






<!DOCTYPE html>
<html
  lang="en"
  
  data-color-mode="auto" data-light-theme="light" data-dark-theme="dark"
  data-a11y-animated-images="system" data-a11y-link-underlines="true"
  
  >




  <head>
    <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://github.githubassets.com">
  <link rel="dns-prefetch" href="https://avatars.githubusercontent.com">
  <link rel="dns-prefetch" href="https://github-cloud.s3.amazonaws.com">
  <link rel="dns-prefetch" href="https://user-images.githubusercontent.com/">
  <link rel="preconnect" href="https://github.githubassets.com" crossorigin>
  <link rel="preconnect" href="https://avatars.githubusercontent.com">

  

  <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/light-44e67b0cd5d5.css" /><link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/light_high_contrast-b51c2fae25e8.css" /><link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/dark-cb035ed575b8.css" /><link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/dark_high_contrast-99e9b1169976.css" /><link data-color-theme="light" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light-44e67b0cd5d5.css" /><link data-color-theme="light_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light_high_contrast-b51c2fae25e8.css" /><link data-color-theme="light_colorblind" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light_colorblind-dadcba82130c.css" /><link data-color-theme="light_colorblind_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light_colorblind_high_contrast-cdc36145225e.css" /><link data-color-theme="light_tritanopia" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light_tritanopia-0ca195e3b5f3.css" /><link data-color-theme="light_tritanopia_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/light_tritanopia_high_contrast-f9fb5556a83f.css" /><link data-color-theme="dark" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark-cb035ed575b8.css" /><link data-color-theme="dark_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_high_contrast-99e9b1169976.css" /><link data-color-theme="dark_colorblind" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_colorblind-9541c4141757.css" /><link data-color-theme="dark_colorblind_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_colorblind_high_contrast-bc604fc65912.css" /><link data-color-theme="dark_tritanopia" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_tritanopia-384776200fd7.css" /><link data-color-theme="dark_tritanopia_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_tritanopia_high_contrast-489c70dedd0a.css" /><link data-color-theme="dark_dimmed" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_dimmed-1545a2e9e540.css" /><link data-color-theme="dark_dimmed_high_contrast" crossorigin="anonymous" media="all" rel="stylesheet" data-href="https://github.githubassets.com/assets/dark_dimmed_high_contrast-4c1792a987c3.css" />

  <style type="text/css">
    :root {
      --tab-size-preference: 4;
    }

    pre, code {
      tab-size: var(--tab-size-preference);
    }
  </style>

    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-primitives-15839d47b75d.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-a5c85403da8c.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/global-4d11e88b2383.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/github-6aeb6451a33d.css" />
  <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/repository-5d735668c600.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/code-9c9b8dc61e74.css" />

  

  <script type="application/json" id="client-env">{"locale":"en","featureFlags":["alternate_user_config_repo","api_insights_show_missing_data_banner","attestations_filtering","attestations_sorting","billing_unfiltered_discounts","client_version_header","codespaces_prebuild_region_target_update","contentful_lp_footnotes","copilot_agent_cli_public_preview","copilot_agent_task_list_v2","copilot_agent_tasks_btn_code_nav","copilot_agent_tasks_btn_code_view","copilot_agent_tasks_btn_code_view_lines","copilot_api_agentic_issue_marshal_yaml","copilot_api_github_draft_update_issue_skill","copilot_chat_attach_multiple_images","copilot_chat_file_redirect","copilot_chat_reduce_quota_checks","copilot_chat_search_bar_redirect","copilot_chat_selection_attachments","copilot_chat_vision_in_claude","copilot_chat_vision_skip_thread_create","copilot_custom_copilots","copilot_custom_copilots_feature_preview","copilot_duplicate_thread","copilot_extensions_deprecation_notice","copilot_features_raycast_logo","copilot_file_block_ref_matching","copilot_free_to_paid_telem","copilot_ftp_hyperspace_upgrade_prompt","copilot_ftp_settings_upgrade","copilot_ftp_upgrade_to_pro_from_models","copilot_ftp_your_copilot_settings","copilot_generate_commit_message_dry_regenerate","copilot_immersive_structured_model_picker","copilot_immersive_task_within_chat_thread","copilot_insights_column_chart_axis_legibility_fix","copilot_insights_usage_export_ndjson","copilot_mission_control_feedback","copilot_mission_control_session_feedback","copilot_no_floating_button","copilot_read_shared_conversation","copilot_spaces_as_attachments","copilot_spaces_ga","copilot_spark_loading_webgl","copilot_spark_progressive_error_handling","copilot_spark_read_iteration_history_from_git_v2","copilot_spark_use_billing_headers","copilot_spark_write_iteration_history_to_git","copilot_stable_conversation_view","copilot_workbench_agent_seed_tool","copilot_workbench_cache","copilot_workbench_connection_reload_banner","copilot_workbench_preview_analytics","copilot_workbench_skip_repo_on_codespace","copilot_workbench_use_single_prompt","direct_to_salesforce","disable_dashboard_universe_2025_private_preview","dotcom_chat_client_side_skills","failbot_report_error_react_apps_on_page","ghost_pilot_confidence_truncation_25","ghost_pilot_confidence_truncation_40","global_search_multi_orgs","hpc_improve_dom_insertion_observer","inp_reduced_threshold","insert_before_patch","issue_fields_report_usage","issues_copilot_cross_repo_assign","issues_react_blur_item_picker_on_close","issues_react_bots_timeline_pagination","issues_react_prohibit_title_fallback","issues_react_remove_placeholders","issues_sticky_sidebar","kb_convert_to_space","lifecycle_label_name_updates","link_contact_sales_swp_marketo","marketing_pages_search_explore_provider","mcp_registry_install","memex_mwl_filter_field_delimiter","migrate_toasts_to_banners_web_notifications","new_traffic_page_banner","open_agent_session_in_vscode_insiders","pinned_issue_fields","primer_react_segmented_control_tooltip","primer_react_unified_portal_root","record_sso_banner_metrics","ref_selector_create_tag_dialog","remove_child_patch","repos_insights_remove_new_url","sample_network_conn_type","scheduled_reminders_updated_limits","site_homepage_collaborate_video","site_homepage_contentful","site_msbuild_webgl_hero","spark_fix_rename","spark_force_push_after_checkout","spark_kv_encocoded_keys","spark_show_data_access_on_publish","spark_sync_repository_after_iteration","viewscreen_sandbox","webp_support","workbench_store_readonly"],"copilotApiOverrideUrl":"https://api.githubcopilot.com"}</script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/high-contrast-cookie-f3788027bd8d.js"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/wp-runtime-b73258c5aaae.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_oddbird_popover-polyfill_dist_popover-fn_js-468bf7cab607.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_stacktrace-parser_dist_stack-trace-parser_esm_js-node_modules_github_bro-2f4e04-280c10ec004d.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/environment-b4e74adb6411.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_primer_behaviors_dist_esm_index_mjs-3eee64e5ddf0.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_selector-observer_dist_index_esm_js-9ab93471824e.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_relative-time-element_dist_index_js-ef89d23fcc0a.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_auto-complete-element_dist_index_js-node_modules_github_catalyst_-0d7d60-ad3a87b2f0eb.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_text-expander-element_dist_index_js-754f5b5e9e7e.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_filter-input-element_dist_index_js-node_modules_github_remote-inp-665e70-ac788066c220.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_markdown-toolbar-element_dist_index_js-d41270eb61be.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_file-attachment-element_dist_index_js-node_modules_primer_view-co-777ce2-9ec8c103bf42.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/github-elements-9e1d42c09c62.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/element-registry-212230e65885.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_braintree_browser-detection_dist_browser-detection_js-node_modules_githu-bb80ec-f11c694928ba.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_lit-html_lit-html_js-9012bef51135.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_index_js-node_modules_morphdom_dist_morphdom-e-c1896e-ba47f43192a8.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_remote-form_dist_index_js-node_modules_delegated-events_dist_inde-893f9f-9ba0881c72fb.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_turbo_dist_turbo_es2017-esm_js-8eb9b2209bcd.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_hotkey_dist_index_js-node_modules_github_hydro-analytics-client_d-dd3ec8-1f3d5f90de2b.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_quote-selection_dist_index_js-node_modules_github_session-resume_-31b9f3-9021ed20220b.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/packages_document-metadata_document-metadata_ts-packages_failbot_failbot_ts-06156f7d8d1a.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/packages_updatable-content_updatable-content_ts-38f5e2f7c2a7.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_ajax-error_ts-app_assets_modules_github_behaviors_details-6493f1-cecb020e2bb7.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_task-list_ts-app_assets_modules_github_throttled-input_ts-047775-cfe8770908d1.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_commenting_edit_ts-app_assets_modules_github_behaviors_ht-83c235-d8c5bfe37d1d.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/behaviors-d431b500aedc.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_delegated-events_dist_index_js-node_modules_github_catalyst_lib_index_js-ef6d0f-20d6767cecc0.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/notifications-global-d89a4ddd4532.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_virtualized-list_es_index_js-node_modules_github_template-parts_lib_inde-f69fd1-ead47121f2f7.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_remote-form_dist_index_js-node_modules_delegated-events_dist_inde-0d71a9-129b4f34d384.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/app_assets_modules_github_ref-selector_ts-63ecfa2887c1.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/codespaces-8cfd06ba3e39.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_filter-input-element_dist_index_js-node_modules_github_remote-inp-3eebbd-7f6bf4b8b391.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_decorators_js-node_modules_delegated-events_di-e161aa-9086b9aee9d1.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_file-attachment-element_dist_index_js-node_modules_github_remote--abdaf7-71f92102de66.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/repositories-7c2a36f9c401.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_index_js-node_modules_github_catalyst_lib_inde-96937f-70732ff56a20.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/code-menu-614eb4e0c016.js" defer="defer"></script>
  
  <script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/primer-react-cdd6dd11a475.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/react-lib-25ef56e89e94.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/react-core-26c9e2751844.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/octicons-react-dfcd3f5e8531.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_emotion_is-prop-valid_dist_emotion-is-prop-valid_esm_js-node_modules_emo-825c28-cdae255a4bbc.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_index_js-node_modules_github_hydro-analytics-c-c228f9-e9af1d9bff76.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_tanstack_query-core_build_modern_mutation_js-node_modules_tanstack_query-9bf7e4-2246c69bea10.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_swc_helpers_esm__class_private_method_get_js-node_modules_swc_helpers_es-d6b1a6-13297632eddc.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/packages_notifications-subscriptions-menu_entry_ts-packages_promise-with-resolvers-polyfill_p-15cb60-9c0f034a796f.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/notifications-subscriptions-menu-c28df4f8626e.js" defer="defer"></script>
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.bab8822ac328fb95c70d.module.css" />

  <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.bab8822ac328fb95c70d.module.css" />


  <title>GitHub - openresty/lua-nginx-module: Embed the Power of Lua into NGINX HTTP servers</title>



  <meta name="route-pattern" content="/:user_id/:repository" data-turbo-transient>
  <meta name="route-controller" content="files" data-turbo-transient>
  <meta name="route-action" content="disambiguate" data-turbo-transient>
  <meta name="fetch-nonce" content="v2:52c78e24-b6ba-2bee-e25d-671c7be5c833">

    
  <meta name="current-catalog-service-hash" content="f3abb0cc802f3d7b95fc8762b94bdcb13bf39634c40c357301c4aa1d67a256fb">


  <meta name="request-id" content="DC00:108D45:C8FC4E:1147B16:68FB562C" data-pjax-transient="true"/><meta name="html-safe-nonce" content="6c5b79325121764f3e7b2f56b9c435114922256726d86663d3013d53b5286b15" data-pjax-transient="true"/><meta name="visitor-payload" content="eyJyZWZlcnJlciI6IiIsInJlcXVlc3RfaWQiOiJEQzAwOjEwOEQ0NTpDOEZDNEU6MTE0N0IxNjo2OEZCNTYyQyIsInZpc2l0b3JfaWQiOiIxNzM1NDgyNjc5ODk0OTU1NTQ1IiwicmVnaW9uX2VkZ2UiOiJpYWQiLCJyZWdpb25fcmVuZGVyIjoiaWFkIn0=" data-pjax-transient="true"/><meta name="visitor-hmac" content="c95346692aea3034eaa2402acc7168f0762fdd273f3118ea0923a8f0f77f1044" data-pjax-transient="true"/>


    <meta name="hovercard-subject-tag" content="repository:613829" data-turbo-transient>


  <meta name="github-keyboard-shortcuts" content="repository,copilot" data-turbo-transient="true" />
  

  <meta name="selected-link" value="repo_source" data-turbo-transient>
  <link rel="assets" href="https://github.githubassets.com/">

    <meta name="google-site-verification" content="Apib7-x98H0j5cPqHWwSMm6dNU4GmODRoqxLiDzdx9I">

<meta name="octolytics-url" content="https://collector.github.com/github/collect" />

  <meta name="analytics-location" content="/&lt;user-name&gt;/&lt;repo-name&gt;" data-turbo-transient="true" />

  




    <meta name="user-login" content="">

  

    <meta name="viewport" content="width=device-width">

    

      <meta name="description" content="Embed the Power of Lua into NGINX HTTP servers. Contribute to openresty/lua-nginx-module development by creating an account on GitHub.">

      <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub">

    <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub">
    <meta property="fb:app_id" content="1401488693436528">
    <meta name="apple-itunes-app" content="app-id=1477376905, app-argument=https://github.com/openresty/lua-nginx-module" />

      <meta name="twitter:image" content="https://opengraph.githubassets.com/493fee8acbcedb3c9213fc09939d8b19995d724e0ed50f539990901c987b7d85/openresty/lua-nginx-module" /><meta name="twitter:site" content="@github" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:title" content="GitHub - openresty/lua-nginx-module: Embed the Power of Lua into NGINX HTTP servers" /><meta name="twitter:description" content="Embed the Power of Lua into NGINX HTTP servers. Contribute to openresty/lua-nginx-module development by creating an account on GitHub." />
  <meta property="og:image" content="https://opengraph.githubassets.com/493fee8acbcedb3c9213fc09939d8b19995d724e0ed50f539990901c987b7d85/openresty/lua-nginx-module" /><meta property="og:image:alt" content="Embed the Power of Lua into NGINX HTTP servers. Contribute to openresty/lua-nginx-module development by creating an account on GitHub." /><meta property="og:image:width" content="1200" /><meta property="og:image:height" content="600" /><meta property="og:site_name" content="GitHub" /><meta property="og:type" content="object" /><meta property="og:title" content="GitHub - openresty/lua-nginx-module: Embed the Power of Lua into NGINX HTTP servers" /><meta property="og:url" content="https://github.com/openresty/lua-nginx-module" /><meta property="og:description" content="Embed the Power of Lua into NGINX HTTP servers. Contribute to openresty/lua-nginx-module development by creating an account on GitHub." />
  




      <meta name="hostname" content="github.com">



        <meta name="expected-hostname" content="github.com">


  <meta http-equiv="x-pjax-version" content="edb0d926ab1906770550b20a43d9b38dd31aa9f43125e46b0f03b199f9f5ffc9" data-turbo-track="reload">
  <meta http-equiv="x-pjax-csp-version" content="21a43568025709b66240454fc92d4f09335a96863f8ab1c46b4a07f6a5b67102" data-turbo-track="reload">
  <meta http-equiv="x-pjax-css-version" content="9a5723604920ed305ee49e39cb1005f635d72600a9d3ee8570586b8be07865c3" data-turbo-track="reload">
  <meta http-equiv="x-pjax-js-version" content="e219e7f22a568c92e2760b3fa72fe03f661aed0635cfdd507899c28619d497b7" data-turbo-track="reload">

  <meta name="turbo-cache-control" content="no-preview" data-turbo-transient="">

      <meta data-hydrostats="publish">
  <meta name="go-import" content="github.com/openresty/lua-nginx-module git https://github.com/openresty/lua-nginx-module.git">

  <meta name="octolytics-dimension-user_id" content="7390180" /><meta name="octolytics-dimension-user_login" content="openresty" /><meta name="octolytics-dimension-repository_id" content="613829" /><meta name="octolytics-dimension-repository_nwo" content="openresty/lua-nginx-module" /><meta name="octolytics-dimension-repository_public" content="true" /><meta name="octolytics-dimension-repository_is_fork" content="false" /><meta name="octolytics-dimension-repository_network_root_id" content="613829" /><meta name="octolytics-dimension-repository_network_root_nwo" content="openresty/lua-nginx-module" />



      <link rel="canonical" href="https://github.com/openresty/lua-nginx-module" data-turbo-transient>


    <meta name="turbo-body-classes" content="logged-out env-production page-responsive">


  <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">

  <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">

  <meta name="release" content="52b212fa9d89c9c0399bcd8a7727377c16297ef9">
  <meta name="ui-target" content="full">

  <link rel="mask-icon" href="https://github.githubassets.com/assets/pinned-octocat-093da3e6fa40.svg" color="#000000">
  <link rel="alternate icon" class="js-site-favicon" type="image/png" href="https://github.githubassets.com/favicons/favicon.png">
  <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg" data-base-href="https://github.githubassets.com/favicons/favicon">

<meta name="theme-color" content="#1e2327">
<meta name="color-scheme" content="light dark" />


  <link rel="manifest" href="/manifest.json" crossOrigin="use-credentials">

  </head>

  <body class="logged-out env-production page-responsive" style="word-wrap: break-word;">
    <div data-turbo-body class="logged-out env-production page-responsive" style="word-wrap: break-word;">
      



    <div class="position-relative header-wrapper js-header-wrapper ">
      <a href="#start-of-content" data-skip-target-assigned="false" class="px-2 py-4 color-bg-accent-emphasis color-fg-on-emphasis show-on-focus js-skip-to-content">Skip to content</a>

      <span data-view-component="true" class="progress-pjax-loader Progress position-fixed width-full">
    <span style="width: 0%;" data-view-component="true" class="Progress-item progress-pjax-loader-bar left-0 top-0 color-bg-accent-emphasis"></span>
</span>      
      
      <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/keyboard-shortcuts-dialog.2de9c7d6456a311fce49.module.css" />

<react-partial
  partial-name="keyboard-shortcuts-dialog"
  data-ssr="false"
  data-attempted-ssr="false"
  data-react-profiling="false"
>
  
  <script type="application/json" data-target="react-partial.embeddedData">{"props":{"docsUrl":"https://docs.github.com/get-started/accessibility/keyboard-shortcuts"}}</script>
  <div data-target="react-partial.reactRoot"></div>
</react-partial>





      

          

              
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_gsap_index_js-6265bea06e74.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/vendors-node_modules_github_remote-form_dist_index_js-node_modules_delegated-events_dist_inde-94fd67-dc050877d1bf.js" defer="defer"></script>
<script crossorigin="anonymous" type="application/javascript" src="https://github.githubassets.com/assets/sessions-917229b8a853.js" defer="defer"></script>

<header class="HeaderMktg header-logged-out js-details-container js-header Details f4 py-3" role="banner" data-is-top="true" data-color-mode=light data-light-theme=light data-dark-theme=dark>
  <h2 class="sr-only">Navigation Menu</h2>

  <button type="button" class="HeaderMktg-backdrop d-lg-none border-0 position-fixed top-0 left-0 width-full height-full js-details-target" aria-label="Toggle navigation">
    <span class="d-none">Toggle navigation</span>
  </button>

  <div class="d-flex flex-column flex-lg-row flex-items-center px-3 px-md-4 px-lg-5 height-full position-relative z-1">
    <div class="d-flex flex-justify-between flex-items-center width-full width-lg-auto">
      <div class="flex-1">
        <button aria-label="Toggle navigation" aria-expanded="false" type="button" data-view-component="true" class="js-details-target js-nav-padding-recalculate js-header-menu-toggle Button--link Button--medium Button d-lg-none color-fg-inherit p-1">  <span class="Button-content">
    <span class="Button-label"><div class="HeaderMenu-toggle-bar rounded my-1"></div>
            <div class="HeaderMenu-toggle-bar rounded my-1"></div>
            <div class="HeaderMenu-toggle-bar rounded my-1"></div></span>
  </span>
</button>
      </div>

      <a class="mr-lg-3 color-fg-inherit flex-order-2 js-prevent-focus-on-mobile-nav"
        href="/"
        aria-label="Homepage"
        data-analytics-event="{&quot;category&quot;:&quot;Marketing nav&quot;,&quot;action&quot;:&quot;click to go to homepage&quot;,&quot;label&quot;:&quot;ref_page:Marketing;ref_cta:Logomark;ref_loc:Header&quot;}">
        <svg height="32" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="32" data-view-component="true" class="octicon octicon-mark-github">
    <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
</svg>
      </a>

      <div class="d-flex flex-1 flex-order-2 text-right d-lg-none gap-2 flex-justify-end">
          <a
            href="/login?return_to=https%3A%2F%2Fgithub.com%2Fopenresty%2Flua-nginx-module"
            class="HeaderMenu-link HeaderMenu-button d-inline-flex f5 no-underline border color-border-default rounded-2 px-2 py-1 color-fg-inherit js-prevent-focus-on-mobile-nav"
            data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;site header menu&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;SIGN_UP&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="08a7380e479b2797416d11d8727cd24ccc936fc1127e80d25982889679295abd"
            data-analytics-event="{&quot;category&quot;:&quot;Marketing nav&quot;,&quot;action&quot;:&quot;click to Sign in&quot;,&quot;label&quot;:&quot;ref_page:Marketing;ref_cta:Sign in;ref_loc:Header&quot;}"
          >
            Sign in
          </a>
              <div class="AppHeader-appearanceSettings">
    <react-partial-anchor>
      <button data-target="react-partial-anchor.anchor" id="icon-button-2d1a1ac7-e400-4a83-9031-7e672ca5cfff" aria-labelledby="tooltip-b9210d0a-f085-42b0-a890-f075a30827b2" type="button" disabled="disabled" data-view-component="true" class="Button Button--iconOnly Button--invisible Button--medium AppHeader-button HeaderMenu-link border cursor-wait">  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-sliders Button-visual">
    <path d="M15 2.75a.75.75 0 0 1-.75.75h-4a.75.75 0 0 1 0-1.5h4a.75.75 0 0 1 .75.75Zm-8.5.75v1.25a.75.75 0 0 0 1.5 0v-4a.75.75 0 0 0-1.5 0V2H1.75a.75.75 0 0 0 0 1.5H6.5Zm1.25 5.25a.75.75 0 0 0 0-1.5h-6a.75.75 0 0 0 0 1.5h6ZM15 8a.75.75 0 0 1-.75.75H11.5V10a.75.75 0 1 1-1.5 0V6a.75.75 0 0 1 1.5 0v1.25h2.75A.75.75 0 0 1 15 8Zm-9 5.25v-2a.75.75 0 0 0-1.5 0v1.25H1.75a.75.75 0 0 0 0 1.5H4.5v1.25a.75.75 0 0 0 1.5 0v-2Zm9 0a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1 0-1.5h6a.75.75 0 0 1 .75.75Z"></path>
</svg>
</button><tool-tip id="tooltip-b9210d0a-f085-42b0-a890-f075a30827b2" for="icon-button-2d1a1ac7-e400-4a83-9031-7e672ca5cfff" popover="manual" data-direction="s" data-type="label" data-view-component="true" class="sr-only position-absolute">Appearance settings</tool-tip>

      <template data-target="react-partial-anchor.template">
        <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/appearance-settings.6c63a6de228d6520804d.module.css" />

<react-partial
  partial-name="appearance-settings"
  data-ssr="false"
  data-attempted-ssr="false"
  data-react-profiling="false"
>
  
  <script type="application/json" data-target="react-partial.embeddedData">{"props":{}}</script>
  <div data-target="react-partial.reactRoot"></div>
</react-partial>


      </template>
    </react-partial-anchor>
  </div>

      </div>
    </div>


    <div class="HeaderMenu js-header-menu height-fit position-lg-relative d-lg-flex flex-column flex-auto top-0">
      <div class="HeaderMenu-wrapper d-flex flex-column flex-self-start flex-lg-row flex-auto rounded rounded-lg-0">
            <nav class="HeaderMenu-nav" aria-label="Global">
              <ul class="d-lg-flex list-style-none">
                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
      <button type="button" class="HeaderMenu-link border-0 width-full width-lg-auto px-0 px-lg-2 py-lg-2 no-wrap d-flex flex-items-center flex-justify-between js-details-target" aria-expanded="false">
        Platform
        <svg opacity="0.5" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-down HeaderMenu-icon ml-1">
    <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
</svg>
      </button>

      <div class="HeaderMenu-dropdown dropdown-menu rounded m-0 p-0 pt-2 pt-lg-4 position-relative position-lg-absolute left-0 left-lg-n3 dropdown-menu-wide">
        <div class="d-lg-flex dropdown-menu-wide">
            <div class="HeaderMenu-column px-lg-4">
                <div class="">

                  <ul class="list-style-none f5" >
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_copilot&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_copilot_link_platform_navbar&quot;}" href="https://github.com/features/copilot">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-copilot color-fg-subtle mr-3">
    <path d="M23.922 16.992c-.861 1.495-5.859 5.023-11.922 5.023-6.063 0-11.061-3.528-11.922-5.023A.641.641 0 0 1 0 16.736v-2.869a.841.841 0 0 1 .053-.22c.372-.935 1.347-2.292 2.605-2.656.167-.429.414-1.055.644-1.517a10.195 10.195 0 0 1-.052-1.086c0-1.331.282-2.499 1.132-3.368.397-.406.89-.717 1.474-.952 1.399-1.136 3.392-2.093 6.122-2.093 2.731 0 4.767.957 6.166 2.093.584.235 1.077.546 1.474.952.85.869 1.132 2.037 1.132 3.368 0 .368-.014.733-.052 1.086.23.462.477 1.088.644 1.517 1.258.364 2.233 1.721 2.605 2.656a.832.832 0 0 1 .053.22v2.869a.641.641 0 0 1-.078.256ZM12.172 11h-.344a4.323 4.323 0 0 1-.355.508C10.703 12.455 9.555 13 7.965 13c-1.725 0-2.989-.359-3.782-1.259a2.005 2.005 0 0 1-.085-.104L4 11.741v6.585c1.435.779 4.514 2.179 8 2.179 3.486 0 6.565-1.4 8-2.179v-6.585l-.098-.104s-.033.045-.085.104c-.793.9-2.057 1.259-3.782 1.259-1.59 0-2.738-.545-3.508-1.492a4.323 4.323 0 0 1-.355-.508h-.016.016Zm.641-2.935c.136 1.057.403 1.913.878 2.497.442.544 1.134.938 2.344.938 1.573 0 2.292-.337 2.657-.751.384-.435.558-1.15.558-2.361 0-1.14-.243-1.847-.705-2.319-.477-.488-1.319-.862-2.824-1.025-1.487-.161-2.192.138-2.533.529-.269.307-.437.808-.438 1.578v.021c0 .265.021.562.063.893Zm-1.626 0c.042-.331.063-.628.063-.894v-.02c-.001-.77-.169-1.271-.438-1.578-.341-.391-1.046-.69-2.533-.529-1.505.163-2.347.537-2.824 1.025-.462.472-.705 1.179-.705 2.319 0 1.211.175 1.926.558 2.361.365.414 1.084.751 2.657.751 1.21 0 1.902-.394 2.344-.938.475-.584.742-1.44.878-2.497Z"></path><path d="M14.5 14.25a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1Zm-5 0a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          GitHub Copilot

        </div>

        Write better code with AI
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_spark&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_spark_link_platform_navbar&quot;}" href="https://github.com/features/spark">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-sparkle-fill color-fg-subtle mr-3">
    <path d="M11.296 1.924c.24-.656 1.168-.656 1.408 0l.717 1.958a11.25 11.25 0 0 0 6.697 6.697l1.958.717c.657.24.657 1.168 0 1.408l-1.958.717a11.25 11.25 0 0 0-6.697 6.697l-.717 1.958c-.24.657-1.168.657-1.408 0l-.717-1.958a11.25 11.25 0 0 0-6.697-6.697l-1.958-.717c-.656-.24-.656-1.168 0-1.408l1.958-.717a11.25 11.25 0 0 0 6.697-6.697l.717-1.958Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          GitHub Spark

            <span class="HeaderMenu-label">
              New
            </span>
        </div>

        Build and deploy intelligent apps
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_models&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_models_link_platform_navbar&quot;}" href="https://github.com/features/models">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-ai-model color-fg-subtle mr-3">
    <path d="M19.375 8.5a3.25 3.25 0 1 1-3.163 4h-3a3.252 3.252 0 0 1-4.443 2.509L7.214 17.76a3.25 3.25 0 1 1-1.342-.674l1.672-2.957A3.238 3.238 0 0 1 6.75 12c0-.907.371-1.727.97-2.316L6.117 6.846A3.253 3.253 0 0 1 1.875 3.75a3.25 3.25 0 1 1 5.526 2.32l1.603 2.836A3.25 3.25 0 0 1 13.093 11h3.119a3.252 3.252 0 0 1 3.163-2.5ZM10 10.25a1.75 1.75 0 1 0-.001 3.499A1.75 1.75 0 0 0 10 10.25ZM5.125 2a1.75 1.75 0 1 0 0 3.5 1.75 1.75 0 0 0 0-3.5Zm12.5 9.75a1.75 1.75 0 1 0 3.5 0 1.75 1.75 0 0 0-3.5 0Zm-14.25 8.5a1.75 1.75 0 1 0 3.501-.001 1.75 1.75 0 0 0-3.501.001Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          GitHub Models

            <span class="HeaderMenu-label">
              New
            </span>
        </div>

        Manage and compare prompts
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_advanced_security&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_advanced_security_link_platform_navbar&quot;}" href="https://github.com/security/advanced-security">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-shield-check color-fg-subtle mr-3">
    <path d="M16.53 9.78a.75.75 0 0 0-1.06-1.06L11 13.19l-1.97-1.97a.75.75 0 0 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l5-5Z"></path><path d="m12.54.637 8.25 2.675A1.75 1.75 0 0 1 22 4.976V10c0 6.19-3.771 10.704-9.401 12.83a1.704 1.704 0 0 1-1.198 0C5.77 20.705 2 16.19 2 10V4.976c0-.758.489-1.43 1.21-1.664L11.46.637a1.748 1.748 0 0 1 1.08 0Zm-.617 1.426-8.25 2.676a.249.249 0 0 0-.173.237V10c0 5.46 3.28 9.483 8.43 11.426a.199.199 0 0 0 .14 0C17.22 19.483 20.5 15.461 20.5 10V4.976a.25.25 0 0 0-.173-.237l-8.25-2.676a.253.253 0 0 0-.154 0Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          GitHub Advanced Security

        </div>

        Find and fix vulnerabilities
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;actions&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;actions_link_platform_navbar&quot;}" href="https://github.com/features/actions">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-workflow color-fg-subtle mr-3">
    <path d="M1 3a2 2 0 0 1 2-2h6.5a2 2 0 0 1 2 2v6.5a2 2 0 0 1-2 2H7v4.063C7 16.355 7.644 17 8.438 17H12.5v-2.5a2 2 0 0 1 2-2H21a2 2 0 0 1 2 2V21a2 2 0 0 1-2 2h-6.5a2 2 0 0 1-2-2v-2.5H8.437A2.939 2.939 0 0 1 5.5 15.562V11.5H3a2 2 0 0 1-2-2Zm2-.5a.5.5 0 0 0-.5.5v6.5a.5.5 0 0 0 .5.5h6.5a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5ZM14.5 14a.5.5 0 0 0-.5.5V21a.5.5 0 0 0 .5.5H21a.5.5 0 0 0 .5-.5v-6.5a.5.5 0 0 0-.5-.5Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Actions

        </div>

        Automate any workflow
      </div>

    
</a></li>

                  </ul>
                </div>
            </div>
            <div class="HeaderMenu-column px-lg-4 pb-3 pb-lg-0 border-lg-right">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                  <ul class="list-style-none f5" >
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;codespaces&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;codespaces_link_platform_navbar&quot;}" href="https://github.com/features/codespaces">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-codespaces color-fg-subtle mr-3">
    <path d="M3.5 3.75C3.5 2.784 4.284 2 5.25 2h13.5c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 18.75 13H5.25a1.75 1.75 0 0 1-1.75-1.75Zm-2 12c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v4a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75ZM5.25 3.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h13.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Zm-2 12a.25.25 0 0 0-.25.25v4c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25Z"></path><path d="M10 17.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75Zm-4 0a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Codespaces

        </div>

        Instant dev environments
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;issues&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;issues_link_platform_navbar&quot;}" href="https://github.com/features/issues">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-issue-opened color-fg-subtle mr-3">
    <path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Zm9.5 2a2 2 0 1 1-.001-3.999A2 2 0 0 1 12 14Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Issues

        </div>

        Plan and track work
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;code_review&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;code_review_link_platform_navbar&quot;}" href="https://github.com/features/code-review">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-code-review color-fg-subtle mr-3">
    <path d="M10.3 6.74a.75.75 0 0 1-.04 1.06l-2.908 2.7 2.908 2.7a.75.75 0 1 1-1.02 1.1l-3.5-3.25a.75.75 0 0 1 0-1.1l3.5-3.25a.75.75 0 0 1 1.06.04Zm3.44 1.06a.75.75 0 1 1 1.02-1.1l3.5 3.25a.75.75 0 0 1 0 1.1l-3.5 3.25a.75.75 0 1 1-1.02-1.1l2.908-2.7-2.908-2.7Z"></path><path d="M1.5 4.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 0 1-1.75 1.75h-9.69l-3.573 3.573A1.458 1.458 0 0 1 5 21.043V18.5H3.25a1.75 1.75 0 0 1-1.75-1.75ZM3.25 4a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 0 1 .75.75v3.19l3.72-3.72a.749.749 0 0 1 .53-.22h10a.25.25 0 0 0 .25-.25V4.25a.25.25 0 0 0-.25-.25Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Code Review

        </div>

        Manage code changes
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;discussions&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;discussions_link_platform_navbar&quot;}" href="https://github.com/features/discussions">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-comment-discussion color-fg-subtle mr-3">
    <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 14.25 14H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 15.543V14H1.75A1.75 1.75 0 0 1 0 12.25v-9.5C0 1.784.784 1 1.75 1ZM1.5 2.75v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"></path><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Discussions

        </div>

        Collaborate outside of code
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;code_search&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;code_search_link_platform_navbar&quot;}" href="https://github.com/features/code-search">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-code-square color-fg-subtle mr-3">
    <path d="M10.3 8.24a.75.75 0 0 1-.04 1.06L7.352 12l2.908 2.7a.75.75 0 1 1-1.02 1.1l-3.5-3.25a.75.75 0 0 1 0-1.1l3.5-3.25a.75.75 0 0 1 1.06.04Zm3.44 1.06a.75.75 0 1 1 1.02-1.1l3.5 3.25a.75.75 0 0 1 0 1.1l-3.5 3.25a.75.75 0 1 1-1.02-1.1l2.908-2.7-2.908-2.7Z"></path><path d="M2 3.75C2 2.784 2.784 2 3.75 2h16.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 20.25 22H3.75A1.75 1.75 0 0 1 2 20.25Zm1.75-.25a.25.25 0 0 0-.25.25v16.5c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25V3.75a.25.25 0 0 0-.25-.25Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Code Search

        </div>

        Find more, search less
      </div>

    
</a></li>

                  </ul>
                </div>
            </div>
            <div class="HeaderMenu-column px-lg-4">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 mb-3 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="platform-explore-heading">Explore</span>

                  <ul class="list-style-none f5" aria-labelledby="platform-explore-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;why_github&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;why_github_link_platform_navbar&quot;}" href="https://github.com/why-github">
      Why GitHub

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary Link--external" target="_blank" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;documentation&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;documentation_link_platform_navbar&quot;}" href="https://docs.github.com">
      Documentation

    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link-external HeaderMenu-external-icon color-fg-subtle">
    <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path>
</svg>
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary Link--external" target="_blank" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_skills&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_skills_link_platform_navbar&quot;}" href="https://skills.github.com">
      GitHub Skills

    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link-external HeaderMenu-external-icon color-fg-subtle">
    <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path>
</svg>
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary Link--external" target="_blank" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;blog&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;blog_link_platform_navbar&quot;}" href="https://github.blog">
      Blog

    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link-external HeaderMenu-external-icon color-fg-subtle">
    <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path>
</svg>
</a></li>

                  </ul>
                </div>
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="platform-integrations-heading">Integrations</span>

                  <ul class="list-style-none f5" aria-labelledby="platform-integrations-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_marketplace&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_marketplace_link_platform_navbar&quot;}" href="https://github.com/marketplace">
      GitHub Marketplace

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;mcp_registry&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;mcp_registry_link_platform_navbar&quot;}" href="https://github.com/mcp">
      MCP Registry

    
</a></li>

                  </ul>
                </div>
            </div>
        </div>

          <div class="HeaderMenu-trailing-link rounded-bottom-2 mt-lg-4 px-lg-4 py-4 py-lg-3 f5 text-semibold">
            <a data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;view_all_features&quot;,&quot;context&quot;:&quot;platform&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;view_all_features_link_platform_navbar&quot;}" href="https://github.com/features">
              View all features
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-right HeaderMenu-trailing-link-icon">
    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"></path>
</svg>
</a>          </div>
      </div>
</li>


                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
      <button type="button" class="HeaderMenu-link border-0 width-full width-lg-auto px-0 px-lg-2 py-lg-2 no-wrap d-flex flex-items-center flex-justify-between js-details-target" aria-expanded="false">
        Solutions
        <svg opacity="0.5" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-down HeaderMenu-icon ml-1">
    <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
</svg>
      </button>

      <div class="HeaderMenu-dropdown dropdown-menu rounded m-0 p-0 pt-2 pt-lg-4 position-relative position-lg-absolute left-0 left-lg-n3 dropdown-menu-wide">
        <div class="d-lg-flex dropdown-menu-wide">
            <div class="HeaderMenu-column px-lg-4 pb-3 pb-lg-0 border-lg-right">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="solutions-by-company-size-heading">By company size</span>

                  <ul class="list-style-none f5" aria-labelledby="solutions-by-company-size-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;enterprises&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;enterprises_link_solutions_navbar&quot;}" href="https://github.com/enterprise">
      Enterprises

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;small_and_medium_teams&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;small_and_medium_teams_link_solutions_navbar&quot;}" href="https://github.com/team">
      Small and medium teams

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;startups&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;startups_link_solutions_navbar&quot;}" href="https://github.com/enterprise/startups">
      Startups

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;nonprofits&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;nonprofits_link_solutions_navbar&quot;}" href="/solutions/industry/nonprofits">
      Nonprofits

    
</a></li>

                  </ul>
                </div>
            </div>
            <div class="HeaderMenu-column px-lg-4 pb-3 pb-lg-0 border-lg-right">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="solutions-by-use-case-heading">By use case</span>

                  <ul class="list-style-none f5" aria-labelledby="solutions-by-use-case-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;app_modernization&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;app_modernization_link_solutions_navbar&quot;}" href="/solutions/use-case/app-modernization">
      App Modernization

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;devsecops&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;devsecops_link_solutions_navbar&quot;}" href="/solutions/use-case/devsecops">
      DevSecOps

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;devops&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;devops_link_solutions_navbar&quot;}" href="/solutions/use-case/devops">
      DevOps

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;ci_cd&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;ci_cd_link_solutions_navbar&quot;}" href="/solutions/use-case/ci-cd">
      CI/CD

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;view_all_use_cases&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;view_all_use_cases_link_solutions_navbar&quot;}" href="/solutions/use-case">
      View all use cases

    
</a></li>

                  </ul>
                </div>
            </div>
            <div class="HeaderMenu-column px-lg-4">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="solutions-by-industry-heading">By industry</span>

                  <ul class="list-style-none f5" aria-labelledby="solutions-by-industry-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;healthcare&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;healthcare_link_solutions_navbar&quot;}" href="/solutions/industry/healthcare">
      Healthcare

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;financial_services&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;financial_services_link_solutions_navbar&quot;}" href="/solutions/industry/financial-services">
      Financial services

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;manufacturing&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;manufacturing_link_solutions_navbar&quot;}" href="/solutions/industry/manufacturing">
      Manufacturing

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;government&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;government_link_solutions_navbar&quot;}" href="/solutions/industry/government">
      Government

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;view_all_industries&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;view_all_industries_link_solutions_navbar&quot;}" href="/solutions/industry">
      View all industries

    
</a></li>

                  </ul>
                </div>
            </div>
        </div>

          <div class="HeaderMenu-trailing-link rounded-bottom-2 mt-lg-4 px-lg-4 py-4 py-lg-3 f5 text-semibold">
            <a data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;view_all_solutions&quot;,&quot;context&quot;:&quot;solutions&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;view_all_solutions_link_solutions_navbar&quot;}" href="/solutions">
              View all solutions
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-right HeaderMenu-trailing-link-icon">
    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"></path>
</svg>
</a>          </div>
      </div>
</li>


                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
      <button type="button" class="HeaderMenu-link border-0 width-full width-lg-auto px-0 px-lg-2 py-lg-2 no-wrap d-flex flex-items-center flex-justify-between js-details-target" aria-expanded="false">
        Resources
        <svg opacity="0.5" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-down HeaderMenu-icon ml-1">
    <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
</svg>
      </button>

      <div class="HeaderMenu-dropdown dropdown-menu rounded m-0 p-0 pt-2 pt-lg-4 position-relative position-lg-absolute left-0 left-lg-n3 pb-2 pb-lg-4 dropdown-menu-wide">
        <div class="d-lg-flex dropdown-menu-wide">
            <div class="HeaderMenu-column px-lg-4 pb-3 pb-lg-0 border-lg-right">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 pb-3">

                      <span class="d-block h4 color-fg-default my-1" id="resources-topics-heading">Topics</span>

                  <ul class="list-style-none f5" aria-labelledby="resources-topics-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;ai&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;ai_link_resources_navbar&quot;}" href="/resources/articles?topic=ai">
      AI

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;devops&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;devops_link_resources_navbar&quot;}" href="/resources/articles?topic=devops">
      DevOps

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;security&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;security_link_resources_navbar&quot;}" href="/resources/articles?topic=security">
      Security

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;software_development&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;software_development_link_resources_navbar&quot;}" href="/resources/articles?topic=software-development">
      Software Development

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;view_all&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;view_all_link_resources_navbar&quot;}" href="/resources/articles">
      View all

    
</a></li>

                  </ul>
                </div>
            </div>
            <div class="HeaderMenu-column px-lg-4">
                <div class="border-bottom border-lg-bottom-0 pb-lg-0 border-bottom-0">

                      <span class="d-block h4 color-fg-default my-1" id="resources-explore-heading">Explore</span>

                  <ul class="list-style-none f5" aria-labelledby="resources-explore-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary Link--external" target="_blank" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;learning_pathways&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;learning_pathways_link_resources_navbar&quot;}" href="https://resources.github.com/learn/pathways">
      Learning Pathways

    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link-external HeaderMenu-external-icon color-fg-subtle">
    <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path>
</svg>
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;events_amp_webinars&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;events_amp_webinars_link_resources_navbar&quot;}" href="https://github.com/resources/events">
      Events &amp; Webinars

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;ebooks_amp_whitepapers&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;ebooks_amp_whitepapers_link_resources_navbar&quot;}" href="https://github.com/resources/whitepapers">
      Ebooks &amp; Whitepapers

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;customer_stories&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;customer_stories_link_resources_navbar&quot;}" href="https://github.com/customer-stories">
      Customer Stories

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;partners&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;partners_link_resources_navbar&quot;}" href="https://github.com/partners">
      Partners

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;executive_insights&quot;,&quot;context&quot;:&quot;resources&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;executive_insights_link_resources_navbar&quot;}" href="https://github.com/solutions/executive-insights">
      Executive Insights

    
</a></li>

                  </ul>
                </div>
            </div>
        </div>

      </div>
</li>


                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
      <button type="button" class="HeaderMenu-link border-0 width-full width-lg-auto px-0 px-lg-2 py-lg-2 no-wrap d-flex flex-items-center flex-justify-between js-details-target" aria-expanded="false">
        Open Source
        <svg opacity="0.5" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-down HeaderMenu-icon ml-1">
    <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
</svg>
      </button>

      <div class="HeaderMenu-dropdown dropdown-menu rounded m-0 p-0 pt-2 pt-lg-4 position-relative position-lg-absolute left-0 left-lg-n3 pb-2 pb-lg-4">
        <div class="d-lg-flex dropdown-menu-wide">
            <div class="HeaderMenu-column px-lg-4">
                <div class="border-bottom mb-3 mb-lg-3 pb-3">

                  <ul class="list-style-none f5" >
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_sponsors&quot;,&quot;context&quot;:&quot;open_source&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_sponsors_link_open_source_navbar&quot;}" href="/sponsors">
      
      <div>
        <div class="color-fg-default h4">
          GitHub Sponsors

        </div>

        Fund open source developers
      </div>

    
</a></li>

                  </ul>
                </div>
                <div class="border-bottom mb-3 mb-lg-3 pb-3">

                  <ul class="list-style-none f5" >
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;the_readme_project&quot;,&quot;context&quot;:&quot;open_source&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;the_readme_project_link_open_source_navbar&quot;}" href="https://github.com/readme">
      
      <div>
        <div class="color-fg-default h4">
          The ReadME Project

        </div>

        GitHub community articles
      </div>

    
</a></li>

                  </ul>
                </div>
                <div class="border-bottom border-bottom-0">

                      <span class="d-block h4 color-fg-default my-1" id="open-source-repositories-heading">Repositories</span>

                  <ul class="list-style-none f5" aria-labelledby="open-source-repositories-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;topics&quot;,&quot;context&quot;:&quot;open_source&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;topics_link_open_source_navbar&quot;}" href="https://github.com/topics">
      Topics

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;trending&quot;,&quot;context&quot;:&quot;open_source&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;trending_link_open_source_navbar&quot;}" href="https://github.com/trending">
      Trending

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;collections&quot;,&quot;context&quot;:&quot;open_source&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;collections_link_open_source_navbar&quot;}" href="https://github.com/collections">
      Collections

    
</a></li>

                  </ul>
                </div>
            </div>
        </div>

      </div>
</li>


                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
      <button type="button" class="HeaderMenu-link border-0 width-full width-lg-auto px-0 px-lg-2 py-lg-2 no-wrap d-flex flex-items-center flex-justify-between js-details-target" aria-expanded="false">
        Enterprise
        <svg opacity="0.5" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-chevron-down HeaderMenu-icon ml-1">
    <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
</svg>
      </button>

      <div class="HeaderMenu-dropdown dropdown-menu rounded m-0 p-0 pt-2 pt-lg-4 position-relative position-lg-absolute left-0 left-lg-n3 pb-2 pb-lg-4">
        <div class="d-lg-flex dropdown-menu-wide">
            <div class="HeaderMenu-column px-lg-4">
                <div class="border-bottom mb-3 mb-lg-3 pb-3">

                  <ul class="list-style-none f5" >
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;enterprise_platform&quot;,&quot;context&quot;:&quot;enterprise&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;enterprise_platform_link_enterprise_navbar&quot;}" href="/enterprise">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-stack color-fg-subtle mr-3">
    <path d="M11.063 1.456a1.749 1.749 0 0 1 1.874 0l8.383 5.316a1.751 1.751 0 0 1 0 2.956l-8.383 5.316a1.749 1.749 0 0 1-1.874 0L2.68 9.728a1.751 1.751 0 0 1 0-2.956Zm1.071 1.267a.25.25 0 0 0-.268 0L3.483 8.039a.25.25 0 0 0 0 .422l8.383 5.316a.25.25 0 0 0 .268 0l8.383-5.316a.25.25 0 0 0 0-.422Z"></path><path d="M1.867 12.324a.75.75 0 0 1 1.035-.232l8.964 5.685a.25.25 0 0 0 .268 0l8.964-5.685a.75.75 0 0 1 .804 1.267l-8.965 5.685a1.749 1.749 0 0 1-1.874 0l-8.965-5.685a.75.75 0 0 1-.231-1.035Z"></path><path d="M1.867 16.324a.75.75 0 0 1 1.035-.232l8.964 5.685a.25.25 0 0 0 .268 0l8.964-5.685a.75.75 0 0 1 .804 1.267l-8.965 5.685a1.749 1.749 0 0 1-1.874 0l-8.965-5.685a.75.75 0 0 1-.231-1.035Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Enterprise platform

        </div>

        AI-powered developer platform
      </div>

    
</a></li>

                  </ul>
                </div>
                <div class="border-bottom border-bottom-0">

                      <span class="d-block h4 color-fg-default my-1" id="enterprise-available-add-ons-heading">Available add-ons</span>

                  <ul class="list-style-none f5" aria-labelledby="enterprise-available-add-ons-heading">
                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;github_advanced_security&quot;,&quot;context&quot;:&quot;enterprise&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;github_advanced_security_link_enterprise_navbar&quot;}" href="https://github.com/security/advanced-security">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-shield-check color-fg-subtle mr-3">
    <path d="M16.53 9.78a.75.75 0 0 0-1.06-1.06L11 13.19l-1.97-1.97a.75.75 0 0 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l5-5Z"></path><path d="m12.54.637 8.25 2.675A1.75 1.75 0 0 1 22 4.976V10c0 6.19-3.771 10.704-9.401 12.83a1.704 1.704 0 0 1-1.198 0C5.77 20.705 2 16.19 2 10V4.976c0-.758.489-1.43 1.21-1.664L11.46.637a1.748 1.748 0 0 1 1.08 0Zm-.617 1.426-8.25 2.676a.249.249 0 0 0-.173.237V10c0 5.46 3.28 9.483 8.43 11.426a.199.199 0 0 0 .14 0C17.22 19.483 20.5 15.461 20.5 10V4.976a.25.25 0 0 0-.173-.237l-8.25-2.676a.253.253 0 0 0-.154 0Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          GitHub Advanced Security

        </div>

        Enterprise-grade security features
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description mb-lg-3" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;copilot_for_business&quot;,&quot;context&quot;:&quot;enterprise&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;copilot_for_business_link_enterprise_navbar&quot;}" href="/features/copilot/copilot-business">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-copilot color-fg-subtle mr-3">
    <path d="M23.922 16.992c-.861 1.495-5.859 5.023-11.922 5.023-6.063 0-11.061-3.528-11.922-5.023A.641.641 0 0 1 0 16.736v-2.869a.841.841 0 0 1 .053-.22c.372-.935 1.347-2.292 2.605-2.656.167-.429.414-1.055.644-1.517a10.195 10.195 0 0 1-.052-1.086c0-1.331.282-2.499 1.132-3.368.397-.406.89-.717 1.474-.952 1.399-1.136 3.392-2.093 6.122-2.093 2.731 0 4.767.957 6.166 2.093.584.235 1.077.546 1.474.952.85.869 1.132 2.037 1.132 3.368 0 .368-.014.733-.052 1.086.23.462.477 1.088.644 1.517 1.258.364 2.233 1.721 2.605 2.656a.832.832 0 0 1 .053.22v2.869a.641.641 0 0 1-.078.256ZM12.172 11h-.344a4.323 4.323 0 0 1-.355.508C10.703 12.455 9.555 13 7.965 13c-1.725 0-2.989-.359-3.782-1.259a2.005 2.005 0 0 1-.085-.104L4 11.741v6.585c1.435.779 4.514 2.179 8 2.179 3.486 0 6.565-1.4 8-2.179v-6.585l-.098-.104s-.033.045-.085.104c-.793.9-2.057 1.259-3.782 1.259-1.59 0-2.738-.545-3.508-1.492a4.323 4.323 0 0 1-.355-.508h-.016.016Zm.641-2.935c.136 1.057.403 1.913.878 2.497.442.544 1.134.938 2.344.938 1.573 0 2.292-.337 2.657-.751.384-.435.558-1.15.558-2.361 0-1.14-.243-1.847-.705-2.319-.477-.488-1.319-.862-2.824-1.025-1.487-.161-2.192.138-2.533.529-.269.307-.437.808-.438 1.578v.021c0 .265.021.562.063.893Zm-1.626 0c.042-.331.063-.628.063-.894v-.02c-.001-.77-.169-1.271-.438-1.578-.341-.391-1.046-.69-2.533-.529-1.505.163-2.347.537-2.824 1.025-.462.472-.705 1.179-.705 2.319 0 1.211.175 1.926.558 2.361.365.414 1.084.751 2.657.751 1.21 0 1.902-.394 2.344-.938.475-.584.742-1.44.878-2.497Z"></path><path d="M14.5 14.25a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1Zm-5 0a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Copilot for business

        </div>

        Enterprise-grade AI features
      </div>

    
</a></li>

                      <li>
  <a class="HeaderMenu-dropdown-link d-block no-underline position-relative py-2 Link--secondary d-flex flex-items-center Link--has-description" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;premium_support&quot;,&quot;context&quot;:&quot;enterprise&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;premium_support_link_enterprise_navbar&quot;}" href="/premium-support">
      <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-comment-discussion color-fg-subtle mr-3">
    <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 14.25 14H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 15.543V14H1.75A1.75 1.75 0 0 1 0 12.25v-9.5C0 1.784.784 1 1.75 1ZM1.5 2.75v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"></path><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5Z"></path>
</svg>
      <div>
        <div class="color-fg-default h4">
          Premium Support

        </div>

        Enterprise-grade 24/7 support
      </div>

    
</a></li>

                  </ul>
                </div>
            </div>
        </div>

      </div>
</li>


                  <li class="HeaderMenu-item position-relative flex-wrap flex-justify-between flex-items-center d-block d-lg-flex flex-lg-nowrap flex-lg-items-center js-details-container js-header-menu-item">
    <a class="HeaderMenu-link no-underline px-0 px-lg-2 py-3 py-lg-2 d-block d-lg-inline-block" data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;platform&quot;,&quot;context&quot;:&quot;global&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;platform_link_global_navbar&quot;}" href="https://github.com/pricing">Pricing</a>
</li>

              </ul>
            </nav>

        <div class="d-flex flex-column flex-lg-row width-full flex-justify-end flex-lg-items-center text-center mt-3 mt-lg-0 text-lg-left ml-lg-3">
                


<qbsearch-input class="search-input" data-scope="repo:openresty/lua-nginx-module" data-custom-scopes-path="/search/custom_scopes" data-delete-custom-scopes-csrf="AmXgYBVgkh3q2jqLoBUwRIypZ9ao-eJoe3HRedM_pMhOFKclsLPygRLklr4ZnKz2UFn0g1DubIoQqjQZDYL8iA" data-max-custom-scopes="10" data-header-redesign-enabled="false" data-initial-value="" data-blackbird-suggestions-path="/search/suggestions" data-jump-to-suggestions-path="/_graphql/GetSuggestedNavigationDestinations" data-current-repository="openresty/lua-nginx-module" data-current-org="openresty" data-current-owner="" data-logged-in="false" data-copilot-chat-enabled="false" data-nl-search-enabled="false" data-retain-scroll-position="true">
  <div
    class="search-input-container search-with-dialog position-relative d-flex flex-row flex-items-center mr-4 rounded"
    data-action="click:qbsearch-input#searchInputContainerClicked"
  >
      <button
        type="button"
        class="header-search-button placeholder  input-button form-control d-flex flex-1 flex-self-stretch flex-items-center no-wrap width-full py-0 pl-2 pr-0 text-left border-0 box-shadow-none"
        data-target="qbsearch-input.inputButton"
        aria-label="Search or jump to…"
        aria-haspopup="dialog"
        placeholder="Search or jump to..."
        data-hotkey=s,/
        autocapitalize="off"
        data-analytics-event="{&quot;location&quot;:&quot;navbar&quot;,&quot;action&quot;:&quot;searchbar&quot;,&quot;context&quot;:&quot;global&quot;,&quot;tag&quot;:&quot;input&quot;,&quot;label&quot;:&quot;searchbar_input_global_navbar&quot;}"
        data-action="click:qbsearch-input#handleExpand"
      >
        <div class="mr-2 color-fg-muted">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-search">
    <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path>
</svg>
        </div>
        <span class="flex-1" data-target="qbsearch-input.inputButtonText">Search or jump to...</span>
          <div class="d-flex" data-target="qbsearch-input.hotkeyIndicator">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="20" aria-hidden="true" class="mr-1"><path fill="none" stroke="#979A9C" opacity=".4" d="M3.5.5h12c1.7 0 3 1.3 3 3v13c0 1.7-1.3 3-3 3h-12c-1.7 0-3-1.3-3-3v-13c0-1.7 1.3-3 3-3z"></path><path fill="#979A9C" d="M11.8 6L8 15.1h-.9L10.8 6h1z"></path></svg>
          </div>
      </button>

    <input type="hidden" name="type" class="js-site-search-type-field">

    
<div class="Overlay--hidden " data-modal-dialog-overlay>
  <modal-dialog data-action="close:qbsearch-input#handleClose cancel:qbsearch-input#handleClose" data-target="qbsearch-input.searchSuggestionsDialog" role="dialog" id="search-suggestions-dialog" aria-modal="true" aria-labelledby="search-suggestions-dialog-header" data-view-component="true" class="Overlay Overlay--width-large Overlay--height-auto">
      <h1 id="search-suggestions-dialog-header" class="sr-only">Search code, repositories, users, issues, pull requests...</h1>
    <div class="Overlay-body Overlay-body--paddingNone">
      
          <div data-view-component="true">        <div class="search-suggestions position-fixed width-full color-shadow-large border color-fg-default color-bg-default overflow-hidden d-flex flex-column query-builder-container"
          style="border-radius: 12px;"
          data-target="qbsearch-input.queryBuilderContainer"
          hidden
        >
          <!-- '"` --><!-- </textarea></xmp> --></option></form><form id="query-builder-test-form" action="" accept-charset="UTF-8" method="get">
  <query-builder data-target="qbsearch-input.queryBuilder" id="query-builder-query-builder-test" data-filter-key=":" data-view-component="true" class="QueryBuilder search-query-builder">
    <div class="FormControl FormControl--fullWidth">
      <label id="query-builder-test-label" for="query-builder-test" class="FormControl-label sr-only">
        Search
      </label>
      <div
        class="QueryBuilder-StyledInput width-fit "
        data-target="query-builder.styledInput"
      >
          <span id="query-builder-test-leadingvisual-wrap" class="FormControl-input-leadingVisualWrap QueryBuilder-leadingVisualWrap">
            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-search FormControl-input-leadingVisual">
    <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path>
</svg>
          </span>
        <div data-target="query-builder.styledInputContainer" class="QueryBuilder-StyledInputContainer">
          <div
            aria-hidden="true"
            class="QueryBuilder-StyledInputContent"
            data-target="query-builder.styledInputContent"
          ></div>
          <div class="QueryBuilder-InputWrapper">
            <div aria-hidden="true" class="QueryBuilder-Sizer" data-target="query-builder.sizer"></div>
            <input id="query-builder-test" name="query-builder-test" value="" autocomplete="off" type="text" role="combobox" spellcheck="false" aria-expanded="false" aria-describedby="validation-1194a9d5-7342-474f-9dae-dfd90940231f" data-target="query-builder.input" data-action="
          input:query-builder#inputChange
          blur:query-builder#inputBlur
          keydown:query-builder#inputKeydown
          focus:query-builder#inputFocus
        " data-view-component="true" class="FormControl-input QueryBuilder-Input FormControl-medium" />
          </div>
        </div>
          <span class="sr-only" id="query-builder-test-clear">Clear</span>
          <button role="button" id="query-builder-test-clear-button" aria-labelledby="query-builder-test-clear query-builder-test-label" data-target="query-builder.clearButton" data-action="
                click:query-builder#clear
                focus:query-builder#clearButtonFocus
                blur:query-builder#clearButtonBlur
              " variant="small" hidden="hidden" type="button" data-view-component="true" class="Button Button--iconOnly Button--invisible Button--medium mr-1 px-2 py-0 d-flex flex-items-center rounded-1 color-fg-muted">  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x-circle-fill Button-visual">
    <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
</svg>
</button>

      </div>
      <template id="search-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-search">
    <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path>
</svg>
</template>

<template id="code-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-code">
    <path d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"></path>
</svg>
</template>

<template id="file-code-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-file-code">
    <path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0 1 14.25 15h-9a.75.75 0 0 1 0-1.5h9a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 10 4.25V1.5H5.75a.25.25 0 0 0-.25.25v2.5a.75.75 0 0 1-1.5 0Zm1.72 4.97a.75.75 0 0 1 1.06 0l2 2a.75.75 0 0 1 0 1.06l-2 2a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.47-1.47-1.47-1.47a.75.75 0 0 1 0-1.06ZM3.28 7.78 1.81 9.25l1.47 1.47a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018l-2-2a.75.75 0 0 1 0-1.06l2-2a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Zm8.22-6.218V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
</svg>
</template>

<template id="history-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-history">
    <path d="m.427 1.927 1.215 1.215a8.002 8.002 0 1 1-1.6 5.685.75.75 0 1 1 1.493-.154 6.5 6.5 0 1 0 1.18-4.458l1.358 1.358A.25.25 0 0 1 3.896 6H.25A.25.25 0 0 1 0 5.75V2.104a.25.25 0 0 1 .427-.177ZM7.75 4a.75.75 0 0 1 .75.75v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5A.75.75 0 0 1 7.75 4Z"></path>
</svg>
</template>

<template id="repo-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-repo">
    <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"></path>
</svg>
</template>

<template id="bookmark-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-bookmark">
    <path d="M3 2.75C3 1.784 3.784 1 4.75 1h6.5c.966 0 1.75.784 1.75 1.75v11.5a.75.75 0 0 1-1.227.579L8 11.722l-3.773 3.107A.751.751 0 0 1 3 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.91l3.023-2.489a.75.75 0 0 1 .954 0l3.023 2.49V2.75a.25.25 0 0 0-.25-.25Z"></path>
</svg>
</template>

<template id="plus-circle-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-plus-circle">
    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm7.25-3.25v2.5h2.5a.75.75 0 0 1 0 1.5h-2.5v2.5a.75.75 0 0 1-1.5 0v-2.5h-2.5a.75.75 0 0 1 0-1.5h2.5v-2.5a.75.75 0 0 1 1.5 0Z"></path>
</svg>
</template>

<template id="circle-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
</template>

<template id="trash-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-trash">
    <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"></path>
</svg>
</template>

<template id="team-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-people">
    <path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"></path>
</svg>
</template>

<template id="project-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-project">
    <path d="M1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25V1.75C0 .784.784 0 1.75 0ZM1.5 1.75v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25ZM11.75 3a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5a.75.75 0 0 1 .75-.75Zm-8.25.75a.75.75 0 0 1 1.5 0v5.5a.75.75 0 0 1-1.5 0ZM8 3a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 3Z"></path>
</svg>
</template>

<template id="pencil-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-pencil">
    <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"></path>
</svg>
</template>

<template id="copilot-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-copilot">
    <path d="M7.998 15.035c-4.562 0-7.873-2.914-7.998-3.749V9.338c.085-.628.677-1.686 1.588-2.065.013-.07.024-.143.036-.218.029-.183.06-.384.126-.612-.201-.508-.254-1.084-.254-1.656 0-.87.128-1.769.693-2.484.579-.733 1.494-1.124 2.724-1.261 1.206-.134 2.262.034 2.944.765.05.053.096.108.139.165.044-.057.094-.112.143-.165.682-.731 1.738-.899 2.944-.765 1.23.137 2.145.528 2.724 1.261.566.715.693 1.614.693 2.484 0 .572-.053 1.148-.254 1.656.066.228.098.429.126.612.012.076.024.148.037.218.924.385 1.522 1.471 1.591 2.095v1.872c0 .766-3.351 3.795-8.002 3.795Zm0-1.485c2.28 0 4.584-1.11 5.002-1.433V7.862l-.023-.116c-.49.21-1.075.291-1.727.291-1.146 0-2.059-.327-2.71-.991A3.222 3.222 0 0 1 8 6.303a3.24 3.24 0 0 1-.544.743c-.65.664-1.563.991-2.71.991-.652 0-1.236-.081-1.727-.291l-.023.116v4.255c.419.323 2.722 1.433 5.002 1.433ZM6.762 2.83c-.193-.206-.637-.413-1.682-.297-1.019.113-1.479.404-1.713.7-.247.312-.369.789-.369 1.554 0 .793.129 1.171.308 1.371.162.181.519.379 1.442.379.853 0 1.339-.235 1.638-.54.315-.322.527-.827.617-1.553.117-.935-.037-1.395-.241-1.614Zm4.155-.297c-1.044-.116-1.488.091-1.681.297-.204.219-.359.679-.242 1.614.091.726.303 1.231.618 1.553.299.305.784.54 1.638.54.922 0 1.28-.198 1.442-.379.179-.2.308-.578.308-1.371 0-.765-.123-1.242-.37-1.554-.233-.296-.693-.587-1.713-.7Z"></path><path d="M6.25 9.037a.75.75 0 0 1 .75.75v1.501a.75.75 0 0 1-1.5 0V9.787a.75.75 0 0 1 .75-.75Zm4.25.75v1.501a.75.75 0 0 1-1.5 0V9.787a.75.75 0 0 1 1.5 0Z"></path>
</svg>
</template>

<template id="copilot-error-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-copilot-error">
    <path d="M16 11.24c0 .112-.072.274-.21.467L13 9.688V7.862l-.023-.116c-.49.21-1.075.291-1.727.291-.198 0-.388-.009-.571-.029L6.833 5.226a4.01 4.01 0 0 0 .17-.782c.117-.935-.037-1.395-.241-1.614-.193-.206-.637-.413-1.682-.297-.683.076-1.115.231-1.395.415l-1.257-.91c.579-.564 1.413-.877 2.485-.996 1.206-.134 2.262.034 2.944.765.05.053.096.108.139.165.044-.057.094-.112.143-.165.682-.731 1.738-.899 2.944-.765 1.23.137 2.145.528 2.724 1.261.566.715.693 1.614.693 2.484 0 .572-.053 1.148-.254 1.656.066.228.098.429.126.612.012.076.024.148.037.218.924.385 1.522 1.471 1.591 2.095Zm-5.083-8.707c-1.044-.116-1.488.091-1.681.297-.204.219-.359.679-.242 1.614.091.726.303 1.231.618 1.553.299.305.784.54 1.638.54.922 0 1.28-.198 1.442-.379.179-.2.308-.578.308-1.371 0-.765-.123-1.242-.37-1.554-.233-.296-.693-.587-1.713-.7Zm2.511 11.074c-1.393.776-3.272 1.428-5.43 1.428-4.562 0-7.873-2.914-7.998-3.749V9.338c.085-.628.677-1.686 1.588-2.065.013-.07.024-.143.036-.218.029-.183.06-.384.126-.612-.18-.455-.241-.963-.252-1.475L.31 4.107A.747.747 0 0 1 0 3.509V3.49a.748.748 0 0 1 .625-.73c.156-.026.306.047.435.139l14.667 10.578a.592.592 0 0 1 .227.264.752.752 0 0 1 .046.249v.022a.75.75 0 0 1-1.19.596Zm-1.367-.991L5.635 7.964a5.128 5.128 0 0 1-.889.073c-.652 0-1.236-.081-1.727-.291l-.023.116v4.255c.419.323 2.722 1.433 5.002 1.433 1.539 0 3.089-.505 4.063-.934Z"></path>
</svg>
</template>

<template id="workflow-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-workflow">
    <path d="M0 1.75C0 .784.784 0 1.75 0h3.5C6.216 0 7 .784 7 1.75v3.5A1.75 1.75 0 0 1 5.25 7H4v4a1 1 0 0 0 1 1h4v-1.25C9 9.784 9.784 9 10.75 9h3.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0 1 14.25 16h-3.5A1.75 1.75 0 0 1 9 14.25v-.75H5A2.5 2.5 0 0 1 2.5 11V7h-.75A1.75 1.75 0 0 1 0 5.25Zm1.75-.25a.25.25 0 0 0-.25.25v3.5c0 .138.112.25.25.25h3.5a.25.25 0 0 0 .25-.25v-3.5a.25.25 0 0 0-.25-.25Zm9 9a.25.25 0 0 0-.25.25v3.5c0 .138.112.25.25.25h3.5a.25.25 0 0 0 .25-.25v-3.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
</template>

<template id="book-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-book">
    <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"></path>
</svg>
</template>

<template id="code-review-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-code-review">
    <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 13H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25v-8.5C0 1.784.784 1 1.75 1ZM1.5 2.75v8.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Zm5.28 1.72a.75.75 0 0 1 0 1.06L5.31 7l1.47 1.47a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018l-2-2a.75.75 0 0 1 0-1.06l2-2a.75.75 0 0 1 1.06 0Zm2.44 0a.75.75 0 0 1 1.06 0l2 2a.75.75 0 0 1 0 1.06l-2 2a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L10.69 7 9.22 5.53a.75.75 0 0 1 0-1.06Z"></path>
</svg>
</template>

<template id="codespaces-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-codespaces">
    <path d="M0 11.25c0-.966.784-1.75 1.75-1.75h12.5c.966 0 1.75.784 1.75 1.75v3A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25Zm2-9.5C2 .784 2.784 0 3.75 0h8.5C13.216 0 14 .784 14 1.75v5a1.75 1.75 0 0 1-1.75 1.75h-8.5A1.75 1.75 0 0 1 2 6.75Zm1.75-.25a.25.25 0 0 0-.25.25v5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-5a.25.25 0 0 0-.25-.25Zm-2 9.5a.25.25 0 0 0-.25.25v3c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-3a.25.25 0 0 0-.25-.25Z"></path><path d="M7 12.75a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Zm-4 0a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75Z"></path>
</svg>
</template>

<template id="comment-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-comment">
    <path d="M1 2.75C1 1.784 1.784 1 2.75 1h10.5c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 13.25 12H9.06l-2.573 2.573A1.458 1.458 0 0 1 4 13.543V12H2.75A1.75 1.75 0 0 1 1 10.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h4.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
</template>

<template id="comment-discussion-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-comment-discussion">
    <path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"></path>
</svg>
</template>

<template id="organization-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-organization">
    <path d="M1.75 16A1.75 1.75 0 0 1 0 14.25V1.75C0 .784.784 0 1.75 0h8.5C11.216 0 12 .784 12 1.75v12.5c0 .085-.006.168-.018.25h2.268a.25.25 0 0 0 .25-.25V8.285a.25.25 0 0 0-.111-.208l-1.055-.703a.749.749 0 1 1 .832-1.248l1.055.703c.487.325.779.871.779 1.456v5.965A1.75 1.75 0 0 1 14.25 16h-3.5a.766.766 0 0 1-.197-.026c-.099.017-.2.026-.303.026h-3a.75.75 0 0 1-.75-.75V14h-1v1.25a.75.75 0 0 1-.75.75Zm-.25-1.75c0 .138.112.25.25.25H4v-1.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 .75.75v1.25h2.25a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25ZM3.75 6h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5ZM3 3.75A.75.75 0 0 1 3.75 3h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 3.75Zm4 3A.75.75 0 0 1 7.75 6h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 7 6.75ZM7.75 3h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5ZM3 9.75A.75.75 0 0 1 3.75 9h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 9.75ZM7.75 9h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5Z"></path>
</svg>
</template>

<template id="rocket-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-rocket">
    <path d="M14.064 0h.186C15.216 0 16 .784 16 1.75v.186a8.752 8.752 0 0 1-2.564 6.186l-.458.459c-.314.314-.641.616-.979.904v3.207c0 .608-.315 1.172-.833 1.49l-2.774 1.707a.749.749 0 0 1-1.11-.418l-.954-3.102a1.214 1.214 0 0 1-.145-.125L3.754 9.816a1.218 1.218 0 0 1-.124-.145L.528 8.717a.749.749 0 0 1-.418-1.11l1.71-2.774A1.748 1.748 0 0 1 3.31 4h3.204c.288-.338.59-.665.904-.979l.459-.458A8.749 8.749 0 0 1 14.064 0ZM8.938 3.623h-.002l-.458.458c-.76.76-1.437 1.598-2.02 2.5l-1.5 2.317 2.143 2.143 2.317-1.5c.902-.583 1.74-1.26 2.499-2.02l.459-.458a7.25 7.25 0 0 0 2.123-5.127V1.75a.25.25 0 0 0-.25-.25h-.186a7.249 7.249 0 0 0-5.125 2.123ZM3.56 14.56c-.732.732-2.334 1.045-3.005 1.148a.234.234 0 0 1-.201-.064.234.234 0 0 1-.064-.201c.103-.671.416-2.273 1.15-3.003a1.502 1.502 0 1 1 2.12 2.12Zm6.94-3.935c-.088.06-.177.118-.266.175l-2.35 1.521.548 1.783 1.949-1.2a.25.25 0 0 0 .119-.213ZM3.678 8.116 5.2 5.766c.058-.09.117-.178.176-.266H3.309a.25.25 0 0 0-.213.119l-1.2 1.95ZM12 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</template>

<template id="shield-check-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-shield-check">
    <path d="m8.533.133 5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.697 1.697 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667l5.25-1.68a1.748 1.748 0 0 1 1.066 0Zm-.61 1.429.001.001-5.25 1.68a.251.251 0 0 0-.174.237V7c0 1.36.275 2.666 1.057 3.859.784 1.194 2.121 2.342 4.366 3.298a.196.196 0 0 0 .154 0c2.245-.957 3.582-2.103 4.366-3.297C13.225 9.666 13.5 8.358 13.5 7V3.48a.25.25 0 0 0-.174-.238l-5.25-1.68a.25.25 0 0 0-.153 0ZM11.28 6.28l-3.5 3.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l.97.97 2.97-2.97a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
</svg>
</template>

<template id="heart-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-heart">
    <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
</svg>
</template>

<template id="server-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-server">
    <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v4c0 .372-.116.717-.314 1 .198.283.314.628.314 1v4a1.75 1.75 0 0 1-1.75 1.75H1.75A1.75 1.75 0 0 1 0 12.75v-4c0-.358.109-.707.314-1a1.739 1.739 0 0 1-.314-1v-4C0 1.784.784 1 1.75 1ZM1.5 2.75v4c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Zm.25 5.75a.25.25 0 0 0-.25.25v4c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25ZM7 4.75A.75.75 0 0 1 7.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 7 4.75ZM7.75 10h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM3 4.75A.75.75 0 0 1 3.75 4h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 4.75ZM3.75 10h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5Z"></path>
</svg>
</template>

<template id="globe-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-globe">
    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM5.78 8.75a9.64 9.64 0 0 0 1.363 4.177c.255.426.542.832.857 1.215.245-.296.551-.705.857-1.215A9.64 9.64 0 0 0 10.22 8.75Zm4.44-1.5a9.64 9.64 0 0 0-1.363-4.177c-.307-.51-.612-.919-.857-1.215a9.927 9.927 0 0 0-.857 1.215A9.64 9.64 0 0 0 5.78 7.25Zm-5.944 1.5H1.543a6.507 6.507 0 0 0 4.666 5.5c-.123-.181-.24-.365-.352-.552-.715-1.192-1.437-2.874-1.581-4.948Zm-2.733-1.5h2.733c.144-2.074.866-3.756 1.58-4.948.12-.197.237-.381.353-.552a6.507 6.507 0 0 0-4.666 5.5Zm10.181 1.5c-.144 2.074-.866 3.756-1.58 4.948-.12.197-.237.381-.353.552a6.507 6.507 0 0 0 4.666-5.5Zm2.733-1.5a6.507 6.507 0 0 0-4.666-5.5c.123.181.24.365.353.552.714 1.192 1.436 2.874 1.58 4.948Z"></path>
</svg>
</template>

<template id="issue-opened-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-issue-opened">
    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
</svg>
</template>

<template id="device-mobile-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-device-mobile">
    <path d="M3.75 0h8.5C13.216 0 14 .784 14 1.75v12.5A1.75 1.75 0 0 1 12.25 16h-8.5A1.75 1.75 0 0 1 2 14.25V1.75C2 .784 2.784 0 3.75 0ZM3.5 1.75v12.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25ZM8 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path>
</svg>
</template>

<template id="package-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-package">
    <path d="m8.878.392 5.25 3.045c.54.314.872.89.872 1.514v6.098a1.75 1.75 0 0 1-.872 1.514l-5.25 3.045a1.75 1.75 0 0 1-1.756 0l-5.25-3.045A1.75 1.75 0 0 1 1 11.049V4.951c0-.624.332-1.201.872-1.514L7.122.392a1.75 1.75 0 0 1 1.756 0ZM7.875 1.69l-4.63 2.685L8 7.133l4.755-2.758-4.63-2.685a.248.248 0 0 0-.25 0ZM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432Zm6.25 8.271 4.625-2.683a.25.25 0 0 0 .125-.216V5.677L8.75 8.432Z"></path>
</svg>
</template>

<template id="credit-card-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-credit-card">
    <path d="M10.75 9a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5h-1.5Z"></path><path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25ZM14.5 6.5h-13v5.75c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25Zm0-2.75a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25V5h13Z"></path>
</svg>
</template>

<template id="play-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-play">
    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"></path>
</svg>
</template>

<template id="gift-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-gift">
    <path d="M2 2.75A2.75 2.75 0 0 1 4.75 0c.983 0 1.873.42 2.57 1.232.268.318.497.668.68 1.042.183-.375.411-.725.68-1.044C9.376.42 10.266 0 11.25 0a2.75 2.75 0 0 1 2.45 4h.55c.966 0 1.75.784 1.75 1.75v2c0 .698-.409 1.301-1 1.582v4.918A1.75 1.75 0 0 1 13.25 16H2.75A1.75 1.75 0 0 1 1 14.25V9.332C.409 9.05 0 8.448 0 7.75v-2C0 4.784.784 4 1.75 4h.55c-.192-.375-.3-.8-.3-1.25ZM7.25 9.5H2.5v4.75c0 .138.112.25.25.25h4.5Zm1.5 0v5h4.5a.25.25 0 0 0 .25-.25V9.5Zm0-4V8h5.5a.25.25 0 0 0 .25-.25v-2a.25.25 0 0 0-.25-.25Zm-7 0a.25.25 0 0 0-.25.25v2c0 .138.112.25.25.25h5.5V5.5h-5.5Zm3-4a1.25 1.25 0 0 0 0 2.5h2.309c-.233-.818-.542-1.401-.878-1.793-.43-.502-.915-.707-1.431-.707ZM8.941 4h2.309a1.25 1.25 0 0 0 0-2.5c-.516 0-1 .205-1.43.707-.337.392-.646.975-.879 1.793Z"></path>
</svg>
</template>

<template id="code-square-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-code-square">
    <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25Zm7.47 3.97a.75.75 0 0 1 1.06 0l2 2a.75.75 0 0 1 0 1.06l-2 2a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L10.69 8 9.22 6.53a.75.75 0 0 1 0-1.06ZM6.78 6.53 5.31 8l1.47 1.47a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215l-2-2a.75.75 0 0 1 0-1.06l2-2a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
</svg>
</template>

<template id="device-desktop-icon">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-device-desktop">
    <path d="M14.25 1c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 14.25 12h-3.727c.099 1.041.52 1.872 1.292 2.757A.752.752 0 0 1 11.25 16h-6.5a.75.75 0 0 1-.565-1.243c.772-.885 1.192-1.716 1.292-2.757H1.75A1.75 1.75 0 0 1 0 10.25v-7.5C0 1.784.784 1 1.75 1ZM1.75 2.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25ZM9.018 12H6.982a5.72 5.72 0 0 1-.765 2.5h3.566a5.72 5.72 0 0 1-.765-2.5Z"></path>
</svg>
</template>

        <div class="position-relative">
                <ul
                  role="listbox"
                  class="ActionListWrap QueryBuilder-ListWrap"
                  aria-label="Suggestions"
                  data-action="
                    combobox-commit:query-builder#comboboxCommit
                    mousedown:query-builder#resultsMousedown
                  "
                  data-target="query-builder.resultsList"
                  data-persist-list=false
                  id="query-builder-test-results"
                  tabindex="-1"
                ></ul>
        </div>
      <div class="FormControl-inlineValidation" id="validation-1194a9d5-7342-474f-9dae-dfd90940231f" hidden="hidden">
        <span class="FormControl-inlineValidation--visual">
          <svg aria-hidden="true" height="12" viewBox="0 0 12 12" version="1.1" width="12" data-view-component="true" class="octicon octicon-alert-fill">
    <path d="M4.855.708c.5-.896 1.79-.896 2.29 0l4.675 8.351a1.312 1.312 0 0 1-1.146 1.954H1.33A1.313 1.313 0 0 1 .183 9.058ZM7 7V3H5v4Zm-1 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"></path>
</svg>
        </span>
        <span></span>
</div>    </div>
    <div data-target="query-builder.screenReaderFeedback" aria-live="polite" aria-atomic="true" class="sr-only"></div>
</query-builder></form>
          <div class="d-flex flex-row color-fg-muted px-3 text-small color-bg-default search-feedback-prompt">
            <a target="_blank" href="https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax" data-view-component="true" class="Link color-fg-accent text-normal ml-2">Search syntax tips</a>            <div class="d-flex flex-1"></div>
          </div>
        </div>
</div>

    </div>
</modal-dialog></div>
  </div>
  <div data-action="click:qbsearch-input#retract" class="dark-backdrop position-fixed" hidden data-target="qbsearch-input.darkBackdrop"></div>
  <div class="color-fg-default">
    
<dialog-helper>
  <dialog data-target="qbsearch-input.feedbackDialog" data-action="close:qbsearch-input#handleDialogClose cancel:qbsearch-input#handleDialogClose" id="feedback-dialog" aria-modal="true" aria-labelledby="feedback-dialog-title" aria-describedby="feedback-dialog-description" data-view-component="true" class="Overlay Overlay-whenNarrow Overlay--size-medium Overlay--motion-scaleFade Overlay--disableScroll">
    <div data-view-component="true" class="Overlay-header">
  <div class="Overlay-headerContentWrap">
    <div class="Overlay-titleWrap">
      <h1 class="Overlay-title " id="feedback-dialog-title">
        Provide feedback
      </h1>
        
    </div>
    <div class="Overlay-actionWrap">
      <button data-close-dialog-id="feedback-dialog" aria-label="Close" aria-label="Close" type="button" data-view-component="true" class="close-button Overlay-closeButton"><svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg></button>
    </div>
  </div>
  
</div>
      <scrollable-region data-labelled-by="feedback-dialog-title">
        <div data-view-component="true" class="Overlay-body">        <!-- '"` --><!-- </textarea></xmp> --></option></form><form id="code-search-feedback-form" data-turbo="false" action="/search/feedback" accept-charset="UTF-8" method="post"><input type="hidden" data-csrf="true" name="authenticity_token" value="+8THPrOB0gDkeWsgjXC0ncgOikPEEw7RADW3l3PHSAOGheRGePjJTHTfmPY3zQ3AKtjV9QGKJOvSef5MhxpAxw==" />
          <p>We read every piece of feedback, and take your input very seriously.</p>
          <textarea name="feedback" class="form-control width-full mb-2" style="height: 120px" id="feedback"></textarea>
          <input name="include_email" id="include_email" aria-label="Include my email address so I can be contacted" class="form-control mr-2" type="checkbox">
          <label for="include_email" style="font-weight: normal">Include my email address so I can be contacted</label>
</form></div>
      </scrollable-region>
      <div data-view-component="true" class="Overlay-footer Overlay-footer--alignEnd">          <button data-close-dialog-id="feedback-dialog" type="button" data-view-component="true" class="btn">    Cancel
</button>
          <button form="code-search-feedback-form" data-action="click:qbsearch-input#submitFeedback" type="submit" data-view-component="true" class="btn-primary btn">    Submit feedback
</button>
</div>
</dialog></dialog-helper>

    <custom-scopes data-target="qbsearch-input.customScopesManager">
    
<dialog-helper>
  <dialog data-target="custom-scopes.customScopesModalDialog" data-action="close:qbsearch-input#handleDialogClose cancel:qbsearch-input#handleDialogClose" id="custom-scopes-dialog" aria-modal="true" aria-labelledby="custom-scopes-dialog-title" aria-describedby="custom-scopes-dialog-description" data-view-component="true" class="Overlay Overlay-whenNarrow Overlay--size-medium Overlay--motion-scaleFade Overlay--disableScroll">
    <div data-view-component="true" class="Overlay-header Overlay-header--divided">
  <div class="Overlay-headerContentWrap">
    <div class="Overlay-titleWrap">
      <h1 class="Overlay-title " id="custom-scopes-dialog-title">
        Saved searches
      </h1>
        <h2 id="custom-scopes-dialog-description" class="Overlay-description">Use saved searches to filter your results more quickly</h2>
    </div>
    <div class="Overlay-actionWrap">
      <button data-close-dialog-id="custom-scopes-dialog" aria-label="Close" aria-label="Close" type="button" data-view-component="true" class="close-button Overlay-closeButton"><svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg></button>
    </div>
  </div>
  
</div>
      <scrollable-region data-labelled-by="custom-scopes-dialog-title">
        <div data-view-component="true" class="Overlay-body">        <div data-target="custom-scopes.customScopesModalDialogFlash"></div>

        <div hidden class="create-custom-scope-form" data-target="custom-scopes.createCustomScopeForm">
        <!-- '"` --><!-- </textarea></xmp> --></option></form><form id="custom-scopes-dialog-form" data-turbo="false" action="/search/custom_scopes" accept-charset="UTF-8" method="post"><input type="hidden" data-csrf="true" name="authenticity_token" value="TkuaapLPEB1Diwj1n4R4AYaNijBUTsz59tXIRgJ4XDWfm4x52vh/Lf3Qb0cG8H/xqgzb8AOWTJ1jD/r+k3tdaw==" />
          <div data-target="custom-scopes.customScopesModalDialogFlash"></div>

          <input type="hidden" id="custom_scope_id" name="custom_scope_id" data-target="custom-scopes.customScopesIdField">

          <div class="form-group">
            <label for="custom_scope_name">Name</label>
            <auto-check src="/search/custom_scopes/check_name" required>
              <input
                type="text"
                name="custom_scope_name"
                id="custom_scope_name"
                data-target="custom-scopes.customScopesNameField"
                class="form-control"
                autocomplete="off"
                placeholder="github-ruby"
                required
                maxlength="50">
              <input type="hidden" data-csrf="true" value="qr8vSaMAVimD3FHWK9y4YVlxVVHEdnP3My87agowfPqJlquJ1KHZNN1Bt2fhAP+5ZPJU8kdGRw4ouU3K0BcmUg==" />
            </auto-check>
          </div>

          <div class="form-group">
            <label for="custom_scope_query">Query</label>
            <input
              type="text"
              name="custom_scope_query"
              id="custom_scope_query"
              data-target="custom-scopes.customScopesQueryField"
              class="form-control"
              autocomplete="off"
              placeholder="(repo:mona/a OR repo:mona/b) AND lang:python"
              required
              maxlength="500">
          </div>

          <p class="text-small color-fg-muted">
            To see all available qualifiers, see our <a class="Link--inTextBlock" href="https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax">documentation</a>.
          </p>
</form>        </div>

        <div data-target="custom-scopes.manageCustomScopesForm">
          <div data-target="custom-scopes.list"></div>
        </div>

</div>
      </scrollable-region>
      <div data-view-component="true" class="Overlay-footer Overlay-footer--alignEnd Overlay-footer--divided">          <button data-action="click:custom-scopes#customScopesCancel" type="button" data-view-component="true" class="btn">    Cancel
</button>
          <button form="custom-scopes-dialog-form" data-action="click:custom-scopes#customScopesSubmit" data-target="custom-scopes.customScopesSubmitButton" type="submit" data-view-component="true" class="btn-primary btn">    Create saved search
</button>
</div>
</dialog></dialog-helper>
    </custom-scopes>
  </div>
</qbsearch-input>


            <div class="position-relative HeaderMenu-link-wrap d-lg-inline-block">
              <a
                href="/login?return_to=https%3A%2F%2Fgithub.com%2Fopenresty%2Flua-nginx-module"
                class="HeaderMenu-link HeaderMenu-link--sign-in HeaderMenu-button flex-shrink-0 no-underline d-none d-lg-inline-flex border border-lg-0 rounded px-2 py-1"
                style="margin-left: 12px;"
                data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;site header menu&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;SIGN_UP&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="08a7380e479b2797416d11d8727cd24ccc936fc1127e80d25982889679295abd"
                data-analytics-event="{&quot;category&quot;:&quot;Marketing nav&quot;,&quot;action&quot;:&quot;click to go to homepage&quot;,&quot;label&quot;:&quot;ref_page:Marketing;ref_cta:Sign in;ref_loc:Header&quot;}"
              >
                Sign in
              </a>
            </div>

              <a href="/signup?ref_cta=Sign+up&amp;ref_loc=header+logged+out&amp;ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&amp;source=header-repo&amp;source_repo=openresty%2Flua-nginx-module"
                class="HeaderMenu-link HeaderMenu-link--sign-up HeaderMenu-button flex-shrink-0 d-flex d-lg-inline-flex no-underline border color-border-default rounded px-2 py-1"
                data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;site header menu&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;SIGN_UP&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="08a7380e479b2797416d11d8727cd24ccc936fc1127e80d25982889679295abd"
                data-analytics-event="{&quot;category&quot;:&quot;Sign up&quot;,&quot;action&quot;:&quot;click to sign up for account&quot;,&quot;label&quot;:&quot;ref_page:/&lt;user-name&gt;/&lt;repo-name&gt;;ref_cta:Sign up;ref_loc:header logged out&quot;}"
              >
                Sign up
              </a>

                <div class="AppHeader-appearanceSettings">
    <react-partial-anchor>
      <button data-target="react-partial-anchor.anchor" id="icon-button-56c55b91-973b-4840-856b-16c2c5a49cd6" aria-labelledby="tooltip-4567157f-d53d-4a44-b3a8-a3a4ae9acb0f" type="button" disabled="disabled" data-view-component="true" class="Button Button--iconOnly Button--invisible Button--medium AppHeader-button HeaderMenu-link border cursor-wait">  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-sliders Button-visual">
    <path d="M15 2.75a.75.75 0 0 1-.75.75h-4a.75.75 0 0 1 0-1.5h4a.75.75 0 0 1 .75.75Zm-8.5.75v1.25a.75.75 0 0 0 1.5 0v-4a.75.75 0 0 0-1.5 0V2H1.75a.75.75 0 0 0 0 1.5H6.5Zm1.25 5.25a.75.75 0 0 0 0-1.5h-6a.75.75 0 0 0 0 1.5h6ZM15 8a.75.75 0 0 1-.75.75H11.5V10a.75.75 0 1 1-1.5 0V6a.75.75 0 0 1 1.5 0v1.25h2.75A.75.75 0 0 1 15 8Zm-9 5.25v-2a.75.75 0 0 0-1.5 0v1.25H1.75a.75.75 0 0 0 0 1.5H4.5v1.25a.75.75 0 0 0 1.5 0v-2Zm9 0a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1 0-1.5h6a.75.75 0 0 1 .75.75Z"></path>
</svg>
</button><tool-tip id="tooltip-4567157f-d53d-4a44-b3a8-a3a4ae9acb0f" for="icon-button-56c55b91-973b-4840-856b-16c2c5a49cd6" popover="manual" data-direction="s" data-type="label" data-view-component="true" class="sr-only position-absolute">Appearance settings</tool-tip>

      <template data-target="react-partial-anchor.template">
        <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/appearance-settings.6c63a6de228d6520804d.module.css" />

<react-partial
  partial-name="appearance-settings"
  data-ssr="false"
  data-attempted-ssr="false"
  data-react-profiling="false"
>
  
  <script type="application/json" data-target="react-partial.embeddedData">{"props":{}}</script>
  <div data-target="react-partial.reactRoot"></div>
</react-partial>


      </template>
    </react-partial-anchor>
  </div>

          <button type="button" class="sr-only js-header-menu-focus-trap d-block d-lg-none">Resetting focus</button>
        </div>
      </div>
    </div>
  </div>
</header>

      <div hidden="hidden" data-view-component="true" class="js-stale-session-flash stale-session-flash flash flash-warn flash-full">
  
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
        <span class="js-stale-session-flash-signed-in" hidden>You signed in with another tab or window. <a class="Link--inTextBlock" href="">Reload</a> to refresh your session.</span>
        <span class="js-stale-session-flash-signed-out" hidden>You signed out in another tab or window. <a class="Link--inTextBlock" href="">Reload</a> to refresh your session.</span>
        <span class="js-stale-session-flash-switched" hidden>You switched accounts on another tab or window. <a class="Link--inTextBlock" href="">Reload</a> to refresh your session.</span>

    <button id="icon-button-6eec3f1a-bfe6-405c-acc3-b72604617f9f" aria-labelledby="tooltip-ec0e6bdb-29d6-4002-8fb4-370f404e24a6" type="button" data-view-component="true" class="Button Button--iconOnly Button--invisible Button--medium flash-close js-flash-close">  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x Button-visual">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg>
</button><tool-tip id="tooltip-ec0e6bdb-29d6-4002-8fb4-370f404e24a6" for="icon-button-6eec3f1a-bfe6-405c-acc3-b72604617f9f" popover="manual" data-direction="s" data-type="label" data-view-component="true" class="sr-only position-absolute">Dismiss alert</tool-tip>


  
</div>
    </div>

  <div id="start-of-content" class="show-on-focus"></div>








    <div id="js-flash-container" class="flash-container" data-turbo-replace>




  <template class="js-flash-template">
    
<div class="flash flash-full   {{ className }}">
  <div >
    <button autofocus class="flash-close js-flash-close" type="button" aria-label="Dismiss this message">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg>
    </button>
    <div aria-atomic="true" role="alert" class="js-flash-alert">
      
      <div>{{ message }}</div>

    </div>
  </div>
</div>
  </template>
</div>


    






  <div
    class="application-main "
    data-commit-hovercards-enabled
    data-discussion-hovercards-enabled
    data-issue-and-pr-hovercards-enabled
    data-project-hovercards-enabled
  >
        <div itemscope itemtype="http://schema.org/SoftwareSourceCode" class="">
    <main id="js-repo-pjax-container" >
      
  





    
    

    






  
  <div id="repository-container-header"  class="pt-3 hide-full-screen" style="background-color: var(--page-header-bgColor, var(--color-page-header-bg));" data-turbo-replace>

      <div class="d-flex flex-nowrap flex-justify-end mb-3  px-3 px-lg-5" style="gap: 1rem;">

        <div class="flex-auto min-width-0 width-fit">
            
  <div class=" d-flex flex-wrap flex-items-center wb-break-word f3 text-normal">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-repo color-fg-muted mr-2">
    <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"></path>
</svg>
    
    <span class="author flex-self-stretch" itemprop="author">
      <a class="url fn" rel="author" data-hovercard-type="organization" data-hovercard-url="/orgs/openresty/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="/openresty">
        openresty
</a>    </span>
    <span class="mx-1 flex-self-stretch color-fg-muted">/</span>
    <strong itemprop="name" class="mr-2 flex-self-stretch">
      <a data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" href="/openresty/lua-nginx-module">lua-nginx-module</a>
    </strong>

    <span></span><span class="Label Label--secondary v-align-middle mr-1">Public</span>
  </div>


        </div>

        <div id="repository-details-container" class="flex-shrink-0" data-turbo-replace style="max-width: 70%;">
            <ul class="pagehead-actions flex-shrink-0 d-none d-md-inline" style="padding: 2px 0;">
    
      

  <li>
            <a href="/login?return_to=%2Fopenresty%2Flua-nginx-module" rel="nofollow" id="repository-details-watch-button" data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;notification subscription menu watch&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;LOG_IN&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="f579b1e798a1e5b6ba35812e8fd4e21fd5983bc50d2cda27df952d246a4ca142" aria-label="You must be signed in to change notification settings" data-view-component="true" class="btn-sm btn">    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-bell mr-2">
    <path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"></path>
</svg>Notifications
</a>    <tool-tip id="tooltip-abb250c8-4e95-4274-b61c-891fc6cad603" for="repository-details-watch-button" popover="manual" data-direction="s" data-type="description" data-view-component="true" class="sr-only position-absolute">You must be signed in to change notification settings</tool-tip>

  </li>

  <li>
          <a icon="repo-forked" id="fork-button" href="/login?return_to=%2Fopenresty%2Flua-nginx-module" rel="nofollow" data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;repo details fork button&quot;,&quot;repository_id&quot;:613829,&quot;auth_type&quot;:&quot;LOG_IN&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="43ce436cb123682848c23303279718d5192dd94089bd3433a5294f4859a806b5" data-view-component="true" class="btn-sm btn">    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-repo-forked mr-2">
    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path>
</svg>Fork
    <span id="repo-network-counter" data-pjax-replace="true" data-turbo-replace="true" title="2,063" data-view-component="true" class="Counter">2.1k</span>
</a>
  </li>

  <li>
        <div data-view-component="true" class="BtnGroup d-flex">
        <a href="/login?return_to=%2Fopenresty%2Flua-nginx-module" rel="nofollow" data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;star button&quot;,&quot;repository_id&quot;:613829,&quot;auth_type&quot;:&quot;LOG_IN&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="8c4215ae1b3fab12703e2001934805689374137857d65eb1cba4ae55207caf51" aria-label="You must be signed in to star a repository" data-view-component="true" class="tooltipped tooltipped-sw btn-sm btn">    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-star v-align-text-bottom d-inline-block mr-2">
    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"></path>
</svg><span data-view-component="true" class="d-inline">
          Star
</span>          <span id="repo-stars-counter-star" aria-label="11653 users starred this repository" data-singular-suffix="user starred this repository" data-plural-suffix="users starred this repository" data-turbo-replace="true" title="11,653" data-view-component="true" class="Counter js-social-count">11.7k</span>
</a></div>
  </li>

</ul>

        </div>
      </div>

        <div id="responsive-meta-container" data-turbo-replace>
      <div class="d-block d-md-none mb-2 px-3 px-md-4 px-lg-5">
      <p class="f4 mb-3 ">
        Embed the Power of Lua into NGINX HTTP servers
      </p>
      <div class="mb-2 d-flex flex-items-center Link--secondary">
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link flex-shrink-0 mr-2">
    <path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path>
</svg>
        <span class="flex-auto min-width-0 css-truncate css-truncate-target width-fit">
          <a title="https://openresty.org/" role="link" target="_blank" class="text-bold" rel="noopener noreferrer" href="https://openresty.org/">openresty.org/</a>
        </span>
      </div>

    

    <div class="mb-3">
        <a class="Link--secondary no-underline mr-3" href="/openresty/lua-nginx-module/stargazers">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-star mr-1">
    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"></path>
</svg>
          <span class="text-bold">11.7k</span>
          stars
</a>        <a class="Link--secondary no-underline mr-3" href="/openresty/lua-nginx-module/forks">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-repo-forked mr-1">
    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path>
</svg>
          <span class="text-bold">2.1k</span>
          forks
</a>        <a class="Link--secondary no-underline mr-3 d-inline-block" href="/openresty/lua-nginx-module/branches">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-git-branch mr-1">
    <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path>
</svg>
          <span>Branches</span>
</a>        <a class="Link--secondary no-underline d-inline-block" href="/openresty/lua-nginx-module/tags">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-tag mr-1">
    <path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path>
</svg>
          <span>Tags</span>
</a>        <a class="Link--secondary no-underline d-inline-block" href="/openresty/lua-nginx-module/activity">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-pulse mr-1">
    <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path>
</svg>
          <span>Activity</span>
</a>    </div>

      <div class="d-flex flex-wrap gap-2">
        <div class="flex-1">
            <div data-view-component="true" class="BtnGroup d-flex">
        <a href="/login?return_to=%2Fopenresty%2Flua-nginx-module" rel="nofollow" data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;star button&quot;,&quot;repository_id&quot;:613829,&quot;auth_type&quot;:&quot;LOG_IN&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="8c4215ae1b3fab12703e2001934805689374137857d65eb1cba4ae55207caf51" aria-label="You must be signed in to star a repository" data-view-component="true" class="tooltipped tooltipped-sw btn-sm btn btn-block">    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-star v-align-text-bottom d-inline-block mr-2">
    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"></path>
</svg><span data-view-component="true" class="d-inline">
          Star
</span>
</a></div>
        </div>
        <div class="flex-1">
                <a href="/login?return_to=%2Fopenresty%2Flua-nginx-module" rel="nofollow" id="files-overview-watch-button" data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;notification subscription menu watch&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;LOG_IN&quot;,&quot;originating_url&quot;:&quot;https://github.com/openresty/lua-nginx-module&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="f579b1e798a1e5b6ba35812e8fd4e21fd5983bc50d2cda27df952d246a4ca142" aria-label="You must be signed in to change notification settings" data-view-component="true" class="btn-sm btn btn-block">    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-bell mr-2">
    <path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"></path>
</svg>Notifications
</a>    <tool-tip id="tooltip-f28126e8-6b71-422e-a8d4-86d9cc0516c4" for="files-overview-watch-button" popover="manual" data-direction="s" data-type="description" data-view-component="true" class="sr-only position-absolute">You must be signed in to change notification settings</tool-tip>

        </div>
        <span>
          

        </span>
      </div>
  </div>

</div>


          <nav data-pjax="#js-repo-pjax-container" aria-label="Repository" data-view-component="true" class="js-repo-nav js-sidenav-container-pjax js-responsive-underlinenav overflow-hidden UnderlineNav px-3 px-md-4 px-lg-5">

  <ul data-view-component="true" class="UnderlineNav-body list-style-none">
      <li data-view-component="true" class="d-inline-flex">
  <a id="code-tab" href="/openresty/lua-nginx-module" data-tab-item="i0code-tab" data-selected-links="repo_source repo_downloads repo_commits repo_releases repo_tags repo_branches repo_packages repo_deployments repo_attestations /openresty/lua-nginx-module" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g c" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Code&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" aria-current="page" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item selected">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-code UnderlineNav-octicon d-none d-sm-inline">
    <path d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"></path>
</svg>
        <span data-content="Code">Code</span>
          <span id="code-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="Not available" data-view-component="true" class="Counter"></span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="issues-tab" href="/openresty/lua-nginx-module/issues" data-tab-item="i1issues-tab" data-selected-links="repo_issues repo_labels repo_milestones /openresty/lua-nginx-module/issues" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g i" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Issues&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-issue-opened UnderlineNav-octicon d-none d-sm-inline">
    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
</svg>
        <span data-content="Issues">Issues</span>
          <span id="issues-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="348" data-view-component="true" class="Counter">348</span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="pull-requests-tab" href="/openresty/lua-nginx-module/pulls" data-tab-item="i2pull-requests-tab" data-selected-links="repo_pulls checks /openresty/lua-nginx-module/pulls" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g p" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Pull requests&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-git-pull-request UnderlineNav-octicon d-none d-sm-inline">
    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"></path>
</svg>
        <span data-content="Pull requests">Pull requests</span>
          <span id="pull-requests-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="36" data-view-component="true" class="Counter">36</span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="actions-tab" href="/openresty/lua-nginx-module/actions" data-tab-item="i3actions-tab" data-selected-links="repo_actions /openresty/lua-nginx-module/actions" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g a" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Actions&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-play UnderlineNav-octicon d-none d-sm-inline">
    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"></path>
</svg>
        <span data-content="Actions">Actions</span>
          <span id="actions-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="Not available" data-view-component="true" class="Counter"></span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="projects-tab" href="/openresty/lua-nginx-module/projects" data-tab-item="i4projects-tab" data-selected-links="repo_projects new_repo_project repo_project /openresty/lua-nginx-module/projects" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g b" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Projects&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-table UnderlineNav-octicon d-none d-sm-inline">
    <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25ZM6.5 6.5v8h7.75a.25.25 0 0 0 .25-.25V6.5Zm8-1.5V1.75a.25.25 0 0 0-.25-.25H6.5V5Zm-13 1.5v7.75c0 .138.112.25.25.25H5v-8ZM5 5V1.5H1.75a.25.25 0 0 0-.25.25V5Z"></path>
</svg>
        <span data-content="Projects">Projects</span>
          <span id="projects-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="0" hidden="hidden" data-view-component="true" class="Counter">0</span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="wiki-tab" href="/openresty/lua-nginx-module/wiki" data-tab-item="i5wiki-tab" data-selected-links="repo_wiki /openresty/lua-nginx-module/wiki" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g w" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Wiki&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-book UnderlineNav-octicon d-none d-sm-inline">
    <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"></path>
</svg>
        <span data-content="Wiki">Wiki</span>
          <span id="wiki-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="Not available" data-view-component="true" class="Counter"></span>


    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="security-tab" href="/openresty/lua-nginx-module/security" data-tab-item="i6security-tab" data-selected-links="security overview alerts policy token_scanning code_scanning /openresty/lua-nginx-module/security" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-hotkey="g s" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Security&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-shield UnderlineNav-octicon d-none d-sm-inline">
    <path d="M7.467.133a1.748 1.748 0 0 1 1.066 0l5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.697 1.697 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667Zm.61 1.429a.25.25 0 0 0-.153 0l-5.25 1.68a.25.25 0 0 0-.174.238V7c0 1.358.275 2.666 1.057 3.86.784 1.194 2.121 2.34 4.366 3.297a.196.196 0 0 0 .154 0c2.245-.956 3.582-2.104 4.366-3.298C13.225 9.666 13.5 8.36 13.5 7V3.48a.251.251 0 0 0-.174-.237l-5.25-1.68ZM8.75 4.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 1.5 0ZM9 10.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
        <span data-content="Security">Security</span>
          <include-fragment src="/openresty/lua-nginx-module/security/overall-count" accept="text/fragment+html" data-nonce="v2:52c78e24-b6ba-2bee-e25d-671c7be5c833" data-view-component="true">
  
  <div data-show-on-forbidden-error hidden>
    <div class="Box">
  <div class="blankslate-container">
    <div data-view-component="true" class="blankslate blankslate-spacious color-bg-default rounded-2">
      

      <h3 data-view-component="true" class="blankslate-heading">        Uh oh!
</h3>
      <p data-view-component="true">        <p class="color-fg-muted my-2 mb-2 ws-normal">There was an error while loading. <a class="Link--inTextBlock" data-turbo="false" href="" aria-label="Please reload this page">Please reload this page</a>.</p>
</p>

</div>  </div>
</div>  </div>
</include-fragment>

    
</a></li>
      <li data-view-component="true" class="d-inline-flex">
  <a id="insights-tab" href="/openresty/lua-nginx-module/pulse" data-tab-item="i7insights-tab" data-selected-links="repo_graphs repo_contributors dependency_graph dependabot_updates pulse people community /openresty/lua-nginx-module/pulse" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" data-analytics-event="{&quot;category&quot;:&quot;Underline navbar&quot;,&quot;action&quot;:&quot;Click tab&quot;,&quot;label&quot;:&quot;Insights&quot;,&quot;target&quot;:&quot;UNDERLINE_NAV.TAB&quot;}" data-view-component="true" class="UnderlineNav-item no-wrap js-responsive-underlinenav-item js-selected-navigation-item">
    
              <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-graph UnderlineNav-octicon d-none d-sm-inline">
    <path d="M1.5 1.75V13.5h13.75a.75.75 0 0 1 0 1.5H.75a.75.75 0 0 1-.75-.75V1.75a.75.75 0 0 1 1.5 0Zm14.28 2.53-5.25 5.25a.75.75 0 0 1-1.06 0L7 7.06 4.28 9.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.25-3.25a.75.75 0 0 1 1.06 0L10 7.94l4.72-4.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
</svg>
        <span data-content="Insights">Insights</span>
          <span id="insights-repo-tab-count" data-pjax-replace="" data-turbo-replace="" title="Not available" data-view-component="true" class="Counter"></span>


    
</a></li>
</ul>
    <div style="visibility:hidden;" data-view-component="true" class="UnderlineNav-actions js-responsive-underlinenav-overflow position-absolute pr-3 pr-md-4 pr-lg-5 right-0">      <action-menu data-select-variant="none" data-view-component="true">
  <focus-group direction="vertical" mnemonics retain>
    <button id="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-button" popovertarget="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-overlay" aria-controls="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-list" aria-haspopup="true" aria-labelledby="tooltip-69a112f2-b96c-4498-aadd-1307e382e0cc" type="button" data-view-component="true" class="Button Button--iconOnly Button--secondary Button--medium UnderlineNav-item">  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-kebab-horizontal Button-visual">
    <path d="M8 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM1.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm13 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
</svg>
</button><tool-tip id="tooltip-69a112f2-b96c-4498-aadd-1307e382e0cc" for="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-button" popover="manual" data-direction="s" data-type="label" data-view-component="true" class="sr-only position-absolute">Additional navigation options</tool-tip>


<anchored-position data-target="action-menu.overlay" id="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-overlay" anchor="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-button" align="start" side="outside-bottom" anchor-offset="normal" popover="auto" data-view-component="true">
  <div data-view-component="true" class="Overlay Overlay--size-auto">
    
      <div data-view-component="true" class="Overlay-body Overlay-body--paddingNone">          <action-list>
  <div data-view-component="true">
    <ul aria-labelledby="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-button" id="action-menu-afa7979d-e791-4cf3-8151-b21455ee039c-list" role="menu" data-view-component="true" class="ActionListWrap--inset ActionListWrap">
        <li hidden="hidden" data-menu-item="i0code-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-9121d5ab-1561-4696-9303-3d4139d1df5e" href="/openresty/lua-nginx-module" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-code">
    <path d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Code
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i1issues-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-481a0a9f-2e2b-4e1e-a5ef-2089d9028297" href="/openresty/lua-nginx-module/issues" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-issue-opened">
    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Issues
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i2pull-requests-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-dbc78d16-bfca-49c4-acfb-34b235edf2ed" href="/openresty/lua-nginx-module/pulls" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-git-pull-request">
    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Pull requests
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i3actions-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-350d1b7e-bed0-48bc-8d2b-1da7d8fb8ab1" href="/openresty/lua-nginx-module/actions" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-play">
    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Actions
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i4projects-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-431f4b02-7179-45df-a493-be52575e3414" href="/openresty/lua-nginx-module/projects" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-table">
    <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25ZM6.5 6.5v8h7.75a.25.25 0 0 0 .25-.25V6.5Zm8-1.5V1.75a.25.25 0 0 0-.25-.25H6.5V5Zm-13 1.5v7.75c0 .138.112.25.25.25H5v-8ZM5 5V1.5H1.75a.25.25 0 0 0-.25.25V5Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Projects
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i5wiki-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-b1bcdc66-a8ef-438b-97f3-c92c052db871" href="/openresty/lua-nginx-module/wiki" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-book">
    <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Wiki
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i6security-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-4c7849f0-c679-4212-a646-bcc046524a9d" href="/openresty/lua-nginx-module/security" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-shield">
    <path d="M7.467.133a1.748 1.748 0 0 1 1.066 0l5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.697 1.697 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667Zm.61 1.429a.25.25 0 0 0-.153 0l-5.25 1.68a.25.25 0 0 0-.174.238V7c0 1.358.275 2.666 1.057 3.86.784 1.194 2.121 2.34 4.366 3.297a.196.196 0 0 0 .154 0c2.245-.956 3.582-2.104 4.366-3.298C13.225 9.666 13.5 8.36 13.5 7V3.48a.251.251 0 0 0-.174-.237l-5.25-1.68ZM8.75 4.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 1.5 0ZM9 10.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Security
</span>      
</a>
  
</li>
        <li hidden="hidden" data-menu-item="i7insights-tab" data-targets="action-list.items" role="none" data-view-component="true" class="ActionListItem">
    
    
    <a tabindex="-1" id="item-b11bdaf7-054c-4442-bed5-d17583b1bcd8" href="/openresty/lua-nginx-module/pulse" role="menuitem" data-view-component="true" class="ActionListContent ActionListContent--visual16">
        <span class="ActionListItem-visual ActionListItem-visual--leading">
          <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-graph">
    <path d="M1.5 1.75V13.5h13.75a.75.75 0 0 1 0 1.5H.75a.75.75 0 0 1-.75-.75V1.75a.75.75 0 0 1 1.5 0Zm14.28 2.53-5.25 5.25a.75.75 0 0 1-1.06 0L7 7.06 4.28 9.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.25-3.25a.75.75 0 0 1 1.06 0L10 7.94l4.72-4.72a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
</svg>
        </span>
      
        <span data-view-component="true" class="ActionListItem-label">
          Insights
</span>      
</a>
  
</li>
</ul>    
</div></action-list>


</div>
      
</div></anchored-position>  </focus-group>
</action-menu></div>
</nav>

  </div>

  



<turbo-frame id="repo-content-turbo-frame" target="_top" data-turbo-action="advance" class="">
    <div id="repo-content-pjax-container" class="repository-content " >
    



    
      
  <h1 class='sr-only'>openresty/lua-nginx-module</h1>
  <div class="clearfix container-xl px-md-4 px-lg-5 px-3">
    <div>

  <div style="max-width: 100%" data-view-component="true" class="Layout Layout--flowRow-until-md react-repos-overview-margin Layout--sidebarPosition-end Layout--sidebarPosition-flowRow-end">
  <div data-view-component="true" class="Layout-main">      <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-react.f595f41454298e934d3c.module.css" />
<link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/app_assets_modules_react-partials_repos-overview_components_OverviewContent_module_css-app_as-2f8a17.0268c3a576b1dbc77d72.module.css" />

<react-partial
  partial-name="repos-overview"
  data-ssr="true"
  data-attempted-ssr="true"
  data-react-profiling="false"
>
  
  <script type="application/json" data-target="react-partial.embeddedData">{"props":{"initialPayload":{"allShortcutsEnabled":false,"path":"/","repo":{"id":613829,"defaultBranch":"master","name":"lua-nginx-module","ownerLogin":"openresty","currentUserCanPush":false,"isFork":false,"isEmpty":false,"createdAt":"2010-04-16T15:59:01.000Z","ownerAvatar":"https://avatars.githubusercontent.com/u/7390180?v=4","public":true,"private":false,"isOrgOwned":true},"currentUser":null,"refInfo":{"name":"master","listCacheKey":"v0:1761101237.0","canEdit":false,"refType":"branch","currentOid":"47e8d8b485e12cb7cb4a17da0dc828ee83a67b45"},"tree":{"items":[{"name":".github","path":".github","contentType":"directory"},{"name":"doc","path":"doc","contentType":"directory"},{"name":"dtrace","path":"dtrace","contentType":"directory"},{"name":"misc/recv-until-pm","path":"misc/recv-until-pm","contentType":"directory","hasSimplifiedPath":true},{"name":"src","path":"src","contentType":"directory"},{"name":"t","path":"t","contentType":"directory"},{"name":"tapset","path":"tapset","contentType":"directory"},{"name":"util","path":"util","contentType":"directory"},{"name":".gitattributes","path":".gitattributes","contentType":"file"},{"name":".gitignore","path":".gitignore","contentType":"file"},{"name":".mergify.yml","path":".mergify.yml","contentType":"file"},{"name":".travis.yml","path":".travis.yml","contentType":"file"},{"name":"README.markdown","path":"README.markdown","contentType":"file"},{"name":"config","path":"config","contentType":"file"},{"name":"valgrind.suppress","path":"valgrind.suppress","contentType":"file"}],"templateDirectorySuggestionUrl":null,"readme":null,"totalCount":15,"showBranchInfobar":false},"fileTree":null,"fileTreeProcessingTime":null,"foldersToFetch":[],"treeExpanded":false,"symbolsExpanded":false,"copilotSWEAgentEnabled":false,"isOverview":true,"overview":{"banners":{"shouldRecommendReadme":false,"isPersonalRepo":false,"showUseActionBanner":false,"actionSlug":null,"actionId":null,"showProtectBranchBanner":false,"publishBannersInfo":{"dismissActionNoticePath":"/settings/dismiss-notice/publish_action_from_repo","releasePath":"/openresty/lua-nginx-module/releases/new?marketplace=true","showPublishActionBanner":false},"interactionLimitBanner":null,"showInvitationBanner":false,"inviterName":null,"actionsMigrationBannerInfo":{"releaseTags":[],"showImmutableActionsMigrationBanner":false,"initialMigrationStatus":null},"showDeployBanner":false,"detectedStack":{"framework":null,"packageManager":null}},"codeButton":{"contactPath":"/contact","isEnterprise":false,"local":{"protocolInfo":{"httpAvailable":true,"sshAvailable":null,"httpUrl":"https://github.com/openresty/lua-nginx-module.git","showCloneWarning":null,"sshUrl":null,"sshCertificatesRequired":null,"sshCertificatesAvailable":null,"ghCliUrl":"gh repo clone openresty/lua-nginx-module","defaultProtocol":"http","newSshKeyUrl":"/settings/ssh/new","setProtocolPath":"/users/set_protocol"},"platformInfo":{"cloneUrl":"https://desktop.github.com","showVisualStudioCloneButton":false,"visualStudioCloneUrl":"https://windows.github.com","showXcodeCloneButton":false,"xcodeCloneUrl":"xcode://clone?repo=https%3A%2F%2Fgithub.com%2Fopenresty%2Flua-nginx-module","zipballUrl":"/openresty/lua-nginx-module/archive/refs/heads/master.zip"}},"newCodespacePath":"/codespaces/new?hide_repo_select=true\u0026repo=613829"},"popovers":{"rename":null,"renamedParentRepo":null},"commitCount":"3,968","overviewFiles":[{"displayName":"README.markdown","repoName":"lua-nginx-module","refName":"master","path":"README.markdown","preferredFileType":"readme","tabName":"README","richText":"\u003carticle class=\"markdown-body entry-content container-lg\" itemprop=\"text\"\u003e\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eName\u003c/h1\u003e\u003ca id=\"user-content-name\" class=\"anchor\" aria-label=\"Permalink: Name\" href=\"#name\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003engx_http_lua_module - Embed the power of Lua into Nginx HTTP Servers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis module is a core component of \u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e. If you are using this module,\nthen you are essentially using OpenResty :)\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cem\u003eThis module is not distributed with the Nginx source.\u003c/em\u003e See\n\u003ca href=\"#installation\"\u003ethe installation instructions\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eTable of Contents\u003c/h1\u003e\u003ca id=\"user-content-table-of-contents\" class=\"anchor\" aria-label=\"Permalink: Table of Contents\" href=\"#table-of-contents\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#name\"\u003eName\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#status\"\u003eStatus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#version\"\u003eVersion\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#videos\"\u003eVideos\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#synopsis\"\u003eSynopsis\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#description\"\u003eDescription\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#typical-uses\"\u003eTypical Uses\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#nginx-compatibility\"\u003eNginx Compatibility\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#installation\"\u003eInstallation\u003c/a\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#building-as-a-dynamic-module\"\u003eBuilding as a dynamic module\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#c-macro-configurations\"\u003eC Macro Configurations\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#community\"\u003eCommunity\u003c/a\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#english-mailing-list\"\u003eEnglish Mailing List\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#chinese-mailing-list\"\u003eChinese Mailing List\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#code-repository\"\u003eCode Repository\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#bugs-and-patches\"\u003eBugs and Patches\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode support\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#system-environment-variable-support\"\u003eSystem Environment Variable Support\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#http-10-support\"\u003eHTTP 1.0 support\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#statically-linking-pure-lua-modules\"\u003eStatically Linking Pure Lua Modules\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#data-sharing-within-an-nginx-worker\"\u003eData Sharing within an Nginx Worker\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#known-issues\"\u003eKnown Issues\u003c/a\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#tcp-socket-connect-operation-issues\"\u003eTCP socket connect operation issues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua-coroutine-yieldingresuming\"\u003eLua Coroutine Yielding/Resuming\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua-variable-scope\"\u003eLua Variable Scope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#locations-configured-by-subrequest-directives-of-other-modules\"\u003eLocations Configured by Subrequest Directives of Other Modules\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#cosockets-not-available-everywhere\"\u003eCosockets Not Available Everywhere\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#special-escaping-sequences\"\u003eSpecial Escaping Sequences\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#mixing-with-ssi-not-supported\"\u003eMixing with SSI Not Supported\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#spdy-mode-not-fully-supported\"\u003eSPDY Mode Not Fully Supported\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#missing-data-on-short-circuited-requests\"\u003eMissing data on short circuited requests\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#todo\"\u003eTODO\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#changes\"\u003eChanges\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#build-and-test\"\u003eBuild And Test\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#test-suite\"\u003eTest Suite\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#copyright-and-license\"\u003eCopyright and License\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#see-also\"\u003eSee Also\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#directives\"\u003eDirectives\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#obsolete-sections\"\u003eObsolete Sections\u003c/a\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#special-pcre-sequences\"\u003eSpecial PCRE Sequences\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lualuajit-bytecode-support\"\u003eLua/LuaJIT bytecode support\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eStatus\u003c/h1\u003e\u003ca id=\"user-content-status\" class=\"anchor\" aria-label=\"Permalink: Status\" href=\"#status\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eProduction ready.\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eVersion\u003c/h1\u003e\u003ca id=\"user-content-version\" class=\"anchor\" aria-label=\"Permalink: Version\" href=\"#version\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis document describes ngx_lua\n\u003ca href=\"https://github.com/openresty/lua-nginx-module/tags\"\u003ev0.10.28\u003c/a\u003e, which was released\non 17 Jan, 2025.\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eVideos\u003c/h1\u003e\u003ca id=\"user-content-videos\" class=\"anchor\" aria-label=\"Permalink: Videos\" href=\"#videos\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eYouTube video \"\u003ca href=\"https://youtu.be/eSfYLvVQMxw\" rel=\"nofollow\"\u003eHello World HTTP Example with OpenResty/Lua\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/eSfYLvVQMxw\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/7ff656067b4a093e39aac78ffda66d7ce447608f765fa014dcaea0ee6f9cf825/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f655366594c7656514d78772f302e6a7067\" alt=\"Hello World HTTP Example with OpenResty/Lua\" data-canonical-src=\"https://img.youtube.com/vi/eSfYLvVQMxw/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eYouTube video \"\u003ca href=\"https://youtu.be/vfYxOMl5LVY\" rel=\"nofollow\"\u003eWrite Your Own Lua Modules in OpenResty/Nginx Applications\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/vfYxOMl5LVY\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/8819b06eee38f799e2bd232534b694d9d83b1353206c01cab88d91060943108e/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f766659784f4d6c354c56592f302e6a7067\" alt=\"Write Your Own Lua Modules in OpenResty/Nginx Applications\" data-canonical-src=\"https://img.youtube.com/vi/vfYxOMl5LVY/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eYouTube video \"\u003ca href=\"https://youtu.be/L1c7aw4mSOo\" rel=\"nofollow\"\u003eOpenResty's resty Command-Line Utility Demo\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/L1c7aw4mSOo\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/68d68cd6ebcb69256f229c0abe5245237b607506a0eed924d7921e689c2e7cc5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4c3163376177346d534f6f2f302e6a7067\" alt=\"OpenResty's resty Command-Line Utility Demo\" data-canonical-src=\"https://img.youtube.com/vi/L1c7aw4mSOo/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eYouTube video \"\u003ca href=\"https://youtu.be/VkRYW_qLoME\" rel=\"nofollow\"\u003eMeasure Execution Time of Lua Code Correctly in OpenResty\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/VkRYW_qLoME\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/8355e8ae9fbef6dd76872c1abc759ecf4defae030ede89709e1ea222e6ca8ad7/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f566b5259575f714c6f4d452f302e6a7067\" alt=\"Measure Execution Time of Lua Code Correctly in OpenResty\" data-canonical-src=\"https://img.youtube.com/vi/VkRYW_qLoME/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eYouTube video \"\u003ca href=\"https://youtu.be/EP7c0BM2yNo\" rel=\"nofollow\"\u003ePrecompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/EP7c0BM2yNo\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/182f5fca45b84c4c9674b1811d4846e18104c33906d9eb556e4cb37fff67d3f5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4550376330424d32794e6f2f302e6a7067\" alt=\"Precompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup\" data-canonical-src=\"https://img.youtube.com/vi/EP7c0BM2yNo/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eYou are welcome to subscribe to our \u003ca href=\"https://www.youtube.com/channel/UCXVmwF-UCScv2ftsGoMqxhw\" rel=\"nofollow\"\u003eofficial YouTube channel, OpenResty\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSynopsis\u003c/h1\u003e\u003ca id=\"user-content-synopsis\" class=\"anchor\" aria-label=\"Permalink: Synopsis\" href=\"#synopsis\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # set search paths for pure Lua external libraries (';;' is the default path):\n lua_package_path '/foo/bar/?.lua;/blah/?.lua;;';\n\n # set search paths for Lua external libraries written in C (can also use ';;'):\n lua_package_cpath '/bar/baz/?.so;/blah/blah/?.so;;';\n\n server {\n     location /lua_content {\n         # MIME type determined by default_type:\n         default_type 'text/plain';\n\n         content_by_lua_block {\n             ngx.say('Hello,world!')\n         }\n     }\n\n     location /nginx_var {\n         # MIME type determined by default_type:\n         default_type 'text/plain';\n\n         # try access /nginx_var?a=hello,world\n         content_by_lua_block {\n             ngx.say(ngx.var.arg_a)\n         }\n     }\n\n     location = /request_body {\n         client_max_body_size 50k;\n         client_body_buffer_size 50k;\n\n         content_by_lua_block {\n             ngx.req.read_body()  -- explicitly read the req body\n             local data = ngx.req.get_body_data()\n             if data then\n                 ngx.say(\u0026quot;body data:\u0026quot;)\n                 ngx.print(data)\n                 return\n             end\n\n             -- body may get buffered in a temp file:\n             local file = ngx.req.get_body_file()\n             if file then\n                 ngx.say(\u0026quot;body is in file \u0026quot;, file)\n             else\n                 ngx.say(\u0026quot;no body found\u0026quot;)\n             end\n         }\n     }\n\n     # transparent non-blocking I/O in Lua via subrequests\n     # (well, a better way is to use cosockets)\n     location = /lua {\n         # MIME type determined by default_type:\n         default_type 'text/plain';\n\n         content_by_lua_block {\n             local res = ngx.location.capture(\u0026quot;/some_other_location\u0026quot;)\n             if res then\n                 ngx.say(\u0026quot;status: \u0026quot;, res.status)\n                 ngx.say(\u0026quot;body:\u0026quot;)\n                 ngx.print(res.body)\n             end\n         }\n     }\n\n     location = /foo {\n         rewrite_by_lua_block {\n             res = ngx.location.capture(\u0026quot;/memc\u0026quot;,\n                 { args = { cmd = \u0026quot;incr\u0026quot;, key = ngx.var.uri } }\n             )\n         }\n\n         proxy_pass http://blah.blah.com;\n     }\n\n     location = /mixed {\n         rewrite_by_lua_file /path/to/rewrite.lua;\n         access_by_lua_file /path/to/access.lua;\n         content_by_lua_file /path/to/content.lua;\n     }\n\n     # use nginx var in code path\n     # CAUTION: contents in nginx var must be carefully filtered,\n     # otherwise there'll be great security risk!\n     location ~ ^/app/([-_a-zA-Z0-9/]+) {\n         set $path $1;\n         content_by_lua_file /path/to/lua/app/root/$path.lua;\n     }\n\n     location / {\n        client_max_body_size 100k;\n        client_body_buffer_size 100k;\n\n        access_by_lua_block {\n            -- check the client IP address is in our black list\n            if ngx.var.remote_addr == \u0026quot;132.5.72.3\u0026quot; then\n                ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n\n            -- check if the URI contains bad words\n            if ngx.var.uri and\n                   string.match(ngx.var.request_body, \u0026quot;evil\u0026quot;)\n            then\n                return ngx.redirect(\u0026quot;/terms_of_use.html\u0026quot;)\n            end\n\n            -- tests passed\n        }\n\n        # proxy_pass/fastcgi_pass/etc settings\n     }\n }\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # set search paths for pure Lua external libraries (';;' is the default path):\u003c/span\u003e\n lua_package_path \u003cspan class=\"pl-s\"\u003e'/foo/bar/?.lua;/blah/?.lua;;'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e # set search paths for Lua external libraries written in C (can also use ';;'):\u003c/span\u003e\n lua_package_cpath \u003cspan class=\"pl-s\"\u003e'/bar/baz/?.so;/blah/blah/?.so;;'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua_content \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e         # MIME type determined by default_type:\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'text/plain'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e'Hello,world!'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /nginx_var \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e         # MIME type determined by default_type:\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'text/plain'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e         # try access /nginx_var?a=hello,world\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.arg_a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /request_body \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eclient_max_body_size\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e50k\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eclient_body_buffer_size\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e50k\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             ngx.req.read_body\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e  -- explicitly read the req body\n             local data = ngx.req.get_body_data\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e data then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"body data:\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003edata\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n             end\n\n             -- body may get buffered in a temp file:\n             local file = ngx.req.get_body_file\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e file then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"body is in file \"\u003c/span\u003e, file\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             else\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"no body found\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e     # transparent non-blocking I/O in Lua via subrequests\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e     # (well, a better way is to use cosockets)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e         # MIME type determined by default_type:\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'text/plain'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/some_other_location\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e res then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"status: \"\u003c/span\u003e, res.\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"body:\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/memc\"\u003c/span\u003e,\n                 \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e args = \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e cmd = \u003cspan class=\"pl-s\"\u003e\"incr\"\u003c/span\u003e, key = ngx.var.uri \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n             \u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n         \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://blah.blah.com\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /mixed \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         rewrite_by_lua_file /path/to/\u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e.lua\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         access_by_lua_file /path/to/access.lua\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         content_by_lua_file /path/to/content.lua\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e     # use nginx var in code path\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e     # CAUTION: contents in nginx var must be carefully filtered,\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e     # otherwise there'll be great security risk!\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e \u003cspan class=\"pl-sr\"\u003e~\u003c/span\u003e ^/app/\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e[-_a-zA-Z0-9/]+\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$path\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$1\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         content_by_lua_file /path/to/lua/app/\u003cspan class=\"pl-c1\"\u003eroot\u003c/span\u003e/\u003cspan class=\"pl-v\"\u003e$path\u003c/span\u003e.lua\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"pl-c1\"\u003eclient_max_body_size\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e100k\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"pl-c1\"\u003eclient_body_buffer_size\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e100k\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n        access_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n            -- check the client IP address is in our black list\n            \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e ngx.var.remote_addr == \u003cspan class=\"pl-s\"\u003e\"132.5.72.3\"\u003c/span\u003e then\n                ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.HTTP_FORBIDDEN\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n            end\n\n            -- check \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e the URI contains bad words\n            \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e ngx.var.uri and\n                   string.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.request_body, \u003cspan class=\"pl-s\"\u003e\"evil\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n            then\n                \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e ngx.redirect\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/terms_of_use.html\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n            end\n\n            -- tests passed\n        \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e        # proxy_pass/fastcgi_pass/etc settings\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eDescription\u003c/h1\u003e\u003ca id=\"user-content-description\" class=\"anchor\" aria-label=\"Permalink: Description\" href=\"#description\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis module embeds \u003ca href=\"https://luajit.org/luajit.html\" rel=\"nofollow\"\u003eLuaJIT 2.0/2.1\u003c/a\u003e into Nginx.\nIt is a core component of \u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e. If you are using\nthis module, then you are essentially using OpenResty.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince version \u003ccode\u003ev0.10.16\u003c/code\u003e of this module, the standard Lua\ninterpreter (also known as \"PUC-Rio Lua\") is not supported anymore. This\ndocument interchangeably uses the terms \"Lua\" and \"LuaJIT\" to refer to the\nLuaJIT interpreter.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBy leveraging Nginx's subrequests, this module allows the integration of the\npowerful Lua threads (known as Lua \"coroutines\") into the Nginx event model.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnlike \u003ca href=\"https://httpd.apache.org/docs/trunk/mod/mod_lua.html\" rel=\"nofollow\"\u003eApache's mod_lua\u003c/a\u003e\nand \u003ca href=\"http://redmine.lighttpd.net/wiki/1/Docs:ModMagnet\" rel=\"nofollow\"\u003eLighttpd's mod_magnet\u003c/a\u003e,\nLua code executed using this module can be \u003cem\u003e100% non-blocking\u003c/em\u003e on network\ntraffic as long as the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e provided by\nthis module is used to handle requests to upstream services such as MySQL,\nPostgreSQL, Memcached, Redis, or upstream HTTP web services.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAt least the following Lua libraries and Nginx modules can be used with this\nmodule:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-memcached\"\u003elua-resty-memcached\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-mysql\"\u003elua-resty-mysql\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-redis\"\u003elua-resty-redis\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-dns\"\u003elua-resty-dns\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-upload\"\u003elua-resty-upload\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-websocket\"\u003elua-resty-websocket\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-lock\"\u003elua-resty-lock\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/cloudflare/lua-resty-logger-socket\"\u003elua-resty-logger-socket\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-lrucache\"\u003elua-resty-lrucache\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-string\"\u003elua-resty-string\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/memc-nginx-module\"\u003engx_memc\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/FRiCKLE/ngx_postgres\"\u003engx_postgres\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/redis2-nginx-module\"\u003engx_redis2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://wiki.nginx.org/HttpRedisModule\" rel=\"nofollow\"\u003engx_redis\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_proxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html\" rel=\"nofollow\"\u003engx_fastcgi\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eAlmost any Nginx modules can be used with this ngx_lua module by means of\n\u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e or\n\u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e but it is\nrecommended to use those \u003ccode\u003elua-resty-*\u003c/code\u003e libraries instead of creating\nsubrequests to access the Nginx upstream modules because the former is usually\nmuch more flexible and memory-efficient.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua interpreter (also known as \"Lua State\" or \"LuaJIT VM instance\") is\nshared across all the requests in a single Nginx worker process to minimize\nmemory use. Request contexts are segregated using lightweight Lua coroutines.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLoaded Lua modules persist in the Nginx worker process level resulting in a\nsmall memory footprint in Lua even when under heavy loads.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis module is plugged into Nginx's \"http\" subsystem so it can only speak\ndownstream communication protocols in the HTTP family (HTTP 0.9/1.0/1.1/2.0,\nWebSockets, etc...).  If you want to do generic TCP communications with the\ndownstream clients, then you should use the\n\u003ca href=\"https://github.com/openresty/stream-lua-nginx-module#readme\"\u003engx_stream_lua\u003c/a\u003e\nmodule instead, which offers a compatible Lua API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eTypical Uses\u003c/h1\u003e\u003ca id=\"user-content-typical-uses\" class=\"anchor\" aria-label=\"Permalink: Typical Uses\" href=\"#typical-uses\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eJust to name a few:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eMashup'ing and processing outputs of various Nginx upstream outputs (proxy, drizzle, postgres, redis, memcached, etc.) in Lua,\u003c/li\u003e\n\u003cli\u003edoing arbitrarily complex access control and security checks in Lua before requests actually reach the upstream backends,\u003c/li\u003e\n\u003cli\u003emanipulating response headers in an arbitrary way (by Lua)\u003c/li\u003e\n\u003cli\u003efetching backend information from external storage backends (like redis, memcached, mysql, postgresql) and use that information to choose which upstream backend to access on-the-fly,\u003c/li\u003e\n\u003cli\u003ecoding up arbitrarily complex web applications in a content handler using synchronous but still non-blocking access to the database backends and other storage,\u003c/li\u003e\n\u003cli\u003edoing very complex URL dispatch in Lua at rewrite phase,\u003c/li\u003e\n\u003cli\u003eusing Lua to implement advanced caching mechanism for Nginx's subrequests and arbitrary locations.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe possibilities are unlimited as the module allows bringing together various\nelements within Nginx as well as exposing the power of the Lua language to the\nuser. The module provides the full flexibility of scripting while offering\nperformance levels comparable with native C language programs both in terms of\nCPU time as well as memory footprint thanks to LuaJIT 2.x.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOther scripting language implementations typically struggle to match this\nperformance level.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eNginx Compatibility\u003c/h1\u003e\u003ca id=\"user-content-nginx-compatibility\" class=\"anchor\" aria-label=\"Permalink: Nginx Compatibility\" href=\"#nginx-compatibility\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe latest version of this module is compatible with the following versions of Nginx:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e1.29.x  (last tested: 1.29.2)\u003c/li\u003e\n\u003cli\u003e1.27.x  (last tested: 1.27.1)\u003c/li\u003e\n\u003cli\u003e1.25.x  (last tested: 1.25.1)\u003c/li\u003e\n\u003cli\u003e1.21.x  (last tested: 1.21.4)\u003c/li\u003e\n\u003cli\u003e1.19.x  (last tested: 1.19.3)\u003c/li\u003e\n\u003cli\u003e1.17.x  (last tested: 1.17.8)\u003c/li\u003e\n\u003cli\u003e1.15.x  (last tested: 1.15.8)\u003c/li\u003e\n\u003cli\u003e1.14.x\u003c/li\u003e\n\u003cli\u003e1.13.x  (last tested: 1.13.6)\u003c/li\u003e\n\u003cli\u003e1.12.x\u003c/li\u003e\n\u003cli\u003e1.11.x  (last tested: 1.11.2)\u003c/li\u003e\n\u003cli\u003e1.10.x\u003c/li\u003e\n\u003cli\u003e1.9.x (last tested: 1.9.15)\u003c/li\u003e\n\u003cli\u003e1.8.x\u003c/li\u003e\n\u003cli\u003e1.7.x (last tested: 1.7.10)\u003c/li\u003e\n\u003cli\u003e1.6.x\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eNginx cores older than 1.6.0 (exclusive) are \u003cem\u003enot\u003c/em\u003e supported.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eInstallation\u003c/h1\u003e\u003ca id=\"user-content-installation\" class=\"anchor\" aria-label=\"Permalink: Installation\" href=\"#installation\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is \u003cem\u003ehighly\u003c/em\u003e recommended to use \u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty releases\u003c/a\u003e\nwhich bundle Nginx, ngx_lua (this module), LuaJIT, as well as other powerful\ncompanion Nginx modules and Lua libraries.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is discouraged to build this module with Nginx yourself since it is tricky\nto set up exactly right.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that Nginx, LuaJIT, and OpenSSL official releases have various limitations\nand long-standing bugs that can cause some of this module's features to be\ndisabled, not work properly, or run slower. Official OpenResty releases are\nrecommended because they bundle \u003ca href=\"https://github.com/openresty/luajit2\"\u003eOpenResty's optimized LuaJIT 2.1 fork\u003c/a\u003e and\n\u003ca href=\"https://github.com/openresty/openresty/tree/master/patches\"\u003eNginx/OpenSSL\npatches\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlternatively, ngx_lua can be manually compiled into Nginx:\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003eLuaJIT can be downloaded from the \u003ca href=\"https://github.com/openresty/luajit2/releases\"\u003elatest release of OpenResty's LuaJIT fork\u003c/a\u003e. The official LuaJIT 2.x releases are also supported, although performance will be significantly lower for reasons elaborated above\u003c/li\u003e\n\u003cli\u003eDownload the latest version of the ngx_devel_kit (NDK) module \u003ca href=\"https://github.com/simplresty/ngx_devel_kit/tags\"\u003eHERE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eDownload the latest version of ngx_lua \u003ca href=\"https://github.com/openresty/lua-nginx-module/tags\"\u003eHERE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eDownload the latest supported version of Nginx \u003ca href=\"https://nginx.org/\" rel=\"nofollow\"\u003eHERE\u003c/a\u003e (See \u003ca href=\"#nginx-compatibility\"\u003eNginx Compatibility\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eDownload the latest version of the lua-resty-core \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003eHERE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eDownload the latest version of the lua-resty-lrucache \u003ca href=\"https://github.com/openresty/lua-resty-lrucache\"\u003eHERE\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eBuild the source with this module:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n wget 'https://openresty.org/download/nginx-1.19.3.tar.gz'\n tar -xzvf nginx-1.19.3.tar.gz\n cd nginx-1.19.3/\n\n # tell nginx's build system where to find LuaJIT 2.0:\n export LUAJIT_LIB=/path/to/luajit/lib\n export LUAJIT_INC=/path/to/luajit/include/luajit-2.0\n\n # tell nginx's build system where to find LuaJIT 2.1:\n export LUAJIT_LIB=/path/to/luajit/lib\n export LUAJIT_INC=/path/to/luajit/include/luajit-2.1\n\n # Here we assume Nginx is to be installed under /opt/nginx/.\n ./configure --prefix=/opt/nginx \\\n         --with-ld-opt=\u0026quot;-Wl,-rpath,/path/to/luajit/lib\u0026quot; \\\n         --add-module=/path/to/ngx_devel_kit \\\n         --add-module=/path/to/lua-nginx-module\n\n # Note that you may also want to add `./configure` options which are used in your\n # current nginx build.\n # You can get usually those options using command nginx -V\n\n # you can change the parallelism number 2 below to fit the number of spare CPU cores in your\n # machine.\n make -j2\n make install\n\n # Note that this version of lug-nginx-module not allow to set `lua_load_resty_core off;` any more.\n # So, you have to install `lua-resty-core` and `lua-resty-lrucache` manually as below.\n\n cd lua-resty-core\n make install PREFIX=/opt/nginx\n cd lua-resty-lrucache\n make install PREFIX=/opt/nginx\n\n # add necessary `lua_package_path` directive to `nginx.conf`, in the http context\n\n lua_package_path \u0026quot;/opt/nginx/lib/lua/?.lua;;\u0026quot;;\"\u003e\u003cpre\u003e wget \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ehttps://openresty.org/download/nginx-1.19.3.tar.gz\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e\n tar -xzvf nginx-1.19.3.tar.gz\n \u003cspan class=\"pl-c1\"\u003ecd\u003c/span\u003e nginx-1.19.3/\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e tell nginx's build system where to find LuaJIT 2.0:\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eexport\u003c/span\u003e LUAJIT_LIB=/path/to/luajit/lib\n \u003cspan class=\"pl-k\"\u003eexport\u003c/span\u003e LUAJIT_INC=/path/to/luajit/include/luajit-2.0\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e tell nginx's build system where to find LuaJIT 2.1:\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eexport\u003c/span\u003e LUAJIT_LIB=/path/to/luajit/lib\n \u003cspan class=\"pl-k\"\u003eexport\u003c/span\u003e LUAJIT_INC=/path/to/luajit/include/luajit-2.1\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e Here we assume Nginx is to be installed under /opt/nginx/.\u003c/span\u003e\n ./configure --prefix=/opt/nginx \\\n         --with-ld-opt=\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e-Wl,-rpath,/path/to/luajit/lib\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e \\\n         --add-module=/path/to/ngx_devel_kit \\\n         --add-module=/path/to/lua-nginx-module\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e Note that you may also want to add `./configure` options which are used in your\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e current nginx build.\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e You can get usually those options using command nginx -V\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e you can change the parallelism number 2 below to fit the number of spare CPU cores in your\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e machine.\u003c/span\u003e\n make -j2\n make install\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e Note that this version of lug-nginx-module not allow to set `lua_load_resty_core off;` any more.\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e So, you have to install `lua-resty-core` and `lua-resty-lrucache` manually as below.\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003ecd\u003c/span\u003e lua-resty-core\n make install PREFIX=/opt/nginx\n \u003cspan class=\"pl-c1\"\u003ecd\u003c/span\u003e lua-resty-lrucache\n make install PREFIX=/opt/nginx\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e add necessary `lua_package_path` directive to `nginx.conf`, in the http context\u003c/span\u003e\n\n lua_package_path \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/opt/nginx/lib/lua/?.lua;;\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eBuilding as a dynamic module\u003c/h2\u003e\u003ca id=\"user-content-building-as-a-dynamic-module\" class=\"anchor\" aria-label=\"Permalink: Building as a dynamic module\" href=\"#building-as-a-dynamic-module\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eStarting from NGINX 1.9.11, you can also compile this module as a dynamic module, by using the \u003ccode\u003e--add-dynamic-module=PATH\u003c/code\u003e option instead of \u003ccode\u003e--add-module=PATH\u003c/code\u003e on the\n\u003ccode\u003e./configure\u003c/code\u003e command line above. And then you can explicitly load the module in your \u003ccode\u003enginx.conf\u003c/code\u003e via the \u003ca href=\"https://nginx.org/en/docs/ngx_core_module.html#load_module\" rel=\"nofollow\"\u003eload_module\u003c/a\u003e\ndirective, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n load_module /path/to/modules/ndk_http_module.so;  # assuming NDK is built as a dynamic module too\n load_module /path/to/modules/ngx_http_lua_module.so;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eload_module\u003c/span\u003e /path/to/modules/ndk_http_module.so\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # assuming NDK is built as a dynamic module too\n \u003cspan class=\"pl-c1\"\u003eload_module\u003c/span\u003e /path/to/modules/ngx_http_lua_module.so\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eC Macro Configurations\u003c/h2\u003e\u003ca id=\"user-content-c-macro-configurations\" class=\"anchor\" aria-label=\"Permalink: C Macro Configurations\" href=\"#c-macro-configurations\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhile building this module either via OpenResty or with the Nginx core, you can define the following C macros via the C compiler options:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003eNGX_LUA_USE_ASSERT\u003c/code\u003e\nWhen defined, will enable assertions in the ngx_lua C code base. Recommended for debugging or testing builds. It can introduce some (small) runtime overhead when enabled. This macro was first introduced in the \u003ccode\u003ev0.9.10\u003c/code\u003e release.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eNGX_LUA_ABORT_AT_PANIC\u003c/code\u003e\nWhen the LuaJIT VM panics, ngx_lua will instruct the current nginx worker process to quit gracefully by default. By specifying this C macro, ngx_lua will abort the current nginx worker process (which usually results in a core dump file) immediately. This option is useful for debugging VM panics. This option was first introduced in the \u003ccode\u003ev0.9.8\u003c/code\u003e release.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eTo enable one or more of these macros, just pass extra C compiler options to the \u003ccode\u003e./configure\u003c/code\u003e script of either Nginx or OpenResty. For instance,\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"./configure --with-cc-opt=\u0026quot;-DNGX_LUA_USE_ASSERT -DNGX_LUA_ABORT_AT_PANIC\u0026quot;\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e./configure --with-cc-opt=\"-DNGX_LUA_USE_ASSERT -DNGX_LUA_ABORT_AT_PANIC\"\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eCommunity\u003c/h1\u003e\u003ca id=\"user-content-community\" class=\"anchor\" aria-label=\"Permalink: Community\" href=\"#community\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eEnglish Mailing List\u003c/h2\u003e\u003ca id=\"user-content-english-mailing-list\" class=\"anchor\" aria-label=\"Permalink: English Mailing List\" href=\"#english-mailing-list\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"https://groups.google.com/group/openresty-en\" rel=\"nofollow\"\u003eopenresty-en\u003c/a\u003e mailing list is for English speakers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eChinese Mailing List\u003c/h2\u003e\u003ca id=\"user-content-chinese-mailing-list\" class=\"anchor\" aria-label=\"Permalink: Chinese Mailing List\" href=\"#chinese-mailing-list\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"https://groups.google.com/group/openresty\" rel=\"nofollow\"\u003eopenresty\u003c/a\u003e mailing list is for Chinese speakers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eCode Repository\u003c/h1\u003e\u003ca id=\"user-content-code-repository\" class=\"anchor\" aria-label=\"Permalink: Code Repository\" href=\"#code-repository\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe code repository of this project is hosted on GitHub at\n\u003ca href=\"https://github.com/openresty/lua-nginx-module\"\u003eopenresty/lua-nginx-module\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eBugs and Patches\u003c/h1\u003e\u003ca id=\"user-content-bugs-and-patches\" class=\"anchor\" aria-label=\"Permalink: Bugs and Patches\" href=\"#bugs-and-patches\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ePlease submit bug reports, wishlists, or patches by\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ecreating a ticket on the \u003ca href=\"https://github.com/openresty/lua-nginx-module/issues\"\u003eGitHub Issue Tracker\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003eor posting to the \u003ca href=\"#community\"\u003eOpenResty community\u003c/a\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eLuaJIT bytecode support\u003c/h1\u003e\u003ca id=\"user-content-luajit-bytecode-support\" class=\"anchor\" aria-label=\"Permalink: LuaJIT bytecode support\" href=\"#luajit-bytecode-support\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWatch YouTube video \"\u003ca href=\"https://youtu.be/VkRYW_qLoME\" rel=\"nofollow\"\u003eMeasure Execution Time of Lua Code Correctly in OpenResty\u003c/a\u003e\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://youtu.be/EP7c0BM2yNo\" rel=\"nofollow\"\u003e\u003cimg src=\"https://camo.githubusercontent.com/182f5fca45b84c4c9674b1811d4846e18104c33906d9eb556e4cb37fff67d3f5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4550376330424d32794e6f2f302e6a7067\" alt=\"Precompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup\" data-canonical-src=\"https://img.youtube.com/vi/EP7c0BM2yNo/0.jpg\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAs from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, all \u003ccode\u003e*_by_lua_file\u003c/code\u003e configure directives (such as \u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e) support loading LuaJIT 2.0/2.1 raw bytecode files directly:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n /path/to/luajit/bin/luajit -b /path/to/input_file.lua /path/to/output_file.ljbc\"\u003e\u003cpre\u003e /path/to/luajit/bin/luajit -b /path/to/input_file.lua /path/to/output_file.ljbc\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e-bg\u003c/code\u003e option can be used to include debug information in the LuaJIT bytecode file:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n /path/to/luajit/bin/luajit -bg /path/to/input_file.lua /path/to/output_file.ljbc\"\u003e\u003cpre\u003e /path/to/luajit/bin/luajit -bg /path/to/input_file.lua /path/to/output_file.ljbc\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ePlease refer to the official LuaJIT documentation on the \u003ccode\u003e-b\u003c/code\u003e option for more details:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://luajit.org/running.html#opt_b\" rel=\"nofollow\"\u003ehttps://luajit.org/running.html#opt_b\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the bytecode files generated by LuaJIT 2.1 is \u003cem\u003enot\u003c/em\u003e compatible with\nLuaJIT 2.0, and vice versa. The support for LuaJIT 2.1 bytecode was first added\nin ngx_lua v0.9.3.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAttempts to load standard Lua 5.1 bytecode files into ngx_lua instances linked\nto LuaJIT 2.0/2.1 (or vice versa) will result in an Nginx error message such as\nthe one below:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[error] 13909#0: *1 failed to load Lua inlined code: bad byte-code header in /path/to/test_file.luac\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e[error] 13909#0: *1 failed to load Lua inlined code: bad byte-code header in /path/to/test_file.luac\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eLoading bytecode files via the Lua primitives like \u003ccode\u003erequire\u003c/code\u003e and\n\u003ccode\u003edofile\u003c/code\u003e should always work as expected.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSystem Environment Variable Support\u003c/h1\u003e\u003ca id=\"user-content-system-environment-variable-support\" class=\"anchor\" aria-label=\"Permalink: System Environment Variable Support\" href=\"#system-environment-variable-support\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf you want to access the system environment variable, say, \u003ccode\u003efoo\u003c/code\u003e, in Lua via the standard Lua API \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-os.getenv\" rel=\"nofollow\"\u003eos.getenv\u003c/a\u003e, then you should also list this environment variable name in your \u003ccode\u003enginx.conf\u003c/code\u003e file via the \u003ca href=\"https://nginx.org/en/docs/ngx_core_module.html#env\" rel=\"nofollow\"\u003eenv directive\u003c/a\u003e. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n env foo;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eenv\u003c/span\u003e foo\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eHTTP 1.0 support\u003c/h1\u003e\u003ca id=\"user-content-http-10-support\" class=\"anchor\" aria-label=\"Permalink: HTTP 1.0 support\" href=\"#http-10-support\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe HTTP 1.0 protocol does not support chunked output and requires an explicit \u003ccode\u003eContent-Length\u003c/code\u003e header when the response body is not empty in order to support the HTTP 1.0 keep-alive.\nSo when a HTTP 1.0 request is made and the \u003ca href=\"#lua_http10_buffering\"\u003elua_http10_buffering\u003c/a\u003e directive is turned \u003ccode\u003eon\u003c/code\u003e, ngx_lua will buffer the\noutput of \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e and \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e calls and also postpone sending response headers until all the response body output is received.\nAt that time ngx_lua can calculate the total length of the body and construct a proper \u003ccode\u003eContent-Length\u003c/code\u003e header to return to the HTTP 1.0 client.\nIf the \u003ccode\u003eContent-Length\u003c/code\u003e response header is set in the running Lua code, however, this buffering will be disabled even if the \u003ca href=\"#lua_http10_buffering\"\u003elua_http10_buffering\u003c/a\u003e directive is turned \u003ccode\u003eon\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor large streaming output responses, it is important to disable the \u003ca href=\"#lua_http10_buffering\"\u003elua_http10_buffering\u003c/a\u003e directive to minimise memory usage.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that common HTTP benchmark tools such as \u003ccode\u003eab\u003c/code\u003e and \u003ccode\u003ehttp_load\u003c/code\u003e issue HTTP 1.0 requests by default.\nTo force \u003ccode\u003ecurl\u003c/code\u003e to send HTTP 1.0 requests, use the \u003ccode\u003e-0\u003c/code\u003e option.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eStatically Linking Pure Lua Modules\u003c/h1\u003e\u003ca id=\"user-content-statically-linking-pure-lua-modules\" class=\"anchor\" aria-label=\"Permalink: Statically Linking Pure Lua Modules\" href=\"#statically-linking-pure-lua-modules\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWith LuaJIT 2.x, it is possible to statically link the bytecode of pure Lua\nmodules into the Nginx executable.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can use the \u003ccode\u003eluajit\u003c/code\u003e executable to compile \u003ccode\u003e.lua\u003c/code\u003e Lua\nmodule files to \u003ccode\u003e.o\u003c/code\u003e object files containing the exported bytecode\ndata, and then link the \u003ccode\u003e.o\u003c/code\u003e files directly in your Nginx build.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBelow is a trivial example to demonstrate this. Consider that we have the following \u003ccode\u003e.lua\u003c/code\u003e file named \u003ccode\u003efoo.lua\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- foo.lua\n local _M = {}\n\n function _M.go()\n     print(\u0026quot;Hello from foo\u0026quot;)\n end\n\n return _M\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e foo.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003e_M\u003c/span\u003e.\u003cspan class=\"pl-en\"\u003ego\u003c/span\u003e()\n     \u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eHello from foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAnd then we compile this \u003ccode\u003e.lua\u003c/code\u003e file to \u003ccode\u003efoo.o\u003c/code\u003e file:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n /path/to/luajit/bin/luajit -bg foo.lua foo.o\"\u003e\u003cpre\u003e /path/to/luajit/bin/luajit -bg foo.lua foo.o\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhat matters here is the name of the \u003ccode\u003e.lua\u003c/code\u003e file, which determines how you use this module later on the Lua land. The file name \u003ccode\u003efoo.o\u003c/code\u003e does not matter at all except the \u003ccode\u003e.o\u003c/code\u003e file extension (which tells \u003ccode\u003eluajit\u003c/code\u003e what output format is used). If you want to strip the Lua debug information from the resulting bytecode, you can just specify the \u003ccode\u003e-b\u003c/code\u003e option above instead of \u003ccode\u003e-bg\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThen when building Nginx or OpenResty, pass the \u003ccode\u003e--with-ld-opt=\"foo.o\"\u003c/code\u003e option to the \u003ccode\u003e./configure\u003c/code\u003e script:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ./configure --with-ld-opt=\u0026quot;/path/to/foo.o\u0026quot; ...\"\u003e\u003cpre\u003e ./configure --with-ld-opt=\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/path/to/foo.o\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e ...\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eFinally, you can just do the following in any Lua code run by ngx_lua:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local foo = require \u0026quot;foo\u0026quot;\n foo.go()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efoo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ego\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAnd this piece of code no longer depends on the external \u003ccode\u003efoo.lua\u003c/code\u003e file any more because it has already been compiled into the \u003ccode\u003enginx\u003c/code\u003e executable.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you want to use dot in the Lua module name when calling \u003ccode\u003erequire\u003c/code\u003e, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local foo = require \u0026quot;resty.foo\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ethen you need to rename the \u003ccode\u003efoo.lua\u003c/code\u003e file to \u003ccode\u003eresty_foo.lua\u003c/code\u003e before compiling it down to a \u003ccode\u003e.o\u003c/code\u003e file with the \u003ccode\u003eluajit\u003c/code\u003e command-line utility.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is important to use exactly the same version of LuaJIT when compiling \u003ccode\u003e.lua\u003c/code\u003e files to \u003ccode\u003e.o\u003c/code\u003e files as building nginx + ngx_lua. This is because the LuaJIT bytecode format may be incompatible between different LuaJIT versions. When the bytecode format is incompatible, you will see a Lua runtime error saying that the Lua module is not found.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen you have multiple \u003ccode\u003e.lua\u003c/code\u003e files to compile and link, then just specify their \u003ccode\u003e.o\u003c/code\u003e files at the same time in the value of the \u003ccode\u003e--with-ld-opt\u003c/code\u003e option. For instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ./configure --with-ld-opt=\u0026quot;/path/to/foo.o /path/to/bar.o\u0026quot; ...\"\u003e\u003cpre\u003e ./configure --with-ld-opt=\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/path/to/foo.o /path/to/bar.o\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e ...\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf you have too many \u003ccode\u003e.o\u003c/code\u003e files, then it might not be feasible to name them all in a single command. In this case, you can build a static library (or archive) for your \u003ccode\u003e.o\u003c/code\u003e files, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ar rcus libmyluafiles.a *.o\"\u003e\u003cpre\u003e ar rcus libmyluafiles.a \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e.o\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ethen you can link the \u003ccode\u003emyluafiles\u003c/code\u003e archive as a whole to your nginx executable:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ./configure \\\n     --with-ld-opt=\u0026quot;-L/path/to/lib -Wl,--whole-archive -lmyluafiles -Wl,--no-whole-archive\u0026quot;\"\u003e\u003cpre\u003e ./configure \\\n     --with-ld-opt=\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e-L/path/to/lib -Wl,--whole-archive -lmyluafiles -Wl,--no-whole-archive\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhere \u003ccode\u003e/path/to/lib\u003c/code\u003e is the path of the directory containing the \u003ccode\u003elibmyluafiles.a\u003c/code\u003e file. It should be noted that the linker option \u003ccode\u003e--whole-archive\u003c/code\u003e is required here because otherwise our archive will be skipped because no symbols in our archive are mentioned in the main parts of the nginx executable.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eData Sharing within an Nginx Worker\u003c/h1\u003e\u003ca id=\"user-content-data-sharing-within-an-nginx-worker\" class=\"anchor\" aria-label=\"Permalink: Data Sharing within an Nginx Worker\" href=\"#data-sharing-within-an-nginx-worker\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo globally share data among all the requests handled by the same Nginx worker\nprocess, encapsulate the shared data into a Lua module, use the Lua\n\u003ccode\u003erequire\u003c/code\u003e builtin to import the module, and then manipulate the\nshared data in Lua. This works because required Lua modules are loaded only\nonce and all coroutines will share the same copy of the module (both its code\nand data).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the use of global Lua variables is \u003cem\u003estrongly discouraged\u003c/em\u003e, as it may\nlead to unexpected race conditions between concurrent requests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is a small example on sharing data within an Nginx worker via a Lua module:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- mydata.lua\n local _M = {}\n\n local data = {\n     dog = 3,\n     cat = 4,\n     pig = 5,\n }\n\n function _M.get_age(name)\n     return data[name]\n end\n\n return _M\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e mydata.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\n     \u003cspan class=\"pl-smi\"\u003edog\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e,\n     \u003cspan class=\"pl-smi\"\u003ecat\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e4\u003c/span\u003e,\n     \u003cspan class=\"pl-smi\"\u003epig\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e5\u003c/span\u003e,\n }\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003e_M\u003c/span\u003e.\u003cspan class=\"pl-en\"\u003eget_age\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ename\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e[\u003cspan class=\"pl-smi\"\u003ename\u003c/span\u003e]\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eand then accessing it from \u003ccode\u003enginx.conf\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /lua {\n     content_by_lua_block {\n         local mydata = require \u0026quot;mydata\u0026quot;\n         ngx.say(mydata.get_age(\u0026quot;dog\u0026quot;))\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local mydata = require \u003cspan class=\"pl-s\"\u003e\"mydata\"\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003emydata.get_age\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"dog\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003emydata\u003c/code\u003e module in this example will only be loaded and run on the first request to the location \u003ccode\u003e/lua\u003c/code\u003e,\nand all subsequent requests to the same Nginx worker process will use the reloaded instance of the\nmodule as well as the same copy of the data in it, until a \u003ccode\u003eHUP\u003c/code\u003e signal is sent to the Nginx master process to force a reload.\nThis data sharing technique is essential for high performance Lua applications based on this module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this data sharing is on a \u003cem\u003eper-worker\u003c/em\u003e basis and not on a \u003cem\u003eper-server\u003c/em\u003e basis. That is, when there are multiple Nginx worker processes under an Nginx master, data sharing cannot cross the process boundary between these workers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is usually recommended to share read-only data this way. You can also share changeable data among all the concurrent requests of each Nginx worker process as\nlong as there is \u003cem\u003eno\u003c/em\u003e nonblocking I/O operations (including \u003ca href=\"#ngxsleep\"\u003engx.sleep\u003c/a\u003e)\nin the middle of your calculations. As long as you do not give the\ncontrol back to the Nginx event loop and ngx_lua's light thread\nscheduler (even implicitly), there can never be any race conditions in\nbetween. For this reason, always be very careful when you want to share changeable data on the\nworker level. Buggy optimizations can easily lead to hard-to-debug\nrace conditions under load.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf server-wide data sharing is required, then use one or more of the following approaches:\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003eUse the \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e API provided by this module.\u003c/li\u003e\n\u003cli\u003eUse only a single Nginx worker and a single server (this is however not recommended when there is a multi core CPU or multiple CPUs in a single machine).\u003c/li\u003e\n\u003cli\u003eUse data storage mechanisms such as \u003ccode\u003ememcached\u003c/code\u003e, \u003ccode\u003eredis\u003c/code\u003e, \u003ccode\u003eMySQL\u003c/code\u003e or \u003ccode\u003ePostgreSQL\u003c/code\u003e. \u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eThe OpenResty official releases\u003c/a\u003e come with a set of companion Nginx modules and Lua libraries that provide interfaces with these data storage mechanisms.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eKnown Issues\u003c/h1\u003e\u003ca id=\"user-content-known-issues\" class=\"anchor\" aria-label=\"Permalink: Known Issues\" href=\"#known-issues\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eTCP socket connect operation issues\u003c/h2\u003e\u003ca id=\"user-content-tcp-socket-connect-operation-issues\" class=\"anchor\" aria-label=\"Permalink: TCP socket connect operation issues\" href=\"#tcp-socket-connect-operation-issues\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"#tcpsockconnect\"\u003etcpsock:connect\u003c/a\u003e method may indicate \u003ccode\u003esuccess\u003c/code\u003e despite connection failures such as with \u003ccode\u003eConnection Refused\u003c/code\u003e errors.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHowever, later attempts to manipulate the cosocket object will fail and return the actual error status message generated by the failed connect operation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis issue is due to limitations in the Nginx event model and only appears to affect Mac OS X.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eLua Coroutine Yielding/Resuming\u003c/h2\u003e\u003ca id=\"user-content-lua-coroutine-yieldingresuming\" class=\"anchor\" aria-label=\"Permalink: Lua Coroutine Yielding/Resuming\" href=\"#lua-coroutine-yieldingresuming\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eBecause Lua's \u003ccode\u003edofile\u003c/code\u003e and \u003ccode\u003erequire\u003c/code\u003e builtins are currently implemented as C functions in LuaJIT 2.0/2.1, if the Lua file being loaded by \u003ccode\u003edofile\u003c/code\u003e or \u003ccode\u003erequire\u003c/code\u003e invokes \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture*\u003c/a\u003e, \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e, \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e, or other API functions requiring yielding in the \u003cem\u003etop-level\u003c/em\u003e scope of the Lua file, then the Lua error \"attempt to yield across C-call boundary\" will be raised. To avoid this, put these calls requiring yielding into your own Lua functions in the Lua file instead of the top-level scope of the file.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eLua Variable Scope\u003c/h2\u003e\u003ca id=\"user-content-lua-variable-scope\" class=\"anchor\" aria-label=\"Permalink: Lua Variable Scope\" href=\"#lua-variable-scope\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eCare must be taken when importing modules, and this form should be used:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local xxx = require('xxx')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003exxx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003exxx\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003einstead of the old deprecated form:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require('xxx')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003exxx\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere is the reason: by design, the global environment has exactly the same lifetime as the Nginx request handler associated with it. Each request handler has its own set of Lua global variables and that is the idea of request isolation. The Lua module is actually loaded by the first Nginx request handler and is cached by the \u003ccode\u003erequire()\u003c/code\u003e built-in in the \u003ccode\u003epackage.loaded\u003c/code\u003e table for later reference, and the \u003ccode\u003emodule()\u003c/code\u003e builtin used by some Lua modules has the side effect of setting a global variable to the loaded module table. But this global variable will be cleared at the end of the request handler,  and every subsequent request handler all has its own (clean) global environment. So one will get Lua exception for accessing the \u003ccode\u003enil\u003c/code\u003e value.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe use of Lua global variables is a generally inadvisable in the ngx_lua context as:\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ethe misuse of Lua globals has detrimental side effects on concurrent requests when such variables should instead be local in scope,\u003c/li\u003e\n\u003cli\u003eLua global variables require Lua table look-ups in the global environment which is computationally expensive, and\u003c/li\u003e\n\u003cli\u003esome Lua global variable references may include typing errors which make such difficult to debug.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eIt is therefore \u003cem\u003ehighly\u003c/em\u003e recommended to always declare such within an appropriate local scope instead.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- Avoid\n foo = 123\n -- Recommended\n local foo = 123\n\n -- Avoid\n function foo() return 123 end\n -- Recommended\n local function foo() return 123 end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Avoid\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e123\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Recommended\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e123\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Avoid\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003efoo\u003c/span\u003e() \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e123\u003c/span\u003e \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Recommended\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003efoo\u003c/span\u003e() \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e123\u003c/span\u003e \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo find all instances of Lua global variables in your Lua code, run the \u003ca href=\"https://github.com/openresty/nginx-devel-utils/blob/master/lua-releng\"\u003elua-releng tool\u003c/a\u003e across all \u003ccode\u003e.lua\u003c/code\u003e source files:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ lua-releng\nChecking use of Lua global variables in file lib/foo/bar.lua ...\n        1       [1489]  SETGLOBAL       7 -1    ; contains\n        55      [1506]  GETGLOBAL       7 -3    ; setvar\n        3       [1545]  GETGLOBAL       3 -4    ; varexpand\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e$ lua-releng\nChecking use of Lua global variables in file lib/foo/bar.lua ...\n        1       [1489]  SETGLOBAL       7 -1    ; contains\n        55      [1506]  GETGLOBAL       7 -3    ; setvar\n        3       [1545]  GETGLOBAL       3 -4    ; varexpand\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe output says that the line 1489 of file \u003ccode\u003elib/foo/bar.lua\u003c/code\u003e writes to a global variable named \u003ccode\u003econtains\u003c/code\u003e, the line 1506 reads from the global variable \u003ccode\u003esetvar\u003c/code\u003e, and line 1545 reads the global \u003ccode\u003evarexpand\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis tool will guarantee that local variables in the Lua module functions are all declared with the \u003ccode\u003elocal\u003c/code\u003e keyword, otherwise a runtime exception will be thrown. It prevents undesirable race conditions while accessing such variables. See \u003ca href=\"#data-sharing-within-an-nginx-worker\"\u003eData Sharing within an Nginx Worker\u003c/a\u003e for the reasons behind this.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eLocations Configured by Subrequest Directives of Other Modules\u003c/h2\u003e\u003ca id=\"user-content-locations-configured-by-subrequest-directives-of-other-modules\" class=\"anchor\" aria-label=\"Permalink: Locations Configured by Subrequest Directives of Other Modules\" href=\"#locations-configured-by-subrequest-directives-of-other-modules\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e directives cannot capture locations that include the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_addition_module.html#add_before_body\" rel=\"nofollow\"\u003eadd_before_body\u003c/a\u003e, \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_addition_module.html#add_after_body\" rel=\"nofollow\"\u003eadd_after_body\u003c/a\u003e, \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_auth_request_module.html#auth_request\" rel=\"nofollow\"\u003eauth_request\u003c/a\u003e, \u003ca href=\"http://github.com/openresty/echo-nginx-module#echo_location\"\u003eecho_location\u003c/a\u003e, \u003ca href=\"http://github.com/openresty/echo-nginx-module#echo_location_async\"\u003eecho_location_async\u003c/a\u003e, \u003ca href=\"http://github.com/openresty/echo-nginx-module#echo_subrequest\"\u003eecho_subrequest\u003c/a\u003e, or \u003ca href=\"http://github.com/openresty/echo-nginx-module#echo_subrequest_async\"\u003eecho_subrequest_async\u003c/a\u003e directives.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     content_by_lua_block {\n         res = ngx.location.capture(\u0026quot;/bar\u0026quot;)\n     }\n }\n location /bar {\n     echo_location /blah;\n }\n location /blah {\n     echo \u0026quot;Success!\u0026quot;;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/bar\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /bar \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     echo_location /blah\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /blah \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     echo \u003cspan class=\"pl-s\"\u003e\"Success!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n $ curl -i http://example.com/foo\"\u003e\u003cpre\u003e $ curl -i \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://example.com/foo\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill not work as expected.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eCosockets Not Available Everywhere\u003c/h2\u003e\u003ca id=\"user-content-cosockets-not-available-everywhere\" class=\"anchor\" aria-label=\"Permalink: Cosockets Not Available Everywhere\" href=\"#cosockets-not-available-everywhere\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eDue to internal limitations in the Nginx core, the cosocket API is disabled in the following contexts: \u003ca href=\"#set_by_lua\"\u003eset_by_lua*\u003c/a\u003e, \u003ca href=\"#log_by_lua\"\u003elog_by_lua*\u003c/a\u003e, \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e, and \u003ca href=\"#body_filter_by_lua\"\u003ebody_filter_by_lua\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe cosockets are currently also disabled in the \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e and \u003ca href=\"#init_worker_by_lua\"\u003einit_worker_by_lua*\u003c/a\u003e directive contexts but we may add support for these contexts in the future because there is no limitation in the Nginx core (or the limitation might be worked around).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThere exists a workaround, however, when the original context does \u003cem\u003enot\u003c/em\u003e need to wait for the cosocket results. That is, creating a zero-delay timer via the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e API and do the cosocket results in the timer handler, which runs asynchronously as to the original context creating the timer.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSpecial Escaping Sequences\u003c/h2\u003e\u003ca id=\"user-content-special-escaping-sequences\" class=\"anchor\" aria-label=\"Permalink: Special Escaping Sequences\" href=\"#special-escaping-sequences\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Following the \u003ccode\u003ev0.9.17\u003c/code\u003e release, this pitfall can be avoided by using the \u003ccode\u003e*_by_lua_block {}\u003c/code\u003e configuration directives.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePCRE sequences such as \u003ccode\u003e\\d\u003c/code\u003e, \u003ccode\u003e\\s\u003c/code\u003e, or \u003ccode\u003e\\w\u003c/code\u003e, require special attention because in string literals, the backslash character, \u003ccode\u003e\\\u003c/code\u003e, is stripped out by both the Lua language parser and by the Nginx config file parser before processing if not within a \u003ccode\u003e*_by_lua_block {}\u003c/code\u003e directive. So the following snippet will not work as expected:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # nginx.conf\n ? location /test {\n ?     content_by_lua '\n ?         local regex = \u0026quot;\\d+\u0026quot;  -- THIS IS WRONG OUTSIDE OF A *_by_lua_block DIRECTIVE\n ?         local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n ?         if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n ?     ';\n ? }\n # evaluates to \u0026quot;not matched!\u0026quot;\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # nginx.conf\u003c/span\u003e\n ? \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n ?     content_by_lua '\n ?         local regex = \u003cspan class=\"pl-s\"\u003e\"\u003cspan class=\"pl-cce\"\u003e\\d\u003c/span\u003e+\"\u003c/span\u003e  -- THIS IS WRONG OUTSIDE OF A *_by_lua_block DIRECTIVE\n ?         local m = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 1234\"\u003c/span\u003e, regex\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n ?         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e m then ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003em[0]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e else ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"not matched!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e end\n ?     '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n ? \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # evaluates to \"not matched!\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo avoid this, \u003cem\u003edouble\u003c/em\u003e escape the backslash:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # nginx.conf\n location /test {\n     content_by_lua '\n         local regex = \u0026quot;\\\\\\\\d+\u0026quot;\n         local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n         if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n     ';\n }\n # evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # nginx.conf\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua '\n         local regex = \u003cspan class=\"pl-s\"\u003e\"\u003cspan class=\"pl-cce\"\u003e\\\\\\\\\u003c/span\u003ed+\"\u003c/span\u003e\n         local m = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 1234\"\u003c/span\u003e, regex\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e m then ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003em[0]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e else ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"not matched!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e end\n     '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere, \u003ccode\u003e\\\\\\\\d+\u003c/code\u003e is stripped down to \u003ccode\u003e\\\\d+\u003c/code\u003e by the Nginx config file parser and this is further stripped down to \u003ccode\u003e\\d+\u003c/code\u003e by the Lua language parser before running.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlternatively, the regex pattern can be presented as a long-bracketed Lua string literal by encasing it in \"long brackets\", \u003ccode\u003e[[...]]\u003c/code\u003e, in which case backslashes have to only be escaped once for the Nginx config file parser.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # nginx.conf\n location /test {\n     content_by_lua '\n         local regex = [[\\\\d+]]\n         local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n         if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n     ';\n }\n # evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # nginx.conf\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua '\n         local regex = [[\\\\d+]]\n         local m = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 1234\"\u003c/span\u003e, regex\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e m then ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003em[0]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e else ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"not matched!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e end\n     '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere, \u003ccode\u003e[[\\\\d+]]\u003c/code\u003e is stripped down to \u003ccode\u003e[[\\d+]]\u003c/code\u003e by the Nginx config file parser and this is processed correctly.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that a longer from of the long bracket, \u003ccode\u003e[=[...]=]\u003c/code\u003e, may be required if the regex pattern contains \u003ccode\u003e[...]\u003c/code\u003e sequences.\nThe \u003ccode\u003e[=[...]=]\u003c/code\u003e form may be used as the default form if desired.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # nginx.conf\n location /test {\n     content_by_lua '\n         local regex = [=[[0-9]+]=]\n         local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n         if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n     ';\n }\n # evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # nginx.conf\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua '\n         local regex = [=[[0-9]+]=]\n         local m = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 1234\"\u003c/span\u003e, regex\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e m then ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003em[0]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e else ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"not matched!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e end\n     '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAn alternative approach to escaping PCRE sequences is to ensure that Lua code is placed in external script files and executed using the various \u003ccode\u003e*_by_lua_file\u003c/code\u003e directives.\nWith this approach, the backslashes are only stripped by the Lua language parser and therefore only need to be escaped once each.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- test.lua\n local regex = \u0026quot;\\\\d+\u0026quot;\n local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n -- evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e test.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eregex\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-cce\"\u003e\\\\\u003c/span\u003ed+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eregex\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e]) \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003enot matched!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e) \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWithin external script files, PCRE sequences presented as long-bracketed Lua string literals do not require modification.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- test.lua\n local regex = [[\\d+]]\n local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n -- evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e test.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eregex\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e[[\u003c/span\u003e\\d+\u003cspan class=\"pl-pds\"\u003e]]\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eregex\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e]) \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003enot matched!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e) \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAs noted earlier, PCRE sequences presented within \u003ccode\u003e*_by_lua_block {}\u003c/code\u003e directives (available following the \u003ccode\u003ev0.9.17\u003c/code\u003e release) do not require modification.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # nginx.conf\n location /test {\n     content_by_lua_block {\n         local regex = [[\\d+]]\n         local m = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, regex)\n         if m then ngx.say(m[0]) else ngx.say(\u0026quot;not matched!\u0026quot;) end\n     }\n }\n # evaluates to \u0026quot;1234\u0026quot;\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # nginx.conf\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local regex = [[\\d+]]\n         local m = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 1234\"\u003c/span\u003e, regex\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e m then ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003em[0]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e else ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"not matched!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # evaluates to \"1234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e You are recommended to use \u003ccode\u003eby_lua_file\u003c/code\u003e when the Lua code is very long.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eMixing with SSI Not Supported\u003c/h2\u003e\u003ca id=\"user-content-mixing-with-ssi-not-supported\" class=\"anchor\" aria-label=\"Permalink: Mixing with SSI Not Supported\" href=\"#mixing-with-ssi-not-supported\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eMixing SSI with ngx_lua in the same Nginx request is not supported at all. Just use ngx_lua exclusively. Everything you can do with SSI can be done atop ngx_lua anyway and it can be more efficient when using ngx_lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSPDY Mode Not Fully Supported\u003c/h2\u003e\u003ca id=\"user-content-spdy-mode-not-fully-supported\" class=\"anchor\" aria-label=\"Permalink: SPDY Mode Not Fully Supported\" href=\"#spdy-mode-not-fully-supported\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eCertain Lua APIs provided by ngx_lua do not work in Nginx's SPDY mode yet: \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e, \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e, and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eMissing data on short circuited requests\u003c/h2\u003e\u003ca id=\"user-content-missing-data-on-short-circuited-requests\" class=\"anchor\" aria-label=\"Permalink: Missing data on short circuited requests\" href=\"#missing-data-on-short-circuited-requests\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNginx may terminate a request early with (at least):\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e400 (Bad Request)\u003c/li\u003e\n\u003cli\u003e405 (Not Allowed)\u003c/li\u003e\n\u003cli\u003e408 (Request Timeout)\u003c/li\u003e\n\u003cli\u003e413 (Request Entity Too Large)\u003c/li\u003e\n\u003cli\u003e414 (Request URI Too Large)\u003c/li\u003e\n\u003cli\u003e494 (Request Headers Too Large)\u003c/li\u003e\n\u003cli\u003e499 (Client Closed Request)\u003c/li\u003e\n\u003cli\u003e500 (Internal Server Error)\u003c/li\u003e\n\u003cli\u003e501 (Not Implemented)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThis means that phases that normally run are skipped, such as the rewrite or\naccess phase. This also means that later phases that are run regardless, e.g.\n\u003ca href=\"#log_by_lua\"\u003elog_by_lua\u003c/a\u003e, will not have access to information that is normally set in those\nphases.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eTODO\u003c/h1\u003e\u003ca id=\"user-content-todo\" class=\"anchor\" aria-label=\"Permalink: TODO\" href=\"#todo\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003ecosocket: implement LuaSocket's unconnected UDP API.\u003c/li\u003e\n\u003cli\u003ecosocket: add support in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003ecosocket: review and merge aviramc's \u003ca href=\"https://github.com/openresty/lua-nginx-module/pull/290\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/openresty/lua-nginx-module/pull/290/hovercard\"\u003epatch\u003c/a\u003e for adding the \u003ccode\u003ebsdrecv\u003c/code\u003e method.\u003c/li\u003e\n\u003cli\u003ecosocket: add configure options for different strategies of handling the cosocket connection exceeding in the pools.\u003c/li\u003e\n\u003cli\u003euse \u003ccode\u003engx_hash_t\u003c/code\u003e to optimize the built-in header look-up process for \u003ca href=\"#ngxreqset_header\"\u003engx.req.set_header\u003c/a\u003e, and etc.\u003c/li\u003e\n\u003cli\u003eadd \u003ccode\u003eignore_resp_headers\u003c/code\u003e, \u003ccode\u003eignore_resp_body\u003c/code\u003e, and \u003ccode\u003eignore_resp\u003c/code\u003e options to \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e methods, to allow micro performance tuning on the user side.\u003c/li\u003e\n\u003cli\u003eadd automatic Lua code time slicing support by yielding and resuming the Lua VM actively via Lua's debug hooks.\u003c/li\u003e\n\u003cli\u003eadd \u003ccode\u003estat\u003c/code\u003e mode similar to \u003ca href=\"https://httpd.apache.org/docs/trunk/mod/mod_lua.html\" rel=\"nofollow\"\u003emod_lua\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eChanges\u003c/h1\u003e\u003ca id=\"user-content-changes\" class=\"anchor\" aria-label=\"Permalink: Changes\" href=\"#changes\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe changes made in every release of this module are listed in the change logs of the OpenResty bundle:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://openresty.org/#Changes\" rel=\"nofollow\"\u003ehttps://openresty.org/#Changes\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eBuild And Test\u003c/h1\u003e\u003ca id=\"user-content-build-and-test\" class=\"anchor\" aria-label=\"Permalink: Build And Test\" href=\"#build-and-test\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis module uses \u003ccode\u003e.travis.yml\u003c/code\u003e as the CI configuration.\nYou can always check \u003ccode\u003e.travis.yml\u003c/code\u003e for the latest CI configuration.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor developers, you need to run tests locally. You can use \u003ccode\u003eutil/run-ci.sh\u003c/code\u003e\nto easily set up the environment and execute the test suite.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo run the Test from the beginning:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"git clone https://github.com/openresty/lua-nginx-module.git\ncd lua-nginx-module\nbash util/run-ci.sh\"\u003e\u003cpre\u003egit clone https://github.com/openresty/lua-nginx-module.git\n\u003cspan class=\"pl-c1\"\u003ecd\u003c/span\u003e lua-nginx-module\nbash util/run-ci.sh\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eTest Suite\u003c/h1\u003e\u003ca id=\"user-content-test-suite\" class=\"anchor\" aria-label=\"Permalink: Test Suite\" href=\"#test-suite\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe following dependencies are required to run the test suite:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eNginx version \u0026gt;= 1.4.2\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003ePerl modules:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eTest::Nginx: \u003ca href=\"https://github.com/openresty/test-nginx\"\u003ehttps://github.com/openresty/test-nginx\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eNginx modules:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/set-misc-nginx-module\"\u003engx_set_misc\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://mdounin.ru/files/ngx_http_auth_request_module-0.2.tar.gz\" rel=\"nofollow\"\u003engx_auth_request\u003c/a\u003e (this is not needed if you're using Nginx 1.5.4+.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/echo-nginx-module\"\u003engx_echo\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/memc-nginx-module\"\u003engx_memc\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/srcache-nginx-module\"\u003engx_srcache\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003engx_lua (i.e., this module)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-upstream-nginx-module\"\u003engx_lua_upstream\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/headers-more-nginx-module\"\u003engx_headers_more\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/drizzle-nginx-module\"\u003engx_drizzle\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/rds-json-nginx-module\"\u003engx_rds_json\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/FRiCKLE/ngx_coolkit\"\u003engx_coolkit\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/redis2-nginx-module\"\u003engx_redis2\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe order in which these modules are added during configuration is important because the position of any filter module in the\nfiltering chain determines the final output, for example. The correct adding order is shown above.\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e3rd-party Lua libraries:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://www.kyne.au/~mark/software/lua-cjson.php\" rel=\"nofollow\"\u003elua-cjson\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eApplications:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003emysql: create database 'ngx_test', grant all privileges to user 'ngx_test', password is 'ngx_test'\u003c/li\u003e\n\u003cli\u003ememcached: listening on the default port, 11211.\u003c/li\u003e\n\u003cli\u003eredis: listening on the default port, 6379.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eSee also the \u003ca href=\"https://github.com/openresty/lua-nginx-module/blob/master/util/build.sh\"\u003edeveloper build script\u003c/a\u003e for more details on setting up the testing environment.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo run the whole test suite in the default testing mode:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"cd /path/to/lua-nginx-module\nexport PATH=/path/to/your/nginx/sbin:$PATH\nprove -I/path/to/test-nginx/lib -r t\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ecd /path/to/lua-nginx-module\nexport PATH=/path/to/your/nginx/sbin:$PATH\nprove -I/path/to/test-nginx/lib -r t\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo run specific test files:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"cd /path/to/lua-nginx-module\nexport PATH=/path/to/your/nginx/sbin:$PATH\nprove -I/path/to/test-nginx/lib t/002-content.t t/003-errors.t\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ecd /path/to/lua-nginx-module\nexport PATH=/path/to/your/nginx/sbin:$PATH\nprove -I/path/to/test-nginx/lib t/002-content.t t/003-errors.t\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo run a specific test block in a particular test file, add the line \u003ccode\u003e--- ONLY\u003c/code\u003e to the test block you want to run, and then use the \u003ccode\u003eprove\u003c/code\u003e utility to run that \u003ccode\u003e.t\u003c/code\u003e file.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThere are also various testing modes based on mockeagain, valgrind, and etc. Refer to the \u003ca href=\"https://search.cpan.org/perldoc?Test::Nginx\" rel=\"nofollow\"\u003eTest::Nginx documentation\u003c/a\u003e for more details for various advanced testing modes. See also the test reports for the Nginx test cluster running on Amazon EC2: \u003ca href=\"https://qa.openresty.org\" rel=\"nofollow\"\u003ehttps://qa.openresty.org\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eCopyright and License\u003c/h1\u003e\u003ca id=\"user-content-copyright-and-license\" class=\"anchor\" aria-label=\"Permalink: Copyright and License\" href=\"#copyright-and-license\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis module is licensed under the BSD license.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCopyright (C) 2009-2017, by Xiaozhe Wang (chaoslawful) \u003ca href=\"mailto:chaoslawful@gmail.com\"\u003echaoslawful@gmail.com\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCopyright (C) 2009-2019, by Yichun \"agentzh\" Zhang (章亦春) \u003ca href=\"mailto:agentzh@gmail.com\"\u003eagentzh@gmail.com\u003c/a\u003e, OpenResty Inc.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAll rights reserved.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRedistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eRedistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003eRedistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSee Also\u003c/h1\u003e\u003ca id=\"user-content-see-also\" class=\"anchor\" aria-label=\"Permalink: See Also\" href=\"#see-also\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBlog posts:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en/lua-cpu-flame-graph/?src=gh_ngxlua\" rel=\"nofollow\"\u003eIntroduction to Lua-Land CPU Flame Graphs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en//how-or-alloc-mem?src=gh_ngxlua\" rel=\"nofollow\"\u003eHow OpenResty and Nginx Allocate and Manage Memory\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en/how-nginx-shm-consume-ram/?src=gh_ngxlua\" rel=\"nofollow\"\u003eHow OpenResty and Nginx Shared Memory Zones Consume RAM\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en/nginx-shm-frag/?src=gh_ngxlua\" rel=\"nofollow\"\u003eMemory Fragmentation in OpenResty and Nginx's Shared Memory Zones\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eOther related modules and libraries:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/stream-lua-nginx-module#readme\"\u003engx_stream_lua_module\u003c/a\u003e for an official port of this module for the Nginx \"stream\" subsystem (doing generic downstream TCP communications).\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-memcached\"\u003elua-resty-memcached\u003c/a\u003e library based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-redis\"\u003elua-resty-redis\u003c/a\u003e library based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-mysql\"\u003elua-resty-mysql\u003c/a\u003e library based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-upload\"\u003elua-resty-upload\u003c/a\u003e library based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-dns\"\u003elua-resty-dns\u003c/a\u003e library based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-websocket\"\u003elua-resty-websocket\u003c/a\u003e library for both WebSocket server and client, based on ngx_lua cosocket.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-string\"\u003elua-resty-string\u003c/a\u003e library based on \u003ca href=\"https://luajit.org/ext_ffi.html\" rel=\"nofollow\"\u003eLuaJIT FFI\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-resty-lock\"\u003elua-resty-lock\u003c/a\u003e library for a nonblocking simple lock API.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/cloudflare/lua-resty-cookie\"\u003elua-resty-cookie\u003c/a\u003e library for HTTP cookie manipulation.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://openresty.org/#RoutingMySQLQueriesBasedOnURIArgs\" rel=\"nofollow\"\u003eRouting requests to different MySQL queries based on URI arguments\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://openresty.org/#DynamicRoutingBasedOnRedis\" rel=\"nofollow\"\u003eDynamic Routing Based on Redis and Lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://openresty.org/#UsingLuaRocks\" rel=\"nofollow\"\u003eUsing LuaRocks with ngx_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/lua-nginx-module/wiki/Introduction\"\u003eIntroduction to ngx_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/echo-nginx-module\"\u003eecho-nginx-module\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/drizzle-nginx-module\"\u003edrizzle-nginx-module\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/FRiCKLE/ngx_postgres\"\u003epostgres-nginx-module\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/memc-nginx-module\"\u003ememc-nginx-module\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eThe OpenResty bundle\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/openresty/nginx-systemtap-toolkit\"\u003eNginx Systemtap Toolkit\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eDirectives\u003c/h1\u003e\u003ca id=\"user-content-directives\" class=\"anchor\" aria-label=\"Permalink: Directives\" href=\"#directives\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#lua_load_resty_core\"\u003elua_load_resty_core\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_capture_error_log\"\u003elua_capture_error_log\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_use_default_type\"\u003elua_use_default_type\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_malloc_trim\"\u003elua_malloc_trim\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_thread_cache_max_entries\"\u003elua_thread_cache_max_entries\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_regex_cache_max_entries\"\u003elua_regex_cache_max_entries\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_regex_match_limit\"\u003elua_regex_match_limit\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_package_path\"\u003elua_package_path\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_package_cpath\"\u003elua_package_cpath\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_by_lua\"\u003einit_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_by_lua_block\"\u003einit_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_by_lua_file\"\u003einit_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_worker_by_lua\"\u003einit_worker_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_worker_by_lua_block\"\u003einit_worker_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#init_worker_by_lua_file\"\u003einit_worker_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#exit_worker_by_lua_block\"\u003eexit_worker_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#exit_worker_by_lua_file\"\u003eexit_worker_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#set_by_lua\"\u003eset_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#set_by_lua_block\"\u003eset_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#set_by_lua_file\"\u003eset_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#content_by_lua_block\"\u003econtent_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#server_rewrite_by_lua_block\"\u003eserver_rewrite_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#server_rewrite_by_lua_file\"\u003eserver_rewrite_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rewrite_by_lua_file\"\u003erewrite_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#access_by_lua\"\u003eaccess_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#access_by_lua_file\"\u003eaccess_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#header_filter_by_lua_block\"\u003eheader_filter_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#header_filter_by_lua_file\"\u003eheader_filter_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#body_filter_by_lua\"\u003ebody_filter_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#body_filter_by_lua_block\"\u003ebody_filter_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#body_filter_by_lua_file\"\u003ebody_filter_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#log_by_lua\"\u003elog_by_lua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#log_by_lua_block\"\u003elog_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#log_by_lua_file\"\u003elog_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#balancer_by_lua_block\"\u003ebalancer_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#balancer_by_lua_file\"\u003ebalancer_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#balancer_keepalive\"\u003ebalancer_keepalive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_client_hello_by_lua_block\"\u003essl_client_hello_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_client_hello_by_lua_file\"\u003essl_client_hello_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_certificate_by_lua_file\"\u003essl_certificate_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_session_fetch_by_lua_block\"\u003essl_session_fetch_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_session_fetch_by_lua_file\"\u003essl_session_fetch_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ssl_session_store_by_lua_file\"\u003essl_session_store_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#proxy_ssl_verify_by_lua_block\"\u003eproxy_ssl_verify_by_lua_block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#proxy_ssl_verify_by_lua_file\"\u003eproxy_ssl_verify_by_lua_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_connect_timeout\"\u003elua_socket_connect_timeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_send_timeout\"\u003elua_socket_send_timeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_send_lowat\"\u003elua_socket_send_lowat\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_buffer_size\"\u003elua_socket_buffer_size\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_pool_size\"\u003elua_socket_pool_size\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_keepalive_timeout\"\u003elua_socket_keepalive_timeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_socket_log_errors\"\u003elua_socket_log_errors\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_ciphers\"\u003elua_ssl_ciphers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_crl\"\u003elua_ssl_crl\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_protocols\"\u003elua_ssl_protocols\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_certificate\"\u003elua_ssl_certificate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_certificate_key\"\u003elua_ssl_certificate_key\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_trusted_certificate\"\u003elua_ssl_trusted_certificate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_verify_depth\"\u003elua_ssl_verify_depth\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_key_log\"\u003elua_ssl_key_log\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_ssl_conf_command\"\u003elua_ssl_conf_command\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_upstream_skip_openssl_default_verify\"\u003elua_upstream_skip_openssl_default_verify\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_http10_buffering\"\u003elua_http10_buffering\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rewrite_by_lua_no_postpone\"\u003erewrite_by_lua_no_postpone\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#access_by_lua_no_postpone\"\u003eaccess_by_lua_no_postpone\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_transform_underscores_in_response_headers\"\u003elua_transform_underscores_in_response_headers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_check_client_abort\"\u003elua_check_client_abort\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_max_pending_timers\"\u003elua_max_pending_timers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_max_running_timers\"\u003elua_max_running_timers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_sa_restart\"\u003elua_sa_restart\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lua_worker_thread_vm_pool_size\"\u003elua_worker_thread_vm_pool_size\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe basic building blocks of scripting Nginx with Lua are directives. Directives are used to specify when the user Lua code is run and\nhow the result will be used. Below is a diagram showing the order in which directives are executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" href=\"/openresty/lua-nginx-module/blob/master/doc/images/lua_nginx_modules_directives.drawio.png\"\u003e\u003cimg src=\"/openresty/lua-nginx-module/raw/master/doc/images/lua_nginx_modules_directives.drawio.png\" alt=\"Lua Nginx Modules Directives\" style=\"max-width: 100%;\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_load_resty_core\u003c/h2\u003e\u003ca id=\"user-content-lua_load_resty_core\" class=\"anchor\" aria-label=\"Permalink: lua_load_resty_core\" href=\"#lua_load_resty_core\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_load_resty_core on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_load_resty_core on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is deprecated since the \u003ccode\u003ev0.10.16\u003c/code\u003e release of this\nmodule. The \u003ccode\u003eresty.core\u003c/code\u003e module from\n\u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e is now mandatorily\nloaded during the Lua VM initialization. Specifying this directive will have no\neffect.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.15\u003c/code\u003e release and\nused to optionally load the \u003ccode\u003eresty.core\u003c/code\u003e module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_capture_error_log\u003c/h2\u003e\u003ca id=\"user-content-lua_capture_error_log\" class=\"anchor\" aria-label=\"Permalink: lua_capture_error_log\" href=\"#lua_capture_error_log\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_capture_error_log size\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003enone\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnables a buffer of the specified \u003ccode\u003esize\u003c/code\u003e for capturing all the Nginx error log message data (not just those produced\nby this module or the Nginx http subsystem, but everything) without touching files or disks.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can use units like \u003ccode\u003ek\u003c/code\u003e and \u003ccode\u003em\u003c/code\u003e in the \u003ccode\u003esize\u003c/code\u003e value, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_capture_error_log 100k;\"\u003e\u003cpre\u003e lua_capture_error_log \u003cspan class=\"pl-c1\"\u003e100k\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAs a rule of thumb, a 4KB buffer can usually hold about 20 typical error log messages. So do the maths!\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis buffer never grows. If it is full, new error log messages will replace the oldest ones in the buffer.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe size of the buffer must be bigger than the maximum length of a single error log message (which is 4K in OpenResty and 2K in stock NGINX).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can read the messages in the buffer on the Lua land via the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#get_logs\"\u003eget_logs()\u003c/a\u003e\nfunction of the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#readme\"\u003engx.errlog\u003c/a\u003e\nmodule of the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary. This Lua API function will return the captured error log messages and\nalso remove these already read from the global capturing buffer, making room\nfor any new error log data. For this reason, the user should not configure this\nbuffer to be too big if the user read the buffered error log data fast enough.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the log level specified in the standard \u003ca href=\"https://nginx.org/r/error_log\" rel=\"nofollow\"\u003eerror_log\u003c/a\u003e directive\n\u003cem\u003edoes\u003c/em\u003e have effect on this capturing facility. It only captures log\nmessages of a level no lower than the specified log level in the \u003ca href=\"https://nginx.org/r/error_log\" rel=\"nofollow\"\u003eerror_log\u003c/a\u003e directive.\nThe user can still choose to set an even higher filtering log level on the fly via the Lua API function\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#set_filter_level\"\u003eerrlog.set_filter_level\u003c/a\u003e.\nSo it is more flexible than the static \u003ca href=\"https://nginx.org/r/error_log\" rel=\"nofollow\"\u003eerror_log\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is worth noting that there is no way to capture the debugging logs\nwithout building OpenResty or Nginx with the \u003ccode\u003e./configure\u003c/code\u003e\noption \u003ccode\u003e--with-debug\u003c/code\u003e. And enabling debugging logs is\nstrongly discouraged in production builds due to high overhead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.9\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_use_default_type\u003c/h2\u003e\u003ca id=\"user-content-lua_use_default_type\" class=\"anchor\" aria-label=\"Permalink: lua_use_default_type\" href=\"#lua_use_default_type\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_use_default_type on | off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_use_default_type on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies whether to use the MIME type specified by the \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_core_module.html#default_type\" rel=\"nofollow\"\u003edefault_type\u003c/a\u003e directive for the default value of the \u003ccode\u003eContent-Type\u003c/code\u003e response header. Deactivate this directive if a default \u003ccode\u003eContent-Type\u003c/code\u003e response header for Lua request handlers is not desired.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is turned on by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_malloc_trim\u003c/h2\u003e\u003ca id=\"user-content-lua_malloc_trim\" class=\"anchor\" aria-label=\"Permalink: lua_malloc_trim\" href=\"#lua_malloc_trim\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_malloc_trim \u0026lt;request-count\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_malloc_trim 1000\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAsks the underlying \u003ccode\u003elibc\u003c/code\u003e runtime library to release its cached free memory back to the operating system every\n\u003ccode\u003eN\u003c/code\u003e requests processed by the Nginx core. By default, \u003ccode\u003eN\u003c/code\u003e is 1000. You can configure the request count\nby using your own numbers. Smaller numbers mean more frequent releases, which may introduce higher CPU time consumption and\nsmaller memory footprint while larger numbers usually lead to less CPU time overhead and relatively larger memory footprint.\nJust tune the number for your own use cases.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eConfiguring the argument to \u003ccode\u003e0\u003c/code\u003e essentially turns off the periodical memory trimming altogether.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_malloc_trim 0;  # turn off trimming completely\"\u003e\u003cpre\u003e lua_malloc_trim 0\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # turn off trimming completely\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe current implementation uses an Nginx log phase handler to do the request counting. So the appearance of the\n\u003ca href=\"https://nginx.org/en/docs/http/ngx_http_core_module.html#log_subrequest\" rel=\"nofollow\"\u003elog_subrequest on\u003c/a\u003e directives in \u003ccode\u003enginx.conf\u003c/code\u003e\nmay make the counting faster when subrequests are involved. By default, only \"main requests\" count.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this directive does \u003cem\u003enot\u003c/em\u003e affect the memory allocated by LuaJIT's own allocator based on the \u003ccode\u003emmap\u003c/code\u003e\nsystem call.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_code_cache\u003c/h2\u003e\u003ca id=\"user-content-lua_code_cache\" class=\"anchor\" aria-label=\"Permalink: lua_code_cache\" href=\"#lua_code_cache\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_code_cache on | off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_code_cache on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnables or disables the Lua code cache for Lua code in \u003ccode\u003e*_by_lua_file\u003c/code\u003e directives (like \u003ca href=\"#set_by_lua_file\"\u003eset_by_lua_file\u003c/a\u003e and\n\u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e) and Lua modules.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen turning off, every request served by ngx_lua will run in a separate Lua VM instance, starting from the \u003ccode\u003e0.9.3\u003c/code\u003e release. So the Lua files referenced in \u003ca href=\"#set_by_lua_file\"\u003eset_by_lua_file\u003c/a\u003e,\n\u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e, \u003ca href=\"#access_by_lua_file\"\u003eaccess_by_lua_file\u003c/a\u003e,\nand etc will not be cached\nand all Lua modules used will be loaded from scratch. With this in place, developers can adopt an edit-and-refresh approach.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease note however, that Lua code written inlined within nginx.conf\nsuch as those specified by \u003ca href=\"#set_by_lua\"\u003eset_by_lua\u003c/a\u003e, \u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e,\n\u003ca href=\"#access_by_lua\"\u003eaccess_by_lua\u003c/a\u003e, and \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua\u003c/a\u003e will not be updated when you edit the inlined Lua code in your \u003ccode\u003enginx.conf\u003c/code\u003e file because only the Nginx config file parser can correctly parse the \u003ccode\u003enginx.conf\u003c/code\u003e\nfile and the only way is to reload the config file\nby sending a \u003ccode\u003eHUP\u003c/code\u003e signal or just to restart Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEven when the code cache is enabled, Lua files which are loaded by \u003ccode\u003edofile\u003c/code\u003e or \u003ccode\u003eloadfile\u003c/code\u003e\nin *_by_lua_file cannot be cached (unless you cache the results yourself). Usually you can either use the \u003ca href=\"#init_by_lua\"\u003einit_by_lua\u003c/a\u003e\nor \u003ca href=\"#init-by_lua_file\"\u003einit_by_lua_file\u003c/a\u003e directives to load all such files or just make these Lua files true Lua modules\nand load them via \u003ccode\u003erequire\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe ngx_lua module does not support the \u003ccode\u003estat\u003c/code\u003e mode available with the\nApache \u003ccode\u003emod_lua\u003c/code\u003e module (yet).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDisabling the Lua code cache is strongly\ndiscouraged for production use and should only be used during\ndevelopment as it has a significant negative impact on overall performance. For example, the performance of a \"hello world\" Lua example can drop by an order of magnitude after disabling the Lua code cache.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_thread_cache_max_entries\u003c/h2\u003e\u003ca id=\"user-content-lua_thread_cache_max_entries\" class=\"anchor\" aria-label=\"Permalink: lua_thread_cache_max_entries\" href=\"#lua_thread_cache_max_entries\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_thread_cache_max_entries \u0026lt;num\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_thread_cache_max_entries 1024\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the maximum number of entries allowed in the worker process level lua thread object cache.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis cache recycles the lua thread GC objects among all our \"light threads\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eA zero value of \u003ccode\u003e\u0026lt;num\u0026gt;\u003c/code\u003e disables the cache.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this feature requires OpenResty's LuaJIT with the new C API \u003ccode\u003elua_resetthread\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in verson \u003ccode\u003ev0.10.9\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_regex_cache_max_entries\u003c/h2\u003e\u003ca id=\"user-content-lua_regex_cache_max_entries\" class=\"anchor\" aria-label=\"Permalink: lua_regex_cache_max_entries\" href=\"#lua_regex_cache_max_entries\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_regex_cache_max_entries \u0026lt;num\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_regex_cache_max_entries 1024\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the maximum number of entries allowed in the worker process level compiled regex cache.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe regular expressions used in \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e, \u003ca href=\"#ngxregmatch\"\u003engx.re.gmatch\u003c/a\u003e, \u003ca href=\"#ngxresub\"\u003engx.re.sub\u003c/a\u003e, and \u003ca href=\"#ngxregsub\"\u003engx.re.gsub\u003c/a\u003e will be cached within this cache if the regex option \u003ccode\u003eo\u003c/code\u003e (i.e., compile-once flag) is specified.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe default number of entries allowed is 1024 and when this limit is reached, new regular expressions will not be cached (as if the \u003ccode\u003eo\u003c/code\u003e option was not specified) and there will be one, and only one, warning in the \u003ccode\u003eerror.log\u003c/code\u003e file:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"2011/08/27 23:18:26 [warn] 31997#0: *1 lua exceeding regex cache max entries (1024), ...\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e2011/08/27 23:18:26 [warn] 31997#0: *1 lua exceeding regex cache max entries (1024), ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf you are using the \u003ccode\u003engx.re.*\u003c/code\u003e implementation of \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e by loading the \u003ccode\u003eresty.core.regex\u003c/code\u003e module (or just the \u003ccode\u003eresty.core\u003c/code\u003e module), then an LRU cache is used for the regex cache being used here.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDo not activate the \u003ccode\u003eo\u003c/code\u003e option for regular expressions (and/or \u003ccode\u003ereplace\u003c/code\u003e string arguments for \u003ca href=\"#ngxresub\"\u003engx.re.sub\u003c/a\u003e and \u003ca href=\"#ngxregsub\"\u003engx.re.gsub\u003c/a\u003e) that are generated \u003cem\u003eon the fly\u003c/em\u003e and give rise to infinite variations to avoid hitting the specified limit.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_regex_match_limit\u003c/h2\u003e\u003ca id=\"user-content-lua_regex_match_limit\" class=\"anchor\" aria-label=\"Permalink: lua_regex_match_limit\" href=\"#lua_regex_match_limit\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_regex_match_limit \u0026lt;num\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_regex_match_limit 0\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the \"match limit\" used by the PCRE library when executing the \u003ca href=\"#ngxrematch\"\u003engx.re API\u003c/a\u003e. To quote the PCRE manpage, \"the limit ... has the effect of limiting the amount of backtracking that can take place.\"\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the limit is hit, the error string \"pcre_exec() failed: -8\" will be returned by the \u003ca href=\"#ngxrematch\"\u003engx.re API\u003c/a\u003e functions on the Lua land.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen setting the limit to 0, the default \"match limit\" when compiling the PCRE library is used. And this is the default value of this directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.8.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_package_path\u003c/h2\u003e\u003ca id=\"user-content-lua_package_path\" class=\"anchor\" aria-label=\"Permalink: lua_package_path\" href=\"#lua_package_path\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_package_path \u0026lt;lua-style-path-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eThe content of LUA_PATH environment variable or Lua's compiled-in defaults.\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets the Lua module search path used by scripts specified by \u003ca href=\"#set_by_lua\"\u003eset_by_lua\u003c/a\u003e,\n\u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e and others. The path string is in standard Lua path form, and \u003ccode\u003e;;\u003c/code\u003e\ncan be used to stand for the original search paths.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAs from the \u003ccode\u003ev0.5.0rc29\u003c/code\u003e release, the special notation \u003ccode\u003e$prefix\u003c/code\u003e or \u003ccode\u003e${prefix}\u003c/code\u003e can be used in the search path string to indicate the path of the \u003ccode\u003eserver prefix\u003c/code\u003e usually determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_package_cpath\u003c/h2\u003e\u003ca id=\"user-content-lua_package_cpath\" class=\"anchor\" aria-label=\"Permalink: lua_package_cpath\" href=\"#lua_package_cpath\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_package_cpath \u0026lt;lua-style-cpath-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eThe content of LUA_CPATH environment variable or Lua's compiled-in defaults.\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets the Lua C-module search path used by scripts specified by \u003ca href=\"#set_by_lua\"\u003eset_by_lua\u003c/a\u003e,\n\u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e and others. The cpath string is in standard Lua cpath form, and \u003ccode\u003e;;\u003c/code\u003e\ncan be used to stand for the original cpath.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAs from the \u003ccode\u003ev0.5.0rc29\u003c/code\u003e release, the special notation \u003ccode\u003e$prefix\u003c/code\u003e or \u003ccode\u003e${prefix}\u003c/code\u003e can be used in the search path string to indicate the path of the \u003ccode\u003eserver prefix\u003c/code\u003e usually determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_by_lua\u003c/h2\u003e\u003ca id=\"user-content-init_by_lua\" class=\"anchor\" aria-label=\"Permalink: init_by_lua\" href=\"#init_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eloading-config\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#init_by_lua_block\"\u003einit_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#init_by_lua_block\"\u003einit_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n init_by_lua '\n     print(\u0026quot;I need no extra escaping here, for example: \\r\\nblah\u0026quot;)\n '\"\u003e\u003cpre\u003e init_by_lua '\n     print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"I need no extra escaping here, for example: \u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003eblah\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-init_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: init_by_lua_block\" href=\"#init_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eloading-config\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen Nginx receives the \u003ccode\u003eHUP\u003c/code\u003e signal and starts reloading the config file, the Lua VM will also be re-created and \u003ccode\u003einit_by_lua_block\u003c/code\u003e will run again on the new Lua VM. In case that the \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e directive is turned off (default on), the \u003ccode\u003einit_by_lua_block\u003c/code\u003e handler will run upon every request because in this special mode a standalone Lua VM is always created for each request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUsually you can pre-load Lua modules at server start-up by means of this hook and take advantage of modern operating systems' copy-on-write (COW) optimization. Here is an example for pre-loading Lua modules:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # this runs before forking out nginx worker processes:\n init_by_lua_block { require \u0026quot;cjson\u0026quot; }\n\n server {\n     location = /api {\n         content_by_lua_block {\n             -- the following require() will just  return\n             -- the already loaded module from package.loaded:\n             ngx.say(require \u0026quot;cjson\u0026quot;.encode{dog = 5, cat = 6})\n         }\n     }\n }\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # this runs before forking out nginx worker processes:\u003c/span\u003e\n init_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e require \u003cspan class=\"pl-s\"\u003e\"cjson\"\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /api \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             -- the following require\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e will just  \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n             -- the already loaded module from package.loaded:\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003erequire \u003cspan class=\"pl-s\"\u003e\"cjson\"\u003c/span\u003e.encode\u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003edog = 5, cat = 6\u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eYou can also initialize the \u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e shm storage at this phase. Here is an example for this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_shared_dict dogs 1m;\n\n init_by_lua_block {\n     local dogs = ngx.shared.dogs\n     dogs:set(\u0026quot;Tom\u0026quot;, 56)\n }\n\n server {\n     location = /api {\n         content_by_lua_block {\n             local dogs = ngx.shared.dogs\n             ngx.say(dogs:get(\u0026quot;Tom\u0026quot;))\n         }\n     }\n }\"\u003e\u003cpre\u003e lua_shared_dict dogs \u003cspan class=\"pl-c1\"\u003e1m\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n init_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     local dogs = ngx.shared.dogs\n     dogs:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"Tom\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e56\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /api \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local dogs = ngx.shared.dogs\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003edogs:get\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"Tom\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBut note that, the \u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e's shm storage will not be cleared through a config reload (via the \u003ccode\u003eHUP\u003c/code\u003e signal, for example). So if you do \u003cem\u003enot\u003c/em\u003e want to re-initialize the shm storage in your \u003ccode\u003einit_by_lua_block\u003c/code\u003e code in this case, then you just need to set a custom flag in the shm storage and always check the flag in your \u003ccode\u003einit_by_lua_block\u003c/code\u003e code.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBecause the Lua code in this context runs before Nginx forks its worker processes (if any), data or code loaded here will enjoy the \u003ca href=\"https://en.wikipedia.org/wiki/Copy-on-write\" rel=\"nofollow\"\u003eCopy-on-write (COW)\u003c/a\u003e feature provided by many operating systems among all the worker processes, thus saving a lot of memory.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDo \u003cem\u003enot\u003c/em\u003e initialize your own Lua global variables in this context because use of Lua global variables have performance penalties and can lead to global namespace pollution (see the \u003ca href=\"#lua-variable-scope\"\u003eLua Variable Scope\u003c/a\u003e section for more details). The recommended way is to use proper \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#5.3\" rel=\"nofollow\"\u003eLua module\u003c/a\u003e files (but do not use the standard Lua function \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-module\" rel=\"nofollow\"\u003emodule()\u003c/a\u003e to define Lua modules because it pollutes the global namespace as well) and call \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-require\" rel=\"nofollow\"\u003erequire()\u003c/a\u003e to load your own module files in \u003ccode\u003einit_by_lua_block\u003c/code\u003e or other contexts (\u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-require\" rel=\"nofollow\"\u003erequire()\u003c/a\u003e does cache the loaded Lua modules in the global \u003ccode\u003epackage.loaded\u003c/code\u003e table in the Lua registry so your modules will only loaded once for the whole Lua VM instance).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly a small set of the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e is supported in this context:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eLogging APIs: \u003ca href=\"#ngxlog\"\u003engx.log\u003c/a\u003e and \u003ca href=\"#print\"\u003eprint\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003eShared Dictionary API: \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eMore Nginx APIs for Lua may be supported in this context upon future user requests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBasically you can safely use Lua libraries that do blocking I/O in this very context because blocking the master process during server start-up is completely okay. Even the Nginx core does blocking I/O (at least on resolving upstream's host names) at the configure-loading phase.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou should be very careful about potential security vulnerabilities in your Lua code registered in this context because the Nginx master process is often run under the \u003ccode\u003eroot\u003c/code\u003e account.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also the following blog posts for more details on OpenResty and Nginx's shared memory zones:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en/how-nginx-shm-consume-ram/?src=gh_ngxlua\" rel=\"nofollow\"\u003eHow OpenResty and Nginx Shared Memory Zones Consume RAM\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.openresty.com/en/nginx-shm-frag/?src=gh_ngxlua\" rel=\"nofollow\"\u003eMemory Fragmentation in OpenResty and Nginx's Shared Memory Zones\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-init_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: init_by_lua_file\" href=\"#init_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eloading-config\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#init_by_lua_block\"\u003einit_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code or \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_worker_by_lua\u003c/h2\u003e\u003ca id=\"user-content-init_worker_by_lua\" class=\"anchor\" aria-label=\"Permalink: init_worker_by_lua\" href=\"#init_worker_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003estarting-worker\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#init_worker_by_lua_block\"\u003einit_worker_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#init_worker_by_lua_block\"\u003einit_worker_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n init_worker_by_lua '\n     print(\u0026quot;I need no extra escaping here, for example: \\r\\nblah\u0026quot;)\n ';\"\u003e\u003cpre\u003e init_worker_by_lua '\n     print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"I need no extra escaping here, for example: \u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003eblah\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook no longer runs in the cache manager and cache loader processes since the \u003ccode\u003ev0.10.12\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_worker_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-init_worker_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: init_worker_by_lua_block\" href=\"#init_worker_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003estarting-worker\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRuns the specified Lua code upon every Nginx worker process's startup when the master process is enabled. When the master process is disabled, this hook will just run after \u003ca href=\"#init_by_lua_block\"\u003einit_by_lua*\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook is often used to create per-worker reoccurring timers (via the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e Lua API), either for backend health-check or other timed routine work. Below is an example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n init_worker_by_lua_block {\n     local delay = 3  -- in seconds\n     local new_timer = ngx.timer.at\n     local log = ngx.log\n     local ERR = ngx.ERR\n     local check\n\n     check = function(premature)\n         if not premature then\n             -- do the health check or other routine work\n             local ok, err = new_timer(delay, check)\n             if not ok then\n                 log(ERR, \u0026quot;failed to create timer: \u0026quot;, err)\n                 return\n             end\n         end\n\n         -- do something in timer\n     end\n\n     local hdl, err = new_timer(delay, check)\n     if not hdl then\n         log(ERR, \u0026quot;failed to create timer: \u0026quot;, err)\n         return\n     end\n\n     -- other job in init_worker_by_lua\n }\"\u003e\u003cpre\u003e init_worker_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     local delay = 3  -- in seconds\n     local new_timer = ngx.timer.at\n     local log = ngx.log\n     local ERR = ngx.ERR\n     local check\n\n     check = function\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003epremature\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not premature then\n             -- do the health check or other routine work\n             local ok, err = new_timer\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003edelay, check\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n                 log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eERR, \u003cspan class=\"pl-s\"\u003e\"failed to create timer: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n             end\n         end\n\n         -- do something in timer\n     end\n\n     local hdl, err = new_timer\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003edelay, check\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not hdl then\n         log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eERR, \u003cspan class=\"pl-s\"\u003e\"failed to create timer: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     end\n\n     -- other job in init_worker_by_lua\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook no longer runs in the cache manager and cache loader processes since the \u003ccode\u003ev0.10.12\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003einit_worker_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-init_worker_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: init_worker_by_lua_file\" href=\"#init_worker_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua_file \u0026lt;lua-file-path\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003estarting-worker\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to \u003ca href=\"#init_worker_by_lua_block\"\u003einit_worker_by_lua_block\u003c/a\u003e, but accepts the file path to a Lua source file or Lua bytecode file.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook no longer runs in the cache manager and cache loader processes since the \u003ccode\u003ev0.10.12\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eexit_worker_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-exit_worker_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: exit_worker_by_lua_block\" href=\"#exit_worker_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eexit_worker_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eexiting-worker\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRuns the specified Lua code upon every Nginx worker process's exit when the master process is enabled. When the master process is disabled, this hook will run before the Nginx process exits.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook is often used to release resources allocated by each worker (e.g. resources allocated by \u003ca href=\"#init_worker_by_lua_block\"\u003einit_worker_by_lua*\u003c/a\u003e), or to prevent workers from exiting abnormally.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n exit_worker_by_lua_block {\n     print(\u0026quot;log from exit_worker_by_lua_block\u0026quot;)\n }\"\u003e\u003cpre\u003e exit_worker_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"log from exit_worker_by_lua_block\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt's not allowed to create a timer (even a 0-delay timer) here since it runs after all timers have been processed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eexit_worker_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-exit_worker_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: exit_worker_by_lua_file\" href=\"#exit_worker_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eexit_worker_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eexiting-worker\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to \u003ca href=\"#exit_worker_by_lua_block\"\u003eexit_worker_by_lua_block\u003c/a\u003e, but accepts the file path to a Lua source file or Lua bytecode file.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eset_by_lua\u003c/h2\u003e\u003ca id=\"user-content-set_by_lua\" class=\"anchor\" aria-label=\"Permalink: set_by_lua\" href=\"#set_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eset_by_lua $res \u0026lt;lua-script-str\u0026gt; [$arg1 $arg2 ...]\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eserver, server if, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#set_by_lua_block\"\u003eset_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#set_by_lua_block\"\u003eset_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping), and\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ethis directive support extra arguments after the Lua script.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n set_by_lua $res ' return 32 + math.cos(32) ';\n # $res now has the value \u0026quot;32.834223360507\u0026quot; or alike.\"\u003e\u003cpre\u003e set_by_lua \u003cspan class=\"pl-v\"\u003e$res\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e' return 32 + math.cos(32) '\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # $res now has the value \"32.834223360507\" or alike.\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAs from the \u003ccode\u003ev0.5.0rc29\u003c/code\u003e release, Nginx variable interpolation is disabled in the \u003ccode\u003e\u0026lt;lua-script-str\u0026gt;\u003c/code\u003e argument of this directive and therefore, the dollar sign character (\u003ccode\u003e$\u003c/code\u003e) can be used directly.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires the \u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eset_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-set_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: set_by_lua_block\" href=\"#set_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eset_by_lua_block $res { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eserver, server if, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExecutes code specified inside a pair of curly braces (\u003ccode\u003e{}\u003c/code\u003e), and returns string output to \u003ccode\u003e$res\u003c/code\u003e.\nThe code inside a pair of curly braces (\u003ccode\u003e{}\u003c/code\u003e) can make \u003ca href=\"#nginx-api-for-lua\"\u003eAPI calls\u003c/a\u003e and can retrieve input arguments from the \u003ccode\u003engx.arg\u003c/code\u003e table (index starts from \u003ccode\u003e1\u003c/code\u003e and increases sequentially).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is designed to execute short, fast running code blocks as the Nginx event loop is blocked during code execution. Time consuming code sequences should therefore be avoided.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is implemented by injecting custom commands into the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e's command list. Because \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e does not support nonblocking I/O in its commands, Lua APIs requiring yielding the current Lua \"light thread\" cannot work in this directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAt least the following API functions are currently disabled within the context of \u003ccode\u003eset_by_lua_block\u003c/code\u003e:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eOutput API functions (e.g., \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e and \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eControl API functions (e.g., \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eSubrequest API functions (e.g., \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eCosocket API functions (e.g., \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e).\u003c/li\u003e\n\u003cli\u003eSleeping API function \u003ca href=\"#ngxsleep\"\u003engx.sleep\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIn addition, note that this directive can only write out a value to a single Nginx variable at\na time. However, a workaround is possible using the \u003ca href=\"#ngxvarvariable\"\u003engx.var.VARIABLE\u003c/a\u003e interface.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     set $diff ''; # we have to predefine the $diff variable here\n\n     set_by_lua_block $sum {\n         local a = 32\n         local b = 56\n\n         ngx.var.diff = a - b  -- write to $diff directly\n         return a + b          -- return the $sum value normally\n     }\n\n     echo \u0026quot;sum = $sum, diff = $diff\u0026quot;;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$diff\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # we have to predefine the \u003cspan class=\"pl-v\"\u003e$diff\u003c/span\u003e variable here\n\n     set_by_lua_block \u003cspan class=\"pl-v\"\u003e$sum\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local a = \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e\n         local b = \u003cspan class=\"pl-c1\"\u003e56\u003c/span\u003e\n\n         ngx.var.diff = a - b  -- write to \u003cspan class=\"pl-v\"\u003e$diff\u003c/span\u003e directly\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e a + b          -- \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e the \u003cspan class=\"pl-v\"\u003e$sum\u003c/span\u003e value normally\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     echo \u003cspan class=\"pl-s\"\u003e\"sum = $sum, diff = $diff\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive can be freely mixed with all directives of the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e, \u003ca href=\"http://github.com/openresty/set-misc-nginx-module\"\u003eset-misc-nginx-module\u003c/a\u003e, and \u003ca href=\"http://github.com/openresty/array-var-nginx-module\"\u003earray-var-nginx-module\u003c/a\u003e modules. All of these directives will run in the same order as they appear in the config file.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n set $foo 32;\n set_by_lua_block $bar { return tonumber(ngx.var.foo) + 1 }\n set $baz \u0026quot;bar: $bar\u0026quot;;  # $baz == \u0026quot;bar: 33\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$foo\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n set_by_lua_block \u003cspan class=\"pl-v\"\u003e$bar\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e + 1 \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$baz\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\"bar: $bar\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # \u003cspan class=\"pl-v\"\u003e$baz\u003c/span\u003e == \u003cspan class=\"pl-s\"\u003e\"bar: 33\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNo special escaping is required in the Lua code block.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires the \u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eset_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-set_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: set_by_lua_file\" href=\"#set_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eset_by_lua_file $res \u0026lt;path-to-lua-script-file\u0026gt; [$arg1 $arg2 ...]\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eserver, server if, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#set_by_lua_block\"\u003eset_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variable interpolation is supported in the \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e argument string of this directive. But special care must be taken for injection attacks.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached\nand the Nginx config must be reloaded each time the Lua source file is modified.\nThe Lua code cache can be temporarily disabled during development by\nswitching \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e \u003ccode\u003eoff\u003c/code\u003e in \u003ccode\u003enginx.conf\u003c/code\u003e to avoid reloading Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires the \u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003econtent_by_lua\u003c/h2\u003e\u003ca id=\"user-content-content_by_lua\" class=\"anchor\" aria-label=\"Permalink: content_by_lua\" href=\"#content_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003econtent_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003econtent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#content_by_lua_block\"\u003econtent_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#content_by_lua_block\"\u003econtent_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n content_by_lua '\n     ngx.say(\u0026quot;I need no extra escaping here, for example: \\r\\nblah\u0026quot;)\n ';\"\u003e\u003cpre\u003e content_by_lua '\n     ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"I need no extra escaping here, for example: \u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003eblah\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003econtent_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-content_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: content_by_lua_block\" href=\"#content_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003econtent_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003econtent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n content_by_lua_block {\n     ngx.say(\u0026quot;I need no extra escaping here, for example: \\r\\nblah\u0026quot;)\n }\"\u003e\u003cpre\u003e content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"I need no extra escaping here, for example: \u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003eblah\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eActs as a \"content handler\" and executes Lua code string specified in \u003ccode\u003e{ lua-script }\u003c/code\u003e for every request.\nThe Lua code may make \u003ca href=\"#nginx-api-for-lua\"\u003eAPI calls\u003c/a\u003e and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDo not use this directive and other content handler directives in the same location. For example, this directive and the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass\" rel=\"nofollow\"\u003eproxy_pass\u003c/a\u003e directive should not be used in the same location.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003econtent_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-content_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: content_by_lua_file\" href=\"#content_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003econtent_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003econtent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#content_by_lua_block\"\u003econtent_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the file is not found, a \u003ccode\u003e404 Not Found\u003c/code\u003e status code will be returned, and a \u003ccode\u003e503 Service Temporarily Unavailable\u003c/code\u003e status code will be returned in case of errors in reading other files.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables can be used in the \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e string to provide flexibility. This however carries some risks and is not ordinarily recommended.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached\nand the Nginx config must be reloaded each time the Lua source file is modified.\nThe Lua code cache can be temporarily disabled during development by\nswitching \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e \u003ccode\u003eoff\u003c/code\u003e in \u003ccode\u003enginx.conf\u003c/code\u003e to avoid reloading Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables are supported in the file path for dynamic dispatch, for example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # CAUTION: contents in nginx var must be carefully filtered,\n # otherwise there'll be great security risk!\n location ~ ^/app/([-_a-zA-Z0-9/]+) {\n     set $path $1;\n     content_by_lua_file /path/to/lua/app/root/$path.lua;\n }\"\u003e\u003cpre\u003e\u003cspan class=\"pl-c\"\u003e # CAUTION: contents in nginx var must be carefully filtered,\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e # otherwise there'll be great security risk!\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e \u003cspan class=\"pl-sr\"\u003e~\u003c/span\u003e ^/app/\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e[-_a-zA-Z0-9/]+\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$path\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$1\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     content_by_lua_file /path/to/lua/app/\u003cspan class=\"pl-c1\"\u003eroot\u003c/span\u003e/\u003cspan class=\"pl-v\"\u003e$path\u003c/span\u003e.lua\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBut be very careful about malicious user inputs and always carefully validate or filter out the user-supplied path components.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eserver_rewrite_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-server_rewrite_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: server_rewrite_by_lua_block\" href=\"#server_rewrite_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eserver_rewrite_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eserver rewrite\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eActs as a server rewrite phase handler and executes Lua code string specified in \u003ccode\u003e{ lua-script }\u003c/code\u003e for every request.\nThe Lua code may make \u003ca href=\"#nginx-api-for-lua\"\u003eAPI calls\u003c/a\u003e and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server {\n     ...\n\n     server_rewrite_by_lua_block {\n         ngx.ctx.a = \u0026quot;server_rewrite_by_lua_block in http\u0026quot;\n     }\n\n     location /lua {\n         content_by_lua_block {\n             ngx.say(ngx.ctx.a)\n             ngx.log(ngx.INFO, ngx.ctx.a)\n        \t}\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ...\n\n     server_rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.a = \u003cspan class=\"pl-s\"\u003e\"server_rewrite_by_lua_block in http\"\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ctx.a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             ngx.log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.INFO, ngx.ctx.a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n        \t\u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eJust as any other rewrite phase handlers, \u003ca href=\"#server_rewrite_by_lua_block\"\u003eserver_rewrite_by_lua_block\u003c/a\u003e also runs in subrequests.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server {\n     server_rewrite_by_lua_block {\n         ngx.log(ngx.INFO, \u0026quot;is_subrequest:\u0026quot;, ngx.is_subrequest)\n     }\n\n     location /lua {\n         content_by_lua_block {\n             local res = ngx.location.capture(\u0026quot;/sub\u0026quot;)\n             ngx.print(res.body)\n         }\n     }\n\n     location /sub {\n         content_by_lua_block {\n             ngx.say(\u0026quot;OK\u0026quot;)\n         }\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     server_rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.INFO, \u003cspan class=\"pl-s\"\u003e\"is_subrequest:\"\u003c/span\u003e, ngx.is_subrequest\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/sub\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /sub \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"OK\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that when calling \u003ccode\u003engx.exit(ngx.OK)\u003c/code\u003e within a \u003ca href=\"#server_rewrite_by_lua_block\"\u003eserver_rewrite_by_lua_block\u003c/a\u003e handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a \u003ca href=\"#server_rewrite_by_lua_block\"\u003eserver_rewrite_by_lua_block\u003c/a\u003e handler, call \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e with status \u0026gt;= 200 (\u003ccode\u003engx.HTTP_OK\u003c/code\u003e) and status \u0026lt; 300 (\u003ccode\u003engx.HTTP_SPECIAL_RESPONSE\u003c/code\u003e) for successful quits and \u003ccode\u003engx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)\u003c/code\u003e (or its friends) for failures.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server_rewrite_by_lua_block {\n     ngx.exit(503)\n }\n\n location /bar {\n     ...\n     # never exec\n }\"\u003e\u003cpre\u003e server_rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e503\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /bar \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ...\n\u003cspan class=\"pl-c\"\u003e     # never exec\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eserver_rewrite_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-server_rewrite_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: server_rewrite_by_lua_file\" href=\"#server_rewrite_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eserver_rewrite_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eserver rewrite\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#server_rewrite_by_lua_block\"\u003eserver_rewrite_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.10.22\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables can be used in the \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e string to provide flexibility. This however carries some risks and is not ordinarily recommended.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached and the Nginx config must be reloaded each time the Lua source file is modified. The Lua code cache can be temporarily disabled during development by switching \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e \u003ccode\u003eoff\u003c/code\u003e in \u003ccode\u003enginx.conf\u003c/code\u003e to avoid reloading Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003erewrite_by_lua\u003c/h2\u003e\u003ca id=\"user-content-rewrite_by_lua\" class=\"anchor\" aria-label=\"Permalink: rewrite_by_lua\" href=\"#rewrite_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003erewrite_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite_by_lua '\n     do_something(\u0026quot;hello, world!\\nhiya\\n\u0026quot;)\n ';\"\u003e\u003cpre\u003e rewrite_by_lua '\n     do_something\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, world!\u003cspan class=\"pl-cce\"\u003e\\n\u003c/span\u003ehiya\u003cspan class=\"pl-cce\"\u003e\\n\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003erewrite_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-rewrite_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: rewrite_by_lua_block\" href=\"#rewrite_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003erewrite_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eActs as a rewrite phase handler and executes Lua code string specified in \u003ccode\u003e{ lua-script }\u003c/code\u003e for every request.\nThe Lua code may make \u003ca href=\"#nginx-api-for-lua\"\u003eAPI calls\u003c/a\u003e and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this handler always runs \u003cem\u003eafter\u003c/em\u003e the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e. So the following will work as expected:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     set $a 12; # create and initialize $a\n     set $b \u0026quot;\u0026quot;; # create and initialize $b\n     rewrite_by_lua_block {\n         ngx.var.b = tonumber(ngx.var.a) + 1\n     }\n     echo \u0026quot;res = $b\u0026quot;;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e12\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.var.b = tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e + 1\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     echo \u003cspan class=\"pl-s\"\u003e\"res = $b\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ebecause \u003ccode\u003eset $a 12\u003c/code\u003e and \u003ccode\u003eset $b \"\"\u003c/code\u003e run \u003cem\u003ebefore\u003c/em\u003e \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOn the other hand, the following will not work as expected:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ?  location /foo {\n ?      set $a 12; # create and initialize $a\n ?      set $b ''; # create and initialize $b\n ?      rewrite_by_lua_block {\n ?          ngx.var.b = tonumber(ngx.var.a) + 1\n ?      }\n ?      if ($b = '13') {\n ?         rewrite ^ /bar redirect;\n ?         break;\n ?      }\n ?\n ?      echo \u0026quot;res = $b\u0026quot;;\n ?  }\"\u003e\u003cpre\u003e ?  \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n ?      \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e12\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e\n ?      \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e\n ?      rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n ?          ngx.var.b = tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e + 1\n ?      \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n ?      \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e = \u003cspan class=\"pl-s\"\u003e'13'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n ?         \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /bar redirect\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n ?         \u003cspan class=\"pl-c1\"\u003ebreak\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n ?      \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n ?\n ?      echo \u003cspan class=\"pl-s\"\u003e\"res = $b\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n ?  \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ebecause \u003ccode\u003eif\u003c/code\u003e runs \u003cem\u003ebefore\u003c/em\u003e \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e even if it is placed after \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e in the config.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe right way of doing this is as follows:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     set $a 12; # create and initialize $a\n     set $b ''; # create and initialize $b\n     rewrite_by_lua_block {\n         ngx.var.b = tonumber(ngx.var.a) + 1\n         if tonumber(ngx.var.b) == 13 then\n             return ngx.redirect(\u0026quot;/bar\u0026quot;)\n         end\n     }\n\n     echo \u0026quot;res = $b\u0026quot;;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e12\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # create and initialize \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.var.b = tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.a\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e + 1\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.b\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e == \u003cspan class=\"pl-c1\"\u003e13\u003c/span\u003e then\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e ngx.redirect\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/bar\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     echo \u003cspan class=\"pl-s\"\u003e\"res = $b\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that the \u003ca href=\"http://www.grid.net.ru/nginx/eval.en.html\" rel=\"nofollow\"\u003engx_eval\u003c/a\u003e module can be approximated by using \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     eval $res {\n         proxy_pass http://foo.com/check-spam;\n     }\n\n     if ($res = 'spam') {\n         rewrite ^ /terms-of-use.html redirect;\n     }\n\n     fastcgi_pass ...;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     eval \u003cspan class=\"pl-v\"\u003e$res\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://foo.com/check-spam\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-v\"\u003e$res\u003c/span\u003e = \u003cspan class=\"pl-s\"\u003e'spam'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /terms-of-\u003cspan class=\"pl-c1\"\u003euse\u003c/span\u003e.html redirect\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003efastcgi_pass\u003c/span\u003e ...\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ecan be implemented in ngx_lua as:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location = /check-spam {\n     internal;\n     proxy_pass http://foo.com/check-spam;\n }\n\n location / {\n     rewrite_by_lua_block {\n         local res = ngx.location.capture(\u0026quot;/check-spam\u0026quot;)\n         if res.body == \u0026quot;spam\u0026quot; then\n             return ngx.redirect(\u0026quot;/terms-of-use.html\u0026quot;)\n         end\n     }\n\n     fastcgi_pass ...;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /check-spam \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003einternal\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://foo.com/check-spam\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/check-spam\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e res.body == \u003cspan class=\"pl-s\"\u003e\"spam\"\u003c/span\u003e then\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e ngx.redirect\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/terms-of-use.html\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003efastcgi_pass\u003c/span\u003e ...\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eJust as any other rewrite phase handlers, \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e also runs in subrequests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that when calling \u003ccode\u003engx.exit(ngx.OK)\u003c/code\u003e within a \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e handler, call \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e with status \u0026gt;= 200 (\u003ccode\u003engx.HTTP_OK\u003c/code\u003e) and status \u0026lt; 300 (\u003ccode\u003engx.HTTP_SPECIAL_RESPONSE\u003c/code\u003e) for successful quits and \u003ccode\u003engx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)\u003c/code\u003e (or its friends) for failures.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e's \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite\" rel=\"nofollow\"\u003erewrite\u003c/a\u003e directive is used to change the URI and initiate location re-lookups (internal redirections), then any \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e or \u003ca href=\"#rewrite_by_lua_file_block\"\u003erewrite_by_lua_file_block\u003c/a\u003e code sequences within the current location will not be executed. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     rewrite ^ /bar;\n     rewrite_by_lua_block {\n         ngx.exit(503)\n     }\n }\n location /bar {\n     ...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /bar\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e503\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /bar \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ...\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere the Lua code \u003ccode\u003engx.exit(503)\u003c/code\u003e will never run. This will be the case if \u003ccode\u003erewrite ^ /bar last\u003c/code\u003e is used as this will similarly initiate an internal redirection. If the \u003ccode\u003ebreak\u003c/code\u003e modifier is used instead, there will be no internal redirection and the \u003ccode\u003erewrite_by_lua_block\u003c/code\u003e code will be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003erewrite_by_lua_block\u003c/code\u003e code will always run at the end of the \u003ccode\u003erewrite\u003c/code\u003e request-processing phase unless \u003ca href=\"#rewrite_by_lua_no_postpone\"\u003erewrite_by_lua_no_postpone\u003c/a\u003e is turned on.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003erewrite_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-rewrite_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: rewrite_by_lua_file\" href=\"#rewrite_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003erewrite_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003erewrite tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#rewrite_by_lua_block\"\u003erewrite_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables can be used in the \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e string to provide flexibility. This however carries some risks and is not ordinarily recommended.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached and the Nginx config must be reloaded each time the Lua source file is modified. The Lua code cache can be temporarily disabled during development by switching \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e \u003ccode\u003eoff\u003c/code\u003e in \u003ccode\u003enginx.conf\u003c/code\u003e to avoid reloading Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003erewrite_by_lua_file\u003c/code\u003e code will always run at the end of the \u003ccode\u003erewrite\u003c/code\u003e request-processing phase unless \u003ca href=\"#rewrite_by_lua_no_postpone\"\u003erewrite_by_lua_no_postpone\u003c/a\u003e is turned on.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables are supported in the file path for dynamic dispatch just as in \u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eaccess_by_lua\u003c/h2\u003e\u003ca id=\"user-content-access_by_lua\" class=\"anchor\" aria-label=\"Permalink: access_by_lua\" href=\"#access_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eaccess_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eaccess tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n access_by_lua '\n     do_something(\u0026quot;hello, world!\\nhiya\\n\u0026quot;)\n ';\"\u003e\u003cpre\u003e access_by_lua '\n     do_something\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, world!\u003cspan class=\"pl-cce\"\u003e\\n\u003c/span\u003ehiya\u003cspan class=\"pl-cce\"\u003e\\n\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eaccess_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-access_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: access_by_lua_block\" href=\"#access_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eaccess_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eaccess tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eActs as an access phase handler and executes Lua code string specified in \u003ccode\u003e{ \u0026lt;lua-script }\u003c/code\u003e for every request.\nThe Lua code may make \u003ca href=\"#nginx-api-for-lua\"\u003eAPI calls\u003c/a\u003e and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this handler always runs \u003cem\u003eafter\u003c/em\u003e the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_access_module.html\" rel=\"nofollow\"\u003engx_http_access_module\u003c/a\u003e. So the following will work as expected:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     deny    192.168.1.1;\n     allow   192.168.1.0/24;\n     allow   10.1.1.0/16;\n     deny    all;\n\n     access_by_lua_block {\n         local res = ngx.location.capture(\u0026quot;/mysql\u0026quot;, { ... })\n         ...\n     }\n\n     # proxy_pass/fastcgi_pass/...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003edeny\u003c/span\u003e    \u003cspan class=\"pl-c1\"\u003e192.168.1.1\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eallow\u003c/span\u003e   \u003cspan class=\"pl-c1\"\u003e192.168.1.0\u003c/span\u003e/\u003cspan class=\"pl-c1\"\u003e24\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eallow\u003c/span\u003e   \u003cspan class=\"pl-c1\"\u003e10.1.1.0\u003c/span\u003e/\u003cspan class=\"pl-c1\"\u003e16\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003edeny\u003c/span\u003e    all\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     access_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/mysql\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e ... \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ...\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e     # proxy_pass/fastcgi_pass/...\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, if a client IP address is in the blacklist, it will be denied before the MySQL query for more complex authentication is executed by \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the \u003ca href=\"http://mdounin.ru/hg/ngx_http_auth_request_module/\" rel=\"nofollow\"\u003engx_auth_request\u003c/a\u003e module can be approximated by using \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     auth_request /auth;\n\n     # proxy_pass/fastcgi_pass/postgres_pass/...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eauth_request\u003c/span\u003e /auth\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e     # proxy_pass/fastcgi_pass/postgres_pass/...\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ecan be implemented in ngx_lua as:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     access_by_lua_block {\n         local res = ngx.location.capture(\u0026quot;/auth\u0026quot;)\n\n         if res.status == ngx.HTTP_OK then\n             return\n         end\n\n         if res.status == ngx.HTTP_FORBIDDEN then\n             ngx.exit(res.status)\n         end\n\n         ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)\n     }\n\n     # proxy_pass/fastcgi_pass/postgres_pass/...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     access_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/auth\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e res.\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e == ngx.HTTP_OK then\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e res.\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e == ngx.HTTP_FORBIDDEN then\n             ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         end\n\n         ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.HTTP_INTERNAL_SERVER_ERROR\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-c\"\u003e     # proxy_pass/fastcgi_pass/postgres_pass/...\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAs with other access phase handlers, \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e will \u003cem\u003enot\u003c/em\u003e run in subrequests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that when calling \u003ccode\u003engx.exit(ngx.OK)\u003c/code\u003e within a \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e handler, call \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e with status \u0026gt;= 200 (\u003ccode\u003engx.HTTP_OK\u003c/code\u003e) and status \u0026lt; 300 (\u003ccode\u003engx.HTTP_SPECIAL_RESPONSE\u003c/code\u003e) for successful quits and \u003ccode\u003engx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)\u003c/code\u003e (or its friends) for failures.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eStarting from the \u003ccode\u003ev0.9.20\u003c/code\u003e release, you can use the \u003ca href=\"#access_by_lua_no_postpone\"\u003eaccess_by_lua_no_postpone\u003c/a\u003e\ndirective to control when to run this handler inside the \"access\" request-processing phase\nof Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eaccess_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-access_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: access_by_lua_file\" href=\"#access_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eaccess_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eaccess tail\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#access_by_lua_block\"\u003eaccess_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables can be used in the \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e string to provide flexibility. This however carries some risks and is not ordinarily recommended.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached\nand the Nginx config must be reloaded each time the Lua source file is modified.\nThe Lua code cache can be temporarily disabled during development by switching \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e \u003ccode\u003eoff\u003c/code\u003e in \u003ccode\u003enginx.conf\u003c/code\u003e to avoid repeatedly reloading Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx variables are supported in the file path for dynamic dispatch just as in \u003ca href=\"#content_by_lua_file\"\u003econtent_by_lua_file\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eheader_filter_by_lua\u003c/h2\u003e\u003ca id=\"user-content-header_filter_by_lua\" class=\"anchor\" aria-label=\"Permalink: header_filter_by_lua\" href=\"#header_filter_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eheader_filter_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-header-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#header_filter_by_lua_block\"\u003eheader_filter_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#header_filter_by_lua_block\"\u003eheader_filter_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n header_filter_by_lua '\n     ngx.header[\u0026quot;content-length\u0026quot;] = nil\n ';\"\u003e\u003cpre\u003e header_filter_by_lua '\n     ngx.header[\u003cspan class=\"pl-s\"\u003e\"content-length\"\u003c/span\u003e] = nil\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.2.1rc20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eheader_filter_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-header_filter_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: header_filter_by_lua_block\" href=\"#header_filter_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eheader_filter_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-header-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUses Lua code specified in \u003ccode\u003e{ lua-script }\u003c/code\u003e to define an output header filter.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the following API functions are currently disabled within this context:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eOutput API functions (e.g., \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e and \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eControl API functions (e.g., \u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e and \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eSubrequest API functions (e.g., \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eCosocket API functions (e.g., \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eHere is an example of overriding a response header (or adding one if absent) in our Lua header filter:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     proxy_pass http://mybackend;\n     header_filter_by_lua_block {\n         ngx.header.Foo = \u0026quot;blah\u0026quot;\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://mybackend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     header_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.header.Foo = \u003cspan class=\"pl-s\"\u003e\"blah\"\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eheader_filter_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-header_filter_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: header_filter_by_lua_file\" href=\"#header_filter_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eheader_filter_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-header-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#header_filter_by_lua_block\"\u003eheader_filter_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.2.1rc20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebody_filter_by_lua\u003c/h2\u003e\u003ca id=\"user-content-body_filter_by_lua\" class=\"anchor\" aria-label=\"Permalink: body_filter_by_lua\" href=\"#body_filter_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebody_filter_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-body-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#body_filter_by_lua_block\"\u003ebody_filter_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#body_filter_by_lua_block\"\u003ebody_filter_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n body_filter_by_lua '\n     local data, eof = ngx.arg[1], ngx.arg[2]\n ';\"\u003e\u003cpre\u003e body_filter_by_lua '\n     local data, eof = ngx.arg[1], ngx.arg[2]\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebody_filter_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-body_filter_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: body_filter_by_lua_block\" href=\"#body_filter_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebody_filter_by_lua_block { lua-script-str }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-body-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUses Lua code specified in \u003ccode\u003e{ lua-script }\u003c/code\u003e to define an output body filter.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe input data chunk is passed via \u003ca href=\"#ngxarg\"\u003engx.arg\u003c/a\u003e[1] (as a Lua string value) and the \"eof\" flag indicating the end of the response body data stream is passed via \u003ca href=\"#ngxarg\"\u003engx.arg\u003c/a\u003e[2] (as a Lua boolean value).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBehind the scene, the \"eof\" flag is just the \u003ccode\u003elast_buf\u003c/code\u003e (for main requests) or \u003ccode\u003elast_in_chain\u003c/code\u003e (for subrequests) flag of the Nginx chain link buffers. (Before the \u003ccode\u003ev0.7.14\u003c/code\u003e release, the \"eof\" flag does not work at all in subrequests.)\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe output data stream can be aborted immediately by running the following Lua statement:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.ERROR\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERROR\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis will truncate the response body and usually result in incomplete and also invalid responses.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua code can pass its own modified version of the input data chunk to the downstream Nginx output body filters by overriding \u003ca href=\"#ngxarg\"\u003engx.arg\u003c/a\u003e[1] with a Lua string or a Lua table of strings. For example, to transform all the lowercase letters in the response body, we can just write:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     proxy_pass http://mybackend;\n     body_filter_by_lua_block {\n         ngx.arg[1] = string.upper(ngx.arg[1])\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://mybackend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     body_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.arg[1] = string.upper\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.arg[1]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhen setting \u003ccode\u003enil\u003c/code\u003e or an empty Lua string value to \u003ccode\u003engx.arg[1]\u003c/code\u003e, no data chunk will be passed to the downstream Nginx output filters at all.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLikewise, new \"eof\" flag can also be specified by setting a boolean value to \u003ca href=\"#ngxarg\"\u003engx.arg\u003c/a\u003e[2]. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /t {\n     echo hello world;\n     echo hiya globe;\n\n     body_filter_by_lua_block {\n         local chunk = ngx.arg[1]\n         if string.match(chunk, \u0026quot;hello\u0026quot;) then\n             ngx.arg[2] = true  -- new eof\n             return\n         end\n\n         -- just throw away any remaining chunk data\n         ngx.arg[1] = nil\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /t \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     echo hello world\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     echo hiya globe\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     body_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local chunk = ngx.arg[1]\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e string.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003echunk, \u003cspan class=\"pl-s\"\u003e\"hello\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e then\n             ngx.arg[2] = true  -- new eof\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n\n         -- just throw away any remaining chunk data\n         ngx.arg[1] = nil\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eGET /t\u003c/code\u003e will just return the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"hello world\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ehello world\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, when the body filter sees a chunk containing the word \"hello\", then it will set the \"eof\" flag to true immediately, resulting in truncated but still valid responses.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the Lua code may change the length of the response body, then it is required to always clear out the \u003ccode\u003eContent-Length\u003c/code\u003e response header (if any) in a header filter to enforce streaming output, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     # fastcgi_pass/proxy_pass/...\n\n     header_filter_by_lua_block {\n         ngx.header.content_length = nil\n     }\n     body_filter_by_lua_block {\n         ngx.arg[1] = string.len(ngx.arg[1]) .. \u0026quot;\\n\u0026quot;\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n\u003cspan class=\"pl-c\"\u003e     # fastcgi_pass/proxy_pass/...\u003c/span\u003e\n\n     header_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.header.content_length = nil\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     body_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.arg[1] = string.len\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.arg[1]\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e .. \u003cspan class=\"pl-s\"\u003e\"\u003cspan class=\"pl-cce\"\u003e\\n\u003c/span\u003e\"\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that the following API functions are currently disabled within this context due to the limitations in Nginx output filter's current implementation:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eOutput API functions (e.g., \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e and \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eControl API functions (e.g., \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e and \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eSubrequest API functions (e.g., \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eCosocket API functions (e.g., \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eNginx output filters may be called multiple times for a single request because response body may be delivered in chunks. Thus, the Lua code specified by in this directive may also run multiple times in the lifetime of a single HTTP request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebody_filter_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-body_filter_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: body_filter_by_lua_file\" href=\"#body_filter_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebody_filter_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eoutput-body-filter\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#body_filter_by_lua_block\"\u003ebody_filter_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elog_by_lua\u003c/h2\u003e\u003ca id=\"user-content-log_by_lua\" class=\"anchor\" aria-label=\"Permalink: log_by_lua\" href=\"#log_by_lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elog_by_lua \u0026lt;lua-script-str\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003elog\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Use of this directive is \u003cem\u003ediscouraged\u003c/em\u003e following the \u003ccode\u003ev0.9.17\u003c/code\u003e release. Use the \u003ca href=\"#log_by_lua_block\"\u003elog_by_lua_block\u003c/a\u003e directive instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#log_by_lua_block\"\u003elog_by_lua_block\u003c/a\u003e directive, but accepts the Lua source directly in an Nginx string literal (which requires\nspecial character escaping).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n log_by_lua '\n     print(\u0026quot;I need no extra escaping here, for example: \\r\\nblah\u0026quot;)\n ';\"\u003e\u003cpre\u003e log_by_lua '\n     print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"I need no extra escaping here, for example: \u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003eblah\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n '\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc31\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elog_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-log_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: log_by_lua_block\" href=\"#log_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elog_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003elog\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRuns the Lua source code inlined as the \u003ccode\u003e{ lua-script }\u003c/code\u003e at the \u003ccode\u003elog\u003c/code\u003e request processing phase. This does not replace the current access logs, but runs before.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the following API functions are currently disabled within this context:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eOutput API functions (e.g., \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e and \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eControl API functions (e.g., \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eSubrequest API functions (e.g., \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eCosocket API functions (e.g., \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eHere is an example of gathering average data for \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_upstream_module.html#var_upstream_response_time\" rel=\"nofollow\"\u003e$upstream_response_time\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_shared_dict log_dict 5M;\n\n server {\n     location / {\n         proxy_pass http://mybackend;\n\n         log_by_lua_block {\n             local log_dict = ngx.shared.log_dict\n             local upstream_time = tonumber(ngx.var.upstream_response_time)\n\n             local sum = log_dict:get(\u0026quot;upstream_time-sum\u0026quot;) or 0\n             sum = sum + upstream_time\n             log_dict:set(\u0026quot;upstream_time-sum\u0026quot;, sum)\n\n             local newval, err = log_dict:incr(\u0026quot;upstream_time-nb\u0026quot;, 1)\n             if not newval and err == \u0026quot;not found\u0026quot; then\n                 log_dict:add(\u0026quot;upstream_time-nb\u0026quot;, 0)\n                 log_dict:incr(\u0026quot;upstream_time-nb\u0026quot;, 1)\n             end\n         }\n     }\n\n     location = /status {\n         content_by_lua_block {\n             local log_dict = ngx.shared.log_dict\n             local sum = log_dict:get(\u0026quot;upstream_time-sum\u0026quot;)\n             local nb = log_dict:get(\u0026quot;upstream_time-nb\u0026quot;)\n\n             if nb and sum then\n                 ngx.say(\u0026quot;average upstream response time: \u0026quot;, sum / nb,\n                         \u0026quot; (\u0026quot;, nb, \u0026quot; reqs)\u0026quot;)\n             else\n                 ngx.say(\u0026quot;no data yet\u0026quot;)\n             end\n         }\n     }\n }\"\u003e\u003cpre\u003e lua_shared_dict log_dict \u003cspan class=\"pl-c1\"\u003e5M\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://mybackend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n         log_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local log_dict = ngx.shared.log_dict\n             local upstream_time = tonumber\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.upstream_response_time\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n             local sum = log_dict:get\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-sum\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e or 0\n             sum = sum + upstream_time\n             log_dict:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-sum\"\u003c/span\u003e, sum\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n             local newval, err = log_dict:incr\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-nb\"\u003c/span\u003e, 1\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not newval and err == \u003cspan class=\"pl-s\"\u003e\"not found\"\u003c/span\u003e then\n                 log_dict:add\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-nb\"\u003c/span\u003e, 0\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 log_dict:incr\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-nb\"\u003c/span\u003e, 1\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local log_dict = ngx.shared.log_dict\n             local sum = log_dict:get\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-sum\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             local nb = log_dict:get\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"upstream_time-nb\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e nb and sum then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"average upstream response time: \"\u003c/span\u003e, sum / nb,\n                         \u003cspan class=\"pl-s\"\u003e\" (\"\u003c/span\u003e, nb, \u003cspan class=\"pl-s\"\u003e\" reqs)\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             else\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"no data yet\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elog_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-log_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: log_by_lua_file\" href=\"#log_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elog_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003elog\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#log_by_lua_block\"\u003elog_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc31\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebalancer_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-balancer_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: balancer_by_lua_block\" href=\"#balancer_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebalancer_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eupstream\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003econtent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs Lua code as an upstream balancer for any upstream entities defined\nby the \u003ccode\u003eupstream {}\u003c/code\u003e configuration block.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n upstream foo {\n     server 127.0.0.1;\n     balancer_by_lua_block {\n         -- use Lua to do something interesting here\n         -- as a dynamic balancer\n     }\n }\n\n server {\n     location / {\n         proxy_pass http://foo;\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eupstream\u003c/span\u003e foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e127.0.0.1\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     balancer_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         -- \u003cspan class=\"pl-c1\"\u003euse\u003c/span\u003e Lua to do something interesting here\n         -- as a dynamic balancer\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://foo\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe resulting Lua load balancer can work with any existing Nginx upstream modules\nlike \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_proxy\u003c/a\u003e and\n\u003ca href=\"https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html\" rel=\"nofollow\"\u003engx_fastcgi\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso, the Lua load balancer can work with the standard upstream connection pool mechanism,\ni.e., the standard \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive\" rel=\"nofollow\"\u003ekeepalive\u003c/a\u003e directive.\nJust ensure that the \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive\" rel=\"nofollow\"\u003ekeepalive\u003c/a\u003e directive\nis used \u003cem\u003eafter\u003c/em\u003e this \u003ccode\u003ebalancer_by_lua_block\u003c/code\u003e directive in a single \u003ccode\u003eupstream {}\u003c/code\u003e configuration block.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua load balancer can totally ignore the list of servers defined in the \u003ccode\u003eupstream {}\u003c/code\u003e block\nand select peer from a completely dynamic server list (even changing per request) via the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md\"\u003engx.balancer\u003c/a\u003e module\nfrom the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua code handler registered by this directive might get called more than once in a single\ndownstream request when the Nginx upstream mechanism retries the request on conditions\nspecified by directives like the \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream\" rel=\"nofollow\"\u003eproxy_next_upstream\u003c/a\u003e\ndirective.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua code execution context does not support yielding, so Lua APIs that may yield\n(like cosockets and \"light threads\") are disabled in this context. One can usually work\naround this limitation by doing such operations in an earlier phase handler (like\n\u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e) and passing along the result into this context\nvia the \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebalancer_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-balancer_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: balancer_by_lua_file\" href=\"#balancer_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebalancer_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eupstream\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003econtent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#balancer_by_lua_block\"\u003ebalancer_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ebalancer_keepalive\u003c/h2\u003e\u003ca id=\"user-content-balancer_keepalive\" class=\"anchor\" aria-label=\"Permalink: balancer_keepalive\" href=\"#balancer_keepalive\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebalancer_keepalive \u0026lt;total-connections\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eupstream\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eloading-config\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003etotal-connections\u003c/code\u003e parameter sets the maximum number of idle\nkeepalive connections to upstream servers that are preserved in the cache of\neach worker process. When this number is exceeded, the least recently used\nconnections are closed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt should be particularly noted that the keepalive directive does not limit the\ntotal number of connections to upstream servers that an nginx worker process\ncan open. The connections parameter should be set to a number small enough to\nlet upstream servers process new incoming connections as well.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.21\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_need_request_body\u003c/h2\u003e\u003ca id=\"user-content-lua_need_request_body\" class=\"anchor\" aria-label=\"Permalink: lua_need_request_body\" href=\"#lua_need_request_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_need_request_body \u0026lt;on|off\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eoff\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003edepends on usage\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDetermines whether to force the request body data to be read before running rewrite/access/content_by_lua* or not. The Nginx core does not read the client request body by default and if request body data is required, then this directive should be turned \u003ccode\u003eon\u003c/code\u003e or the \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e function should be called within the Lua code.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo read the request body data within the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_body\" rel=\"nofollow\"\u003e$request_body\u003c/a\u003e variable,\n\u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size\" rel=\"nofollow\"\u003eclient_body_buffer_size\u003c/a\u003e must have the same value as \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size\" rel=\"nofollow\"\u003eclient_max_body_size\u003c/a\u003e. Because when the content length exceeds \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size\" rel=\"nofollow\"\u003eclient_body_buffer_size\u003c/a\u003e but less than \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size\" rel=\"nofollow\"\u003eclient_max_body_size\u003c/a\u003e, Nginx will buffer the data into a temporary file on the disk, which will lead to empty value in the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_body\" rel=\"nofollow\"\u003e$request_body\u003c/a\u003e variable.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the current location includes \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e directives,\nthen the request body will be read just before the \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e code is run (and also at the\n\u003ccode\u003erewrite\u003c/code\u003e phase). Similarly, if only \u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e is specified,\nthe request body will not be read until the content handler's Lua code is\nabout to run (i.e., the request body will be read during the content phase).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is recommended however, to use the \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e and \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e functions for finer control over the request body reading process instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis also applies to \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_client_hello_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-ssl_client_hello_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: ssl_client_hello_by_lua_block\" href=\"#ssl_client_hello_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_client_hello_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-client-hello-message-was-processed\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs user Lua code when Nginx is about to post-process the SSL client hello message for the downstream\nSSL (https) connections.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is particularly useful for dynamically setting the SSL protocols according to the SNI.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is also useful to do some custom operations according to the per-connection information in the client hello message.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example, one can parse custom client hello extension and do the corresponding handling in pure Lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua handler will always run whether the SSL session is resumed (via SSL session IDs or TLS session tickets) or not.\nWhile the \u003ccode\u003essl_certificate_by_lua*\u003c/code\u003e Lua handler will only runs when initiating a full SSL handshake.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md\"\u003engx.ssl.clienthello\u003c/a\u003e Lua modules\nprovided by the \u003ca href=\"https://github.com/openresty/lua-resty-core/#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary are particularly useful in this context.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this handler runs in extremely early stage of SSL handshake, before the SSL client hello extensions are parsed.\nSo you can not use some Lua API like \u003ccode\u003essl.server_name()\u003c/code\u003e which is dependent on the later stage's processing.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso note that only the directive in default server is valid for several virtual servers with the same IP address and port.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBelow is a trivial example using the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md\"\u003engx.ssl.clienthello\u003c/a\u003e module\nat the same time:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server {\n     listen 443 ssl;\n     server_name   test.com;\n     ssl_certificate /path/to/cert.crt;\n     ssl_certificate_key /path/to/key.key;\n     ssl_client_hello_by_lua_block {\n         local ssl_clt = require \u0026quot;ngx.ssl.clienthello\u0026quot;\n         local host, err = ssl_clt.get_client_hello_server_name()\n         if host == \u0026quot;test.com\u0026quot; then\n             ssl_clt.set_protocols({\u0026quot;TLSv1\u0026quot;, \u0026quot;TLSv1.1\u0026quot;})\n         elseif host == \u0026quot;test2.com\u0026quot; then\n             ssl_clt.set_protocols({\u0026quot;TLSv1.2\u0026quot;, \u0026quot;TLSv1.3\u0026quot;})\n         elseif not host then\n             ngx.log(ngx.ERR, \u0026quot;failed to get the SNI name: \u0026quot;, err)\n             ngx.exit(ngx.ERROR)\n         else\n             ngx.log(ngx.ERR, \u0026quot;unknown SNI name: \u0026quot;, host)\n             ngx.exit(ngx.ERROR)\n         end\n     }\n     ...\n }\n server {\n     listen 443 ssl;\n     server_name   test2.com;\n     ssl_certificate /path/to/cert.crt;\n     ssl_certificate_key /path/to/key.key;\n     ...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elisten\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e443\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003essl\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver_name\u003c/span\u003e   test.com\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate\u003c/span\u003e /path/to/cert.crt\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate_key\u003c/span\u003e /path/to/key.key\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     ssl_client_hello_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local ssl_clt = require \u003cspan class=\"pl-s\"\u003e\"ngx.ssl.clienthello\"\u003c/span\u003e\n         local host, err = ssl_clt.get_client_hello_server_name\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e host == \u003cspan class=\"pl-s\"\u003e\"test.com\"\u003c/span\u003e then\n             ssl_clt.set_protocols\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"TLSv1\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"TLSv1.1\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         elseif host == \u003cspan class=\"pl-s\"\u003e\"test2.com\"\u003c/span\u003e then\n             ssl_clt.set_protocols\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"TLSv1.2\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"TLSv1.3\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         elseif not host then\n             ngx.log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ERR, \u003cspan class=\"pl-s\"\u003e\"failed to get the SNI name: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ERROR\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         else\n             ngx.log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ERR, \u003cspan class=\"pl-s\"\u003e\"unknown SNI name: \"\u003c/span\u003e, host\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             ngx.exit\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ERROR\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     ...\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elisten\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e443\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003essl\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver_name\u003c/span\u003e   test2.com\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate\u003c/span\u003e /path/to/cert.crt\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate_key\u003c/span\u003e /path/to/key.key\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     ...\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSee more information in the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md\"\u003engx.ssl.clienthello\u003c/a\u003e\nLua modules' official documentation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the\n\u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e call with an error code like \u003ccode\u003engx.ERROR\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua code execution context \u003cem\u003edoes\u003c/em\u003e support yielding, so Lua APIs that may yield\n(like cosockets, sleeping, and \"light threads\")\nare enabled in this context\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote, you need to configure the \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate\" rel=\"nofollow\"\u003essl_certificate\u003c/a\u003e\nand \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_key\" rel=\"nofollow\"\u003essl_certificate_key\u003c/a\u003e\nto avoid the following error while starting NGINX:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"nginx: [emerg] no ssl configured for the server\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003enginx: [emerg] no ssl configured for the server\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires OpenSSL 1.1.1 or greater.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are using the \u003ca href=\"https://openresty.org/en/linux-packages.html\" rel=\"nofollow\"\u003eofficial pre-built\npackages\u003c/a\u003e for\n\u003ca href=\"https://openresty.org/\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e 1.21.4.1 or later, then everything should\nwork out of the box.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are not using the Nginx core shipped with\n\u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e 1.21.4.1 or later, you will need to apply\npatches to the standard Nginx core:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://openresty.org/en/nginx-ssl-patches.html\" rel=\"nofollow\"\u003ehttps://openresty.org/en/nginx-ssl-patches.html\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote for HTTP/3 (QUIC) users\u003c/strong\u003e: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: \u003ca href=\"https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch\"\u003enginx-1.27.1-quic_ssl_lua_yield.patch\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.21\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_client_hello_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-ssl_client_hello_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: ssl_client_hello_by_lua_file\" href=\"#ssl_client_hello_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_client_hello_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-client-hello-message-was-processed\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#ssl_client_hello_by_lua_block\"\u003essl_client_hello_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote for HTTP/3 (QUIC) users\u003c/strong\u003e: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: \u003ca href=\"https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch\"\u003enginx-1.27.1-quic_ssl_lua_yield.patch\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.21\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_certificate_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-ssl_certificate_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: ssl_certificate_by_lua_block\" href=\"#ssl_certificate_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_certificate_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eserver\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-before-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs user Lua code when Nginx is about to start the SSL handshake for the downstream\nSSL (https) connections.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is particularly useful for setting the SSL certificate chain and the corresponding private key on a per-request\nbasis. It is also useful to load such handshake configurations nonblockingly from the remote (for example,\nwith the \u003ca href=\"#ngxsockettcp\"\u003ecosocket\u003c/a\u003e API). And one can also do per-request OCSP stapling handling in pure\nLua here as well.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAnother typical use case is to do SSL handshake traffic control nonblockingly in this context,\nwith the help of the \u003ca href=\"https://github.com/openresty/lua-resty-limit-traffic\"\u003elua-resty-limit-traffic#readme\u003c/a\u003e\nlibrary, for example.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOne can also do interesting things with the SSL handshake requests from the client side, like\nrejecting old SSL clients using the SSLv3 protocol or even below selectively.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md\"\u003engx.ssl\u003c/a\u003e\nand \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md\"\u003engx.ocsp\u003c/a\u003e Lua modules\nprovided by the \u003ca href=\"https://github.com/openresty/lua-resty-core/#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary are particularly useful in this context. You can use the Lua API offered by these two Lua modules\nto manipulate the SSL certificate chain and private key for the current SSL connection\nbeing initiated.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua handler does not run at all, however, when Nginx/OpenSSL successfully resumes\nthe SSL session via SSL session IDs or TLS session tickets for the current SSL connection. In\nother words, this Lua handler only runs when Nginx has to initiate a full SSL handshake.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBelow is a trivial example using the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md\"\u003engx.ssl\u003c/a\u003e module\nat the same time:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server {\n     listen 443 ssl;\n     server_name   test.com;\n\n     ssl_certificate_by_lua_block {\n         print(\u0026quot;About to initiate a new SSL handshake!\u0026quot;)\n     }\n\n     location / {\n         root html;\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elisten\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e443\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003essl\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver_name\u003c/span\u003e   test.com\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     ssl_certificate_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"About to initiate a new SSL handshake!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eroot\u003c/span\u003e html\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSee more complicated examples in the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md\"\u003engx.ssl\u003c/a\u003e\nand \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md\"\u003engx.ocsp\u003c/a\u003e\nLua modules' official documentation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the\n\u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e call with an error code like \u003ccode\u003engx.ERROR\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua code execution context \u003cem\u003edoes\u003c/em\u003e support yielding, so Lua APIs that may yield\n(like cosockets, sleeping, and \"light threads\")\nare enabled in this context.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote, however, you still need to configure the \u003ca href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate\" rel=\"nofollow\"\u003essl_certificate\u003c/a\u003e and\n\u003ca href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_key\" rel=\"nofollow\"\u003essl_certificate_key\u003c/a\u003e\ndirectives even though you will not use this static certificate and private key at all. This is\nbecause the NGINX core requires their appearance otherwise you are seeing the following error\nwhile starting NGINX:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"nginx: [emerg] no ssl configured for the server\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003enginx: [emerg] no ssl configured for the server\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires OpenSSL 1.0.2e or greater.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are using the \u003ca href=\"https://openresty.org/en/linux-packages.html\" rel=\"nofollow\"\u003eofficial pre-built\npackages\u003c/a\u003e for\n\u003ca href=\"https://openresty.org/\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e 1.9.7.2 or later, then everything should\nwork out of the box.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are not using the Nginx core shipped with\n\u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e 1.9.7.2 or later, you will need to apply\npatches to the standard Nginx core:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://openresty.org/en/nginx-ssl-patches.html\" rel=\"nofollow\"\u003ehttps://openresty.org/en/nginx-ssl-patches.html\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote for HTTP/3 (QUIC) users\u003c/strong\u003e: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: \u003ca href=\"https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch\"\u003enginx-1.27.1-quic_ssl_lua_yield.patch\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_certificate_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-ssl_certificate_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: ssl_certificate_by_lua_file\" href=\"#ssl_certificate_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_certificate_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eserver\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-before-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote for HTTP/3 (QUIC) users\u003c/strong\u003e: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: \u003ca href=\"https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch\"\u003enginx-1.27.1-quic_ssl_lua_yield.patch\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_session_fetch_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-ssl_session_fetch_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: ssl_session_fetch_by_lua_block\" href=\"#ssl_session_fetch_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_session_fetch_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-before-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs Lua code to look up and load the SSL session (if any) according to the session ID\nprovided by the current SSL handshake request for the downstream.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua API for obtaining the current session ID and loading a cached SSL session data\nis provided in the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/session.md\"\u003engx.ssl.session\u003c/a\u003e\nLua module shipped with the \u003ca href=\"https://github.com/openresty/lua-resty-core#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLua APIs that may yield, like \u003ca href=\"#ngxsleep\"\u003engx.sleep\u003c/a\u003e and \u003ca href=\"#ngxsockettcp\"\u003ecosockets\u003c/a\u003e,\nare enabled in this context.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis hook, together with the \u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua*\u003c/a\u003e hook,\ncan be used to implement distributed caching mechanisms in pure Lua (based\non the \u003ca href=\"#ngxsockettcp\"\u003ecosocket\u003c/a\u003e API, for example). If a cached SSL session is found\nand loaded into the current SSL connection context,\nSSL session resumption can then get immediately initiated and bypass the full SSL handshake process which is very expensive in terms of CPU time.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease note that TLS session tickets are very different and it is the clients' responsibility\nto cache the SSL session state when session tickets are used. SSL session resumptions based on\nTLS session tickets would happen automatically without going through this hook (nor the\n\u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua*\u003c/a\u003e hook). This hook is mainly\nfor older or less capable SSL clients that can only do SSL sessions by session IDs.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e is specified at the same time,\nthis hook usually runs before \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e.\nWhen the SSL session is found and successfully loaded for the current SSL connection,\nSSL session resumption will happen and thus bypass the \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e\nhook completely. In this case, Nginx also bypasses the \u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua*\u003c/a\u003e\nhook, for obvious reasons.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo easily test this hook locally with a modern web browser, you can temporarily put the following line\nin your https server block to disable the TLS session ticket support:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ssl_session_tickets off;\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003essl_session_tickets off;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBut do not forget to comment this line out before publishing your site to the world.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are using the \u003ca href=\"https://openresty.org/en/linux-packages.html\" rel=\"nofollow\"\u003eofficial pre-built packages\u003c/a\u003e for \u003ca href=\"https://openresty.org/\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e\n1.11.2.1 or later, then everything should work out of the box.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf you are not using one of the \u003ca href=\"https://openresty.org/en/linux-packages.html\" rel=\"nofollow\"\u003eOpenSSL\npackages\u003c/a\u003e provided by\n\u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e, you will need to apply patches to OpenSSL\nin order to use this directive:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://openresty.org/en/openssl-patches.html\" rel=\"nofollow\"\u003ehttps://openresty.org/en/openssl-patches.html\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilarly, if you are not using the Nginx core shipped with\n\u003ca href=\"https://openresty.org\" rel=\"nofollow\"\u003eOpenResty\u003c/a\u003e 1.11.2.1 or later, you will need to apply\npatches to the standard Nginx core:\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://openresty.org/en/nginx-ssl-patches.html\" rel=\"nofollow\"\u003ehttps://openresty.org/en/nginx-ssl-patches.html\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this directive can only be used in the \u003cstrong\u003ehttp context\u003c/strong\u003e starting\nwith the \u003ccode\u003ev0.10.7\u003c/code\u003e release since SSL session resumption happens\nbefore server name dispatch.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_session_fetch_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-ssl_session_fetch_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: ssl_session_fetch_by_lua_file\" href=\"#ssl_session_fetch_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_session_fetch_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-before-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#ssl_session_fetch_by_lua_block\"\u003essl_session_fetch_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or rather, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that: this directive is only allowed to used in \u003cstrong\u003ehttp context\u003c/strong\u003e from the \u003ccode\u003ev0.10.7\u003c/code\u003e release\n(because SSL session resumption happens before server name dispatch).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_session_store_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-ssl_session_store_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: ssl_session_store_by_lua_block\" href=\"#ssl_session_store_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_session_store_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs Lua code to fetch and save the SSL session (if any) according to the session ID\nprovided by the current SSL handshake request for the downstream. The saved or cached SSL\nsession data can be used for future SSL connections to resume SSL sessions without going\nthrough the full SSL handshake process (which is very expensive in terms of CPU time).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLua APIs that may yield, like \u003ca href=\"#ngxsleep\"\u003engx.sleep\u003c/a\u003e and \u003ca href=\"#ngxsockettcp\"\u003ecosockets\u003c/a\u003e,\nare \u003cem\u003edisabled\u003c/em\u003e in this context. You can still, however, use the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e API\nto create 0-delay timers to save the SSL session data asynchronously to external services (like \u003ccode\u003eredis\u003c/code\u003e or \u003ccode\u003ememcached\u003c/code\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua API for obtaining the current session ID and the associated session state data\nis provided in the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/session.md#readme\"\u003engx.ssl.session\u003c/a\u003e\nLua module shipped with the \u003ca href=\"https://github.com/openresty/lua-resty-core#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo easily test this hook locally with a modern web browser, you can temporarily put the following line\nin your https server block to disable the TLS session ticket support:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ssl_session_tickets off;\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003essl_session_tickets off;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBut do not forget to comment this line out before publishing your site to the world.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that: this directive is only allowed to used in \u003cstrong\u003ehttp context\u003c/strong\u003e from the \u003ccode\u003ev0.10.7\u003c/code\u003e release\n(because SSL session resumption happens before server name dispatch).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003essl_session_store_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-ssl_session_store_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: ssl_session_store_by_lua_file\" href=\"#ssl_session_store_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003essl_session_store_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-SSL-handshake\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or rather, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that: this directive is only allowed to used in \u003cstrong\u003ehttp context\u003c/strong\u003e from the \u003ccode\u003ev0.10.7\u003c/code\u003e release\n(because SSL session resumption happens before server name dispatch).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eproxy_ssl_verify_by_lua_block\u003c/h2\u003e\u003ca id=\"user-content-proxy_ssl_verify_by_lua_block\" class=\"anchor\" aria-label=\"Permalink: proxy_ssl_verify_by_lua_block\" href=\"#proxy_ssl_verify_by_lua_block\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eproxy_ssl_verify_by_lua_block { lua-script }\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-server-certificate-message-was-processed\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive runs user Lua code when Nginx is about to post-process the SSL server certificate message for the upstream SSL (https) connections.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is particularly useful to parse upstream server certificate and do some custom operations in pure lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md\"\u003engx.ssl.proxysslverify\u003c/a\u003e Lua modules provided by the \u003ca href=\"https://github.com/openresty/lua-resty-core/#readme\"\u003elua-resty-core\u003c/a\u003e\nlibrary are particularly useful in this context.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBelow is a trivial example using the\n\u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md\"\u003engx.ssl.proxysslverify\u003c/a\u003e module\nat the same time:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n server {\n     listen 443 ssl;\n     server_name   test.com;\n     ssl_certificate /path/to/cert.crt;\n     ssl_certificate_key /path/to/key.key;\n\n     location /t {\n         proxy_ssl_certificate /path/to/cert.crt;\n         proxy_ssl_certificate_key /path/to/key.key;\n         proxy_pass https://upstream;\n\n         proxy_ssl_verify_by_lua_block {\n             local proxy_ssl_vfy = require \u0026quot;ngx.ssl.proxysslverify\u0026quot;\n             local cert = proxy_ssl_vfy.get_verify_cert()\n\n             -- ocsp to verify cert\n             -- check crl\n             proxy_ssl_vfy.set_verify_result()\n             ...\n         }\n     }\n     ...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003elisten\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e443\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003essl\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver_name\u003c/span\u003e   test.com\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate\u003c/span\u003e /path/to/cert.crt\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003essl_certificate_key\u003c/span\u003e /path/to/key.key\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /t \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_ssl_certificate\u003c/span\u003e /path/to/cert.crt\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_ssl_certificate_key\u003c/span\u003e /path/to/key.key\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e https://\u003cspan class=\"pl-c1\"\u003eupstream\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n         proxy_ssl_verify_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             local proxy_ssl_vfy = require \u003cspan class=\"pl-s\"\u003e\"ngx.ssl.proxysslverify\"\u003c/span\u003e\n             local cert = proxy_ssl_vfy.get_verify_cert\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n\n             -- ocsp to verify cert\n             -- check crl\n             proxy_ssl_vfy.set_verify_result\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n             ...\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     ...\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSee more information in the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md\"\u003engx.ssl.proxysslverify\u003c/a\u003e\nLua modules' official documentation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the\n\u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e call with an error code like \u003ccode\u003engx.ERROR\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua code execution context \u003cem\u003edoes\u003c/em\u003e support yielding, so Lua APIs that may yield\n(like cosockets, sleeping, and \"light threads\")\nare enabled in this context\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote, \u003ccode\u003engx.ctx\u003c/code\u003e in proxy_ssl_verify_by_lua_block is belonging to upstream connection, not downstream connection, so it's different from \u003ccode\u003engx.ctx\u003c/code\u003e in contexts like ssl_certificate_by_lua etc.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive requires OpenSSL 3.0.2 or greater.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eproxy_ssl_verify_by_lua_file\u003c/h2\u003e\u003ca id=\"user-content-proxy_ssl_verify_by_lua_file\" class=\"anchor\" aria-label=\"Permalink: proxy_ssl_verify_by_lua_file\" href=\"#proxy_ssl_verify_by_lua_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eproxy_ssl_verify_by_lua_file \u0026lt;path-to-lua-script-file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003eright-after-server-certificate-message-was-processed\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEquivalent to \u003ca href=\"#proxy_ssl_verify_by_lua_block\"\u003eproxy_ssl_verify_by_lua_block\u003c/a\u003e, except that the file specified by \u003ccode\u003e\u0026lt;path-to-lua-script-file\u0026gt;\u003c/code\u003e contains the Lua code, or, as from the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release, the \u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode\u003c/a\u003e to be executed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a relative path like \u003ccode\u003efoo/bar.lua\u003c/code\u003e is given, they will be turned into the absolute path relative to the \u003ccode\u003eserver prefix\u003c/code\u003e path determined by the \u003ccode\u003e-p PATH\u003c/code\u003e command-line option while starting the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_shared_dict\u003c/h2\u003e\u003ca id=\"user-content-lua_shared_dict\" class=\"anchor\" aria-label=\"Permalink: lua_shared_dict\" href=\"#lua_shared_dict\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_shared_dict \u0026lt;name\u0026gt; \u0026lt;size\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eno\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003edepends on usage\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDeclares a shared memory zone, \u003ccode\u003e\u0026lt;name\u0026gt;\u003c/code\u003e, to serve as storage for the shm based Lua dictionary \u003ccode\u003engx.shared.\u0026lt;name\u0026gt;\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eShared memory zones are always shared by all the Nginx worker processes in the current Nginx server instance.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e\u0026lt;size\u0026gt;\u003c/code\u003e argument accepts size units such as \u003ccode\u003ek\u003c/code\u003e and \u003ccode\u003em\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n http {\n     lua_shared_dict dogs 10m;\n     ...\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     lua_shared_dict dogs \u003cspan class=\"pl-c1\"\u003e10m\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     ...\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe hard-coded minimum size is 8KB while the practical minimum size depends\non actual user data set (some people start with 12KB).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e for details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_connect_timeout\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_connect_timeout\" class=\"anchor\" aria-label=\"Permalink: lua_socket_connect_timeout\" href=\"#lua_socket_connect_timeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_connect_timeout \u0026lt;time\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_connect_timeout 60s\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive controls the default timeout value used in TCP/unix-domain socket object's \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e method and can be overridden by the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e or \u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e methods.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e\u0026lt;time\u0026gt;\u003c/code\u003e argument can be an integer, with an optional time unit, like \u003ccode\u003es\u003c/code\u003e (second), \u003ccode\u003ems\u003c/code\u003e (millisecond), \u003ccode\u003em\u003c/code\u003e (minute). The default time unit is \u003ccode\u003es\u003c/code\u003e, i.e., \"second\". The default setting is \u003ccode\u003e60s\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_send_timeout\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_send_timeout\" class=\"anchor\" aria-label=\"Permalink: lua_socket_send_timeout\" href=\"#lua_socket_send_timeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_send_timeout \u0026lt;time\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_send_timeout 60s\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls the default timeout value used in TCP/unix-domain socket object's \u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e method and can be overridden by the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e or \u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e methods.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e\u0026lt;time\u0026gt;\u003c/code\u003e argument can be an integer, with an optional time unit, like \u003ccode\u003es\u003c/code\u003e (second), \u003ccode\u003ems\u003c/code\u003e (millisecond), \u003ccode\u003em\u003c/code\u003e (minute). The default time unit is \u003ccode\u003es\u003c/code\u003e, i.e., \"second\". The default setting is \u003ccode\u003e60s\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_send_lowat\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_send_lowat\" class=\"anchor\" aria-label=\"Permalink: lua_socket_send_lowat\" href=\"#lua_socket_send_lowat\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_send_lowat \u0026lt;size\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_send_lowat 0\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls the \u003ccode\u003elowat\u003c/code\u003e (low water) value for the cosocket send buffer.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_read_timeout\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_read_timeout\" class=\"anchor\" aria-label=\"Permalink: lua_socket_read_timeout\" href=\"#lua_socket_read_timeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_read_timeout \u0026lt;time\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_read_timeout 60s\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003ephase:\u003c/strong\u003e \u003cem\u003edepends on usage\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive controls the default timeout value used in TCP/unix-domain socket object's \u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e method and iterator functions returned by the \u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e method. This setting can be overridden by the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e or \u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e methods.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e\u0026lt;time\u0026gt;\u003c/code\u003e argument can be an integer, with an optional time unit, like \u003ccode\u003es\u003c/code\u003e (second), \u003ccode\u003ems\u003c/code\u003e (millisecond), \u003ccode\u003em\u003c/code\u003e (minute). The default time unit is \u003ccode\u003es\u003c/code\u003e, i.e., \"second\". The default setting is \u003ccode\u003e60s\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_buffer_size\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_buffer_size\" class=\"anchor\" aria-label=\"Permalink: lua_socket_buffer_size\" href=\"#lua_socket_buffer_size\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_buffer_size \u0026lt;size\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_buffer_size 4k/8k\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the buffer size used by cosocket reading operations.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis buffer does not have to be that big to hold everything at the same time because cosocket supports 100% non-buffered reading and parsing. So even \u003ccode\u003e1\u003c/code\u003e byte buffer size should still work everywhere but the performance could be terrible.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_pool_size\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_pool_size\" class=\"anchor\" aria-label=\"Permalink: lua_socket_pool_size\" href=\"#lua_socket_pool_size\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_pool_size \u0026lt;size\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_pool_size 30\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the size limit (in terms of connection count) for every cosocket connection pool associated with every remote server (i.e., identified by either the host-port pair or the unix domain socket file path).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDefault to 30 connections for every pool.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the connection pool exceeds the available size limit, the least recently used (idle) connection already in the pool will be closed to make room for the current connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the cosocket connection pool is per Nginx worker process rather than per Nginx server instance, so size limit specified here also applies to every single Nginx worker process.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_keepalive_timeout\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_keepalive_timeout\" class=\"anchor\" aria-label=\"Permalink: lua_socket_keepalive_timeout\" href=\"#lua_socket_keepalive_timeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_keepalive_timeout \u0026lt;time\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_keepalive_timeout 60s\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive controls the default maximal idle time of the connections in the cosocket built-in connection pool. When this timeout reaches, idle connections will be closed and removed from the pool. This setting can be overridden by cosocket objects' \u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e\u0026lt;time\u0026gt;\u003c/code\u003e argument can be an integer, with an optional time unit, like \u003ccode\u003es\u003c/code\u003e (second), \u003ccode\u003ems\u003c/code\u003e (millisecond), \u003ccode\u003em\u003c/code\u003e (minute). The default time unit is \u003ccode\u003es\u003c/code\u003e, i.e., \"second\". The default setting is \u003ccode\u003e60s\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_socket_log_errors\u003c/h2\u003e\u003ca id=\"user-content-lua_socket_log_errors\" class=\"anchor\" aria-label=\"Permalink: lua_socket_log_errors\" href=\"#lua_socket_log_errors\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_socket_log_errors on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_socket_log_errors on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive can be used to toggle error logging when a failure occurs for the TCP or UDP cosockets. If you are already doing proper error handling and logging in your Lua code, then it is recommended to turn this directive off to prevent data flushing in your Nginx error log files (which is usually rather expensive).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.13\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_ciphers\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_ciphers\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_ciphers\" href=\"#lua_ssl_ciphers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_ciphers \u0026lt;ciphers\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_ssl_ciphers DEFAULT\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the enabled ciphers for requests to a SSL/TLS server in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method. The ciphers are specified in the format understood by the OpenSSL library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe full list can be viewed using the “openssl ciphers” command.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_crl\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_crl\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_crl\" href=\"#lua_ssl_crl\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_crl \u0026lt;file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eno\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies a file with revoked certificates (CRL) in the PEM format used to verify the certificate of the SSL/TLS server in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_protocols\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_protocols\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_protocols\" href=\"#lua_ssl_protocols\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2] [TLSv1.3]\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnables the specified protocols for requests to a SSL/TLS server in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe support for the \u003ccode\u003eTLSv1.3\u003c/code\u003e parameter requires version \u003ccode\u003ev0.10.12\u003c/code\u003e \u003cem\u003eand\u003c/em\u003e OpenSSL 1.1.1.\nFrom version v0.10.25, the default value change from \u003ccode\u003eSSLV3 TLSv1 TLSv1.1 TLSv1.2\u003c/code\u003e to \u003ccode\u003eTLSv1 TLSv1.1 TLSv1.2 TLSv1.3\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_certificate\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_certificate\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_certificate\" href=\"#lua_ssl_certificate\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_certificate \u0026lt;file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003enone\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the file path to the SSL/TLS certificate in PEM format used for the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive allows you to specify the SSL/TLS certificate that will be presented to server during the SSL/TLS handshake process.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.26\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#lua_ssl_certificate_key\"\u003elua_ssl_certificate_key\u003c/a\u003e and \u003ca href=\"#lua_ssl_verify_depth\"\u003elua_ssl_verify_depth\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_certificate_key\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_certificate_key\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_certificate_key\" href=\"#lua_ssl_certificate_key\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_certificate_key \u0026lt;file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003enone\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the file path to the private key associated with the SSL/TLS certificate used in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive allows you to specify the private key file corresponding to the SSL/TLS certificate specified by lua_ssl_certificate. The private key should be in PEM format and must match the certificate.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.26\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#lua_ssl_certificate\"\u003elua_ssl_certificate\u003c/a\u003e and \u003ca href=\"#lua_ssl_verify_depth\"\u003elua_ssl_verify_depth\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_trusted_certificate\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_trusted_certificate\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_trusted_certificate\" href=\"#lua_ssl_trusted_certificate\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_trusted_certificate \u0026lt;file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003enone\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies a file path with trusted CA certificates in the PEM format used to verify the certificate of the SSL/TLS server in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#lua_ssl_verify_depth\"\u003elua_ssl_verify_depth\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_verify_depth\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_verify_depth\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_verify_depth\" href=\"#lua_ssl_verify_depth\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_verify_depth \u0026lt;number\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_ssl_verify_depth 1\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets the verification depth in the server certificates chain.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#lua_ssl_certificate\"\u003elua_ssl_certificate\u003c/a\u003e, \u003ca href=\"#lua_ssl_certificate_key\"\u003elua_ssl_certificate_key\u003c/a\u003e and \u003ca href=\"#lua_ssl_trusted_certificate\"\u003elua_ssl_trusted_certificate\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_key_log\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_key_log\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_key_log\" href=\"#lua_ssl_key_log\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_key_log \u0026lt;file\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003enone\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnables logging of client connection SSL keys in the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method and specifies the path to the key log file. Keys are logged in the SSLKEYLOGFILE format compatible with Wireshark.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_ssl_conf_command\u003c/h2\u003e\u003ca id=\"user-content-lua_ssl_conf_command\" class=\"anchor\" aria-label=\"Permalink: lua_ssl_conf_command\" href=\"#lua_ssl_conf_command\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_ssl_conf_command \u0026lt;command\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eno\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets arbitrary OpenSSL configuration \u003ca href=\"https://www.openssl.org/docs/man1.1.1/man3/SSL_CONF_cmd.html\" rel=\"nofollow\"\u003ecommands\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe directive is supported when using OpenSSL 1.0.2 or higher and nginx 1.19.4 or higher. According to the specify command, higher OpenSSL version may be needed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSeveral \u003ccode\u003elua_ssl_conf_command\u003c/code\u003e directives can be specified on the same level:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_ssl_conf_command Options PrioritizeChaCha;\n lua_ssl_conf_command Ciphersuites TLS_CHACHA20_POLY1305_SHA256;\"\u003e\u003cpre\u003e lua_ssl_conf_command Options PrioritizeChaCha\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n lua_ssl_conf_command Ciphersuites TLS_CHACHA20_POLY1305_SHA256\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eConfiguration commands are applied after OpenResty own configuration for SSL, so they can be used to override anything set by OpenResty.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote though that configuring OpenSSL directly with \u003ccode\u003elua_ssl_conf_command\u003c/code\u003e might result in a behaviour OpenResty does not expect, and should be done with care.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.21\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_upstream_skip_openssl_default_verify\u003c/h2\u003e\u003ca id=\"user-content-lua_upstream_skip_openssl_default_verify\" class=\"anchor\" aria-label=\"Permalink: lua_upstream_skip_openssl_default_verify\" href=\"#lua_upstream_skip_openssl_default_verify\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_upstream_skip_openssl_default_verify on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_upstream_skip_openssl_default_verify off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003elocation, location-if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen using proxy_ssl_verify_by_lua directive, \u003ccode\u003elua_upstream_skip_openssl_default_verify\u003c/code\u003e controls whether to skip default openssl's verify function, that means using pure Lua code to verify upstream server certificate.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is turned \u003ccode\u003eoff\u003c/code\u003e by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_http10_buffering\u003c/h2\u003e\u003ca id=\"user-content-lua_http10_buffering\" class=\"anchor\" aria-label=\"Permalink: lua_http10_buffering\" href=\"#lua_http10_buffering\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_http10_buffering on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_http10_buffering on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location-if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnables or disables automatic response buffering for HTTP 1.0 (or older) requests. This buffering mechanism is mainly used for HTTP 1.0 keep-alive which relies on a proper \u003ccode\u003eContent-Length\u003c/code\u003e response header.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the Lua code explicitly sets a \u003ccode\u003eContent-Length\u003c/code\u003e response header before sending the headers (either explicitly via \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e or implicitly via the first \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e or \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e call), then the HTTP 1.0 response buffering will be disabled even when this directive is turned on.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo output very large response data in a streaming fashion (via the \u003ca href=\"#ngxflush\"\u003engx.flush\u003c/a\u003e call, for example), this directive MUST be turned off to minimize memory usage.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive is turned \u003ccode\u003eon\u003c/code\u003e by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc19\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003erewrite_by_lua_no_postpone\u003c/h2\u003e\u003ca id=\"user-content-rewrite_by_lua_no_postpone\" class=\"anchor\" aria-label=\"Permalink: rewrite_by_lua_no_postpone\" href=\"#rewrite_by_lua_no_postpone\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003erewrite_by_lua_no_postpone on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003erewrite_by_lua_no_postpone off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls whether or not to disable postponing \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e directives to run at the end of the \u003ccode\u003erewrite\u003c/code\u003e request-processing phase. By default, this directive is turned off and the Lua code is postponed to run at the end of the \u003ccode\u003erewrite\u003c/code\u003e phase.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc29\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eaccess_by_lua_no_postpone\u003c/h2\u003e\u003ca id=\"user-content-access_by_lua_no_postpone\" class=\"anchor\" aria-label=\"Permalink: access_by_lua_no_postpone\" href=\"#access_by_lua_no_postpone\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eaccess_by_lua_no_postpone on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003eaccess_by_lua_no_postpone off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls whether or not to disable postponing \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e directives to run at the end of the \u003ccode\u003eaccess\u003c/code\u003e request-processing phase. By default, this directive is turned off and the Lua code is postponed to run at the end of the \u003ccode\u003eaccess\u003c/code\u003e phase.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_transform_underscores_in_response_headers\u003c/h2\u003e\u003ca id=\"user-content-lua_transform_underscores_in_response_headers\" class=\"anchor\" aria-label=\"Permalink: lua_transform_underscores_in_response_headers\" href=\"#lua_transform_underscores_in_response_headers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_transform_underscores_in_response_headers on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_transform_underscores_in_response_headers on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location-if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls whether to transform underscores (\u003ccode\u003e_\u003c/code\u003e) in the response header names specified in the \u003ca href=\"#ngxheaderheader\"\u003engx.header.HEADER\u003c/a\u003e API to hyphens (\u003ccode\u003e-\u003c/code\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.5.0rc32\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_check_client_abort\u003c/h2\u003e\u003ca id=\"user-content-lua_check_client_abort\" class=\"anchor\" aria-label=\"Permalink: lua_check_client_abort\" href=\"#lua_check_client_abort\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_check_client_abort on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_check_client_abort off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp, server, location, location-if\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive controls whether to check for premature client connection abortion.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen this directive is on, the ngx_lua module will monitor the premature connection close event on the downstream connections and when there is such an event, it will call the user Lua function callback (registered by \u003ca href=\"#ngxon_abort\"\u003engx.on_abort\u003c/a\u003e) or just stop and clean up all the Lua \"light threads\" running in the current request's request handler when there is no user callback function registered.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAccording to the current implementation, however, if the client closes the connection before the Lua code finishes reading the request body data via \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e, then ngx_lua will neither stop all the running \"light threads\" nor call the user callback (if \u003ca href=\"#ngxon_abort\"\u003engx.on_abort\u003c/a\u003e has been called). Instead, the reading operation on \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e will just return the error message \"client aborted\" as the second return value (the first return value is surely \u003ccode\u003enil\u003c/code\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen TCP keepalive is disabled, it is relying on the client side to close the socket gracefully (by sending a \u003ccode\u003eFIN\u003c/code\u003e packet or something like that). For (soft) real-time web applications, it is highly recommended to configure the \u003ca href=\"http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html\" rel=\"nofollow\"\u003eTCP keepalive\u003c/a\u003e support in your system's TCP stack implementation in order to detect \"half-open\" TCP connections in time.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example, on Linux, you can configure the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#listen\" rel=\"nofollow\"\u003elisten\u003c/a\u003e directive in your \u003ccode\u003enginx.conf\u003c/code\u003e file like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n listen 80 so_keepalive=2s:2s:8;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elisten\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e80\u003c/span\u003e so_keepalive=\u003cspan class=\"pl-c1\"\u003e2s\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003e2s\u003c/span\u003e:8\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eOn FreeBSD, you can only tune the system-wide configuration for TCP keepalive, for example:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"# sysctl net.inet.tcp.keepintvl=2000\n# sysctl net.inet.tcp.keepidle=2000\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e# sysctl net.inet.tcp.keepintvl=2000\n# sysctl net.inet.tcp.keepidle=2000\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.7.4\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxon_abort\"\u003engx.on_abort\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_max_pending_timers\u003c/h2\u003e\u003ca id=\"user-content-lua_max_pending_timers\" class=\"anchor\" aria-label=\"Permalink: lua_max_pending_timers\" href=\"#lua_max_pending_timers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_max_pending_timers \u0026lt;count\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_max_pending_timers 1024\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls the maximum number of pending timers allowed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePending timers are those timers that have not expired yet.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen exceeding this limit, the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e call will immediately return \u003ccode\u003enil\u003c/code\u003e and the error string \"too many pending timers\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.8.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_max_running_timers\u003c/h2\u003e\u003ca id=\"user-content-lua_max_running_timers\" class=\"anchor\" aria-label=\"Permalink: lua_max_running_timers\" href=\"#lua_max_running_timers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_max_running_timers \u0026lt;count\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_max_running_timers 256\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eControls the maximum number of \"running timers\" allowed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRunning timers are those timers whose user callback functions are still running or \u003ccode\u003elightthreads\u003c/code\u003e spawned in callback functions are still running.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen exceeding this limit, Nginx will stop running the callbacks of newly expired timers and log an error message \"N lua_max_running_timers are not enough\" where \"N\" is the current value of this directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.8.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_sa_restart\u003c/h2\u003e\u003ca id=\"user-content-lua_sa_restart\" class=\"anchor\" aria-label=\"Permalink: lua_sa_restart\" href=\"#lua_sa_restart\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_sa_restart on|off\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_sa_restart on\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen enabled, this module will set the \u003ccode\u003eSA_RESTART\u003c/code\u003e flag on Nginx workers signal dispositions.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis allows Lua I/O primitives to not be interrupted by Nginx's handling of various signals.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.10.14\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003elua_worker_thread_vm_pool_size\u003c/h2\u003e\u003ca id=\"user-content-lua_worker_thread_vm_pool_size\" class=\"anchor\" aria-label=\"Permalink: lua_worker_thread_vm_pool_size\" href=\"#lua_worker_thread_vm_pool_size\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elua_worker_thread_vm_pool_size \u0026lt;size\u0026gt;\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003edefault:\u003c/strong\u003e \u003cem\u003elua_worker_thread_vm_pool_size 10\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003ehttp\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpecifies the size limit of the Lua VM pool (default 100) that will be used in the \u003ca href=\"#ngxrun_worker_thread\"\u003engx.run_worker_thread\u003c/a\u003e API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso, it is not allowed to create Lua VMs that exceeds the pool size limit.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe Lua VM in the VM pool is used to execute Lua code in separate thread.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe pool is global at Nginx worker level. And it is used to reuse Lua VMs between requests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eWarning:\u003c/strong\u003e Each worker thread uses a separate Lua VM and caches the Lua VM for reuse in subsequent operations. Configuring too many worker threads can result in consuming a lot of memory.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#directives\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eNginx API for Lua\u003c/h1\u003e\u003ca id=\"user-content-nginx-api-for-lua\" class=\"anchor\" aria-label=\"Permalink: Nginx API for Lua\" href=\"#nginx-api-for-lua\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxarg\"\u003engx.arg\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxvarvariable\"\u003engx.var.VARIABLE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#core-constants\"\u003eCore constants\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#http-method-constants\"\u003eHTTP method constants\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#http-status-constants\"\u003eHTTP status constants\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#nginx-log-level-constants\"\u003eNginx log level constants\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#print\"\u003eprint\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxstatus\"\u003engx.status\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxheaderheader\"\u003engx.header.HEADER\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxrespget_headers\"\u003engx.resp.get_headers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqis_internal\"\u003engx.req.is_internal\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqstart_time\"\u003engx.req.start_time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqhttp_version\"\u003engx.req.http_version\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqraw_header\"\u003engx.req.raw_header\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_method\"\u003engx.req.get_method\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_method\"\u003engx.req.set_method\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_uri\"\u003engx.req.set_uri\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_uri_args\"\u003engx.req.set_uri_args\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_uri_args\"\u003engx.req.get_uri_args\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_post_args\"\u003engx.req.get_post_args\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_headers\"\u003engx.req.get_headers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_header\"\u003engx.req.set_header\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqclear_header\"\u003engx.req.clear_header\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_body_data\"\u003engx.req.get_body_data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqget_body_file\"\u003engx.req.get_body_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_body_data\"\u003engx.req.set_body_data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqset_body_file\"\u003engx.req.set_body_file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxheaders_sent\"\u003engx.headers_sent\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxlog\"\u003engx.log\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxflush\"\u003engx.flush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxeof\"\u003engx.eof\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsleep\"\u003engx.sleep\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxescape_uri\"\u003engx.escape_uri\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxunescape_uri\"\u003engx.unescape_uri\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxencode_args\"\u003engx.encode_args\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxdecode_args\"\u003engx.decode_args\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxencode_base64\"\u003engx.encode_base64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxdecode_base64\"\u003engx.decode_base64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxdecode_base64mime\"\u003engx.decode_base64mime\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxcrc32_short\"\u003engx.crc32_short\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxcrc32_long\"\u003engx.crc32_long\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxhmac_sha1\"\u003engx.hmac_sha1\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxmd5\"\u003engx.md5\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxmd5_bin\"\u003engx.md5_bin\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsha1_bin\"\u003engx.sha1_bin\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxquote_sql_str\"\u003engx.quote_sql_str\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtoday\"\u003engx.today\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtime\"\u003engx.time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxnow\"\u003engx.now\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxupdate_time\"\u003engx.update_time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxlocaltime\"\u003engx.localtime\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxutctime\"\u003engx.utctime\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxcookie_time\"\u003engx.cookie_time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxhttp_time\"\u003engx.http_time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxparse_http_time\"\u003engx.parse_http_time\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxis_subrequest\"\u003engx.is_subrequest\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxrefind\"\u003engx.re.find\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxregmatch\"\u003engx.re.gmatch\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxresub\"\u003engx.re.sub\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxregsub\"\u003engx.re.gsub\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget\"\u003engx.shared.DICT.get\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget_stale\"\u003engx.shared.DICT.get_stale\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictset\"\u003engx.shared.DICT.set\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictsafe_set\"\u003engx.shared.DICT.safe_set\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictadd\"\u003engx.shared.DICT.add\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictsafe_add\"\u003engx.shared.DICT.safe_add\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictreplace\"\u003engx.shared.DICT.replace\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictdelete\"\u003engx.shared.DICT.delete\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictincr\"\u003engx.shared.DICT.incr\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictlpush\"\u003engx.shared.DICT.lpush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictrpush\"\u003engx.shared.DICT.rpush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictlpop\"\u003engx.shared.DICT.lpop\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictrpop\"\u003engx.shared.DICT.rpop\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictllen\"\u003engx.shared.DICT.llen\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictttl\"\u003engx.shared.DICT.ttl\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictexpire\"\u003engx.shared.DICT.expire\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictflush_all\"\u003engx.shared.DICT.flush_all\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictflush_expired\"\u003engx.shared.DICT.flush_expired\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget_keys\"\u003engx.shared.DICT.get_keys\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictcapacity\"\u003engx.shared.DICT.capacity\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictfree_space\"\u003engx.shared.DICT.free_space\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsocketudp\"\u003engx.socket.udp\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsockbind\"\u003eudpsock:bind\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksetpeername\"\u003eudpsock:setpeername\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksend\"\u003eudpsock:send\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsockreceive\"\u003eudpsock:receive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsockclose\"\u003eudpsock:close\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksettimeout\"\u003eudpsock:settimeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsocketstream\"\u003engx.socket.stream\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockbind\"\u003etcpsock:bind\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockconnect\"\u003etcpsock:connect\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#getfd\"\u003etcpsock:getfd\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetclientcert\"\u003etcpsock:setclientcert\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksend\"\u003etcpsock:send\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceive\"\u003etcpsock:receive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceiveany\"\u003etcpsock:receiveany\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceiveuntil\"\u003etcpsock:receiveuntil\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockclose\"\u003etcpsock:close\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksettimeout\"\u003etcpsock:settimeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksettimeouts\"\u003etcpsock:settimeouts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetoption\"\u003etcpsock:setoption\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetkeepalive\"\u003etcpsock:setkeepalive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockgetreusedtimes\"\u003etcpsock:getreusedtimes\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsocketconnect\"\u003engx.socket.connect\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxget_phase\"\u003engx.get_phase\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxthreadspawn\"\u003engx.thread.spawn\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxthreadwait\"\u003engx.thread.wait\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxthreadkill\"\u003engx.thread.kill\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxon_abort\"\u003engx.on_abort\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtimerevery\"\u003engx.timer.every\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtimerrunning_count\"\u003engx.timer.running_count\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxtimerpending_count\"\u003engx.timer.pending_count\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfigsubsystem\"\u003engx.config.subsystem\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfigdebug\"\u003engx.config.debug\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfigprefix\"\u003engx.config.prefix\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfignginx_version\"\u003engx.config.nginx_version\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfignginx_configure\"\u003engx.config.nginx_configure\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxconfigngx_lua_version\"\u003engx.config.ngx_lua_version\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxworkerexiting\"\u003engx.worker.exiting\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxworkerpid\"\u003engx.worker.pid\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxworkerpids\"\u003engx.worker.pids\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxworkercount\"\u003engx.worker.count\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxworkerid\"\u003engx.worker.id\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxsemaphore\"\u003engx.semaphore\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxbalancer\"\u003engx.balancer\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxssl\"\u003engx.ssl\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxocsp\"\u003engx.ocsp\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ndkset_vardirective\"\u003endk.set_var.DIRECTIVE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutinecreate\"\u003ecoroutine.create\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutineresume\"\u003ecoroutine.resume\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutineyield\"\u003ecoroutine.yield\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutinewrap\"\u003ecoroutine.wrap\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutinerunning\"\u003ecoroutine.running\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#coroutinestatus\"\u003ecoroutine.status\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxrun_worker_thread\"\u003engx.run_worker_thread\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eIntroduction\u003c/h2\u003e\u003ca id=\"user-content-introduction\" class=\"anchor\" aria-label=\"Permalink: Introduction\" href=\"#introduction\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe various \u003ccode\u003e*_by_lua\u003c/code\u003e, \u003ccode\u003e*_by_lua_block\u003c/code\u003e and \u003ccode\u003e*_by_lua_file\u003c/code\u003e configuration directives serve as gateways to the Lua API within the \u003ccode\u003enginx.conf\u003c/code\u003e file. The Nginx Lua API described below can only be called within the user Lua code run in the context of these configuration directives.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe API is exposed to Lua in the form of two standard packages \u003ccode\u003engx\u003c/code\u003e and \u003ccode\u003endk\u003c/code\u003e. These packages are in the default global scope within ngx_lua and are always available within ngx_lua directives.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe packages can be introduced into external Lua modules like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local say = ngx.say\n\n local _M = {}\n\n function _M.foo(a)\n     say(a)\n end\n\n return _M\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esay\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esay\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003e_M\u003c/span\u003e.\u003cspan class=\"pl-en\"\u003efoo\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e)\n     \u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eUse of the \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-package.seeall\" rel=\"nofollow\"\u003epackage.seeall\u003c/a\u003e flag is strongly discouraged due to its various bad side-effects.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is also possible to directly require the packages in external Lua modules:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local ngx = require \u0026quot;ngx\u0026quot;\n local ndk = require \u0026quot;ndk\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003engx\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003endk\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003endk\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe ability to require these packages was introduced in the \u003ccode\u003ev0.2.1rc19\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNetwork I/O operations in user code should only be done through the Nginx Lua API calls as the Nginx event loop may be blocked and performance drop off dramatically otherwise. Disk operations with relatively small amount of data can be done using the standard Lua \u003ccode\u003eio\u003c/code\u003e library but huge file reading and writing should be avoided wherever possible as they may block the Nginx process significantly. Delegating all network and disk I/O operations to Nginx's subrequests (via the \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e method and similar) is strongly recommended for maximum performance.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.arg\u003c/h2\u003e\u003ca id=\"user-content-ngxarg\" class=\"anchor\" aria-label=\"Permalink: ngx.arg\" href=\"#ngxarg\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eval = ngx.arg[index]\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, body_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen this is used in the context of the \u003ca href=\"#set_by_lua\"\u003eset_by_lua*\u003c/a\u003e directives, this table is read-only and holds the input arguments to the config directives:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n value = ngx.arg[n]\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003evalue\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003earg\u003c/span\u003e[\u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e]\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere is an example\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     set $a 32;\n     set $b 56;\n\n     set_by_lua $sum\n         'return tonumber(ngx.arg[1]) + tonumber(ngx.arg[2])'\n         $a $b;\n\n     echo $sum;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e56\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     set_by_lua \u003cspan class=\"pl-v\"\u003e$sum\u003c/span\u003e\n         \u003cspan class=\"pl-s\"\u003e'return tonumber(ngx.arg[1]) + tonumber(ngx.arg[2])'\u003c/span\u003e\n         \u003cspan class=\"pl-v\"\u003e$a\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$b\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     echo \u003cspan class=\"pl-v\"\u003e$sum\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ethat writes out \u003ccode\u003e88\u003c/code\u003e, the sum of \u003ccode\u003e32\u003c/code\u003e and \u003ccode\u003e56\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen this table is used in the context of \u003ca href=\"#body_filter_by_lua\"\u003ebody_filter_by_lua*\u003c/a\u003e, the first element holds the input data chunk to the output filter code and the second element holds the boolean flag for the \"eof\" flag indicating the end of the whole output data stream.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe data chunk and \"eof\" flag passed to the downstream Nginx output filters can also be overridden by assigning values directly to the corresponding table elements. When setting \u003ccode\u003enil\u003c/code\u003e or an empty Lua string value to \u003ccode\u003engx.arg[1]\u003c/code\u003e, no data chunk will be passed to the downstream Nginx output filters at all.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.var.VARIABLE\u003c/h2\u003e\u003ca id=\"user-content-ngxvarvariable\" class=\"anchor\" aria-label=\"Permalink: ngx.var.VARIABLE\" href=\"#ngxvarvariable\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.var.VAR_NAME\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRead and write Nginx variable values.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n value = ngx.var.some_nginx_variable_name\n ngx.var.some_nginx_variable_name = value\"\u003e\u003cpre\u003e value = ngx.var.some_nginx_variable_name\n ngx.var.some_nginx_variable_name = value\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that only already defined Nginx variables can be written to.\nFor example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     set $my_var ''; # this line is required to create $my_var at config time\n     content_by_lua_block {\n         ngx.var.my_var = 123\n         ...\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$my_var\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e # this line is required to create \u003cspan class=\"pl-v\"\u003e$my_var\u003c/span\u003e at config time\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.var.my_var = \u003cspan class=\"pl-c1\"\u003e123\u003c/span\u003e\n         ...\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, Nginx variables cannot be created on-the-fly. Here is a list of pre-defined\n\u003ca href=\"http://nginx.org/en/docs/varindex.html\" rel=\"nofollow\"\u003eNginx variables\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSome special Nginx variables like \u003ccode\u003e$args\u003c/code\u003e and \u003ccode\u003e$limit_rate\u003c/code\u003e can be assigned a value,\nmany others are not, like \u003ccode\u003e$query_string\u003c/code\u003e, \u003ccode\u003e$arg_PARAMETER\u003c/code\u003e, and \u003ccode\u003e$http_NAME\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx regex group capturing variables \u003ccode\u003e$1\u003c/code\u003e, \u003ccode\u003e$2\u003c/code\u003e, \u003ccode\u003e$3\u003c/code\u003e, and etc, can be read by this\ninterface as well, by writing \u003ccode\u003engx.var[1]\u003c/code\u003e, \u003ccode\u003engx.var[2]\u003c/code\u003e, \u003ccode\u003engx.var[3]\u003c/code\u003e, and etc.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSetting \u003ccode\u003engx.var.Foo\u003c/code\u003e to a \u003ccode\u003enil\u003c/code\u003e value will unset the \u003ccode\u003e$Foo\u003c/code\u003e Nginx variable.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.var.args = nil\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003evar\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eCAUTION\u003c/strong\u003e When reading from an Nginx variable, Nginx will allocate memory in the per-request memory pool which is freed only at request termination. So when you need to read from an Nginx variable repeatedly in your Lua code, cache the Nginx variable value to your own Lua variable, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local val = ngx.var.some_var\n --- use the val repeatedly later\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eval\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003evar\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esome_var\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e---\u003c/span\u003e use the val repeatedly later\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eto prevent (temporary) memory leaking within the current request's lifetime. Another way of caching the result is to use the \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUndefined Nginx variables are evaluated to \u003ccode\u003enil\u003c/code\u003e while uninitialized (but defined) Nginx variables are evaluated to an empty Lua string.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API requires a relatively expensive metamethod call and it is recommended to avoid using it on hot code paths.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eCore constants\u003c/h2\u003e\u003ca id=\"user-content-core-constants\" class=\"anchor\" aria-label=\"Permalink: Core constants\" href=\"#core-constants\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, *log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n   ngx.OK (0)\n   ngx.ERROR (-1)\n   ngx.AGAIN (-2)\n   ngx.DONE (-4)\n   ngx.DECLINED (-5)\"\u003e\u003cpre\u003e   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eOK\u003c/span\u003e (\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eERROR\u003c/span\u003e (\u003cspan class=\"pl-k\"\u003e-\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e)\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eAGAIN\u003c/span\u003e (\u003cspan class=\"pl-k\"\u003e-\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e2\u003c/span\u003e)\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eDONE\u003c/span\u003e (\u003cspan class=\"pl-k\"\u003e-\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e4\u003c/span\u003e)\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eDECLINED\u003c/span\u003e (\u003cspan class=\"pl-k\"\u003e-\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e5\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that only three of these constants are utilized by the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e (i.e., \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e accepts \u003ccode\u003engx.OK\u003c/code\u003e, \u003ccode\u003engx.ERROR\u003c/code\u003e, and \u003ccode\u003engx.DECLINED\u003c/code\u003e as input).\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n   ngx.null\"\u003e\u003cpre\u003e   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003enull\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003engx.null\u003c/code\u003e constant is a \u003ccode\u003eNULL\u003c/code\u003e light userdata usually used to represent nil values in Lua tables etc and is similar to the \u003ca href=\"http://www.kyne.com.au/~mark/software/lua-cjson.php\" rel=\"nofollow\"\u003elua-cjson\u003c/a\u003e library's \u003ccode\u003ecjson.null\u003c/code\u003e constant. This constant was first introduced in the \u003ccode\u003ev0.5.0rc5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003engx.DECLINED\u003c/code\u003e constant was first introduced in the \u003ccode\u003ev0.5.0rc19\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eHTTP method constants\u003c/h2\u003e\u003ca id=\"user-content-http-method-constants\" class=\"anchor\" aria-label=\"Permalink: HTTP method constants\" href=\"#http-method-constants\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  ngx.HTTP_GET\n  ngx.HTTP_HEAD\n  ngx.HTTP_PUT\n  ngx.HTTP_POST\n  ngx.HTTP_DELETE\n  ngx.HTTP_OPTIONS   (added in the v0.5.0rc24 release)\n  ngx.HTTP_MKCOL     (added in the v0.8.2 release)\n  ngx.HTTP_COPY      (added in the v0.8.2 release)\n  ngx.HTTP_MOVE      (added in the v0.8.2 release)\n  ngx.HTTP_PROPFIND  (added in the v0.8.2 release)\n  ngx.HTTP_PROPPATCH (added in the v0.8.2 release)\n  ngx.HTTP_LOCK      (added in the v0.8.2 release)\n  ngx.HTTP_UNLOCK    (added in the v0.8.2 release)\n  ngx.HTTP_PATCH     (added in the v0.8.2 release)\n  ngx.HTTP_TRACE     (added in the v0.8.2 release)\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e  ngx.HTTP_GET\n  ngx.HTTP_HEAD\n  ngx.HTTP_PUT\n  ngx.HTTP_POST\n  ngx.HTTP_DELETE\n  ngx.HTTP_OPTIONS   (added in the v0.5.0rc24 release)\n  ngx.HTTP_MKCOL     (added in the v0.8.2 release)\n  ngx.HTTP_COPY      (added in the v0.8.2 release)\n  ngx.HTTP_MOVE      (added in the v0.8.2 release)\n  ngx.HTTP_PROPFIND  (added in the v0.8.2 release)\n  ngx.HTTP_PROPPATCH (added in the v0.8.2 release)\n  ngx.HTTP_LOCK      (added in the v0.8.2 release)\n  ngx.HTTP_UNLOCK    (added in the v0.8.2 release)\n  ngx.HTTP_PATCH     (added in the v0.8.2 release)\n  ngx.HTTP_TRACE     (added in the v0.8.2 release)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese constants are usually used in \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e method calls.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eHTTP status constants\u003c/h2\u003e\u003ca id=\"user-content-http-status-constants\" class=\"anchor\" aria-label=\"Permalink: HTTP status constants\" href=\"#http-status-constants\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n   value = ngx.HTTP_CONTINUE (100) (first added in the v0.9.20 release)\n   value = ngx.HTTP_SWITCHING_PROTOCOLS (101) (first added in the v0.9.20 release)\n   value = ngx.HTTP_OK (200)\n   value = ngx.HTTP_CREATED (201)\n   value = ngx.HTTP_ACCEPTED (202) (first added in the v0.9.20 release)\n   value = ngx.HTTP_NO_CONTENT (204) (first added in the v0.9.20 release)\n   value = ngx.HTTP_PARTIAL_CONTENT (206) (first added in the v0.9.20 release)\n   value = ngx.HTTP_SPECIAL_RESPONSE (300)\n   value = ngx.HTTP_MOVED_PERMANENTLY (301)\n   value = ngx.HTTP_MOVED_TEMPORARILY (302)\n   value = ngx.HTTP_SEE_OTHER (303)\n   value = ngx.HTTP_NOT_MODIFIED (304)\n   value = ngx.HTTP_TEMPORARY_REDIRECT (307) (first added in the v0.9.20 release)\n   value = ngx.HTTP_PERMANENT_REDIRECT (308)\n   value = ngx.HTTP_BAD_REQUEST (400)\n   value = ngx.HTTP_UNAUTHORIZED (401)\n   value = ngx.HTTP_PAYMENT_REQUIRED (402) (first added in the v0.9.20 release)\n   value = ngx.HTTP_FORBIDDEN (403)\n   value = ngx.HTTP_NOT_FOUND (404)\n   value = ngx.HTTP_NOT_ALLOWED (405)\n   value = ngx.HTTP_NOT_ACCEPTABLE (406) (first added in the v0.9.20 release)\n   value = ngx.HTTP_REQUEST_TIMEOUT (408) (first added in the v0.9.20 release)\n   value = ngx.HTTP_CONFLICT (409) (first added in the v0.9.20 release)\n   value = ngx.HTTP_GONE (410)\n   value = ngx.HTTP_UPGRADE_REQUIRED (426) (first added in the v0.9.20 release)\n   value = ngx.HTTP_TOO_MANY_REQUESTS (429) (first added in the v0.9.20 release)\n   value = ngx.HTTP_CLOSE (444) (first added in the v0.9.20 release)\n   value = ngx.HTTP_ILLEGAL (451) (first added in the v0.9.20 release)\n   value = ngx.HTTP_INTERNAL_SERVER_ERROR (500)\n   value = ngx.HTTP_NOT_IMPLEMENTED (501)\n   value = ngx.HTTP_METHOD_NOT_IMPLEMENTED (501) (kept for compatibility)\n   value = ngx.HTTP_BAD_GATEWAY (502) (first added in the v0.9.20 release)\n   value = ngx.HTTP_SERVICE_UNAVAILABLE (503)\n   value = ngx.HTTP_GATEWAY_TIMEOUT (504) (first added in the v0.3.1rc38 release)\n   value = ngx.HTTP_VERSION_NOT_SUPPORTED (505) (first added in the v0.9.20 release)\n   value = ngx.HTTP_INSUFFICIENT_STORAGE (507) (first added in the v0.9.20 release)\"\u003e\u003cpre\u003e   value = ngx.HTTP_CONTINUE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e100\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_SWITCHING_PROTOCOLS \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e101\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_OK \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e200\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_CREATED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e201\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_ACCEPTED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e202\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NO_CONTENT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e204\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_PARTIAL_CONTENT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e206\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_SPECIAL_RESPONSE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e300\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_MOVED_PERMANENTLY \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e301\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_MOVED_TEMPORARILY \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e302\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_SEE_OTHER \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e303\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NOT_MODIFIED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e304\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_TEMPORARY_REDIRECT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e307\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_PERMANENT_REDIRECT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e308\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_BAD_REQUEST \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e400\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_UNAUTHORIZED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e401\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_PAYMENT_REQUIRED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e402\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_FORBIDDEN \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e403\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NOT_FOUND \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e404\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NOT_ALLOWED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e405\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NOT_ACCEPTABLE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e406\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_REQUEST_TIMEOUT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e408\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_CONFLICT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e409\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_GONE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e410\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_UPGRADE_REQUIRED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e426\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_TOO_MANY_REQUESTS \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e429\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_CLOSE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e444\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_ILLEGAL \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e451\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_INTERNAL_SERVER_ERROR \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e500\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_NOT_IMPLEMENTED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e501\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_METHOD_NOT_IMPLEMENTED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e501\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ekept \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e compatibility\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_BAD_GATEWAY \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e502\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_SERVICE_UNAVAILABLE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e503\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_GATEWAY_TIMEOUT \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e504\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.3.\u003cspan class=\"pl-c1\"\u003e1rc38\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_VERSION_NOT_SUPPORTED \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e505\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n   value = ngx.HTTP_INSUFFICIENT_STORAGE \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e507\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003efirst added in the v0.9.\u003cspan class=\"pl-c1\"\u003e20\u003c/span\u003e release\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eNginx log level constants\u003c/h2\u003e\u003ca id=\"user-content-nginx-log-level-constants\" class=\"anchor\" aria-label=\"Permalink: Nginx log level constants\" href=\"#nginx-log-level-constants\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n   ngx.STDERR\n   ngx.EMERG\n   ngx.ALERT\n   ngx.CRIT\n   ngx.ERR\n   ngx.WARN\n   ngx.NOTICE\n   ngx.INFO\n   ngx.DEBUG\"\u003e\u003cpre\u003e   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eSTDERR\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eEMERG\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eALERT\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eCRIT\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eWARN\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eNOTICE\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eINFO\u003c/span\u003e\n   \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eDEBUG\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese constants are usually used by the \u003ca href=\"#ngxlog\"\u003engx.log\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eprint\u003c/h2\u003e\u003ca id=\"user-content-print\" class=\"anchor\" aria-label=\"Permalink: print\" href=\"#print\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eprint(...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWrites argument values into the Nginx \u003ccode\u003eerror.log\u003c/code\u003e file with the \u003ccode\u003engx.NOTICE\u003c/code\u003e log level.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.log(ngx.NOTICE, ...)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eNOTICE\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eLua \u003ccode\u003enil\u003c/code\u003e arguments are accepted and result in literal \u003ccode\u003e\"nil\"\u003c/code\u003e strings while Lua booleans result in literal \u003ccode\u003e\"true\"\u003c/code\u003e or \u003ccode\u003e\"false\"\u003c/code\u003e strings. And the \u003ccode\u003engx.null\u003c/code\u003e constant will yield the \u003ccode\u003e\"null\"\u003c/code\u003e string output.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThere is a hard coded \u003ccode\u003e2048\u003c/code\u003e byte limitation on error message lengths in the Nginx core. This limit includes trailing newlines and leading time stamps. If the message size exceeds this limit, Nginx will truncate the message text accordingly. This limit can be manually modified by editing the \u003ccode\u003eNGX_MAX_ERROR_STR\u003c/code\u003e macro definition in the \u003ccode\u003esrc/core/ngx_log.h\u003c/code\u003e file in the Nginx source tree.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.ctx\u003c/h2\u003e\u003ca id=\"user-content-ngxctx\" class=\"anchor\" aria-label=\"Permalink: ngx.ctx\" href=\"#ngxctx\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis table can be used to store per-request Lua context data and has a life time identical to the current request (as with the Nginx variables).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eConsider the following example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     rewrite_by_lua_block {\n         ngx.ctx.foo = 76\n     }\n     access_by_lua_block {\n         ngx.ctx.foo = ngx.ctx.foo + 3\n     }\n     content_by_lua_block {\n         ngx.say(ngx.ctx.foo)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.foo = \u003cspan class=\"pl-c1\"\u003e76\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     access_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.foo = ngx.ctx.foo + 3\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ctx.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eGET /test\u003c/code\u003e will yield the output\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n 79\"\u003e\u003cpre\u003e 79\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, the \u003ccode\u003engx.ctx.foo\u003c/code\u003e entry persists across the rewrite, access, and content phases of a request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEvery request, including subrequests, has its own copy of the table. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /sub {\n     content_by_lua_block {\n         ngx.say(\u0026quot;sub pre: \u0026quot;, ngx.ctx.blah)\n         ngx.ctx.blah = 32\n         ngx.say(\u0026quot;sub post: \u0026quot;, ngx.ctx.blah)\n     }\n }\n\n location /main {\n     content_by_lua_block {\n         ngx.ctx.blah = 73\n         ngx.say(\u0026quot;main pre: \u0026quot;, ngx.ctx.blah)\n         local res = ngx.location.capture(\u0026quot;/sub\u0026quot;)\n         ngx.print(res.body)\n         ngx.say(\u0026quot;main post: \u0026quot;, ngx.ctx.blah)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /sub \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"sub pre: \"\u003c/span\u003e, ngx.ctx.blah\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.ctx.blah = \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"sub post: \"\u003c/span\u003e, ngx.ctx.blah\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /main \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.blah = \u003cspan class=\"pl-c1\"\u003e73\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"main pre: \"\u003c/span\u003e, ngx.ctx.blah\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         local res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/sub\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"main post: \"\u003c/span\u003e, ngx.ctx.blah\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eGET /main\u003c/code\u003e will give the output\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n main pre: 73\n sub pre: nil\n sub post: 32\n main post: 73\"\u003e\u003cpre\u003e main pre: 73\n sub pre: nil\n sub post: 32\n main post: 73\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere, modification of the \u003ccode\u003engx.ctx.blah\u003c/code\u003e entry in the subrequest does not affect the one in the parent request. This is because they have two separate versions of \u003ccode\u003engx.ctx.blah\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eInternal redirects (triggered by nginx configuration directives like \u003ccode\u003eerror_page\u003c/code\u003e, \u003ccode\u003etry_files\u003c/code\u003e, \u003ccode\u003eindex\u003c/code\u003e, etc.) will destroy the original request \u003ccode\u003engx.ctx\u003c/code\u003e data (if any) and the new request will have an empty \u003ccode\u003engx.ctx\u003c/code\u003e table. For instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /new {\n     content_by_lua_block {\n         ngx.say(ngx.ctx.foo)\n     }\n }\n\n location /orig {\n     content_by_lua_block {\n         ngx.ctx.foo = \u0026quot;hello\u0026quot;\n         ngx.exec(\u0026quot;/new\u0026quot;)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /new \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ctx.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /orig \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.foo = \u003cspan class=\"pl-s\"\u003e\"hello\"\u003c/span\u003e\n         ngx.exec\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/new\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eGET /orig\u003c/code\u003e will give\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n nil\"\u003e\u003cpre\u003e nil\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003erather than the original \u003ccode\u003e\"hello\"\u003c/code\u003e value.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBecause HTTP request is created after SSL handshake, the \u003ccode\u003engx.ctx\u003c/code\u003e created\nin \u003ca href=\"#ssl_certificate_by_lua\"\u003essl_certificate_by_lua*\u003c/a\u003e, \u003ca href=\"#ssl_session_store_by_lua\"\u003essl_session_store_by_lua*\u003c/a\u003e, \u003ca href=\"#ssl_session_fetch_by_lua\"\u003essl_session_fetch_by_lua*\u003c/a\u003e and \u003ca href=\"#ssl_client_hello_by_lua\"\u003essl_client_hello_by_lua*\u003c/a\u003e\nis not available in the following phases like \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.10.18\u003c/code\u003e, the \u003ccode\u003engx.ctx\u003c/code\u003e created during a SSL handshake\nwill be inherited by the requests which share the same TCP connection established by the handshake.\nNote that overwrite values in \u003ccode\u003engx.ctx\u003c/code\u003e in the http request phases (like \u003ccode\u003erewrite_by_lua*\u003c/code\u003e) will only take affect in the current http request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eArbitrary data values, including Lua closures and nested tables, can be inserted into this \"magic\" table. It also allows the registration of custom meta methods.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOverriding \u003ccode\u003engx.ctx\u003c/code\u003e with a new Lua table is also supported, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.ctx = { foo = 32, bar = 54 }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ectx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e { \u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ebar\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e54\u003c/span\u003e }\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhen being used in the context of \u003ca href=\"#init_worker_by_lua\"\u003einit_worker_by_lua*\u003c/a\u003e, this table just has the same lifetime of the current Lua handler.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003engx.ctx\u003c/code\u003e lookup requires relatively expensive metamethod calls and it is much slower than explicitly passing per-request data along by your own function arguments. So do not abuse this API for saving your own function arguments because it usually has quite some performance impact.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBecause of the metamethod magic, never \"local\" the \u003ccode\u003engx.ctx\u003c/code\u003e table outside your Lua function scope on the Lua module level due to \u003ca href=\"#data-sharing-within-an-nginx-worker\"\u003eworker-level data sharing\u003c/a\u003e. For example, the following is bad:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- mymodule.lua\n local _M = {}\n\n -- the following line is bad since ngx.ctx is a per-request\n -- data while this \u0026lt;code\u0026gt;ctx\u0026lt;/code\u0026gt; variable is on the Lua module level\n -- and thus is per-nginx-worker.\n local ctx = ngx.ctx\n\n function _M.main()\n     ctx.foo = \u0026quot;bar\u0026quot;\n end\n\n return _M\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e mymodule.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e the following line is bad since ngx.ctx is a per-request\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e data while this \u0026lt;code\u0026gt;ctx\u0026lt;/code\u0026gt; variable is on the Lua module level\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e and thus is per-nginx-worker.\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ectx\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003e_M\u003c/span\u003e.\u003cspan class=\"pl-en\"\u003emain\u003c/span\u003e()\n     \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebar\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eUse the following instead:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- mymodule.lua\n local _M = {}\n\n function _M.main(ctx)\n     ctx.foo = \u0026quot;bar\u0026quot;\n end\n\n return _M\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e mymodule.lua\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003e_M\u003c/span\u003e.\u003cspan class=\"pl-en\"\u003emain\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebar\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003e_M\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, let the caller pass the \u003ccode\u003ectx\u003c/code\u003e table explicitly via a function argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.location.capture\u003c/h2\u003e\u003ca id=\"user-content-ngxlocationcapture\" class=\"anchor\" aria-label=\"Permalink: ngx.location.capture\" href=\"#ngxlocationcapture\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eres = ngx.location.capture(uri, options?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIssues a synchronous but still non-blocking \u003cem\u003eNginx Subrequest\u003c/em\u003e using \u003ccode\u003euri\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNginx's subrequests provide a powerful way to make non-blocking internal requests to other locations configured with disk file directory or \u003cem\u003eany\u003c/em\u003e other Nginx C modules like \u003ccode\u003engx_proxy\u003c/code\u003e, \u003ccode\u003engx_fastcgi\u003c/code\u003e, \u003ccode\u003engx_memc\u003c/code\u003e,\n\u003ccode\u003engx_postgres\u003c/code\u003e, \u003ccode\u003engx_drizzle\u003c/code\u003e, and even ngx_lua itself and etc etc etc.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso note that subrequests just mimic the HTTP interface but there is \u003cem\u003eno\u003c/em\u003e extra HTTP/TCP traffic \u003cem\u003enor\u003c/em\u003e IPC involved. Everything works internally, efficiently, on the C level.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSubrequests are completely different from HTTP 301/302 redirection (via \u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e) and internal redirection (via \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou should always read the request body (by either calling \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e or configuring \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e on) before initiating a subrequest.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API function (as well as \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e) always buffers the whole response body of the subrequest in memory. Thus, you should use \u003ca href=\"#ngxsockettcp\"\u003ecosockets\u003c/a\u003e\nand streaming processing instead if you have to handle large subrequest responses.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is a basic example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n res = ngx.location.capture(uri)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003euri\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eReturns a Lua table with 4 slots: \u003ccode\u003eres.status\u003c/code\u003e, \u003ccode\u003eres.header\u003c/code\u003e, \u003ccode\u003eres.body\u003c/code\u003e, and \u003ccode\u003eres.truncated\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003eres.status\u003c/code\u003e holds the response status code for the subrequest response.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003eres.header\u003c/code\u003e holds all the response headers of the\nsubrequest and it is a normal Lua table. For multi-value response headers,\nthe value is a Lua (array) table that holds all the values in the order that\nthey appear. For instance, if the subrequest response headers contain the following\nlines:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n Set-Cookie: a=3\n Set-Cookie: foo=bar\n Set-Cookie: baz=blah\"\u003e\u003cpre\u003e Set-Cookie: a=3\n Set-Cookie: foo=bar\n Set-Cookie: baz=blah\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eres.header[\"Set-Cookie\"]\u003c/code\u003e will be evaluated to the table value\n\u003ccode\u003e{\"a=3\", \"foo=bar\", \"baz=blah\"}\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003eres.body\u003c/code\u003e holds the subrequest's response body data, which might be truncated. You always need to check the \u003ccode\u003eres.truncated\u003c/code\u003e boolean flag to see if \u003ccode\u003eres.body\u003c/code\u003e contains truncated data. The data truncation here can only be caused by those unrecoverable errors in your subrequests like the cases that the remote end aborts the connection prematurely in the middle of the response body data stream or a read timeout happens when your subrequest is receiving the response body data from the remote.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eURI query strings can be concatenated to URI itself, for instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n res = ngx.location.capture('/foo/bar?a=3\u0026amp;b=4')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo/bar?a=3\u0026amp;b=4\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNamed locations like \u003ccode\u003e@foo\u003c/code\u003e are not allowed due to a limitation in\nthe Nginx core. Use normal locations combined with the \u003ccode\u003einternal\u003c/code\u003e directive to\nprepare internal-only locations.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAn optional option table can be fed as the second\nargument, which supports the options:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003emethod\u003c/code\u003e\nspecify the subrequest's request method, which only accepts constants like \u003ccode\u003engx.HTTP_POST\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebody\u003c/code\u003e\nspecify the subrequest's request body (string value only).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eargs\u003c/code\u003e\nspecify the subrequest's URI query arguments (both string value and Lua tables are accepted)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eheaders\u003c/code\u003e\nspecify the subrequest's request headers (Lua table only). this headers will override the original headers of the subrequest.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ectx\u003c/code\u003e\nspecify a Lua table to be the \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table for the subrequest. It can be the current request's \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table, which effectively makes the parent and its subrequest to share exactly the same context table. This option was first introduced in the \u003ccode\u003ev0.3.1rc25\u003c/code\u003e release.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evars\u003c/code\u003e\ntake a Lua table which holds the values to set the specified Nginx variables in the subrequest as this option's value. This option was first introduced in the \u003ccode\u003ev0.3.1rc31\u003c/code\u003e release.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecopy_all_vars\u003c/code\u003e\nspecify whether to copy over all the Nginx variable values of the current request to the subrequest in question. modifications of the Nginx variables in the subrequest will not affect the current (parent) request. This option was first introduced in the \u003ccode\u003ev0.3.1rc31\u003c/code\u003e release.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eshare_all_vars\u003c/code\u003e\nspecify whether to share all the Nginx variables of the subrequest with the current (parent) request. modifications of the Nginx variables in the subrequest will affect the current (parent) request. Enabling this option may lead to hard-to-debug issues due to bad side-effects and is considered bad and harmful. Only enable this option when you completely know what you are doing.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ealways_forward_body\u003c/code\u003e\nwhen set to true, the current (parent) request's request body will always be forwarded to the subrequest being created if the \u003ccode\u003ebody\u003c/code\u003e option is not specified. The request body read by either \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body()\u003c/a\u003e or \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body on\u003c/a\u003e will be directly forwarded to the subrequest without copying the whole request body data when creating the subrequest (no matter the request body data is buffered in memory buffers or temporary files). By default, this option is \u003ccode\u003efalse\u003c/code\u003e and when the \u003ccode\u003ebody\u003c/code\u003e option is not specified, the request body of the current (parent) request is only forwarded when the subrequest takes the \u003ccode\u003ePUT\u003c/code\u003e or \u003ccode\u003ePOST\u003c/code\u003e request method.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIssuing a POST subrequest, for example, can be done as follows\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n res = ngx.location.capture(\n     '/foo/bar',\n     { method = ngx.HTTP_POST, body = 'hello, world' }\n )\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\n     \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo/bar\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e,\n     { \u003cspan class=\"pl-smi\"\u003emethod\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_POST\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ebody\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ehello, world\u003cspan class=\"pl-pds\"\u003e' \u003c/span\u003e\u003c/span\u003e}\n )\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSee HTTP method constants methods other than POST.\nThe \u003ccode\u003emethod\u003c/code\u003e option is \u003ccode\u003engx.HTTP_GET\u003c/code\u003e by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eargs\u003c/code\u003e option can specify extra URI arguments, for instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.location.capture('/foo?a=1',\n     { args = { b = 3, c = ':' } }\n )\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo?a=1\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e,\n     { \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e { \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ec\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e:\u003cspan class=\"pl-pds\"\u003e' \u003c/span\u003e\u003c/span\u003e} }\n )\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eis equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.location.capture('/foo?a=1\u0026amp;b=3\u0026amp;c=%3a')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo?a=1\u0026amp;b=3\u0026amp;c=%3a\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ethat is, this method will escape argument keys and values according to URI rules and\nconcatenate them together into a complete query string. The format for the Lua table passed as the \u003ccode\u003eargs\u003c/code\u003e argument is identical to the format used in the \u003ca href=\"#ngxencode_args\"\u003engx.encode_args\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eargs\u003c/code\u003e option can also take plain query strings:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.location.capture('/foo?a=1',\n     { args = 'b=3\u0026amp;c=%3a' }\n )\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo?a=1\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e,\n     { \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eb=3\u0026amp;c=%3a\u003cspan class=\"pl-pds\"\u003e' \u003c/span\u003e\u003c/span\u003e}\n )\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis is functionally identical to the previous examples.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eshare_all_vars\u003c/code\u003e option controls whether to share Nginx variables among the current request and its subrequests.\nIf this option is set to \u003ccode\u003etrue\u003c/code\u003e, then the current request and associated subrequests will share the same Nginx variable scope. Hence, changes to Nginx variables made by a subrequest will affect the current request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCare should be taken in using this option as variable scope sharing can have unexpected side effects. The \u003ccode\u003eargs\u003c/code\u003e, \u003ccode\u003evars\u003c/code\u003e, or \u003ccode\u003ecopy_all_vars\u003c/code\u003e options are generally preferable instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis option is set to \u003ccode\u003efalse\u003c/code\u003e by default\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /other {\n     set $dog \u0026quot;$dog world\u0026quot;;\n     echo \u0026quot;$uri dog: $dog\u0026quot;;\n }\n\n location /lua {\n     set $dog 'hello';\n     content_by_lua_block {\n         res = ngx.location.capture(\u0026quot;/other\u0026quot;,\n             { share_all_vars = true })\n\n         ngx.print(res.body)\n         ngx.say(ngx.var.uri, \u0026quot;: \u0026quot;, ngx.var.dog)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /other \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$dog\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\"$dog world\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     echo \u003cspan class=\"pl-s\"\u003e\"$uri dog: $dog\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$dog\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'hello'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/other\"\u003c/span\u003e,\n             \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e share_all_vars = true \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n         ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.uri, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, ngx.var.dog\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAccessing location \u003ccode\u003e/lua\u003c/code\u003e gives\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"/other dog: hello world\n/lua: hello world\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e/other dog: hello world\n/lua: hello world\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003ecopy_all_vars\u003c/code\u003e option provides a copy of the parent request's Nginx variables to subrequests when such subrequests are issued. Changes made to these variables by such subrequests will not affect the parent request or any other subrequests sharing the parent request's variables.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /other {\n     set $dog \u0026quot;$dog world\u0026quot;;\n     echo \u0026quot;$uri dog: $dog\u0026quot;;\n }\n\n location /lua {\n     set $dog 'hello';\n     content_by_lua_block {\n         res = ngx.location.capture(\u0026quot;/other\u0026quot;,\n             { copy_all_vars = true })\n\n         ngx.print(res.body)\n         ngx.say(ngx.var.uri, \u0026quot;: \u0026quot;, ngx.var.dog)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /other \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$dog\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\"$dog world\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     echo \u003cspan class=\"pl-s\"\u003e\"$uri dog: $dog\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$dog\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'hello'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/other\"\u003c/span\u003e,\n             \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e copy_all_vars = true \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n         ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.uri, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, ngx.var.dog\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRequest \u003ccode\u003eGET /lua\u003c/code\u003e will give the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"/other dog: hello world\n/lua: hello\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e/other dog: hello world\n/lua: hello\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that if both \u003ccode\u003eshare_all_vars\u003c/code\u003e and \u003ccode\u003ecopy_all_vars\u003c/code\u003e are set to true, then \u003ccode\u003eshare_all_vars\u003c/code\u003e takes precedence.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn addition to the two settings above, it is possible to specify\nvalues for variables in the subrequest using the \u003ccode\u003evars\u003c/code\u003e option. These\nvariables are set after the sharing or copying of variables has been\nevaluated, and provides a more efficient method of passing specific\nvalues to a subrequest over encoding them as URL arguments and\nunescaping them in the Nginx config file.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /other {\n     content_by_lua_block {\n         ngx.say(\u0026quot;dog = \u0026quot;, ngx.var.dog)\n         ngx.say(\u0026quot;cat = \u0026quot;, ngx.var.cat)\n     }\n }\n\n location /lua {\n     set $dog '';\n     set $cat '';\n     content_by_lua_block {\n         res = ngx.location.capture(\u0026quot;/other\u0026quot;,\n             { vars = { dog = \u0026quot;hello\u0026quot;, cat = 32 }})\n\n         ngx.print(res.body)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /other \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"dog = \"\u003c/span\u003e, ngx.var.dog\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"cat = \"\u003c/span\u003e, ngx.var.cat\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$dog\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$cat\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/other\"\u003c/span\u003e,\n             \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e vars = \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e dog = \u003cspan class=\"pl-s\"\u003e\"hello\"\u003c/span\u003e, cat = \u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e}}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n         ngx.print\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eres.body\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAccessing \u003ccode\u003e/lua\u003c/code\u003e will yield the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"dog = hello\ncat = 32\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003edog = hello\ncat = 32\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eheaders\u003c/code\u003e option can be used to specify the request headers for the subrequest. The value of this option should be a Lua table where the keys are the header names and the values are the header values. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocation /foo {\n    content_by_lua_block {\n        ngx.print(ngx.var.http_x_test)\n    }\n}\n\nlocation /lua {\n    content_by_lua_block {\n        local res = ngx.location.capture(\u0026quot;/foo\u0026quot;, {\n            headers = {\n                [\u0026quot;X-Test\u0026quot;] = \u0026quot;aa\u0026quot;,\n            }\n        })\n        ngx.print(res.body)\n    }\n}\"\u003e\u003cpre\u003e\u003cspan class=\"pl-smi\"\u003elocation\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e/\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003efoo\u003c/span\u003e {\n    \u003cspan class=\"pl-c1\"\u003econtent_by_lua_block\u003c/span\u003e {\n        \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003evar\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ehttp_x_test\u003c/span\u003e)\n    }\n}\n\n\u003cspan class=\"pl-smi\"\u003elocation\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e/\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003elua\u003c/span\u003e {\n    \u003cspan class=\"pl-c1\"\u003econtent_by_lua_block\u003c/span\u003e {\n        \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, {\n            \u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\n                [\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-Test\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eaa\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n            }\n        })\n        \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ebody\u003c/span\u003e)\n    }\n}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAccessing \u003ccode\u003e/lua\u003c/code\u003e will yield the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"aa\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eaa\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003ectx\u003c/code\u003e option can be used to specify a custom Lua table to serve as the \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table for the subrequest.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /sub {\n     content_by_lua_block {\n         ngx.ctx.foo = \u0026quot;bar\u0026quot;;\n     }\n }\n location /lua {\n     content_by_lua_block {\n         local ctx = {}\n         res = ngx.location.capture(\u0026quot;/sub\u0026quot;, { ctx = ctx })\n\n         ngx.say(ctx.foo)\n         ngx.say(ngx.ctx.foo)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /sub \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.foo = \u003cspan class=\"pl-s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local ctx = \u003cspan class=\"pl-c1\"\u003e{}\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/sub\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e ctx = ctx \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ectx.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ctx.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen request \u003ccode\u003eGET /lua\u003c/code\u003e gives\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"bar\nnil\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ebar\nnil\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is also possible to use this \u003ccode\u003ectx\u003c/code\u003e option to share the same \u003ca href=\"#ngxctx\"\u003engx.ctx\u003c/a\u003e table between the current (parent) request and the subrequest:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /sub {\n     content_by_lua_block {\n         ngx.ctx.foo = \u0026quot;bar\u0026quot;\n     }\n }\n location /lua {\n     content_by_lua_block {\n         res = ngx.location.capture(\u0026quot;/sub\u0026quot;, { ctx = ngx.ctx })\n         ngx.say(ngx.ctx.foo)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /sub \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.ctx.foo = \u003cspan class=\"pl-s\"\u003e\"bar\"\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /lua \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         res = ngx.\u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e.capture\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/sub\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e ctx = ngx.ctx \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ctx.foo\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRequest \u003ccode\u003eGET /lua\u003c/code\u003e yields the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"bar\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ebar\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that subrequests issued by \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e inherit all the\nrequest headers of the current request by default and that this may have unexpected side effects on the\nsubrequest responses. For example, when using the standard \u003ccode\u003engx_proxy\u003c/code\u003e module to serve\nsubrequests, an \"Accept-Encoding: gzip\" header in the main request may result\nin gzipped responses that cannot be handled properly in Lua code. Original request headers should be ignored by setting\n\u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_request_headers\" rel=\"nofollow\"\u003eproxy_pass_request_headers\u003c/a\u003e to \u003ccode\u003eoff\u003c/code\u003e in subrequest locations.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the \u003ccode\u003ebody\u003c/code\u003e option is not specified and the \u003ccode\u003ealways_forward_body\u003c/code\u003e option is false (the default value), the \u003ccode\u003ePOST\u003c/code\u003e and \u003ccode\u003ePUT\u003c/code\u003e subrequests will inherit the request bodies of the parent request (if any).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThere is a hard-coded upper limit on the number of subrequests possible for every main request. In older versions of Nginx, the limit was \u003ccode\u003e50\u003c/code\u003e concurrent subrequests and in more recent versions, Nginx \u003ccode\u003e1.9.5\u003c/code\u003e onwards, the same limit is changed to limit the depth of recursive subrequests. When this limit is exceeded, the following error message is added to the \u003ccode\u003eerror.log\u003c/code\u003e file:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[error] 13983#0: *1 subrequests cycle while processing \u0026quot;/uri\u0026quot;\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e[error] 13983#0: *1 subrequests cycle while processing \"/uri\"\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe limit can be manually modified if required by editing the definition of the \u003ccode\u003eNGX_HTTP_MAX_SUBREQUESTS\u003c/code\u003e macro in the \u003ccode\u003enginx/src/http/ngx_http_request.h\u003c/code\u003e file in the Nginx source tree.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease also refer to restrictions on capturing locations configured by \u003ca href=\"#locations-configured-by-subrequest-directives-of-other-modules\"\u003esubrequest directives of other modules\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.location.capture_multi\u003c/h2\u003e\u003ca id=\"user-content-ngxlocationcapture_multi\" class=\"anchor\" aria-label=\"Permalink: ngx.location.capture_multi\" href=\"#ngxlocationcapture_multi\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eres1, res2, ... = ngx.location.capture_multi({ {uri, options?}, {uri, options?}, ... })\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e, but supports multiple subrequests running in parallel.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function issues several parallel subrequests specified by the input table and returns their results in the same order. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n res1, res2, res3 = ngx.location.capture_multi{\n     { \u0026quot;/foo\u0026quot;, { args = \u0026quot;a=3\u0026amp;b=4\u0026quot; } },\n     { \u0026quot;/bar\u0026quot; },\n     { \u0026quot;/baz\u0026quot;, { method = ngx.HTTP_POST, body = \u0026quot;hello\u0026quot; } },\n }\n\n if res1.status == ngx.HTTP_OK then\n     ...\n end\n\n if res2.body == \u0026quot;BLAH\u0026quot; then\n     ...\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003eres1\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres2\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres3\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture_multi\u003c/span\u003e{\n     { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, { \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea=3\u0026amp;b=4\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e} },\n     { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/bar\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e},\n     { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/baz\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, { \u003cspan class=\"pl-smi\"\u003emethod\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_POST\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ebody\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e} },\n }\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres1\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003estatus\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_OK\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres2\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ebody\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eBLAH\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis function will not return until all the subrequests terminate.\nThe total latency is the longest latency of the individual subrequests rather than the sum.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLua tables can be used for both requests and responses when the number of subrequests to be issued is not known in advance:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- construct the requests table\n local reqs = {}\n table.insert(reqs, { \u0026quot;/mysql\u0026quot; })\n table.insert(reqs, { \u0026quot;/postgres\u0026quot; })\n table.insert(reqs, { \u0026quot;/redis\u0026quot; })\n table.insert(reqs, { \u0026quot;/memcached\u0026quot; })\n\n -- issue all the requests at once and wait until they all return\n local resps = {\n     ngx.location.capture_multi(reqs)\n }\n\n -- loop over the responses table\n for i, resp in ipairs(resps) do\n     -- process the response table \u0026quot;resp\u0026quot;\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e construct the requests table\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n \u003cspan class=\"pl-c1\"\u003etable.insert\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e, { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/mysql\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\n \u003cspan class=\"pl-c1\"\u003etable.insert\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e, { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/postgres\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\n \u003cspan class=\"pl-c1\"\u003etable.insert\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e, { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/redis\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\n \u003cspan class=\"pl-c1\"\u003etable.insert\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e, { \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/memcached\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e issue all the requests at once and wait until they all return\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eresps\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture_multi\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ereqs\u003c/span\u003e)\n }\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e loop over the responses table\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eresp\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ein\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eipairs\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eresps\u003c/span\u003e) \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e process the response table \"resp\"\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e function is just a special form\nof this function. Logically speaking, the \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e can be implemented like this\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.location.capture =\n     function (uri, args)\n         return ngx.location.capture_multi({ {uri, args} })\n     end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecapture\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e (\u003cspan class=\"pl-smi\"\u003euri\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture_multi\u003c/span\u003e({ {\u003cspan class=\"pl-smi\"\u003euri\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e} })\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ePlease also refer to restrictions on capturing locations configured by \u003ca href=\"#locations-configured-by-subrequest-directives-of-other-modules\"\u003esubrequest directives of other modules\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.status\u003c/h2\u003e\u003ca id=\"user-content-ngxstatus\" class=\"anchor\" aria-label=\"Permalink: ngx.status\" href=\"#ngxstatus\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRead and write the current request's response status. This should be called\nbefore sending out the response headers.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.status = ngx.HTTP_CREATED\n status = ngx.status\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003estatus\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_CREATED\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003estatus\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003estatus\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSetting \u003ccode\u003engx.status\u003c/code\u003e after the response header is sent out has no effect but leaving an error message in your Nginx's error log file:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"attempt to set ngx.status after sending out response headers\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eattempt to set ngx.status after sending out response headers\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.header.HEADER\u003c/h2\u003e\u003ca id=\"user-content-ngxheaderheader\" class=\"anchor\" aria-label=\"Permalink: ngx.header.HEADER\" href=\"#ngxheaderheader\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.header.HEADER = VALUE\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003evalue = ngx.header.HEADER\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet, add to, or clear the current request's \u003ccode\u003eHEADER\u003c/code\u003e response header that is to be sent.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnderscores (\u003ccode\u003e_\u003c/code\u003e) in the header names will be replaced by hyphens (\u003ccode\u003e-\u003c/code\u003e) by default. This transformation can be turned off via the \u003ca href=\"#lua_transform_underscores_in_response_headers\"\u003elua_transform_underscores_in_response_headers\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe header names are matched case-insensitively.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- equivalent to ngx.header[\u0026quot;Content-Type\u0026quot;] = 'text/plain'\n ngx.header.content_type = 'text/plain'\n\n ngx.header[\u0026quot;X-My-Header\u0026quot;] = 'blah blah'\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e equivalent to ngx.header[\"Content-Type\"] = 'text/plain'\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003econtent_type\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003etext/plain\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-My-Header\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eblah blah\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eMulti-value headers can be set this way:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.header['Set-Cookie'] = {'a=32; path=/', 'b=4; path=/'}\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eSet-Cookie\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea=32; path=/\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eb=4; path=/\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill yield\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n Set-Cookie: a=32; path=/\n Set-Cookie: b=4; path=/\"\u003e\u003cpre\u003e Set-Cookie: a=32\u003cspan class=\"pl-k\"\u003e;\u003c/span\u003e path=/\n Set-Cookie: b=4\u003cspan class=\"pl-k\"\u003e;\u003c/span\u003e path=/\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ein the response headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly Lua tables are accepted (Only the last element in the table will take effect for standard headers such as \u003ccode\u003eContent-Type\u003c/code\u003e that only accept a single value).\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.header.content_type = {'a', 'b'}\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003econtent_type\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eb\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eis equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.header.content_type = 'b'\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003econtent_type\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003eb\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSetting a slot to \u003ccode\u003enil\u003c/code\u003e effectively removes it from the response headers:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.header[\u0026quot;X-My-Header\u0026quot;] = nil\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-My-Header\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe same applies to assigning an empty table:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.header[\u0026quot;X-My-Header\u0026quot;] = {}\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eheader\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-My-Header\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSetting \u003ccode\u003engx.header.HEADER\u003c/code\u003e after sending out response headers (either explicitly with \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e or implicitly with \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e and similar) will log an error message.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReading \u003ccode\u003engx.header.HEADER\u003c/code\u003e will return the value of the response header named \u003ccode\u003eHEADER\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnderscores (\u003ccode\u003e_\u003c/code\u003e) in the header names will also be replaced by dashes (\u003ccode\u003e-\u003c/code\u003e) and the header names will be matched case-insensitively. If the response header is not present at all, \u003ccode\u003enil\u003c/code\u003e will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is particularly useful in the context of \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     set $footer '';\n\n     proxy_pass http://some-backend;\n\n     header_filter_by_lua_block {\n         if ngx.header[\u0026quot;X-My-Header\u0026quot;] == \u0026quot;blah\u0026quot; then\n             ngx.var.footer = \u0026quot;some value\u0026quot;\n         end\n     }\n\n     echo_after_body $footer;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-v\"\u003e$footer\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e''\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://some-backend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     header_filter_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e ngx.header[\u003cspan class=\"pl-s\"\u003e\"X-My-Header\"\u003c/span\u003e] == \u003cspan class=\"pl-s\"\u003e\"blah\"\u003c/span\u003e then\n             ngx.var.footer = \u003cspan class=\"pl-s\"\u003e\"some value\"\u003c/span\u003e\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n     echo_after_body \u003cspan class=\"pl-v\"\u003e$footer\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eFor multi-value headers, all of the values of header will be collected in order and returned as a Lua table. For example, response headers\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Foo: bar\nFoo: baz\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eFoo: bar\nFoo: baz\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill result in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n {\u0026quot;bar\u0026quot;, \u0026quot;baz\u0026quot;}\"\u003e\u003cpre\u003e {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebar\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebaz\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eto be returned when reading \u003ccode\u003engx.header.Foo\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that \u003ccode\u003engx.header\u003c/code\u003e is not a normal Lua table and as such, it is not possible to iterate through it using the Lua \u003ccode\u003eipairs\u003c/code\u003e function.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote: this function throws a Lua error if \u003ccode\u003eHEADER\u003c/code\u003e or\n\u003ccode\u003eVALUE\u003c/code\u003e contain unsafe characters (control characters).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor reading \u003cem\u003erequest\u003c/em\u003e headers, use the \u003ca href=\"#ngxreqget_headers\"\u003engx.req.get_headers\u003c/a\u003e function instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.resp.get_headers\u003c/h2\u003e\u003ca id=\"user-content-ngxrespget_headers\" class=\"anchor\" aria-label=\"Permalink: ngx.resp.get_headers\" href=\"#ngxrespget_headers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eheaders, err = ngx.resp.get_headers(max_headers?, raw?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a Lua table holding all the current response headers for the current request.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local h, err = ngx.resp.get_headers()\n\n if err == \u0026quot;truncated\u0026quot; then\n     -- one can choose to ignore or reject the current response here\n end\n\n for k, v in pairs(h) do\n     ...\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eh\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eresp\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_headers\u003c/span\u003e()\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etruncated\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one can choose to ignore or reject the current response here\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ek\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ev\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ein\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003epairs\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eh\u003c/span\u003e) \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis function has the same signature as \u003ca href=\"#ngxreqget_headers\"\u003engx.req.get_headers\u003c/a\u003e except getting response headers instead of request headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that a maximum of 100 response headers are parsed by default (including those with the same name) and that additional response headers are silently discarded to guard against potential denial of service attacks. Since \u003ccode\u003ev0.10.13\u003c/code\u003e, when the limit is exceeded, it will return a second value which is the string \u003ccode\u003e\"truncated\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.9.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.is_internal\u003c/h2\u003e\u003ca id=\"user-content-ngxreqis_internal\" class=\"anchor\" aria-label=\"Permalink: ngx.req.is_internal\" href=\"#ngxreqis_internal\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eis_internal = ngx.req.is_internal()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a boolean indicating whether the current request is an \"internal request\", i.e.,\na request initiated from inside the current Nginx server instead of from the client side.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSubrequests are all internal requests and so are requests after internal redirects.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.start_time\u003c/h2\u003e\u003ca id=\"user-content-ngxreqstart_time\" class=\"anchor\" aria-label=\"Permalink: ngx.req.start_time\" href=\"#ngxreqstart_time\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esecs = ngx.req.start_time()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a floating-point number representing the timestamp (including milliseconds as the decimal part) when the current request was created.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe following example emulates the \u003ccode\u003e$request_time\u003c/code\u003e variable value (provided by \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_log_module.html\" rel=\"nofollow\"\u003engx_http_log_module\u003c/a\u003e) in pure Lua:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local request_time = ngx.now() - ngx.req.start_time()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003erequest_time\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003enow\u003c/span\u003e() \u003cspan class=\"pl-k\"\u003e-\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003estart_time\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.7.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxnow\"\u003engx.now\u003c/a\u003e and \u003ca href=\"#ngxupdate_time\"\u003engx.update_time\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.http_version\u003c/h2\u003e\u003ca id=\"user-content-ngxreqhttp_version\" class=\"anchor\" aria-label=\"Permalink: ngx.req.http_version\" href=\"#ngxreqhttp_version\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enum = ngx.req.http_version()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the HTTP version number for the current request as a Lua number.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCurrent possible values are 3.0, 2.0, 1.0, 1.1, and 0.9. Returns \u003ccode\u003enil\u003c/code\u003e for unrecognized values.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.7.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.raw_header\u003c/h2\u003e\u003ca id=\"user-content-ngxreqraw_header\" class=\"anchor\" aria-label=\"Permalink: ngx.req.raw_header\" href=\"#ngxreqraw_header\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.req.raw_header(no_request_line?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the original raw HTTP protocol header received by the Nginx server.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBy default, the request line and trailing \u003ccode\u003eCR LF\u003c/code\u003e terminator will also be included. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.print(ngx.req.raw_header())\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eraw_header\u003c/span\u003e())\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003egives something like this:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"GET /t HTTP/1.1\nHost: localhost\nConnection: close\nFoo: bar\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eGET /t HTTP/1.1\nHost: localhost\nConnection: close\nFoo: bar\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eYou can specify the optional\n\u003ccode\u003eno_request_line\u003c/code\u003e argument as a \u003ccode\u003etrue\u003c/code\u003e value to exclude the request line from the result. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.print(ngx.req.raw_header(true))\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eraw_header\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e))\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eoutputs something like this:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Host: localhost\nConnection: close\nFoo: bar\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eHost: localhost\nConnection: close\nFoo: bar\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.7.17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method does not work in HTTP/2 requests yet.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_method\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_method\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_method\" href=\"#ngxreqget_method\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003emethod_name = ngx.req.get_method()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, balancer_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the current request's request method name. Strings like \u003ccode\u003e\"GET\"\u003c/code\u003e and \u003ccode\u003e\"POST\"\u003c/code\u003e are returned instead of numerical \u003ca href=\"#http-method-constants\"\u003emethod constants\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the current request is an Nginx subrequest, then the subrequest's method name will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.5.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqset_method\"\u003engx.req.set_method\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_method\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_method\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_method\" href=\"#ngxreqset_method\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_method(method_id)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOverrides the current request's request method with the \u003ccode\u003emethod_id\u003c/code\u003e argument. Currently only numerical \u003ca href=\"#http-method-constants\"\u003emethod constants\u003c/a\u003e are supported, like \u003ccode\u003engx.HTTP_POST\u003c/code\u003e and \u003ccode\u003engx.HTTP_GET\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the current request is an Nginx subrequest, then the subrequest's method will be overridden.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.5.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqget_method\"\u003engx.req.get_method\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_uri\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_uri\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_uri\" href=\"#ngxreqset_uri\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_uri(uri, jump?, binary?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRewrite the current request's (parsed) URI by the \u003ccode\u003euri\u003c/code\u003e argument. The \u003ccode\u003euri\u003c/code\u003e argument must be a Lua string and cannot be of zero length, or a Lua exception will be thrown.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional boolean \u003ccode\u003ejump\u003c/code\u003e argument can trigger location rematch (or location jump) as \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e's \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite\" rel=\"nofollow\"\u003erewrite\u003c/a\u003e directive, that is, when \u003ccode\u003ejump\u003c/code\u003e is \u003ccode\u003etrue\u003c/code\u003e (default to \u003ccode\u003efalse\u003c/code\u003e), this function will never return and it will tell Nginx to try re-searching locations with the new URI value at the later \u003ccode\u003epost-rewrite\u003c/code\u003e phase and jumping to the new location.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLocation jump will not be triggered otherwise, and only the current request's URI will be modified, which is also the default behavior. This function will return but with no returned values when the \u003ccode\u003ejump\u003c/code\u003e argument is \u003ccode\u003efalse\u003c/code\u003e or absent altogether.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example, the following Nginx config snippet\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite ^ /foo last;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /foo last\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ecan be coded in Lua like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri(\u0026quot;/foo\u0026quot;, true)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSimilarly, Nginx config\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite ^ /foo break;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /foo \u003cspan class=\"pl-c1\"\u003ebreak\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ecan be coded in Lua as\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri(\u0026quot;/foo\u0026quot;, false)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003efalse\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eor equivalently,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri(\u0026quot;/foo\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003ejump\u003c/code\u003e argument can only be set to \u003ccode\u003etrue\u003c/code\u003e in \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e. Use of jump in other contexts is prohibited and will throw out a Lua exception.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eA more sophisticated example involving regex substitutions is as follows\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     rewrite_by_lua_block {\n         local uri = ngx.re.sub(ngx.var.uri, \u0026quot;^/test/(.*)\u0026quot;, \u0026quot;/$1\u0026quot;, \u0026quot;o\u0026quot;)\n         ngx.req.set_uri(uri)\n     }\n     proxy_pass http://my_backend;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     rewrite_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local uri = ngx.re.sub\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.var.uri, \u003cspan class=\"pl-s\"\u003e\"^/test/(.*)\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"/$1\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"o\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.req.set_uri\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003euri\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://my_backend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhich is functionally equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     rewrite ^/test/(.*) /$1 break;\n     proxy_pass http://my_backend;\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^/test/\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e.*\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e /\u003cspan class=\"pl-v\"\u003e$1\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ebreak\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e://my_backend\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote: this function throws a Lua error if the \u003ccode\u003euri\u003c/code\u003e argument\ncontains unsafe characters (control characters).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that it is not possible to use this interface to rewrite URI arguments and that \u003ca href=\"#ngxreqset_uri_args\"\u003engx.req.set_uri_args\u003c/a\u003e should be used for this instead. For instance, Nginx config\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite ^ /foo?a=3? last;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /foo?a=3? last\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ecan be coded as\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri_args(\u0026quot;a=3\u0026quot;)\n ngx.req.set_uri(\u0026quot;/foo\u0026quot;, true)\"\u003e\u003cpre\u003e ngx.req.set_uri_args\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"a=3\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n ngx.req.set_uri\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/foo\"\u003c/span\u003e, true\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eor\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri_args({a = 3})\n ngx.req.set_uri(\u0026quot;/foo\u0026quot;, true)\"\u003e\u003cpre\u003e ngx.req.set_uri_args\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003ea = 3\u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n ngx.req.set_uri\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"/foo\"\u003c/span\u003e, true\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eStarting from \u003ccode\u003e0.10.16\u003c/code\u003e of this module, this function accepts an\noptional boolean \u003ccode\u003ebinary\u003c/code\u003e argument to allow arbitrary binary URI\ndata. By default, this \u003ccode\u003ebinary\u003c/code\u003e argument is false and this function\nwill throw out a Lua error such as the one below when the \u003ccode\u003euri\u003c/code\u003e\nargument contains any control characters (ASCII Code 0 ~ 0x08, 0x0A ~ 0x1F and 0x7F).\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[error] 23430#23430: *1 lua entry thread aborted: runtime error:\ncontent_by_lua(nginx.conf:44):3: ngx.req.set_uri unsafe byte \u0026quot;0x00\u0026quot;\nin \u0026quot;\\x00foo\u0026quot; (maybe you want to set the 'binary' argument?)\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e[error] 23430#23430: *1 lua entry thread aborted: runtime error:\ncontent_by_lua(nginx.conf:44):3: ngx.req.set_uri unsafe byte \"0x00\"\nin \"\\x00foo\" (maybe you want to set the 'binary' argument?)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis interface was first introduced in the \u003ccode\u003ev0.3.1rc14\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_uri_args\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_uri_args\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_uri_args\" href=\"#ngxreqset_uri_args\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_uri_args(args)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRewrite the current request's URI query arguments by the \u003ccode\u003eargs\u003c/code\u003e argument. The \u003ccode\u003eargs\u003c/code\u003e argument can be either a Lua string, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri_args(\u0026quot;a=3\u0026amp;b=hello%20world\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri_args\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea=3\u0026amp;b=hello%20world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eor a Lua table holding the query arguments' key-value pairs, as in\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri_args({ a = 3, b = \u0026quot;hello world\u0026quot; })\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri_args\u003c/span\u003e({ \u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello world\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIn the former case, i.e., when the whole query-string is provided directly,\nthe input Lua string should already be well-formed with the URI encoding.\nFor security considerations, this method will automatically escape any control and\nwhitespace characters (ASCII code 0x00 ~ 0x20 and 0x7F) in the Lua string.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn the latter case, this method will escape argument keys and values according to the URI escaping rule.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eMulti-value arguments are also supported:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_uri_args({ a = 3, b = {5, 6} })\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_uri_args\u003c/span\u003e({ \u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\u003cspan class=\"pl-c1\"\u003e5\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e6\u003c/span\u003e} })\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhich will result in a query string like \u003ccode\u003ea=3\u0026amp;b=5\u0026amp;b=6\u003c/code\u003e or \u003ccode\u003eb=5\u0026amp;b=6\u0026amp;a=3\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote that when using Lua table as the \u003ccode\u003earg\u003c/code\u003e argument, the order of the arguments in the result query string which change from time to time. If you would like to get an ordered result, you need to use Lua string as the \u003ccode\u003earg\u003c/code\u003e argument.\u003c/strong\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis interface was first introduced in the \u003ccode\u003ev0.3.1rc13\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqset_uri\"\u003engx.req.set_uri\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_uri_args\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_uri_args\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_uri_args\" href=\"#ngxreqget_uri_args\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eargs, err = ngx.req.get_uri_args(max_args?, tab?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a Lua table holding all the current request URL query arguments. An optional \u003ccode\u003etab\u003c/code\u003e argument\ncan be used to reuse the table returned by this method.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location = /test {\n     content_by_lua_block {\n         local args, err = ngx.req.get_uri_args()\n\n         if err == \u0026quot;truncated\u0026quot; then\n             -- one can choose to ignore or reject the current request here\n         end\n\n         for key, val in pairs(args) do\n             if type(val) == \u0026quot;table\u0026quot; then\n                 ngx.say(key, \u0026quot;: \u0026quot;, table.concat(val, \u0026quot;, \u0026quot;))\n             else\n                 ngx.say(key, \u0026quot;: \u0026quot;, val)\n             end\n         end\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local args, err = ngx.req.get_uri_args\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e err == \u003cspan class=\"pl-s\"\u003e\"truncated\"\u003c/span\u003e then\n             -- one can choose to ignore or reject the current request here\n         end\n\n         \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e key, val in pairs\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eargs\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e do\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e type\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eval\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e == \u003cspan class=\"pl-s\"\u003e\"table\"\u003c/span\u003e then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ekey, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, table.concat\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eval, \u003cspan class=\"pl-s\"\u003e\", \"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n             else\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ekey, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, val\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen \u003ccode\u003eGET /test?foo=bar\u0026amp;bar=baz\u0026amp;bar=blah\u003c/code\u003e will yield the response body\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo: bar\n bar: baz, blah\"\u003e\u003cpre\u003e foo: bar\n bar: baz, blah\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eMultiple occurrences of an argument key will result in a table value holding all the values for that key in order.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eKeys and values are unescaped according to URI escaping rules. In the settings above, \u003ccode\u003eGET /test?a%20b=1%61+2\u003c/code\u003e will yield:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n a b: 1a 2\"\u003e\u003cpre\u003e a b: 1a 2\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eArguments without the \u003ccode\u003e=\u0026lt;value\u0026gt;\u003c/code\u003e parts are treated as boolean arguments. \u003ccode\u003eGET /test?foo\u0026amp;bar\u003c/code\u003e will yield:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo: true\n bar: true\"\u003e\u003cpre\u003e foo: \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e\n bar: \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, they will take Lua boolean values \u003ccode\u003etrue\u003c/code\u003e. However, they are different from arguments taking empty string values. \u003ccode\u003eGET /test?foo=\u0026amp;bar=\u003c/code\u003e will give something like\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo:\n bar:\"\u003e\u003cpre\u003e foo:\n bar:\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eEmpty key arguments are discarded. \u003ccode\u003eGET /test?=hello\u0026amp;=world\u003c/code\u003e will yield an empty output for instance.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUpdating query arguments via the Nginx variable \u003ccode\u003e$args\u003c/code\u003e (or \u003ccode\u003engx.var.args\u003c/code\u003e in Lua) at runtime is also supported:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.var.args = \u0026quot;a=3\u0026amp;b=42\u0026quot;\n local args, err = ngx.req.get_uri_args()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003evar\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea=3\u0026amp;b=42\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_uri_args\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere the \u003ccode\u003eargs\u003c/code\u003e table will always look like\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n {a = 3, b = 42}\"\u003e\u003cpre\u003e {\u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e42\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eregardless of the actual request query string.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that a maximum of 100 request arguments are parsed by default (including those with the same name) and that additional request arguments are silently discarded to guard against potential denial of service attacks. Since \u003ccode\u003ev0.10.13\u003c/code\u003e, when the limit is exceeded, it will return a second value which is the string \u003ccode\u003e\"truncated\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHowever, the optional \u003ccode\u003emax_args\u003c/code\u003e function argument can be used to override this limit:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local args, err = ngx.req.get_uri_args(10)\n if err == \u0026quot;truncated\u0026quot; then\n     -- one can choose to ignore or reject the current request here\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_uri_args\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etruncated\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one can choose to ignore or reject the current request here\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis argument can be set to zero to remove the limit and to process all request arguments received:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local args, err = ngx.req.get_uri_args(0)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_uri_args\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRemoving the \u003ccode\u003emax_args\u003c/code\u003e cap is strongly discouraged.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_post_args\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_post_args\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_post_args\" href=\"#ngxreqget_post_args\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eargs, err = ngx.req.get_post_args(max_args?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a Lua table holding all the current request POST query arguments (of the MIME type \u003ccode\u003eapplication/x-www-form-urlencoded\u003c/code\u003e). Call \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e to read the request body first or turn on the \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e directive to avoid errors.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location = /test {\n     content_by_lua_block {\n         ngx.req.read_body()\n         local args, err = ngx.req.get_post_args()\n\n         if err == \u0026quot;truncated\u0026quot; then\n             -- one can choose to ignore or reject the current request here\n         end\n\n         if not args then\n             ngx.say(\u0026quot;failed to get post args: \u0026quot;, err)\n             return\n         end\n         for key, val in pairs(args) do\n             if type(val) == \u0026quot;table\u0026quot; then\n                 ngx.say(key, \u0026quot;: \u0026quot;, table.concat(val, \u0026quot;, \u0026quot;))\n             else\n                 ngx.say(key, \u0026quot;: \u0026quot;, val)\n             end\n         end\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.req.read_body\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         local args, err = ngx.req.get_post_args\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e err == \u003cspan class=\"pl-s\"\u003e\"truncated\"\u003c/span\u003e then\n             -- one can choose to ignore or reject the current request here\n         end\n\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not args then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to get post args: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e key, val in pairs\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eargs\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e do\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e type\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eval\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e == \u003cspan class=\"pl-s\"\u003e\"table\"\u003c/span\u003e then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ekey, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, table.concat\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eval, \u003cspan class=\"pl-s\"\u003e\", \"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n             else\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003ekey, \u003cspan class=\"pl-s\"\u003e\": \"\u003c/span\u003e, val\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # Post request with the body 'foo=bar\u0026amp;bar=baz\u0026amp;bar=blah'\n $ curl --data 'foo=bar\u0026amp;bar=baz\u0026amp;bar=blah' localhost/test\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e Post request with the body 'foo=bar\u0026amp;bar=baz\u0026amp;bar=blah'\u003c/span\u003e\n $ curl --data \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003efoo=bar\u0026amp;bar=baz\u0026amp;bar=blah\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e localhost/test\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill yield the response body like\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo: bar\n bar: baz, blah\"\u003e\u003cpre\u003e foo: bar\n bar: baz, blah\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eMultiple occurrences of an argument key will result in a table value holding all of the values for that key in order.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eKeys and values will be unescaped according to URI escaping rules.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWith the settings above,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n # POST request with body 'a%20b=1%61+2'\n $ curl -d 'a%20b=1%61+2' localhost/test\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e#\u003c/span\u003e POST request with body 'a%20b=1%61+2'\u003c/span\u003e\n $ curl -d \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea%20b=1%61+2\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e localhost/test\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill yield:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n a b: 1a 2\"\u003e\u003cpre\u003e a b: 1a 2\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eArguments without the \u003ccode\u003e=\u0026lt;value\u0026gt;\u003c/code\u003e parts are treated as boolean arguments. \u003ccode\u003ePOST /test\u003c/code\u003e with the request body \u003ccode\u003efoo\u0026amp;bar\u003c/code\u003e will yield:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo: true\n bar: true\"\u003e\u003cpre\u003e foo: \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e\n bar: \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThat is, they will take Lua boolean values \u003ccode\u003etrue\u003c/code\u003e. However, they are different from arguments taking empty string values. \u003ccode\u003ePOST /test\u003c/code\u003e with request body \u003ccode\u003efoo=\u0026amp;bar=\u003c/code\u003e will return something like\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n foo:\n bar:\"\u003e\u003cpre\u003e foo:\n bar:\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eEmpty key arguments are discarded. \u003ccode\u003ePOST /test\u003c/code\u003e with body \u003ccode\u003e=hello\u0026amp;=world\u003c/code\u003e will yield empty outputs for instance.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that a maximum of 100 request arguments are parsed by default (including those with the same name) and that additional request arguments are silently discarded to guard against potential denial of service attacks. Since \u003ccode\u003ev0.10.13\u003c/code\u003e, when the limit is exceeded, it will return a second value which is the string \u003ccode\u003e\"truncated\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHowever, the optional \u003ccode\u003emax_args\u003c/code\u003e function argument can be used to override this limit:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local args, err = ngx.req.get_post_args(10)\n if err == \u0026quot;truncated\u0026quot; then\n     -- one can choose to ignore or reject the current request here\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_post_args\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etruncated\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one can choose to ignore or reject the current request here\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis argument can be set to zero to remove the limit and to process all request arguments received:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local args, err = ngx.req.get_post_args(0)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_post_args\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRemoving the \u003ccode\u003emax_args\u003c/code\u003e cap is strongly discouraged.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_headers\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_headers\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_headers\" href=\"#ngxreqget_headers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eheaders, err = ngx.req.get_headers(max_headers?, raw?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a Lua table holding all the current request headers.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local h, err = ngx.req.get_headers()\n\n if err == \u0026quot;truncated\u0026quot; then\n     -- one can choose to ignore or reject the current request here\n end\n\n for k, v in pairs(h) do\n     ...\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eh\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_headers\u003c/span\u003e()\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etruncated\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one can choose to ignore or reject the current request here\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ek\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ev\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ein\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003epairs\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eh\u003c/span\u003e) \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eTo read an individual header:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(\u0026quot;Host: \u0026quot;, ngx.req.get_headers()[\u0026quot;Host\u0026quot;])\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eHost: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_headers\u003c/span\u003e()[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eHost\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e])\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that the \u003ca href=\"#ngxvarvariable\"\u003engx.var.HEADER\u003c/a\u003e API call, which uses core \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#var_http_\" rel=\"nofollow\"\u003e$http_HEADER\u003c/a\u003e variables, may be more preferable for reading individual request headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor multiple instances of request headers such as:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n Foo: foo\n Foo: bar\n Foo: baz\"\u003e\u003cpre\u003e Foo: foo\n Foo: bar\n Foo: baz\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ethe value of \u003ccode\u003engx.req.get_headers()[\"Foo\"]\u003c/code\u003e will be a Lua (array) table such as:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n {\u0026quot;foo\u0026quot;, \u0026quot;bar\u0026quot;, \u0026quot;baz\u0026quot;}\"\u003e\u003cpre\u003e {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efoo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebar\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ebaz\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that a maximum of 100 request headers are parsed by default (including those with the same name) and that additional request headers are silently discarded to guard against potential denial of service attacks. Since \u003ccode\u003ev0.10.13\u003c/code\u003e, when the limit is exceeded, it will return a second value which is the string \u003ccode\u003e\"truncated\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHowever, the optional \u003ccode\u003emax_headers\u003c/code\u003e function argument can be used to override this limit:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local headers, err = ngx.req.get_headers(10)\n\n if err == \u0026quot;truncated\u0026quot; then\n     -- one can choose to ignore or reject the current request here\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_headers\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etruncated\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one can choose to ignore or reject the current request here\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis argument can be set to zero to remove the limit and to process all request headers received:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local headers, err = ngx.req.get_headers(0)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_headers\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRemoving the \u003ccode\u003emax_headers\u003c/code\u003e cap is strongly discouraged.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003e0.6.9\u003c/code\u003e release, all the header names in the Lua table returned are converted to the pure lower-case form by default, unless the \u003ccode\u003eraw\u003c/code\u003e argument is set to \u003ccode\u003etrue\u003c/code\u003e (default to \u003ccode\u003efalse\u003c/code\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso, by default, an \u003ccode\u003e__index\u003c/code\u003e metamethod is added to the resulting Lua table and will normalize the keys to a pure lowercase form with all underscores converted to dashes in case of a lookup miss. For example, if a request header \u003ccode\u003eMy-Foo-Header\u003c/code\u003e is present, then the following invocations will all pick up the value of this header correctly:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(headers.my_foo_header)\n ngx.say(headers[\u0026quot;My-Foo-Header\u0026quot;])\n ngx.say(headers[\u0026quot;my-foo-header\u0026quot;])\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003emy_foo_header\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMy-Foo-Header\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e])\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eheaders\u003c/span\u003e[\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emy-foo-header\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e])\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003e__index\u003c/code\u003e metamethod will not be added when the \u003ccode\u003eraw\u003c/code\u003e argument is set to \u003ccode\u003etrue\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_header\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_header\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_header\" href=\"#ngxreqset_header\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_header(header_name, header_value)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet the current request's request header named \u003ccode\u003eheader_name\u003c/code\u003e to value \u003ccode\u003eheader_value\u003c/code\u003e, overriding any existing ones.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe input Lua string \u003ccode\u003eheader_name\u003c/code\u003e and \u003ccode\u003eheader_value\u003c/code\u003e should already be well-formed with the URI encoding.\nFor security considerations, this method will automatically escape \" \", \"\"\", \"(\", \")\", \",\", \"/\", \":\", \";\", \"?\",\n\"\u0026lt;\", \"=\", \"\u0026gt;\", \"?\", \"@\", \"[\", \"]\", \"\", \"{\", \"}\", 0x00-0x1F, 0x7F-0xFF in \u003ccode\u003eheader_name\u003c/code\u003e and automatically escape\n\"0x00-0x08, 0x0A-0x0F, 0x7F in \u003ccode\u003eheader_value\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBy default, all the subrequests subsequently initiated by \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e and \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e will inherit the new header.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is not a Lua's equivalent of nginx \u003ccode\u003eproxy_set_header\u003c/code\u003e directive (same is true about \u003ca href=\"#ngxreqclear_header\"\u003engx.req.clear_header\u003c/a\u003e). \u003ccode\u003eproxy_set_header\u003c/code\u003e only affects the upstream request while \u003ccode\u003engx.req.set_header\u003c/code\u003e change the incoming request. Record the http headers in the access log file will show the difference. But you still can use it as an alternative of nginx \u003ccode\u003eproxy_set_header\u003c/code\u003e directive as long as you know the difference.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example of setting the \u003ccode\u003eContent-Type\u003c/code\u003e header:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_header(\u0026quot;Content-Type\u0026quot;, \u0026quot;text/css\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_header\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eContent-Type\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etext/css\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eheader_value\u003c/code\u003e can take an array list of values,\nfor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_header(\u0026quot;Foo\u0026quot;, {\u0026quot;a\u0026quot;, \u0026quot;abc\u0026quot;})\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_header\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eFoo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eabc\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill produce two new request headers:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n Foo: a\n Foo: abc\"\u003e\u003cpre\u003e Foo: a\n Foo: abc\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eand old \u003ccode\u003eFoo\u003c/code\u003e headers will be overridden if there is any.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the \u003ccode\u003eheader_value\u003c/code\u003e argument is \u003ccode\u003enil\u003c/code\u003e, the request header will be removed. So\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.set_header(\u0026quot;X-Foo\u0026quot;, nil)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_header\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-Foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eis equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.clear_header(\u0026quot;X-Foo\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eclear_header\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eX-Foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote: this function throws a Lua error if \u003ccode\u003eheader_name\u003c/code\u003e or\n\u003ccode\u003eheader_value\u003c/code\u003e contain unsafe characters (control characters).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.clear_header\u003c/h2\u003e\u003ca id=\"user-content-ngxreqclear_header\" class=\"anchor\" aria-label=\"Permalink: ngx.req.clear_header\" href=\"#ngxreqclear_header\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.clear_header(header_name)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eClears the current request's request header named \u003ccode\u003eheader_name\u003c/code\u003e. None of the current request's existing subrequests will be affected but subsequently initiated subrequests will inherit the change by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.read_body\u003c/h2\u003e\u003ca id=\"user-content-ngxreqread_body\" class=\"anchor\" aria-label=\"Permalink: ngx.req.read_body\" href=\"#ngxreqread_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.read_body()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReads the client request body synchronously without blocking the Nginx event loop.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.read_body()\n local args = ngx.req.get_post_args()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eread_body\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget_post_args\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf the request body is already read previously by turning on \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e or by using other modules, then this function does not run and returns immediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has already been explicitly discarded, either by the \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e function or other modules, this function does not run and returns immediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of errors, such as connection errors while reading the data, this method will throw out a Lua exception \u003cem\u003eor\u003c/em\u003e terminate the current request with a 500 status code immediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe request body data read using this function can be retrieved later via \u003ca href=\"#ngxreqget_body_data\"\u003engx.req.get_body_data\u003c/a\u003e or, alternatively, the temporary file name for the body data cached to disk using \u003ca href=\"#ngxreqget_body_file\"\u003engx.req.get_body_file\u003c/a\u003e. This depends on\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ewhether the current request body is already larger than the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size\" rel=\"nofollow\"\u003eclient_body_buffer_size\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003eand whether \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_file_only\" rel=\"nofollow\"\u003eclient_body_in_file_only\u003c/a\u003e has been switched on.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eIn cases where current request may have a request body and the request body data is not required, The \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e function must be used to explicitly discard the request body to avoid breaking things under HTTP 1.1 keepalive or HTTP 1.1 pipelining.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.discard_body\u003c/h2\u003e\u003ca id=\"user-content-ngxreqdiscard_body\" class=\"anchor\" aria-label=\"Permalink: ngx.req.discard_body\" href=\"#ngxreqdiscard_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.discard_body()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExplicitly discard the request body, i.e., read the data on the connection and throw it away immediately (without using the request body by any means).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function is an asynchronous call and returns immediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has already been read, this function does nothing and returns immediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_body_data\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_body_data\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_body_data\" href=\"#ngxreqget_body_data\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edata = ngx.req.get_body_data(max_bytes?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves in-memory request body data. It returns a Lua string rather than a Lua table holding all the parsed query arguments. Use the \u003ca href=\"#ngxreqget_post_args\"\u003engx.req.get_post_args\u003c/a\u003e function instead if a Lua table is required.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003emax_bytes\u003c/code\u003e argument can be used when you don't need the entire body.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns \u003ccode\u003enil\u003c/code\u003e if\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ethe request body has not been read,\u003c/li\u003e\n\u003cli\u003ethe request body has been read into disk temporary files,\u003c/li\u003e\n\u003cli\u003eor the request body has zero size.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has not been read yet, call \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e first (or turn on \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e to force this module to read the request body. This is not recommended however).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has been read into disk files, try calling the \u003ca href=\"#ngxreqget_body_file\"\u003engx.req.get_body_file\u003c/a\u003e function instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo force in-memory request bodies, try setting \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size\" rel=\"nofollow\"\u003eclient_body_buffer_size\u003c/a\u003e to the same size value in \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size\" rel=\"nofollow\"\u003eclient_max_body_size\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that calling this function instead of using \u003ccode\u003engx.var.request_body\u003c/code\u003e or \u003ccode\u003engx.var.echo_request_body\u003c/code\u003e is more efficient because it can save one dynamic memory allocation and one data copy.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqget_body_file\"\u003engx.req.get_body_file\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.get_body_file\u003c/h2\u003e\u003ca id=\"user-content-ngxreqget_body_file\" class=\"anchor\" aria-label=\"Permalink: ngx.req.get_body_file\" href=\"#ngxreqget_body_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003efile_name = ngx.req.get_body_file()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the file name for the in-file request body data. Returns \u003ccode\u003enil\u003c/code\u003e if the request body has not been read or has been read into memory.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe returned file is read only and is usually cleaned up by Nginx's memory pool. It should not be manually modified, renamed, or removed in Lua code.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has not been read yet, call \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e first (or turn on \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e to force this module to read the request body. This is not recommended however).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has been read into memory, try calling the \u003ca href=\"#ngxreqget_body_data\"\u003engx.req.get_body_data\u003c/a\u003e function instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo force in-file request bodies, try turning on \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_file_only\" rel=\"nofollow\"\u003eclient_body_in_file_only\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this function is also work for balancer phase but it needs to call \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#recreate_request\"\u003ebalancer.recreate_request\u003c/a\u003e to make the change take effect after set the request body data or headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqget_body_data\"\u003engx.req.get_body_data\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_body_data\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_body_data\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_body_data\" href=\"#ngxreqset_body_data\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_body_data(data)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, balancer_by_lua*,\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet the current request's request body using the in-memory data specified by the \u003ccode\u003edata\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has not been read yet, call \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e first (or turn on \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e to force this module to read the request body. This is not recommended however). Additionally, the request body must not have been previously discarded by \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhether the previous request body has been read into memory or buffered into a disk file, it will be freed or the disk file will be cleaned up immediately, respectively.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this function is also work for balancer phase but it needs to call \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#recreate_request\"\u003ebalancer.recreate_request\u003c/a\u003e to make the change take effect after set the request body data or headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqset_body_file\"\u003engx.req.set_body_file\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.set_body_file\u003c/h2\u003e\u003ca id=\"user-content-ngxreqset_body_file\" class=\"anchor\" aria-label=\"Permalink: ngx.req.set_body_file\" href=\"#ngxreqset_body_file\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.set_body_file(file_name, auto_clean?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, balancer_by_lua*,\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet the current request's request body using the in-file data specified by the \u003ccode\u003efile_name\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the request body has not been read yet, call \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e first (or turn on \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e to force this module to read the request body. This is not recommended however). Additionally, the request body must not have been previously discarded by \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the optional \u003ccode\u003eauto_clean\u003c/code\u003e argument is given a \u003ccode\u003etrue\u003c/code\u003e value, then this file will be removed at request completion or the next time this function or \u003ca href=\"#ngxreqset_body_data\"\u003engx.req.set_body_data\u003c/a\u003e are called in the same request. The \u003ccode\u003eauto_clean\u003c/code\u003e is default to \u003ccode\u003efalse\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease ensure that the file specified by the \u003ccode\u003efile_name\u003c/code\u003e argument exists and is readable by an Nginx worker process by setting its permission properly to avoid Lua exception errors.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhether the previous request body has been read into memory or buffered into a disk file, it will be freed or the disk file will be cleaned up immediately, respectively.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqset_body_data\"\u003engx.req.set_body_data\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.init_body\u003c/h2\u003e\u003ca id=\"user-content-ngxreqinit_body\" class=\"anchor\" aria-label=\"Permalink: ngx.req.init_body\" href=\"#ngxreqinit_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.init_body(buffer_size?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCreates a new blank request body for the current request and initializes the buffer for later request body data writing via the \u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e and \u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e APIs.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the \u003ccode\u003ebuffer_size\u003c/code\u003e argument is specified, then its value will be used for the size of the memory buffer for body writing with \u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e. If the argument is omitted, then the value specified by the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size\" rel=\"nofollow\"\u003eclient_body_buffer_size\u003c/a\u003e directive will be used instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the data can no longer be hold in the memory buffer for the request body, then the data will be flushed onto a temporary file just like the standard request body reader in the Nginx core.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is important to always call the \u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e after all the data has been appended onto the current request body. Also, when this function is used together with \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e, it is required to call \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e \u003cem\u003ebefore\u003c/em\u003e this function, or you will get the \"request body already exists\" error message.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe usage of this function is often like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.req.init_body(128 * 1024)  -- buffer is 128KB\n for chunk in next_data_chunk() do\n     ngx.req.append_body(chunk) -- each chunk can be 4KB\n end\n ngx.req.finish_body()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003einit_body\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e128\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e1024\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e buffer is 128KB\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003echunk\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ein\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003enext_data_chunk\u003c/span\u003e() \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eappend_body\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003echunk\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e each chunk can be 4KB\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ereq\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003efinish_body\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis function can be used with \u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e, \u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e, and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e to implement efficient input filters in pure Lua (in the context of \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e or \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e), which can be used with other Nginx content handler or upstream modules like \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_http_proxy_module\u003c/a\u003e and \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html\" rel=\"nofollow\"\u003engx_http_fastcgi_module\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.5.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.append_body\u003c/h2\u003e\u003ca id=\"user-content-ngxreqappend_body\" class=\"anchor\" aria-label=\"Permalink: ngx.req.append_body\" href=\"#ngxreqappend_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.append_body(data_chunk)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAppend new data chunk specified by the \u003ccode\u003edata_chunk\u003c/code\u003e argument onto the existing request body created by the \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e call.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the data can no longer be hold in the memory buffer for the request body, then the data will be flushed onto a temporary file just like the standard request body reader in the Nginx core.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is important to always call the \u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e after all the data has been appended onto the current request body.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function can be used with \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e, \u003ca href=\"#ngxreqfinish_body\"\u003engx.req.finish_body\u003c/a\u003e, and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e to implement efficient input filters in pure Lua (in the context of \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e or \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e), which can be used with other Nginx content handler or upstream modules like \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_http_proxy_module\u003c/a\u003e and \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html\" rel=\"nofollow\"\u003engx_http_fastcgi_module\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.5.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.finish_body\u003c/h2\u003e\u003ca id=\"user-content-ngxreqfinish_body\" class=\"anchor\" aria-label=\"Permalink: ngx.req.finish_body\" href=\"#ngxreqfinish_body\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.req.finish_body()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCompletes the construction process of the new request body created by the \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e and \u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e calls.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function can be used with \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e, \u003ca href=\"#ngxreqappend_body\"\u003engx.req.append_body\u003c/a\u003e, and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e to implement efficient input filters in pure Lua (in the context of \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e or \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e), which can be used with other Nginx content handler or upstream modules like \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_http_proxy_module\u003c/a\u003e and \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html\" rel=\"nofollow\"\u003engx_http_fastcgi_module\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.5.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxreqinit_body\"\u003engx.req.init_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.req.socket\u003c/h2\u003e\u003ca id=\"user-content-ngxreqsocket\" class=\"anchor\" aria-label=\"Permalink: ngx.req.socket\" href=\"#ngxreqsocket\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock, err = ngx.req.socket()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock, err = ngx.req.socket(raw)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a read-only cosocket object that wraps the downstream connection. Only \u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e, \u003ca href=\"#tcpsockreceiveany\"\u003ereceiveany\u003c/a\u003e and \u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e methods are supported on this object.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of error, \u003ccode\u003enil\u003c/code\u003e will be returned as well as a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e This method will block while waiting for client request body to be fully received. Block time depends on the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_timeout\" rel=\"nofollow\"\u003eclient_body_timeout\u003c/a\u003e directive and maximum body size specified by the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size\" rel=\"nofollow\"\u003eclient_max_body_size\u003c/a\u003e directive. If read timeout occurs or client body size exceeds the defined limit, this function will not return and \u003ccode\u003e408 Request Time-out\u003c/code\u003e or \u003ccode\u003e413 Request Entity Too Large\u003c/code\u003e response will be returned to the client instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe socket object returned by this method is usually used to read the current request's body in a streaming fashion. Do not turn on the \u003ca href=\"#lua_need_request_body\"\u003elua_need_request_body\u003c/a\u003e directive, and do not mix this call with \u003ca href=\"#ngxreqread_body\"\u003engx.req.read_body\u003c/a\u003e and \u003ca href=\"#ngxreqdiscard_body\"\u003engx.req.discard_body\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf any request body data has been pre-read into the Nginx core request header buffer, the resulting cosocket object will take care of this to avoid potential data loss resulting from such pre-reading.\nChunked request bodies are not yet supported in this API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003ev0.9.0\u003c/code\u003e release, this function accepts an optional boolean \u003ccode\u003eraw\u003c/code\u003e argument. When this argument is \u003ccode\u003etrue\u003c/code\u003e, this function returns a full-duplex cosocket object wrapping around the raw downstream connection socket, upon which you can call the \u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e, \u003ca href=\"#tcpsockreceiveany\"\u003ereceiveany\u003c/a\u003e, \u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e, and \u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e methods.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the \u003ccode\u003eraw\u003c/code\u003e argument is \u003ccode\u003etrue\u003c/code\u003e, it is required that no pending data from any previous \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e, \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e, or \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e calls exists. So if you have these downstream output calls previously, you should call \u003ca href=\"#ngxflush\"\u003engx.flush(true)\u003c/a\u003e before calling \u003ccode\u003engx.req.socket(true)\u003c/code\u003e to ensure that there is no pending output data. If the request body has not been read yet, then this \"raw socket\" can also be used to read the request body.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can use the \"raw request socket\" returned by \u003ccode\u003engx.req.socket(true)\u003c/code\u003e to implement fancy protocols like \u003ca href=\"https://en.wikipedia.org/wiki/WebSocket\" rel=\"nofollow\"\u003eWebSocket\u003c/a\u003e, or just emit your own raw HTTP response header or body data. You can refer to the \u003ca href=\"https://github.com/openresty/lua-resty-websocket\"\u003elua-resty-websocket library\u003c/a\u003e for a real world example.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.exec\u003c/h2\u003e\u003ca id=\"user-content-ngxexec\" class=\"anchor\" aria-label=\"Permalink: ngx.exec\" href=\"#ngxexec\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.exec(uri, args?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDoes an internal redirect to \u003ccode\u003euri\u003c/code\u003e with \u003ccode\u003eargs\u003c/code\u003e and is similar to the \u003ca href=\"http://github.com/openresty/echo-nginx-module#echo_exec\"\u003eecho_exec\u003c/a\u003e directive of the \u003ca href=\"http://github.com/openresty/echo-nginx-module\"\u003eecho-nginx-module\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.exec('/some-location')\n ngx.exec('/some-location', 'a=3\u0026amp;b=5\u0026amp;c=6')\n ngx.exec('/some-location?a=3\u0026amp;b=5', 'c=6')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexec\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/some-location\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexec\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/some-location\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea=3\u0026amp;b=5\u0026amp;c=6\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexec\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/some-location?a=3\u0026amp;b=5\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ec=6\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe optional second \u003ccode\u003eargs\u003c/code\u003e can be used to specify extra URI query arguments, for example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.exec(\u0026quot;/foo\u0026quot;, \u0026quot;a=3\u0026amp;b=hello%20world\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexec\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea=3\u0026amp;b=hello%20world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAlternatively, a Lua table can be passed for the \u003ccode\u003eargs\u003c/code\u003e argument for ngx_lua to carry out URI escaping and string concatenation.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.exec(\u0026quot;/foo\u0026quot;, { a = 3, b = \u0026quot;hello world\u0026quot; })\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexec\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, { \u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello world\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe result is exactly the same as the previous example.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe format for the Lua table passed as the \u003ccode\u003eargs\u003c/code\u003e argument is identical to the format used in the \u003ca href=\"#ngxencode_args\"\u003engx.encode_args\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNamed locations are also supported but the second \u003ccode\u003eargs\u003c/code\u003e argument will be ignored if present and the querystring for the new target is inherited from the referring location (if any).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003eGET /foo/file.php?a=hello\u003c/code\u003e will return \"hello\" and not \"goodbye\" in the example below\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /foo {\n     content_by_lua_block {\n         ngx.exec(\u0026quot;@bar\u0026quot;, \u0026quot;a=goodbye\u0026quot;)\n     }\n }\n\n location @bar {\n     content_by_lua_block {\n         local args = ngx.req.get_uri_args()\n         for key, val in pairs(args) do\n             if key == \u0026quot;a\u0026quot; then\n                 ngx.say(val)\n             end\n         end\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /foo \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.exec\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"@bar\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"a=goodbye\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n\n \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e @bar \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local args = ngx.req.get_uri_args\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e key, val in pairs\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eargs\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e do\n             \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e key == \u003cspan class=\"pl-s\"\u003e\"a\"\u003c/span\u003e then\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eval\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             end\n         end\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that the \u003ccode\u003engx.exec\u003c/code\u003e method is different from \u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e in that\nit is purely an internal redirect and that no new external HTTP traffic is involved.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso note that this method call terminates the processing of the current request and that it \u003cem\u003emust\u003c/em\u003e be called before \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e or explicit response body\noutputs by either \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e or \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is recommended that a coding style that combines this method call with the \u003ccode\u003ereturn\u003c/code\u003e statement, i.e., \u003ccode\u003ereturn ngx.exec(...)\u003c/code\u003e be adopted when this method call is used in contexts other than \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e to reinforce the fact that the request processing is being terminated.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.redirect\u003c/h2\u003e\u003ca id=\"user-content-ngxredirect\" class=\"anchor\" aria-label=\"Permalink: ngx.redirect\" href=\"#ngxredirect\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.redirect(uri, status?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIssue an \u003ccode\u003eHTTP 301\u003c/code\u003e or \u003ccode\u003e302\u003c/code\u003e redirection to \u003ccode\u003euri\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote: this function throws a Lua error if the \u003ccode\u003euri\u003c/code\u003e argument\ncontains unsafe characters (control characters).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003estatus\u003c/code\u003e parameter specifies the HTTP status code to be used. The following status codes are supported right now:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003e301\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e302\u003c/code\u003e (default)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e303\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e307\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e308\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIt is \u003ccode\u003e302\u003c/code\u003e (\u003ccode\u003engx.HTTP_MOVED_TEMPORARILY\u003c/code\u003e) by default.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example assuming the current server name is \u003ccode\u003elocalhost\u003c/code\u003e and that it is listening on port 1984:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect(\u0026quot;/foo\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhich is equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect(\u0026quot;/foo\u0026quot;, ngx.HTTP_MOVED_TEMPORARILY)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_MOVED_TEMPORARILY\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRedirecting arbitrary external URLs is also supported, for example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect(\u0026quot;http://www.google.com\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehttp://www.google.com\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWe can also use the numerical code directly as the second \u003ccode\u003estatus\u003c/code\u003e argument:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect(\u0026quot;/foo\u0026quot;, 301)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e301\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis method is similar to the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite\" rel=\"nofollow\"\u003erewrite\u003c/a\u003e directive with the \u003ccode\u003eredirect\u003c/code\u003e modifier in the standard\n\u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html\" rel=\"nofollow\"\u003engx_http_rewrite_module\u003c/a\u003e, for example, this \u003ccode\u003enginx.conf\u003c/code\u003e snippet\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite ^ /foo? redirect;  # nginx config\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /foo? redirect\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # nginx config\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eis equivalent to the following Lua code\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect('/foo')  -- Lua code\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Lua code\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhile\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n rewrite ^ /foo? permanent;  # nginx config\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erewrite\u003c/span\u003e ^ /foo? permanent\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # nginx config\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eis equivalent to\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect('/foo', ngx.HTTP_MOVED_PERMANENTLY)  -- Lua code\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_MOVED_PERMANENTLY\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e Lua code\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eURI arguments can be specified as well, for example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n return ngx.redirect('/foo?a=3\u0026amp;b=4')\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e/foo?a=3\u0026amp;b=4\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that this method call terminates the processing of the current request and that it \u003cem\u003emust\u003c/em\u003e be called before \u003ca href=\"#ngxsend_headers\"\u003engx.send_headers\u003c/a\u003e or explicit response body\noutputs by either \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e or \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is recommended that a coding style that combines this method call with the \u003ccode\u003ereturn\u003c/code\u003e statement, i.e., \u003ccode\u003ereturn ngx.redirect(...)\u003c/code\u003e be adopted when this method call is used in contexts other than \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e to reinforce the fact that the request processing is being terminated.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.send_headers\u003c/h2\u003e\u003ca id=\"user-content-ngxsend_headers\" class=\"anchor\" aria-label=\"Permalink: ngx.send_headers\" href=\"#ngxsend_headers\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.send_headers()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExplicitly send out the response headers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.8.3\u003c/code\u003e this function returns \u003ccode\u003e1\u003c/code\u003e on success, or returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that there is normally no need to manually send out response headers as ngx_lua will automatically send headers out\nbefore content is output with \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e or \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e or when \u003ca href=\"#content_by_lua\"\u003econtent_by_lua*\u003c/a\u003e exits normally.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.headers_sent\u003c/h2\u003e\u003ca id=\"user-content-ngxheaders_sent\" class=\"anchor\" aria-label=\"Permalink: ngx.headers_sent\" href=\"#ngxheaders_sent\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003evalue = ngx.headers_sent\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns \u003ccode\u003etrue\u003c/code\u003e if the response headers have been sent (by ngx_lua), and \u003ccode\u003efalse\u003c/code\u003e otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in ngx_lua v0.3.1rc6.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.print\u003c/h2\u003e\u003ca id=\"user-content-ngxprint\" class=\"anchor\" aria-label=\"Permalink: ngx.print\" href=\"#ngxprint\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.print(...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEmits arguments concatenated to the HTTP client (as response body). If response headers have not been sent, this function will send headers out first and then output body data.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.8.3\u003c/code\u003e this function returns \u003ccode\u003e1\u003c/code\u003e on success, or returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLua \u003ccode\u003enil\u003c/code\u003e values will output \u003ccode\u003e\"nil\"\u003c/code\u003e strings and Lua boolean values will output \u003ccode\u003e\"true\"\u003c/code\u003e and \u003ccode\u003e\"false\"\u003c/code\u003e literal strings respectively.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNested arrays of strings are permitted and the elements in the arrays will be sent one by one:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local table = {\n     \u0026quot;hello, \u0026quot;,\n     {\u0026quot;world: \u0026quot;, true, \u0026quot; or \u0026quot;, false,\n         {\u0026quot;: \u0026quot;, nil}}\n }\n ngx.print(table)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003etable\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\n     \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n     {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eworld: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e or \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003efalse\u003c/span\u003e,\n         {\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e}}\n }\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003etable\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewill yield the output\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n hello, world: true or false: nil\"\u003e\u003cpre\u003e hello, world: \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e or false: nil\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNon-array table arguments will cause a Lua exception to be thrown.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003engx.null\u003c/code\u003e constant will yield the \u003ccode\u003e\"null\"\u003c/code\u003e string output.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is an asynchronous call and will return immediately without waiting for all the data to be written into the system send buffer. To run in synchronous mode, call \u003ccode\u003engx.flush(true)\u003c/code\u003e after calling \u003ccode\u003engx.print\u003c/code\u003e. This can be particularly useful for streaming output. See \u003ca href=\"#ngxflush\"\u003engx.flush\u003c/a\u003e for more details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease note that both \u003ccode\u003engx.print\u003c/code\u003e and \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e will always invoke the whole Nginx output body filter chain, which is an expensive operation. So be careful when calling either of these two in a tight loop; buffer the data yourself in Lua and save the calls.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.say\u003c/h2\u003e\u003ca id=\"user-content-ngxsay\" class=\"anchor\" aria-label=\"Permalink: ngx.say\" href=\"#ngxsay\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.say(...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust as \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e but also emit a trailing newline.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.log\u003c/h2\u003e\u003ca id=\"user-content-ngxlog\" class=\"anchor\" aria-label=\"Permalink: ngx.log\" href=\"#ngxlog\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.log(log_level, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLog arguments concatenated to error.log with the given logging level.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eLua \u003ccode\u003enil\u003c/code\u003e arguments are accepted and result in literal \u003ccode\u003e\"nil\"\u003c/code\u003e string while Lua booleans result in literal \u003ccode\u003e\"true\"\u003c/code\u003e or \u003ccode\u003e\"false\"\u003c/code\u003e string outputs. And the \u003ccode\u003engx.null\u003c/code\u003e constant will yield the \u003ccode\u003e\"null\"\u003c/code\u003e string output.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003elog_level\u003c/code\u003e argument can take constants like \u003ccode\u003engx.ERR\u003c/code\u003e and \u003ccode\u003engx.WARN\u003c/code\u003e. Check out \u003ca href=\"#nginx-log-level-constants\"\u003eNginx log level constants\u003c/a\u003e for details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThere is a hard coded \u003ccode\u003e2048\u003c/code\u003e byte limitation on error message lengths in the Nginx core. This limit includes trailing newlines and leading time stamps. If the message size exceeds this limit, Nginx will truncate the message text accordingly. This limit can be manually modified by editing the \u003ccode\u003eNGX_MAX_ERROR_STR\u003c/code\u003e macro definition in the \u003ccode\u003esrc/core/ngx_log.h\u003c/code\u003e file in the Nginx source tree.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.flush\u003c/h2\u003e\u003ca id=\"user-content-ngxflush\" class=\"anchor\" aria-label=\"Permalink: ngx.flush\" href=\"#ngxflush\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.flush(wait?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFlushes response output to the client.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.flush\u003c/code\u003e accepts an optional boolean \u003ccode\u003ewait\u003c/code\u003e argument (Default: \u003ccode\u003efalse\u003c/code\u003e) first introduced in the \u003ccode\u003ev0.3.1rc34\u003c/code\u003e release. When called with the default argument, it issues an asynchronous call (Returns immediately without waiting for output data to be written into the system send buffer). Calling the function with the \u003ccode\u003ewait\u003c/code\u003e argument set to \u003ccode\u003etrue\u003c/code\u003e switches to synchronous mode.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn synchronous mode, the function will not return until all output data has been written into the system send buffer or until the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#send_timeout\" rel=\"nofollow\"\u003esend_timeout\u003c/a\u003e setting has expired. Note that using the Lua coroutine mechanism means that this function does not block the Nginx event loop even in the synchronous mode.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen \u003ccode\u003engx.flush(true)\u003c/code\u003e is called immediately after \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e or \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e, it causes the latter functions to run in synchronous mode. This can be particularly useful for streaming output.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that \u003ccode\u003engx.flush\u003c/code\u003e is not functional when in the HTTP 1.0 output buffering mode. See \u003ca href=\"#http-10-support\"\u003eHTTP 1.0 support\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.8.3\u003c/code\u003e this function returns \u003ccode\u003e1\u003c/code\u003e on success, or returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.exit\u003c/h2\u003e\u003ca id=\"user-content-ngxexit\" class=\"anchor\" aria-label=\"Permalink: ngx.exit\" href=\"#ngxexit\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.exit(status)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen \u003ccode\u003estatus \u0026gt;= 200\u003c/code\u003e (i.e., \u003ccode\u003engx.HTTP_OK\u003c/code\u003e and above), it will interrupt the execution of the current request and return status code to Nginx.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen \u003ccode\u003estatus == 0\u003c/code\u003e (i.e., \u003ccode\u003engx.OK\u003c/code\u003e), it will only quit the current phase handler (or the content handler if the \u003ca href=\"#content_by_lua\"\u003econtent_by_lua*\u003c/a\u003e directive is used) and continue to run later phases (if any) for the current request.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003estatus\u003c/code\u003e argument can be \u003ccode\u003engx.OK\u003c/code\u003e, \u003ccode\u003engx.ERROR\u003c/code\u003e, \u003ccode\u003engx.HTTP_NOT_FOUND\u003c/code\u003e,\n\u003ccode\u003engx.HTTP_MOVED_TEMPORARILY\u003c/code\u003e, or other \u003ca href=\"#http-status-constants\"\u003eHTTP status constants\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo return an error page with custom contents, use code snippets like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.status = ngx.HTTP_GONE\n ngx.say(\u0026quot;This is our own content\u0026quot;)\n -- to cause quit the whole request rather than the current phase handler\n ngx.exit(ngx.HTTP_OK)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003estatus\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_GONE\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eThis is our own content\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e to cause quit the whole request rather than the current phase handler\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexit\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eHTTP_OK\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe effect in action:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n $ curl -i http://localhost/test\n HTTP/1.1 410 Gone\n Server: nginx/1.0.6\n Date: Thu, 15 Sep 2011 00:51:48 GMT\n Content-Type: text/plain\n Transfer-Encoding: chunked\n Connection: keep-alive\n\n This is our own content\"\u003e\u003cpre\u003e $ curl -i http://localhost/test\n HTTP/1.1 410 Gone\n Server: nginx/1.0.6\n Date: Thu, 15 Sep 2011 00:51:48 GMT\n Content-Type: text/plain\n Transfer-Encoding: chunked\n Connection: keep-alive\n\n This is our own content\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNumber literals can be used directly as the argument, for instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.exit(501)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexit\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e501\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that while this method accepts all \u003ca href=\"#http-status-constants\"\u003eHTTP status constants\u003c/a\u003e as input, it only accepts \u003ccode\u003engx.OK\u003c/code\u003e and \u003ccode\u003engx.ERROR\u003c/code\u003e of the \u003ca href=\"#core-constants\"\u003ecore constants\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAlso note that this method call terminates the processing of the current request and that it is recommended that a coding style that combines this method call with the \u003ccode\u003ereturn\u003c/code\u003e statement, i.e., \u003ccode\u003ereturn ngx.exit(...)\u003c/code\u003e be used to reinforce the fact that the request processing is being terminated.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen being used in the contexts of \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e, \u003ca href=\"#balancer_by_lua_block\"\u003ebalancer_by_lua*\u003c/a\u003e, and\n\u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua*\u003c/a\u003e, \u003ccode\u003engx.exit()\u003c/code\u003e is\nan asynchronous operation and will return immediately. This behavior may change in future and it is recommended that users always use \u003ccode\u003ereturn\u003c/code\u003e in combination as suggested above.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.eof\u003c/h2\u003e\u003ca id=\"user-content-ngxeof\" class=\"anchor\" aria-label=\"Permalink: ngx.eof\" href=\"#ngxeof\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.eof()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExplicitly specify the end of the response output stream. In the case of HTTP 1.1 chunked encoded output, it will just trigger the Nginx core to send out the \"last chunk\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen you disable the HTTP 1.1 keep-alive feature for your downstream connections, you can rely on well written HTTP clients to close the connection actively for you when you call this method. This trick can be used do back-ground jobs without letting the HTTP clients to wait on the connection, as in the following example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location = /async {\n     keepalive_timeout 0;\n     content_by_lua_block {\n         ngx.say(\u0026quot;got the task!\u0026quot;)\n         ngx.eof()  -- well written HTTP clients will close the connection at this point\n         -- access MySQL, PostgreSQL, Redis, Memcached, and etc here...\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /async \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003ekeepalive_timeout\u003c/span\u003e 0\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"got the task!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.eof\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e  -- well written HTTP clients will close the connection at this point\n         -- access MySQL, PostgreSQL, Redis, Memcached, and etc here...\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBut if you create subrequests to access other locations configured by Nginx upstream modules, then you should configure those upstream modules to ignore client connection abortions if they are not by default. For example, by default the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_http_proxy_module\u003c/a\u003e will terminate both the subrequest and the main request as soon as the client closes the connection, so it is important to turn on the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ignore_client_abort\" rel=\"nofollow\"\u003eproxy_ignore_client_abort\u003c/a\u003e directive in your location block configured by \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html\" rel=\"nofollow\"\u003engx_http_proxy_module\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n proxy_ignore_client_abort on;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eproxy_ignore_client_abort\u003c/span\u003e on\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eA better way to do background jobs is to use the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.8.3\u003c/code\u003e this function returns \u003ccode\u003e1\u003c/code\u003e on success, or returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.sleep\u003c/h2\u003e\u003ca id=\"user-content-ngxsleep\" class=\"anchor\" aria-label=\"Permalink: ngx.sleep\" href=\"#ngxsleep\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.sleep(seconds)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSleeps for the specified seconds without blocking. One can specify time resolution up to 0.001 seconds (i.e., one millisecond).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBehind the scene, this method makes use of the Nginx timers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003e0.7.20\u003c/code\u003e release, The \u003ccode\u003e0\u003c/code\u003e time argument can also be specified.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was introduced in the \u003ccode\u003e0.5.0rc30\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.escape_uri\u003c/h2\u003e\u003ca id=\"user-content-ngxescape_uri\" class=\"anchor\" aria-label=\"Permalink: ngx.escape_uri\" href=\"#ngxescape_uri\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr = ngx.escape_uri(str, type?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince \u003ccode\u003ev0.10.16\u003c/code\u003e, this function accepts an optional \u003ccode\u003etype\u003c/code\u003e argument.\nIt accepts the following values (defaults to \u003ccode\u003e2\u003c/code\u003e):\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003e0\u003c/code\u003e: escapes \u003ccode\u003estr\u003c/code\u003e as a full URI. And the characters\n\u003ccode\u003e \u003c/code\u003e (space), \u003ccode\u003e#\u003c/code\u003e, \u003ccode\u003e%\u003c/code\u003e,\n\u003ccode\u003e?\u003c/code\u003e, 0x00 ~ 0x1F, 0x7F ~ 0xFF will be escaped.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e2\u003c/code\u003e: escape \u003ccode\u003estr\u003c/code\u003e as a URI component. All characters except\nalphabetic characters, digits, \u003ccode\u003e-\u003c/code\u003e, \u003ccode\u003e.\u003c/code\u003e, \u003ccode\u003e_\u003c/code\u003e,\n\u003ccode\u003e~\u003c/code\u003e will be encoded as \u003ccode\u003e%XX\u003c/code\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.unescape_uri\u003c/h2\u003e\u003ca id=\"user-content-ngxunescape_uri\" class=\"anchor\" aria-label=\"Permalink: ngx.unescape_uri\" href=\"#ngxunescape_uri\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr = ngx.unescape_uri(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnescape \u003ccode\u003estr\u003c/code\u003e as an escaped URI component.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(ngx.unescape_uri(\u0026quot;b%20r56+7\u0026quot;))\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eunescape_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eb%20r56+7\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e))\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003egives the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"b r56 7\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eb r56 7\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eInvalid escaping sequences are handled in a conventional way: \u003ccode\u003e%\u003c/code\u003es are left unchanged. Also, characters that should not appear in escaped string are simply left unchanged.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(ngx.unescape_uri(\u0026quot;try %search%%20%again%\u0026quot;))\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eunescape_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etry %search%%20%again%\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e))\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003egives the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"try %search% %again%\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003etry %search% %again%\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e(Note that \u003ccode\u003e%20\u003c/code\u003e following \u003ccode\u003e%\u003c/code\u003e got unescaped, even it can be considered a part of invalid sequence.)\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.encode_args\u003c/h2\u003e\u003ca id=\"user-content-ngxencode_args\" class=\"anchor\" aria-label=\"Permalink: ngx.encode_args\" href=\"#ngxencode_args\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.encode_args(table)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEncode the Lua table to a query args string according to the URI encoded rules.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.encode_args({foo = 3, [\u0026quot;b r\u0026quot;] = \u0026quot;hello world\u0026quot;})\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eencode_args\u003c/span\u003e({\u003cspan class=\"pl-smi\"\u003efoo\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3\u003c/span\u003e, [\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eb r\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eyields\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"foo=3\u0026amp;b%20r=hello%20world\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003efoo=3\u0026amp;b%20r=hello%20world\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe table keys must be Lua strings.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eMulti-value query args are also supported. Just use a Lua table for the argument's value, for example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.encode_args({baz = {32, \u0026quot;hello\u0026quot;}})\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eencode_args\u003c/span\u003e({\u003cspan class=\"pl-smi\"\u003ebaz\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\u003cspan class=\"pl-c1\"\u003e32\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e}})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003egives\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"baz=32\u0026amp;baz=hello\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ebaz=32\u0026amp;baz=hello\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf the value table is empty and the effect is equivalent to the \u003ccode\u003enil\u003c/code\u003e value.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBoolean argument values are also supported, for instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.encode_args({a = true, b = 1})\"\u003e\u003cpre\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eencode_args\u003c/span\u003e({\u003cspan class=\"pl-smi\"\u003ea\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e})\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eyields\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"a\u0026amp;b=1\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ea\u0026amp;b=1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf the argument value is \u003ccode\u003efalse\u003c/code\u003e, then the effect is equivalent to the \u003ccode\u003enil\u003c/code\u003e value.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.3.1rc27\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.decode_args\u003c/h2\u003e\u003ca id=\"user-content-ngxdecode_args\" class=\"anchor\" aria-label=\"Permalink: ngx.decode_args\" href=\"#ngxdecode_args\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etable, err = ngx.decode_args(str, max_args?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDecodes a URI encoded query-string into a Lua table. This is the inverse function of \u003ca href=\"#ngxencode_args\"\u003engx.encode_args\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003emax_args\u003c/code\u003e argument can be used to specify the maximum number of arguments parsed from the \u003ccode\u003estr\u003c/code\u003e argument. By default, a maximum of 100 request arguments are parsed (including those with the same name) and that additional URI arguments are silently discarded to guard against potential denial of service attacks. Since \u003ccode\u003ev0.10.13\u003c/code\u003e, when the limit is exceeded, it will return a second value which is the string \u003ccode\u003e\"truncated\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis argument can be set to zero to remove the limit and to process all request arguments received:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local args = ngx.decode_args(str, 0)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eargs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003edecode_args\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eRemoving the \u003ccode\u003emax_args\u003c/code\u003e cap is strongly discouraged.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was introduced in the \u003ccode\u003ev0.5.0rc29\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.encode_base64\u003c/h2\u003e\u003ca id=\"user-content-ngxencode_base64\" class=\"anchor\" aria-label=\"Permalink: ngx.encode_base64\" href=\"#ngxencode_base64\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr = ngx.encode_base64(str, no_padding?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEncodes \u003ccode\u003estr\u003c/code\u003e to a base64 digest. For base64url encoding use \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/base64.md#encode_base64url\"\u003e\u003ccode\u003ebase64.encode_base64url\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003e0.9.16\u003c/code\u003e release, an optional boolean-typed \u003ccode\u003eno_padding\u003c/code\u003e argument can be specified to control whether the base64 padding should be appended to the resulting digest (default to \u003ccode\u003efalse\u003c/code\u003e, i.e., with padding enabled).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.decode_base64\u003c/h2\u003e\u003ca id=\"user-content-ngxdecode_base64\" class=\"anchor\" aria-label=\"Permalink: ngx.decode_base64\" href=\"#ngxdecode_base64\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr = ngx.decode_base64(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDecodes the \u003ccode\u003estr\u003c/code\u003e argument as a base64 digest to the raw form. For base64url decoding use \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/base64.md#decode_base64url\"\u003e\u003ccode\u003ebase64.decode_base64url\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003estr\u003c/code\u003e should be standard 'base64' encoding for RFC 3548 or RFC 4648, and will returns \u003ccode\u003enil\u003c/code\u003e if is not well formed or any characters not in the base encoding alphabet. Padding may be omitted from the input.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.decode_base64mime\u003c/h2\u003e\u003ca id=\"user-content-ngxdecode_base64mime\" class=\"anchor\" aria-label=\"Permalink: ngx.decode_base64mime\" href=\"#ngxdecode_base64mime\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr = ngx.decode_base64mime(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003erequires:\u003c/strong\u003e \u003ccode\u003eresty.core.base64\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDecodes the \u003ccode\u003estr\u003c/code\u003e argument as a base64 digest to the raw form.\nThe \u003ccode\u003estr\u003c/code\u003e follows base64 transfer encoding for MIME (RFC 2045), and will discard characters outside the base encoding alphabet.\nReturns \u003ccode\u003enil\u003c/code\u003e if \u003ccode\u003estr\u003c/code\u003e is not well formed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e'''Note:''' This method requires the \u003ccode\u003eresty.core.base64\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.crc32_short\u003c/h2\u003e\u003ca id=\"user-content-ngxcrc32_short\" class=\"anchor\" aria-label=\"Permalink: ngx.crc32_short\" href=\"#ngxcrc32_short\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eintval = ngx.crc32_short(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCalculates the CRC-32 (Cyclic Redundancy Code) digest for the \u003ccode\u003estr\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method performs better on relatively short \u003ccode\u003estr\u003c/code\u003e inputs (i.e., less than 30 ~ 60 bytes), as compared to \u003ca href=\"#ngxcrc32_long\"\u003engx.crc32_long\u003c/a\u003e. The result is exactly the same as \u003ca href=\"#ngxcrc32_long\"\u003engx.crc32_long\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBehind the scene, it is just a thin wrapper around the \u003ccode\u003engx_crc32_short\u003c/code\u003e function defined in the Nginx core.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.3.1rc8\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.crc32_long\u003c/h2\u003e\u003ca id=\"user-content-ngxcrc32_long\" class=\"anchor\" aria-label=\"Permalink: ngx.crc32_long\" href=\"#ngxcrc32_long\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eintval = ngx.crc32_long(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCalculates the CRC-32 (Cyclic Redundancy Code) digest for the \u003ccode\u003estr\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method performs better on relatively long \u003ccode\u003estr\u003c/code\u003e inputs (i.e., longer than 30 ~ 60 bytes), as compared to \u003ca href=\"#ngxcrc32_short\"\u003engx.crc32_short\u003c/a\u003e.  The result is exactly the same as \u003ca href=\"#ngxcrc32_short\"\u003engx.crc32_short\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBehind the scene, it is just a thin wrapper around the \u003ccode\u003engx_crc32_long\u003c/code\u003e function defined in the Nginx core.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.3.1rc8\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.hmac_sha1\u003c/h2\u003e\u003ca id=\"user-content-ngxhmac_sha1\" class=\"anchor\" aria-label=\"Permalink: ngx.hmac_sha1\" href=\"#ngxhmac_sha1\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edigest = ngx.hmac_sha1(secret_key, str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eComputes the \u003ca href=\"https://en.wikipedia.org/wiki/HMAC\" rel=\"nofollow\"\u003eHMAC-SHA1\u003c/a\u003e digest of the argument \u003ccode\u003estr\u003c/code\u003e and turns the result using the secret key \u003ccode\u003e\u0026lt;secret_key\u0026gt;\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe raw binary form of the \u003ccode\u003eHMAC-SHA1\u003c/code\u003e digest will be generated, use \u003ca href=\"#ngxencode_base64\"\u003engx.encode_base64\u003c/a\u003e, for example, to encode the result to a textual representation if desired.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local key = \u0026quot;thisisverysecretstuff\u0026quot;\n local src = \u0026quot;some string we want to sign\u0026quot;\n local digest = ngx.hmac_sha1(key, src)\n ngx.say(ngx.encode_base64(digest))\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ekey\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ethisisverysecretstuff\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esrc\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esome string we want to sign\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edigest\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ehmac_sha1\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ekey\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003esrc\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eencode_base64\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003edigest\u003c/span\u003e))\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eyields the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"R/pvxzHC4NLtj7S+kXFg/NePTmk=\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eR/pvxzHC4NLtj7S+kXFg/NePTmk=\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis API requires the OpenSSL library enabled in the Nginx build (usually by passing the \u003ccode\u003e--with-http_ssl_module\u003c/code\u003e option to the \u003ccode\u003e./configure\u003c/code\u003e script).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.3.1rc29\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.md5\u003c/h2\u003e\u003ca id=\"user-content-ngxmd5\" class=\"anchor\" aria-label=\"Permalink: ngx.md5\" href=\"#ngxmd5\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edigest = ngx.md5(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the hexadecimal representation of the MD5 digest of the \u003ccode\u003estr\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location = /md5 {\n     content_by_lua_block {\n         ngx.say(ngx.md5(\u0026quot;hello\u0026quot;))\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e = /md5 \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.md5\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eyields the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"5d41402abc4b2a76b9719d911017c592\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e5d41402abc4b2a76b9719d911017c592\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSee \u003ca href=\"#ngxmd5_bin\"\u003engx.md5_bin\u003c/a\u003e if the raw binary MD5 digest is required.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.md5_bin\u003c/h2\u003e\u003ca id=\"user-content-ngxmd5_bin\" class=\"anchor\" aria-label=\"Permalink: ngx.md5_bin\" href=\"#ngxmd5_bin\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edigest = ngx.md5_bin(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the binary form of the MD5 digest of the \u003ccode\u003estr\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee \u003ca href=\"#ngxmd5\"\u003engx.md5\u003c/a\u003e if the hexadecimal form of the MD5 digest is required.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.sha1_bin\u003c/h2\u003e\u003ca id=\"user-content-ngxsha1_bin\" class=\"anchor\" aria-label=\"Permalink: ngx.sha1_bin\" href=\"#ngxsha1_bin\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edigest = ngx.sha1_bin(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the binary form of the SHA-1 digest of the \u003ccode\u003estr\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function requires SHA-1 support in the Nginx build. (This usually just means OpenSSL should be installed while building Nginx).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003ev0.5.0rc6\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.quote_sql_str\u003c/h2\u003e\u003ca id=\"user-content-ngxquote_sql_str\" class=\"anchor\" aria-label=\"Permalink: ngx.quote_sql_str\" href=\"#ngxquote_sql_str\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003equoted_value = ngx.quote_sql_str(raw_value)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a quoted SQL string literal according to the MySQL quoting rules.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.today\u003c/h2\u003e\u003ca id=\"user-content-ngxtoday\" class=\"anchor\" aria-label=\"Permalink: ngx.today\" href=\"#ngxtoday\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.today()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns current date (in the format \u003ccode\u003eyyyy-mm-dd\u003c/code\u003e) from the Nginx cached time (no syscall involved unlike Lua's date library).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is the local time.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.time\u003c/h2\u003e\u003ca id=\"user-content-ngxtime\" class=\"anchor\" aria-label=\"Permalink: ngx.time\" href=\"#ngxtime\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esecs = ngx.time()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the elapsed seconds from the epoch for the current time stamp from the Nginx cached time (no syscall involved unlike Lua's date library).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUpdates of the Nginx time cache can be forced by calling \u003ca href=\"#ngxupdate_time\"\u003engx.update_time\u003c/a\u003e first.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.now\u003c/h2\u003e\u003ca id=\"user-content-ngxnow\" class=\"anchor\" aria-label=\"Permalink: ngx.now\" href=\"#ngxnow\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esecs = ngx.now()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a floating-point number for the elapsed time in seconds (including milliseconds as the decimal part) from the epoch for the current time stamp from the Nginx cached time (no syscall involved unlike Lua's date library).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can forcibly update the Nginx time cache by calling \u003ca href=\"#ngxupdate_time\"\u003engx.update_time\u003c/a\u003e first.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in \u003ccode\u003ev0.3.1rc32\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.update_time\u003c/h2\u003e\u003ca id=\"user-content-ngxupdate_time\" class=\"anchor\" aria-label=\"Permalink: ngx.update_time\" href=\"#ngxupdate_time\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.update_time()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eForcibly updates the Nginx current time cache. This call involves a syscall and thus has some overhead, so do not abuse it.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in \u003ccode\u003ev0.3.1rc32\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.localtime\u003c/h2\u003e\u003ca id=\"user-content-ngxlocaltime\" class=\"anchor\" aria-label=\"Permalink: ngx.localtime\" href=\"#ngxlocaltime\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.localtime()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the current time stamp (in the format \u003ccode\u003eyyyy-mm-dd hh:mm:ss\u003c/code\u003e) of the Nginx cached time (no syscall involved unlike Lua's \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-os.date\" rel=\"nofollow\"\u003eos.date\u003c/a\u003e function).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is the local time.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.utctime\u003c/h2\u003e\u003ca id=\"user-content-ngxutctime\" class=\"anchor\" aria-label=\"Permalink: ngx.utctime\" href=\"#ngxutctime\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.utctime()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the current time stamp (in the format \u003ccode\u003eyyyy-mm-dd hh:mm:ss\u003c/code\u003e) of the Nginx cached time (no syscall involved unlike Lua's \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-os.date\" rel=\"nofollow\"\u003eos.date\u003c/a\u003e function).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is the UTC time.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.cookie_time\u003c/h2\u003e\u003ca id=\"user-content-ngxcookie_time\" class=\"anchor\" aria-label=\"Permalink: ngx.cookie_time\" href=\"#ngxcookie_time\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.cookie_time(sec)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a formatted string can be used as the cookie expiration time. The parameter \u003ccode\u003esec\u003c/code\u003e is the time stamp in seconds (like those returned from \u003ca href=\"#ngxtime\"\u003engx.time\u003c/a\u003e).\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(ngx.cookie_time(1290079655))\n     -- yields \u0026quot;Thu, 18-Nov-10 11:27:35 GMT\u0026quot;\"\u003e\u003cpre\u003e ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.cookie_time\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e1290079655\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n     -- yields \u003cspan class=\"pl-s\"\u003e\"Thu, 18-Nov-10 11:27:35 GMT\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.http_time\u003c/h2\u003e\u003ca id=\"user-content-ngxhttp_time\" class=\"anchor\" aria-label=\"Permalink: ngx.http_time\" href=\"#ngxhttp_time\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.http_time(sec)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a formated string can be used as the http header time (for example, being used in \u003ccode\u003eLast-Modified\u003c/code\u003e header). The parameter \u003ccode\u003esec\u003c/code\u003e is the time stamp in seconds (like those returned from \u003ca href=\"#ngxtime\"\u003engx.time\u003c/a\u003e).\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n ngx.say(ngx.http_time(1290079655))\n     -- yields \u0026quot;Thu, 18 Nov 2010 11:27:35 GMT\u0026quot;\"\u003e\u003cpre\u003e ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.http_time\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e1290079655\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n     -- yields \u003cspan class=\"pl-s\"\u003e\"Thu, 18 Nov 2010 11:27:35 GMT\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.parse_http_time\u003c/h2\u003e\u003ca id=\"user-content-ngxparse_http_time\" class=\"anchor\" aria-label=\"Permalink: ngx.parse_http_time\" href=\"#ngxparse_http_time\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esec = ngx.parse_http_time(str)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eParse the http time string (as returned by \u003ca href=\"#ngxhttp_time\"\u003engx.http_time\u003c/a\u003e) into seconds. Returns the seconds or \u003ccode\u003enil\u003c/code\u003e if the input string is in bad forms.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local time = ngx.parse_http_time(\u0026quot;Thu, 18 Nov 2010 11:27:35 GMT\u0026quot;)\n if time == nil then\n     ...\n end\"\u003e\u003cpre\u003e local time = ngx.parse_http_time\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"Thu, 18 Nov 2010 11:27:35 GMT\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e time == nil then\n     ...\n end\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.is_subrequest\u003c/h2\u003e\u003ca id=\"user-content-ngxis_subrequest\" class=\"anchor\" aria-label=\"Permalink: ngx.is_subrequest\" href=\"#ngxis_subrequest\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003evalue = ngx.is_subrequest\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns \u003ccode\u003etrue\u003c/code\u003e if the current request is an Nginx subrequest, or \u003ccode\u003efalse\u003c/code\u003e otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.re.match\u003c/h2\u003e\u003ca id=\"user-content-ngxrematch\" class=\"anchor\" aria-label=\"Permalink: ngx.re.match\" href=\"#ngxrematch\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecaptures, err = ngx.re.match(subject, regex, options?, ctx?, res_table?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eMatches the \u003ccode\u003esubject\u003c/code\u003e string using the Perl compatible regular expression \u003ccode\u003eregex\u003c/code\u003e with the optional \u003ccode\u003eoptions\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly the first occurrence of the match is returned, or \u003ccode\u003enil\u003c/code\u003e if no match is found. In case of errors, like seeing a bad regular expression or exceeding the PCRE stack limit, \u003ccode\u003enil\u003c/code\u003e and a string describing the error will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a match is found, a Lua table \u003ccode\u003ecaptures\u003c/code\u003e is returned, where \u003ccode\u003ecaptures[0]\u003c/code\u003e holds the whole substring being matched, and \u003ccode\u003ecaptures[1]\u003c/code\u003e holds the first parenthesized sub-pattern's capturing, \u003ccode\u003ecaptures[2]\u003c/code\u003e the second, and so on.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, \u0026quot;[0-9]+\u0026quot;)\n if m then\n     -- m[0] == \u0026quot;1234\u0026quot;\n\n else\n     if err then\n         ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n         return\n     end\n\n     ngx.say(\u0026quot;match not found\u0026quot;)\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[0-9]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == \"1234\"\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ematch not found\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, \u0026quot;([0-9])[0-9]+\u0026quot;)\n -- m[0] == \u0026quot;1234\u0026quot;\n -- m[1] == \u0026quot;1\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([0-9])[0-9]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == \"1234\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[1] == \"1\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNamed captures are also supported since the \u003ccode\u003ev0.7.14\u003c/code\u003e release\nand are returned in the same Lua table as key-value pairs as the numbered captures.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, 1234\u0026quot;, \u0026quot;([0-9])(?\u0026lt;remaining\u0026gt;[0-9]+)\u0026quot;)\n -- m[0] == \u0026quot;1234\u0026quot;\n -- m[1] == \u0026quot;1\u0026quot;\n -- m[2] == \u0026quot;234\u0026quot;\n -- m[\u0026quot;remaining\u0026quot;] == \u0026quot;234\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([0-9])(?\u0026lt;remaining\u0026gt;[0-9]+)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == \"1234\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[1] == \"1\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[2] == \"234\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[\"remaining\"] == \"234\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eUnmatched subpatterns will have \u003ccode\u003efalse\u003c/code\u003e values in their \u003ccode\u003ecaptures\u003c/code\u003e table fields.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, world\u0026quot;, \u0026quot;(world)|(hello)|(?\u0026lt;named\u0026gt;howdy)\u0026quot;)\n -- m[0] == \u0026quot;hello\u0026quot;\n -- m[1] == false\n -- m[2] == \u0026quot;hello\u0026quot;\n -- m[3] == false\n -- m[\u0026quot;named\u0026quot;] == false\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e(world)|(hello)|(?\u0026lt;named\u0026gt;howdy)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == \"hello\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[1] == false\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[2] == \"hello\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[3] == false\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[\"named\"] == false\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSpecify \u003ccode\u003eoptions\u003c/code\u003e to control how the match operation will be performed. The following option characters are supported:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"a             anchored mode (only match from the beginning)\n\nd             enable the DFA mode (or the longest token match semantics).\n              this requires PCRE 6.0+ or else a Lua exception will be thrown.\n              first introduced in ngx_lua v0.3.1rc30.\n\nD             enable duplicate named pattern support. This allows named\n              subpattern names to be repeated, returning the captures in\n              an array-like Lua table. for example,\n                local m = ngx.re.match(\u0026quot;hello, world\u0026quot;,\n                                       \u0026quot;(?\u0026lt;named\u0026gt;\\w+), (?\u0026lt;named\u0026gt;\\w+)\u0026quot;,\n                                       \u0026quot;D\u0026quot;)\n                -- m[\u0026quot;named\u0026quot;] == {\u0026quot;hello\u0026quot;, \u0026quot;world\u0026quot;}\n              this option was first introduced in the v0.7.14 release.\n              this option requires at least PCRE 8.12.\n\ni             case insensitive mode (similar to Perl's /i modifier)\n\nj             enable PCRE JIT compilation, this requires PCRE 8.21+ which\n              must be built with the --enable-jit option. for optimum performance,\n              this option should always be used together with the 'o' option.\n              first introduced in ngx_lua v0.3.1rc30.\n\nJ             enable the PCRE Javascript compatible mode. this option was\n              first introduced in the v0.7.14 release. this option requires\n              at least PCRE 8.12.\n\nm             multi-line mode (similar to Perl's /m modifier)\n\no             compile-once mode (similar to Perl's /o modifier),\n              to enable the worker-process-level compiled-regex cache\n\ns             single-line mode (similar to Perl's /s modifier)\n\nu             UTF-8 mode. this requires PCRE to be built with\n              the --enable-utf8 option or else a Lua exception will be thrown.\n\nU             similar to \u0026quot;u\u0026quot; but disables PCRE's UTF-8 validity check on\n              the subject string. first introduced in ngx_lua v0.8.1.\n\nx             extended mode (similar to Perl's /x modifier)\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ea             anchored mode (only match from the beginning)\n\nd             enable the DFA mode (or the longest token match semantics).\n              this requires PCRE 6.0+ or else a Lua exception will be thrown.\n              first introduced in ngx_lua v0.3.1rc30.\n\nD             enable duplicate named pattern support. This allows named\n              subpattern names to be repeated, returning the captures in\n              an array-like Lua table. for example,\n                local m = ngx.re.match(\"hello, world\",\n                                       \"(?\u0026lt;named\u0026gt;\\w+), (?\u0026lt;named\u0026gt;\\w+)\",\n                                       \"D\")\n                -- m[\"named\"] == {\"hello\", \"world\"}\n              this option was first introduced in the v0.7.14 release.\n              this option requires at least PCRE 8.12.\n\ni             case insensitive mode (similar to Perl's /i modifier)\n\nj             enable PCRE JIT compilation, this requires PCRE 8.21+ which\n              must be built with the --enable-jit option. for optimum performance,\n              this option should always be used together with the 'o' option.\n              first introduced in ngx_lua v0.3.1rc30.\n\nJ             enable the PCRE Javascript compatible mode. this option was\n              first introduced in the v0.7.14 release. this option requires\n              at least PCRE 8.12.\n\nm             multi-line mode (similar to Perl's /m modifier)\n\no             compile-once mode (similar to Perl's /o modifier),\n              to enable the worker-process-level compiled-regex cache\n\ns             single-line mode (similar to Perl's /s modifier)\n\nu             UTF-8 mode. this requires PCRE to be built with\n              the --enable-utf8 option or else a Lua exception will be thrown.\n\nU             similar to \"u\" but disables PCRE's UTF-8 validity check on\n              the subject string. first introduced in ngx_lua v0.8.1.\n\nx             extended mode (similar to Perl's /x modifier)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese options can be combined:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, world\u0026quot;, \u0026quot;HEL LO\u0026quot;, \u0026quot;ix\u0026quot;)\n -- m[0] == \u0026quot;hello\u0026quot;\"\u003e\u003cpre\u003e local m, err = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, world\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"HEL LO\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"ix\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n -- m[0] == \u003cspan class=\"pl-s\"\u003e\"hello\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local m, err = ngx.re.match(\u0026quot;hello, 美好生活\u0026quot;, \u0026quot;HELLO, (.{2})\u0026quot;, \u0026quot;iu\u0026quot;)\n -- m[0] == \u0026quot;hello, 美好\u0026quot;\n -- m[1] == \u0026quot;美好\u0026quot;\"\u003e\u003cpre\u003e local m, err = ngx.re.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"hello, 美好生活\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"HELLO, (.{2})\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"iu\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n -- m[0] == \u003cspan class=\"pl-s\"\u003e\"hello, 美好\"\u003c/span\u003e\n -- m[1] == \u003cspan class=\"pl-s\"\u003e\"美好\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eo\u003c/code\u003e option is useful for performance tuning, because the regex pattern in question will only be compiled once, cached in the worker-process level, and shared among all requests in the current Nginx worker process. The upper limit of the regex cache can be tuned via the \u003ca href=\"#lua_regex_cache_max_entries\"\u003elua_regex_cache_max_entries\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional fourth argument, \u003ccode\u003ectx\u003c/code\u003e, can be a Lua table holding an optional \u003ccode\u003epos\u003c/code\u003e field. When the \u003ccode\u003epos\u003c/code\u003e field in the \u003ccode\u003ectx\u003c/code\u003e table argument is specified, \u003ccode\u003engx.re.match\u003c/code\u003e will start matching from that offset (starting from 1). Regardless of the presence of the \u003ccode\u003epos\u003c/code\u003e field in the \u003ccode\u003ectx\u003c/code\u003e table, \u003ccode\u003engx.re.match\u003c/code\u003e will always set this \u003ccode\u003epos\u003c/code\u003e field to the position \u003cem\u003eafter\u003c/em\u003e the substring matched by the whole pattern in case of a successful match. When match fails, the \u003ccode\u003ectx\u003c/code\u003e table will be left intact.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local ctx = {}\n local m, err = ngx.re.match(\u0026quot;1234, hello\u0026quot;, \u0026quot;[0-9]+\u0026quot;, \u0026quot;\u0026quot;, ctx)\n      -- m[0] = \u0026quot;1234\u0026quot;\n      -- ctx.pos == 5\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {}\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e1234, hello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[0-9]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e)\n      \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] = \"1234\"\u003c/span\u003e\n      \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e ctx.pos == 5\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local ctx = { pos = 2 }\n local m, err = ngx.re.match(\u0026quot;1234, hello\u0026quot;, \u0026quot;[0-9]+\u0026quot;, \u0026quot;\u0026quot;, ctx)\n      -- m[0] = \u0026quot;234\u0026quot;\n      -- ctx.pos == 5\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e { \u003cspan class=\"pl-smi\"\u003epos\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e2\u003c/span\u003e }\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ematch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e1234, hello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[0-9]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ectx\u003c/span\u003e)\n      \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] = \"234\"\u003c/span\u003e\n      \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e ctx.pos == 5\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003ectx\u003c/code\u003e table argument combined with the \u003ccode\u003ea\u003c/code\u003e regex modifier can be used to construct a lexer atop \u003ccode\u003engx.re.match\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that, the \u003ccode\u003eoptions\u003c/code\u003e argument is not optional when the \u003ccode\u003ectx\u003c/code\u003e argument is specified and that the empty Lua string (\u003ccode\u003e\"\"\u003c/code\u003e) must be used as placeholder for \u003ccode\u003eoptions\u003c/code\u003e if no meaningful regex options are required.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method requires the PCRE library enabled in Nginx (\u003ca href=\"#special-escaping-sequences\"\u003eKnown Issue With Special Escaping Sequences\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTo confirm that PCRE JIT is enabled, activate the Nginx debug log by adding the \u003ccode\u003e--with-debug\u003c/code\u003e option to Nginx or OpenResty's \u003ccode\u003e./configure\u003c/code\u003e script. Then, enable the \"debug\" error log level in \u003ccode\u003eerror_log\u003c/code\u003e directive. The following message will be generated if PCRE JIT is enabled:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"pcre JIT compiling result: 1\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003epcre JIT compiling result: 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eStarting from the \u003ccode\u003e0.9.4\u003c/code\u003e release, this function also accepts a 5th argument, \u003ccode\u003eres_table\u003c/code\u003e, for letting the caller supply the Lua table used to hold all the capturing results. Starting from \u003ccode\u003e0.9.6\u003c/code\u003e, it is the caller's responsibility to ensure this table is empty. This is very useful for recycling Lua tables and saving GC and table allocation overhead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was introduced in the \u003ccode\u003ev0.2.1rc11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.re.find\u003c/h2\u003e\u003ca id=\"user-content-ngxrefind\" class=\"anchor\" aria-label=\"Permalink: ngx.re.find\" href=\"#ngxrefind\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003efrom, to, err = ngx.re.find(subject, regex, options?, ctx?, nth?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e but only returns the beginning index (\u003ccode\u003efrom\u003c/code\u003e) and end index (\u003ccode\u003eto\u003c/code\u003e) of the matched substring. The returned indexes are 1-based and can be fed directly into the \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-string.sub\" rel=\"nofollow\"\u003estring.sub\u003c/a\u003e API function to obtain the matched substring.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of errors (like bad regexes or any PCRE runtime errors), this API function returns two \u003ccode\u003enil\u003c/code\u003e values followed by a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf no match is found, this function just returns a \u003ccode\u003enil\u003c/code\u003e value.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBelow is an example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local s = \u0026quot;hello, 1234\u0026quot;\n local from, to, err = ngx.re.find(s, \u0026quot;([0-9]+)\u0026quot;, \u0026quot;jo\u0026quot;)\n if from then\n     ngx.say(\u0026quot;from: \u0026quot;, from)\n     ngx.say(\u0026quot;to: \u0026quot;, to)\n     ngx.say(\u0026quot;matched: \u0026quot;, string.sub(s, from, to))\n else\n     if err then\n         ngx.say(\u0026quot;error: \u0026quot;, err)\n         return\n     end\n     ngx.say(\u0026quot;not matched!\u0026quot;)\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003es\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eto\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003efind\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003es\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([0-9]+)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ejo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efrom: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eto: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eto\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ematched: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003estring.sub\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003es\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eto\u003c/span\u003e))\n \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003enot matched!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis example produces the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"from: 8\nto: 11\nmatched: 1234\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003efrom: 8\nto: 11\nmatched: 1234\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eBecause this API function does not create new Lua strings nor new Lua tables, it is much faster than \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e. It should be used wherever possible.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003e0.9.3\u003c/code\u003e release, an optional 5th argument, \u003ccode\u003enth\u003c/code\u003e, is supported to specify which (submatch) capture's indexes to return. When \u003ccode\u003enth\u003c/code\u003e is 0 (which is the default), the indexes for the whole matched substring is returned; when \u003ccode\u003enth\u003c/code\u003e is 1, then the 1st submatch capture's indexes are returned; when \u003ccode\u003enth\u003c/code\u003e is 2, then the 2nd submatch capture is returned, and so on. When the specified submatch does not have a match, then two \u003ccode\u003enil\u003c/code\u003e values will be returned. Below is an example for this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local str = \u0026quot;hello, 1234\u0026quot;\n local from, to = ngx.re.find(str, \u0026quot;([0-9])([0-9]+)\u0026quot;, \u0026quot;jo\u0026quot;, nil, 2)\n if from then\n     ngx.say(\u0026quot;matched 2nd submatch: \u0026quot;, string.sub(str, from, to))  -- yields \u0026quot;234\u0026quot;\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eto\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003efind\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([0-9])([0-9]+)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ejo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e2\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ematched 2nd submatch: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003estring.sub\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003efrom\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eto\u003c/span\u003e))  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e yields \"234\"\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis API function was first introduced in the \u003ccode\u003ev0.9.2\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.re.gmatch\u003c/h2\u003e\u003ca id=\"user-content-ngxregmatch\" class=\"anchor\" aria-label=\"Permalink: ngx.re.gmatch\" href=\"#ngxregmatch\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eiterator, err = ngx.re.gmatch(subject, regex, options?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e, but returns a Lua iterator instead, so as to let the user programmer iterate all the matches over the \u003ccode\u003e\u0026lt;subject\u0026gt;\u003c/code\u003e string argument with the PCRE \u003ccode\u003eregex\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of errors, like seeing an ill-formed regular expression, \u003ccode\u003enil\u003c/code\u003e and a string describing the error will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is a small example to demonstrate its basic usage:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local iterator, err = ngx.re.gmatch(\u0026quot;hello, world!\u0026quot;, \u0026quot;([a-z]+)\u0026quot;, \u0026quot;i\u0026quot;)\n if not iterator then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n local m\n m, err = iterator()    -- m[0] == m[1] == \u0026quot;hello\u0026quot;\n if err then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n m, err = iterator()    -- m[0] == m[1] == \u0026quot;world\u0026quot;\n if err then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n m, err = iterator()    -- m == nil\n if err then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eiterator\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003egmatch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, world!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([a-z]+)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ei\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eiterator\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eiterator\u003c/span\u003e()    \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == m[1] == \"hello\"\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eiterator\u003c/span\u003e()    \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m[0] == m[1] == \"world\"\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eiterator\u003c/span\u003e()    \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e m == nil\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eMore often we just put it into a Lua loop:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local it, err = ngx.re.gmatch(\u0026quot;hello, world!\u0026quot;, \u0026quot;([a-z]+)\u0026quot;, \u0026quot;i\u0026quot;)\n if not it then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n while true do\n     local m, err = it()\n     if err then\n         ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n         return\n     end\n\n     if not m then\n         -- no match found (any more)\n         break\n     end\n\n     -- found a match\n     ngx.say(m[0])\n     ngx.say(m[1])\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eit\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003egmatch\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, world!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([a-z]+)\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ei\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eit\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eit\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e no match found (any more)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003ebreak\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e found a match\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e])\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e])\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003eoptions\u003c/code\u003e argument takes exactly the same semantics as the \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe current implementation requires that the iterator returned should only be used in a single request. That is, one should \u003cem\u003enot\u003c/em\u003e assign it to a variable belonging to persistent namespace like a Lua package.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method requires the PCRE library enabled in Nginx (\u003ca href=\"#special-escaping-sequences\"\u003eKnown Issue With Special Escaping Sequences\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.2.1rc12\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.re.sub\u003c/h2\u003e\u003ca id=\"user-content-ngxresub\" class=\"anchor\" aria-label=\"Permalink: ngx.re.sub\" href=\"#ngxresub\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr, n, err = ngx.re.sub(subject, regex, replace, options?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSubstitutes the first match of the Perl compatible regular expression \u003ccode\u003eregex\u003c/code\u003e on the \u003ccode\u003esubject\u003c/code\u003e argument string with the string or function argument \u003ccode\u003ereplace\u003c/code\u003e. The optional \u003ccode\u003eoptions\u003c/code\u003e argument has exactly the same meaning as in \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method returns the resulting new string as well as the number of successful substitutions. In case of failures, like syntax errors in the regular expressions or the \u003ccode\u003e\u0026lt;replace\u0026gt;\u003c/code\u003e string argument, it will return \u003ccode\u003enil\u003c/code\u003e and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the \u003ccode\u003ereplace\u003c/code\u003e is a string, then it is treated as a special template for string replacement. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local newstr, n, err = ngx.re.sub(\u0026quot;hello, 1234\u0026quot;, \u0026quot;([0-9])[0-9]\u0026quot;, \u0026quot;[$0][$1]\u0026quot;)\n if not newstr then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n -- newstr == \u0026quot;hello, [12][1]34\u0026quot;\n -- n == 1\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([0-9])[0-9]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[$0][$1]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"hello, [12][1]34\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 1\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003ewhere \u003ccode\u003e$0\u003c/code\u003e referring to the whole substring matched by the pattern and \u003ccode\u003e$1\u003c/code\u003e referring to the first parenthesized capturing substring.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCurly braces can also be used to disambiguate variable names from the background string literals:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local newstr, n, err = ngx.re.sub(\u0026quot;hello, 1234\u0026quot;, \u0026quot;[0-9]\u0026quot;, \u0026quot;${0}00\u0026quot;)\n -- newstr == \u0026quot;hello, 100234\u0026quot;\n -- n == 1\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[0-9]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e${0}00\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"hello, 100234\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 1\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eLiteral dollar sign characters (\u003ccode\u003e$\u003c/code\u003e) in the \u003ccode\u003ereplace\u003c/code\u003e string argument can be escaped by another dollar sign, for instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local newstr, n, err = ngx.re.sub(\u0026quot;hello, 1234\u0026quot;, \u0026quot;[0-9]\u0026quot;, \u0026quot;$$\u0026quot;)\n -- newstr == \u0026quot;hello, $234\u0026quot;\n -- n == 1\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[0-9]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e$$\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"hello, $234\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 1\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eDo not use backlashes to escape dollar signs; it will not work as expected.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the \u003ccode\u003ereplace\u003c/code\u003e argument is of type \"function\", then it will be invoked with the \"match table\" as the argument to generate the replace string literal for substitution. The \"match table\" fed into the \u003ccode\u003ereplace\u003c/code\u003e function is exactly the same as the return value of \u003ca href=\"#ngxrematch\"\u003engx.re.match\u003c/a\u003e. Here is an example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local func = function (m)\n     return \u0026quot;[\u0026quot; .. m[0] .. \u0026quot;][\u0026quot; .. m[1] .. \u0026quot;]\u0026quot;\n end\n\n local newstr, n, err = ngx.re.sub(\u0026quot;hello, 1234\u0026quot;, \u0026quot;( [0-9] ) [0-9]\u0026quot;, func, \u0026quot;x\u0026quot;)\n -- newstr == \u0026quot;hello, [12][1]34\u0026quot;\n -- n == 1\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-en\"\u003efunc\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e (\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e][\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, 1234\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e( [0-9] ) [0-9]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003efunc\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ex\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"hello, [12][1]34\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 1\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe dollar sign characters in the return value of the \u003ccode\u003ereplace\u003c/code\u003e function argument are not special at all.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method requires the PCRE library enabled in Nginx (\u003ca href=\"#special-escaping-sequences\"\u003eKnown Issue With Special Escaping Sequences\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.2.1rc13\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.re.gsub\u003c/h2\u003e\u003ca id=\"user-content-ngxregsub\" class=\"anchor\" aria-label=\"Permalink: ngx.re.gsub\" href=\"#ngxregsub\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewstr, n, err = ngx.re.gsub(subject, regex, replace, options?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like \u003ca href=\"#ngxresub\"\u003engx.re.sub\u003c/a\u003e, but does global substitution.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is some examples:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local newstr, n, err = ngx.re.gsub(\u0026quot;hello, world\u0026quot;, \u0026quot;([a-z])[a-z]+\u0026quot;, \u0026quot;[$0,$1]\u0026quot;, \u0026quot;i\u0026quot;)\n if not newstr then\n     ngx.log(ngx.ERR, \u0026quot;error: \u0026quot;, err)\n     return\n end\n\n -- newstr == \u0026quot;[hello,h], [world,w]\u0026quot;\n -- n == 2\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003egsub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([a-z])[a-z]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[$0,$1]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ei\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eerror: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"[hello,h], [world,w]\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 2\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local func = function (m)\n     return \u0026quot;[\u0026quot; .. m[0] .. \u0026quot;,\u0026quot; .. m[1] .. \u0026quot;]\u0026quot;\n end\n local newstr, n, err = ngx.re.gsub(\u0026quot;hello, world\u0026quot;, \u0026quot;([a-z])[a-z]+\u0026quot;, func, \u0026quot;i\u0026quot;)\n -- newstr == \u0026quot;[hello,h], [world,w]\u0026quot;\n -- n == 2\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-en\"\u003efunc\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e (\u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e[\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e,\u003cspan class=\"pl-pds\"\u003e\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003em\u003c/span\u003e[\u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e] \u003cspan class=\"pl-k\"\u003e..\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewstr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003en\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ere\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003egsub\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello, world\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e([a-z])[a-z]+\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003efunc\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ei\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e newstr == \"[hello,h], [world,w]\"\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e n == 2\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis method requires the PCRE library enabled in Nginx (\u003ca href=\"#special-escaping-sequences\"\u003eKnown Issue With Special Escaping Sequences\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.2.1rc15\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddict\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT\" href=\"#ngxshareddict\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edict = ngx.shared.DICT\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edict = ngx.shared[name_var]\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFetching the shm-based Lua dictionary object for the shared memory zone named \u003ccode\u003eDICT\u003c/code\u003e defined by the \u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eShared memory zones are always shared by all the Nginx worker processes in the current Nginx server instance.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe resulting object \u003ccode\u003edict\u003c/code\u003e has the following methods:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget\"\u003eget\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget_stale\"\u003eget_stale\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictsafe_set\"\u003esafe_set\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictadd\"\u003eadd\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictsafe_add\"\u003esafe_add\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictreplace\"\u003ereplace\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictdelete\"\u003edelete\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictincr\"\u003eincr\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictlpush\"\u003elpush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictrpush\"\u003erpush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictlpop\"\u003elpop\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictrpop\"\u003erpop\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictllen\"\u003ellen\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictttl\"\u003ettl\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictexpire\"\u003eexpire\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictflush_all\"\u003eflush_all\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictflush_expired\"\u003eflush_expired\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictget_keys\"\u003eget_keys\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictcapacity\"\u003ecapacity\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ngxshareddictfree_space\"\u003efree_space\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eAll these methods are \u003cem\u003eatomic\u003c/em\u003e operations, that is, safe from concurrent accesses from multiple Nginx worker processes for the same \u003ccode\u003elua_shared_dict\u003c/code\u003e zone.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n http {\n     lua_shared_dict dogs 10m;\n     server {\n         location /set {\n             content_by_lua_block {\n                 local dogs = ngx.shared.dogs\n                 dogs:set(\u0026quot;Jim\u0026quot;, 8)\n                 ngx.say(\u0026quot;STORED\u0026quot;)\n             }\n         }\n         location /get {\n             content_by_lua_block {\n                 local dogs = ngx.shared.dogs\n                 ngx.say(dogs:get(\u0026quot;Jim\u0026quot;))\n             }\n         }\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003ehttp\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     lua_shared_dict dogs \u003cspan class=\"pl-c1\"\u003e10m\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eserver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n                 local dogs = ngx.shared.dogs\n                 dogs:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"Jim\"\u003c/span\u003e, 8\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"STORED\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /get \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n             content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n                 local dogs = ngx.shared.dogs\n                 ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003edogs:get\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"Jim\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e))\u003c/span\u003e\n             \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eLet us test it:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n $ curl localhost/set\n STORED\n\n $ curl localhost/get\n 8\n\n $ curl localhost/get\n 8\"\u003e\u003cpre\u003e $ curl localhost/set\n STORED\n\n $ curl localhost/get\n 8\n\n $ curl localhost/get\n 8\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe number \u003ccode\u003e8\u003c/code\u003e will be consistently output when accessing \u003ccode\u003e/get\u003c/code\u003e regardless of how many Nginx workers there are because the \u003ccode\u003edogs\u003c/code\u003e dictionary resides in the shared memory and visible to \u003cem\u003eall\u003c/em\u003e of the worker processes.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe shared dictionary will retain its contents through a server config reload (either by sending the \u003ccode\u003eHUP\u003c/code\u003e signal to the Nginx process or by using the \u003ccode\u003e-s reload\u003c/code\u003e command-line option).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe contents in the dictionary storage will be lost, however, when the Nginx server quits.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.get\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictget\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.get\" href=\"#ngxshareddictget\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003evalue, flags = ngx.shared.DICT:get(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieving the value in the dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e for the key \u003ccode\u003ekey\u003c/code\u003e. If the key does not exist or has expired, then \u003ccode\u003enil\u003c/code\u003e will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of errors, \u003ccode\u003enil\u003c/code\u003e and a string describing the error will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe value returned will have the original data type when they were inserted into the dictionary, for example, Lua booleans, numbers, or strings.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe first argument to this method must be the dictionary object itself, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local cats = ngx.shared.cats\n local value, flags = cats.get(cats, \u0026quot;Marry\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003evalue\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eflags\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eget\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eor use Lua's syntactic sugar for method calls:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local cats = ngx.shared.cats\n local value, flags = cats:get(\u0026quot;Marry\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003evalue\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eflags\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eget\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese two forms are fundamentally equivalent.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the user flags is \u003ccode\u003e0\u003c/code\u003e (the default), then no flags value will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.get_stale\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictget_stale\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.get_stale\" href=\"#ngxshareddictget_stale\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003evalue, flags, stale = ngx.shared.DICT:get_stale(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#ngxshareddictget\"\u003eget\u003c/a\u003e method but returns the value even if the key has already expired.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns a 3rd value, \u003ccode\u003estale\u003c/code\u003e, indicating whether the key has expired or not.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that the value of an expired key is not guaranteed to be available so one should never rely on the availability of expired items.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003e0.8.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.set\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictset\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.set\" href=\"#ngxshareddictset\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esuccess, err, forcible = ngx.shared.DICT:set(key, value, exptime?, flags?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnconditionally sets a key-value pair into the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e. Returns three values:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003esuccess\u003c/code\u003e: boolean value to indicate whether the key-value pair is stored or not.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eerr\u003c/code\u003e: textual error message, can be \u003ccode\u003e\"no memory\"\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eforcible\u003c/code\u003e: a boolean value to indicate whether other valid items have been removed forcibly when out of storage in the shared memory zone.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003evalue\u003c/code\u003e argument inserted can be Lua booleans, numbers, strings, or \u003ccode\u003enil\u003c/code\u003e. Their value type will also be stored into the dictionary and the same data type can be retrieved later via the \u003ca href=\"#ngxshareddictget\"\u003eget\u003c/a\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003eexptime\u003c/code\u003e argument specifies expiration time (in seconds) for the inserted key-value pair. The time resolution is \u003ccode\u003e0.001\u003c/code\u003e seconds. If the \u003ccode\u003eexptime\u003c/code\u003e takes the value \u003ccode\u003e0\u003c/code\u003e (which is the default), then the item will never expire.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003eflags\u003c/code\u003e argument specifies a user flags value associated with the entry to be stored. It can also be retrieved later with the value. The user flags is stored as an unsigned 32-bit integer internally. Defaults to \u003ccode\u003e0\u003c/code\u003e. The user flags argument was first introduced in the \u003ccode\u003ev0.5.0rc2\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen it fails to allocate memory for the current key-value item, then \u003ccode\u003eset\u003c/code\u003e will try removing existing items in the storage according to the Least-Recently Used (LRU) algorithm. Note that, LRU takes priority over expiration time here. If up to tens of existing items have been removed and the storage left is still insufficient (either due to the total capacity limit specified by \u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e or memory segmentation), then the \u003ccode\u003eerr\u003c/code\u003e return value will be \u003ccode\u003eno memory\u003c/code\u003e and \u003ccode\u003esuccess\u003c/code\u003e will be \u003ccode\u003efalse\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the sizes of items in the dictionary are not multiples or even powers of a certain value (like 2), it is easier to encounter \u003ccode\u003eno memory\u003c/code\u003e error because of memory fragmentation. It is recommended to use different dictionaries for different sizes of items.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen you encounter \u003ccode\u003eno memory\u003c/code\u003e error, you can also evict more least-recently-used items by retrying this method call more times to to make room for the current item.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf this method succeeds in storing the current item by forcibly removing other not-yet-expired items in the dictionary via LRU, the \u003ccode\u003eforcible\u003c/code\u003e return value will be \u003ccode\u003etrue\u003c/code\u003e. If it stores the item without forcibly removing other valid items, then the return value \u003ccode\u003eforcible\u003c/code\u003e will be \u003ccode\u003efalse\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe first argument to this method must be the dictionary object itself, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local cats = ngx.shared.cats\n local succ, err, forcible = cats.set(cats, \u0026quot;Marry\u0026quot;, \u0026quot;it is a nice cat!\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esucc\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eforcible\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eit is a nice cat!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eor use Lua's syntactic sugar for method calls:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local cats = ngx.shared.cats\n local succ, err, forcible = cats:set(\u0026quot;Marry\u0026quot;, \u0026quot;it is a nice cat!\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esucc\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eforcible\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eit is a nice cat!\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese two forms are fundamentally equivalent.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease note that while internally the key-value pair is set atomically, the atomicity does not go across the method call boundary.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.safe_set\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictsafe_set\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.safe_set\" href=\"#ngxshareddictsafe_set\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.shared.DICT:safe_set(key, value, exptime?, flags?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e method, but never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return \u003ccode\u003enil\u003c/code\u003e and the string \"no memory\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.7.18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.add\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictadd\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.add\" href=\"#ngxshareddictadd\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esuccess, err, forcible = ngx.shared.DICT:add(key, value, exptime?, flags?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like the \u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e method, but only stores the key-value pair into the dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e if the key does \u003cem\u003enot\u003c/em\u003e exist.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the \u003ccode\u003ekey\u003c/code\u003e argument already exists in the dictionary (and not expired for sure), the \u003ccode\u003esuccess\u003c/code\u003e return value will be \u003ccode\u003efalse\u003c/code\u003e and the \u003ccode\u003eerr\u003c/code\u003e return value will be \u003ccode\u003e\"exists\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.safe_add\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictsafe_add\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.safe_add\" href=\"#ngxshareddictsafe_add\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.shared.DICT:safe_add(key, value, exptime?, flags?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#ngxshareddictadd\"\u003eadd\u003c/a\u003e method, but never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return \u003ccode\u003enil\u003c/code\u003e and the string \"no memory\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.7.18\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.replace\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictreplace\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.replace\" href=\"#ngxshareddictreplace\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esuccess, err, forcible = ngx.shared.DICT:replace(key, value, exptime?, flags?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like the \u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e method, but only stores the key-value pair into the dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e if the key \u003cem\u003edoes\u003c/em\u003e exist.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the \u003ccode\u003ekey\u003c/code\u003e argument does \u003cem\u003enot\u003c/em\u003e exist in the dictionary (or expired already), the \u003ccode\u003esuccess\u003c/code\u003e return value will be \u003ccode\u003efalse\u003c/code\u003e and the \u003ccode\u003eerr\u003c/code\u003e return value will be \u003ccode\u003e\"not found\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.delete\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictdelete\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.delete\" href=\"#ngxshareddictdelete\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.shared.DICT:delete(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnconditionally removes the key-value pair from the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is equivalent to \u003ccode\u003engx.shared.DICT:set(key, nil)\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.incr\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictincr\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.incr\" href=\"#ngxshareddictincr\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003enewval, err, forcible? = ngx.shared.DICT:incr(key, value, init?, init_ttl?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eoptional requirement:\u003c/strong\u003e \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIncrements the (numerical) value for \u003ccode\u003ekey\u003c/code\u003e in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e by the step value \u003ccode\u003evalue\u003c/code\u003e. Returns the new resulting number if the operation is successfully completed or \u003ccode\u003enil\u003c/code\u003e and an error message otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the key does not exist or has already expired in the shared dictionary,\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003eif the \u003ccode\u003einit\u003c/code\u003e argument is not specified or takes the value \u003ccode\u003enil\u003c/code\u003e, this method will return \u003ccode\u003enil\u003c/code\u003e and the error string \u003ccode\u003e\"not found\"\u003c/code\u003e, or\u003c/li\u003e\n\u003cli\u003eif the \u003ccode\u003einit\u003c/code\u003e argument takes a number value, this method will create a new \u003ccode\u003ekey\u003c/code\u003e with the value \u003ccode\u003einit + value\u003c/code\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eLike the \u003ca href=\"#ngxshareddictadd\"\u003eadd\u003c/a\u003e method, it also overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003einit_ttl\u003c/code\u003e argument specifies expiration time (in seconds) of the value when it is initialized via the \u003ccode\u003einit\u003c/code\u003e argument. The time resolution is \u003ccode\u003e0.001\u003c/code\u003e seconds. If \u003ccode\u003einit_ttl\u003c/code\u003e takes the value \u003ccode\u003e0\u003c/code\u003e (which is the default), then the item will never expire. This argument cannot be provided without providing the \u003ccode\u003einit\u003c/code\u003e argument as well, and has no effect if the value already exists (e.g., if it was previously inserted via \u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e or the likes).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e Usage of the \u003ccode\u003einit_ttl\u003c/code\u003e argument requires the \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library. Example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require \u0026quot;resty.core\u0026quot;\n\n local cats = ngx.shared.cats\n local newval, err = cats:incr(\u0026quot;black_cats\u0026quot;, 1, 0, 0.1)\n\n print(newval) -- 1\n\n ngx.sleep(0.2)\n\n local val, err = cats:get(\u0026quot;black_cats\u0026quot;)\n print(val) -- nil\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.core\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003enewval\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eincr\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eblack_cats\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0.1\u003c/span\u003e)\n\n \u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003enewval\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e 1\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esleep\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0.2\u003c/span\u003e)\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eval\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eget\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eblack_cats\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c1\"\u003eprint\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eval\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e nil\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eforcible\u003c/code\u003e return value will always be \u003ccode\u003enil\u003c/code\u003e when the \u003ccode\u003einit\u003c/code\u003e argument is not specified.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf this method succeeds in storing the current item by forcibly removing other not-yet-expired items in the dictionary via LRU, the \u003ccode\u003eforcible\u003c/code\u003e return value will be \u003ccode\u003etrue\u003c/code\u003e. If it stores the item without forcibly removing other valid items, then the return value \u003ccode\u003eforcible\u003c/code\u003e will be \u003ccode\u003efalse\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the original value is not a valid Lua number in the dictionary, it will return \u003ccode\u003enil\u003c/code\u003e and \u003ccode\u003e\"not a number\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003evalue\u003c/code\u003e argument and \u003ccode\u003einit\u003c/code\u003e argument can be any valid Lua numbers, like negative numbers or floating-point numbers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.3.1rc22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003einit\u003c/code\u003e parameter was first added in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003einit_ttl\u003c/code\u003e parameter was introduced in the \u003ccode\u003ev0.10.12rc2\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.lpush\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictlpush\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.lpush\" href=\"#ngxshareddictlpush\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elength, err = ngx.shared.DICT:lpush(key, value)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eInserts the specified (numerical or string) \u003ccode\u003evalue\u003c/code\u003e at the head of the list named \u003ccode\u003ekey\u003c/code\u003e in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e. Returns the number of elements in the list after the push operation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf \u003ccode\u003ekey\u003c/code\u003e does not exist, it is created as an empty list before performing the push operation. When the \u003ccode\u003ekey\u003c/code\u003e already takes a value that is not a list, it will return \u003ccode\u003enil\u003c/code\u003e and \u003ccode\u003e\"value not a list\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return \u003ccode\u003enil\u003c/code\u003e and the string \"no memory\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.rpush\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictrpush\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.rpush\" href=\"#ngxshareddictrpush\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elength, err = ngx.shared.DICT:rpush(key, value)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#ngxshareddictlpush\"\u003elpush\u003c/a\u003e method, but inserts the specified (numerical or string) \u003ccode\u003evalue\u003c/code\u003e at the tail of the list named \u003ccode\u003ekey\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.lpop\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictlpop\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.lpop\" href=\"#ngxshareddictlpop\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eval, err = ngx.shared.DICT:lpop(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRemoves and returns the first element of the list named \u003ccode\u003ekey\u003c/code\u003e in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf \u003ccode\u003ekey\u003c/code\u003e does not exist, it will return \u003ccode\u003enil\u003c/code\u003e. When the \u003ccode\u003ekey\u003c/code\u003e already takes a value that is not a list, it will return \u003ccode\u003enil\u003c/code\u003e and \u003ccode\u003e\"value not a list\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.rpop\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictrpop\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.rpop\" href=\"#ngxshareddictrpop\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eval, err = ngx.shared.DICT:rpop(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRemoves and returns the last element of the list named \u003ccode\u003ekey\u003c/code\u003e in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf \u003ccode\u003ekey\u003c/code\u003e does not exist, it will return \u003ccode\u003enil\u003c/code\u003e. When the \u003ccode\u003ekey\u003c/code\u003e already takes a value that is not a list, it will return \u003ccode\u003enil\u003c/code\u003e and \u003ccode\u003e\"value not a list\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.llen\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictllen\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.llen\" href=\"#ngxshareddictllen\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elen, err = ngx.shared.DICT:llen(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the number of elements in the list named \u003ccode\u003ekey\u003c/code\u003e in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf key does not exist, it is interpreted as an empty list and 0 is returned. When the \u003ccode\u003ekey\u003c/code\u003e already takes a value that is not a list, it will return \u003ccode\u003enil\u003c/code\u003e and \u003ccode\u003e\"value not a list\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.6\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.ttl\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictttl\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.ttl\" href=\"#ngxshareddictttl\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ettl, err = ngx.shared.DICT:ttl(key)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003erequires:\u003c/strong\u003e \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the remaining TTL (time-to-live in seconds) of a key-value pair in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e. Returns the TTL as a number if the operation is successfully completed or \u003ccode\u003enil\u003c/code\u003e and an error message otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the key does not exist (or has already expired), this method will return \u003ccode\u003enil\u003c/code\u003e and the error string \u003ccode\u003e\"not found\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe TTL is originally determined by the \u003ccode\u003eexptime\u003c/code\u003e argument of the \u003ca href=\"#ngxshareddictset\"\u003eset\u003c/a\u003e, \u003ca href=\"#ngxshareddictadd\"\u003eadd\u003c/a\u003e, \u003ca href=\"#ngxshareddictreplace\"\u003ereplace\u003c/a\u003e (and the likes) methods. It has a time resolution of \u003ccode\u003e0.001\u003c/code\u003e seconds. A value of \u003ccode\u003e0\u003c/code\u003e means that the item will never expire.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExample:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require \u0026quot;resty.core\u0026quot;\n\n local cats = ngx.shared.cats\n local succ, err = cats:set(\u0026quot;Marry\u0026quot;, \u0026quot;a nice cat\u0026quot;, 0.5)\n\n ngx.sleep(0.2)\n\n local ttl, err = cats:ttl(\u0026quot;Marry\u0026quot;)\n ngx.say(ttl) -- 0.3\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.core\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esucc\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea nice cat\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0.5\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esleep\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0.2\u003c/span\u003e)\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ettl\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ettl\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ettl\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e 0.3\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e This method requires the \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.expire\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictexpire\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.expire\" href=\"#ngxshareddictexpire\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esuccess, err = ngx.shared.DICT:expire(key, exptime)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003erequires:\u003c/strong\u003e \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUpdates the \u003ccode\u003eexptime\u003c/code\u003e (in second) of a key-value pair in the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e. Returns a boolean indicating success if the operation completes or \u003ccode\u003enil\u003c/code\u003e and an error message otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the key does not exist, this method will return \u003ccode\u003enil\u003c/code\u003e and the error string \u003ccode\u003e\"not found\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eexptime\u003c/code\u003e argument has a resolution of \u003ccode\u003e0.001\u003c/code\u003e seconds. If \u003ccode\u003eexptime\u003c/code\u003e is \u003ccode\u003e0\u003c/code\u003e, then the item will never expire.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExample:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require \u0026quot;resty.core\u0026quot;\n\n local cats = ngx.shared.cats\n local succ, err = cats:set(\u0026quot;Marry\u0026quot;, \u0026quot;a nice cat\u0026quot;, 0.1)\n\n succ, err = cats:expire(\u0026quot;Marry\u0026quot;, 0.5)\n\n ngx.sleep(0.2)\n\n local val, err = cats:get(\u0026quot;Marry\u0026quot;)\n ngx.say(val) -- \u0026quot;a nice cat\u0026quot;\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.core\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esucc\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eset\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea nice cat\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0.1\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003esucc\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eexpire\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0.5\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esleep\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0.2\u003c/span\u003e)\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eval\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eget\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eMarry\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eval\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e \"a nice cat\"\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e This method requires the \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.flush_all\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictflush_all\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.flush_all\" href=\"#ngxshareddictflush_all\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003engx.shared.DICT:flush_all()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFlushes out all the items in the dictionary. This method does not actually free up all the memory blocks in the dictionary but just marks all the existing items as expired.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc17\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddictflush_expired\"\u003engx.shared.DICT.flush_expired\u003c/a\u003e and \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.flush_expired\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictflush_expired\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.flush_expired\" href=\"#ngxshareddictflush_expired\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eflushed = ngx.shared.DICT:flush_expired(max_count?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFlushes out the expired items in the dictionary, up to the maximal number specified by the optional \u003ccode\u003emax_count\u003c/code\u003e argument. When the \u003ccode\u003emax_count\u003c/code\u003e argument is given \u003ccode\u003e0\u003c/code\u003e or not given at all, then it means unlimited. Returns the number of items that have actually been flushed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUnlike the \u003ca href=\"#ngxshareddictflush_all\"\u003eflush_all\u003c/a\u003e method, this method actually frees up the memory used by the expired items.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.6.3\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddictflush_all\"\u003engx.shared.DICT.flush_all\u003c/a\u003e and \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.get_keys\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictget_keys\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.get_keys\" href=\"#ngxshareddictget_keys\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ekeys = ngx.shared.DICT:get_keys(max_count?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFetch a list of the keys from the dictionary, up to \u003ccode\u003e\u0026lt;max_count\u0026gt;\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBy default, only the first 1024 keys (if any) are returned. When the \u003ccode\u003e\u0026lt;max_count\u0026gt;\u003c/code\u003e argument is given the value \u003ccode\u003e0\u003c/code\u003e, then all the keys will be returned even there is more than 1024 keys in the dictionary.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eCAUTION\u003c/strong\u003e Avoid calling this method on dictionaries with a very large number of keys as it may lock the dictionary for significant amount of time and block Nginx worker processes trying to access the dictionary.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.7.3\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.capacity\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictcapacity\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.capacity\" href=\"#ngxshareddictcapacity\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecapacity_bytes = ngx.shared.DICT:capacity()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003erequires:\u003c/strong\u003e \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the capacity in bytes for the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e declared with\nthe \u003ca href=\"#lua_shared_dict\"\u003elua_shared_dict\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExample:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require \u0026quot;resty.core.shdict\u0026quot;\n\n local cats = ngx.shared.cats\n local capacity_bytes = cats:capacity()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.core.shdict\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecapacity_bytes\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ecapacity\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e This method requires the \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least Nginx core version \u003ccode\u003e0.7.3\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.shared.DICT.free_space\u003c/h2\u003e\u003ca id=\"user-content-ngxshareddictfree_space\" class=\"anchor\" aria-label=\"Permalink: ngx.shared.DICT.free_space\" href=\"#ngxshareddictfree_space\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003efree_page_bytes = ngx.shared.DICT:free_space()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003erequires:\u003c/strong\u003e \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the free page size in bytes for the shm-based dictionary \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e The memory for ngx.shared.DICT is allocated via the Nginx slab allocator which has each slot for\ndata size ranges like ~8, 9~16, 17~32, ..., 1025~2048, 2048~ bytes. And pages are assigned to a slot if there\nis no room in already assigned pages for the slot.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSo even if the return value of the \u003ccode\u003efree_space\u003c/code\u003e method is zero, there may be room in already assigned pages, so\nyou may successfully set a new key value pair to the shared dict without getting \u003ccode\u003etrue\u003c/code\u003e for \u003ccode\u003eforcible\u003c/code\u003e or\nnon nil \u003ccode\u003eerr\u003c/code\u003e from the \u003ccode\u003engx.shared.DICT.set\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOn the other hand, if already assigned pages for a slot are full and a new key value pair is added to the\nslot and there is no free page, you may get \u003ccode\u003etrue\u003c/code\u003e for \u003ccode\u003eforcible\u003c/code\u003e or non nil \u003ccode\u003eerr\u003c/code\u003e from the\n\u003ccode\u003engx.shared.DICT.set\u003c/code\u003e method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eExample:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n require \u0026quot;resty.core.shdict\u0026quot;\n\n local cats = ngx.shared.cats\n local free_page_bytes = cats:free_space()\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.core.shdict\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecats\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eshared\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecats\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efree_page_bytes\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ecats\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003efree_space\u003c/span\u003e()\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e This method requires the \u003ccode\u003eresty.core.shdict\u003c/code\u003e or \u003ccode\u003eresty.core\u003c/code\u003e modules from the \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least Nginx core version \u003ccode\u003e1.11.7\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.socket.udp\u003c/h2\u003e\u003ca id=\"user-content-ngxsocketudp\" class=\"anchor\" aria-label=\"Permalink: ngx.socket.udp\" href=\"#ngxsocketudp\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eudpsock = ngx.socket.udp()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCreates and returns a UDP or datagram-oriented unix domain socket object (also known as one type of the \"cosocket\" objects). The following methods are supported on this object:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#udpsockbind\"\u003ebind\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksetpeername\"\u003esetpeername\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksend\"\u003esend\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsockreceive\"\u003ereceive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsockclose\"\u003eclose\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#udpsocksettimeout\"\u003esettimeout\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIt is intended to be compatible with the UDP API of the \u003ca href=\"http://w3.impa.br/~diego/software/luasocket/udp.html\" rel=\"nofollow\"\u003eLuaSocket\u003c/a\u003e library but is 100% nonblocking out of the box.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:bind\u003c/h2\u003e\u003ca id=\"user-content-udpsockbind\" class=\"anchor\" aria-label=\"Permalink: udpsock:bind\" href=\"#udpsockbind\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = udpsock:bind(address)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*,ssl_session_fetch_by_lua*,ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind\" rel=\"nofollow\"\u003eproxy_bind\u003c/a\u003e directive, this api makes the outgoing connection to a upstream server originate from the specified local IP address.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly IP addresses can be specified as the \u003ccode\u003eaddress\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example for connecting to a TCP server from the specified local IP address:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     content_by_lua_block {\n         local sock = ngx.socket.udp()\n         -- assume \u0026quot;192.168.1.10\u0026quot; is the local ip address\n         local ok, err = sock:bind(\u0026quot;192.168.1.10\u0026quot;)\n         if not ok then\n             ngx.say(\u0026quot;failed to bind: \u0026quot;, err)\n             return\n         end\n         sock:close()\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local sock = ngx.socket.udp\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         -- assume \u003cspan class=\"pl-s\"\u003e\"192.168.1.10\"\u003c/span\u003e is the local ip address\n         local ok, err = sock:bind\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"192.168.1.10\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to bind: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         sock:close\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:setpeername\u003c/h2\u003e\u003ca id=\"user-content-udpsocksetpeername\" class=\"anchor\" aria-label=\"Permalink: udpsock:setpeername\" href=\"#udpsocksetpeername\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = udpsock:setpeername(host, port)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = udpsock:setpeername(\"unix:/path/to/unix-domain.socket\")\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAttempts to connect a UDP socket object to a remote server or to a datagram unix domain socket file. Because the datagram protocol is actually connection-less, this method does not really establish a \"connection\", but only just set the name of the remote peer for subsequent read/write operations.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBoth IP addresses and domain names can be specified as the \u003ccode\u003ehost\u003c/code\u003e argument. In case of domain names, this method will use Nginx core's dynamic resolver to parse the domain name without blocking and it is required to configure the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver\" rel=\"nofollow\"\u003eresolver\u003c/a\u003e directive in the \u003ccode\u003enginx.conf\u003c/code\u003e file like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n resolver 8.8.8.8;  # use Google's public DNS nameserver\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eresolver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e8.8.8.8\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # \u003cspan class=\"pl-c1\"\u003euse\u003c/span\u003e Google's public DNS nameserver\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf the nameserver returns multiple IP addresses for the host name, this method will pick up one randomly.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of error, the method returns \u003ccode\u003enil\u003c/code\u003e followed by a string describing the error. In case of success, the method returns \u003ccode\u003e1\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example for connecting to a UDP (memcached) server:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     resolver 8.8.8.8;\n\n     content_by_lua_block {\n         local sock = ngx.socket.udp()\n         local ok, err = sock:setpeername(\u0026quot;my.memcached.server.domain\u0026quot;, 11211)\n         if not ok then\n             ngx.say(\u0026quot;failed to connect to memcached: \u0026quot;, err)\n             return\n         end\n         ngx.say(\u0026quot;successfully connected to memcached!\u0026quot;)\n         sock:close()\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eresolver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e8.8.8.8\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local sock = ngx.socket.udp\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         local ok, err = sock:setpeername\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"my.memcached.server.domain\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e11211\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to connect to memcached: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"successfully connected to memcached!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         sock:close\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003ev0.7.18\u003c/code\u003e release, connecting to a datagram unix domain socket file is also possible on Linux:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local sock = ngx.socket.udp()\n local ok, err = sock:setpeername(\u0026quot;unix:/tmp/some-datagram-service.sock\u0026quot;)\n if not ok then\n     ngx.say(\u0026quot;failed to connect to the datagram unix domain socket: \u0026quot;, err)\n     return\n end\n\n -- do something after connect\n -- such as sock:send or sock:receive\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esock\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esocket\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eudp\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetpeername\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eunix:/tmp/some-datagram-service.sock\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to connect to the datagram unix domain socket: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e do something after connect\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e such as sock:send or sock:receive\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eassuming the datagram service is listening on the unix domain socket file \u003ccode\u003e/tmp/some-datagram-service.sock\u003c/code\u003e and the client socket will use the \"autobind\" feature on Linux.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCalling this method on an already connected socket object will cause the original connection to be closed first.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:send\u003c/h2\u003e\u003ca id=\"user-content-udpsocksend\" class=\"anchor\" aria-label=\"Permalink: udpsock:send\" href=\"#udpsocksend\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = udpsock:send(data)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSends data on the current UDP or datagram unix domain socket object.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns \u003ccode\u003e1\u003c/code\u003e. Otherwise, it returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe input argument \u003ccode\u003edata\u003c/code\u003e can either be a Lua string or a (nested) Lua table holding string fragments. In case of table arguments, this method will copy all the string elements piece by piece to the underlying Nginx socket send buffers, which is usually optimal than doing string concatenation operations on the Lua land.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:receive\u003c/h2\u003e\u003ca id=\"user-content-udpsockreceive\" class=\"anchor\" aria-label=\"Permalink: udpsock:receive\" href=\"#udpsockreceive\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edata, err = udpsock:receive(size?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReceives data from the UDP or datagram unix domain socket object with an optional receive buffer size argument, \u003ccode\u003esize\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method is a synchronous operation and is 100% nonblocking.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns the data received; in case of error, it returns \u003ccode\u003enil\u003c/code\u003e with a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the \u003ccode\u003esize\u003c/code\u003e argument is specified, then this method will use this size as the receive buffer size. But when this size is greater than \u003ccode\u003e8192\u003c/code\u003e, then \u003ccode\u003e8192\u003c/code\u003e will be used instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf no argument is specified, then the maximal buffer size, \u003ccode\u003e8192\u003c/code\u003e is assumed.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the reading operation is controlled by the \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e config directive and the \u003ca href=\"#udpsocksettimeout\"\u003esettimeout\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n sock:settimeout(1000)  -- one second timeout\n local data, err = sock:receive()\n if not data then\n     ngx.say(\u0026quot;failed to read a packet: \u0026quot;, err)\n     return\n end\n ngx.say(\u0026quot;successfully read a packet: \u0026quot;, data)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeout\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceive\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read a packet: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esuccessfully read a packet: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is important here to call the \u003ca href=\"#udpsocksettimeout\"\u003esettimeout\u003c/a\u003e method \u003cem\u003ebefore\u003c/em\u003e calling this method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:close\u003c/h2\u003e\u003ca id=\"user-content-udpsockclose\" class=\"anchor\" aria-label=\"Permalink: udpsock:close\" href=\"#udpsockclose\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = udpsock:close()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCloses the current UDP or datagram unix domain socket. It returns the \u003ccode\u003e1\u003c/code\u003e in case of success and returns \u003ccode\u003enil\u003c/code\u003e with a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSocket objects that have not invoked this method (and associated connections) will be closed when the socket object is released by the Lua GC (Garbage Collector) or the current client HTTP request finishes processing.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eudpsock:settimeout\u003c/h2\u003e\u003ca id=\"user-content-udpsocksettimeout\" class=\"anchor\" aria-label=\"Permalink: udpsock:settimeout\" href=\"#udpsocksettimeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eudpsock:settimeout(time)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet the timeout value in milliseconds for subsequent socket operations (like \u003ca href=\"#udpsockreceive\"\u003ereceive\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSettings done by this method takes priority over those config directives, like \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.socket.stream\u003c/h2\u003e\u003ca id=\"user-content-ngxsocketstream\" class=\"anchor\" aria-label=\"Permalink: ngx.socket.stream\" href=\"#ngxsocketstream\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eJust an alias to \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e. If the stream-typed cosocket may also connect to a unix domain\nsocket, then this API name is preferred.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API function was first added to the \u003ccode\u003ev0.10.1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.socket.tcp\u003c/h2\u003e\u003ca id=\"user-content-ngxsockettcp\" class=\"anchor\" aria-label=\"Permalink: ngx.socket.tcp\" href=\"#ngxsockettcp\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock = ngx.socket.tcp()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCreates and returns a TCP or stream-oriented unix domain socket object (also known as one type of the \"cosocket\" objects). The following methods are supported on this object:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockbind\"\u003ebind\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetclientcert\"\u003esetclientcert\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksslhandshake\"\u003esslhandshake\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockclose\"\u003eclose\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetoption\"\u003esetoption\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceiveany\"\u003ereceiveany\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tcpsockgetreusedtimes\"\u003egetreusedtimes\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIt is intended to be compatible with the TCP API of the \u003ca href=\"http://w3.impa.br/~diego/software/luasocket/tcp.html\" rel=\"nofollow\"\u003eLuaSocket\u003c/a\u003e library but is 100% nonblocking out of the box. Also, we introduce some new APIs to provide more functionalities.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe cosocket object created by this API function has exactly the same lifetime as the Lua handler creating it. So never pass the cosocket object to any other Lua handler (including ngx.timer callback functions) and never share the cosocket object between different Nginx requests.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor every cosocket object's underlying connection, if you do not\nexplicitly close it (via \u003ca href=\"#tcpsockclose\"\u003eclose\u003c/a\u003e) or put it back to the connection\npool (via \u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e), then it is automatically closed when one of\nthe following two events happens:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003ethe current request handler completes, or\u003c/li\u003e\n\u003cli\u003ethe Lua cosocket object value gets collected by the Lua GC.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eFatal errors in cosocket operations always automatically close the current\nconnection (note that, read timeout error is the only error that is\nnot fatal), and if you call \u003ca href=\"#tcpsockclose\"\u003eclose\u003c/a\u003e on a closed connection, you will get\nthe \"closed\" error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eStarting from the \u003ccode\u003e0.9.9\u003c/code\u003e release, the cosocket object here is full-duplex, that is, a reader \"light thread\" and a writer \"light thread\" can operate on a single cosocket object simultaneously (both \"light threads\" must belong to the same Lua handler though, see reasons above). But you cannot have two \"light threads\" both reading (or writing or connecting) the same cosocket, otherwise you might get an error like \"socket busy reading\" when calling the methods of the cosocket object.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxsocketudp\"\u003engx.socket.udp\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:bind\u003c/h2\u003e\u003ca id=\"user-content-tcpsockbind\" class=\"anchor\" aria-label=\"Permalink: tcpsock:bind\" href=\"#tcpsockbind\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:bind(address, port?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*,ssl_session_fetch_by_lua*,ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eJust like the standard \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind\" rel=\"nofollow\"\u003eproxy_bind\u003c/a\u003e directive, this api makes the outgoing connection to a upstream server originate from the specified local IP address.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIP addresses can be specified as the \u003ccode\u003eaddress\u003c/code\u003e argument.\nThe optional \u003ccode\u003eport\u003c/code\u003e argument is usually used in the transparent proxy.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example for connecting to a TCP server from the specified local IP address:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     content_by_lua_block {\n         local sock = ngx.socket.tcp()\n         -- assume \u0026quot;192.168.1.10\u0026quot; is the local ip address\n         local ok, err = sock:bind(\u0026quot;192.168.1.10\u0026quot;)\n         if not ok then\n             ngx.say(\u0026quot;failed to bind\u0026quot;)\n             return\n         end\n         local ok, err = sock:connect(\u0026quot;192.168.1.67\u0026quot;, 80)\n         if not ok then\n             ngx.say(\u0026quot;failed to connect server: \u0026quot;, err)\n             return\n         end\n         ngx.say(\u0026quot;successfully connected!\u0026quot;)\n         sock:close()\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local sock = ngx.socket.tcp\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         -- assume \u003cspan class=\"pl-s\"\u003e\"192.168.1.10\"\u003c/span\u003e is the local ip address\n         local ok, err = sock:bind\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"192.168.1.10\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to bind\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         local ok, err = sock:connect\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"192.168.1.67\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e80\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to connect server: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"successfully connected!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         sock:close\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:connect\u003c/h2\u003e\u003ca id=\"user-content-tcpsockconnect\" class=\"anchor\" aria-label=\"Permalink: tcpsock:connect\" href=\"#tcpsockconnect\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:connect(host, port, options_table?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:connect(\"unix:/path/to/unix-domain.socket\", options_table?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAttempts to connect a TCP socket object to a remote server or to a stream unix domain socket file without blocking.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBefore actually resolving the host name and connecting to the remote backend, this method will always look up the connection pool for matched idle connections created by previous calls of this method (or the \u003ca href=\"#ngxsocketconnect\"\u003engx.socket.connect\u003c/a\u003e function).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBoth IP addresses and domain names can be specified as the \u003ccode\u003ehost\u003c/code\u003e argument. In case of domain names, this method will use Nginx core's dynamic resolver to parse the domain name without blocking and it is required to configure the \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver\" rel=\"nofollow\"\u003eresolver\u003c/a\u003e directive in the \u003ccode\u003enginx.conf\u003c/code\u003e file like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n resolver 8.8.8.8;  # use Google's public DNS nameserver\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003eresolver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e8.8.8.8\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e  # \u003cspan class=\"pl-c1\"\u003euse\u003c/span\u003e Google's public DNS nameserver\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIf the nameserver returns multiple IP addresses for the host name, this method will pick up one randomly.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of error, the method returns \u003ccode\u003enil\u003c/code\u003e followed by a string describing the error. In case of success, the method returns \u003ccode\u003e1\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example for connecting to a TCP server:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /test {\n     resolver 8.8.8.8;\n\n     content_by_lua_block {\n         local sock = ngx.socket.tcp()\n         local ok, err = sock:connect(\u0026quot;www.google.com\u0026quot;, 80)\n         if not ok then\n             ngx.say(\u0026quot;failed to connect to google: \u0026quot;, err)\n             return\n         end\n         ngx.say(\u0026quot;successfully connected to google!\u0026quot;)\n         sock:close()\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /test \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003eresolver\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e8.8.8.8\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local sock = ngx.socket.tcp\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n         local ok, err = sock:connect\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"www.google.com\"\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e80\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"failed to connect to google: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"successfully connected to google!\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         sock:close\u003cspan class=\"pl-c1\"\u003e()\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eConnecting to a Unix Domain Socket file is also possible:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local sock = ngx.socket.tcp()\n local ok, err = sock:connect(\u0026quot;unix:/tmp/memcached.sock\u0026quot;)\n if not ok then\n     ngx.say(\u0026quot;failed to connect to the memcached unix domain socket: \u0026quot;, err)\n     return\n end\n\n -- do something after connect\n -- such as sock:send or sock:receive\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esock\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esocket\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003etcp\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003econnect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eunix:/tmp/memcached.sock\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to connect to the memcached unix domain socket: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e do something after connect\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e such as sock:send or sock:receive\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eassuming memcached (or something else) is listening on the unix domain socket file \u003ccode\u003e/tmp/memcached.sock\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the connecting operation is controlled by the \u003ca href=\"#lua_socket_connect_timeout\"\u003elua_socket_connect_timeout\u003c/a\u003e config directive and the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local sock = ngx.socket.tcp()\n sock:settimeout(1000)  -- one second timeout\n local ok, err = sock:connect(host, port)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esock\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esocket\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003etcp\u003c/span\u003e()\n \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeout\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003econnect\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ehost\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eport\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is important here to call the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method \u003cem\u003ebefore\u003c/em\u003e calling this method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCalling this method on an already connected socket object will cause the original connection to be closed first.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAn optional Lua table can be specified as the last argument to this method to specify various connect options:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003epool\u003c/code\u003e\nspecify a custom name for the connection pool being used. If omitted, then the connection pool name will be generated from the string template \u003ccode\u003e\"\u0026lt;host\u0026gt;:\u0026lt;port\u0026gt;\"\u003c/code\u003e or \u003ccode\u003e\"\u0026lt;unix-socket-path\u0026gt;\"\u003c/code\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003epool_size\u003c/code\u003e\nspecify the size of the connection pool. If omitted and no\n\u003ccode\u003ebacklog\u003c/code\u003e option was provided, no pool will be created. If omitted\nbut \u003ccode\u003ebacklog\u003c/code\u003e was provided, the pool will be created with a default\nsize equal to the value of the \u003ca href=\"#lua_socket_pool_size\"\u003elua_socket_pool_size\u003c/a\u003e\ndirective.\nThe connection pool holds up to \u003ccode\u003epool_size\u003c/code\u003e alive connections\nready to be reused by subsequent calls to \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e, but\nnote that there is no upper limit to the total number of opened connections\noutside of the pool. If you need to restrict the total number of opened\nconnections, specify the \u003ccode\u003ebacklog\u003c/code\u003e option.\nWhen the connection pool would exceed its size limit, the least recently used\n(kept-alive) connection already in the pool will be closed to make room for\nthe current connection.\nNote that the cosocket connection pool is per Nginx worker process rather\nthan per Nginx server instance, so the size limit specified here also applies\nto every single Nginx worker process. Also note that the size of the connection\npool cannot be changed once it has been created.\nThis option was first introduced in the \u003ccode\u003ev0.10.14\u003c/code\u003e release.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003ebacklog\u003c/code\u003e\nif specified, this module will limit the total number of opened connections\nfor this pool. No more connections than \u003ccode\u003epool_size\u003c/code\u003e can be opened\nfor this pool at any time. If \u003ccode\u003epool_size\u003c/code\u003e number of connections are in use,\nsubsequent connect operations will be queued into a queue equal to this\noption's value (the \"backlog\" queue).\nIf the number of queued connect operations is equal to \u003ccode\u003ebacklog\u003c/code\u003e,\nsubsequent connect operations will fail and return \u003ccode\u003enil\u003c/code\u003e plus the\nerror string \u003ccode\u003e\"too many waiting connect operations\"\u003c/code\u003e.\nThe queued connect operations will be resumed once the number of active\nconnections becomes less than \u003ccode\u003epool_size\u003c/code\u003e.\nThe queued connect operation will abort once they have been queued for more\nthan \u003ccode\u003econnect_timeout\u003c/code\u003e, controlled by\n\u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e, and will return \u003ccode\u003enil\u003c/code\u003e plus\nthe error string \u003ccode\u003e\"timeout\"\u003c/code\u003e.\nThis option was first introduced in the \u003ccode\u003ev0.10.14\u003c/code\u003e release.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe support for the options table argument was first introduced in the \u003ccode\u003ev0.5.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:getfd\u003c/h2\u003e\u003ca id=\"user-content-tcpsockgetfd\" class=\"anchor\" aria-label=\"Permalink: tcpsock:getfd\" href=\"#tcpsockgetfd\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003efd, err = tcpsock:getfd()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eGet the file descriptor of the current tcp socket.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.10.29\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:setclientcert\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksetclientcert\" class=\"anchor\" aria-label=\"Permalink: tcpsock:setclientcert\" href=\"#tcpsocksetclientcert\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:setclientcert(cert, pkey)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet client certificate chain and corresponding private key to the TCP socket object.\nThe certificate chain and private key provided will be used later by the \u003ca href=\"#tcpsocksslhandshake\"\u003etcpsock:sslhandshake\u003c/a\u003e method.\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003ecert\u003c/code\u003e specify a client certificate chain cdata object that will be used while handshaking with\nremote server. These objects can be created using \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_cert\"\u003engx.ssl.parse_pem_cert\u003c/a\u003e or \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_der_cert\"\u003engx.ssl.parse_der_cert\u003c/a\u003e\nfunction provided by lua-resty-core. Note that specifying the \u003ccode\u003ecert\u003c/code\u003e option requires\ncorresponding \u003ccode\u003epkey\u003c/code\u003e be provided too. See below.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epkey\u003c/code\u003e specify a private key corresponds to the \u003ccode\u003ecert\u003c/code\u003e option above.\nThese objects can be created using \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_priv_key\"\u003engx.ssl.parse_pem_priv_key\u003c/a\u003e or \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_der_priv_key\"\u003engx.ssl.parse_der_priv_key\u003c/a\u003e\nfunction provided by lua-resty-core.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIf both of \u003ccode\u003ecert\u003c/code\u003e and \u003ccode\u003epkey\u003c/code\u003e are \u003ccode\u003enil\u003c/code\u003e, this method will clear any existing client certificate and private key\nthat was previously set on the cosocket object.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.10.22\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:sslhandshake\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksslhandshake\" class=\"anchor\" aria-label=\"Permalink: tcpsock:sslhandshake\" href=\"#tcpsocksslhandshake\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esession, err = tcpsock:sslhandshake(reused_session?, server_name?, ssl_verify?, send_status_req?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDoes SSL/TLS handshake on the currently established connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003ereused_session\u003c/code\u003e argument can take a former SSL\nsession userdata returned by a previous \u003ccode\u003esslhandshake\u003c/code\u003e\ncall for exactly the same target. For short-lived connections, reusing SSL\nsessions can usually speed up the handshake by one order by magnitude but it\nis not so useful if the connection pool is enabled. This argument defaults to\n\u003ccode\u003enil\u003c/code\u003e. If this argument takes the boolean \u003ccode\u003efalse\u003c/code\u003e value, no SSL session\nuserdata would return by this call and only a Lua boolean will be returned as\nthe first return value; otherwise the current SSL session will\nalways be returned as the first argument in case of successes.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003eserver_name\u003c/code\u003e argument is used to specify the server\nname for the new TLS extension Server Name Indication (SNI). Use of SNI can\nmake different servers share the same IP address on the server side. Also,\nwhen SSL verification is enabled, this \u003ccode\u003eserver_name\u003c/code\u003e argument is\nalso used to validate the server name specified in the server certificate sent from\nthe remote.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003essl_verify\u003c/code\u003e argument takes a Lua boolean value to\ncontrol whether to perform SSL verification. When set to \u003ccode\u003etrue\u003c/code\u003e, the server\ncertificate will be verified according to the CA certificates specified by\nthe \u003ca href=\"#lua_ssl_trusted_certificate\"\u003elua_ssl_trusted_certificate\u003c/a\u003e directive.\nYou may also need to adjust the \u003ca href=\"#lua_ssl_verify_depth\"\u003elua_ssl_verify_depth\u003c/a\u003e\ndirective to control how deep we should follow along the certificate chain.\nAlso, when the \u003ccode\u003essl_verify\u003c/code\u003e argument is true and the\n\u003ccode\u003eserver_name\u003c/code\u003e argument is also specified, the latter will be used\nto validate the server name in the server certificate.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe optional \u003ccode\u003esend_status_req\u003c/code\u003e argument takes a boolean that controls whether to send\nthe OCSP status request in the SSL handshake request (which is for requesting OCSP stapling).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor connections that have already done SSL/TLS handshake, this method returns\nimmediately.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.9.11\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:send\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksend\" class=\"anchor\" aria-label=\"Permalink: tcpsock:send\" href=\"#tcpsocksend\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ebytes, err = tcpsock:send(data)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSends data without blocking on the current TCP or Unix Domain Socket connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method is a synchronous operation that will not return until \u003cem\u003eall\u003c/em\u003e the data has been flushed into the system socket send buffer or an error occurs.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns the total number of bytes that have been sent. Otherwise, it returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe input argument \u003ccode\u003edata\u003c/code\u003e can either be a Lua string or a (nested) Lua table holding string fragments. In case of table arguments, this method will copy all the string elements piece by piece to the underlying Nginx socket send buffers, which is usually optimal than doing string concatenation operations on the Lua land.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the sending operation is controlled by the \u003ca href=\"#lua_socket_send_timeout\"\u003elua_socket_send_timeout\u003c/a\u003e config directive and the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n sock:settimeout(1000)  -- one second timeout\n local bytes, err = sock:send(request)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeout\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ebytes\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esend\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003erequest\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is important here to call the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method \u003cem\u003ebefore\u003c/em\u003e calling this method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of any connection errors, this method always automatically closes the current connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:receive\u003c/h2\u003e\u003ca id=\"user-content-tcpsockreceive\" class=\"anchor\" aria-label=\"Permalink: tcpsock:receive\" href=\"#tcpsockreceive\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edata, err, partial = tcpsock:receive(size)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edata, err, partial = tcpsock:receive(pattern?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReceives data from the connected socket according to the reading pattern or size.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method is a synchronous operation just like the \u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e method and is 100% nonblocking.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns the data received; in case of error, it returns \u003ccode\u003enil\u003c/code\u003e with a string describing the error and the partial data received so far.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf a number-like argument is specified (including strings that look like numbers), then it is interpreted as a size. This method will not return until it reads exactly this size of data or an error occurs.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf a non-number-like string argument is specified, then it is interpreted as a \"pattern\". The following patterns are supported:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003e'*a'\u003c/code\u003e: reads from the socket until the connection is closed. No end-of-line translation is performed;\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e'*l'\u003c/code\u003e: reads a line of text from the socket. The line is terminated by a \u003ccode\u003eLine Feed\u003c/code\u003e (LF) character (ASCII 10), optionally preceded by a \u003ccode\u003eCarriage Return\u003c/code\u003e (CR) character (ASCII 13). The CR and LF characters are not included in the returned line. In fact, all CR characters are ignored by the pattern.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eIf no argument is specified, then it is assumed to be the pattern \u003ccode\u003e'*l'\u003c/code\u003e, that is, the line reading pattern.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the reading operation is controlled by the \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e config directive and the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n sock:settimeout(1000)  -- one second timeout\n local line, err, partial = sock:receive()\n if not line then\n     ngx.say(\u0026quot;failed to read a line: \u0026quot;, err)\n     return\n end\n ngx.say(\u0026quot;successfully read a line: \u0026quot;, line)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeout\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003epartial\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceive\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read a line: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esuccessfully read a line: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is important here to call the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method \u003cem\u003ebefore\u003c/em\u003e calling this method.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003ev0.8.8\u003c/code\u003e release, this method no longer automatically closes the current connection when the read timeout error happens. For other connection errors, this method always automatically closes the connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:receiveany\u003c/h2\u003e\u003ca id=\"user-content-tcpsockreceiveany\" class=\"anchor\" aria-label=\"Permalink: tcpsock:receiveany\" href=\"#tcpsockreceiveany\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edata, err = tcpsock:receiveany(max)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns any data received by the connected socket, at most \u003ccode\u003emax\u003c/code\u003e bytes.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method is a synchronous operation just like the \u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e method and is 100% nonblocking.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns the data received; in case of error, it returns \u003ccode\u003enil\u003c/code\u003e with a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the received data is more than this size, this method will return with exactly this size of data.\nThe remaining data in the underlying receive buffer could be returned in the next reading operation.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the reading operation is controlled by the \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e config directive and the \u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n sock:settimeouts(1000, 1000, 1000)  -- one second timeout for connect/read/write\n local data, err = sock:receiveany(10 * 1024) -- read any data, at most 10K\n if not data then\n     ngx.say(\u0026quot;failed to read any data: \u0026quot;, err)\n     return\n end\n ngx.say(\u0026quot;successfully read: \u0026quot;, data)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeouts\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout for connect/read/write\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceiveany\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e1024\u003c/span\u003e) \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e read any data, at most 10K\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read any data: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esuccessfully read: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis method doesn't automatically close the current connection when the read timeout error occurs. For other connection errors, this method always automatically closes the connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.14\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:receiveuntil\u003c/h2\u003e\u003ca id=\"user-content-tcpsockreceiveuntil\" class=\"anchor\" aria-label=\"Permalink: tcpsock:receiveuntil\" href=\"#tcpsockreceiveuntil\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eiterator = tcpsock:receiveuntil(pattern, options?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method returns an iterator Lua function that can be called to read the data stream until it sees the specified pattern or an error occurs.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is an example for using this method to read a data stream with the boundary sequence \u003ccode\u003e--abcedhb\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local reader = sock:receiveuntil(\u0026quot;\\r\\n--abcedhb\u0026quot;)\n local data, err, partial = reader()\n if not data then\n     ngx.say(\u0026quot;failed to read the data stream: \u0026quot;, err)\n end\n ngx.say(\u0026quot;read the data stream: \u0026quot;, data)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ereader\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceiveuntil\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003e--abcedhb\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003epartial\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ereader\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read the data stream: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eread the data stream: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhen called without any argument, the iterator function returns the received data right \u003cem\u003ebefore\u003c/em\u003e the specified pattern string in the incoming data stream. So for the example above, if the incoming data stream is \u003ccode\u003e'hello, world! -agentzh\\r\\n--abcedhb blah blah'\u003c/code\u003e, then the string \u003ccode\u003e'hello, world! -agentzh'\u003c/code\u003e will be returned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of error, the iterator function will return \u003ccode\u003enil\u003c/code\u003e along with a string describing the error and the partial data bytes that have been read so far.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe iterator function can be called multiple times and can be mixed safely with other cosocket method calls or other iterator function calls.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe iterator function behaves differently (i.e., like a real iterator) when it is called with a \u003ccode\u003esize\u003c/code\u003e argument. That is, it will read that \u003ccode\u003esize\u003c/code\u003e of data on each invocation and will return \u003ccode\u003enil\u003c/code\u003e at the last invocation (either sees the boundary pattern or meets an error). For the last successful invocation of the iterator function, the \u003ccode\u003eerr\u003c/code\u003e return value will be \u003ccode\u003enil\u003c/code\u003e too. The iterator function will be reset after the last successful invocation that returns \u003ccode\u003enil\u003c/code\u003e data and \u003ccode\u003enil\u003c/code\u003e error. Consider the following example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local reader = sock:receiveuntil(\u0026quot;\\r\\n--abcedhb\u0026quot;)\n\n while true do\n     local data, err, partial = reader(4)\n     if not data then\n         if err then\n             ngx.say(\u0026quot;failed to read the data stream: \u0026quot;, err)\n             break\n         end\n\n         ngx.say(\u0026quot;read done\u0026quot;)\n         break\n     end\n     ngx.say(\u0026quot;read chunk: [\u0026quot;, data, \u0026quot;]\u0026quot;)\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ereader\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceiveuntil\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003e--abcedhb\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n\n \u003cspan class=\"pl-k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003epartial\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ereader\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e4\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n             \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read the data stream: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n             \u003cspan class=\"pl-k\"\u003ebreak\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eread done\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ebreak\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eread chunk: [\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e]\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen for the incoming data stream \u003ccode\u003e'hello, world! -agentzh\\r\\n--abcedhb blah blah'\u003c/code\u003e, we shall get the following output from the sample code above:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"read chunk: [hell]\nread chunk: [o, w]\nread chunk: [orld]\nread chunk: [! -a]\nread chunk: [gent]\nread chunk: [zh]\nread done\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003eread chunk: [hell]\nread chunk: [o, w]\nread chunk: [orld]\nread chunk: [! -a]\nread chunk: [gent]\nread chunk: [zh]\nread done\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eNote that, the actual data returned \u003cem\u003emight\u003c/em\u003e be a little longer than the size limit specified by the \u003ccode\u003esize\u003c/code\u003e argument when the boundary pattern has ambiguity for streaming parsing. Near the boundary of the data stream, the data string actually returned could also be shorter than the size limit.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eTimeout for the iterator function's reading operation is controlled by the \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e config directive and the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method. And the latter takes priority. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local readline = sock:receiveuntil(\u0026quot;\\r\\n\u0026quot;)\n\n sock:settimeout(1000)  -- one second timeout\n line, err, partial = readline()\n if not line then\n     ngx.say(\u0026quot;failed to read a line: \u0026quot;, err)\n     return\n end\n ngx.say(\u0026quot;successfully read a line: \u0026quot;, line)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ereadline\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceiveuntil\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003cspan class=\"pl-cce\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n\n \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esettimeout\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e1000\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e one second timeout\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003epartial\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ereadline\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to read a line: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esuccessfully read a line: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eline\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is important here to call the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method \u003cem\u003ebefore\u003c/em\u003e calling the iterator function (note that the \u003ccode\u003ereceiveuntil\u003c/code\u003e call is irrelevant here).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAs from the \u003ccode\u003ev0.5.1\u003c/code\u003e release, this method also takes an optional \u003ccode\u003eoptions\u003c/code\u003e table argument to control the behavior. The following options are supported:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003einclusive\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003einclusive\u003c/code\u003e takes a boolean value to control whether to include the pattern string in the returned data string. Default to \u003ccode\u003efalse\u003c/code\u003e. For example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local reader = tcpsock:receiveuntil(\u0026quot;_END_\u0026quot;, { inclusive = true })\n local data = reader()\n ngx.say(data)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ereader\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ereceiveuntil\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e_END_\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, { \u003cspan class=\"pl-smi\"\u003einclusive\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e })\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ereader\u003c/span\u003e()\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003edata\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen for the input data stream \u003ccode\u003e\"hello world _END_ blah blah blah\"\u003c/code\u003e, then the example above will output \u003ccode\u003ehello world _END_\u003c/code\u003e, including the pattern string \u003ccode\u003e_END_\u003c/code\u003e itself.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSince the \u003ccode\u003ev0.8.8\u003c/code\u003e release, this method no longer automatically closes the current connection when the read timeout error happens. For other connection errors, this method always automatically closes the connection.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:close\u003c/h2\u003e\u003ca id=\"user-content-tcpsockclose\" class=\"anchor\" aria-label=\"Permalink: tcpsock:close\" href=\"#tcpsockclose\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:close()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCloses the current TCP or stream unix domain socket. It returns the \u003ccode\u003e1\u003c/code\u003e in case of success and returns \u003ccode\u003enil\u003c/code\u003e with a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that there is no need to call this method on socket objects that have invoked the \u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e method because the socket object is already closed (and the current connection is saved into the built-in connection pool).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSocket objects that have not invoked this method (and associated connections) will be closed when the socket object is released by the Lua GC (Garbage Collector) or the current client HTTP request finishes processing.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:settimeout\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksettimeout\" class=\"anchor\" aria-label=\"Permalink: tcpsock:settimeout\" href=\"#tcpsocksettimeout\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock:settimeout(time)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSet the timeout value in milliseconds for subsequent socket operations (\u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e, \u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e, and iterators returned from \u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSettings done by this method take priority over those specified via config directives (i.e. \u003ca href=\"#lua_socket_connect_timeout\"\u003elua_socket_connect_timeout\u003c/a\u003e, \u003ca href=\"#lua_socket_send_timeout\"\u003elua_socket_send_timeout\u003c/a\u003e, and \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this method does \u003cem\u003enot\u003c/em\u003e affect the \u003ca href=\"#lua_socket_keepalive_timeout\"\u003elua_socket_keepalive_timeout\u003c/a\u003e setting; the \u003ccode\u003etimeout\u003c/code\u003e argument to the \u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e method should be used for this purpose instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:settimeouts\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksettimeouts\" class=\"anchor\" aria-label=\"Permalink: tcpsock:settimeouts\" href=\"#tcpsocksettimeouts\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock:settimeouts(connect_timeout, send_timeout, read_timeout)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRespectively sets the connect, send, and read timeout thresholds (in milliseconds) for subsequent socket\noperations (\u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e, \u003ca href=\"#tcpsocksend\"\u003esend\u003c/a\u003e, \u003ca href=\"#tcpsockreceive\"\u003ereceive\u003c/a\u003e, and iterators returned from \u003ca href=\"#tcpsockreceiveuntil\"\u003ereceiveuntil\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSettings done by this method take priority over those specified via config directives (i.e. \u003ca href=\"#lua_socket_connect_timeout\"\u003elua_socket_connect_timeout\u003c/a\u003e, \u003ca href=\"#lua_socket_send_timeout\"\u003elua_socket_send_timeout\u003c/a\u003e, and \u003ca href=\"#lua_socket_read_timeout\"\u003elua_socket_read_timeout\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIt is recommended to use \u003ca href=\"#tcpsocksettimeouts\"\u003esettimeouts\u003c/a\u003e instead of \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eNote that this method does \u003cem\u003enot\u003c/em\u003e affect the \u003ca href=\"#lua_socket_keepalive_timeout\"\u003elua_socket_keepalive_timeout\u003c/a\u003e setting; the \u003ccode\u003etimeout\u003c/code\u003e argument to the \u003ca href=\"#tcpsocksetkeepalive\"\u003esetkeepalive\u003c/a\u003e method should be used for this purpose instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.10.7\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:setoption\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksetoption\" class=\"anchor\" aria-label=\"Permalink: tcpsock:setoption\" href=\"#tcpsocksetoption\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:setoption(option, value?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function is added for \u003ca href=\"http://w3.impa.br/~diego/software/luasocket/tcp.html\" rel=\"nofollow\"\u003eLuaSocket\u003c/a\u003e API compatibility, its functionality is implemented \u003ccode\u003ev0.10.18\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, it returns \u003ccode\u003etrue\u003c/code\u003e. Otherwise, it returns nil and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eoption\u003c/code\u003e is a string with the option name, and the value depends on the option being set:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003ekeepalive\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSetting this option to true enables sending of keep-alive messages on\nconnection-oriented sockets. Make sure the \u003ccode\u003econnect\u003c/code\u003e function\nhad been called before, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocal ok, err = tcpsock:setoption(\u0026quot;keepalive\u0026quot;, true)\nif not ok then\n    ngx.say(\u0026quot;setoption keepalive failed: \u0026quot;, err)\nend\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ekeepalive\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption keepalive failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003ereuseaddr\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eEnabling this option indicates that the rules used in validating addresses\nsupplied in a call to bind should allow reuse of local addresses. Make sure\nthe \u003ccode\u003econnect\u003c/code\u003e function had been called before, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocal ok, err = tcpsock:setoption(\u0026quot;reuseaddr\u0026quot;, 0)\nif not ok then\n    ngx.say(\u0026quot;setoption reuseaddr failed: \u0026quot;, err)\nend\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ereuseaddr\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption reuseaddr failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003etcp-nodelay\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSetting this option to true disables the Nagle's algorithm for the connection.\nMake sure the \u003ccode\u003econnect\u003c/code\u003e function had been called before, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocal ok, err = tcpsock:setoption(\u0026quot;tcp-nodelay\u0026quot;, true)\nif not ok then\n    ngx.say(\u0026quot;setoption tcp-nodelay failed: \u0026quot;, err)\nend\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etcp-nodelay\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption tcp-nodelay failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003esndbuf\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets the maximum socket send buffer in bytes. The kernel doubles this value\n(to allow space for bookkeeping overhead) when it is set using setsockopt().\nMake sure the \u003ccode\u003econnect\u003c/code\u003e function had been called before, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocal ok, err = tcpsock:setoption(\u0026quot;sndbuf\u0026quot;, 1024 * 10)\nif not ok then\n    ngx.say(\u0026quot;setoption sndbuf failed: \u0026quot;, err)\nend\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esndbuf\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1024\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption sndbuf failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003ercvbuf\u003c/code\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSets the maximum socket receive buffer in bytes. The kernel doubles this value\n(to allow space for bookkeeping overhead) when it is set using setsockopt. Make\nsure the \u003ccode\u003econnect\u003c/code\u003e function had been called before, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\nlocal ok, err = tcpsock:setoption(\u0026quot;rcvbuf\u0026quot;, 1024 * 10)\nif not ok then\n    ngx.say(\u0026quot;setoption rcvbuf failed: \u0026quot;, err)\nend\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ercvbuf\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1024\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption rcvbuf failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eNOTE: Once the option is set, it will become effective until the connection is closed. If you know the connection is from the connection pool and all the in-pool connections already have called the setoption() method with the desired socket option state, then you can just skip calling setoption() again to avoid the overhead of repeated calls, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local count, err = tcpsock:getreusedtimes()\n if not count then\n     ngx.say(\u0026quot;getreusedtimes failed: \u0026quot;, err)\n     return\n end\n\n if count == 0 then\n     local ok, err = tcpsock:setoption(\u0026quot;rcvbuf\u0026quot;, 1024 * 10)\n     if not ok then\n         ngx.say(\u0026quot;setoption rcvbuf failed: \u0026quot;, err)\n         return\n     end\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecount\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003egetreusedtimes\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecount\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003egetreusedtimes failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecount\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e==\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003etcpsock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003esetoption\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ercvbuf\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e1024\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e*\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e10\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esetoption rcvbuf failed: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThese options described above are supported in \u003ccode\u003ev0.10.18\u003c/code\u003e, and more options will be implemented in future.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:setkeepalive\u003c/h2\u003e\u003ca id=\"user-content-tcpsocksetkeepalive\" class=\"anchor\" aria-label=\"Permalink: tcpsock:setkeepalive\" href=\"#tcpsocksetkeepalive\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = tcpsock:setkeepalive(timeout?, size?)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePuts the current socket's connection immediately into the cosocket built-in connection pool and keep it alive until other \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e method calls request it or the associated maximal idle timeout is expired.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe first optional argument, \u003ccode\u003etimeout\u003c/code\u003e, can be used to specify the maximal idle timeout (in milliseconds) for the current connection. If omitted, the default setting in the \u003ca href=\"#lua_socket_keepalive_timeout\"\u003elua_socket_keepalive_timeout\u003c/a\u003e config directive will be used. If the \u003ccode\u003e0\u003c/code\u003e value is given, then the timeout interval is unlimited.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe second optional argument \u003ccode\u003esize\u003c/code\u003e is considered deprecated since\nthe \u003ccode\u003ev0.10.14\u003c/code\u003e release of this module, in favor of the\n\u003ccode\u003epool_size\u003c/code\u003e option of the \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e method.\nSince the \u003ccode\u003ev0.10.14\u003c/code\u003e release, this option will only take effect if\nthe call to \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e did not already create a connection\npool.\nWhen this option takes effect (no connection pool was previously created by\n\u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e), it will specify the size of the connection pool,\nand create it.\nIf omitted (and no pool was previously created), the default size is the value\nof the \u003ca href=\"#lua_socket_pool_size\"\u003elua_socket_pool_size\u003c/a\u003e directive.\nThe connection pool holds up to \u003ccode\u003esize\u003c/code\u003e alive connections ready to be\nreused by subsequent calls to \u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e, but note that there\nis no upper limit to the total number of opened connections outside of the\npool.\nWhen the connection pool would exceed its size limit, the least recently used\n(kept-alive) connection already in the pool will be closed to make room for\nthe current connection.\nNote that the cosocket connection pool is per Nginx worker process rather\nthan per Nginx server instance, so the size limit specified here also applies\nto every single Nginx worker process. Also note that the size of the connection\npool cannot be changed once it has been created.\nIf you need to restrict the total number of opened connections, specify both\nthe \u003ccode\u003epool_size\u003c/code\u003e and \u003ccode\u003ebacklog\u003c/code\u003e option in the call to\n\u003ca href=\"#tcpsockconnect\"\u003econnect\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIn case of success, this method returns \u003ccode\u003e1\u003c/code\u003e; otherwise, it returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen the system receive buffer for the current connection has unread data, then this method will return the \"connection in dubious state\" error message (as the second return value) because the previous session has unread data left behind for the next session and the connection is not safe to be reused.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method also makes the current cosocket object enter the \"closed\" state, so there is no need to manually call the \u003ca href=\"#tcpsockclose\"\u003eclose\u003c/a\u003e method on it afterwards.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003etcpsock:getreusedtimes\u003c/h2\u003e\u003ca id=\"user-content-tcpsockgetreusedtimes\" class=\"anchor\" aria-label=\"Permalink: tcpsock:getreusedtimes\" href=\"#tcpsockgetreusedtimes\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecount, err = tcpsock:getreusedtimes()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis method returns the (successfully) reused times for the current connection. In case of error, it returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIf the current connection does not come from the built-in connection pool, then this method always returns \u003ccode\u003e0\u003c/code\u003e, that is, the connection has never been reused (yet). If the connection comes from the connection pool, then the return value is always non-zero. So this method can also be used to determine if the current connection comes from the pool.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.socket.connect\u003c/h2\u003e\u003ca id=\"user-content-ngxsocketconnect\" class=\"anchor\" aria-label=\"Permalink: ngx.socket.connect\" href=\"#ngxsocketconnect\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock, err = ngx.socket.connect(host, port)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003etcpsock, err = ngx.socket.connect(\"unix:/path/to/unix-domain.socket\")\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function is a shortcut for combining \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp()\u003c/a\u003e and the \u003ca href=\"#tcpsockconnect\"\u003econnect()\u003c/a\u003e method call in a single operation. It is actually implemented like this:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local sock = ngx.socket.tcp()\n local ok, err = sock:connect(...)\n if not ok then\n     return nil, err\n end\n return sock\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esock\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esocket\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003etcp\u003c/span\u003e()\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003esock\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003econnect\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e...\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003enil\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esock\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThere is no way to use the \u003ca href=\"#tcpsocksettimeout\"\u003esettimeout\u003c/a\u003e method to specify connecting timeout for this method and the \u003ca href=\"#lua_socket_connect_timeout\"\u003elua_socket_connect_timeout\u003c/a\u003e directive must be set at configure time instead.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature was first introduced in the \u003ccode\u003ev0.5.0rc1\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.get_phase\u003c/h2\u003e\u003ca id=\"user-content-ngxget_phase\" class=\"anchor\" aria-label=\"Permalink: ngx.get_phase\" href=\"#ngxget_phase\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.get_phase()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRetrieves the current running phase name. Possible return values are\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003einit\u003c/code\u003e\nfor the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003einit_worker\u003c/code\u003e\nfor the context of \u003ca href=\"#init_worker_by_lua\"\u003einit_worker_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003essl_cert\u003c/code\u003e\nfor the context of \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003essl_session_fetch\u003c/code\u003e\nfor the context of \u003ca href=\"#ssl_session_fetch_by_lua_block\"\u003essl_session_fetch_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003essl_session_store\u003c/code\u003e\nfor the context of \u003ca href=\"#ssl_session_store_by_lua_block\"\u003essl_session_store_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003essl_client_hello\u003c/code\u003e\nfor the context of \u003ca href=\"#ssl_client_hello_by_lua_block\"\u003essl_client_hello_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eset\u003c/code\u003e\nfor the context of \u003ca href=\"#set_by_lua\"\u003eset_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erewrite\u003c/code\u003e\nfor the context of \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebalancer\u003c/code\u003e\nfor the context of \u003ca href=\"#balancer_by_lua_block\"\u003ebalancer_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eaccess\u003c/code\u003e\nfor the context of \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003econtent\u003c/code\u003e\nfor the context of \u003ca href=\"#content_by_lua\"\u003econtent_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eheader_filter\u003c/code\u003e\nfor the context of \u003ca href=\"#header_filter_by_lua\"\u003eheader_filter_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebody_filter\u003c/code\u003e\nfor the context of \u003ca href=\"#body_filter_by_lua\"\u003ebody_filter_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog\u003c/code\u003e\nfor the context of \u003ca href=\"#log_by_lua\"\u003elog_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etimer\u003c/code\u003e\nfor the context of user callback functions for \u003ca href=\"#ngxtimerat\"\u003engx.timer.*\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eexit_worker\u003c/code\u003e\nfor the context of \u003ca href=\"#exit_worker_by_lua\"\u003eexit_worker_by_lua*\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.5.10\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.thread.spawn\u003c/h2\u003e\u003ca id=\"user-content-ngxthreadspawn\" class=\"anchor\" aria-label=\"Permalink: ngx.thread.spawn\" href=\"#ngxthreadspawn\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eco = ngx.thread.spawn(func, arg1, arg2, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSpawns a new user \"light thread\" with the Lua function \u003ccode\u003efunc\u003c/code\u003e as well as those optional arguments \u003ccode\u003earg1\u003c/code\u003e, \u003ccode\u003earg2\u003c/code\u003e, and etc. Returns a Lua thread (or Lua coroutine) object represents this \"light thread\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\"Light threads\" are just a special kind of Lua coroutines that are scheduled by the ngx_lua module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBefore \u003ccode\u003engx.thread.spawn\u003c/code\u003e returns, the \u003ccode\u003efunc\u003c/code\u003e will be called with those optional arguments until it returns, aborts with an error, or gets yielded due to I/O operations via the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e (like \u003ca href=\"#tcpsockreceive\"\u003etcpsock:receive\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAfter \u003ccode\u003engx.thread.spawn\u003c/code\u003e returns, the newly-created \"light thread\" will keep running asynchronously usually at various I/O events.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAll the Lua code chunks running by \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua\u003c/a\u003e, \u003ca href=\"#access_by_lua\"\u003eaccess_by_lua\u003c/a\u003e, and \u003ca href=\"#content_by_lua\"\u003econtent_by_lua\u003c/a\u003e are in a boilerplate \"light thread\" created automatically by ngx_lua. Such boilerplate \"light thread\" are also called \"entry threads\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBy default, the corresponding Nginx handler (e.g., \u003ca href=\"#rewrite_by_lua\"\u003erewrite_by_lua\u003c/a\u003e handler) will not terminate until\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003eboth the \"entry thread\" and all the user \"light threads\" terminates,\u003c/li\u003e\n\u003cli\u003ea \"light thread\" (either the \"entry thread\" or a user \"light thread\") aborts by calling \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e, \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e, \u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e, or \u003ca href=\"#ngxreqset_uri\"\u003engx.req.set_uri(uri, true)\u003c/a\u003e, or\u003c/li\u003e\n\u003cli\u003ethe \"entry thread\" terminates with a Lua error.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eWhen the user \"light thread\" terminates with a Lua error, however, it will not abort other running \"light threads\" like the \"entry thread\" does.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eDue to the limitation in the Nginx subrequest model, it is not allowed to abort a running Nginx subrequest in general. So it is also prohibited to abort a running \"light thread\" that is pending on one ore more Nginx subrequests. You must call \u003ca href=\"#ngxthreadwait\"\u003engx.thread.wait\u003c/a\u003e to wait for those \"light thread\" to terminate before quitting the \"world\". A notable exception here is that you can abort pending subrequests by calling \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e with and only with the status code \u003ccode\u003engx.ERROR\u003c/code\u003e (-1), \u003ccode\u003e408\u003c/code\u003e, \u003ccode\u003e444\u003c/code\u003e, or \u003ccode\u003e499\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \"light threads\" are not scheduled in a pre-emptive way. In other words, no time-slicing is performed automatically. A \"light thread\" will keep running exclusively on the CPU until\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ea (nonblocking) I/O operation cannot be completed in a single run,\u003c/li\u003e\n\u003cli\u003eit calls \u003ca href=\"#coroutineyield\"\u003ecoroutine.yield\u003c/a\u003e to actively give up execution, or\u003c/li\u003e\n\u003cli\u003eit is aborted by a Lua error or an invocation of \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e, \u003ca href=\"#ngxexec\"\u003engx.exec\u003c/a\u003e, \u003ca href=\"#ngxredirect\"\u003engx.redirect\u003c/a\u003e, or \u003ca href=\"#ngxreqset_uri\"\u003engx.req.set_uri(uri, true)\u003c/a\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eFor the first two cases, the \"light thread\" will usually be resumed later by the ngx_lua scheduler unless a \"stop-the-world\" event happens.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUser \"light threads\" can create \"light threads\" themselves. And normal user coroutines created by \u003ca href=\"#coroutinecreate\"\u003ecoroutine.create\u003c/a\u003e can also create \"light threads\". The coroutine (be it a normal Lua coroutine or a \"light thread\") that directly spawns the \"light thread\" is called the \"parent coroutine\" for the \"light thread\" newly spawned.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe \"parent coroutine\" can call \u003ca href=\"#ngxthreadwait\"\u003engx.thread.wait\u003c/a\u003e to wait on the termination of its child \"light thread\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can call coroutine.status() and coroutine.yield() on the \"light thread\" coroutines.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe status of the \"light thread\" coroutine can be \"zombie\" if\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003ethe current \"light thread\" already terminates (either successfully or with an error),\u003c/li\u003e\n\u003cli\u003eits parent coroutine is still alive, and\u003c/li\u003e\n\u003cli\u003eits parent coroutine is not waiting on it with \u003ca href=\"#ngxthreadwait\"\u003engx.thread.wait\u003c/a\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eThe following example demonstrates the use of coroutine.yield() in the \"light thread\" coroutines\nto do manual time-slicing:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local yield = coroutine.yield\n\n function f()\n     local self = coroutine.running()\n     ngx.say(\u0026quot;f 1\u0026quot;)\n     yield(self)\n     ngx.say(\u0026quot;f 2\u0026quot;)\n     yield(self)\n     ngx.say(\u0026quot;f 3\u0026quot;)\n end\n\n local self = coroutine.running()\n ngx.say(\u0026quot;0\u0026quot;)\n yield(self)\n\n ngx.say(\u0026quot;1\u0026quot;)\n ngx.thread.spawn(f)\n\n ngx.say(\u0026quot;2\u0026quot;)\n yield(self)\n\n ngx.say(\u0026quot;3\u0026quot;)\n yield(self)\n\n ngx.say(\u0026quot;4\u0026quot;)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eyield\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ecoroutine.yield\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ef\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ecoroutine.running\u003c/span\u003e()\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef 1\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-c1\"\u003eyield\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef 2\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-c1\"\u003eyield\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef 3\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ecoroutine.running\u003c/span\u003e()\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e0\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c1\"\u003eyield\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e1\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ef\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e2\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c1\"\u003eyield\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e3\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c1\"\u003eyield\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003eself\u003c/span\u003e)\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e4\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThen it will generate the output\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"0\n1\nf 1\n2\nf 2\n3\nf 3\n4\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003e0\n1\nf 1\n2\nf 2\n3\nf 3\n4\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\"Light threads\" are mostly useful for making concurrent upstream requests in a single Nginx request handler, much like a generalized version of \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e that can work with all the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e. The following example demonstrates parallel requests to MySQL, Memcached, and upstream HTTP services in a single Lua handler, and outputting the results in the order that they actually return (similar to Facebook's BigPipe model):\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n -- query mysql, memcached, and a remote http service at the same time,\n -- output the results in the order that they\n -- actually return the results.\n\n local mysql = require \u0026quot;resty.mysql\u0026quot;\n local memcached = require \u0026quot;resty.memcached\u0026quot;\n\n local function query_mysql()\n     local db = mysql:new()\n     db:connect{\n                 host = \u0026quot;127.0.0.1\u0026quot;,\n                 port = 3306,\n                 database = \u0026quot;test\u0026quot;,\n                 user = \u0026quot;monty\u0026quot;,\n                 password = \u0026quot;mypass\u0026quot;\n               }\n     local res, err, errno, sqlstate =\n             db:query(\u0026quot;select * from cats order by id asc\u0026quot;)\n     db:set_keepalive(0, 100)\n     ngx.say(\u0026quot;mysql done: \u0026quot;, cjson.encode(res))\n end\n\n local function query_memcached()\n     local memc = memcached:new()\n     memc:connect(\u0026quot;127.0.0.1\u0026quot;, 11211)\n     local res, err = memc:get(\u0026quot;some_key\u0026quot;)\n     ngx.say(\u0026quot;memcached done: \u0026quot;, res)\n end\n\n local function query_http()\n     local res = ngx.location.capture(\u0026quot;/my-http-proxy\u0026quot;)\n     ngx.say(\u0026quot;http done: \u0026quot;, res.body)\n end\n\n ngx.thread.spawn(query_mysql)      -- create thread 1\n ngx.thread.spawn(query_memcached)  -- create thread 2\n ngx.thread.spawn(query_http)       -- create thread 3\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e query mysql, memcached, and a remote http service at the same time,\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e output the results in the order that they\u003c/span\u003e\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e actually return the results.\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003emysql\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.mysql\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ememcached\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003erequire\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eresty.memcached\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003equery_mysql\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edb\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003emysql\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003enew\u003c/span\u003e()\n     \u003cspan class=\"pl-en\"\u003edb\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003econnect\u003c/span\u003e{\n                 \u003cspan class=\"pl-smi\"\u003ehost\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e127.0.0.1\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n                 \u003cspan class=\"pl-smi\"\u003eport\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e3306\u003c/span\u003e,\n                 \u003cspan class=\"pl-smi\"\u003edatabase\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003etest\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n                 \u003cspan class=\"pl-smi\"\u003euser\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emonty\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n                 \u003cspan class=\"pl-smi\"\u003epassword\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emypass\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n               }\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerrno\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003esqlstate\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e\n             \u003cspan class=\"pl-en\"\u003edb\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003equery\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eselect * from cats order by id asc\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-en\"\u003edb\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eset_keepalive\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e100\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emysql done: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ecjson\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eencode\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e))\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003equery_memcached\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ememc\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ememcached\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003enew\u003c/span\u003e()\n     \u003cspan class=\"pl-en\"\u003ememc\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003econnect\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e127.0.0.1\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003e11211\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ememc\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eget\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003esome_key\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ememcached done: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003equery_http\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/my-http-proxy\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehttp done: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ebody\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003equery_mysql\u003c/span\u003e)      \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e create thread 1\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003equery_memcached\u003c/span\u003e)  \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e create thread 2\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003equery_http\u003c/span\u003e)       \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e create thread 3\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis API was first enabled in the \u003ccode\u003ev0.7.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.thread.wait\u003c/h2\u003e\u003ca id=\"user-content-ngxthreadwait\" class=\"anchor\" aria-label=\"Permalink: ngx.thread.wait\" href=\"#ngxthreadwait\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, res1, res2, ... = ngx.thread.wait(thread1, thread2, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWaits on one or more child \"light threads\" and returns the results of the first \"light thread\" that terminates (either successfully or with an error).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe arguments \u003ccode\u003ethread1\u003c/code\u003e, \u003ccode\u003ethread2\u003c/code\u003e, and etc are the Lua thread objects returned by earlier calls of \u003ca href=\"#ngxthreadspawn\"\u003engx.thread.spawn\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe return values have exactly the same meaning as \u003ca href=\"#coroutineresume\"\u003ecoroutine.resume\u003c/a\u003e, that is, the first value returned is a boolean value indicating whether the \"light thread\" terminates successfully or not, and subsequent values returned are the return values of the user Lua function that was used to spawn the \"light thread\" (in case of success) or the error object (in case of failure).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly the direct \"parent coroutine\" can wait on its child \"light thread\", otherwise a Lua exception will be raised.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe following example demonstrates the use of \u003ccode\u003engx.thread.wait\u003c/code\u003e and \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e to emulate \u003ca href=\"#ngxlocationcapture_multi\"\u003engx.location.capture_multi\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local capture = ngx.location.capture\n local spawn = ngx.thread.spawn\n local wait = ngx.thread.wait\n local say = ngx.say\n\n local function fetch(uri)\n     return capture(uri)\n end\n\n local threads = {\n     spawn(fetch, \u0026quot;/foo\u0026quot;),\n     spawn(fetch, \u0026quot;/bar\u0026quot;),\n     spawn(fetch, \u0026quot;/baz\u0026quot;)\n }\n\n for i = 1, #threads do\n     local ok, res = wait(threads[i])\n     if not ok then\n         say(i, \u0026quot;: failed to run: \u0026quot;, res)\n     else\n         say(i, \u0026quot;: status: \u0026quot;, res.status)\n         say(i, \u0026quot;: body: \u0026quot;, res.body)\n     end\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ecapture\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003elocation\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ecapture\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003espawn\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003espawn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ewait\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ewait\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003esay\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003esay\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003efetch\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003euri\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ecapture\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003euri\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ethreads\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e {\n     \u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003efetch\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/foo\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e),\n     \u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003efetch\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/bar\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e),\n     \u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003efetch\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/baz\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n }\n\n \u003cspan class=\"pl-k\"\u003efor\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e1\u003c/span\u003e, \u003cspan class=\"pl-k\"\u003e#\u003c/span\u003e\u003cspan class=\"pl-smi\"\u003ethreads\u003c/span\u003e \u003cspan class=\"pl-k\"\u003edo\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003ewait\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ethreads\u003c/span\u003e[\u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e])\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e: failed to run: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e\n         \u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e: status: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003estatus\u003c/span\u003e)\n         \u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ei\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e: body: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ebody\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eHere it essentially implements the \"wait all\" model.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAnd below is an example demonstrating the \"wait any\" model:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n function f()\n     ngx.sleep(0.2)\n     ngx.say(\u0026quot;f: hello\u0026quot;)\n     return \u0026quot;f done\u0026quot;\n end\n\n function g()\n     ngx.sleep(0.1)\n     ngx.say(\u0026quot;g: hello\u0026quot;)\n     return \u0026quot;g done\u0026quot;\n end\n\n local tf, err = ngx.thread.spawn(f)\n if not tf then\n     ngx.say(\u0026quot;failed to spawn thread f: \u0026quot;, err)\n     return\n end\n\n ngx.say(\u0026quot;f thread created: \u0026quot;, coroutine.status(tf))\n\n local tg, err = ngx.thread.spawn(g)\n if not tg then\n     ngx.say(\u0026quot;failed to spawn thread g: \u0026quot;, err)\n     return\n end\n\n ngx.say(\u0026quot;g thread created: \u0026quot;, coroutine.status(tg))\n\n ok, res = ngx.thread.wait(tf, tg)\n if not ok then\n     ngx.say(\u0026quot;failed to wait: \u0026quot;, res)\n     return\n end\n\n ngx.say(\u0026quot;res: \u0026quot;, res)\n\n -- stop the \u0026quot;world\u0026quot;, aborting other running threads\n ngx.exit(ngx.OK)\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003ef\u003c/span\u003e()\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esleep\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0.2\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef: hello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef done\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eg\u003c/span\u003e()\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esleep\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e0.1\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eg: hello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eg done\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003etf\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003ef\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003etf\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to spawn thread f: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ef thread created: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003ecoroutine.status\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003etf\u003c/span\u003e))\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003etg\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003espawn\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003eg\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003etg\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to spawn thread g: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eg thread created: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-c1\"\u003ecoroutine.status\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003etg\u003c/span\u003e))\n\n \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003ethread\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003ewait\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003etf\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003etg\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to wait: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003esay\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003eres: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e)\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e stop the \"world\", aborting other running threads\u003c/span\u003e\n \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexit\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eOK\u003c/span\u003e)\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eAnd it will generate the following output:\u003c/p\u003e\n\u003cdiv class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"f thread created: running\ng thread created: running\ng: hello\nres: g done\"\u003e\u003cpre class=\"notranslate\"\u003e\u003ccode\u003ef thread created: running\ng thread created: running\ng: hello\nres: g done\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis API was first enabled in the \u003ccode\u003ev0.7.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.thread.kill\u003c/h2\u003e\u003ca id=\"user-content-ngxthreadkill\" class=\"anchor\" aria-label=\"Permalink: ngx.thread.kill\" href=\"#ngxthreadkill\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.thread.kill(thread)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eKills a running \"light thread\" created by \u003ca href=\"#ngxthreadspawn\"\u003engx.thread.spawn\u003c/a\u003e. Returns a true value when successful or \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAccording to the current implementation, only the parent coroutine (or \"light thread\") can kill a thread. Also, a running \"light thread\" with pending Nginx subrequests (initiated by \u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e for example) cannot be killed due to a limitation in the Nginx core.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first enabled in the \u003ccode\u003ev0.9.9\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.on_abort\u003c/h2\u003e\u003ca id=\"user-content-ngxon_abort\" class=\"anchor\" aria-label=\"Permalink: ngx.on_abort\" href=\"#ngxon_abort\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, err = ngx.on_abort(callback)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eRegisters a user Lua function as the callback which gets called automatically when the client closes the (downstream) connection prematurely.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns \u003ccode\u003e1\u003c/code\u003e if the callback is registered successfully or returns \u003ccode\u003enil\u003c/code\u003e and a string describing the error otherwise.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAll the \u003ca href=\"#nginx-api-for-lua\"\u003eNginx API for Lua\u003c/a\u003e can be used in the callback function because the function is run in a special \"light thread\", just as those \"light threads\" created by \u003ca href=\"#ngxthreadspawn\"\u003engx.thread.spawn\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe callback function can decide what to do with the client abortion event all by itself. For example, it can simply ignore the event by doing nothing and the current Lua request handler will continue executing without interruptions. And the callback function can also decide to terminate everything by calling \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e, for example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local function my_cleanup()\n     -- custom cleanup work goes here, like cancelling a pending DB transaction\n\n     -- now abort all the \u0026quot;light threads\u0026quot; running in the current request handler\n     ngx.exit(499)\n end\n\n local ok, err = ngx.on_abort(my_cleanup)\n if not ok then\n     ngx.log(ngx.ERR, \u0026quot;failed to register the on_abort callback: \u0026quot;, err)\n     ngx.exit(500)\n end\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003emy_cleanup\u003c/span\u003e()\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e custom cleanup work goes here, like cancelling a pending DB transaction\u003c/span\u003e\n\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e now abort all the \"light threads\" running in the current request handler\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexit\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e499\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eon_abort\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003emy_cleanup\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to register the on_abort callback: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eexit\u003c/span\u003e(\u003cspan class=\"pl-c1\"\u003e500\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eWhen \u003ca href=\"#lua_check_client_abort\"\u003elua_check_client_abort\u003c/a\u003e is set to \u003ccode\u003eoff\u003c/code\u003e (which is the default), then this function call will always return the error message \"lua_check_client_abort is off\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAccording to the current implementation, this function can only be called once in a single request handler; subsequent calls will return the error message \"duplicate call\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.7.4\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#lua_check_client_abort\"\u003elua_check_client_abort\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.timer.at\u003c/h2\u003e\u003ca id=\"user-content-ngxtimerat\" class=\"anchor\" aria-label=\"Permalink: ngx.timer.at\" href=\"#ngxtimerat\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ehdl, err = ngx.timer.at(delay, callback, user_arg1, user_arg2, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCreates an Nginx timer with a user callback function as well as optional user arguments.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe first argument, \u003ccode\u003edelay\u003c/code\u003e, specifies the delay for the timer,\nin seconds. One can specify fractional seconds like \u003ccode\u003e0.001\u003c/code\u003e to mean 1\nmillisecond here. \u003ccode\u003e0\u003c/code\u003e delay can also be specified, in which case the\ntimer will immediately expire when the current handler yields\nexecution.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe second argument, \u003ccode\u003ecallback\u003c/code\u003e, can\nbe any Lua function, which will be invoked later in a background\n\"light thread\" after the delay specified. The user callback will be\ncalled automatically by the Nginx core with the arguments \u003ccode\u003epremature\u003c/code\u003e,\n\u003ccode\u003euser_arg1\u003c/code\u003e, \u003ccode\u003euser_arg2\u003c/code\u003e, and etc, where the \u003ccode\u003epremature\u003c/code\u003e\nargument takes a boolean value indicating whether it is a premature timer\nexpiration or not(for the \u003ccode\u003e0\u003c/code\u003e delay timer it is always \u003ccode\u003efalse\u003c/code\u003e), and \u003ccode\u003euser_arg1\u003c/code\u003e, \u003ccode\u003euser_arg2\u003c/code\u003e, and etc, are\nthose (extra) user arguments specified when calling \u003ccode\u003engx.timer.at\u003c/code\u003e\nas the remaining arguments.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePremature timer expiration happens when the Nginx worker process is\ntrying to shut down, as in an Nginx configuration reload triggered by\nthe \u003ccode\u003eHUP\u003c/code\u003e signal or in an Nginx server shutdown. When the Nginx worker\nis trying to shut down, one can no longer call \u003ccode\u003engx.timer.at\u003c/code\u003e to\ncreate new timers with nonzero delays and in that case \u003ccode\u003engx.timer.at\u003c/code\u003e will return a \"conditional false\" value and\na string describing the error, that is, \"process exiting\".\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eStarting from the \u003ccode\u003ev0.9.3\u003c/code\u003e release, it is allowed to create zero-delay timers even when the Nginx worker process starts shutting down.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen a timer expires, the user Lua code in the timer callback is\nrunning in a \"light thread\" detached completely from the original\nrequest creating the timer. So objects with the same lifetime as the\nrequest creating them, like \u003ca href=\"#ngxsockettcp\"\u003ecosockets\u003c/a\u003e, cannot be shared between the\noriginal request and the timer user callback function.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eHere is a simple example:\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location / {\n     ...\n     log_by_lua_block {\n         local function push_data(premature, uri, args, status)\n             -- push the data uri, args, and status to the remote\n             -- via ngx.socket.tcp or ngx.socket.udp\n             -- (one may want to buffer the data in Lua a bit to\n             -- save I/O operations)\n         end\n         local ok, err = ngx.timer.at(0, push_data,\n                                      ngx.var.uri, ngx.var.args, ngx.header.status)\n         if not ok then\n             ngx.log(ngx.ERR, \u0026quot;failed to create timer: \u0026quot;, err)\n             return\n         end\n\n         -- other job in log_by_lua_block\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e / \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     ...\n     log_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local function push_data\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003epremature, uri, args, \u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             -- push the data uri, args, and \u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e to the remote\n             -- via ngx.socket.tcp or ngx.socket.udp\n             -- \u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eone may want to buffer the data in Lua a bit to\n             -- save I/O operations\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         end\n         local ok, err = ngx.timer.at\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e0, push_data,\n                                      ngx.var.uri, ngx.var.args, ngx.header.\u003cspan class=\"pl-c1\"\u003estatus\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.log\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003engx.ERR, \u003cspan class=\"pl-s\"\u003e\"failed to create timer: \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n\n         -- other job in log_by_lua_block\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eOne can also create infinite re-occurring timers, for instance, a timer getting triggered every \u003ccode\u003e5\u003c/code\u003e seconds, by calling \u003ccode\u003engx.timer.at\u003c/code\u003e recursively in the timer callback function. Here is such an example,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local delay = 5\n local handler\n handler = function (premature)\n     -- do some routine job in Lua just like a cron job\n     if premature then\n         return\n     end\n     local ok, err = ngx.timer.at(delay, handler)\n     if not ok then\n         ngx.log(ngx.ERR, \u0026quot;failed to create the timer: \u0026quot;, err)\n         return\n     end\n\n     -- do something in timer\n end\n\n local ok, err = ngx.timer.at(delay, handler)\n if not ok then\n     ngx.log(ngx.ERR, \u0026quot;failed to create the timer: \u0026quot;, err)\n     return\n end\n\n -- do other jobs\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003edelay\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e5\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003ehandler\u003c/span\u003e\n \u003cspan class=\"pl-en\"\u003ehandler\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e (\u003cspan class=\"pl-smi\"\u003epremature\u003c/span\u003e)\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e do some routine job in Lua just like a cron job\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003epremature\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003etimer\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eat\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003edelay\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ehandler\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to create the timer: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n     \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e do something in timer\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003etimer\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eat\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003edelay\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003ehandler\u003c/span\u003e)\n \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eok\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n     \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eERR\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003efailed to create the timer: \u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e do other jobs\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eIt is recommended, however, to use the \u003ca href=\"#ngxtimerevery\"\u003engx.timer.every\u003c/a\u003e API function\ninstead for creating recurring timers since it is more robust.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eBecause timer callbacks run in the background and their running time\nwill not add to any client request's response time, they can easily\naccumulate in the server and exhaust system resources due to either\nLua programming mistakes or just too much client traffic. To prevent\nextreme consequences like crashing the Nginx server, there are\nbuilt-in limitations on both the number of \"pending timers\" and the\nnumber of \"running timers\" in an Nginx worker process. The \"pending\ntimers\" here mean timers that have not yet been expired and \"running\ntimers\" are those whose user callbacks are currently running.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe maximal number of pending timers allowed in an Nginx\nworker is controlled by the \u003ca href=\"#lua_max_pending_timers\"\u003elua_max_pending_timers\u003c/a\u003e\ndirective. The maximal number of running timers is controlled by the\n\u003ca href=\"#lua_max_running_timers\"\u003elua_max_running_timers\u003c/a\u003e directive.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eAccording to the current implementation, each \"running timer\" will\ntake one (fake) connection record from the global connection record\nlist configured by the standard \u003ca href=\"http://nginx.org/en/docs/ngx_core_module.html#worker_connections\" rel=\"nofollow\"\u003eworker_connections\u003c/a\u003e directive in\n\u003ccode\u003enginx.conf\u003c/code\u003e. So ensure that the\n\u003ca href=\"http://nginx.org/en/docs/ngx_core_module.html#worker_connections\" rel=\"nofollow\"\u003eworker_connections\u003c/a\u003e directive is set to\na large enough value that takes into account both the real connections\nand fake connections required by timer callbacks (as limited by the\n\u003ca href=\"#lua_max_running_timers\"\u003elua_max_running_timers\u003c/a\u003e directive).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eA lot of the Lua APIs for Nginx are enabled in the context of the timer\ncallbacks, like stream/datagram cosockets (\u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e and \u003ca href=\"#ngxsocketudp\"\u003engx.socket.udp\u003c/a\u003e), shared\nmemory dictionaries (\u003ca href=\"#ngxshareddict\"\u003engx.shared.DICT\u003c/a\u003e), user coroutines (\u003ca href=\"#coroutinecreate\"\u003ecoroutine.*\u003c/a\u003e),\nuser \"light threads\" (\u003ca href=\"#ngxthreadspawn\"\u003engx.thread.*\u003c/a\u003e), \u003ca href=\"#ngxexit\"\u003engx.exit\u003c/a\u003e, \u003ca href=\"#ngxnow\"\u003engx.now\u003c/a\u003e/\u003ca href=\"#ngxtime\"\u003engx.time\u003c/a\u003e,\n\u003ca href=\"#ngxmd5\"\u003engx.md5\u003c/a\u003e/\u003ca href=\"#ngxsha1_bin\"\u003engx.sha1_bin\u003c/a\u003e, are all allowed. But the subrequest API (like\n\u003ca href=\"#ngxlocationcapture\"\u003engx.location.capture\u003c/a\u003e), the \u003ca href=\"#ngxreqstart_time\"\u003engx.req.*\u003c/a\u003e API, the downstream output API\n(like \u003ca href=\"#ngxsay\"\u003engx.say\u003c/a\u003e, \u003ca href=\"#ngxprint\"\u003engx.print\u003c/a\u003e, and \u003ca href=\"#ngxflush\"\u003engx.flush\u003c/a\u003e) are explicitly disabled in\nthis context.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou must notice that each timer will be based on a fake request (this fake request is also based on a fake connection). Because Nginx's memory release is based on the connection closure, if you run a lot of APIs that apply for memory resources in a timer, such as \u003ca href=\"#tcpsockconnect\"\u003etcpsock:connect\u003c/a\u003e, will cause the accumulation of memory resources. So it is recommended to create a new timer after running several times to release memory resources.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYou can pass most of the standard Lua values (nils, booleans, numbers, strings, tables, closures, file handles, etc.) into the timer callback, either explicitly as user arguments or implicitly as upvalues for the callback closure. There are several exceptions, however: you \u003cem\u003ecannot\u003c/em\u003e pass any thread objects returned by \u003ca href=\"#coroutinecreate\"\u003ecoroutine.create\u003c/a\u003e and \u003ca href=\"#ngxthreadspawn\"\u003engx.thread.spawn\u003c/a\u003e or any cosocket objects returned by \u003ca href=\"#ngxsockettcp\"\u003engx.socket.tcp\u003c/a\u003e, \u003ca href=\"#ngxsocketudp\"\u003engx.socket.udp\u003c/a\u003e, and \u003ca href=\"#ngxreqsocket\"\u003engx.req.socket\u003c/a\u003e because these objects' lifetime is bound to the request context creating them while the timer callback is detached from the creating request's context (by design) and runs in its own (fake) request context. If you try to share the thread or cosocket objects across the boundary of the creating request, then you will get the \"no co ctx found\" error (for threads) or \"bad request\" (for cosockets). It is fine, however, to create all these objects inside your timer callback.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease note that the timer Lua handler has its own copy of the \u003ccode\u003engx.ctx\u003c/code\u003e magic\ntable. It won't share the same \u003ccode\u003engx.ctx\u003c/code\u003e with the Lua handler creating the timer.\nIf you need to pass data from the timer creator to the timer handler, please\nuse the extra parameters of \u003ccode\u003engx.timer.at()\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.8.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.timer.every\u003c/h2\u003e\u003ca id=\"user-content-ngxtimerevery\" class=\"anchor\" aria-label=\"Permalink: ngx.timer.every\" href=\"#ngxtimerevery\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ehdl, err = ngx.timer.every(delay, callback, user_arg1, user_arg2, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e API function, but\u003c/p\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003e\u003ccode\u003edelay\u003c/code\u003e \u003cem\u003ecannot\u003c/em\u003e be zero,\u003c/li\u003e\n\u003cli\u003etimer will be created every \u003ccode\u003edelay\u003c/code\u003e seconds until the current Nginx worker process starts exiting.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp dir=\"auto\"\u003eLike \u003ca href=\"#ngxtimerat\"\u003engx.timer.at\u003c/a\u003e, the \u003ccode\u003ecallback\u003c/code\u003e argument will be called\nautomatically with the arguments \u003ccode\u003epremature\u003c/code\u003e, \u003ccode\u003euser_arg1\u003c/code\u003e, \u003ccode\u003euser_arg2\u003c/code\u003e, etc.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWhen success, returns a \"conditional true\" value (but not a \u003ccode\u003etrue\u003c/code\u003e). Otherwise, returns a \"conditional false\" value and a string describing the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API also respect the \u003ca href=\"#lua_max_pending_timers\"\u003elua_max_pending_timers\u003c/a\u003e and \u003ca href=\"#lua_max_running_timers\"\u003elua_max_running_timers\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.10.9\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.timer.running_count\u003c/h2\u003e\u003ca id=\"user-content-ngxtimerrunning_count\" class=\"anchor\" aria-label=\"Permalink: ngx.timer.running_count\" href=\"#ngxtimerrunning_count\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecount = ngx.timer.running_count()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the number of timers currently running.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.timer.pending_count\u003c/h2\u003e\u003ca id=\"user-content-ngxtimerpending_count\" class=\"anchor\" aria-label=\"Permalink: ngx.timer.pending_count\" href=\"#ngxtimerpending_count\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecount = ngx.timer.pending_count()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the number of pending timers.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis directive was first introduced in the \u003ccode\u003ev0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.subsystem\u003c/h2\u003e\u003ca id=\"user-content-ngxconfigsubsystem\" class=\"anchor\" aria-label=\"Permalink: ngx.config.subsystem\" href=\"#ngxconfigsubsystem\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003esubsystem = ngx.config.subsystem\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis string field indicates the Nginx subsystem the current Lua environment is based on. For this module, this field always takes the string value \u003ccode\u003e\"http\"\u003c/code\u003e. For\n\u003ca href=\"https://github.com/openresty/stream-lua-nginx-module#readme\"\u003engx_stream_lua_module\u003c/a\u003e, however, this field takes the value \u003ccode\u003e\"stream\"\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis field was first introduced in the \u003ccode\u003e0.10.1\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.debug\u003c/h2\u003e\u003ca id=\"user-content-ngxconfigdebug\" class=\"anchor\" aria-label=\"Permalink: ngx.config.debug\" href=\"#ngxconfigdebug\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003edebug = ngx.config.debug\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis boolean field indicates whether the current Nginx is a debug build, i.e., being built by the \u003ccode\u003e./configure\u003c/code\u003e option \u003ccode\u003e--with-debug\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis field was first introduced in the \u003ccode\u003e0.8.7\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.prefix\u003c/h2\u003e\u003ca id=\"user-content-ngxconfigprefix\" class=\"anchor\" aria-label=\"Permalink: ngx.config.prefix\" href=\"#ngxconfigprefix\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eprefix = ngx.config.prefix()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the Nginx server \"prefix\" path, as determined by the \u003ccode\u003e-p\u003c/code\u003e command-line option when running the Nginx executable, or the path specified by the \u003ccode\u003e--prefix\u003c/code\u003e command-line option when building Nginx with the \u003ccode\u003e./configure\u003c/code\u003e script.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function was first introduced in the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.nginx_version\u003c/h2\u003e\u003ca id=\"user-content-ngxconfignginx_version\" class=\"anchor\" aria-label=\"Permalink: ngx.config.nginx_version\" href=\"#ngxconfignginx_version\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ever = ngx.config.nginx_version\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis field take an integral value indicating the version number of the current Nginx core being used. For example, the version number \u003ccode\u003e1.4.3\u003c/code\u003e results in the Lua number 1004003.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.3\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.nginx_configure\u003c/h2\u003e\u003ca id=\"user-content-ngxconfignginx_configure\" class=\"anchor\" aria-label=\"Permalink: ngx.config.nginx_configure\" href=\"#ngxconfignginx_configure\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estr = ngx.config.nginx_configure()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns a string for the Nginx \u003ccode\u003e./configure\u003c/code\u003e command's arguments string.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.config.ngx_lua_version\u003c/h2\u003e\u003ca id=\"user-content-ngxconfigngx_lua_version\" class=\"anchor\" aria-label=\"Permalink: ngx.config.ngx_lua_version\" href=\"#ngxconfigngx_lua_version\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ever = ngx.config.ngx_lua_version\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis field take an integral value indicating the version number of the current \u003ccode\u003engx_lua\u003c/code\u003e module being used. For example, the version number \u003ccode\u003e0.9.3\u003c/code\u003e results in the Lua number 9003.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.3\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.worker.exiting\u003c/h2\u003e\u003ca id=\"user-content-ngxworkerexiting\" class=\"anchor\" aria-label=\"Permalink: ngx.worker.exiting\" href=\"#ngxworkerexiting\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eexiting = ngx.worker.exiting()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns a boolean value indicating whether the current Nginx worker process already starts exiting. Nginx worker process exiting happens on Nginx server quit or configuration reload (aka HUP reload).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.3\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.worker.pid\u003c/h2\u003e\u003ca id=\"user-content-ngxworkerpid\" class=\"anchor\" aria-label=\"Permalink: ngx.worker.pid\" href=\"#ngxworkerpid\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003epid = ngx.worker.pid()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns a Lua number for the process ID (PID) of the current Nginx worker process. This API is more efficient than \u003ccode\u003engx.var.pid\u003c/code\u003e and can be used in contexts where the \u003ca href=\"#ngxvarvariable\"\u003engx.var.VARIABLE\u003c/a\u003e API cannot be used (like \u003ca href=\"#init_worker_by_lua\"\u003einit_worker_by_lua\u003c/a\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.5\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.worker.pids\u003c/h2\u003e\u003ca id=\"user-content-ngxworkerpids\" class=\"anchor\" aria-label=\"Permalink: ngx.worker.pids\" href=\"#ngxworkerpids\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003epids = ngx.worker.pids()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns a Lua table for all Nginx worker process IDs (PIDs). Nginx uses channel to send the current worker PID to another worker in the worker process start or restart. So this API can get all current worker PIDs. Windows does not have this API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.10.23\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.worker.count\u003c/h2\u003e\u003ca id=\"user-content-ngxworkercount\" class=\"anchor\" aria-label=\"Permalink: ngx.worker.count\" href=\"#ngxworkercount\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003ecount = ngx.worker.count()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the total number of the Nginx worker processes (i.e., the value configured\nby the \u003ca href=\"https://nginx.org/en/docs/ngx_core_module.html#worker_processes\" rel=\"nofollow\"\u003eworker_processes\u003c/a\u003e\ndirective in \u003ccode\u003enginx.conf\u003c/code\u003e).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.worker.id\u003c/h2\u003e\u003ca id=\"user-content-ngxworkerid\" class=\"anchor\" aria-label=\"Permalink: ngx.worker.id\" href=\"#ngxworkerid\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eid = ngx.worker.id()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003eset_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_worker_by_lua*, exit_worker_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eReturns the ordinal number of the current Nginx worker processes (starting from number 0).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSo if the total number of workers is \u003ccode\u003eN\u003c/code\u003e, then this method may return a number between 0\nand \u003ccode\u003eN - 1\u003c/code\u003e (inclusive).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis function returns meaningful values only for Nginx 1.9.1+. With earlier versions of Nginx, it\nalways returns \u003ccode\u003enil\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSee also \u003ca href=\"#ngxworkercount\"\u003engx.worker.count\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003e0.9.20\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.semaphore\u003c/h2\u003e\u003ca id=\"user-content-ngxsemaphore\" class=\"anchor\" aria-label=\"Permalink: ngx.semaphore\" href=\"#ngxsemaphore\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elocal semaphore = require \"ngx.semaphore\"\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is a Lua module that implements a classic-style semaphore API for efficient synchronizations among\ndifferent \"light threads\". Sharing the same semaphore among different \"light threads\" created in different (request)\ncontexts are also supported as long as the \"light threads\" reside in the same Nginx worker process\nand the \u003ca href=\"#lua_code_cache\"\u003elua_code_cache\u003c/a\u003e directive is turned on (which is the default).\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module does not ship with this ngx_lua module itself rather it is shipped with\nthe\n\u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease refer to the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/semaphore.md\"\u003edocumentation\u003c/a\u003e\nfor this \u003ccode\u003engx.semaphore\u003c/code\u003e Lua module in \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e\nfor more details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least ngx_lua \u003ccode\u003ev0.10.0\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.balancer\u003c/h2\u003e\u003ca id=\"user-content-ngxbalancer\" class=\"anchor\" aria-label=\"Permalink: ngx.balancer\" href=\"#ngxbalancer\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elocal balancer = require \"ngx.balancer\"\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis is a Lua module that provides a Lua API to allow defining completely dynamic load balancers\nin pure Lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module does not ship with this ngx_lua module itself rather it is shipped with\nthe\n\u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease refer to the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md\"\u003edocumentation\u003c/a\u003e\nfor this \u003ccode\u003engx.balancer\u003c/code\u003e Lua module in \u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e\nfor more details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least ngx_lua \u003ccode\u003ev0.10.0\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.ssl\u003c/h2\u003e\u003ca id=\"user-content-ngxssl\" class=\"anchor\" aria-label=\"Permalink: ngx.ssl\" href=\"#ngxssl\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elocal ssl = require \"ngx.ssl\"\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module provides API functions to control the SSL handshake process in contexts like\n\u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module does not ship with this ngx_lua module itself rather it is shipped with\nthe\n\u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease refer to the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md\"\u003edocumentation\u003c/a\u003e\nfor this \u003ccode\u003engx.ssl\u003c/code\u003e Lua module for more details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least ngx_lua \u003ccode\u003ev0.10.0\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.ocsp\u003c/h2\u003e\u003ca id=\"user-content-ngxocsp\" class=\"anchor\" aria-label=\"Permalink: ngx.ocsp\" href=\"#ngxocsp\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003elocal ocsp = require \"ngx.ocsp\"\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module provides API to perform OCSP queries, OCSP response validations, and\nOCSP stapling planting.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eUsually, this module is used together with the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md\"\u003engx.ssl\u003c/a\u003e\nmodule in the\ncontext of \u003ca href=\"#ssl_certificate_by_lua_block\"\u003essl_certificate_by_lua*\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis Lua module does not ship with this ngx_lua module itself rather it is shipped with\nthe\n\u003ca href=\"https://github.com/openresty/lua-resty-core\"\u003elua-resty-core\u003c/a\u003e library.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003ePlease refer to the \u003ca href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md\"\u003edocumentation\u003c/a\u003e\nfor this \u003ccode\u003engx.ocsp\u003c/code\u003e Lua module for more details.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires at least ngx_lua \u003ccode\u003ev0.10.0\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003endk.set_var.DIRECTIVE\u003c/h2\u003e\u003ca id=\"user-content-ndkset_vardirective\" class=\"anchor\" aria-label=\"Permalink: ndk.set_var.DIRECTIVE\" href=\"#ndkset_vardirective\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eres = ndk.set_var.DIRECTIVE_NAME\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003einit_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis mechanism allows calling other Nginx C modules' directives that are implemented by \u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003eNginx Devel Kit\u003c/a\u003e (NDK)'s set_var submodule's \u003ccode\u003endk_set_var_value\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eFor example, the following \u003ca href=\"http://github.com/openresty/set-misc-nginx-module\"\u003eset-misc-nginx-module\u003c/a\u003e directives can be invoked this way:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_quote_sql_str\"\u003eset_quote_sql_str\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_quote_pgsql_str\"\u003eset_quote_pgsql_str\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_quote_json_str\"\u003eset_quote_json_str\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_unescape_uri\"\u003eset_unescape_uri\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_escape_uri\"\u003eset_escape_uri\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_encode_base32\"\u003eset_encode_base32\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_decode_base32\"\u003eset_decode_base32\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_encode_base64\"\u003eset_encode_base64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_decode_base64\"\u003eset_decode_base64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_encode_base64\"\u003eset_encode_hex\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_decode_base64\"\u003eset_decode_hex\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_encode_base64\"\u003eset_sha1\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/set-misc-nginx-module#set_decode_base64\"\u003eset_md5\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eFor instance,\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local res = ndk.set_var.set_escape_uri('a/b')\n -- now res == 'a%2fb'\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003eres\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003endk\u003c/span\u003e.\u003cspan class=\"pl-e\"\u003eset_var\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003eset_escape_uri\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003ea/b\u003cspan class=\"pl-pds\"\u003e'\u003c/span\u003e\u003c/span\u003e)\n \u003cspan class=\"pl-c\"\u003e\u003cspan class=\"pl-c\"\u003e--\u003c/span\u003e now res == 'a%2fb'\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eSimilarly, the following directives provided by \u003ca href=\"http://github.com/openresty/encrypted-session-nginx-module\"\u003eencrypted-session-nginx-module\u003c/a\u003e can be invoked from within Lua too:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/encrypted-session-nginx-module#set_encrypt_session\"\u003eset_encrypt_session\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://github.com/openresty/encrypted-session-nginx-module#set_decrypt_session\"\u003eset_decrypt_session\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThis feature requires the \u003ca href=\"https://github.com/simplresty/ngx_devel_kit\"\u003engx_devel_kit\u003c/a\u003e module.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.create\u003c/h2\u003e\u003ca id=\"user-content-coroutinecreate\" class=\"anchor\" aria-label=\"Permalink: coroutine.create\" href=\"#coroutinecreate\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eco = coroutine.create(f)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eCreates a user Lua coroutines with a Lua function, and returns a coroutine object.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.create\" rel=\"nofollow\"\u003ecoroutine.create\u003c/a\u003e API, but works in the context of the Lua coroutines created by ngx_lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.resume\u003c/h2\u003e\u003ca id=\"user-content-coroutineresume\" class=\"anchor\" aria-label=\"Permalink: coroutine.resume\" href=\"#coroutineresume\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, ... = coroutine.resume(co, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eResumes the execution of a user Lua coroutine object previously yielded or just created.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.resume\" rel=\"nofollow\"\u003ecoroutine.resume\u003c/a\u003e API, but works in the context of the Lua coroutines created by ngx_lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.yield\u003c/h2\u003e\u003ca id=\"user-content-coroutineyield\" class=\"anchor\" aria-label=\"Permalink: coroutine.yield\" href=\"#coroutineyield\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003e... = coroutine.yield(...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eYields the execution of the current user Lua coroutine.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.yield\" rel=\"nofollow\"\u003ecoroutine.yield\u003c/a\u003e API, but works in the context of the Lua coroutines created by ngx_lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.wrap\u003c/h2\u003e\u003ca id=\"user-content-coroutinewrap\" class=\"anchor\" aria-label=\"Permalink: coroutine.wrap\" href=\"#coroutinewrap\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eco = coroutine.wrap(f)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eSimilar to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.wrap\" rel=\"nofollow\"\u003ecoroutine.wrap\u003c/a\u003e API, but works in the context of the Lua coroutines created by ngx_lua.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first introduced in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.running\u003c/h2\u003e\u003ca id=\"user-content-coroutinerunning\" class=\"anchor\" aria-label=\"Permalink: coroutine.running\" href=\"#coroutinerunning\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eco = coroutine.running()\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIdentical to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.running\" rel=\"nofollow\"\u003ecoroutine.running\u003c/a\u003e API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first enabled in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003ecoroutine.status\u003c/h2\u003e\u003ca id=\"user-content-coroutinestatus\" class=\"anchor\" aria-label=\"Permalink: coroutine.status\" href=\"#coroutinestatus\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003estatus = coroutine.status(co)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eIdentical to the standard Lua \u003ca href=\"https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.status\" rel=\"nofollow\"\u003ecoroutine.status\u003c/a\u003e API.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first usable in the context of \u003ca href=\"#init_by_lua\"\u003einit_by_lua*\u003c/a\u003e since the \u003ccode\u003e0.9.2\u003c/code\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API was first enabled in the \u003ccode\u003ev0.6.0\u003c/code\u003e release.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003engx.run_worker_thread\u003c/h2\u003e\u003ca id=\"user-content-ngxrun_worker_thread\" class=\"anchor\" aria-label=\"Permalink: ngx.run_worker_thread\" href=\"#ngxrun_worker_thread\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003esyntax:\u003c/strong\u003e \u003cem\u003eok, res1, res2, ... = ngx.run_worker_thread(threadpool, module_name, func_name, arg1, arg2, ...)\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003econtext:\u003c/strong\u003e \u003cem\u003erewrite_by_lua*, access_by_lua*, content_by_lua*\u003c/em\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eThis API is still experimental and may change in the future without notice.\u003c/strong\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003cstrong\u003eThis API is available only for Linux.\u003c/strong\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eWrap the \u003ca href=\"http://nginx.org/en/docs/dev/development_guide.html#threads\" rel=\"nofollow\"\u003enginx worker thread\u003c/a\u003e to execute lua function. The caller coroutine would yield until the function returns.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eOnly the following ngx_lua APIs could be used in \u003ccode\u003efunction_name\u003c/code\u003e function of the \u003ccode\u003emodule\u003c/code\u003e module:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.encode_base64\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.decode_base64\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.hmac_sha1\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.encode_args\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.decode_args\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.quote_sql_str\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.crc32_short\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.crc32_long\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.hmac_sha1\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.md5_bin\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.md5\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.subsystem\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.debug\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.prefix\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.nginx_version\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.nginx_configure\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.config.ngx_lua_version\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003engx.shared.DICT\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe first argument \u003ccode\u003ethreadpool\u003c/code\u003e specifies the Nginx thread pool name defined by \u003ca href=\"https://nginx.org/en/docs/ngx_core_module.html#thread_pool\" rel=\"nofollow\"\u003ethread_pool\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe second argument \u003ccode\u003emodule_name\u003c/code\u003e specifies the lua module name to execute in the worker thread, which would return a lua table. The module must be inside the package path, e.g.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n lua_package_path '/opt/openresty/?.lua;;';\"\u003e\u003cpre\u003e lua_package_path \u003cspan class=\"pl-s\"\u003e'/opt/openresty/?.lua;;'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThe third argument \u003ccode\u003efunc_name\u003c/code\u003e specifies the function field in the module table as the second argument.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe type of \u003ccode\u003eargs\u003c/code\u003e must be one of type below:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eboolean\u003c/li\u003e\n\u003cli\u003enumber\u003c/li\u003e\n\u003cli\u003estring\u003c/li\u003e\n\u003cli\u003enil\u003c/li\u003e\n\u003cli\u003etable (the table may be recursive, and contains members of types above.)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eThe \u003ccode\u003eok\u003c/code\u003e is in boolean type, which indicate the C land error (failed to get thread from thread pool, pcall the module function failed, etc.). If \u003ccode\u003eok\u003c/code\u003e is \u003ccode\u003efalse\u003c/code\u003e, the \u003ccode\u003eres1\u003c/code\u003e is the error string.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThe return values (res1, ...) are returned by invocation of the module function. Normally, the \u003ccode\u003eres1\u003c/code\u003e should be in boolean type, so that the caller could inspect the error.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003eThis API is useful when you need to execute the below types of tasks:\u003c/p\u003e\n\u003cul dir=\"auto\"\u003e\n\u003cli\u003eCPU bound task, e.g. do md5 calculation\u003c/li\u003e\n\u003cli\u003eFile I/O task\u003c/li\u003e\n\u003cli\u003eCall \u003ccode\u003eos.execute()\u003c/code\u003e or blocking C API via \u003ccode\u003effi\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eCall external Lua library not based on cosocket or nginx\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp dir=\"auto\"\u003eExample1: do md5 calculation.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /calc_md5 {\n     default_type 'text/plain';\n\n     content_by_lua_block {\n         local ok, md5_or_err = ngx.run_worker_thread(\u0026quot;testpool\u0026quot;, \u0026quot;md5\u0026quot;, \u0026quot;md5\u0026quot;)\n         ngx.say(ok, \u0026quot; : \u0026quot;, md5_or_err)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /calc_md5 \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'text/plain'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local ok, md5_or_err = ngx.run_worker_thread\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"testpool\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"md5\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"md5\"\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eok, \u003cspan class=\"pl-s\"\u003e\" : \"\u003c/span\u003e, md5_or_err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003emd5.lua\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"local function md5()\n    return ngx.md5(\u0026quot;hello\u0026quot;)\nend\n\nreturn { md5=md5, }\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003emd5\u003c/span\u003e()\n    \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003engx\u003c/span\u003e.\u003cspan class=\"pl-c1\"\u003emd5\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ehello\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n\u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e { \u003cspan class=\"pl-smi\"\u003emd5\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e\u003cspan class=\"pl-smi\"\u003emd5\u003c/span\u003e, }\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eExample2: write logs into the log file.\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-nginx notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n location /write_log_file {\n     default_type 'text/plain';\n\n     content_by_lua_block {\n         local ok, err = ngx.run_worker_thread(\u0026quot;testpool\u0026quot;, \u0026quot;write_log_file\u0026quot;, \u0026quot;log\u0026quot;, ngx.var.arg_str)\n         if not ok then\n             ngx.say(ok, \u0026quot; : \u0026quot;, err)\n             return\n         end\n         ngx.say(ok)\n     }\n }\"\u003e\u003cpre\u003e \u003cspan class=\"pl-c1\"\u003elocation\u003c/span\u003e /write_log_file \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'text/plain'\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003e;\u003c/span\u003e\n\n     content_by_lua_block \u003cspan class=\"pl-c1\"\u003e{\u003c/span\u003e\n         local ok, err = ngx.run_worker_thread\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e\"testpool\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"write_log_file\"\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\"log\"\u003c/span\u003e, ngx.var.arg_str\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e not ok then\n             ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eok, \u003cspan class=\"pl-s\"\u003e\" : \"\u003c/span\u003e, err\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n             \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e\n         end\n         ngx.say\u003cspan class=\"pl-c1\"\u003e(\u003c/span\u003eok\u003cspan class=\"pl-c1\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\n \u003cspan class=\"pl-c1\"\u003e}\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ccode\u003ewrite_log_file.lua\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-lua notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"\n local function log(str)\n     local file, err = io.open(\u0026quot;/tmp/tmp.log\u0026quot;, \u0026quot;a\u0026quot;)\n     if not file then\n         return false, err\n     end\n     file:write(str)\n     file:flush()\n     file:close()\n     return true\n end\n return {log=log}\"\u003e\u003cpre\u003e \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-en\"\u003elog\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003elocal\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efile\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e \u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eio.open\u003c/span\u003e(\u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e/tmp/tmp.log\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e, \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003ea\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e)\n     \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-k\"\u003enot\u003c/span\u003e \u003cspan class=\"pl-smi\"\u003efile\u003c/span\u003e \u003cspan class=\"pl-k\"\u003ethen\u003c/span\u003e\n         \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003efalse\u003c/span\u003e, \u003cspan class=\"pl-smi\"\u003eerr\u003c/span\u003e\n     \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n     \u003cspan class=\"pl-en\"\u003efile\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003ewrite\u003c/span\u003e(\u003cspan class=\"pl-smi\"\u003estr\u003c/span\u003e)\n     \u003cspan class=\"pl-en\"\u003efile\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eflush\u003c/span\u003e()\n     \u003cspan class=\"pl-en\"\u003efile\u003c/span\u003e:\u003cspan class=\"pl-c1\"\u003eclose\u003c/span\u003e()\n     \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003etrue\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003eend\u003c/span\u003e\n \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e {\u003cspan class=\"pl-smi\"\u003elog\u003c/span\u003e\u003cspan class=\"pl-k\"\u003e=\u003c/span\u003e\u003cspan class=\"pl-smi\"\u003elog\u003c/span\u003e}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#nginx-api-for-lua\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch1 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eObsolete Sections\u003c/h1\u003e\u003ca id=\"user-content-obsolete-sections\" class=\"anchor\" aria-label=\"Permalink: Obsolete Sections\" href=\"#obsolete-sections\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis section is just holding obsolete documentation sections that have been either renamed or removed so that existing links over the web are still valid.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eSpecial PCRE Sequences\u003c/h2\u003e\u003ca id=\"user-content-special-pcre-sequences\" class=\"anchor\" aria-label=\"Permalink: Special PCRE Sequences\" href=\"#special-pcre-sequences\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis section has been renamed to \u003ca href=\"#special-escaping-sequences\"\u003eSpecial Escaping Sequences\u003c/a\u003e.\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"#table-of-contents\"\u003eBack to TOC\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"markdown-heading\" dir=\"auto\"\u003e\u003ch2 tabindex=\"-1\" class=\"heading-element\" dir=\"auto\"\u003eLua/LuaJIT bytecode support\u003c/h2\u003e\u003ca id=\"user-content-lualuajit-bytecode-support\" class=\"anchor\" aria-label=\"Permalink: Lua/LuaJIT bytecode support\" href=\"#lualuajit-bytecode-support\"\u003e\u003csvg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"\u003e\u003cpath d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003eThis section has been renamed to\n\u003ca href=\"#luajit-bytecode-support\"\u003eLuaJIT bytecode support\u003c/a\u003e. As of version\n\u003ccode\u003ev0.10.16\u003c/code\u003e of this module, the standard Lua interpreter (also known\nas \"PUC-Rio Lua\") is not supported anymore.\u003c/p\u003e\n\u003c/article\u003e","loaded":true,"timedOut":false,"errorMessage":null,"headerInfo":{"toc":[{"level":1,"text":"Name","anchor":"name","htmlText":"Name"},{"level":1,"text":"Table of Contents","anchor":"table-of-contents","htmlText":"Table of Contents"},{"level":1,"text":"Status","anchor":"status","htmlText":"Status"},{"level":1,"text":"Version","anchor":"version","htmlText":"Version"},{"level":1,"text":"Videos","anchor":"videos","htmlText":"Videos"},{"level":1,"text":"Synopsis","anchor":"synopsis","htmlText":"Synopsis"},{"level":1,"text":"Description","anchor":"description","htmlText":"Description"},{"level":1,"text":"Typical Uses","anchor":"typical-uses","htmlText":"Typical Uses"},{"level":1,"text":"Nginx Compatibility","anchor":"nginx-compatibility","htmlText":"Nginx Compatibility"},{"level":1,"text":"Installation","anchor":"installation","htmlText":"Installation"},{"level":2,"text":"Building as a dynamic module","anchor":"building-as-a-dynamic-module","htmlText":"Building as a dynamic module"},{"level":2,"text":"C Macro Configurations","anchor":"c-macro-configurations","htmlText":"C Macro Configurations"},{"level":1,"text":"Community","anchor":"community","htmlText":"Community"},{"level":2,"text":"English Mailing List","anchor":"english-mailing-list","htmlText":"English Mailing List"},{"level":2,"text":"Chinese Mailing List","anchor":"chinese-mailing-list","htmlText":"Chinese Mailing List"},{"level":1,"text":"Code Repository","anchor":"code-repository","htmlText":"Code Repository"},{"level":1,"text":"Bugs and Patches","anchor":"bugs-and-patches","htmlText":"Bugs and Patches"},{"level":1,"text":"LuaJIT bytecode support","anchor":"luajit-bytecode-support","htmlText":"LuaJIT bytecode support"},{"level":1,"text":"System Environment Variable Support","anchor":"system-environment-variable-support","htmlText":"System Environment Variable Support"},{"level":1,"text":"HTTP 1.0 support","anchor":"http-10-support","htmlText":"HTTP 1.0 support"},{"level":1,"text":"Statically Linking Pure Lua Modules","anchor":"statically-linking-pure-lua-modules","htmlText":"Statically Linking Pure Lua Modules"},{"level":1,"text":"Data Sharing within an Nginx Worker","anchor":"data-sharing-within-an-nginx-worker","htmlText":"Data Sharing within an Nginx Worker"},{"level":1,"text":"Known Issues","anchor":"known-issues","htmlText":"Known Issues"},{"level":2,"text":"TCP socket connect operation issues","anchor":"tcp-socket-connect-operation-issues","htmlText":"TCP socket connect operation issues"},{"level":2,"text":"Lua Coroutine Yielding/Resuming","anchor":"lua-coroutine-yieldingresuming","htmlText":"Lua Coroutine Yielding/Resuming"},{"level":2,"text":"Lua Variable Scope","anchor":"lua-variable-scope","htmlText":"Lua Variable Scope"},{"level":2,"text":"Locations Configured by Subrequest Directives of Other Modules","anchor":"locations-configured-by-subrequest-directives-of-other-modules","htmlText":"Locations Configured by Subrequest Directives of Other Modules"},{"level":2,"text":"Cosockets Not Available Everywhere","anchor":"cosockets-not-available-everywhere","htmlText":"Cosockets Not Available Everywhere"},{"level":2,"text":"Special Escaping Sequences","anchor":"special-escaping-sequences","htmlText":"Special Escaping Sequences"},{"level":2,"text":"Mixing with SSI Not Supported","anchor":"mixing-with-ssi-not-supported","htmlText":"Mixing with SSI Not Supported"},{"level":2,"text":"SPDY Mode Not Fully Supported","anchor":"spdy-mode-not-fully-supported","htmlText":"SPDY Mode Not Fully Supported"},{"level":2,"text":"Missing data on short circuited requests","anchor":"missing-data-on-short-circuited-requests","htmlText":"Missing data on short circuited requests"},{"level":1,"text":"TODO","anchor":"todo","htmlText":"TODO"},{"level":1,"text":"Changes","anchor":"changes","htmlText":"Changes"},{"level":1,"text":"Build And Test","anchor":"build-and-test","htmlText":"Build And Test"},{"level":1,"text":"Test Suite","anchor":"test-suite","htmlText":"Test Suite"},{"level":1,"text":"Copyright and License","anchor":"copyright-and-license","htmlText":"Copyright and License"},{"level":1,"text":"See Also","anchor":"see-also","htmlText":"See Also"},{"level":1,"text":"Directives","anchor":"directives","htmlText":"Directives"},{"level":2,"text":"lua_load_resty_core","anchor":"lua_load_resty_core","htmlText":"lua_load_resty_core"},{"level":2,"text":"lua_capture_error_log","anchor":"lua_capture_error_log","htmlText":"lua_capture_error_log"},{"level":2,"text":"lua_use_default_type","anchor":"lua_use_default_type","htmlText":"lua_use_default_type"},{"level":2,"text":"lua_malloc_trim","anchor":"lua_malloc_trim","htmlText":"lua_malloc_trim"},{"level":2,"text":"lua_code_cache","anchor":"lua_code_cache","htmlText":"lua_code_cache"},{"level":2,"text":"lua_thread_cache_max_entries","anchor":"lua_thread_cache_max_entries","htmlText":"lua_thread_cache_max_entries"},{"level":2,"text":"lua_regex_cache_max_entries","anchor":"lua_regex_cache_max_entries","htmlText":"lua_regex_cache_max_entries"},{"level":2,"text":"lua_regex_match_limit","anchor":"lua_regex_match_limit","htmlText":"lua_regex_match_limit"},{"level":2,"text":"lua_package_path","anchor":"lua_package_path","htmlText":"lua_package_path"},{"level":2,"text":"lua_package_cpath","anchor":"lua_package_cpath","htmlText":"lua_package_cpath"},{"level":2,"text":"init_by_lua","anchor":"init_by_lua","htmlText":"init_by_lua"},{"level":2,"text":"init_by_lua_block","anchor":"init_by_lua_block","htmlText":"init_by_lua_block"},{"level":2,"text":"init_by_lua_file","anchor":"init_by_lua_file","htmlText":"init_by_lua_file"},{"level":2,"text":"init_worker_by_lua","anchor":"init_worker_by_lua","htmlText":"init_worker_by_lua"},{"level":2,"text":"init_worker_by_lua_block","anchor":"init_worker_by_lua_block","htmlText":"init_worker_by_lua_block"},{"level":2,"text":"init_worker_by_lua_file","anchor":"init_worker_by_lua_file","htmlText":"init_worker_by_lua_file"},{"level":2,"text":"exit_worker_by_lua_block","anchor":"exit_worker_by_lua_block","htmlText":"exit_worker_by_lua_block"},{"level":2,"text":"exit_worker_by_lua_file","anchor":"exit_worker_by_lua_file","htmlText":"exit_worker_by_lua_file"},{"level":2,"text":"set_by_lua","anchor":"set_by_lua","htmlText":"set_by_lua"},{"level":2,"text":"set_by_lua_block","anchor":"set_by_lua_block","htmlText":"set_by_lua_block"},{"level":2,"text":"set_by_lua_file","anchor":"set_by_lua_file","htmlText":"set_by_lua_file"},{"level":2,"text":"content_by_lua","anchor":"content_by_lua","htmlText":"content_by_lua"},{"level":2,"text":"content_by_lua_block","anchor":"content_by_lua_block","htmlText":"content_by_lua_block"},{"level":2,"text":"content_by_lua_file","anchor":"content_by_lua_file","htmlText":"content_by_lua_file"},{"level":2,"text":"server_rewrite_by_lua_block","anchor":"server_rewrite_by_lua_block","htmlText":"server_rewrite_by_lua_block"},{"level":2,"text":"server_rewrite_by_lua_file","anchor":"server_rewrite_by_lua_file","htmlText":"server_rewrite_by_lua_file"},{"level":2,"text":"rewrite_by_lua","anchor":"rewrite_by_lua","htmlText":"rewrite_by_lua"},{"level":2,"text":"rewrite_by_lua_block","anchor":"rewrite_by_lua_block","htmlText":"rewrite_by_lua_block"},{"level":2,"text":"rewrite_by_lua_file","anchor":"rewrite_by_lua_file","htmlText":"rewrite_by_lua_file"},{"level":2,"text":"access_by_lua","anchor":"access_by_lua","htmlText":"access_by_lua"},{"level":2,"text":"access_by_lua_block","anchor":"access_by_lua_block","htmlText":"access_by_lua_block"},{"level":2,"text":"access_by_lua_file","anchor":"access_by_lua_file","htmlText":"access_by_lua_file"},{"level":2,"text":"header_filter_by_lua","anchor":"header_filter_by_lua","htmlText":"header_filter_by_lua"},{"level":2,"text":"header_filter_by_lua_block","anchor":"header_filter_by_lua_block","htmlText":"header_filter_by_lua_block"},{"level":2,"text":"header_filter_by_lua_file","anchor":"header_filter_by_lua_file","htmlText":"header_filter_by_lua_file"},{"level":2,"text":"body_filter_by_lua","anchor":"body_filter_by_lua","htmlText":"body_filter_by_lua"},{"level":2,"text":"body_filter_by_lua_block","anchor":"body_filter_by_lua_block","htmlText":"body_filter_by_lua_block"},{"level":2,"text":"body_filter_by_lua_file","anchor":"body_filter_by_lua_file","htmlText":"body_filter_by_lua_file"},{"level":2,"text":"log_by_lua","anchor":"log_by_lua","htmlText":"log_by_lua"},{"level":2,"text":"log_by_lua_block","anchor":"log_by_lua_block","htmlText":"log_by_lua_block"},{"level":2,"text":"log_by_lua_file","anchor":"log_by_lua_file","htmlText":"log_by_lua_file"},{"level":2,"text":"balancer_by_lua_block","anchor":"balancer_by_lua_block","htmlText":"balancer_by_lua_block"},{"level":2,"text":"balancer_by_lua_file","anchor":"balancer_by_lua_file","htmlText":"balancer_by_lua_file"},{"level":2,"text":"balancer_keepalive","anchor":"balancer_keepalive","htmlText":"balancer_keepalive"},{"level":2,"text":"lua_need_request_body","anchor":"lua_need_request_body","htmlText":"lua_need_request_body"},{"level":2,"text":"ssl_client_hello_by_lua_block","anchor":"ssl_client_hello_by_lua_block","htmlText":"ssl_client_hello_by_lua_block"},{"level":2,"text":"ssl_client_hello_by_lua_file","anchor":"ssl_client_hello_by_lua_file","htmlText":"ssl_client_hello_by_lua_file"},{"level":2,"text":"ssl_certificate_by_lua_block","anchor":"ssl_certificate_by_lua_block","htmlText":"ssl_certificate_by_lua_block"},{"level":2,"text":"ssl_certificate_by_lua_file","anchor":"ssl_certificate_by_lua_file","htmlText":"ssl_certificate_by_lua_file"},{"level":2,"text":"ssl_session_fetch_by_lua_block","anchor":"ssl_session_fetch_by_lua_block","htmlText":"ssl_session_fetch_by_lua_block"},{"level":2,"text":"ssl_session_fetch_by_lua_file","anchor":"ssl_session_fetch_by_lua_file","htmlText":"ssl_session_fetch_by_lua_file"},{"level":2,"text":"ssl_session_store_by_lua_block","anchor":"ssl_session_store_by_lua_block","htmlText":"ssl_session_store_by_lua_block"},{"level":2,"text":"ssl_session_store_by_lua_file","anchor":"ssl_session_store_by_lua_file","htmlText":"ssl_session_store_by_lua_file"},{"level":2,"text":"proxy_ssl_verify_by_lua_block","anchor":"proxy_ssl_verify_by_lua_block","htmlText":"proxy_ssl_verify_by_lua_block"},{"level":2,"text":"proxy_ssl_verify_by_lua_file","anchor":"proxy_ssl_verify_by_lua_file","htmlText":"proxy_ssl_verify_by_lua_file"},{"level":2,"text":"lua_shared_dict","anchor":"lua_shared_dict","htmlText":"lua_shared_dict"},{"level":2,"text":"lua_socket_connect_timeout","anchor":"lua_socket_connect_timeout","htmlText":"lua_socket_connect_timeout"},{"level":2,"text":"lua_socket_send_timeout","anchor":"lua_socket_send_timeout","htmlText":"lua_socket_send_timeout"},{"level":2,"text":"lua_socket_send_lowat","anchor":"lua_socket_send_lowat","htmlText":"lua_socket_send_lowat"},{"level":2,"text":"lua_socket_read_timeout","anchor":"lua_socket_read_timeout","htmlText":"lua_socket_read_timeout"},{"level":2,"text":"lua_socket_buffer_size","anchor":"lua_socket_buffer_size","htmlText":"lua_socket_buffer_size"},{"level":2,"text":"lua_socket_pool_size","anchor":"lua_socket_pool_size","htmlText":"lua_socket_pool_size"},{"level":2,"text":"lua_socket_keepalive_timeout","anchor":"lua_socket_keepalive_timeout","htmlText":"lua_socket_keepalive_timeout"},{"level":2,"text":"lua_socket_log_errors","anchor":"lua_socket_log_errors","htmlText":"lua_socket_log_errors"},{"level":2,"text":"lua_ssl_ciphers","anchor":"lua_ssl_ciphers","htmlText":"lua_ssl_ciphers"},{"level":2,"text":"lua_ssl_crl","anchor":"lua_ssl_crl","htmlText":"lua_ssl_crl"},{"level":2,"text":"lua_ssl_protocols","anchor":"lua_ssl_protocols","htmlText":"lua_ssl_protocols"},{"level":2,"text":"lua_ssl_certificate","anchor":"lua_ssl_certificate","htmlText":"lua_ssl_certificate"},{"level":2,"text":"lua_ssl_certificate_key","anchor":"lua_ssl_certificate_key","htmlText":"lua_ssl_certificate_key"},{"level":2,"text":"lua_ssl_trusted_certificate","anchor":"lua_ssl_trusted_certificate","htmlText":"lua_ssl_trusted_certificate"},{"level":2,"text":"lua_ssl_verify_depth","anchor":"lua_ssl_verify_depth","htmlText":"lua_ssl_verify_depth"},{"level":2,"text":"lua_ssl_key_log","anchor":"lua_ssl_key_log","htmlText":"lua_ssl_key_log"},{"level":2,"text":"lua_ssl_conf_command","anchor":"lua_ssl_conf_command","htmlText":"lua_ssl_conf_command"},{"level":2,"text":"lua_upstream_skip_openssl_default_verify","anchor":"lua_upstream_skip_openssl_default_verify","htmlText":"lua_upstream_skip_openssl_default_verify"},{"level":2,"text":"lua_http10_buffering","anchor":"lua_http10_buffering","htmlText":"lua_http10_buffering"},{"level":2,"text":"rewrite_by_lua_no_postpone","anchor":"rewrite_by_lua_no_postpone","htmlText":"rewrite_by_lua_no_postpone"},{"level":2,"text":"access_by_lua_no_postpone","anchor":"access_by_lua_no_postpone","htmlText":"access_by_lua_no_postpone"},{"level":2,"text":"lua_transform_underscores_in_response_headers","anchor":"lua_transform_underscores_in_response_headers","htmlText":"lua_transform_underscores_in_response_headers"},{"level":2,"text":"lua_check_client_abort","anchor":"lua_check_client_abort","htmlText":"lua_check_client_abort"},{"level":2,"text":"lua_max_pending_timers","anchor":"lua_max_pending_timers","htmlText":"lua_max_pending_timers"},{"level":2,"text":"lua_max_running_timers","anchor":"lua_max_running_timers","htmlText":"lua_max_running_timers"},{"level":2,"text":"lua_sa_restart","anchor":"lua_sa_restart","htmlText":"lua_sa_restart"},{"level":2,"text":"lua_worker_thread_vm_pool_size","anchor":"lua_worker_thread_vm_pool_size","htmlText":"lua_worker_thread_vm_pool_size"},{"level":1,"text":"Nginx API for Lua","anchor":"nginx-api-for-lua","htmlText":"Nginx API for Lua"},{"level":2,"text":"Introduction","anchor":"introduction","htmlText":"Introduction"},{"level":2,"text":"ngx.arg","anchor":"ngxarg","htmlText":"ngx.arg"},{"level":2,"text":"ngx.var.VARIABLE","anchor":"ngxvarvariable","htmlText":"ngx.var.VARIABLE"},{"level":2,"text":"Core constants","anchor":"core-constants","htmlText":"Core constants"},{"level":2,"text":"HTTP method constants","anchor":"http-method-constants","htmlText":"HTTP method constants"},{"level":2,"text":"HTTP status constants","anchor":"http-status-constants","htmlText":"HTTP status constants"},{"level":2,"text":"Nginx log level constants","anchor":"nginx-log-level-constants","htmlText":"Nginx log level constants"},{"level":2,"text":"print","anchor":"print","htmlText":"print"},{"level":2,"text":"ngx.ctx","anchor":"ngxctx","htmlText":"ngx.ctx"},{"level":2,"text":"ngx.location.capture","anchor":"ngxlocationcapture","htmlText":"ngx.location.capture"},{"level":2,"text":"ngx.location.capture_multi","anchor":"ngxlocationcapture_multi","htmlText":"ngx.location.capture_multi"},{"level":2,"text":"ngx.status","anchor":"ngxstatus","htmlText":"ngx.status"},{"level":2,"text":"ngx.header.HEADER","anchor":"ngxheaderheader","htmlText":"ngx.header.HEADER"},{"level":2,"text":"ngx.resp.get_headers","anchor":"ngxrespget_headers","htmlText":"ngx.resp.get_headers"},{"level":2,"text":"ngx.req.is_internal","anchor":"ngxreqis_internal","htmlText":"ngx.req.is_internal"},{"level":2,"text":"ngx.req.start_time","anchor":"ngxreqstart_time","htmlText":"ngx.req.start_time"},{"level":2,"text":"ngx.req.http_version","anchor":"ngxreqhttp_version","htmlText":"ngx.req.http_version"},{"level":2,"text":"ngx.req.raw_header","anchor":"ngxreqraw_header","htmlText":"ngx.req.raw_header"},{"level":2,"text":"ngx.req.get_method","anchor":"ngxreqget_method","htmlText":"ngx.req.get_method"},{"level":2,"text":"ngx.req.set_method","anchor":"ngxreqset_method","htmlText":"ngx.req.set_method"},{"level":2,"text":"ngx.req.set_uri","anchor":"ngxreqset_uri","htmlText":"ngx.req.set_uri"},{"level":2,"text":"ngx.req.set_uri_args","anchor":"ngxreqset_uri_args","htmlText":"ngx.req.set_uri_args"},{"level":2,"text":"ngx.req.get_uri_args","anchor":"ngxreqget_uri_args","htmlText":"ngx.req.get_uri_args"},{"level":2,"text":"ngx.req.get_post_args","anchor":"ngxreqget_post_args","htmlText":"ngx.req.get_post_args"},{"level":2,"text":"ngx.req.get_headers","anchor":"ngxreqget_headers","htmlText":"ngx.req.get_headers"},{"level":2,"text":"ngx.req.set_header","anchor":"ngxreqset_header","htmlText":"ngx.req.set_header"},{"level":2,"text":"ngx.req.clear_header","anchor":"ngxreqclear_header","htmlText":"ngx.req.clear_header"},{"level":2,"text":"ngx.req.read_body","anchor":"ngxreqread_body","htmlText":"ngx.req.read_body"},{"level":2,"text":"ngx.req.discard_body","anchor":"ngxreqdiscard_body","htmlText":"ngx.req.discard_body"},{"level":2,"text":"ngx.req.get_body_data","anchor":"ngxreqget_body_data","htmlText":"ngx.req.get_body_data"},{"level":2,"text":"ngx.req.get_body_file","anchor":"ngxreqget_body_file","htmlText":"ngx.req.get_body_file"},{"level":2,"text":"ngx.req.set_body_data","anchor":"ngxreqset_body_data","htmlText":"ngx.req.set_body_data"},{"level":2,"text":"ngx.req.set_body_file","anchor":"ngxreqset_body_file","htmlText":"ngx.req.set_body_file"},{"level":2,"text":"ngx.req.init_body","anchor":"ngxreqinit_body","htmlText":"ngx.req.init_body"},{"level":2,"text":"ngx.req.append_body","anchor":"ngxreqappend_body","htmlText":"ngx.req.append_body"},{"level":2,"text":"ngx.req.finish_body","anchor":"ngxreqfinish_body","htmlText":"ngx.req.finish_body"},{"level":2,"text":"ngx.req.socket","anchor":"ngxreqsocket","htmlText":"ngx.req.socket"},{"level":2,"text":"ngx.exec","anchor":"ngxexec","htmlText":"ngx.exec"},{"level":2,"text":"ngx.redirect","anchor":"ngxredirect","htmlText":"ngx.redirect"},{"level":2,"text":"ngx.send_headers","anchor":"ngxsend_headers","htmlText":"ngx.send_headers"},{"level":2,"text":"ngx.headers_sent","anchor":"ngxheaders_sent","htmlText":"ngx.headers_sent"},{"level":2,"text":"ngx.print","anchor":"ngxprint","htmlText":"ngx.print"},{"level":2,"text":"ngx.say","anchor":"ngxsay","htmlText":"ngx.say"},{"level":2,"text":"ngx.log","anchor":"ngxlog","htmlText":"ngx.log"},{"level":2,"text":"ngx.flush","anchor":"ngxflush","htmlText":"ngx.flush"},{"level":2,"text":"ngx.exit","anchor":"ngxexit","htmlText":"ngx.exit"},{"level":2,"text":"ngx.eof","anchor":"ngxeof","htmlText":"ngx.eof"},{"level":2,"text":"ngx.sleep","anchor":"ngxsleep","htmlText":"ngx.sleep"},{"level":2,"text":"ngx.escape_uri","anchor":"ngxescape_uri","htmlText":"ngx.escape_uri"},{"level":2,"text":"ngx.unescape_uri","anchor":"ngxunescape_uri","htmlText":"ngx.unescape_uri"},{"level":2,"text":"ngx.encode_args","anchor":"ngxencode_args","htmlText":"ngx.encode_args"},{"level":2,"text":"ngx.decode_args","anchor":"ngxdecode_args","htmlText":"ngx.decode_args"},{"level":2,"text":"ngx.encode_base64","anchor":"ngxencode_base64","htmlText":"ngx.encode_base64"},{"level":2,"text":"ngx.decode_base64","anchor":"ngxdecode_base64","htmlText":"ngx.decode_base64"},{"level":2,"text":"ngx.decode_base64mime","anchor":"ngxdecode_base64mime","htmlText":"ngx.decode_base64mime"},{"level":2,"text":"ngx.crc32_short","anchor":"ngxcrc32_short","htmlText":"ngx.crc32_short"},{"level":2,"text":"ngx.crc32_long","anchor":"ngxcrc32_long","htmlText":"ngx.crc32_long"},{"level":2,"text":"ngx.hmac_sha1","anchor":"ngxhmac_sha1","htmlText":"ngx.hmac_sha1"},{"level":2,"text":"ngx.md5","anchor":"ngxmd5","htmlText":"ngx.md5"},{"level":2,"text":"ngx.md5_bin","anchor":"ngxmd5_bin","htmlText":"ngx.md5_bin"},{"level":2,"text":"ngx.sha1_bin","anchor":"ngxsha1_bin","htmlText":"ngx.sha1_bin"},{"level":2,"text":"ngx.quote_sql_str","anchor":"ngxquote_sql_str","htmlText":"ngx.quote_sql_str"},{"level":2,"text":"ngx.today","anchor":"ngxtoday","htmlText":"ngx.today"},{"level":2,"text":"ngx.time","anchor":"ngxtime","htmlText":"ngx.time"},{"level":2,"text":"ngx.now","anchor":"ngxnow","htmlText":"ngx.now"},{"level":2,"text":"ngx.update_time","anchor":"ngxupdate_time","htmlText":"ngx.update_time"},{"level":2,"text":"ngx.localtime","anchor":"ngxlocaltime","htmlText":"ngx.localtime"},{"level":2,"text":"ngx.utctime","anchor":"ngxutctime","htmlText":"ngx.utctime"},{"level":2,"text":"ngx.cookie_time","anchor":"ngxcookie_time","htmlText":"ngx.cookie_time"},{"level":2,"text":"ngx.http_time","anchor":"ngxhttp_time","htmlText":"ngx.http_time"},{"level":2,"text":"ngx.parse_http_time","anchor":"ngxparse_http_time","htmlText":"ngx.parse_http_time"},{"level":2,"text":"ngx.is_subrequest","anchor":"ngxis_subrequest","htmlText":"ngx.is_subrequest"},{"level":2,"text":"ngx.re.match","anchor":"ngxrematch","htmlText":"ngx.re.match"},{"level":2,"text":"ngx.re.find","anchor":"ngxrefind","htmlText":"ngx.re.find"},{"level":2,"text":"ngx.re.gmatch","anchor":"ngxregmatch","htmlText":"ngx.re.gmatch"},{"level":2,"text":"ngx.re.sub","anchor":"ngxresub","htmlText":"ngx.re.sub"},{"level":2,"text":"ngx.re.gsub","anchor":"ngxregsub","htmlText":"ngx.re.gsub"},{"level":2,"text":"ngx.shared.DICT","anchor":"ngxshareddict","htmlText":"ngx.shared.DICT"},{"level":2,"text":"ngx.shared.DICT.get","anchor":"ngxshareddictget","htmlText":"ngx.shared.DICT.get"},{"level":2,"text":"ngx.shared.DICT.get_stale","anchor":"ngxshareddictget_stale","htmlText":"ngx.shared.DICT.get_stale"},{"level":2,"text":"ngx.shared.DICT.set","anchor":"ngxshareddictset","htmlText":"ngx.shared.DICT.set"},{"level":2,"text":"ngx.shared.DICT.safe_set","anchor":"ngxshareddictsafe_set","htmlText":"ngx.shared.DICT.safe_set"},{"level":2,"text":"ngx.shared.DICT.add","anchor":"ngxshareddictadd","htmlText":"ngx.shared.DICT.add"},{"level":2,"text":"ngx.shared.DICT.safe_add","anchor":"ngxshareddictsafe_add","htmlText":"ngx.shared.DICT.safe_add"},{"level":2,"text":"ngx.shared.DICT.replace","anchor":"ngxshareddictreplace","htmlText":"ngx.shared.DICT.replace"},{"level":2,"text":"ngx.shared.DICT.delete","anchor":"ngxshareddictdelete","htmlText":"ngx.shared.DICT.delete"},{"level":2,"text":"ngx.shared.DICT.incr","anchor":"ngxshareddictincr","htmlText":"ngx.shared.DICT.incr"},{"level":2,"text":"ngx.shared.DICT.lpush","anchor":"ngxshareddictlpush","htmlText":"ngx.shared.DICT.lpush"},{"level":2,"text":"ngx.shared.DICT.rpush","anchor":"ngxshareddictrpush","htmlText":"ngx.shared.DICT.rpush"},{"level":2,"text":"ngx.shared.DICT.lpop","anchor":"ngxshareddictlpop","htmlText":"ngx.shared.DICT.lpop"},{"level":2,"text":"ngx.shared.DICT.rpop","anchor":"ngxshareddictrpop","htmlText":"ngx.shared.DICT.rpop"},{"level":2,"text":"ngx.shared.DICT.llen","anchor":"ngxshareddictllen","htmlText":"ngx.shared.DICT.llen"},{"level":2,"text":"ngx.shared.DICT.ttl","anchor":"ngxshareddictttl","htmlText":"ngx.shared.DICT.ttl"},{"level":2,"text":"ngx.shared.DICT.expire","anchor":"ngxshareddictexpire","htmlText":"ngx.shared.DICT.expire"},{"level":2,"text":"ngx.shared.DICT.flush_all","anchor":"ngxshareddictflush_all","htmlText":"ngx.shared.DICT.flush_all"},{"level":2,"text":"ngx.shared.DICT.flush_expired","anchor":"ngxshareddictflush_expired","htmlText":"ngx.shared.DICT.flush_expired"},{"level":2,"text":"ngx.shared.DICT.get_keys","anchor":"ngxshareddictget_keys","htmlText":"ngx.shared.DICT.get_keys"},{"level":2,"text":"ngx.shared.DICT.capacity","anchor":"ngxshareddictcapacity","htmlText":"ngx.shared.DICT.capacity"},{"level":2,"text":"ngx.shared.DICT.free_space","anchor":"ngxshareddictfree_space","htmlText":"ngx.shared.DICT.free_space"},{"level":2,"text":"ngx.socket.udp","anchor":"ngxsocketudp","htmlText":"ngx.socket.udp"},{"level":2,"text":"udpsock:bind","anchor":"udpsockbind","htmlText":"udpsock:bind"},{"level":2,"text":"udpsock:setpeername","anchor":"udpsocksetpeername","htmlText":"udpsock:setpeername"},{"level":2,"text":"udpsock:send","anchor":"udpsocksend","htmlText":"udpsock:send"},{"level":2,"text":"udpsock:receive","anchor":"udpsockreceive","htmlText":"udpsock:receive"},{"level":2,"text":"udpsock:close","anchor":"udpsockclose","htmlText":"udpsock:close"},{"level":2,"text":"udpsock:settimeout","anchor":"udpsocksettimeout","htmlText":"udpsock:settimeout"},{"level":2,"text":"ngx.socket.stream","anchor":"ngxsocketstream","htmlText":"ngx.socket.stream"},{"level":2,"text":"ngx.socket.tcp","anchor":"ngxsockettcp","htmlText":"ngx.socket.tcp"},{"level":2,"text":"tcpsock:bind","anchor":"tcpsockbind","htmlText":"tcpsock:bind"},{"level":2,"text":"tcpsock:connect","anchor":"tcpsockconnect","htmlText":"tcpsock:connect"},{"level":2,"text":"tcpsock:getfd","anchor":"tcpsockgetfd","htmlText":"tcpsock:getfd"},{"level":2,"text":"tcpsock:setclientcert","anchor":"tcpsocksetclientcert","htmlText":"tcpsock:setclientcert"},{"level":2,"text":"tcpsock:sslhandshake","anchor":"tcpsocksslhandshake","htmlText":"tcpsock:sslhandshake"},{"level":2,"text":"tcpsock:send","anchor":"tcpsocksend","htmlText":"tcpsock:send"},{"level":2,"text":"tcpsock:receive","anchor":"tcpsockreceive","htmlText":"tcpsock:receive"},{"level":2,"text":"tcpsock:receiveany","anchor":"tcpsockreceiveany","htmlText":"tcpsock:receiveany"},{"level":2,"text":"tcpsock:receiveuntil","anchor":"tcpsockreceiveuntil","htmlText":"tcpsock:receiveuntil"},{"level":2,"text":"tcpsock:close","anchor":"tcpsockclose","htmlText":"tcpsock:close"},{"level":2,"text":"tcpsock:settimeout","anchor":"tcpsocksettimeout","htmlText":"tcpsock:settimeout"},{"level":2,"text":"tcpsock:settimeouts","anchor":"tcpsocksettimeouts","htmlText":"tcpsock:settimeouts"},{"level":2,"text":"tcpsock:setoption","anchor":"tcpsocksetoption","htmlText":"tcpsock:setoption"},{"level":2,"text":"tcpsock:setkeepalive","anchor":"tcpsocksetkeepalive","htmlText":"tcpsock:setkeepalive"},{"level":2,"text":"tcpsock:getreusedtimes","anchor":"tcpsockgetreusedtimes","htmlText":"tcpsock:getreusedtimes"},{"level":2,"text":"ngx.socket.connect","anchor":"ngxsocketconnect","htmlText":"ngx.socket.connect"},{"level":2,"text":"ngx.get_phase","anchor":"ngxget_phase","htmlText":"ngx.get_phase"},{"level":2,"text":"ngx.thread.spawn","anchor":"ngxthreadspawn","htmlText":"ngx.thread.spawn"},{"level":2,"text":"ngx.thread.wait","anchor":"ngxthreadwait","htmlText":"ngx.thread.wait"},{"level":2,"text":"ngx.thread.kill","anchor":"ngxthreadkill","htmlText":"ngx.thread.kill"},{"level":2,"text":"ngx.on_abort","anchor":"ngxon_abort","htmlText":"ngx.on_abort"},{"level":2,"text":"ngx.timer.at","anchor":"ngxtimerat","htmlText":"ngx.timer.at"},{"level":2,"text":"ngx.timer.every","anchor":"ngxtimerevery","htmlText":"ngx.timer.every"},{"level":2,"text":"ngx.timer.running_count","anchor":"ngxtimerrunning_count","htmlText":"ngx.timer.running_count"},{"level":2,"text":"ngx.timer.pending_count","anchor":"ngxtimerpending_count","htmlText":"ngx.timer.pending_count"},{"level":2,"text":"ngx.config.subsystem","anchor":"ngxconfigsubsystem","htmlText":"ngx.config.subsystem"},{"level":2,"text":"ngx.config.debug","anchor":"ngxconfigdebug","htmlText":"ngx.config.debug"},{"level":2,"text":"ngx.config.prefix","anchor":"ngxconfigprefix","htmlText":"ngx.config.prefix"},{"level":2,"text":"ngx.config.nginx_version","anchor":"ngxconfignginx_version","htmlText":"ngx.config.nginx_version"},{"level":2,"text":"ngx.config.nginx_configure","anchor":"ngxconfignginx_configure","htmlText":"ngx.config.nginx_configure"},{"level":2,"text":"ngx.config.ngx_lua_version","anchor":"ngxconfigngx_lua_version","htmlText":"ngx.config.ngx_lua_version"},{"level":2,"text":"ngx.worker.exiting","anchor":"ngxworkerexiting","htmlText":"ngx.worker.exiting"},{"level":2,"text":"ngx.worker.pid","anchor":"ngxworkerpid","htmlText":"ngx.worker.pid"},{"level":2,"text":"ngx.worker.pids","anchor":"ngxworkerpids","htmlText":"ngx.worker.pids"},{"level":2,"text":"ngx.worker.count","anchor":"ngxworkercount","htmlText":"ngx.worker.count"},{"level":2,"text":"ngx.worker.id","anchor":"ngxworkerid","htmlText":"ngx.worker.id"},{"level":2,"text":"ngx.semaphore","anchor":"ngxsemaphore","htmlText":"ngx.semaphore"},{"level":2,"text":"ngx.balancer","anchor":"ngxbalancer","htmlText":"ngx.balancer"},{"level":2,"text":"ngx.ssl","anchor":"ngxssl","htmlText":"ngx.ssl"},{"level":2,"text":"ngx.ocsp","anchor":"ngxocsp","htmlText":"ngx.ocsp"},{"level":2,"text":"ndk.set_var.DIRECTIVE","anchor":"ndkset_vardirective","htmlText":"ndk.set_var.DIRECTIVE"},{"level":2,"text":"coroutine.create","anchor":"coroutinecreate","htmlText":"coroutine.create"},{"level":2,"text":"coroutine.resume","anchor":"coroutineresume","htmlText":"coroutine.resume"},{"level":2,"text":"coroutine.yield","anchor":"coroutineyield","htmlText":"coroutine.yield"},{"level":2,"text":"coroutine.wrap","anchor":"coroutinewrap","htmlText":"coroutine.wrap"},{"level":2,"text":"coroutine.running","anchor":"coroutinerunning","htmlText":"coroutine.running"},{"level":2,"text":"coroutine.status","anchor":"coroutinestatus","htmlText":"coroutine.status"},{"level":2,"text":"ngx.run_worker_thread","anchor":"ngxrun_worker_thread","htmlText":"ngx.run_worker_thread"},{"level":1,"text":"Obsolete Sections","anchor":"obsolete-sections","htmlText":"Obsolete Sections"},{"level":2,"text":"Special PCRE Sequences","anchor":"special-pcre-sequences","htmlText":"Special PCRE Sequences"},{"level":2,"text":"Lua/LuaJIT bytecode support","anchor":"lualuajit-bytecode-support","htmlText":"Lua/LuaJIT bytecode support"}],"siteNavLoginPath":"/login?return_to=https%3A%2F%2Fgithub.com%2Fopenresty%2Flua-nginx-module"}}],"overviewFilesProcessingTime":0,"copilotSWEAgentEnabled":false}},"appPayload":{"helpUrl":"https://docs.github.com","findFileWorkerPath":"/assets-cdn/worker/find-file-worker-9bd411a8e273.js","findInFileWorkerPath":"/assets-cdn/worker/find-in-file-worker-4747241b1152.js","githubDevUrl":null,"enabled_features":{"copilot_workspace":null,"code_nav_ui_events":false,"react_blob_overlay":false,"accessible_code_button":true}}}}</script>
  <div data-target="react-partial.reactRoot"> <!-- --> <!-- --> <div class="OverviewContent-module__Box--uNd1J"><div class="OverviewHeader-module__Box--fFKf5"></div><div class="OverviewContent-module__Box_1--RhaEy"><div class="OverviewContent-module__Box_2--uHewD"><div class="OverviewContent-module__Box_3--NEYWl"><button type="button" aria-haspopup="true" aria-expanded="false" tabindex="0" style="min-width:0" aria-label="master branch" data-testid="anchor-button" class="prc-Button-ButtonBase-c50BI overview-ref-selector width-full RefSelectorAnchoredOverlay-module__RefSelectorOverlayBtn--D34zl" data-loading="false" data-size="medium" data-variant="default" aria-describedby="ref-picker-repos-header-ref-selector-loading-announcement" id="ref-picker-repos-header-ref-selector"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="text" class="prc-Button-Label-pTQ3x"><div class="RefSelectorAnchoredOverlay-module__RefSelectorOverlayContainer--mCbv8"><div class="RefSelectorAnchoredOverlay-module__RefSelectorOverlayHeader--D4cnZ"><svg aria-hidden="true" focusable="false" class="octicon octicon-git-branch" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path></svg></div><div class="ref-selector-button-text-container RefSelectorAnchoredOverlay-module__RefSelectorBtnTextContainer--yO402"><span class="RefSelectorAnchoredOverlay-module__RefSelectorText--bxVhQ"> <!-- -->master</span></div></div></span><span data-component="trailingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-triangle-down" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="m4.427 7.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"></path></svg></span></span></button><button hidden="" data-testid="ref-selector-hotkey-button" data-hotkey-scope="read-only-cursor-text-area"></button></div><div class="OverviewContent-module__Box_4--rOz8J"><a type="button" href="/openresty/lua-nginx-module/branches" class="prc-Button-ButtonBase-c50BI OverviewContent-module__Button--MDoYP" data-loading="false" data-size="medium" data-variant="invisible" aria-describedby=":Rclab:-loading-announcement"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="leadingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-git-branch" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path></svg></span><span data-component="text" class="prc-Button-Label-pTQ3x">Branches</span></span></a><a type="button" href="/openresty/lua-nginx-module/tags" class="prc-Button-ButtonBase-c50BI OverviewContent-module__Button--MDoYP" data-loading="false" data-size="medium" data-variant="invisible" aria-describedby=":Rklab:-loading-announcement"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="leadingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path></svg></span><span data-component="text" class="prc-Button-Label-pTQ3x">Tags</span></span></a></div><div class="OverviewContent-module__Box_5--PPbL1"><a type="button" aria-label="Go to Branches page" href="/openresty/lua-nginx-module/branches" class="prc-Button-ButtonBase-c50BI OverviewContent-module__Button_1--_1Ng2" data-loading="false" data-no-visuals="true" data-size="medium" data-variant="invisible" aria-describedby=":Relab:-loading-announcement"><svg aria-hidden="true" focusable="false" class="octicon octicon-git-branch" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path></svg></a><a type="button" aria-label="Go to Tags page" href="/openresty/lua-nginx-module/tags" class="prc-Button-ButtonBase-c50BI OverviewContent-module__Button_1--_1Ng2" data-loading="false" data-no-visuals="true" data-size="medium" data-variant="invisible" aria-describedby=":Rmlab:-loading-announcement"><svg aria-hidden="true" focusable="false" class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path></svg></a></div></div><div class="OverviewContent-module__Box_6--wV7Tw"><div class="OverviewContent-module__Box_7--SbxdI"><div class="OverviewContent-module__Box_8--oumpR"><!--$--><div class="Box-sc-62in7e-0 OverviewContent-module__FileResultsList--irMg6"><span class="TextInput__StyledTextInput-sc-ttxlvl-0 d-flex FileResultsList-module__FilesSearchBox--fSAh3 TextInput-wrapper prc-components-TextInputWrapper-i1ofR prc-components-TextInputBaseWrapper-ueK9q" data-leading-visual="true" data-trailing-visual="true" aria-busy="false"><span class="TextInput-icon" id=":R535ab:" aria-hidden="true"><svg aria-hidden="true" focusable="false" class="octicon octicon-search" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path></svg></span><input type="text" aria-label="Go to file" role="combobox" aria-controls="file-results-list" aria-expanded="false" aria-haspopup="dialog" autoCorrect="off" spellcheck="false" placeholder="Go to file" aria-describedby=":R535ab: :R535abH1:" data-component="input" class="prc-components-Input-Ic-y8" value=""/><span class="TextInput-icon" id=":R535abH1:" aria-hidden="true"></span></span></div><!--/$--></div><div class="OverviewContent-module__Box_9--mQYON"><button type="button" class="prc-Button-ButtonBase-c50BI" data-loading="false" data-no-visuals="true" data-size="medium" data-variant="default" aria-describedby=":R1j5ab:-loading-announcement"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="text" class="prc-Button-Label-pTQ3x">Go to file</span></span></button></div></div><button type="button" aria-haspopup="true" aria-expanded="false" tabindex="0" class="prc-Button-ButtonBase-c50BI" data-loading="false" data-size="medium" data-variant="primary" aria-describedby=":R75ab:-loading-announcement" id=":R75ab:"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="leadingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-code hide-sm" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="m11.28 3.22 4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L13.94 8l-3.72-3.72a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215Zm-6.56 0a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L2.06 8l3.72 3.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L.47 8.53a.75.75 0 0 1 0-1.06Z"></path></svg></span><span data-component="text" class="prc-Button-Label-pTQ3x">Code</span><span data-component="trailingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-triangle-down" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="m4.427 7.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"></path></svg></span></span></button><div class="OverviewContent-module__Box_10--ULKAG"><button data-component="IconButton" type="button" aria-haspopup="true" aria-expanded="false" tabindex="0" class="prc-Button-ButtonBase-c50BI prc-Button-IconButton-szpyj" data-loading="false" data-no-visuals="true" data-size="medium" data-variant="default" aria-describedby=":R95ab:-loading-announcement" aria-labelledby=":R7p5ab:" id=":R95ab:"><svg aria-hidden="true" focusable="false" class="octicon octicon-kebab-horizontal" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M8 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM1.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm13 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path></svg></button><span class="prc-TooltipV2-Tooltip-cYMVY" data-direction="n" aria-hidden="true" id=":R7p5ab:">Open more actions menu</span></div></div></div><div class="OverviewContent-module__Box_11--Tqhu2"><div data-hpc="true"><button hidden="" data-testid="focus-next-element-button" data-hotkey="j"></button><button hidden="" data-testid="focus-previous-element-button" data-hotkey="k"></button><h2 class="sr-only ScreenReaderHeading-module__userSelectNone--vlUbc prc-Heading-Heading-6CmGO" data-testid="screen-reader-heading" id="folders-and-files">Folders and files</h2><table class="Table-module__Box--KyMHK" aria-labelledby="folders-and-files"><thead class="DirectoryContent-module__OverviewHeaderRow--FlrUZ Table-module__Box_1--DkRqs"><tr class="Table-module__Box_2--l1wjV"><th colSpan="2" class="DirectoryContent-module__Box--y3Nvf"><span class="text-bold">Name</span></th><th colSpan="1" class="DirectoryContent-module__Box_1--xeAhp"><span class="text-bold">Name</span></th><th class="hide-sm"><div class="width-fit prc-Truncate-Truncate-A9Wn6" data-inline="true" title="Last commit message" style="--truncate-max-width:125px"><span class="text-bold">Last commit message</span></div></th><th colSpan="1" class="DirectoryContent-module__Box_2--h912w"><div class="width-fit prc-Truncate-Truncate-A9Wn6" data-inline="true" title="Last commit date" style="--truncate-max-width:125px"><span class="text-bold">Last commit date</span></div></th></tr></thead><tbody><tr class="DirectoryContent-module__Box_3--zI0N1"><td colSpan="3" class="bgColor-muted p-1 rounded-top-2"><div class="LatestCommit-module__Box--Fimpo"><h2 class="sr-only ScreenReaderHeading-module__userSelectNone--vlUbc prc-Heading-Heading-6CmGO" data-testid="screen-reader-heading">Latest commit</h2><div style="width:120px" class="Skeleton Skeleton--text" data-testid="loading"> </div><div class="d-flex flex-shrink-0 gap-2"><div data-testid="latest-commit-details" class="d-none d-sm-flex flex-items-center"></div><div class="d-flex gap-2"><h2 class="sr-only ScreenReaderHeading-module__userSelectNone--vlUbc prc-Heading-Heading-6CmGO" data-testid="screen-reader-heading">History</h2><a href="/openresty/lua-nginx-module/commits/master/" class="prc-Button-ButtonBase-c50BI d-none d-lg-flex LinkButton-module__code-view-link-button--thtqc flex-items-center fgColor-default" data-loading="false" data-size="small" data-variant="invisible" aria-describedby=":Raqj8pab:-loading-announcement"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="leadingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-history" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="m.427 1.927 1.215 1.215a8.002 8.002 0 1 1-1.6 5.685.75.75 0 1 1 1.493-.154 6.5 6.5 0 1 0 1.18-4.458l1.358 1.358A.25.25 0 0 1 3.896 6H.25A.25.25 0 0 1 0 5.75V2.104a.25.25 0 0 1 .427-.177ZM7.75 4a.75.75 0 0 1 .75.75v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5A.75.75 0 0 1 7.75 4Z"></path></svg></span><span data-component="text" class="prc-Button-Label-pTQ3x"><span class="fgColor-default">3,968 Commits</span></span></span></a><div class="d-sm-none"></div><div class="d-flex d-lg-none"><span role="tooltip" aria-label="3,968 Commits" id="history-icon-button-tooltip" class="prc-Tooltip-Tooltip--1XZX prc-Tooltip-Tooltip--n-BOOzB tooltipped-n"><a aria-label="View commit history for this file." href="/openresty/lua-nginx-module/commits/master/" class="prc-Button-ButtonBase-c50BI LinkButton-module__code-view-link-button--thtqc flex-items-center fgColor-default" data-loading="false" data-size="small" data-variant="invisible" aria-describedby=":R1iqj8pab:-loading-announcement history-icon-button-tooltip"><span data-component="buttonContent" data-align="center" class="prc-Button-ButtonContent-HKbr-"><span data-component="leadingVisual" class="prc-Button-Visual-2epfX prc-Button-VisualWrap-Db-eB"><svg aria-hidden="true" focusable="false" class="octicon octicon-history" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="m.427 1.927 1.215 1.215a8.002 8.002 0 1 1-1.6 5.685.75.75 0 1 1 1.493-.154 6.5 6.5 0 1 0 1.18-4.458l1.358 1.358A.25.25 0 0 1 3.896 6H.25A.25.25 0 0 1 0 5.75V2.104a.25.25 0 0 1 .427-.177ZM7.75 4a.75.75 0 0 1 .75.75v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5A.75.75 0 0 1 7.75 4Z"></path></svg></span></span></a></span></div></div></div></div></td></tr><tr class="react-directory-row undefined" id="folder-row-0"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".github" aria-label=".github, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/.github" data-discover="true">.github</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".github" aria-label=".github, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/.github" data-discover="true">.github</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-1"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="doc" aria-label="doc, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/doc" data-discover="true">doc</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="doc" aria-label="doc, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/doc" data-discover="true">doc</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-2"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="dtrace" aria-label="dtrace, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/dtrace" data-discover="true">dtrace</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="dtrace" aria-label="dtrace, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/dtrace" data-discover="true">dtrace</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-3"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="This path skips through empty directories" aria-label="misc/recv-until-pm, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/misc/recv-until-pm" data-discover="true"><span class="react-directory-default-color" data-testid="path-name-segment">misc/</span><span class="" data-testid="path-name-segment">recv-until-pm</span></a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="This path skips through empty directories" aria-label="misc/recv-until-pm, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/misc/recv-until-pm" data-discover="true"><span class="react-directory-default-color" data-testid="path-name-segment">misc/</span><span class="" data-testid="path-name-segment">recv-until-pm</span></a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-4"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="src" aria-label="src, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/src" data-discover="true">src</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="src" aria-label="src, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/src" data-discover="true">src</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-5"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="t" aria-label="t, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/t" data-discover="true">t</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="t" aria-label="t, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/t" data-discover="true">t</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-6"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="tapset" aria-label="tapset, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/tapset" data-discover="true">tapset</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="tapset" aria-label="tapset, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/tapset" data-discover="true">tapset</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-7"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="util" aria-label="util, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/util" data-discover="true">util</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file-directory-fill icon-directory" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="util" aria-label="util, (Directory)" class="Link--primary" href="/openresty/lua-nginx-module/tree/master/util" data-discover="true">util</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-8"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".gitattributes" aria-label=".gitattributes, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.gitattributes" data-discover="true">.gitattributes</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".gitattributes" aria-label=".gitattributes, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.gitattributes" data-discover="true">.gitattributes</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row undefined" id="folder-row-9"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".gitignore" aria-label=".gitignore, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.gitignore" data-discover="true">.gitignore</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".gitignore" aria-label=".gitignore, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.gitignore" data-discover="true">.gitignore</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row truncate-for-mobile" id="folder-row-10"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".mergify.yml" aria-label=".mergify.yml, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.mergify.yml" data-discover="true">.mergify.yml</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".mergify.yml" aria-label=".mergify.yml, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.mergify.yml" data-discover="true">.mergify.yml</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row truncate-for-mobile" id="folder-row-11"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".travis.yml" aria-label=".travis.yml, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.travis.yml" data-discover="true">.travis.yml</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title=".travis.yml" aria-label=".travis.yml, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/.travis.yml" data-discover="true">.travis.yml</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row truncate-for-mobile" id="folder-row-12"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="README.markdown" aria-label="README.markdown, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/README.markdown" data-discover="true">README.markdown</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="README.markdown" aria-label="README.markdown, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/README.markdown" data-discover="true">README.markdown</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row truncate-for-mobile" id="folder-row-13"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="config" aria-label="config, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/config" data-discover="true">config</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="config" aria-label="config, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/config" data-discover="true">config</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="react-directory-row truncate-for-mobile" id="folder-row-14"><td class="react-directory-row-name-cell-small-screen" colSpan="2"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="valgrind.suppress" aria-label="valgrind.suppress, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/valgrind.suppress" data-discover="true">valgrind.suppress</a></div></div></div></div></td><td class="react-directory-row-name-cell-large-screen" colSpan="1"><div class="react-directory-filename-column"><svg aria-hidden="true" focusable="false" class="octicon octicon-file color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg><div class="overflow-hidden"><div class="react-directory-filename-cell"><div class="react-directory-truncate"><a title="valgrind.suppress" aria-label="valgrind.suppress, (File)" class="Link--primary" href="/openresty/lua-nginx-module/blob/master/valgrind.suppress" data-discover="true">valgrind.suppress</a></div></div></div></div></td><td class="react-directory-row-commit-cell"><div class="Skeleton Skeleton--text"> </div></td><td><div class="Skeleton Skeleton--text"> </div></td></tr><tr class="show-for-mobile DirectoryContent-module__Box_4--QyUbd" data-testid="view-all-files-row"><td colSpan="3" class="DirectoryContent-module__Box_5--OJZQU"><div><button class="prc-Link-Link-85e08">View all files</button></div></td></tr></tbody></table></div><div class="OverviewRepoFiles-module__Box_1--xSt0T"><div class="OverviewRepoFiles-module__Box_2--yIjMp"><div itemscope="" itemType="https://schema.org/abstract" class="OverviewRepoFiles-module__Box_3--Bi2jM"><h2 class="prc-src-InternalVisuallyHidden-nlR9R">Repository files navigation</h2><nav class="prc-components-UnderlineWrapper-oOh5J OverviewRepoFiles-module__UnderlineNav--BHfFi" aria-label="Repository files" data-variant="inset"><ul class="prc-components-UnderlineItemList-b23Hf" role="list"><li class="prc-UnderlineNav-UnderlineNavItem--xDk1"><a href="#" aria-current="page" class="prc-components-UnderlineItem-lJsg-"><span data-component="icon"><svg aria-hidden="true" focusable="false" class="octicon octicon-book" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"></path></svg></span><span data-component="text" data-content="README">README</span></a></li></ul></nav><button type="button" aria-label="Outline" aria-haspopup="true" aria-expanded="false" tabindex="0" class="prc-Button-ButtonBase-c50BI OverviewRepoFiles-module__ActionMenu_Button--xB9DS" data-loading="false" data-size="medium" data-variant="invisible" aria-describedby=":Rr9ab:-loading-announcement" id=":Rr9ab:"><svg aria-hidden="true" focusable="false" class="octicon octicon-list-unordered" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align:text-bottom"><path d="M5.75 2.5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2 14a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm1-6a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM2 4a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg></button></div><div class="Box-sc-62in7e-0 js-snippet-clipboard-copy-unpositioned DirectoryRichtextContent-module__SharedMarkdownContent--BTKsc" data-hpc="true"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Name</h1><a id="user-content-name" class="anchor" aria-label="Permalink: Name" href="#name"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">ngx_http_lua_module - Embed the power of Lua into Nginx HTTP Servers.</p>
<p dir="auto">This module is a core component of <a href="https://openresty.org" rel="nofollow">OpenResty</a>. If you are using this module,
then you are essentially using OpenResty :)</p>
<p dir="auto"><em>This module is not distributed with the Nginx source.</em> See
<a href="#installation">the installation instructions</a>.</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Table of Contents</h1><a id="user-content-table-of-contents" class="anchor" aria-label="Permalink: Table of Contents" href="#table-of-contents"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#name">Name</a></li>
<li><a href="#status">Status</a></li>
<li><a href="#version">Version</a></li>
<li><a href="#videos">Videos</a></li>
<li><a href="#synopsis">Synopsis</a></li>
<li><a href="#description">Description</a></li>
<li><a href="#typical-uses">Typical Uses</a></li>
<li><a href="#nginx-compatibility">Nginx Compatibility</a></li>
<li><a href="#installation">Installation</a>
<ul dir="auto">
<li><a href="#building-as-a-dynamic-module">Building as a dynamic module</a></li>
<li><a href="#c-macro-configurations">C Macro Configurations</a></li>
</ul>
</li>
<li><a href="#community">Community</a>
<ul dir="auto">
<li><a href="#english-mailing-list">English Mailing List</a></li>
<li><a href="#chinese-mailing-list">Chinese Mailing List</a></li>
</ul>
</li>
<li><a href="#code-repository">Code Repository</a></li>
<li><a href="#bugs-and-patches">Bugs and Patches</a></li>
<li><a href="#luajit-bytecode-support">LuaJIT bytecode support</a></li>
<li><a href="#system-environment-variable-support">System Environment Variable Support</a></li>
<li><a href="#http-10-support">HTTP 1.0 support</a></li>
<li><a href="#statically-linking-pure-lua-modules">Statically Linking Pure Lua Modules</a></li>
<li><a href="#data-sharing-within-an-nginx-worker">Data Sharing within an Nginx Worker</a></li>
<li><a href="#known-issues">Known Issues</a>
<ul dir="auto">
<li><a href="#tcp-socket-connect-operation-issues">TCP socket connect operation issues</a></li>
<li><a href="#lua-coroutine-yieldingresuming">Lua Coroutine Yielding/Resuming</a></li>
<li><a href="#lua-variable-scope">Lua Variable Scope</a></li>
<li><a href="#locations-configured-by-subrequest-directives-of-other-modules">Locations Configured by Subrequest Directives of Other Modules</a></li>
<li><a href="#cosockets-not-available-everywhere">Cosockets Not Available Everywhere</a></li>
<li><a href="#special-escaping-sequences">Special Escaping Sequences</a></li>
<li><a href="#mixing-with-ssi-not-supported">Mixing with SSI Not Supported</a></li>
<li><a href="#spdy-mode-not-fully-supported">SPDY Mode Not Fully Supported</a></li>
<li><a href="#missing-data-on-short-circuited-requests">Missing data on short circuited requests</a></li>
</ul>
</li>
<li><a href="#todo">TODO</a></li>
<li><a href="#changes">Changes</a></li>
<li><a href="#build-and-test">Build And Test</a></li>
<li><a href="#test-suite">Test Suite</a></li>
<li><a href="#copyright-and-license">Copyright and License</a></li>
<li><a href="#see-also">See Also</a></li>
<li><a href="#directives">Directives</a></li>
<li><a href="#nginx-api-for-lua">Nginx API for Lua</a></li>
<li><a href="#obsolete-sections">Obsolete Sections</a>
<ul dir="auto">
<li><a href="#special-pcre-sequences">Special PCRE Sequences</a></li>
<li><a href="#lualuajit-bytecode-support">Lua/LuaJIT bytecode support</a></li>
</ul>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Status</h1><a id="user-content-status" class="anchor" aria-label="Permalink: Status" href="#status"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Production ready.</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Version</h1><a id="user-content-version" class="anchor" aria-label="Permalink: Version" href="#version"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This document describes ngx_lua
<a href="https://github.com/openresty/lua-nginx-module/tags">v0.10.28</a>, which was released
on 17 Jan, 2025.</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Videos</h1><a id="user-content-videos" class="anchor" aria-label="Permalink: Videos" href="#videos"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">YouTube video "<a href="https://youtu.be/eSfYLvVQMxw" rel="nofollow">Hello World HTTP Example with OpenResty/Lua</a>"</p>
<p dir="auto"><a href="https://youtu.be/eSfYLvVQMxw" rel="nofollow"><img src="https://camo.githubusercontent.com/7ff656067b4a093e39aac78ffda66d7ce447608f765fa014dcaea0ee6f9cf825/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f655366594c7656514d78772f302e6a7067" alt="Hello World HTTP Example with OpenResty/Lua" data-canonical-src="https://img.youtube.com/vi/eSfYLvVQMxw/0.jpg" style="max-width: 100%;"></a></p>
</li>
<li>
<p dir="auto">YouTube video "<a href="https://youtu.be/vfYxOMl5LVY" rel="nofollow">Write Your Own Lua Modules in OpenResty/Nginx Applications</a>"</p>
<p dir="auto"><a href="https://youtu.be/vfYxOMl5LVY" rel="nofollow"><img src="https://camo.githubusercontent.com/8819b06eee38f799e2bd232534b694d9d83b1353206c01cab88d91060943108e/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f766659784f4d6c354c56592f302e6a7067" alt="Write Your Own Lua Modules in OpenResty/Nginx Applications" data-canonical-src="https://img.youtube.com/vi/vfYxOMl5LVY/0.jpg" style="max-width: 100%;"></a></p>
</li>
<li>
<p dir="auto">YouTube video "<a href="https://youtu.be/L1c7aw4mSOo" rel="nofollow">OpenResty's resty Command-Line Utility Demo</a>"</p>
<p dir="auto"><a href="https://youtu.be/L1c7aw4mSOo" rel="nofollow"><img src="https://camo.githubusercontent.com/68d68cd6ebcb69256f229c0abe5245237b607506a0eed924d7921e689c2e7cc5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4c3163376177346d534f6f2f302e6a7067" alt="OpenResty's resty Command-Line Utility Demo" data-canonical-src="https://img.youtube.com/vi/L1c7aw4mSOo/0.jpg" style="max-width: 100%;"></a></p>
</li>
<li>
<p dir="auto">YouTube video "<a href="https://youtu.be/VkRYW_qLoME" rel="nofollow">Measure Execution Time of Lua Code Correctly in OpenResty</a>"</p>
<p dir="auto"><a href="https://youtu.be/VkRYW_qLoME" rel="nofollow"><img src="https://camo.githubusercontent.com/8355e8ae9fbef6dd76872c1abc759ecf4defae030ede89709e1ea222e6ca8ad7/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f566b5259575f714c6f4d452f302e6a7067" alt="Measure Execution Time of Lua Code Correctly in OpenResty" data-canonical-src="https://img.youtube.com/vi/VkRYW_qLoME/0.jpg" style="max-width: 100%;"></a></p>
</li>
<li>
<p dir="auto">YouTube video "<a href="https://youtu.be/EP7c0BM2yNo" rel="nofollow">Precompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup</a>"</p>
<p dir="auto"><a href="https://youtu.be/EP7c0BM2yNo" rel="nofollow"><img src="https://camo.githubusercontent.com/182f5fca45b84c4c9674b1811d4846e18104c33906d9eb556e4cb37fff67d3f5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4550376330424d32794e6f2f302e6a7067" alt="Precompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup" data-canonical-src="https://img.youtube.com/vi/EP7c0BM2yNo/0.jpg" style="max-width: 100%;"></a></p>
</li>
</ul>
<p dir="auto">You are welcome to subscribe to our <a href="https://www.youtube.com/channel/UCXVmwF-UCScv2ftsGoMqxhw" rel="nofollow">official YouTube channel, OpenResty</a>.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Synopsis</h1><a id="user-content-synopsis" class="anchor" aria-label="Permalink: Synopsis" href="#synopsis"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # set search paths for pure Lua external libraries (';;' is the default path):
 lua_package_path '/foo/bar/?.lua;/blah/?.lua;;';

 # set search paths for Lua external libraries written in C (can also use ';;'):
 lua_package_cpath '/bar/baz/?.so;/blah/blah/?.so;;';

 server {
     location /lua_content {
         # MIME type determined by default_type:
         default_type 'text/plain';

         content_by_lua_block {
             ngx.say('Hello,world!')
         }
     }

     location /nginx_var {
         # MIME type determined by default_type:
         default_type 'text/plain';

         # try access /nginx_var?a=hello,world
         content_by_lua_block {
             ngx.say(ngx.var.arg_a)
         }
     }

     location = /request_body {
         client_max_body_size 50k;
         client_body_buffer_size 50k;

         content_by_lua_block {
             ngx.req.read_body()  -- explicitly read the req body
             local data = ngx.req.get_body_data()
             if data then
                 ngx.say(&quot;body data:&quot;)
                 ngx.print(data)
                 return
             end

             -- body may get buffered in a temp file:
             local file = ngx.req.get_body_file()
             if file then
                 ngx.say(&quot;body is in file &quot;, file)
             else
                 ngx.say(&quot;no body found&quot;)
             end
         }
     }

     # transparent non-blocking I/O in Lua via subrequests
     # (well, a better way is to use cosockets)
     location = /lua {
         # MIME type determined by default_type:
         default_type 'text/plain';

         content_by_lua_block {
             local res = ngx.location.capture(&quot;/some_other_location&quot;)
             if res then
                 ngx.say(&quot;status: &quot;, res.status)
                 ngx.say(&quot;body:&quot;)
                 ngx.print(res.body)
             end
         }
     }

     location = /foo {
         rewrite_by_lua_block {
             res = ngx.location.capture(&quot;/memc&quot;,
                 { args = { cmd = &quot;incr&quot;, key = ngx.var.uri } }
             )
         }

         proxy_pass http://blah.blah.com;
     }

     location = /mixed {
         rewrite_by_lua_file /path/to/rewrite.lua;
         access_by_lua_file /path/to/access.lua;
         content_by_lua_file /path/to/content.lua;
     }

     # use nginx var in code path
     # CAUTION: contents in nginx var must be carefully filtered,
     # otherwise there'll be great security risk!
     location ~ ^/app/([-_a-zA-Z0-9/]+) {
         set $path $1;
         content_by_lua_file /path/to/lua/app/root/$path.lua;
     }

     location / {
        client_max_body_size 100k;
        client_body_buffer_size 100k;

        access_by_lua_block {
            -- check the client IP address is in our black list
            if ngx.var.remote_addr == &quot;132.5.72.3&quot; then
                ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            -- check if the URI contains bad words
            if ngx.var.uri and
                   string.match(ngx.var.request_body, &quot;evil&quot;)
            then
                return ngx.redirect(&quot;/terms_of_use.html&quot;)
            end

            -- tests passed
        }

        # proxy_pass/fastcgi_pass/etc settings
     }
 }"><pre><span class="pl-c"> # set search paths for pure Lua external libraries (';;' is the default path):</span>
 lua_package_path <span class="pl-s">'/foo/bar/?.lua;/blah/?.lua;;'</span><span class="pl-c1">;</span>

<span class="pl-c"> # set search paths for Lua external libraries written in C (can also use ';;'):</span>
 lua_package_cpath <span class="pl-s">'/bar/baz/?.so;/blah/blah/?.so;;'</span><span class="pl-c1">;</span>

 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">location</span> /lua_content <span class="pl-c1">{</span>
<span class="pl-c">         # MIME type determined by default_type:</span>
         <span class="pl-c1">default_type</span> <span class="pl-s">'text/plain'</span><span class="pl-c1">;</span>

         content_by_lua_block <span class="pl-c1">{</span>
             ngx.say<span class="pl-c1">(</span><span class="pl-s">'Hello,world!'</span><span class="pl-c1">)</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> /nginx_var <span class="pl-c1">{</span>
<span class="pl-c">         # MIME type determined by default_type:</span>
         <span class="pl-c1">default_type</span> <span class="pl-s">'text/plain'</span><span class="pl-c1">;</span>

<span class="pl-c">         # try access /nginx_var?a=hello,world</span>
         content_by_lua_block <span class="pl-c1">{</span>
             ngx.say<span class="pl-c1">(</span>ngx.var.arg_a<span class="pl-c1">)</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> = /request_body <span class="pl-c1">{</span>
         <span class="pl-c1">client_max_body_size</span> <span class="pl-c1">50k</span><span class="pl-c1">;</span>
         <span class="pl-c1">client_body_buffer_size</span> <span class="pl-c1">50k</span><span class="pl-c1">;</span>

         content_by_lua_block <span class="pl-c1">{</span>
             ngx.req.read_body<span class="pl-c1">()</span>  -- explicitly read the req body
             local data = ngx.req.get_body_data<span class="pl-c1">()</span>
             <span class="pl-k">if</span> data then
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"body data:"</span><span class="pl-c1">)</span>
                 ngx.print<span class="pl-c1">(</span>data<span class="pl-c1">)</span>
                 <span class="pl-k">return</span>
             end

             -- body may get buffered in a temp file:
             local file = ngx.req.get_body_file<span class="pl-c1">()</span>
             <span class="pl-k">if</span> file then
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"body is in file "</span>, file<span class="pl-c1">)</span>
             else
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"no body found"</span><span class="pl-c1">)</span>
             end
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

<span class="pl-c">     # transparent non-blocking I/O in Lua via subrequests</span>
<span class="pl-c">     # (well, a better way is to use cosockets)</span>
     <span class="pl-c1">location</span> = /lua <span class="pl-c1">{</span>
<span class="pl-c">         # MIME type determined by default_type:</span>
         <span class="pl-c1">default_type</span> <span class="pl-s">'text/plain'</span><span class="pl-c1">;</span>

         content_by_lua_block <span class="pl-c1">{</span>
             local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/some_other_location"</span><span class="pl-c1">)</span>
             <span class="pl-k">if</span> res then
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"status: "</span>, res.<span class="pl-c1">status</span><span class="pl-c1">)</span>
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"body:"</span><span class="pl-c1">)</span>
                 ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
             end
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> = /foo <span class="pl-c1">{</span>
         rewrite_by_lua_block <span class="pl-c1">{</span>
             res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/memc"</span>,
                 <span class="pl-c1">{</span> args = <span class="pl-c1">{</span> cmd = <span class="pl-s">"incr"</span>, key = ngx.var.uri <span class="pl-c1">}</span> <span class="pl-c1">}</span>
             <span class="pl-c1">)</span>
         <span class="pl-c1">}</span>

         <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://blah.blah.com<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> = /mixed <span class="pl-c1">{</span>
         rewrite_by_lua_file /path/to/<span class="pl-c1">rewrite</span>.lua<span class="pl-c1">;</span>
         access_by_lua_file /path/to/access.lua<span class="pl-c1">;</span>
         content_by_lua_file /path/to/content.lua<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>

<span class="pl-c">     # use nginx var in code path</span>
<span class="pl-c">     # CAUTION: contents in nginx var must be carefully filtered,</span>
<span class="pl-c">     # otherwise there'll be great security risk!</span>
     <span class="pl-c1">location</span> <span class="pl-sr">~</span> ^/app/<span class="pl-c1">(</span>[-_a-zA-Z0-9/]+<span class="pl-c1">)</span> <span class="pl-c1">{</span>
         <span class="pl-c1">set</span> <span class="pl-v">$path</span> <span class="pl-v">$1</span><span class="pl-c1">;</span>
         content_by_lua_file /path/to/lua/app/<span class="pl-c1">root</span>/<span class="pl-v">$path</span>.lua<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
        <span class="pl-c1">client_max_body_size</span> <span class="pl-c1">100k</span><span class="pl-c1">;</span>
        <span class="pl-c1">client_body_buffer_size</span> <span class="pl-c1">100k</span><span class="pl-c1">;</span>

        access_by_lua_block <span class="pl-c1">{</span>
            -- check the client IP address is in our black list
            <span class="pl-k">if</span> ngx.var.remote_addr == <span class="pl-s">"132.5.72.3"</span> then
                ngx.exit<span class="pl-c1">(</span>ngx.HTTP_FORBIDDEN<span class="pl-c1">)</span>
            end

            -- check <span class="pl-k">if</span> the URI contains bad words
            <span class="pl-k">if</span> ngx.var.uri and
                   string.<span class="pl-c1">match</span><span class="pl-c1">(</span>ngx.var.request_body, <span class="pl-s">"evil"</span><span class="pl-c1">)</span>
            then
                <span class="pl-k">return</span> ngx.redirect<span class="pl-c1">(</span><span class="pl-s">"/terms_of_use.html"</span><span class="pl-c1">)</span>
            end

            -- tests passed
        <span class="pl-c1">}</span>

<span class="pl-c">        # proxy_pass/fastcgi_pass/etc settings</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Description</h1><a id="user-content-description" class="anchor" aria-label="Permalink: Description" href="#description"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This module embeds <a href="https://luajit.org/luajit.html" rel="nofollow">LuaJIT 2.0/2.1</a> into Nginx.
It is a core component of <a href="https://openresty.org" rel="nofollow">OpenResty</a>. If you are using
this module, then you are essentially using OpenResty.</p>
<p dir="auto">Since version <code>v0.10.16</code> of this module, the standard Lua
interpreter (also known as "PUC-Rio Lua") is not supported anymore. This
document interchangeably uses the terms "Lua" and "LuaJIT" to refer to the
LuaJIT interpreter.</p>
<p dir="auto">By leveraging Nginx's subrequests, this module allows the integration of the
powerful Lua threads (known as Lua "coroutines") into the Nginx event model.</p>
<p dir="auto">Unlike <a href="https://httpd.apache.org/docs/trunk/mod/mod_lua.html" rel="nofollow">Apache's mod_lua</a>
and <a href="http://redmine.lighttpd.net/wiki/1/Docs:ModMagnet" rel="nofollow">Lighttpd's mod_magnet</a>,
Lua code executed using this module can be <em>100% non-blocking</em> on network
traffic as long as the <a href="#nginx-api-for-lua">Nginx API for Lua</a> provided by
this module is used to handle requests to upstream services such as MySQL,
PostgreSQL, Memcached, Redis, or upstream HTTP web services.</p>
<p dir="auto">At least the following Lua libraries and Nginx modules can be used with this
module:</p>
<ul dir="auto">
<li><a href="https://github.com/openresty/lua-resty-memcached">lua-resty-memcached</a></li>
<li><a href="https://github.com/openresty/lua-resty-mysql">lua-resty-mysql</a></li>
<li><a href="https://github.com/openresty/lua-resty-redis">lua-resty-redis</a></li>
<li><a href="https://github.com/openresty/lua-resty-dns">lua-resty-dns</a></li>
<li><a href="https://github.com/openresty/lua-resty-upload">lua-resty-upload</a></li>
<li><a href="https://github.com/openresty/lua-resty-websocket">lua-resty-websocket</a></li>
<li><a href="https://github.com/openresty/lua-resty-lock">lua-resty-lock</a></li>
<li><a href="https://github.com/cloudflare/lua-resty-logger-socket">lua-resty-logger-socket</a></li>
<li><a href="https://github.com/openresty/lua-resty-lrucache">lua-resty-lrucache</a></li>
<li><a href="https://github.com/openresty/lua-resty-string">lua-resty-string</a></li>
<li><a href="http://github.com/openresty/memc-nginx-module">ngx_memc</a></li>
<li><a href="https://github.com/FRiCKLE/ngx_postgres">ngx_postgres</a></li>
<li><a href="http://github.com/openresty/redis2-nginx-module">ngx_redis2</a></li>
<li><a href="http://wiki.nginx.org/HttpRedisModule" rel="nofollow">ngx_redis</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_proxy</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" rel="nofollow">ngx_fastcgi</a></li>
</ul>
<p dir="auto">Almost any Nginx modules can be used with this ngx_lua module by means of
<a href="#ngxlocationcapture">ngx.location.capture</a> or
<a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> but it is
recommended to use those <code>lua-resty-*</code> libraries instead of creating
subrequests to access the Nginx upstream modules because the former is usually
much more flexible and memory-efficient.</p>
<p dir="auto">The Lua interpreter (also known as "Lua State" or "LuaJIT VM instance") is
shared across all the requests in a single Nginx worker process to minimize
memory use. Request contexts are segregated using lightweight Lua coroutines.</p>
<p dir="auto">Loaded Lua modules persist in the Nginx worker process level resulting in a
small memory footprint in Lua even when under heavy loads.</p>
<p dir="auto">This module is plugged into Nginx's "http" subsystem so it can only speak
downstream communication protocols in the HTTP family (HTTP 0.9/1.0/1.1/2.0,
WebSockets, etc...).  If you want to do generic TCP communications with the
downstream clients, then you should use the
<a href="https://github.com/openresty/stream-lua-nginx-module#readme">ngx_stream_lua</a>
module instead, which offers a compatible Lua API.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Typical Uses</h1><a id="user-content-typical-uses" class="anchor" aria-label="Permalink: Typical Uses" href="#typical-uses"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Just to name a few:</p>
<ul dir="auto">
<li>Mashup'ing and processing outputs of various Nginx upstream outputs (proxy, drizzle, postgres, redis, memcached, etc.) in Lua,</li>
<li>doing arbitrarily complex access control and security checks in Lua before requests actually reach the upstream backends,</li>
<li>manipulating response headers in an arbitrary way (by Lua)</li>
<li>fetching backend information from external storage backends (like redis, memcached, mysql, postgresql) and use that information to choose which upstream backend to access on-the-fly,</li>
<li>coding up arbitrarily complex web applications in a content handler using synchronous but still non-blocking access to the database backends and other storage,</li>
<li>doing very complex URL dispatch in Lua at rewrite phase,</li>
<li>using Lua to implement advanced caching mechanism for Nginx's subrequests and arbitrary locations.</li>
</ul>
<p dir="auto">The possibilities are unlimited as the module allows bringing together various
elements within Nginx as well as exposing the power of the Lua language to the
user. The module provides the full flexibility of scripting while offering
performance levels comparable with native C language programs both in terms of
CPU time as well as memory footprint thanks to LuaJIT 2.x.</p>
<p dir="auto">Other scripting language implementations typically struggle to match this
performance level.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Nginx Compatibility</h1><a id="user-content-nginx-compatibility" class="anchor" aria-label="Permalink: Nginx Compatibility" href="#nginx-compatibility"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The latest version of this module is compatible with the following versions of Nginx:</p>
<ul dir="auto">
<li>1.29.x  (last tested: 1.29.2)</li>
<li>1.27.x  (last tested: 1.27.1)</li>
<li>1.25.x  (last tested: 1.25.1)</li>
<li>1.21.x  (last tested: 1.21.4)</li>
<li>1.19.x  (last tested: 1.19.3)</li>
<li>1.17.x  (last tested: 1.17.8)</li>
<li>1.15.x  (last tested: 1.15.8)</li>
<li>1.14.x</li>
<li>1.13.x  (last tested: 1.13.6)</li>
<li>1.12.x</li>
<li>1.11.x  (last tested: 1.11.2)</li>
<li>1.10.x</li>
<li>1.9.x (last tested: 1.9.15)</li>
<li>1.8.x</li>
<li>1.7.x (last tested: 1.7.10)</li>
<li>1.6.x</li>
</ul>
<p dir="auto">Nginx cores older than 1.6.0 (exclusive) are <em>not</em> supported.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Installation</h1><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">It is <em>highly</em> recommended to use <a href="https://openresty.org" rel="nofollow">OpenResty releases</a>
which bundle Nginx, ngx_lua (this module), LuaJIT, as well as other powerful
companion Nginx modules and Lua libraries.</p>
<p dir="auto">It is discouraged to build this module with Nginx yourself since it is tricky
to set up exactly right.</p>
<p dir="auto">Note that Nginx, LuaJIT, and OpenSSL official releases have various limitations
and long-standing bugs that can cause some of this module's features to be
disabled, not work properly, or run slower. Official OpenResty releases are
recommended because they bundle <a href="https://github.com/openresty/luajit2">OpenResty's optimized LuaJIT 2.1 fork</a> and
<a href="https://github.com/openresty/openresty/tree/master/patches">Nginx/OpenSSL
patches</a>.</p>
<p dir="auto">Alternatively, ngx_lua can be manually compiled into Nginx:</p>
<ol dir="auto">
<li>LuaJIT can be downloaded from the <a href="https://github.com/openresty/luajit2/releases">latest release of OpenResty's LuaJIT fork</a>. The official LuaJIT 2.x releases are also supported, although performance will be significantly lower for reasons elaborated above</li>
<li>Download the latest version of the ngx_devel_kit (NDK) module <a href="https://github.com/simplresty/ngx_devel_kit/tags">HERE</a></li>
<li>Download the latest version of ngx_lua <a href="https://github.com/openresty/lua-nginx-module/tags">HERE</a></li>
<li>Download the latest supported version of Nginx <a href="https://nginx.org/" rel="nofollow">HERE</a> (See <a href="#nginx-compatibility">Nginx Compatibility</a>)</li>
<li>Download the latest version of the lua-resty-core <a href="https://github.com/openresty/lua-resty-core">HERE</a></li>
<li>Download the latest version of the lua-resty-lrucache <a href="https://github.com/openresty/lua-resty-lrucache">HERE</a></li>
</ol>
<p dir="auto">Build the source with this module:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 wget 'https://openresty.org/download/nginx-1.19.3.tar.gz'
 tar -xzvf nginx-1.19.3.tar.gz
 cd nginx-1.19.3/

 # tell nginx's build system where to find LuaJIT 2.0:
 export LUAJIT_LIB=/path/to/luajit/lib
 export LUAJIT_INC=/path/to/luajit/include/luajit-2.0

 # tell nginx's build system where to find LuaJIT 2.1:
 export LUAJIT_LIB=/path/to/luajit/lib
 export LUAJIT_INC=/path/to/luajit/include/luajit-2.1

 # Here we assume Nginx is to be installed under /opt/nginx/.
 ./configure --prefix=/opt/nginx \
         --with-ld-opt=&quot;-Wl,-rpath,/path/to/luajit/lib&quot; \
         --add-module=/path/to/ngx_devel_kit \
         --add-module=/path/to/lua-nginx-module

 # Note that you may also want to add `./configure` options which are used in your
 # current nginx build.
 # You can get usually those options using command nginx -V

 # you can change the parallelism number 2 below to fit the number of spare CPU cores in your
 # machine.
 make -j2
 make install

 # Note that this version of lug-nginx-module not allow to set `lua_load_resty_core off;` any more.
 # So, you have to install `lua-resty-core` and `lua-resty-lrucache` manually as below.

 cd lua-resty-core
 make install PREFIX=/opt/nginx
 cd lua-resty-lrucache
 make install PREFIX=/opt/nginx

 # add necessary `lua_package_path` directive to `nginx.conf`, in the http context

 lua_package_path &quot;/opt/nginx/lib/lua/?.lua;;&quot;;"><pre> wget <span class="pl-s"><span class="pl-pds">'</span>https://openresty.org/download/nginx-1.19.3.tar.gz<span class="pl-pds">'</span></span>
 tar -xzvf nginx-1.19.3.tar.gz
 <span class="pl-c1">cd</span> nginx-1.19.3/

 <span class="pl-c"><span class="pl-c">#</span> tell nginx's build system where to find LuaJIT 2.0:</span>
 <span class="pl-k">export</span> LUAJIT_LIB=/path/to/luajit/lib
 <span class="pl-k">export</span> LUAJIT_INC=/path/to/luajit/include/luajit-2.0

 <span class="pl-c"><span class="pl-c">#</span> tell nginx's build system where to find LuaJIT 2.1:</span>
 <span class="pl-k">export</span> LUAJIT_LIB=/path/to/luajit/lib
 <span class="pl-k">export</span> LUAJIT_INC=/path/to/luajit/include/luajit-2.1

 <span class="pl-c"><span class="pl-c">#</span> Here we assume Nginx is to be installed under /opt/nginx/.</span>
 ./configure --prefix=/opt/nginx \
         --with-ld-opt=<span class="pl-s"><span class="pl-pds">"</span>-Wl,-rpath,/path/to/luajit/lib<span class="pl-pds">"</span></span> \
         --add-module=/path/to/ngx_devel_kit \
         --add-module=/path/to/lua-nginx-module

 <span class="pl-c"><span class="pl-c">#</span> Note that you may also want to add `./configure` options which are used in your</span>
 <span class="pl-c"><span class="pl-c">#</span> current nginx build.</span>
 <span class="pl-c"><span class="pl-c">#</span> You can get usually those options using command nginx -V</span>

 <span class="pl-c"><span class="pl-c">#</span> you can change the parallelism number 2 below to fit the number of spare CPU cores in your</span>
 <span class="pl-c"><span class="pl-c">#</span> machine.</span>
 make -j2
 make install

 <span class="pl-c"><span class="pl-c">#</span> Note that this version of lug-nginx-module not allow to set `lua_load_resty_core off;` any more.</span>
 <span class="pl-c"><span class="pl-c">#</span> So, you have to install `lua-resty-core` and `lua-resty-lrucache` manually as below.</span>

 <span class="pl-c1">cd</span> lua-resty-core
 make install PREFIX=/opt/nginx
 <span class="pl-c1">cd</span> lua-resty-lrucache
 make install PREFIX=/opt/nginx

 <span class="pl-c"><span class="pl-c">#</span> add necessary `lua_package_path` directive to `nginx.conf`, in the http context</span>

 lua_package_path <span class="pl-s"><span class="pl-pds">"</span>/opt/nginx/lib/lua/?.lua;;<span class="pl-pds">"</span></span><span class="pl-k">;</span></pre></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Building as a dynamic module</h2><a id="user-content-building-as-a-dynamic-module" class="anchor" aria-label="Permalink: Building as a dynamic module" href="#building-as-a-dynamic-module"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Starting from NGINX 1.9.11, you can also compile this module as a dynamic module, by using the <code>--add-dynamic-module=PATH</code> option instead of <code>--add-module=PATH</code> on the
<code>./configure</code> command line above. And then you can explicitly load the module in your <code>nginx.conf</code> via the <a href="https://nginx.org/en/docs/ngx_core_module.html#load_module" rel="nofollow">load_module</a>
directive, for example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 load_module /path/to/modules/ndk_http_module.so;  # assuming NDK is built as a dynamic module too
 load_module /path/to/modules/ngx_http_lua_module.so;"><pre> <span class="pl-c1">load_module</span> /path/to/modules/ndk_http_module.so<span class="pl-c1">;</span>  # assuming NDK is built as a dynamic module too
 <span class="pl-c1">load_module</span> /path/to/modules/ngx_http_lua_module.so<span class="pl-c1">;</span></pre></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">C Macro Configurations</h2><a id="user-content-c-macro-configurations" class="anchor" aria-label="Permalink: C Macro Configurations" href="#c-macro-configurations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">While building this module either via OpenResty or with the Nginx core, you can define the following C macros via the C compiler options:</p>
<ul dir="auto">
<li><code>NGX_LUA_USE_ASSERT</code>
When defined, will enable assertions in the ngx_lua C code base. Recommended for debugging or testing builds. It can introduce some (small) runtime overhead when enabled. This macro was first introduced in the <code>v0.9.10</code> release.</li>
<li><code>NGX_LUA_ABORT_AT_PANIC</code>
When the LuaJIT VM panics, ngx_lua will instruct the current nginx worker process to quit gracefully by default. By specifying this C macro, ngx_lua will abort the current nginx worker process (which usually results in a core dump file) immediately. This option is useful for debugging VM panics. This option was first introduced in the <code>v0.9.8</code> release.</li>
</ul>
<p dir="auto">To enable one or more of these macros, just pass extra C compiler options to the <code>./configure</code> script of either Nginx or OpenResty. For instance,</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="./configure --with-cc-opt=&quot;-DNGX_LUA_USE_ASSERT -DNGX_LUA_ABORT_AT_PANIC&quot;"><pre class="notranslate"><code>./configure --with-cc-opt="-DNGX_LUA_USE_ASSERT -DNGX_LUA_ABORT_AT_PANIC"
</code></pre></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Community</h1><a id="user-content-community" class="anchor" aria-label="Permalink: Community" href="#community"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">English Mailing List</h2><a id="user-content-english-mailing-list" class="anchor" aria-label="Permalink: English Mailing List" href="#english-mailing-list"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="https://groups.google.com/group/openresty-en" rel="nofollow">openresty-en</a> mailing list is for English speakers.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Chinese Mailing List</h2><a id="user-content-chinese-mailing-list" class="anchor" aria-label="Permalink: Chinese Mailing List" href="#chinese-mailing-list"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="https://groups.google.com/group/openresty" rel="nofollow">openresty</a> mailing list is for Chinese speakers.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Code Repository</h1><a id="user-content-code-repository" class="anchor" aria-label="Permalink: Code Repository" href="#code-repository"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The code repository of this project is hosted on GitHub at
<a href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module</a>.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Bugs and Patches</h1><a id="user-content-bugs-and-patches" class="anchor" aria-label="Permalink: Bugs and Patches" href="#bugs-and-patches"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Please submit bug reports, wishlists, or patches by</p>
<ol dir="auto">
<li>creating a ticket on the <a href="https://github.com/openresty/lua-nginx-module/issues">GitHub Issue Tracker</a>,</li>
<li>or posting to the <a href="#community">OpenResty community</a>.</li>
</ol>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">LuaJIT bytecode support</h1><a id="user-content-luajit-bytecode-support" class="anchor" aria-label="Permalink: LuaJIT bytecode support" href="#luajit-bytecode-support"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Watch YouTube video "<a href="https://youtu.be/VkRYW_qLoME" rel="nofollow">Measure Execution Time of Lua Code Correctly in OpenResty</a>"</p>
<p dir="auto"><a href="https://youtu.be/EP7c0BM2yNo" rel="nofollow"><img src="https://camo.githubusercontent.com/182f5fca45b84c4c9674b1811d4846e18104c33906d9eb556e4cb37fff67d3f5/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f4550376330424d32794e6f2f302e6a7067" alt="Precompile Lua Modules into LuaJIT Bytecode to Speedup OpenResty Startup" data-canonical-src="https://img.youtube.com/vi/EP7c0BM2yNo/0.jpg" style="max-width: 100%;"></a></p>
<p dir="auto">As from the <code>v0.5.0rc32</code> release, all <code>*_by_lua_file</code> configure directives (such as <a href="#content_by_lua_file">content_by_lua_file</a>) support loading LuaJIT 2.0/2.1 raw bytecode files directly:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 /path/to/luajit/bin/luajit -b /path/to/input_file.lua /path/to/output_file.ljbc"><pre> /path/to/luajit/bin/luajit -b /path/to/input_file.lua /path/to/output_file.ljbc</pre></div>
<p dir="auto">The <code>-bg</code> option can be used to include debug information in the LuaJIT bytecode file:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 /path/to/luajit/bin/luajit -bg /path/to/input_file.lua /path/to/output_file.ljbc"><pre> /path/to/luajit/bin/luajit -bg /path/to/input_file.lua /path/to/output_file.ljbc</pre></div>
<p dir="auto">Please refer to the official LuaJIT documentation on the <code>-b</code> option for more details:</p>
<p dir="auto"><a href="https://luajit.org/running.html#opt_b" rel="nofollow">https://luajit.org/running.html#opt_b</a></p>
<p dir="auto">Note that the bytecode files generated by LuaJIT 2.1 is <em>not</em> compatible with
LuaJIT 2.0, and vice versa. The support for LuaJIT 2.1 bytecode was first added
in ngx_lua v0.9.3.</p>
<p dir="auto">Attempts to load standard Lua 5.1 bytecode files into ngx_lua instances linked
to LuaJIT 2.0/2.1 (or vice versa) will result in an Nginx error message such as
the one below:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[error] 13909#0: *1 failed to load Lua inlined code: bad byte-code header in /path/to/test_file.luac"><pre class="notranslate"><code>[error] 13909#0: *1 failed to load Lua inlined code: bad byte-code header in /path/to/test_file.luac
</code></pre></div>
<p dir="auto">Loading bytecode files via the Lua primitives like <code>require</code> and
<code>dofile</code> should always work as expected.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">System Environment Variable Support</h1><a id="user-content-system-environment-variable-support" class="anchor" aria-label="Permalink: System Environment Variable Support" href="#system-environment-variable-support"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you want to access the system environment variable, say, <code>foo</code>, in Lua via the standard Lua API <a href="https://www.lua.org/manual/5.1/manual.html#pdf-os.getenv" rel="nofollow">os.getenv</a>, then you should also list this environment variable name in your <code>nginx.conf</code> file via the <a href="https://nginx.org/en/docs/ngx_core_module.html#env" rel="nofollow">env directive</a>. For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 env foo;"><pre> <span class="pl-c1">env</span> foo<span class="pl-c1">;</span></pre></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">HTTP 1.0 support</h1><a id="user-content-http-10-support" class="anchor" aria-label="Permalink: HTTP 1.0 support" href="#http-10-support"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The HTTP 1.0 protocol does not support chunked output and requires an explicit <code>Content-Length</code> header when the response body is not empty in order to support the HTTP 1.0 keep-alive.
So when a HTTP 1.0 request is made and the <a href="#lua_http10_buffering">lua_http10_buffering</a> directive is turned <code>on</code>, ngx_lua will buffer the
output of <a href="#ngxsay">ngx.say</a> and <a href="#ngxprint">ngx.print</a> calls and also postpone sending response headers until all the response body output is received.
At that time ngx_lua can calculate the total length of the body and construct a proper <code>Content-Length</code> header to return to the HTTP 1.0 client.
If the <code>Content-Length</code> response header is set in the running Lua code, however, this buffering will be disabled even if the <a href="#lua_http10_buffering">lua_http10_buffering</a> directive is turned <code>on</code>.</p>
<p dir="auto">For large streaming output responses, it is important to disable the <a href="#lua_http10_buffering">lua_http10_buffering</a> directive to minimise memory usage.</p>
<p dir="auto">Note that common HTTP benchmark tools such as <code>ab</code> and <code>http_load</code> issue HTTP 1.0 requests by default.
To force <code>curl</code> to send HTTP 1.0 requests, use the <code>-0</code> option.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Statically Linking Pure Lua Modules</h1><a id="user-content-statically-linking-pure-lua-modules" class="anchor" aria-label="Permalink: Statically Linking Pure Lua Modules" href="#statically-linking-pure-lua-modules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">With LuaJIT 2.x, it is possible to statically link the bytecode of pure Lua
modules into the Nginx executable.</p>
<p dir="auto">You can use the <code>luajit</code> executable to compile <code>.lua</code> Lua
module files to <code>.o</code> object files containing the exported bytecode
data, and then link the <code>.o</code> files directly in your Nginx build.</p>
<p dir="auto">Below is a trivial example to demonstrate this. Consider that we have the following <code>.lua</code> file named <code>foo.lua</code>:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- foo.lua
 local _M = {}

 function _M.go()
     print(&quot;Hello from foo&quot;)
 end

 return _M"><pre> <span class="pl-c"><span class="pl-c">--</span> foo.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">_M</span> <span class="pl-k">=</span> {}

 <span class="pl-k">function</span> <span class="pl-en">_M</span>.<span class="pl-en">go</span>()
     <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Hello from foo<span class="pl-pds">"</span></span>)
 <span class="pl-k">end</span>

 <span class="pl-k">return</span> <span class="pl-smi">_M</span></pre></div>
<p dir="auto">And then we compile this <code>.lua</code> file to <code>foo.o</code> file:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 /path/to/luajit/bin/luajit -bg foo.lua foo.o"><pre> /path/to/luajit/bin/luajit -bg foo.lua foo.o</pre></div>
<p dir="auto">What matters here is the name of the <code>.lua</code> file, which determines how you use this module later on the Lua land. The file name <code>foo.o</code> does not matter at all except the <code>.o</code> file extension (which tells <code>luajit</code> what output format is used). If you want to strip the Lua debug information from the resulting bytecode, you can just specify the <code>-b</code> option above instead of <code>-bg</code>.</p>
<p dir="auto">Then when building Nginx or OpenResty, pass the <code>--with-ld-opt="foo.o"</code> option to the <code>./configure</code> script:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ./configure --with-ld-opt=&quot;/path/to/foo.o&quot; ..."><pre> ./configure --with-ld-opt=<span class="pl-s"><span class="pl-pds">"</span>/path/to/foo.o<span class="pl-pds">"</span></span> ...</pre></div>
<p dir="auto">Finally, you can just do the following in any Lua code run by ngx_lua:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local foo = require &quot;foo&quot;
 foo.go()"><pre> <span class="pl-k">local</span> <span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>foo<span class="pl-pds">"</span></span>
 <span class="pl-smi">foo</span>.<span class="pl-c1">go</span>()</pre></div>
<p dir="auto">And this piece of code no longer depends on the external <code>foo.lua</code> file any more because it has already been compiled into the <code>nginx</code> executable.</p>
<p dir="auto">If you want to use dot in the Lua module name when calling <code>require</code>, as in</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local foo = require &quot;resty.foo&quot;"><pre> <span class="pl-k">local</span> <span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.foo<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">then you need to rename the <code>foo.lua</code> file to <code>resty_foo.lua</code> before compiling it down to a <code>.o</code> file with the <code>luajit</code> command-line utility.</p>
<p dir="auto">It is important to use exactly the same version of LuaJIT when compiling <code>.lua</code> files to <code>.o</code> files as building nginx + ngx_lua. This is because the LuaJIT bytecode format may be incompatible between different LuaJIT versions. When the bytecode format is incompatible, you will see a Lua runtime error saying that the Lua module is not found.</p>
<p dir="auto">When you have multiple <code>.lua</code> files to compile and link, then just specify their <code>.o</code> files at the same time in the value of the <code>--with-ld-opt</code> option. For instance,</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ./configure --with-ld-opt=&quot;/path/to/foo.o /path/to/bar.o&quot; ..."><pre> ./configure --with-ld-opt=<span class="pl-s"><span class="pl-pds">"</span>/path/to/foo.o /path/to/bar.o<span class="pl-pds">"</span></span> ...</pre></div>
<p dir="auto">If you have too many <code>.o</code> files, then it might not be feasible to name them all in a single command. In this case, you can build a static library (or archive) for your <code>.o</code> files, as in</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ar rcus libmyluafiles.a *.o"><pre> ar rcus libmyluafiles.a <span class="pl-k">*</span>.o</pre></div>
<p dir="auto">then you can link the <code>myluafiles</code> archive as a whole to your nginx executable:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ./configure \
     --with-ld-opt=&quot;-L/path/to/lib -Wl,--whole-archive -lmyluafiles -Wl,--no-whole-archive&quot;"><pre> ./configure \
     --with-ld-opt=<span class="pl-s"><span class="pl-pds">"</span>-L/path/to/lib -Wl,--whole-archive -lmyluafiles -Wl,--no-whole-archive<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">where <code>/path/to/lib</code> is the path of the directory containing the <code>libmyluafiles.a</code> file. It should be noted that the linker option <code>--whole-archive</code> is required here because otherwise our archive will be skipped because no symbols in our archive are mentioned in the main parts of the nginx executable.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Data Sharing within an Nginx Worker</h1><a id="user-content-data-sharing-within-an-nginx-worker" class="anchor" aria-label="Permalink: Data Sharing within an Nginx Worker" href="#data-sharing-within-an-nginx-worker"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To globally share data among all the requests handled by the same Nginx worker
process, encapsulate the shared data into a Lua module, use the Lua
<code>require</code> builtin to import the module, and then manipulate the
shared data in Lua. This works because required Lua modules are loaded only
once and all coroutines will share the same copy of the module (both its code
and data).</p>
<p dir="auto">Note that the use of global Lua variables is <em>strongly discouraged</em>, as it may
lead to unexpected race conditions between concurrent requests.</p>
<p dir="auto">Here is a small example on sharing data within an Nginx worker via a Lua module:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- mydata.lua
 local _M = {}

 local data = {
     dog = 3,
     cat = 4,
     pig = 5,
 }

 function _M.get_age(name)
     return data[name]
 end

 return _M"><pre> <span class="pl-c"><span class="pl-c">--</span> mydata.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">_M</span> <span class="pl-k">=</span> {}

 <span class="pl-k">local</span> <span class="pl-smi">data</span> <span class="pl-k">=</span> {
     <span class="pl-smi">dog</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>,
     <span class="pl-smi">cat</span> <span class="pl-k">=</span> <span class="pl-c1">4</span>,
     <span class="pl-smi">pig</span> <span class="pl-k">=</span> <span class="pl-c1">5</span>,
 }

 <span class="pl-k">function</span> <span class="pl-en">_M</span>.<span class="pl-en">get_age</span>(<span class="pl-smi">name</span>)
     <span class="pl-k">return</span> <span class="pl-smi">data</span>[<span class="pl-smi">name</span>]
 <span class="pl-k">end</span>

 <span class="pl-k">return</span> <span class="pl-smi">_M</span></pre></div>
<p dir="auto">and then accessing it from <code>nginx.conf</code>:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /lua {
     content_by_lua_block {
         local mydata = require &quot;mydata&quot;
         ngx.say(mydata.get_age(&quot;dog&quot;))
     }
 }"><pre> <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local mydata = require <span class="pl-s">"mydata"</span>
         ngx.say<span class="pl-c1">(</span>mydata.get_age<span class="pl-c1">(</span><span class="pl-s">"dog"</span><span class="pl-c1">))</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">The <code>mydata</code> module in this example will only be loaded and run on the first request to the location <code>/lua</code>,
and all subsequent requests to the same Nginx worker process will use the reloaded instance of the
module as well as the same copy of the data in it, until a <code>HUP</code> signal is sent to the Nginx master process to force a reload.
This data sharing technique is essential for high performance Lua applications based on this module.</p>
<p dir="auto">Note that this data sharing is on a <em>per-worker</em> basis and not on a <em>per-server</em> basis. That is, when there are multiple Nginx worker processes under an Nginx master, data sharing cannot cross the process boundary between these workers.</p>
<p dir="auto">It is usually recommended to share read-only data this way. You can also share changeable data among all the concurrent requests of each Nginx worker process as
long as there is <em>no</em> nonblocking I/O operations (including <a href="#ngxsleep">ngx.sleep</a>)
in the middle of your calculations. As long as you do not give the
control back to the Nginx event loop and ngx_lua's light thread
scheduler (even implicitly), there can never be any race conditions in
between. For this reason, always be very careful when you want to share changeable data on the
worker level. Buggy optimizations can easily lead to hard-to-debug
race conditions under load.</p>
<p dir="auto">If server-wide data sharing is required, then use one or more of the following approaches:</p>
<ol dir="auto">
<li>Use the <a href="#ngxshareddict">ngx.shared.DICT</a> API provided by this module.</li>
<li>Use only a single Nginx worker and a single server (this is however not recommended when there is a multi core CPU or multiple CPUs in a single machine).</li>
<li>Use data storage mechanisms such as <code>memcached</code>, <code>redis</code>, <code>MySQL</code> or <code>PostgreSQL</code>. <a href="https://openresty.org" rel="nofollow">The OpenResty official releases</a> come with a set of companion Nginx modules and Lua libraries that provide interfaces with these data storage mechanisms.</li>
</ol>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Known Issues</h1><a id="user-content-known-issues" class="anchor" aria-label="Permalink: Known Issues" href="#known-issues"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">TCP socket connect operation issues</h2><a id="user-content-tcp-socket-connect-operation-issues" class="anchor" aria-label="Permalink: TCP socket connect operation issues" href="#tcp-socket-connect-operation-issues"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="#tcpsockconnect">tcpsock:connect</a> method may indicate <code>success</code> despite connection failures such as with <code>Connection Refused</code> errors.</p>
<p dir="auto">However, later attempts to manipulate the cosocket object will fail and return the actual error status message generated by the failed connect operation.</p>
<p dir="auto">This issue is due to limitations in the Nginx event model and only appears to affect Mac OS X.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Lua Coroutine Yielding/Resuming</h2><a id="user-content-lua-coroutine-yieldingresuming" class="anchor" aria-label="Permalink: Lua Coroutine Yielding/Resuming" href="#lua-coroutine-yieldingresuming"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Because Lua's <code>dofile</code> and <code>require</code> builtins are currently implemented as C functions in LuaJIT 2.0/2.1, if the Lua file being loaded by <code>dofile</code> or <code>require</code> invokes <a href="#ngxlocationcapture">ngx.location.capture*</a>, <a href="#ngxexec">ngx.exec</a>, <a href="#ngxexit">ngx.exit</a>, or other API functions requiring yielding in the <em>top-level</em> scope of the Lua file, then the Lua error "attempt to yield across C-call boundary" will be raised. To avoid this, put these calls requiring yielding into your own Lua functions in the Lua file instead of the top-level scope of the file.</li>
</ul>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Lua Variable Scope</h2><a id="user-content-lua-variable-scope" class="anchor" aria-label="Permalink: Lua Variable Scope" href="#lua-variable-scope"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Care must be taken when importing modules, and this form should be used:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local xxx = require('xxx')"><pre> <span class="pl-k">local</span> <span class="pl-smi">xxx</span> <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">instead of the old deprecated form:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require('xxx')"><pre> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">Here is the reason: by design, the global environment has exactly the same lifetime as the Nginx request handler associated with it. Each request handler has its own set of Lua global variables and that is the idea of request isolation. The Lua module is actually loaded by the first Nginx request handler and is cached by the <code>require()</code> built-in in the <code>package.loaded</code> table for later reference, and the <code>module()</code> builtin used by some Lua modules has the side effect of setting a global variable to the loaded module table. But this global variable will be cleared at the end of the request handler,  and every subsequent request handler all has its own (clean) global environment. So one will get Lua exception for accessing the <code>nil</code> value.</p>
<p dir="auto">The use of Lua global variables is a generally inadvisable in the ngx_lua context as:</p>
<ol dir="auto">
<li>the misuse of Lua globals has detrimental side effects on concurrent requests when such variables should instead be local in scope,</li>
<li>Lua global variables require Lua table look-ups in the global environment which is computationally expensive, and</li>
<li>some Lua global variable references may include typing errors which make such difficult to debug.</li>
</ol>
<p dir="auto">It is therefore <em>highly</em> recommended to always declare such within an appropriate local scope instead.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- Avoid
 foo = 123
 -- Recommended
 local foo = 123

 -- Avoid
 function foo() return 123 end
 -- Recommended
 local function foo() return 123 end"><pre> <span class="pl-c"><span class="pl-c">--</span> Avoid</span>
 <span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">123</span>
 <span class="pl-c"><span class="pl-c">--</span> Recommended</span>
 <span class="pl-k">local</span> <span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">123</span>

 <span class="pl-c"><span class="pl-c">--</span> Avoid</span>
 <span class="pl-k">function</span> <span class="pl-en">foo</span>() <span class="pl-k">return</span> <span class="pl-c1">123</span> <span class="pl-k">end</span>
 <span class="pl-c"><span class="pl-c">--</span> Recommended</span>
 <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">foo</span>() <span class="pl-k">return</span> <span class="pl-c1">123</span> <span class="pl-k">end</span></pre></div>
<p dir="auto">To find all instances of Lua global variables in your Lua code, run the <a href="https://github.com/openresty/nginx-devel-utils/blob/master/lua-releng">lua-releng tool</a> across all <code>.lua</code> source files:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ lua-releng
Checking use of Lua global variables in file lib/foo/bar.lua ...
        1       [1489]  SETGLOBAL       7 -1    ; contains
        55      [1506]  GETGLOBAL       7 -3    ; setvar
        3       [1545]  GETGLOBAL       3 -4    ; varexpand"><pre class="notranslate"><code>$ lua-releng
Checking use of Lua global variables in file lib/foo/bar.lua ...
        1       [1489]  SETGLOBAL       7 -1    ; contains
        55      [1506]  GETGLOBAL       7 -3    ; setvar
        3       [1545]  GETGLOBAL       3 -4    ; varexpand
</code></pre></div>
<p dir="auto">The output says that the line 1489 of file <code>lib/foo/bar.lua</code> writes to a global variable named <code>contains</code>, the line 1506 reads from the global variable <code>setvar</code>, and line 1545 reads the global <code>varexpand</code>.</p>
<p dir="auto">This tool will guarantee that local variables in the Lua module functions are all declared with the <code>local</code> keyword, otherwise a runtime exception will be thrown. It prevents undesirable race conditions while accessing such variables. See <a href="#data-sharing-within-an-nginx-worker">Data Sharing within an Nginx Worker</a> for the reasons behind this.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Locations Configured by Subrequest Directives of Other Modules</h2><a id="user-content-locations-configured-by-subrequest-directives-of-other-modules" class="anchor" aria-label="Permalink: Locations Configured by Subrequest Directives of Other Modules" href="#locations-configured-by-subrequest-directives-of-other-modules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> directives cannot capture locations that include the <a href="http://nginx.org/en/docs/http/ngx_http_addition_module.html#add_before_body" rel="nofollow">add_before_body</a>, <a href="http://nginx.org/en/docs/http/ngx_http_addition_module.html#add_after_body" rel="nofollow">add_after_body</a>, <a href="https://nginx.org/en/docs/http/ngx_http_auth_request_module.html#auth_request" rel="nofollow">auth_request</a>, <a href="http://github.com/openresty/echo-nginx-module#echo_location">echo_location</a>, <a href="http://github.com/openresty/echo-nginx-module#echo_location_async">echo_location_async</a>, <a href="http://github.com/openresty/echo-nginx-module#echo_subrequest">echo_subrequest</a>, or <a href="http://github.com/openresty/echo-nginx-module#echo_subrequest_async">echo_subrequest_async</a> directives.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     content_by_lua_block {
         res = ngx.location.capture(&quot;/bar&quot;)
     }
 }
 location /bar {
     echo_location /blah;
 }
 location /blah {
     echo &quot;Success!&quot;;
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/bar"</span><span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>
 <span class="pl-c1">location</span> /bar <span class="pl-c1">{</span>
     echo_location /blah<span class="pl-c1">;</span>
 <span class="pl-c1">}</span>
 <span class="pl-c1">location</span> /blah <span class="pl-c1">{</span>
     echo <span class="pl-s">"Success!"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 $ curl -i http://example.com/foo"><pre> $ curl -i <span class="pl-c1">http</span>://example.com/foo</pre></div>
<p dir="auto">will not work as expected.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Cosockets Not Available Everywhere</h2><a id="user-content-cosockets-not-available-everywhere" class="anchor" aria-label="Permalink: Cosockets Not Available Everywhere" href="#cosockets-not-available-everywhere"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Due to internal limitations in the Nginx core, the cosocket API is disabled in the following contexts: <a href="#set_by_lua">set_by_lua*</a>, <a href="#log_by_lua">log_by_lua*</a>, <a href="#header_filter_by_lua">header_filter_by_lua*</a>, and <a href="#body_filter_by_lua">body_filter_by_lua</a>.</p>
<p dir="auto">The cosockets are currently also disabled in the <a href="#init_by_lua">init_by_lua*</a> and <a href="#init_worker_by_lua">init_worker_by_lua*</a> directive contexts but we may add support for these contexts in the future because there is no limitation in the Nginx core (or the limitation might be worked around).</p>
<p dir="auto">There exists a workaround, however, when the original context does <em>not</em> need to wait for the cosocket results. That is, creating a zero-delay timer via the <a href="#ngxtimerat">ngx.timer.at</a> API and do the cosocket results in the timer handler, which runs asynchronously as to the original context creating the timer.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Special Escaping Sequences</h2><a id="user-content-special-escaping-sequences" class="anchor" aria-label="Permalink: Special Escaping Sequences" href="#special-escaping-sequences"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>NOTE</strong> Following the <code>v0.9.17</code> release, this pitfall can be avoided by using the <code>*_by_lua_block {}</code> configuration directives.</p>
<p dir="auto">PCRE sequences such as <code>\d</code>, <code>\s</code>, or <code>\w</code>, require special attention because in string literals, the backslash character, <code>\</code>, is stripped out by both the Lua language parser and by the Nginx config file parser before processing if not within a <code>*_by_lua_block {}</code> directive. So the following snippet will not work as expected:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # nginx.conf
 ? location /test {
 ?     content_by_lua '
 ?         local regex = &quot;\d+&quot;  -- THIS IS WRONG OUTSIDE OF A *_by_lua_block DIRECTIVE
 ?         local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
 ?         if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
 ?     ';
 ? }
 # evaluates to &quot;not matched!&quot;"><pre><span class="pl-c"> # nginx.conf</span>
 ? <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
 ?     content_by_lua '
 ?         local regex = <span class="pl-s">"<span class="pl-cce">\d</span>+"</span>  -- THIS IS WRONG OUTSIDE OF A *_by_lua_block DIRECTIVE
 ?         local m = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 1234"</span>, regex<span class="pl-c1">)</span>
 ?         <span class="pl-k">if</span> m then ngx.say<span class="pl-c1">(</span>m[0]<span class="pl-c1">)</span> else ngx.say<span class="pl-c1">(</span><span class="pl-s">"not matched!"</span><span class="pl-c1">)</span> end
 ?     '<span class="pl-c1">;</span>
 ? <span class="pl-c1">}</span>
<span class="pl-c"> # evaluates to "not matched!"</span></pre></div>
<p dir="auto">To avoid this, <em>double</em> escape the backslash:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # nginx.conf
 location /test {
     content_by_lua '
         local regex = &quot;\\\\d+&quot;
         local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
         if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
     ';
 }
 # evaluates to &quot;1234&quot;"><pre><span class="pl-c"> # nginx.conf</span>
 <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua '
         local regex = <span class="pl-s">"<span class="pl-cce">\\\\</span>d+"</span>
         local m = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 1234"</span>, regex<span class="pl-c1">)</span>
         <span class="pl-k">if</span> m then ngx.say<span class="pl-c1">(</span>m[0]<span class="pl-c1">)</span> else ngx.say<span class="pl-c1">(</span><span class="pl-s">"not matched!"</span><span class="pl-c1">)</span> end
     '<span class="pl-c1">;</span>
 <span class="pl-c1">}</span>
<span class="pl-c"> # evaluates to "1234"</span></pre></div>
<p dir="auto">Here, <code>\\\\d+</code> is stripped down to <code>\\d+</code> by the Nginx config file parser and this is further stripped down to <code>\d+</code> by the Lua language parser before running.</p>
<p dir="auto">Alternatively, the regex pattern can be presented as a long-bracketed Lua string literal by encasing it in "long brackets", <code>[[...]]</code>, in which case backslashes have to only be escaped once for the Nginx config file parser.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # nginx.conf
 location /test {
     content_by_lua '
         local regex = [[\\d+]]
         local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
         if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
     ';
 }
 # evaluates to &quot;1234&quot;"><pre><span class="pl-c"> # nginx.conf</span>
 <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua '
         local regex = [[\\d+]]
         local m = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 1234"</span>, regex<span class="pl-c1">)</span>
         <span class="pl-k">if</span> m then ngx.say<span class="pl-c1">(</span>m[0]<span class="pl-c1">)</span> else ngx.say<span class="pl-c1">(</span><span class="pl-s">"not matched!"</span><span class="pl-c1">)</span> end
     '<span class="pl-c1">;</span>
 <span class="pl-c1">}</span>
<span class="pl-c"> # evaluates to "1234"</span></pre></div>
<p dir="auto">Here, <code>[[\\d+]]</code> is stripped down to <code>[[\d+]]</code> by the Nginx config file parser and this is processed correctly.</p>
<p dir="auto">Note that a longer from of the long bracket, <code>[=[...]=]</code>, may be required if the regex pattern contains <code>[...]</code> sequences.
The <code>[=[...]=]</code> form may be used as the default form if desired.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # nginx.conf
 location /test {
     content_by_lua '
         local regex = [=[[0-9]+]=]
         local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
         if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
     ';
 }
 # evaluates to &quot;1234&quot;"><pre><span class="pl-c"> # nginx.conf</span>
 <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua '
         local regex = [=[[0-9]+]=]
         local m = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 1234"</span>, regex<span class="pl-c1">)</span>
         <span class="pl-k">if</span> m then ngx.say<span class="pl-c1">(</span>m[0]<span class="pl-c1">)</span> else ngx.say<span class="pl-c1">(</span><span class="pl-s">"not matched!"</span><span class="pl-c1">)</span> end
     '<span class="pl-c1">;</span>
 <span class="pl-c1">}</span>
<span class="pl-c"> # evaluates to "1234"</span></pre></div>
<p dir="auto">An alternative approach to escaping PCRE sequences is to ensure that Lua code is placed in external script files and executed using the various <code>*_by_lua_file</code> directives.
With this approach, the backslashes are only stripped by the Lua language parser and therefore only need to be escaped once each.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- test.lua
 local regex = &quot;\\d+&quot;
 local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
 if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
 -- evaluates to &quot;1234&quot;"><pre> <span class="pl-c"><span class="pl-c">--</span> test.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">regex</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>d+<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">m</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-smi">regex</span>)
 <span class="pl-k">if</span> <span class="pl-smi">m</span> <span class="pl-k">then</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">m</span>[<span class="pl-c1">0</span>]) <span class="pl-k">else</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>not matched!<span class="pl-pds">"</span></span>) <span class="pl-k">end</span>
 <span class="pl-c"><span class="pl-c">--</span> evaluates to "1234"</span></pre></div>
<p dir="auto">Within external script files, PCRE sequences presented as long-bracketed Lua string literals do not require modification.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- test.lua
 local regex = [[\d+]]
 local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
 if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
 -- evaluates to &quot;1234&quot;"><pre> <span class="pl-c"><span class="pl-c">--</span> test.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">regex</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">[[</span>\d+<span class="pl-pds">]]</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">m</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-smi">regex</span>)
 <span class="pl-k">if</span> <span class="pl-smi">m</span> <span class="pl-k">then</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">m</span>[<span class="pl-c1">0</span>]) <span class="pl-k">else</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>not matched!<span class="pl-pds">"</span></span>) <span class="pl-k">end</span>
 <span class="pl-c"><span class="pl-c">--</span> evaluates to "1234"</span></pre></div>
<p dir="auto">As noted earlier, PCRE sequences presented within <code>*_by_lua_block {}</code> directives (available following the <code>v0.9.17</code> release) do not require modification.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # nginx.conf
 location /test {
     content_by_lua_block {
         local regex = [[\d+]]
         local m = ngx.re.match(&quot;hello, 1234&quot;, regex)
         if m then ngx.say(m[0]) else ngx.say(&quot;not matched!&quot;) end
     }
 }
 # evaluates to &quot;1234&quot;"><pre><span class="pl-c"> # nginx.conf</span>
 <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local regex = [[\d+]]
         local m = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 1234"</span>, regex<span class="pl-c1">)</span>
         <span class="pl-k">if</span> m then ngx.say<span class="pl-c1">(</span>m[0]<span class="pl-c1">)</span> else ngx.say<span class="pl-c1">(</span><span class="pl-s">"not matched!"</span><span class="pl-c1">)</span> end
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>
<span class="pl-c"> # evaluates to "1234"</span></pre></div>
<p dir="auto"><strong>NOTE</strong> You are recommended to use <code>by_lua_file</code> when the Lua code is very long.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Mixing with SSI Not Supported</h2><a id="user-content-mixing-with-ssi-not-supported" class="anchor" aria-label="Permalink: Mixing with SSI Not Supported" href="#mixing-with-ssi-not-supported"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Mixing SSI with ngx_lua in the same Nginx request is not supported at all. Just use ngx_lua exclusively. Everything you can do with SSI can be done atop ngx_lua anyway and it can be more efficient when using ngx_lua.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">SPDY Mode Not Fully Supported</h2><a id="user-content-spdy-mode-not-fully-supported" class="anchor" aria-label="Permalink: SPDY Mode Not Fully Supported" href="#spdy-mode-not-fully-supported"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Certain Lua APIs provided by ngx_lua do not work in Nginx's SPDY mode yet: <a href="#ngxlocationcapture">ngx.location.capture</a>, <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>, and <a href="#ngxreqsocket">ngx.req.socket</a>.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Missing data on short circuited requests</h2><a id="user-content-missing-data-on-short-circuited-requests" class="anchor" aria-label="Permalink: Missing data on short circuited requests" href="#missing-data-on-short-circuited-requests"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Nginx may terminate a request early with (at least):</p>
<ul dir="auto">
<li>400 (Bad Request)</li>
<li>405 (Not Allowed)</li>
<li>408 (Request Timeout)</li>
<li>413 (Request Entity Too Large)</li>
<li>414 (Request URI Too Large)</li>
<li>494 (Request Headers Too Large)</li>
<li>499 (Client Closed Request)</li>
<li>500 (Internal Server Error)</li>
<li>501 (Not Implemented)</li>
</ul>
<p dir="auto">This means that phases that normally run are skipped, such as the rewrite or
access phase. This also means that later phases that are run regardless, e.g.
<a href="#log_by_lua">log_by_lua</a>, will not have access to information that is normally set in those
phases.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">TODO</h1><a id="user-content-todo" class="anchor" aria-label="Permalink: TODO" href="#todo"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>cosocket: implement LuaSocket's unconnected UDP API.</li>
<li>cosocket: add support in the context of <a href="#init_by_lua">init_by_lua*</a>.</li>
<li>cosocket: review and merge aviramc's <a href="https://github.com/openresty/lua-nginx-module/pull/290" data-hovercard-type="pull_request" data-hovercard-url="/openresty/lua-nginx-module/pull/290/hovercard">patch</a> for adding the <code>bsdrecv</code> method.</li>
<li>cosocket: add configure options for different strategies of handling the cosocket connection exceeding in the pools.</li>
<li>use <code>ngx_hash_t</code> to optimize the built-in header look-up process for <a href="#ngxreqset_header">ngx.req.set_header</a>, and etc.</li>
<li>add <code>ignore_resp_headers</code>, <code>ignore_resp_body</code>, and <code>ignore_resp</code> options to <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> methods, to allow micro performance tuning on the user side.</li>
<li>add automatic Lua code time slicing support by yielding and resuming the Lua VM actively via Lua's debug hooks.</li>
<li>add <code>stat</code> mode similar to <a href="https://httpd.apache.org/docs/trunk/mod/mod_lua.html" rel="nofollow">mod_lua</a>.</li>
</ul>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Changes</h1><a id="user-content-changes" class="anchor" aria-label="Permalink: Changes" href="#changes"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The changes made in every release of this module are listed in the change logs of the OpenResty bundle:</p>
<p dir="auto"><a href="https://openresty.org/#Changes" rel="nofollow">https://openresty.org/#Changes</a></p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Build And Test</h1><a id="user-content-build-and-test" class="anchor" aria-label="Permalink: Build And Test" href="#build-and-test"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This module uses <code>.travis.yml</code> as the CI configuration.
You can always check <code>.travis.yml</code> for the latest CI configuration.</p>
<p dir="auto">For developers, you need to run tests locally. You can use <code>util/run-ci.sh</code>
to easily set up the environment and execute the test suite.</p>
<p dir="auto">To run the Test from the beginning:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/openresty/lua-nginx-module.git
cd lua-nginx-module
bash util/run-ci.sh"><pre>git clone https://github.com/openresty/lua-nginx-module.git
<span class="pl-c1">cd</span> lua-nginx-module
bash util/run-ci.sh</pre></div>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Test Suite</h1><a id="user-content-test-suite" class="anchor" aria-label="Permalink: Test Suite" href="#test-suite"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The following dependencies are required to run the test suite:</p>
<ul dir="auto">
<li>
<p dir="auto">Nginx version &gt;= 1.4.2</p>
</li>
<li>
<p dir="auto">Perl modules:</p>
<ul dir="auto">
<li>Test::Nginx: <a href="https://github.com/openresty/test-nginx">https://github.com/openresty/test-nginx</a></li>
</ul>
</li>
<li>
<p dir="auto">Nginx modules:</p>
<ul dir="auto">
<li><a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a></li>
<li><a href="https://github.com/openresty/set-misc-nginx-module">ngx_set_misc</a></li>
<li><a href="http://mdounin.ru/files/ngx_http_auth_request_module-0.2.tar.gz" rel="nofollow">ngx_auth_request</a> (this is not needed if you're using Nginx 1.5.4+.</li>
<li><a href="https://github.com/openresty/echo-nginx-module">ngx_echo</a></li>
<li><a href="https://github.com/openresty/memc-nginx-module">ngx_memc</a></li>
<li><a href="https://github.com/openresty/srcache-nginx-module">ngx_srcache</a></li>
<li>ngx_lua (i.e., this module)</li>
<li><a href="https://github.com/openresty/lua-upstream-nginx-module">ngx_lua_upstream</a></li>
<li><a href="https://github.com/openresty/headers-more-nginx-module">ngx_headers_more</a></li>
<li><a href="https://github.com/openresty/drizzle-nginx-module">ngx_drizzle</a></li>
<li><a href="https://github.com/openresty/rds-json-nginx-module">ngx_rds_json</a></li>
<li><a href="https://github.com/FRiCKLE/ngx_coolkit">ngx_coolkit</a></li>
<li><a href="https://github.com/openresty/redis2-nginx-module">ngx_redis2</a></li>
</ul>
</li>
</ul>
<p dir="auto">The order in which these modules are added during configuration is important because the position of any filter module in the
filtering chain determines the final output, for example. The correct adding order is shown above.</p>
<ul dir="auto">
<li>
<p dir="auto">3rd-party Lua libraries:</p>
<ul dir="auto">
<li><a href="https://www.kyne.au/~mark/software/lua-cjson.php" rel="nofollow">lua-cjson</a></li>
</ul>
</li>
<li>
<p dir="auto">Applications:</p>
<ul dir="auto">
<li>mysql: create database 'ngx_test', grant all privileges to user 'ngx_test', password is 'ngx_test'</li>
<li>memcached: listening on the default port, 11211.</li>
<li>redis: listening on the default port, 6379.</li>
</ul>
</li>
</ul>
<p dir="auto">See also the <a href="https://github.com/openresty/lua-nginx-module/blob/master/util/build.sh">developer build script</a> for more details on setting up the testing environment.</p>
<p dir="auto">To run the whole test suite in the default testing mode:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="cd /path/to/lua-nginx-module
export PATH=/path/to/your/nginx/sbin:$PATH
prove -I/path/to/test-nginx/lib -r t"><pre class="notranslate"><code>cd /path/to/lua-nginx-module
export PATH=/path/to/your/nginx/sbin:$PATH
prove -I/path/to/test-nginx/lib -r t
</code></pre></div>
<p dir="auto">To run specific test files:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="cd /path/to/lua-nginx-module
export PATH=/path/to/your/nginx/sbin:$PATH
prove -I/path/to/test-nginx/lib t/002-content.t t/003-errors.t"><pre class="notranslate"><code>cd /path/to/lua-nginx-module
export PATH=/path/to/your/nginx/sbin:$PATH
prove -I/path/to/test-nginx/lib t/002-content.t t/003-errors.t
</code></pre></div>
<p dir="auto">To run a specific test block in a particular test file, add the line <code>--- ONLY</code> to the test block you want to run, and then use the <code>prove</code> utility to run that <code>.t</code> file.</p>
<p dir="auto">There are also various testing modes based on mockeagain, valgrind, and etc. Refer to the <a href="https://search.cpan.org/perldoc?Test::Nginx" rel="nofollow">Test::Nginx documentation</a> for more details for various advanced testing modes. See also the test reports for the Nginx test cluster running on Amazon EC2: <a href="https://qa.openresty.org" rel="nofollow">https://qa.openresty.org</a>.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Copyright and License</h1><a id="user-content-copyright-and-license" class="anchor" aria-label="Permalink: Copyright and License" href="#copyright-and-license"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This module is licensed under the BSD license.</p>
<p dir="auto">Copyright (C) 2009-2017, by Xiaozhe Wang (chaoslawful) <a href="mailto:chaoslawful@gmail.com">chaoslawful@gmail.com</a>.</p>
<p dir="auto">Copyright (C) 2009-2019, by Yichun "agentzh" Zhang (章亦春) <a href="mailto:agentzh@gmail.com">agentzh@gmail.com</a>, OpenResty Inc.</p>
<p dir="auto">All rights reserved.</p>
<p dir="auto">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<ul dir="auto">
<li>
<p dir="auto">Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</p>
</li>
<li>
<p dir="auto">Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</p>
</li>
</ul>
<p dir="auto">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">See Also</h1><a id="user-content-see-also" class="anchor" aria-label="Permalink: See Also" href="#see-also"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Blog posts:</p>
<ul dir="auto">
<li><a href="https://blog.openresty.com/en/lua-cpu-flame-graph/?src=gh_ngxlua" rel="nofollow">Introduction to Lua-Land CPU Flame Graphs</a></li>
<li><a href="https://blog.openresty.com/en//how-or-alloc-mem?src=gh_ngxlua" rel="nofollow">How OpenResty and Nginx Allocate and Manage Memory</a></li>
<li><a href="https://blog.openresty.com/en/how-nginx-shm-consume-ram/?src=gh_ngxlua" rel="nofollow">How OpenResty and Nginx Shared Memory Zones Consume RAM</a></li>
<li><a href="https://blog.openresty.com/en/nginx-shm-frag/?src=gh_ngxlua" rel="nofollow">Memory Fragmentation in OpenResty and Nginx's Shared Memory Zones</a></li>
</ul>
<p dir="auto">Other related modules and libraries:</p>
<ul dir="auto">
<li><a href="https://github.com/openresty/stream-lua-nginx-module#readme">ngx_stream_lua_module</a> for an official port of this module for the Nginx "stream" subsystem (doing generic downstream TCP communications).</li>
<li><a href="https://github.com/openresty/lua-resty-memcached">lua-resty-memcached</a> library based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-redis">lua-resty-redis</a> library based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-mysql">lua-resty-mysql</a> library based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-upload">lua-resty-upload</a> library based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-dns">lua-resty-dns</a> library based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-websocket">lua-resty-websocket</a> library for both WebSocket server and client, based on ngx_lua cosocket.</li>
<li><a href="https://github.com/openresty/lua-resty-string">lua-resty-string</a> library based on <a href="https://luajit.org/ext_ffi.html" rel="nofollow">LuaJIT FFI</a>.</li>
<li><a href="https://github.com/openresty/lua-resty-lock">lua-resty-lock</a> library for a nonblocking simple lock API.</li>
<li><a href="https://github.com/cloudflare/lua-resty-cookie">lua-resty-cookie</a> library for HTTP cookie manipulation.</li>
<li><a href="https://openresty.org/#RoutingMySQLQueriesBasedOnURIArgs" rel="nofollow">Routing requests to different MySQL queries based on URI arguments</a></li>
<li><a href="https://openresty.org/#DynamicRoutingBasedOnRedis" rel="nofollow">Dynamic Routing Based on Redis and Lua</a></li>
<li><a href="https://openresty.org/#UsingLuaRocks" rel="nofollow">Using LuaRocks with ngx_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module/wiki/Introduction">Introduction to ngx_lua</a></li>
<li><a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a></li>
<li><a href="http://github.com/openresty/echo-nginx-module">echo-nginx-module</a></li>
<li><a href="http://github.com/openresty/drizzle-nginx-module">drizzle-nginx-module</a></li>
<li><a href="https://github.com/FRiCKLE/ngx_postgres">postgres-nginx-module</a></li>
<li><a href="http://github.com/openresty/memc-nginx-module">memc-nginx-module</a></li>
<li><a href="https://openresty.org" rel="nofollow">The OpenResty bundle</a></li>
<li><a href="https://github.com/openresty/nginx-systemtap-toolkit">Nginx Systemtap Toolkit</a></li>
</ul>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Directives</h1><a id="user-content-directives" class="anchor" aria-label="Permalink: Directives" href="#directives"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#lua_load_resty_core">lua_load_resty_core</a></li>
<li><a href="#lua_capture_error_log">lua_capture_error_log</a></li>
<li><a href="#lua_use_default_type">lua_use_default_type</a></li>
<li><a href="#lua_malloc_trim">lua_malloc_trim</a></li>
<li><a href="#lua_code_cache">lua_code_cache</a></li>
<li><a href="#lua_thread_cache_max_entries">lua_thread_cache_max_entries</a></li>
<li><a href="#lua_regex_cache_max_entries">lua_regex_cache_max_entries</a></li>
<li><a href="#lua_regex_match_limit">lua_regex_match_limit</a></li>
<li><a href="#lua_package_path">lua_package_path</a></li>
<li><a href="#lua_package_cpath">lua_package_cpath</a></li>
<li><a href="#init_by_lua">init_by_lua</a></li>
<li><a href="#init_by_lua_block">init_by_lua_block</a></li>
<li><a href="#init_by_lua_file">init_by_lua_file</a></li>
<li><a href="#init_worker_by_lua">init_worker_by_lua</a></li>
<li><a href="#init_worker_by_lua_block">init_worker_by_lua_block</a></li>
<li><a href="#init_worker_by_lua_file">init_worker_by_lua_file</a></li>
<li><a href="#exit_worker_by_lua_block">exit_worker_by_lua_block</a></li>
<li><a href="#exit_worker_by_lua_file">exit_worker_by_lua_file</a></li>
<li><a href="#set_by_lua">set_by_lua</a></li>
<li><a href="#set_by_lua_block">set_by_lua_block</a></li>
<li><a href="#set_by_lua_file">set_by_lua_file</a></li>
<li><a href="#content_by_lua">content_by_lua</a></li>
<li><a href="#content_by_lua_block">content_by_lua_block</a></li>
<li><a href="#content_by_lua_file">content_by_lua_file</a></li>
<li><a href="#server_rewrite_by_lua_block">server_rewrite_by_lua_block</a></li>
<li><a href="#server_rewrite_by_lua_file">server_rewrite_by_lua_file</a></li>
<li><a href="#rewrite_by_lua">rewrite_by_lua</a></li>
<li><a href="#rewrite_by_lua_block">rewrite_by_lua_block</a></li>
<li><a href="#rewrite_by_lua_file">rewrite_by_lua_file</a></li>
<li><a href="#access_by_lua">access_by_lua</a></li>
<li><a href="#access_by_lua_block">access_by_lua_block</a></li>
<li><a href="#access_by_lua_file">access_by_lua_file</a></li>
<li><a href="#header_filter_by_lua">header_filter_by_lua</a></li>
<li><a href="#header_filter_by_lua_block">header_filter_by_lua_block</a></li>
<li><a href="#header_filter_by_lua_file">header_filter_by_lua_file</a></li>
<li><a href="#body_filter_by_lua">body_filter_by_lua</a></li>
<li><a href="#body_filter_by_lua_block">body_filter_by_lua_block</a></li>
<li><a href="#body_filter_by_lua_file">body_filter_by_lua_file</a></li>
<li><a href="#log_by_lua">log_by_lua</a></li>
<li><a href="#log_by_lua_block">log_by_lua_block</a></li>
<li><a href="#log_by_lua_file">log_by_lua_file</a></li>
<li><a href="#balancer_by_lua_block">balancer_by_lua_block</a></li>
<li><a href="#balancer_by_lua_file">balancer_by_lua_file</a></li>
<li><a href="#balancer_keepalive">balancer_keepalive</a></li>
<li><a href="#lua_need_request_body">lua_need_request_body</a></li>
<li><a href="#ssl_client_hello_by_lua_block">ssl_client_hello_by_lua_block</a></li>
<li><a href="#ssl_client_hello_by_lua_file">ssl_client_hello_by_lua_file</a></li>
<li><a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua_block</a></li>
<li><a href="#ssl_certificate_by_lua_file">ssl_certificate_by_lua_file</a></li>
<li><a href="#ssl_session_fetch_by_lua_block">ssl_session_fetch_by_lua_block</a></li>
<li><a href="#ssl_session_fetch_by_lua_file">ssl_session_fetch_by_lua_file</a></li>
<li><a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua_block</a></li>
<li><a href="#ssl_session_store_by_lua_file">ssl_session_store_by_lua_file</a></li>
<li><a href="#proxy_ssl_verify_by_lua_block">proxy_ssl_verify_by_lua_block</a></li>
<li><a href="#proxy_ssl_verify_by_lua_file">proxy_ssl_verify_by_lua_file</a></li>
<li><a href="#lua_shared_dict">lua_shared_dict</a></li>
<li><a href="#lua_socket_connect_timeout">lua_socket_connect_timeout</a></li>
<li><a href="#lua_socket_send_timeout">lua_socket_send_timeout</a></li>
<li><a href="#lua_socket_send_lowat">lua_socket_send_lowat</a></li>
<li><a href="#lua_socket_read_timeout">lua_socket_read_timeout</a></li>
<li><a href="#lua_socket_buffer_size">lua_socket_buffer_size</a></li>
<li><a href="#lua_socket_pool_size">lua_socket_pool_size</a></li>
<li><a href="#lua_socket_keepalive_timeout">lua_socket_keepalive_timeout</a></li>
<li><a href="#lua_socket_log_errors">lua_socket_log_errors</a></li>
<li><a href="#lua_ssl_ciphers">lua_ssl_ciphers</a></li>
<li><a href="#lua_ssl_crl">lua_ssl_crl</a></li>
<li><a href="#lua_ssl_protocols">lua_ssl_protocols</a></li>
<li><a href="#lua_ssl_certificate">lua_ssl_certificate</a></li>
<li><a href="#lua_ssl_certificate_key">lua_ssl_certificate_key</a></li>
<li><a href="#lua_ssl_trusted_certificate">lua_ssl_trusted_certificate</a></li>
<li><a href="#lua_ssl_verify_depth">lua_ssl_verify_depth</a></li>
<li><a href="#lua_ssl_key_log">lua_ssl_key_log</a></li>
<li><a href="#lua_ssl_conf_command">lua_ssl_conf_command</a></li>
<li><a href="#lua_upstream_skip_openssl_default_verify">lua_upstream_skip_openssl_default_verify</a></li>
<li><a href="#lua_http10_buffering">lua_http10_buffering</a></li>
<li><a href="#rewrite_by_lua_no_postpone">rewrite_by_lua_no_postpone</a></li>
<li><a href="#access_by_lua_no_postpone">access_by_lua_no_postpone</a></li>
<li><a href="#lua_transform_underscores_in_response_headers">lua_transform_underscores_in_response_headers</a></li>
<li><a href="#lua_check_client_abort">lua_check_client_abort</a></li>
<li><a href="#lua_max_pending_timers">lua_max_pending_timers</a></li>
<li><a href="#lua_max_running_timers">lua_max_running_timers</a></li>
<li><a href="#lua_sa_restart">lua_sa_restart</a></li>
<li><a href="#lua_worker_thread_vm_pool_size">lua_worker_thread_vm_pool_size</a></li>
</ul>
<p dir="auto">The basic building blocks of scripting Nginx with Lua are directives. Directives are used to specify when the user Lua code is run and
how the result will be used. Below is a diagram showing the order in which directives are executed.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="/openresty/lua-nginx-module/blob/master/doc/images/lua_nginx_modules_directives.drawio.png"><img src="/openresty/lua-nginx-module/raw/master/doc/images/lua_nginx_modules_directives.drawio.png" alt="Lua Nginx Modules Directives" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_load_resty_core</h2><a id="user-content-lua_load_resty_core" class="anchor" aria-label="Permalink: lua_load_resty_core" href="#lua_load_resty_core"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_load_resty_core on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_load_resty_core on</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">This directive is deprecated since the <code>v0.10.16</code> release of this
module. The <code>resty.core</code> module from
<a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> is now mandatorily
loaded during the Lua VM initialization. Specifying this directive will have no
effect.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.15</code> release and
used to optionally load the <code>resty.core</code> module.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_capture_error_log</h2><a id="user-content-lua_capture_error_log" class="anchor" aria-label="Permalink: lua_capture_error_log" href="#lua_capture_error_log"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_capture_error_log size</em></p>
<p dir="auto"><strong>default:</strong> <em>none</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Enables a buffer of the specified <code>size</code> for capturing all the Nginx error log message data (not just those produced
by this module or the Nginx http subsystem, but everything) without touching files or disks.</p>
<p dir="auto">You can use units like <code>k</code> and <code>m</code> in the <code>size</code> value, as in</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_capture_error_log 100k;"><pre> lua_capture_error_log <span class="pl-c1">100k</span><span class="pl-c1">;</span></pre></div>
<p dir="auto">As a rule of thumb, a 4KB buffer can usually hold about 20 typical error log messages. So do the maths!</p>
<p dir="auto">This buffer never grows. If it is full, new error log messages will replace the oldest ones in the buffer.</p>
<p dir="auto">The size of the buffer must be bigger than the maximum length of a single error log message (which is 4K in OpenResty and 2K in stock NGINX).</p>
<p dir="auto">You can read the messages in the buffer on the Lua land via the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#get_logs">get_logs()</a>
function of the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#readme">ngx.errlog</a>
module of the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#readme">lua-resty-core</a>
library. This Lua API function will return the captured error log messages and
also remove these already read from the global capturing buffer, making room
for any new error log data. For this reason, the user should not configure this
buffer to be too big if the user read the buffered error log data fast enough.</p>
<p dir="auto">Note that the log level specified in the standard <a href="https://nginx.org/r/error_log" rel="nofollow">error_log</a> directive
<em>does</em> have effect on this capturing facility. It only captures log
messages of a level no lower than the specified log level in the <a href="https://nginx.org/r/error_log" rel="nofollow">error_log</a> directive.
The user can still choose to set an even higher filtering log level on the fly via the Lua API function
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/errlog.md#set_filter_level">errlog.set_filter_level</a>.
So it is more flexible than the static <a href="https://nginx.org/r/error_log" rel="nofollow">error_log</a> directive.</p>
<p dir="auto">It is worth noting that there is no way to capture the debugging logs
without building OpenResty or Nginx with the <code>./configure</code>
option <code>--with-debug</code>. And enabling debugging logs is
strongly discouraged in production builds due to high overhead.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.9</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_use_default_type</h2><a id="user-content-lua_use_default_type" class="anchor" aria-label="Permalink: lua_use_default_type" href="#lua_use_default_type"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_use_default_type on | off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_use_default_type on</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto">Specifies whether to use the MIME type specified by the <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#default_type" rel="nofollow">default_type</a> directive for the default value of the <code>Content-Type</code> response header. Deactivate this directive if a default <code>Content-Type</code> response header for Lua request handlers is not desired.</p>
<p dir="auto">This directive is turned on by default.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_malloc_trim</h2><a id="user-content-lua_malloc_trim" class="anchor" aria-label="Permalink: lua_malloc_trim" href="#lua_malloc_trim"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_malloc_trim &lt;request-count&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_malloc_trim 1000</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Asks the underlying <code>libc</code> runtime library to release its cached free memory back to the operating system every
<code>N</code> requests processed by the Nginx core. By default, <code>N</code> is 1000. You can configure the request count
by using your own numbers. Smaller numbers mean more frequent releases, which may introduce higher CPU time consumption and
smaller memory footprint while larger numbers usually lead to less CPU time overhead and relatively larger memory footprint.
Just tune the number for your own use cases.</p>
<p dir="auto">Configuring the argument to <code>0</code> essentially turns off the periodical memory trimming altogether.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_malloc_trim 0;  # turn off trimming completely"><pre> lua_malloc_trim 0<span class="pl-c1">;</span>  # turn off trimming completely</pre></div>
<p dir="auto">The current implementation uses an Nginx log phase handler to do the request counting. So the appearance of the
<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#log_subrequest" rel="nofollow">log_subrequest on</a> directives in <code>nginx.conf</code>
may make the counting faster when subrequests are involved. By default, only "main requests" count.</p>
<p dir="auto">Note that this directive does <em>not</em> affect the memory allocated by LuaJIT's own allocator based on the <code>mmap</code>
system call.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.7</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_code_cache</h2><a id="user-content-lua_code_cache" class="anchor" aria-label="Permalink: lua_code_cache" href="#lua_code_cache"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_code_cache on | off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_code_cache on</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto">Enables or disables the Lua code cache for Lua code in <code>*_by_lua_file</code> directives (like <a href="#set_by_lua_file">set_by_lua_file</a> and
<a href="#content_by_lua_file">content_by_lua_file</a>) and Lua modules.</p>
<p dir="auto">When turning off, every request served by ngx_lua will run in a separate Lua VM instance, starting from the <code>0.9.3</code> release. So the Lua files referenced in <a href="#set_by_lua_file">set_by_lua_file</a>,
<a href="#content_by_lua_file">content_by_lua_file</a>, <a href="#access_by_lua_file">access_by_lua_file</a>,
and etc will not be cached
and all Lua modules used will be loaded from scratch. With this in place, developers can adopt an edit-and-refresh approach.</p>
<p dir="auto">Please note however, that Lua code written inlined within nginx.conf
such as those specified by <a href="#set_by_lua">set_by_lua</a>, <a href="#content_by_lua">content_by_lua</a>,
<a href="#access_by_lua">access_by_lua</a>, and <a href="#rewrite_by_lua">rewrite_by_lua</a> will not be updated when you edit the inlined Lua code in your <code>nginx.conf</code> file because only the Nginx config file parser can correctly parse the <code>nginx.conf</code>
file and the only way is to reload the config file
by sending a <code>HUP</code> signal or just to restart Nginx.</p>
<p dir="auto">Even when the code cache is enabled, Lua files which are loaded by <code>dofile</code> or <code>loadfile</code>
in *_by_lua_file cannot be cached (unless you cache the results yourself). Usually you can either use the <a href="#init_by_lua">init_by_lua</a>
or <a href="#init-by_lua_file">init_by_lua_file</a> directives to load all such files or just make these Lua files true Lua modules
and load them via <code>require</code>.</p>
<p dir="auto">The ngx_lua module does not support the <code>stat</code> mode available with the
Apache <code>mod_lua</code> module (yet).</p>
<p dir="auto">Disabling the Lua code cache is strongly
discouraged for production use and should only be used during
development as it has a significant negative impact on overall performance. For example, the performance of a "hello world" Lua example can drop by an order of magnitude after disabling the Lua code cache.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_thread_cache_max_entries</h2><a id="user-content-lua_thread_cache_max_entries" class="anchor" aria-label="Permalink: lua_thread_cache_max_entries" href="#lua_thread_cache_max_entries"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_thread_cache_max_entries &lt;num&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_thread_cache_max_entries 1024</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Specifies the maximum number of entries allowed in the worker process level lua thread object cache.</p>
<p dir="auto">This cache recycles the lua thread GC objects among all our "light threads".</p>
<p dir="auto">A zero value of <code>&lt;num&gt;</code> disables the cache.</p>
<p dir="auto">Note that this feature requires OpenResty's LuaJIT with the new C API <code>lua_resetthread</code>.</p>
<p dir="auto">This feature was first introduced in verson <code>v0.10.9</code>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_regex_cache_max_entries</h2><a id="user-content-lua_regex_cache_max_entries" class="anchor" aria-label="Permalink: lua_regex_cache_max_entries" href="#lua_regex_cache_max_entries"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_regex_cache_max_entries &lt;num&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_regex_cache_max_entries 1024</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Specifies the maximum number of entries allowed in the worker process level compiled regex cache.</p>
<p dir="auto">The regular expressions used in <a href="#ngxrematch">ngx.re.match</a>, <a href="#ngxregmatch">ngx.re.gmatch</a>, <a href="#ngxresub">ngx.re.sub</a>, and <a href="#ngxregsub">ngx.re.gsub</a> will be cached within this cache if the regex option <code>o</code> (i.e., compile-once flag) is specified.</p>
<p dir="auto">The default number of entries allowed is 1024 and when this limit is reached, new regular expressions will not be cached (as if the <code>o</code> option was not specified) and there will be one, and only one, warning in the <code>error.log</code> file:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="2011/08/27 23:18:26 [warn] 31997#0: *1 lua exceeding regex cache max entries (1024), ..."><pre class="notranslate"><code>2011/08/27 23:18:26 [warn] 31997#0: *1 lua exceeding regex cache max entries (1024), ...
</code></pre></div>
<p dir="auto">If you are using the <code>ngx.re.*</code> implementation of <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> by loading the <code>resty.core.regex</code> module (or just the <code>resty.core</code> module), then an LRU cache is used for the regex cache being used here.</p>
<p dir="auto">Do not activate the <code>o</code> option for regular expressions (and/or <code>replace</code> string arguments for <a href="#ngxresub">ngx.re.sub</a> and <a href="#ngxregsub">ngx.re.gsub</a>) that are generated <em>on the fly</em> and give rise to infinite variations to avoid hitting the specified limit.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_regex_match_limit</h2><a id="user-content-lua_regex_match_limit" class="anchor" aria-label="Permalink: lua_regex_match_limit" href="#lua_regex_match_limit"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_regex_match_limit &lt;num&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_regex_match_limit 0</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Specifies the "match limit" used by the PCRE library when executing the <a href="#ngxrematch">ngx.re API</a>. To quote the PCRE manpage, "the limit ... has the effect of limiting the amount of backtracking that can take place."</p>
<p dir="auto">When the limit is hit, the error string "pcre_exec() failed: -8" will be returned by the <a href="#ngxrematch">ngx.re API</a> functions on the Lua land.</p>
<p dir="auto">When setting the limit to 0, the default "match limit" when compiling the PCRE library is used. And this is the default value of this directive.</p>
<p dir="auto">This directive was first introduced in the <code>v0.8.5</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_package_path</h2><a id="user-content-lua_package_path" class="anchor" aria-label="Permalink: lua_package_path" href="#lua_package_path"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_package_path &lt;lua-style-path-str&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>The content of LUA_PATH environment variable or Lua's compiled-in defaults.</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Sets the Lua module search path used by scripts specified by <a href="#set_by_lua">set_by_lua</a>,
<a href="#content_by_lua">content_by_lua</a> and others. The path string is in standard Lua path form, and <code>;;</code>
can be used to stand for the original search paths.</p>
<p dir="auto">As from the <code>v0.5.0rc29</code> release, the special notation <code>$prefix</code> or <code>${prefix}</code> can be used in the search path string to indicate the path of the <code>server prefix</code> usually determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_package_cpath</h2><a id="user-content-lua_package_cpath" class="anchor" aria-label="Permalink: lua_package_cpath" href="#lua_package_cpath"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_package_cpath &lt;lua-style-cpath-str&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>The content of LUA_CPATH environment variable or Lua's compiled-in defaults.</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Sets the Lua C-module search path used by scripts specified by <a href="#set_by_lua">set_by_lua</a>,
<a href="#content_by_lua">content_by_lua</a> and others. The cpath string is in standard Lua cpath form, and <code>;;</code>
can be used to stand for the original cpath.</p>
<p dir="auto">As from the <code>v0.5.0rc29</code> release, the special notation <code>$prefix</code> or <code>${prefix}</code> can be used in the search path string to indicate the path of the <code>server prefix</code> usually determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_by_lua</h2><a id="user-content-init_by_lua" class="anchor" aria-label="Permalink: init_by_lua" href="#init_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>loading-config</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#init_by_lua_block">init_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#init_by_lua_block">init_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 init_by_lua '
     print(&quot;I need no extra escaping here, for example: \r\nblah&quot;)
 '"><pre> init_by_lua '
     print<span class="pl-c1">(</span><span class="pl-s">"I need no extra escaping here, for example: <span class="pl-cce">\r\n</span>blah"</span><span class="pl-c1">)</span>
 '</pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.5.5</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_by_lua_block</h2><a id="user-content-init_by_lua_block" class="anchor" aria-label="Permalink: init_by_lua_block" href="#init_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>loading-config</em></p>
<p dir="auto">When Nginx receives the <code>HUP</code> signal and starts reloading the config file, the Lua VM will also be re-created and <code>init_by_lua_block</code> will run again on the new Lua VM. In case that the <a href="#lua_code_cache">lua_code_cache</a> directive is turned off (default on), the <code>init_by_lua_block</code> handler will run upon every request because in this special mode a standalone Lua VM is always created for each request.</p>
<p dir="auto">Usually you can pre-load Lua modules at server start-up by means of this hook and take advantage of modern operating systems' copy-on-write (COW) optimization. Here is an example for pre-loading Lua modules:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # this runs before forking out nginx worker processes:
 init_by_lua_block { require &quot;cjson&quot; }

 server {
     location = /api {
         content_by_lua_block {
             -- the following require() will just  return
             -- the already loaded module from package.loaded:
             ngx.say(require &quot;cjson&quot;.encode{dog = 5, cat = 6})
         }
     }
 }"><pre><span class="pl-c"> # this runs before forking out nginx worker processes:</span>
 init_by_lua_block <span class="pl-c1">{</span> require <span class="pl-s">"cjson"</span> <span class="pl-c1">}</span>

 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">location</span> = /api <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             -- the following require<span class="pl-c1">()</span> will just  <span class="pl-k">return</span>
             -- the already loaded module from package.loaded:
             ngx.say<span class="pl-c1">(</span>require <span class="pl-s">"cjson"</span>.encode<span class="pl-c1">{</span>dog = 5, cat = 6<span class="pl-c1">}</span><span class="pl-c1">)</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">You can also initialize the <a href="#lua_shared_dict">lua_shared_dict</a> shm storage at this phase. Here is an example for this:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_shared_dict dogs 1m;

 init_by_lua_block {
     local dogs = ngx.shared.dogs
     dogs:set(&quot;Tom&quot;, 56)
 }

 server {
     location = /api {
         content_by_lua_block {
             local dogs = ngx.shared.dogs
             ngx.say(dogs:get(&quot;Tom&quot;))
         }
     }
 }"><pre> lua_shared_dict dogs <span class="pl-c1">1m</span><span class="pl-c1">;</span>

 init_by_lua_block <span class="pl-c1">{</span>
     local dogs = ngx.shared.dogs
     dogs:<span class="pl-c1">set</span><span class="pl-c1">(</span><span class="pl-s">"Tom"</span>, <span class="pl-c1">56</span><span class="pl-c1">)</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">location</span> = /api <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             local dogs = ngx.shared.dogs
             ngx.say<span class="pl-c1">(</span>dogs:get<span class="pl-c1">(</span><span class="pl-s">"Tom"</span><span class="pl-c1">))</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">But note that, the <a href="#lua_shared_dict">lua_shared_dict</a>'s shm storage will not be cleared through a config reload (via the <code>HUP</code> signal, for example). So if you do <em>not</em> want to re-initialize the shm storage in your <code>init_by_lua_block</code> code in this case, then you just need to set a custom flag in the shm storage and always check the flag in your <code>init_by_lua_block</code> code.</p>
<p dir="auto">Because the Lua code in this context runs before Nginx forks its worker processes (if any), data or code loaded here will enjoy the <a href="https://en.wikipedia.org/wiki/Copy-on-write" rel="nofollow">Copy-on-write (COW)</a> feature provided by many operating systems among all the worker processes, thus saving a lot of memory.</p>
<p dir="auto">Do <em>not</em> initialize your own Lua global variables in this context because use of Lua global variables have performance penalties and can lead to global namespace pollution (see the <a href="#lua-variable-scope">Lua Variable Scope</a> section for more details). The recommended way is to use proper <a href="https://www.lua.org/manual/5.1/manual.html#5.3" rel="nofollow">Lua module</a> files (but do not use the standard Lua function <a href="https://www.lua.org/manual/5.1/manual.html#pdf-module" rel="nofollow">module()</a> to define Lua modules because it pollutes the global namespace as well) and call <a href="https://www.lua.org/manual/5.1/manual.html#pdf-require" rel="nofollow">require()</a> to load your own module files in <code>init_by_lua_block</code> or other contexts (<a href="https://www.lua.org/manual/5.1/manual.html#pdf-require" rel="nofollow">require()</a> does cache the loaded Lua modules in the global <code>package.loaded</code> table in the Lua registry so your modules will only loaded once for the whole Lua VM instance).</p>
<p dir="auto">Only a small set of the <a href="#nginx-api-for-lua">Nginx API for Lua</a> is supported in this context:</p>
<ul dir="auto">
<li>Logging APIs: <a href="#ngxlog">ngx.log</a> and <a href="#print">print</a>,</li>
<li>Shared Dictionary API: <a href="#ngxshareddict">ngx.shared.DICT</a>.</li>
</ul>
<p dir="auto">More Nginx APIs for Lua may be supported in this context upon future user requests.</p>
<p dir="auto">Basically you can safely use Lua libraries that do blocking I/O in this very context because blocking the master process during server start-up is completely okay. Even the Nginx core does blocking I/O (at least on resolving upstream's host names) at the configure-loading phase.</p>
<p dir="auto">You should be very careful about potential security vulnerabilities in your Lua code registered in this context because the Nginx master process is often run under the <code>root</code> account.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto">See also the following blog posts for more details on OpenResty and Nginx's shared memory zones:</p>
<ul dir="auto">
<li><a href="https://blog.openresty.com/en/how-nginx-shm-consume-ram/?src=gh_ngxlua" rel="nofollow">How OpenResty and Nginx Shared Memory Zones Consume RAM</a></li>
<li><a href="https://blog.openresty.com/en/nginx-shm-frag/?src=gh_ngxlua" rel="nofollow">Memory Fragmentation in OpenResty and Nginx's Shared Memory Zones</a></li>
</ul>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_by_lua_file</h2><a id="user-content-init_by_lua_file" class="anchor" aria-label="Permalink: init_by_lua_file" href="#init_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>loading-config</em></p>
<p dir="auto">Equivalent to <a href="#init_by_lua_block">init_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code or <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.5</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_worker_by_lua</h2><a id="user-content-init_worker_by_lua" class="anchor" aria-label="Permalink: init_worker_by_lua" href="#init_worker_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_worker_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>starting-worker</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#init_worker_by_lua_block">init_worker_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#init_worker_by_lua_block">init_worker_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 init_worker_by_lua '
     print(&quot;I need no extra escaping here, for example: \r\nblah&quot;)
 ';"><pre> init_worker_by_lua '
     print<span class="pl-c1">(</span><span class="pl-s">"I need no extra escaping here, for example: <span class="pl-cce">\r\n</span>blah"</span><span class="pl-c1">)</span>
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.9.5</code> release.</p>
<p dir="auto">This hook no longer runs in the cache manager and cache loader processes since the <code>v0.10.12</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_worker_by_lua_block</h2><a id="user-content-init_worker_by_lua_block" class="anchor" aria-label="Permalink: init_worker_by_lua_block" href="#init_worker_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_worker_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>starting-worker</em></p>
<p dir="auto">Runs the specified Lua code upon every Nginx worker process's startup when the master process is enabled. When the master process is disabled, this hook will just run after <a href="#init_by_lua_block">init_by_lua*</a>.</p>
<p dir="auto">This hook is often used to create per-worker reoccurring timers (via the <a href="#ngxtimerat">ngx.timer.at</a> Lua API), either for backend health-check or other timed routine work. Below is an example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 init_worker_by_lua_block {
     local delay = 3  -- in seconds
     local new_timer = ngx.timer.at
     local log = ngx.log
     local ERR = ngx.ERR
     local check

     check = function(premature)
         if not premature then
             -- do the health check or other routine work
             local ok, err = new_timer(delay, check)
             if not ok then
                 log(ERR, &quot;failed to create timer: &quot;, err)
                 return
             end
         end

         -- do something in timer
     end

     local hdl, err = new_timer(delay, check)
     if not hdl then
         log(ERR, &quot;failed to create timer: &quot;, err)
         return
     end

     -- other job in init_worker_by_lua
 }"><pre> init_worker_by_lua_block <span class="pl-c1">{</span>
     local delay = 3  -- in seconds
     local new_timer = ngx.timer.at
     local log = ngx.log
     local ERR = ngx.ERR
     local check

     check = function<span class="pl-c1">(</span>premature<span class="pl-c1">)</span>
         <span class="pl-k">if</span> not premature then
             -- do the health check or other routine work
             local ok, err = new_timer<span class="pl-c1">(</span>delay, check<span class="pl-c1">)</span>
             <span class="pl-k">if</span> not ok then
                 log<span class="pl-c1">(</span>ERR, <span class="pl-s">"failed to create timer: "</span>, err<span class="pl-c1">)</span>
                 <span class="pl-k">return</span>
             end
         end

         -- do something in timer
     end

     local hdl, err = new_timer<span class="pl-c1">(</span>delay, check<span class="pl-c1">)</span>
     <span class="pl-k">if</span> not hdl then
         log<span class="pl-c1">(</span>ERR, <span class="pl-s">"failed to create timer: "</span>, err<span class="pl-c1">)</span>
         <span class="pl-k">return</span>
     end

     -- other job in init_worker_by_lua
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto">This hook no longer runs in the cache manager and cache loader processes since the <code>v0.10.12</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">init_worker_by_lua_file</h2><a id="user-content-init_worker_by_lua_file" class="anchor" aria-label="Permalink: init_worker_by_lua_file" href="#init_worker_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>init_worker_by_lua_file &lt;lua-file-path&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>starting-worker</em></p>
<p dir="auto">Similar to <a href="#init_worker_by_lua_block">init_worker_by_lua_block</a>, but accepts the file path to a Lua source file or Lua bytecode file.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.5</code> release.</p>
<p dir="auto">This hook no longer runs in the cache manager and cache loader processes since the <code>v0.10.12</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">exit_worker_by_lua_block</h2><a id="user-content-exit_worker_by_lua_block" class="anchor" aria-label="Permalink: exit_worker_by_lua_block" href="#exit_worker_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>exit_worker_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>exiting-worker</em></p>
<p dir="auto">Runs the specified Lua code upon every Nginx worker process's exit when the master process is enabled. When the master process is disabled, this hook will run before the Nginx process exits.</p>
<p dir="auto">This hook is often used to release resources allocated by each worker (e.g. resources allocated by <a href="#init_worker_by_lua_block">init_worker_by_lua*</a>), or to prevent workers from exiting abnormally.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 exit_worker_by_lua_block {
     print(&quot;log from exit_worker_by_lua_block&quot;)
 }"><pre> exit_worker_by_lua_block <span class="pl-c1">{</span>
     print<span class="pl-c1">(</span><span class="pl-s">"log from exit_worker_by_lua_block"</span><span class="pl-c1">)</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">It's not allowed to create a timer (even a 0-delay timer) here since it runs after all timers have been processed.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.18</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">exit_worker_by_lua_file</h2><a id="user-content-exit_worker_by_lua_file" class="anchor" aria-label="Permalink: exit_worker_by_lua_file" href="#exit_worker_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>exit_worker_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>exiting-worker</em></p>
<p dir="auto">Similar to <a href="#exit_worker_by_lua_block">exit_worker_by_lua_block</a>, but accepts the file path to a Lua source file or Lua bytecode file.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.18</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">set_by_lua</h2><a id="user-content-set_by_lua" class="anchor" aria-label="Permalink: set_by_lua" href="#set_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>set_by_lua $res &lt;lua-script-str&gt; [$arg1 $arg2 ...]</em></p>
<p dir="auto"><strong>context:</strong> <em>server, server if, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#set_by_lua_block">set_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#set_by_lua_block">set_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping), and</p>
<ol dir="auto">
<li>this directive support extra arguments after the Lua script.</li>
</ol>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 set_by_lua $res ' return 32 + math.cos(32) ';
 # $res now has the value &quot;32.834223360507&quot; or alike."><pre> set_by_lua <span class="pl-v">$res</span> <span class="pl-s">' return 32 + math.cos(32) '</span><span class="pl-c1">;</span>
<span class="pl-c"> # $res now has the value "32.834223360507" or alike.</span></pre></div>
<p dir="auto">As from the <code>v0.5.0rc29</code> release, Nginx variable interpolation is disabled in the <code>&lt;lua-script-str&gt;</code> argument of this directive and therefore, the dollar sign character (<code>$</code>) can be used directly.</p>
<p dir="auto">This directive requires the <a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a> module.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">set_by_lua_block</h2><a id="user-content-set_by_lua_block" class="anchor" aria-label="Permalink: set_by_lua_block" href="#set_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>set_by_lua_block $res { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>server, server if, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite</em></p>
<p dir="auto">Executes code specified inside a pair of curly braces (<code>{}</code>), and returns string output to <code>$res</code>.
The code inside a pair of curly braces (<code>{}</code>) can make <a href="#nginx-api-for-lua">API calls</a> and can retrieve input arguments from the <code>ngx.arg</code> table (index starts from <code>1</code> and increases sequentially).</p>
<p dir="auto">This directive is designed to execute short, fast running code blocks as the Nginx event loop is blocked during code execution. Time consuming code sequences should therefore be avoided.</p>
<p dir="auto">This directive is implemented by injecting custom commands into the standard <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>'s command list. Because <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a> does not support nonblocking I/O in its commands, Lua APIs requiring yielding the current Lua "light thread" cannot work in this directive.</p>
<p dir="auto">At least the following API functions are currently disabled within the context of <code>set_by_lua_block</code>:</p>
<ul dir="auto">
<li>Output API functions (e.g., <a href="#ngxsay">ngx.say</a> and <a href="#ngxsend_headers">ngx.send_headers</a>)</li>
<li>Control API functions (e.g., <a href="#ngxexit">ngx.exit</a>)</li>
<li>Subrequest API functions (e.g., <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>)</li>
<li>Cosocket API functions (e.g., <a href="#ngxsockettcp">ngx.socket.tcp</a> and <a href="#ngxreqsocket">ngx.req.socket</a>).</li>
<li>Sleeping API function <a href="#ngxsleep">ngx.sleep</a>.</li>
</ul>
<p dir="auto">In addition, note that this directive can only write out a value to a single Nginx variable at
a time. However, a workaround is possible using the <a href="#ngxvarvariable">ngx.var.VARIABLE</a> interface.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     set $diff ''; # we have to predefine the $diff variable here

     set_by_lua_block $sum {
         local a = 32
         local b = 56

         ngx.var.diff = a - b  -- write to $diff directly
         return a + b          -- return the $sum value normally
     }

     echo &quot;sum = $sum, diff = $diff&quot;;
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$diff</span> <span class="pl-s">''</span><span class="pl-c1">;</span> # we have to predefine the <span class="pl-v">$diff</span> variable here

     set_by_lua_block <span class="pl-v">$sum</span> <span class="pl-c1">{</span>
         local a = <span class="pl-c1">32</span>
         local b = <span class="pl-c1">56</span>

         ngx.var.diff = a - b  -- write to <span class="pl-v">$diff</span> directly
         <span class="pl-k">return</span> a + b          -- <span class="pl-k">return</span> the <span class="pl-v">$sum</span> value normally
     <span class="pl-c1">}</span>

     echo <span class="pl-s">"sum = $sum, diff = $diff"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">This directive can be freely mixed with all directives of the <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>, <a href="http://github.com/openresty/set-misc-nginx-module">set-misc-nginx-module</a>, and <a href="http://github.com/openresty/array-var-nginx-module">array-var-nginx-module</a> modules. All of these directives will run in the same order as they appear in the config file.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 set $foo 32;
 set_by_lua_block $bar { return tonumber(ngx.var.foo) + 1 }
 set $baz &quot;bar: $bar&quot;;  # $baz == &quot;bar: 33&quot;"><pre> <span class="pl-c1">set</span> <span class="pl-v">$foo</span> <span class="pl-c1">32</span><span class="pl-c1">;</span>
 set_by_lua_block <span class="pl-v">$bar</span> <span class="pl-c1">{</span> <span class="pl-k">return</span> tonumber<span class="pl-c1">(</span>ngx.var.foo<span class="pl-c1">)</span> + 1 <span class="pl-c1">}</span>
 <span class="pl-c1">set</span> <span class="pl-v">$baz</span> <span class="pl-s">"bar: $bar"</span><span class="pl-c1">;</span>  # <span class="pl-v">$baz</span> == <span class="pl-s">"bar: 33"</span></pre></div>
<p dir="auto">No special escaping is required in the Lua code block.</p>
<p dir="auto">This directive requires the <a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a> module.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">set_by_lua_file</h2><a id="user-content-set_by_lua_file" class="anchor" aria-label="Permalink: set_by_lua_file" href="#set_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>set_by_lua_file $res &lt;path-to-lua-script-file&gt; [$arg1 $arg2 ...]</em></p>
<p dir="auto"><strong>context:</strong> <em>server, server if, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite</em></p>
<p dir="auto">Equivalent to <a href="#set_by_lua_block">set_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">Nginx variable interpolation is supported in the <code>&lt;path-to-lua-script-file&gt;</code> argument string of this directive. But special care must be taken for injection attacks.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">When the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached
and the Nginx config must be reloaded each time the Lua source file is modified.
The Lua code cache can be temporarily disabled during development by
switching <a href="#lua_code_cache">lua_code_cache</a> <code>off</code> in <code>nginx.conf</code> to avoid reloading Nginx.</p>
<p dir="auto">This directive requires the <a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a> module.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">content_by_lua</h2><a id="user-content-content_by_lua" class="anchor" aria-label="Permalink: content_by_lua" href="#content_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>content_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>content</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#content_by_lua_block">content_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#content_by_lua_block">content_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 content_by_lua '
     ngx.say(&quot;I need no extra escaping here, for example: \r\nblah&quot;)
 ';"><pre> content_by_lua '
     ngx.say<span class="pl-c1">(</span><span class="pl-s">"I need no extra escaping here, for example: <span class="pl-cce">\r\n</span>blah"</span><span class="pl-c1">)</span>
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">content_by_lua_block</h2><a id="user-content-content_by_lua_block" class="anchor" aria-label="Permalink: content_by_lua_block" href="#content_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>content_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>content</em></p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 content_by_lua_block {
     ngx.say(&quot;I need no extra escaping here, for example: \r\nblah&quot;)
 }"><pre> content_by_lua_block <span class="pl-c1">{</span>
     ngx.say<span class="pl-c1">(</span><span class="pl-s">"I need no extra escaping here, for example: <span class="pl-cce">\r\n</span>blah"</span><span class="pl-c1">)</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Acts as a "content handler" and executes Lua code string specified in <code>{ lua-script }</code> for every request.
The Lua code may make <a href="#nginx-api-for-lua">API calls</a> and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).</p>
<p dir="auto">Do not use this directive and other content handler directives in the same location. For example, this directive and the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" rel="nofollow">proxy_pass</a> directive should not be used in the same location.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">content_by_lua_file</h2><a id="user-content-content_by_lua_file" class="anchor" aria-label="Permalink: content_by_lua_file" href="#content_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>content_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>content</em></p>
<p dir="auto">Equivalent to <a href="#content_by_lua_block">content_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">If the file is not found, a <code>404 Not Found</code> status code will be returned, and a <code>503 Service Temporarily Unavailable</code> status code will be returned in case of errors in reading other files.</p>
<p dir="auto">Nginx variables can be used in the <code>&lt;path-to-lua-script-file&gt;</code> string to provide flexibility. This however carries some risks and is not ordinarily recommended.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">When the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached
and the Nginx config must be reloaded each time the Lua source file is modified.
The Lua code cache can be temporarily disabled during development by
switching <a href="#lua_code_cache">lua_code_cache</a> <code>off</code> in <code>nginx.conf</code> to avoid reloading Nginx.</p>
<p dir="auto">Nginx variables are supported in the file path for dynamic dispatch, for example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # CAUTION: contents in nginx var must be carefully filtered,
 # otherwise there'll be great security risk!
 location ~ ^/app/([-_a-zA-Z0-9/]+) {
     set $path $1;
     content_by_lua_file /path/to/lua/app/root/$path.lua;
 }"><pre><span class="pl-c"> # CAUTION: contents in nginx var must be carefully filtered,</span>
<span class="pl-c"> # otherwise there'll be great security risk!</span>
 <span class="pl-c1">location</span> <span class="pl-sr">~</span> ^/app/<span class="pl-c1">(</span>[-_a-zA-Z0-9/]+<span class="pl-c1">)</span> <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$path</span> <span class="pl-v">$1</span><span class="pl-c1">;</span>
     content_by_lua_file /path/to/lua/app/<span class="pl-c1">root</span>/<span class="pl-v">$path</span>.lua<span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">But be very careful about malicious user inputs and always carefully validate or filter out the user-supplied path components.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">server_rewrite_by_lua_block</h2><a id="user-content-server_rewrite_by_lua_block" class="anchor" aria-label="Permalink: server_rewrite_by_lua_block" href="#server_rewrite_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>server_rewrite_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server</em></p>
<p dir="auto"><strong>phase:</strong> <em>server rewrite</em></p>
<p dir="auto">Acts as a server rewrite phase handler and executes Lua code string specified in <code>{ lua-script }</code> for every request.
The Lua code may make <a href="#nginx-api-for-lua">API calls</a> and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server {
     ...

     server_rewrite_by_lua_block {
         ngx.ctx.a = &quot;server_rewrite_by_lua_block in http&quot;
     }

     location /lua {
         content_by_lua_block {
             ngx.say(ngx.ctx.a)
             ngx.log(ngx.INFO, ngx.ctx.a)
        	}
     }
 }"><pre> <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     ...

     server_rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.a = <span class="pl-s">"server_rewrite_by_lua_block in http"</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             ngx.say<span class="pl-c1">(</span>ngx.ctx.a<span class="pl-c1">)</span>
             ngx.log<span class="pl-c1">(</span>ngx.INFO, ngx.ctx.a<span class="pl-c1">)</span>
        	<span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Just as any other rewrite phase handlers, <a href="#server_rewrite_by_lua_block">server_rewrite_by_lua_block</a> also runs in subrequests.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server {
     server_rewrite_by_lua_block {
         ngx.log(ngx.INFO, &quot;is_subrequest:&quot;, ngx.is_subrequest)
     }

     location /lua {
         content_by_lua_block {
             local res = ngx.location.capture(&quot;/sub&quot;)
             ngx.print(res.body)
         }
     }

     location /sub {
         content_by_lua_block {
             ngx.say(&quot;OK&quot;)
         }
     }
 }"><pre> <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     server_rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.log<span class="pl-c1">(</span>ngx.INFO, <span class="pl-s">"is_subrequest:"</span>, ngx.is_subrequest<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/sub"</span><span class="pl-c1">)</span>
             ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> /sub <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"OK"</span><span class="pl-c1">)</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Note that when calling <code>ngx.exit(ngx.OK)</code> within a <a href="#server_rewrite_by_lua_block">server_rewrite_by_lua_block</a> handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a <a href="#server_rewrite_by_lua_block">server_rewrite_by_lua_block</a> handler, call <a href="#ngxexit">ngx.exit</a> with status &gt;= 200 (<code>ngx.HTTP_OK</code>) and status &lt; 300 (<code>ngx.HTTP_SPECIAL_RESPONSE</code>) for successful quits and <code>ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)</code> (or its friends) for failures.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server_rewrite_by_lua_block {
     ngx.exit(503)
 }

 location /bar {
     ...
     # never exec
 }"><pre> server_rewrite_by_lua_block <span class="pl-c1">{</span>
     ngx.exit<span class="pl-c1">(</span><span class="pl-c1">503</span><span class="pl-c1">)</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /bar <span class="pl-c1">{</span>
     ...
<span class="pl-c">     # never exec</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">server_rewrite_by_lua_file</h2><a id="user-content-server_rewrite_by_lua_file" class="anchor" aria-label="Permalink: server_rewrite_by_lua_file" href="#server_rewrite_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>server_rewrite_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server</em></p>
<p dir="auto"><strong>phase:</strong> <em>server rewrite</em></p>
<p dir="auto">Equivalent to <a href="#server_rewrite_by_lua_block">server_rewrite_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.10.22</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">Nginx variables can be used in the <code>&lt;path-to-lua-script-file&gt;</code> string to provide flexibility. This however carries some risks and is not ordinarily recommended.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">When the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached and the Nginx config must be reloaded each time the Lua source file is modified. The Lua code cache can be temporarily disabled during development by switching <a href="#lua_code_cache">lua_code_cache</a> <code>off</code> in <code>nginx.conf</code> to avoid reloading Nginx.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">rewrite_by_lua</h2><a id="user-content-rewrite_by_lua" class="anchor" aria-label="Permalink: rewrite_by_lua" href="#rewrite_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>rewrite_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite tail</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite_by_lua '
     do_something(&quot;hello, world!\nhiya\n&quot;)
 ';"><pre> rewrite_by_lua '
     do_something<span class="pl-c1">(</span><span class="pl-s">"hello, world!<span class="pl-cce">\n</span>hiya<span class="pl-cce">\n</span>"</span><span class="pl-c1">)</span>
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">rewrite_by_lua_block</h2><a id="user-content-rewrite_by_lua_block" class="anchor" aria-label="Permalink: rewrite_by_lua_block" href="#rewrite_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>rewrite_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite tail</em></p>
<p dir="auto">Acts as a rewrite phase handler and executes Lua code string specified in <code>{ lua-script }</code> for every request.
The Lua code may make <a href="#nginx-api-for-lua">API calls</a> and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).</p>
<p dir="auto">Note that this handler always runs <em>after</em> the standard <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>. So the following will work as expected:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     set $a 12; # create and initialize $a
     set $b &quot;&quot;; # create and initialize $b
     rewrite_by_lua_block {
         ngx.var.b = tonumber(ngx.var.a) + 1
     }
     echo &quot;res = $b&quot;;
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$a</span> <span class="pl-c1">12</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$a</span>
     <span class="pl-c1">set</span> <span class="pl-v">$b</span> <span class="pl-s">""</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$b</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.var.b = tonumber<span class="pl-c1">(</span>ngx.var.a<span class="pl-c1">)</span> + 1
     <span class="pl-c1">}</span>
     echo <span class="pl-s">"res = $b"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">because <code>set $a 12</code> and <code>set $b ""</code> run <em>before</em> <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a>.</p>
<p dir="auto">On the other hand, the following will not work as expected:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ?  location /foo {
 ?      set $a 12; # create and initialize $a
 ?      set $b ''; # create and initialize $b
 ?      rewrite_by_lua_block {
 ?          ngx.var.b = tonumber(ngx.var.a) + 1
 ?      }
 ?      if ($b = '13') {
 ?         rewrite ^ /bar redirect;
 ?         break;
 ?      }
 ?
 ?      echo &quot;res = $b&quot;;
 ?  }"><pre> ?  <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
 ?      <span class="pl-c1">set</span> <span class="pl-v">$a</span> <span class="pl-c1">12</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$a</span>
 ?      <span class="pl-c1">set</span> <span class="pl-v">$b</span> <span class="pl-s">''</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$b</span>
 ?      rewrite_by_lua_block <span class="pl-c1">{</span>
 ?          ngx.var.b = tonumber<span class="pl-c1">(</span>ngx.var.a<span class="pl-c1">)</span> + 1
 ?      <span class="pl-c1">}</span>
 ?      <span class="pl-k">if</span> <span class="pl-c1">(</span><span class="pl-v">$b</span> = <span class="pl-s">'13'</span><span class="pl-c1">)</span> <span class="pl-c1">{</span>
 ?         <span class="pl-c1">rewrite</span> ^ /bar redirect<span class="pl-c1">;</span>
 ?         <span class="pl-c1">break</span><span class="pl-c1">;</span>
 ?      <span class="pl-c1">}</span>
 ?
 ?      echo <span class="pl-s">"res = $b"</span><span class="pl-c1">;</span>
 ?  <span class="pl-c1">}</span></pre></div>
<p dir="auto">because <code>if</code> runs <em>before</em> <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> even if it is placed after <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> in the config.</p>
<p dir="auto">The right way of doing this is as follows:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     set $a 12; # create and initialize $a
     set $b ''; # create and initialize $b
     rewrite_by_lua_block {
         ngx.var.b = tonumber(ngx.var.a) + 1
         if tonumber(ngx.var.b) == 13 then
             return ngx.redirect(&quot;/bar&quot;)
         end
     }

     echo &quot;res = $b&quot;;
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$a</span> <span class="pl-c1">12</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$a</span>
     <span class="pl-c1">set</span> <span class="pl-v">$b</span> <span class="pl-s">''</span><span class="pl-c1">;</span> # create and initialize <span class="pl-v">$b</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.var.b = tonumber<span class="pl-c1">(</span>ngx.var.a<span class="pl-c1">)</span> + 1
         <span class="pl-k">if</span> tonumber<span class="pl-c1">(</span>ngx.var.b<span class="pl-c1">)</span> == <span class="pl-c1">13</span> then
             <span class="pl-k">return</span> ngx.redirect<span class="pl-c1">(</span><span class="pl-s">"/bar"</span><span class="pl-c1">)</span>
         end
     <span class="pl-c1">}</span>

     echo <span class="pl-s">"res = $b"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Note that the <a href="http://www.grid.net.ru/nginx/eval.en.html" rel="nofollow">ngx_eval</a> module can be approximated by using <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a>. For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     eval $res {
         proxy_pass http://foo.com/check-spam;
     }

     if ($res = 'spam') {
         rewrite ^ /terms-of-use.html redirect;
     }

     fastcgi_pass ...;
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     eval <span class="pl-v">$res</span> <span class="pl-c1">{</span>
         <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://foo.com/check-spam<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>

     <span class="pl-k">if</span> <span class="pl-c1">(</span><span class="pl-v">$res</span> = <span class="pl-s">'spam'</span><span class="pl-c1">)</span> <span class="pl-c1">{</span>
         <span class="pl-c1">rewrite</span> ^ /terms-of-<span class="pl-c1">use</span>.html redirect<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">fastcgi_pass</span> ...<span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">can be implemented in ngx_lua as:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location = /check-spam {
     internal;
     proxy_pass http://foo.com/check-spam;
 }

 location / {
     rewrite_by_lua_block {
         local res = ngx.location.capture(&quot;/check-spam&quot;)
         if res.body == &quot;spam&quot; then
             return ngx.redirect(&quot;/terms-of-use.html&quot;)
         end
     }

     fastcgi_pass ...;
 }"><pre> <span class="pl-c1">location</span> = /check-spam <span class="pl-c1">{</span>
     <span class="pl-c1">internal</span><span class="pl-c1">;</span>
     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://foo.com/check-spam<span class="pl-c1">;</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/check-spam"</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> res.body == <span class="pl-s">"spam"</span> then
             <span class="pl-k">return</span> ngx.redirect<span class="pl-c1">(</span><span class="pl-s">"/terms-of-use.html"</span><span class="pl-c1">)</span>
         end
     <span class="pl-c1">}</span>

     <span class="pl-c1">fastcgi_pass</span> ...<span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Just as any other rewrite phase handlers, <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> also runs in subrequests.</p>
<p dir="auto">Note that when calling <code>ngx.exit(ngx.OK)</code> within a <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> handler, call <a href="#ngxexit">ngx.exit</a> with status &gt;= 200 (<code>ngx.HTTP_OK</code>) and status &lt; 300 (<code>ngx.HTTP_SPECIAL_RESPONSE</code>) for successful quits and <code>ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)</code> (or its friends) for failures.</p>
<p dir="auto">If the <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>'s <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" rel="nofollow">rewrite</a> directive is used to change the URI and initiate location re-lookups (internal redirections), then any <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a> or <a href="#rewrite_by_lua_file_block">rewrite_by_lua_file_block</a> code sequences within the current location will not be executed. For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     rewrite ^ /bar;
     rewrite_by_lua_block {
         ngx.exit(503)
     }
 }
 location /bar {
     ...
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">rewrite</span> ^ /bar<span class="pl-c1">;</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.exit<span class="pl-c1">(</span><span class="pl-c1">503</span><span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>
 <span class="pl-c1">location</span> /bar <span class="pl-c1">{</span>
     ...
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Here the Lua code <code>ngx.exit(503)</code> will never run. This will be the case if <code>rewrite ^ /bar last</code> is used as this will similarly initiate an internal redirection. If the <code>break</code> modifier is used instead, there will be no internal redirection and the <code>rewrite_by_lua_block</code> code will be executed.</p>
<p dir="auto">The <code>rewrite_by_lua_block</code> code will always run at the end of the <code>rewrite</code> request-processing phase unless <a href="#rewrite_by_lua_no_postpone">rewrite_by_lua_no_postpone</a> is turned on.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">rewrite_by_lua_file</h2><a id="user-content-rewrite_by_lua_file" class="anchor" aria-label="Permalink: rewrite_by_lua_file" href="#rewrite_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>rewrite_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>rewrite tail</em></p>
<p dir="auto">Equivalent to <a href="#rewrite_by_lua_block">rewrite_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">Nginx variables can be used in the <code>&lt;path-to-lua-script-file&gt;</code> string to provide flexibility. This however carries some risks and is not ordinarily recommended.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">When the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached and the Nginx config must be reloaded each time the Lua source file is modified. The Lua code cache can be temporarily disabled during development by switching <a href="#lua_code_cache">lua_code_cache</a> <code>off</code> in <code>nginx.conf</code> to avoid reloading Nginx.</p>
<p dir="auto">The <code>rewrite_by_lua_file</code> code will always run at the end of the <code>rewrite</code> request-processing phase unless <a href="#rewrite_by_lua_no_postpone">rewrite_by_lua_no_postpone</a> is turned on.</p>
<p dir="auto">Nginx variables are supported in the file path for dynamic dispatch just as in <a href="#content_by_lua_file">content_by_lua_file</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">access_by_lua</h2><a id="user-content-access_by_lua" class="anchor" aria-label="Permalink: access_by_lua" href="#access_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>access_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>access tail</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#access_by_lua_block">access_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#access_by_lua_block">access_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 access_by_lua '
     do_something(&quot;hello, world!\nhiya\n&quot;)
 ';"><pre> access_by_lua '
     do_something<span class="pl-c1">(</span><span class="pl-s">"hello, world!<span class="pl-cce">\n</span>hiya<span class="pl-cce">\n</span>"</span><span class="pl-c1">)</span>
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">access_by_lua_block</h2><a id="user-content-access_by_lua_block" class="anchor" aria-label="Permalink: access_by_lua_block" href="#access_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>access_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>access tail</em></p>
<p dir="auto">Acts as an access phase handler and executes Lua code string specified in <code>{ &lt;lua-script }</code> for every request.
The Lua code may make <a href="#nginx-api-for-lua">API calls</a> and is executed as a new spawned coroutine in an independent global environment (i.e. a sandbox).</p>
<p dir="auto">Note that this handler always runs <em>after</em> the standard <a href="http://nginx.org/en/docs/http/ngx_http_access_module.html" rel="nofollow">ngx_http_access_module</a>. So the following will work as expected:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     deny    192.168.1.1;
     allow   192.168.1.0/24;
     allow   10.1.1.0/16;
     deny    all;

     access_by_lua_block {
         local res = ngx.location.capture(&quot;/mysql&quot;, { ... })
         ...
     }

     # proxy_pass/fastcgi_pass/...
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     <span class="pl-c1">deny</span>    <span class="pl-c1">192.168.1.1</span><span class="pl-c1">;</span>
     <span class="pl-c1">allow</span>   <span class="pl-c1">192.168.1.0</span>/<span class="pl-c1">24</span><span class="pl-c1">;</span>
     <span class="pl-c1">allow</span>   <span class="pl-c1">10.1.1.0</span>/<span class="pl-c1">16</span><span class="pl-c1">;</span>
     <span class="pl-c1">deny</span>    all<span class="pl-c1">;</span>

     access_by_lua_block <span class="pl-c1">{</span>
         local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/mysql"</span>, <span class="pl-c1">{</span> ... <span class="pl-c1">}</span><span class="pl-c1">)</span>
         ...
     <span class="pl-c1">}</span>

<span class="pl-c">     # proxy_pass/fastcgi_pass/...</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">That is, if a client IP address is in the blacklist, it will be denied before the MySQL query for more complex authentication is executed by <a href="#access_by_lua_block">access_by_lua_block</a>.</p>
<p dir="auto">Note that the <a href="http://mdounin.ru/hg/ngx_http_auth_request_module/" rel="nofollow">ngx_auth_request</a> module can be approximated by using <a href="#access_by_lua_block">access_by_lua_block</a>:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     auth_request /auth;

     # proxy_pass/fastcgi_pass/postgres_pass/...
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     <span class="pl-c1">auth_request</span> /auth<span class="pl-c1">;</span>

<span class="pl-c">     # proxy_pass/fastcgi_pass/postgres_pass/...</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">can be implemented in ngx_lua as:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     access_by_lua_block {
         local res = ngx.location.capture(&quot;/auth&quot;)

         if res.status == ngx.HTTP_OK then
             return
         end

         if res.status == ngx.HTTP_FORBIDDEN then
             ngx.exit(res.status)
         end

         ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
     }

     # proxy_pass/fastcgi_pass/postgres_pass/...
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     access_by_lua_block <span class="pl-c1">{</span>
         local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/auth"</span><span class="pl-c1">)</span>

         <span class="pl-k">if</span> res.<span class="pl-c1">status</span> == ngx.HTTP_OK then
             <span class="pl-k">return</span>
         end

         <span class="pl-k">if</span> res.<span class="pl-c1">status</span> == ngx.HTTP_FORBIDDEN then
             ngx.exit<span class="pl-c1">(</span>res.<span class="pl-c1">status</span><span class="pl-c1">)</span>
         end

         ngx.exit<span class="pl-c1">(</span>ngx.HTTP_INTERNAL_SERVER_ERROR<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>

<span class="pl-c">     # proxy_pass/fastcgi_pass/postgres_pass/...</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">As with other access phase handlers, <a href="#access_by_lua_block">access_by_lua_block</a> will <em>not</em> run in subrequests.</p>
<p dir="auto">Note that when calling <code>ngx.exit(ngx.OK)</code> within a <a href="#access_by_lua_block">access_by_lua_block</a> handler, the Nginx request processing control flow will still continue to the content handler. To terminate the current request from within a <a href="#access_by_lua_block">access_by_lua_block</a> handler, call <a href="#ngxexit">ngx.exit</a> with status &gt;= 200 (<code>ngx.HTTP_OK</code>) and status &lt; 300 (<code>ngx.HTTP_SPECIAL_RESPONSE</code>) for successful quits and <code>ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)</code> (or its friends) for failures.</p>
<p dir="auto">Starting from the <code>v0.9.20</code> release, you can use the <a href="#access_by_lua_no_postpone">access_by_lua_no_postpone</a>
directive to control when to run this handler inside the "access" request-processing phase
of Nginx.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">access_by_lua_file</h2><a id="user-content-access_by_lua_file" class="anchor" aria-label="Permalink: access_by_lua_file" href="#access_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>access_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>access tail</em></p>
<p dir="auto">Equivalent to <a href="#access_by_lua_block">access_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">Nginx variables can be used in the <code>&lt;path-to-lua-script-file&gt;</code> string to provide flexibility. This however carries some risks and is not ordinarily recommended.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">When the Lua code cache is turned on (by default), the user code is loaded once at the first request and cached
and the Nginx config must be reloaded each time the Lua source file is modified.
The Lua code cache can be temporarily disabled during development by switching <a href="#lua_code_cache">lua_code_cache</a> <code>off</code> in <code>nginx.conf</code> to avoid repeatedly reloading Nginx.</p>
<p dir="auto">Nginx variables are supported in the file path for dynamic dispatch just as in <a href="#content_by_lua_file">content_by_lua_file</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">header_filter_by_lua</h2><a id="user-content-header_filter_by_lua" class="anchor" aria-label="Permalink: header_filter_by_lua" href="#header_filter_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>header_filter_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-header-filter</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#header_filter_by_lua_block">header_filter_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#header_filter_by_lua_block">header_filter_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 header_filter_by_lua '
     ngx.header[&quot;content-length&quot;] = nil
 ';"><pre> header_filter_by_lua '
     ngx.header[<span class="pl-s">"content-length"</span>] = nil
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.2.1rc20</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">header_filter_by_lua_block</h2><a id="user-content-header_filter_by_lua_block" class="anchor" aria-label="Permalink: header_filter_by_lua_block" href="#header_filter_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>header_filter_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-header-filter</em></p>
<p dir="auto">Uses Lua code specified in <code>{ lua-script }</code> to define an output header filter.</p>
<p dir="auto">Note that the following API functions are currently disabled within this context:</p>
<ul dir="auto">
<li>Output API functions (e.g., <a href="#ngxsay">ngx.say</a> and <a href="#ngxsend_headers">ngx.send_headers</a>)</li>
<li>Control API functions (e.g., <a href="#ngxredirect">ngx.redirect</a> and <a href="#ngxexec">ngx.exec</a>)</li>
<li>Subrequest API functions (e.g., <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>)</li>
<li>Cosocket API functions (e.g., <a href="#ngxsockettcp">ngx.socket.tcp</a> and <a href="#ngxreqsocket">ngx.req.socket</a>).</li>
</ul>
<p dir="auto">Here is an example of overriding a response header (or adding one if absent) in our Lua header filter:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     proxy_pass http://mybackend;
     header_filter_by_lua_block {
         ngx.header.Foo = &quot;blah&quot;
     }
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://mybackend<span class="pl-c1">;</span>
     header_filter_by_lua_block <span class="pl-c1">{</span>
         ngx.header.Foo = <span class="pl-s">"blah"</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">header_filter_by_lua_file</h2><a id="user-content-header_filter_by_lua_file" class="anchor" aria-label="Permalink: header_filter_by_lua_file" href="#header_filter_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>header_filter_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-header-filter</em></p>
<p dir="auto">Equivalent to <a href="#header_filter_by_lua_block">header_filter_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.2.1rc20</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">body_filter_by_lua</h2><a id="user-content-body_filter_by_lua" class="anchor" aria-label="Permalink: body_filter_by_lua" href="#body_filter_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>body_filter_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-body-filter</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#body_filter_by_lua_block">body_filter_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#body_filter_by_lua_block">body_filter_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 body_filter_by_lua '
     local data, eof = ngx.arg[1], ngx.arg[2]
 ';"><pre> body_filter_by_lua '
     local data, eof = ngx.arg[1], ngx.arg[2]
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc32</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">body_filter_by_lua_block</h2><a id="user-content-body_filter_by_lua_block" class="anchor" aria-label="Permalink: body_filter_by_lua_block" href="#body_filter_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>body_filter_by_lua_block { lua-script-str }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-body-filter</em></p>
<p dir="auto">Uses Lua code specified in <code>{ lua-script }</code> to define an output body filter.</p>
<p dir="auto">The input data chunk is passed via <a href="#ngxarg">ngx.arg</a>[1] (as a Lua string value) and the "eof" flag indicating the end of the response body data stream is passed via <a href="#ngxarg">ngx.arg</a>[2] (as a Lua boolean value).</p>
<p dir="auto">Behind the scene, the "eof" flag is just the <code>last_buf</code> (for main requests) or <code>last_in_chain</code> (for subrequests) flag of the Nginx chain link buffers. (Before the <code>v0.7.14</code> release, the "eof" flag does not work at all in subrequests.)</p>
<p dir="auto">The output data stream can be aborted immediately by running the following Lua statement:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.ERROR"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-e">ERROR</span></pre></div>
<p dir="auto">This will truncate the response body and usually result in incomplete and also invalid responses.</p>
<p dir="auto">The Lua code can pass its own modified version of the input data chunk to the downstream Nginx output body filters by overriding <a href="#ngxarg">ngx.arg</a>[1] with a Lua string or a Lua table of strings. For example, to transform all the lowercase letters in the response body, we can just write:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     proxy_pass http://mybackend;
     body_filter_by_lua_block {
         ngx.arg[1] = string.upper(ngx.arg[1])
     }
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://mybackend<span class="pl-c1">;</span>
     body_filter_by_lua_block <span class="pl-c1">{</span>
         ngx.arg[1] = string.upper<span class="pl-c1">(</span>ngx.arg[1]<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">When setting <code>nil</code> or an empty Lua string value to <code>ngx.arg[1]</code>, no data chunk will be passed to the downstream Nginx output filters at all.</p>
<p dir="auto">Likewise, new "eof" flag can also be specified by setting a boolean value to <a href="#ngxarg">ngx.arg</a>[2]. For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /t {
     echo hello world;
     echo hiya globe;

     body_filter_by_lua_block {
         local chunk = ngx.arg[1]
         if string.match(chunk, &quot;hello&quot;) then
             ngx.arg[2] = true  -- new eof
             return
         end

         -- just throw away any remaining chunk data
         ngx.arg[1] = nil
     }
 }"><pre> <span class="pl-c1">location</span> /t <span class="pl-c1">{</span>
     echo hello world<span class="pl-c1">;</span>
     echo hiya globe<span class="pl-c1">;</span>

     body_filter_by_lua_block <span class="pl-c1">{</span>
         local chunk = ngx.arg[1]
         <span class="pl-k">if</span> string.<span class="pl-c1">match</span><span class="pl-c1">(</span>chunk, <span class="pl-s">"hello"</span><span class="pl-c1">)</span> then
             ngx.arg[2] = true  -- new eof
             <span class="pl-k">return</span>
         end

         -- just throw away any remaining chunk data
         ngx.arg[1] = nil
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then <code>GET /t</code> will just return the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="hello world"><pre class="notranslate"><code>hello world
</code></pre></div>
<p dir="auto">That is, when the body filter sees a chunk containing the word "hello", then it will set the "eof" flag to true immediately, resulting in truncated but still valid responses.</p>
<p dir="auto">When the Lua code may change the length of the response body, then it is required to always clear out the <code>Content-Length</code> response header (if any) in a header filter to enforce streaming output, as in</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     # fastcgi_pass/proxy_pass/...

     header_filter_by_lua_block {
         ngx.header.content_length = nil
     }
     body_filter_by_lua_block {
         ngx.arg[1] = string.len(ngx.arg[1]) .. &quot;\n&quot;
     }
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
<span class="pl-c">     # fastcgi_pass/proxy_pass/...</span>

     header_filter_by_lua_block <span class="pl-c1">{</span>
         ngx.header.content_length = nil
     <span class="pl-c1">}</span>
     body_filter_by_lua_block <span class="pl-c1">{</span>
         ngx.arg[1] = string.len<span class="pl-c1">(</span>ngx.arg[1]<span class="pl-c1">)</span> .. <span class="pl-s">"<span class="pl-cce">\n</span>"</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Note that the following API functions are currently disabled within this context due to the limitations in Nginx output filter's current implementation:</p>
<ul dir="auto">
<li>Output API functions (e.g., <a href="#ngxsay">ngx.say</a> and <a href="#ngxsend_headers">ngx.send_headers</a>)</li>
<li>Control API functions (e.g., <a href="#ngxexit">ngx.exit</a> and <a href="#ngxexec">ngx.exec</a>)</li>
<li>Subrequest API functions (e.g., <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>)</li>
<li>Cosocket API functions (e.g., <a href="#ngxsockettcp">ngx.socket.tcp</a> and <a href="#ngxreqsocket">ngx.req.socket</a>).</li>
</ul>
<p dir="auto">Nginx output filters may be called multiple times for a single request because response body may be delivered in chunks. Thus, the Lua code specified by in this directive may also run multiple times in the lifetime of a single HTTP request.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">body_filter_by_lua_file</h2><a id="user-content-body_filter_by_lua_file" class="anchor" aria-label="Permalink: body_filter_by_lua_file" href="#body_filter_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>body_filter_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>output-body-filter</em></p>
<p dir="auto">Equivalent to <a href="#body_filter_by_lua_block">body_filter_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc32</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">log_by_lua</h2><a id="user-content-log_by_lua" class="anchor" aria-label="Permalink: log_by_lua" href="#log_by_lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>log_by_lua &lt;lua-script-str&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>log</em></p>
<p dir="auto"><strong>NOTE</strong> Use of this directive is <em>discouraged</em> following the <code>v0.9.17</code> release. Use the <a href="#log_by_lua_block">log_by_lua_block</a> directive instead.</p>
<p dir="auto">Similar to the <a href="#log_by_lua_block">log_by_lua_block</a> directive, but accepts the Lua source directly in an Nginx string literal (which requires
special character escaping).</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 log_by_lua '
     print(&quot;I need no extra escaping here, for example: \r\nblah&quot;)
 ';"><pre> log_by_lua '
     print<span class="pl-c1">(</span><span class="pl-s">"I need no extra escaping here, for example: <span class="pl-cce">\r\n</span>blah"</span><span class="pl-c1">)</span>
 '<span class="pl-c1">;</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc31</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">log_by_lua_block</h2><a id="user-content-log_by_lua_block" class="anchor" aria-label="Permalink: log_by_lua_block" href="#log_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>log_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>log</em></p>
<p dir="auto">Runs the Lua source code inlined as the <code>{ lua-script }</code> at the <code>log</code> request processing phase. This does not replace the current access logs, but runs before.</p>
<p dir="auto">Note that the following API functions are currently disabled within this context:</p>
<ul dir="auto">
<li>Output API functions (e.g., <a href="#ngxsay">ngx.say</a> and <a href="#ngxsend_headers">ngx.send_headers</a>)</li>
<li>Control API functions (e.g., <a href="#ngxexit">ngx.exit</a>)</li>
<li>Subrequest API functions (e.g., <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>)</li>
<li>Cosocket API functions (e.g., <a href="#ngxsockettcp">ngx.socket.tcp</a> and <a href="#ngxreqsocket">ngx.req.socket</a>).</li>
</ul>
<p dir="auto">Here is an example of gathering average data for <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#var_upstream_response_time" rel="nofollow">$upstream_response_time</a>:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_shared_dict log_dict 5M;

 server {
     location / {
         proxy_pass http://mybackend;

         log_by_lua_block {
             local log_dict = ngx.shared.log_dict
             local upstream_time = tonumber(ngx.var.upstream_response_time)

             local sum = log_dict:get(&quot;upstream_time-sum&quot;) or 0
             sum = sum + upstream_time
             log_dict:set(&quot;upstream_time-sum&quot;, sum)

             local newval, err = log_dict:incr(&quot;upstream_time-nb&quot;, 1)
             if not newval and err == &quot;not found&quot; then
                 log_dict:add(&quot;upstream_time-nb&quot;, 0)
                 log_dict:incr(&quot;upstream_time-nb&quot;, 1)
             end
         }
     }

     location = /status {
         content_by_lua_block {
             local log_dict = ngx.shared.log_dict
             local sum = log_dict:get(&quot;upstream_time-sum&quot;)
             local nb = log_dict:get(&quot;upstream_time-nb&quot;)

             if nb and sum then
                 ngx.say(&quot;average upstream response time: &quot;, sum / nb,
                         &quot; (&quot;, nb, &quot; reqs)&quot;)
             else
                 ngx.say(&quot;no data yet&quot;)
             end
         }
     }
 }"><pre> lua_shared_dict log_dict <span class="pl-c1">5M</span><span class="pl-c1">;</span>

 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
         <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://mybackend<span class="pl-c1">;</span>

         log_by_lua_block <span class="pl-c1">{</span>
             local log_dict = ngx.shared.log_dict
             local upstream_time = tonumber<span class="pl-c1">(</span>ngx.var.upstream_response_time<span class="pl-c1">)</span>

             local sum = log_dict:get<span class="pl-c1">(</span><span class="pl-s">"upstream_time-sum"</span><span class="pl-c1">)</span> or 0
             sum = sum + upstream_time
             log_dict:<span class="pl-c1">set</span><span class="pl-c1">(</span><span class="pl-s">"upstream_time-sum"</span>, sum<span class="pl-c1">)</span>

             local newval, err = log_dict:incr<span class="pl-c1">(</span><span class="pl-s">"upstream_time-nb"</span>, 1<span class="pl-c1">)</span>
             <span class="pl-k">if</span> not newval and err == <span class="pl-s">"not found"</span> then
                 log_dict:add<span class="pl-c1">(</span><span class="pl-s">"upstream_time-nb"</span>, 0<span class="pl-c1">)</span>
                 log_dict:incr<span class="pl-c1">(</span><span class="pl-s">"upstream_time-nb"</span>, 1<span class="pl-c1">)</span>
             end
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> = /<span class="pl-c1">status</span> <span class="pl-c1">{</span>
         content_by_lua_block <span class="pl-c1">{</span>
             local log_dict = ngx.shared.log_dict
             local sum = log_dict:get<span class="pl-c1">(</span><span class="pl-s">"upstream_time-sum"</span><span class="pl-c1">)</span>
             local nb = log_dict:get<span class="pl-c1">(</span><span class="pl-s">"upstream_time-nb"</span><span class="pl-c1">)</span>

             <span class="pl-k">if</span> nb and sum then
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"average upstream response time: "</span>, sum / nb,
                         <span class="pl-s">" ("</span>, nb, <span class="pl-s">" reqs)"</span><span class="pl-c1">)</span>
             else
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"no data yet"</span><span class="pl-c1">)</span>
             end
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.9.17</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">log_by_lua_file</h2><a id="user-content-log_by_lua_file" class="anchor" aria-label="Permalink: log_by_lua_file" href="#log_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>log_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>log</em></p>
<p dir="auto">Equivalent to <a href="#log_by_lua_block">log_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc31</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">balancer_by_lua_block</h2><a id="user-content-balancer_by_lua_block" class="anchor" aria-label="Permalink: balancer_by_lua_block" href="#balancer_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>balancer_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>upstream</em></p>
<p dir="auto"><strong>phase:</strong> <em>content</em></p>
<p dir="auto">This directive runs Lua code as an upstream balancer for any upstream entities defined
by the <code>upstream {}</code> configuration block.</p>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 upstream foo {
     server 127.0.0.1;
     balancer_by_lua_block {
         -- use Lua to do something interesting here
         -- as a dynamic balancer
     }
 }

 server {
     location / {
         proxy_pass http://foo;
     }
 }"><pre> <span class="pl-c1">upstream</span> foo <span class="pl-c1">{</span>
     <span class="pl-c1">server</span> <span class="pl-c1">127.0.0.1</span><span class="pl-c1">;</span>
     balancer_by_lua_block <span class="pl-c1">{</span>
         -- <span class="pl-c1">use</span> Lua to do something interesting here
         -- as a dynamic balancer
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
         <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://foo<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">The resulting Lua load balancer can work with any existing Nginx upstream modules
like <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_proxy</a> and
<a href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" rel="nofollow">ngx_fastcgi</a>.</p>
<p dir="auto">Also, the Lua load balancer can work with the standard upstream connection pool mechanism,
i.e., the standard <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" rel="nofollow">keepalive</a> directive.
Just ensure that the <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" rel="nofollow">keepalive</a> directive
is used <em>after</em> this <code>balancer_by_lua_block</code> directive in a single <code>upstream {}</code> configuration block.</p>
<p dir="auto">The Lua load balancer can totally ignore the list of servers defined in the <code>upstream {}</code> block
and select peer from a completely dynamic server list (even changing per request) via the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md">ngx.balancer</a> module
from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">The Lua code handler registered by this directive might get called more than once in a single
downstream request when the Nginx upstream mechanism retries the request on conditions
specified by directives like the <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream" rel="nofollow">proxy_next_upstream</a>
directive.</p>
<p dir="auto">This Lua code execution context does not support yielding, so Lua APIs that may yield
(like cosockets and "light threads") are disabled in this context. One can usually work
around this limitation by doing such operations in an earlier phase handler (like
<a href="#access_by_lua">access_by_lua*</a>) and passing along the result into this context
via the <a href="#ngxctx">ngx.ctx</a> table.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">balancer_by_lua_file</h2><a id="user-content-balancer_by_lua_file" class="anchor" aria-label="Permalink: balancer_by_lua_file" href="#balancer_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>balancer_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>upstream</em></p>
<p dir="auto"><strong>phase:</strong> <em>content</em></p>
<p dir="auto">Equivalent to <a href="#balancer_by_lua_block">balancer_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">balancer_keepalive</h2><a id="user-content-balancer_keepalive" class="anchor" aria-label="Permalink: balancer_keepalive" href="#balancer_keepalive"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>balancer_keepalive &lt;total-connections&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>upstream</em></p>
<p dir="auto"><strong>phase:</strong> <em>loading-config</em></p>
<p dir="auto">The <code>total-connections</code> parameter sets the maximum number of idle
keepalive connections to upstream servers that are preserved in the cache of
each worker process. When this number is exceeded, the least recently used
connections are closed.</p>
<p dir="auto">It should be particularly noted that the keepalive directive does not limit the
total number of connections to upstream servers that an nginx worker process
can open. The connections parameter should be set to a number small enough to
let upstream servers process new incoming connections as well.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.21</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_need_request_body</h2><a id="user-content-lua_need_request_body" class="anchor" aria-label="Permalink: lua_need_request_body" href="#lua_need_request_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_need_request_body &lt;on|off&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>off</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location if</em></p>
<p dir="auto"><strong>phase:</strong> <em>depends on usage</em></p>
<p dir="auto">Determines whether to force the request body data to be read before running rewrite/access/content_by_lua* or not. The Nginx core does not read the client request body by default and if request body data is required, then this directive should be turned <code>on</code> or the <a href="#ngxreqread_body">ngx.req.read_body</a> function should be called within the Lua code.</p>
<p dir="auto">To read the request body data within the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_body" rel="nofollow">$request_body</a> variable,
<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" rel="nofollow">client_body_buffer_size</a> must have the same value as <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" rel="nofollow">client_max_body_size</a>. Because when the content length exceeds <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" rel="nofollow">client_body_buffer_size</a> but less than <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" rel="nofollow">client_max_body_size</a>, Nginx will buffer the data into a temporary file on the disk, which will lead to empty value in the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_body" rel="nofollow">$request_body</a> variable.</p>
<p dir="auto">If the current location includes <a href="#rewrite_by_lua">rewrite_by_lua*</a> directives,
then the request body will be read just before the <a href="#rewrite_by_lua">rewrite_by_lua*</a> code is run (and also at the
<code>rewrite</code> phase). Similarly, if only <a href="#content_by_lua">content_by_lua</a> is specified,
the request body will not be read until the content handler's Lua code is
about to run (i.e., the request body will be read during the content phase).</p>
<p dir="auto">It is recommended however, to use the <a href="#ngxreqread_body">ngx.req.read_body</a> and <a href="#ngxreqdiscard_body">ngx.req.discard_body</a> functions for finer control over the request body reading process instead.</p>
<p dir="auto">This also applies to <a href="#access_by_lua">access_by_lua*</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_client_hello_by_lua_block</h2><a id="user-content-ssl_client_hello_by_lua_block" class="anchor" aria-label="Permalink: ssl_client_hello_by_lua_block" href="#ssl_client_hello_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_client_hello_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-client-hello-message-was-processed</em></p>
<p dir="auto">This directive runs user Lua code when Nginx is about to post-process the SSL client hello message for the downstream
SSL (https) connections.</p>
<p dir="auto">It is particularly useful for dynamically setting the SSL protocols according to the SNI.</p>
<p dir="auto">It is also useful to do some custom operations according to the per-connection information in the client hello message.</p>
<p dir="auto">For example, one can parse custom client hello extension and do the corresponding handling in pure Lua.</p>
<p dir="auto">This Lua handler will always run whether the SSL session is resumed (via SSL session IDs or TLS session tickets) or not.
While the <code>ssl_certificate_by_lua*</code> Lua handler will only runs when initiating a full SSL handshake.</p>
<p dir="auto">The <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md">ngx.ssl.clienthello</a> Lua modules
provided by the <a href="https://github.com/openresty/lua-resty-core/#readme">lua-resty-core</a>
library are particularly useful in this context.</p>
<p dir="auto">Note that this handler runs in extremely early stage of SSL handshake, before the SSL client hello extensions are parsed.
So you can not use some Lua API like <code>ssl.server_name()</code> which is dependent on the later stage's processing.</p>
<p dir="auto">Also note that only the directive in default server is valid for several virtual servers with the same IP address and port.</p>
<p dir="auto">Below is a trivial example using the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md">ngx.ssl.clienthello</a> module
at the same time:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server {
     listen 443 ssl;
     server_name   test.com;
     ssl_certificate /path/to/cert.crt;
     ssl_certificate_key /path/to/key.key;
     ssl_client_hello_by_lua_block {
         local ssl_clt = require &quot;ngx.ssl.clienthello&quot;
         local host, err = ssl_clt.get_client_hello_server_name()
         if host == &quot;test.com&quot; then
             ssl_clt.set_protocols({&quot;TLSv1&quot;, &quot;TLSv1.1&quot;})
         elseif host == &quot;test2.com&quot; then
             ssl_clt.set_protocols({&quot;TLSv1.2&quot;, &quot;TLSv1.3&quot;})
         elseif not host then
             ngx.log(ngx.ERR, &quot;failed to get the SNI name: &quot;, err)
             ngx.exit(ngx.ERROR)
         else
             ngx.log(ngx.ERR, &quot;unknown SNI name: &quot;, host)
             ngx.exit(ngx.ERROR)
         end
     }
     ...
 }
 server {
     listen 443 ssl;
     server_name   test2.com;
     ssl_certificate /path/to/cert.crt;
     ssl_certificate_key /path/to/key.key;
     ...
 }"><pre> <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">listen</span> <span class="pl-c1">443</span> <span class="pl-c1">ssl</span><span class="pl-c1">;</span>
     <span class="pl-c1">server_name</span>   test.com<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate</span> /path/to/cert.crt<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate_key</span> /path/to/key.key<span class="pl-c1">;</span>
     ssl_client_hello_by_lua_block <span class="pl-c1">{</span>
         local ssl_clt = require <span class="pl-s">"ngx.ssl.clienthello"</span>
         local host, err = ssl_clt.get_client_hello_server_name<span class="pl-c1">()</span>
         <span class="pl-k">if</span> host == <span class="pl-s">"test.com"</span> then
             ssl_clt.set_protocols<span class="pl-c1">(</span><span class="pl-c1">{</span><span class="pl-s">"TLSv1"</span>, <span class="pl-s">"TLSv1.1"</span><span class="pl-c1">}</span><span class="pl-c1">)</span>
         elseif host == <span class="pl-s">"test2.com"</span> then
             ssl_clt.set_protocols<span class="pl-c1">(</span><span class="pl-c1">{</span><span class="pl-s">"TLSv1.2"</span>, <span class="pl-s">"TLSv1.3"</span><span class="pl-c1">}</span><span class="pl-c1">)</span>
         elseif not host then
             ngx.log<span class="pl-c1">(</span>ngx.ERR, <span class="pl-s">"failed to get the SNI name: "</span>, err<span class="pl-c1">)</span>
             ngx.exit<span class="pl-c1">(</span>ngx.ERROR<span class="pl-c1">)</span>
         else
             ngx.log<span class="pl-c1">(</span>ngx.ERR, <span class="pl-s">"unknown SNI name: "</span>, host<span class="pl-c1">)</span>
             ngx.exit<span class="pl-c1">(</span>ngx.ERROR<span class="pl-c1">)</span>
         end
     <span class="pl-c1">}</span>
     ...
 <span class="pl-c1">}</span>
 <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">listen</span> <span class="pl-c1">443</span> <span class="pl-c1">ssl</span><span class="pl-c1">;</span>
     <span class="pl-c1">server_name</span>   test2.com<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate</span> /path/to/cert.crt<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate_key</span> /path/to/key.key<span class="pl-c1">;</span>
     ...
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">See more information in the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/clienthello.md">ngx.ssl.clienthello</a>
Lua modules' official documentation.</p>
<p dir="auto">Uncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the
<a href="#ngxexit">ngx.exit</a> call with an error code like <code>ngx.ERROR</code>.</p>
<p dir="auto">This Lua code execution context <em>does</em> support yielding, so Lua APIs that may yield
(like cosockets, sleeping, and "light threads")
are enabled in this context</p>
<p dir="auto">Note, you need to configure the <a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate" rel="nofollow">ssl_certificate</a>
and <a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_key" rel="nofollow">ssl_certificate_key</a>
to avoid the following error while starting NGINX:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="nginx: [emerg] no ssl configured for the server"><pre class="notranslate"><code>nginx: [emerg] no ssl configured for the server
</code></pre></div>
<p dir="auto">This directive requires OpenSSL 1.1.1 or greater.</p>
<p dir="auto">If you are using the <a href="https://openresty.org/en/linux-packages.html" rel="nofollow">official pre-built
packages</a> for
<a href="https://openresty.org/" rel="nofollow">OpenResty</a> 1.21.4.1 or later, then everything should
work out of the box.</p>
<p dir="auto">If you are not using the Nginx core shipped with
<a href="https://openresty.org" rel="nofollow">OpenResty</a> 1.21.4.1 or later, you will need to apply
patches to the standard Nginx core:</p>
<p dir="auto"><a href="https://openresty.org/en/nginx-ssl-patches.html" rel="nofollow">https://openresty.org/en/nginx-ssl-patches.html</a></p>
<p dir="auto"><strong>Note for HTTP/3 (QUIC) users</strong>: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: <a href="https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch">nginx-1.27.1-quic_ssl_lua_yield.patch</a></p>
<p dir="auto">This directive was first introduced in the <code>v0.10.21</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_client_hello_by_lua_file</h2><a id="user-content-ssl_client_hello_by_lua_file" class="anchor" aria-label="Permalink: ssl_client_hello_by_lua_file" href="#ssl_client_hello_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_client_hello_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-client-hello-message-was-processed</em></p>
<p dir="auto">Equivalent to <a href="#ssl_client_hello_by_lua_block">ssl_client_hello_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto"><strong>Note for HTTP/3 (QUIC) users</strong>: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: <a href="https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch">nginx-1.27.1-quic_ssl_lua_yield.patch</a></p>
<p dir="auto">This directive was first introduced in the <code>v0.10.21</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_certificate_by_lua_block</h2><a id="user-content-ssl_certificate_by_lua_block" class="anchor" aria-label="Permalink: ssl_certificate_by_lua_block" href="#ssl_certificate_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_certificate_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>server</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-before-SSL-handshake</em></p>
<p dir="auto">This directive runs user Lua code when Nginx is about to start the SSL handshake for the downstream
SSL (https) connections.</p>
<p dir="auto">It is particularly useful for setting the SSL certificate chain and the corresponding private key on a per-request
basis. It is also useful to load such handshake configurations nonblockingly from the remote (for example,
with the <a href="#ngxsockettcp">cosocket</a> API). And one can also do per-request OCSP stapling handling in pure
Lua here as well.</p>
<p dir="auto">Another typical use case is to do SSL handshake traffic control nonblockingly in this context,
with the help of the <a href="https://github.com/openresty/lua-resty-limit-traffic">lua-resty-limit-traffic#readme</a>
library, for example.</p>
<p dir="auto">One can also do interesting things with the SSL handshake requests from the client side, like
rejecting old SSL clients using the SSLv3 protocol or even below selectively.</p>
<p dir="auto">The <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md">ngx.ssl</a>
and <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md">ngx.ocsp</a> Lua modules
provided by the <a href="https://github.com/openresty/lua-resty-core/#readme">lua-resty-core</a>
library are particularly useful in this context. You can use the Lua API offered by these two Lua modules
to manipulate the SSL certificate chain and private key for the current SSL connection
being initiated.</p>
<p dir="auto">This Lua handler does not run at all, however, when Nginx/OpenSSL successfully resumes
the SSL session via SSL session IDs or TLS session tickets for the current SSL connection. In
other words, this Lua handler only runs when Nginx has to initiate a full SSL handshake.</p>
<p dir="auto">Below is a trivial example using the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md">ngx.ssl</a> module
at the same time:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server {
     listen 443 ssl;
     server_name   test.com;

     ssl_certificate_by_lua_block {
         print(&quot;About to initiate a new SSL handshake!&quot;)
     }

     location / {
         root html;
     }
 }"><pre> <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">listen</span> <span class="pl-c1">443</span> <span class="pl-c1">ssl</span><span class="pl-c1">;</span>
     <span class="pl-c1">server_name</span>   test.com<span class="pl-c1">;</span>

     ssl_certificate_by_lua_block <span class="pl-c1">{</span>
         print<span class="pl-c1">(</span><span class="pl-s">"About to initiate a new SSL handshake!"</span><span class="pl-c1">)</span>
     <span class="pl-c1">}</span>

     <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
         <span class="pl-c1">root</span> html<span class="pl-c1">;</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">See more complicated examples in the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md">ngx.ssl</a>
and <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md">ngx.ocsp</a>
Lua modules' official documentation.</p>
<p dir="auto">Uncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the
<a href="#ngxexit">ngx.exit</a> call with an error code like <code>ngx.ERROR</code>.</p>
<p dir="auto">This Lua code execution context <em>does</em> support yielding, so Lua APIs that may yield
(like cosockets, sleeping, and "light threads")
are enabled in this context.</p>
<p dir="auto">Note, however, you still need to configure the <a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate" rel="nofollow">ssl_certificate</a> and
<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_key" rel="nofollow">ssl_certificate_key</a>
directives even though you will not use this static certificate and private key at all. This is
because the NGINX core requires their appearance otherwise you are seeing the following error
while starting NGINX:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="nginx: [emerg] no ssl configured for the server"><pre class="notranslate"><code>nginx: [emerg] no ssl configured for the server
</code></pre></div>
<p dir="auto">This directive requires OpenSSL 1.0.2e or greater.</p>
<p dir="auto">If you are using the <a href="https://openresty.org/en/linux-packages.html" rel="nofollow">official pre-built
packages</a> for
<a href="https://openresty.org/" rel="nofollow">OpenResty</a> 1.9.7.2 or later, then everything should
work out of the box.</p>
<p dir="auto">If you are not using the Nginx core shipped with
<a href="https://openresty.org" rel="nofollow">OpenResty</a> 1.9.7.2 or later, you will need to apply
patches to the standard Nginx core:</p>
<p dir="auto"><a href="https://openresty.org/en/nginx-ssl-patches.html" rel="nofollow">https://openresty.org/en/nginx-ssl-patches.html</a></p>
<p dir="auto"><strong>Note for HTTP/3 (QUIC) users</strong>: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: <a href="https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch">nginx-1.27.1-quic_ssl_lua_yield.patch</a></p>
<p dir="auto">This directive was first introduced in the <code>v0.10.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_certificate_by_lua_file</h2><a id="user-content-ssl_certificate_by_lua_file" class="anchor" aria-label="Permalink: ssl_certificate_by_lua_file" href="#ssl_certificate_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_certificate_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>server</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-before-SSL-handshake</em></p>
<p dir="auto">Equivalent to <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto"><strong>Note for HTTP/3 (QUIC) users</strong>: When using this directive with HTTP/3 connections, certain yield operations may fail if the QUIC SSL Lua yield patch is not applied to your OpenSSL installation. OpenResty packages include this patch by default, but if you are building lua-nginx-module separately, you may need to apply the patch manually to ensure proper yield/resume functionality for HTTP/3 connections in SSL Lua phases. The patch can be found at: <a href="https://github.com/openresty/openresty/blob/master/patches/nginx/1.27.1/nginx-1.27.1-quic_ssl_lua_yield.patch">nginx-1.27.1-quic_ssl_lua_yield.patch</a></p>
<p dir="auto">This directive was first introduced in the <code>v0.10.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_session_fetch_by_lua_block</h2><a id="user-content-ssl_session_fetch_by_lua_block" class="anchor" aria-label="Permalink: ssl_session_fetch_by_lua_block" href="#ssl_session_fetch_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_session_fetch_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-before-SSL-handshake</em></p>
<p dir="auto">This directive runs Lua code to look up and load the SSL session (if any) according to the session ID
provided by the current SSL handshake request for the downstream.</p>
<p dir="auto">The Lua API for obtaining the current session ID and loading a cached SSL session data
is provided in the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/session.md">ngx.ssl.session</a>
Lua module shipped with the <a href="https://github.com/openresty/lua-resty-core#readme">lua-resty-core</a>
library.</p>
<p dir="auto">Lua APIs that may yield, like <a href="#ngxsleep">ngx.sleep</a> and <a href="#ngxsockettcp">cosockets</a>,
are enabled in this context.</p>
<p dir="auto">This hook, together with the <a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua*</a> hook,
can be used to implement distributed caching mechanisms in pure Lua (based
on the <a href="#ngxsockettcp">cosocket</a> API, for example). If a cached SSL session is found
and loaded into the current SSL connection context,
SSL session resumption can then get immediately initiated and bypass the full SSL handshake process which is very expensive in terms of CPU time.</p>
<p dir="auto">Please note that TLS session tickets are very different and it is the clients' responsibility
to cache the SSL session state when session tickets are used. SSL session resumptions based on
TLS session tickets would happen automatically without going through this hook (nor the
<a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua*</a> hook). This hook is mainly
for older or less capable SSL clients that can only do SSL sessions by session IDs.</p>
<p dir="auto">When <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a> is specified at the same time,
this hook usually runs before <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a>.
When the SSL session is found and successfully loaded for the current SSL connection,
SSL session resumption will happen and thus bypass the <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a>
hook completely. In this case, Nginx also bypasses the <a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua*</a>
hook, for obvious reasons.</p>
<p dir="auto">To easily test this hook locally with a modern web browser, you can temporarily put the following line
in your https server block to disable the TLS session ticket support:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="ssl_session_tickets off;"><pre class="notranslate"><code>ssl_session_tickets off;
</code></pre></div>
<p dir="auto">But do not forget to comment this line out before publishing your site to the world.</p>
<p dir="auto">If you are using the <a href="https://openresty.org/en/linux-packages.html" rel="nofollow">official pre-built packages</a> for <a href="https://openresty.org/" rel="nofollow">OpenResty</a>
1.11.2.1 or later, then everything should work out of the box.</p>
<p dir="auto">If you are not using one of the <a href="https://openresty.org/en/linux-packages.html" rel="nofollow">OpenSSL
packages</a> provided by
<a href="https://openresty.org" rel="nofollow">OpenResty</a>, you will need to apply patches to OpenSSL
in order to use this directive:</p>
<p dir="auto"><a href="https://openresty.org/en/openssl-patches.html" rel="nofollow">https://openresty.org/en/openssl-patches.html</a></p>
<p dir="auto">Similarly, if you are not using the Nginx core shipped with
<a href="https://openresty.org" rel="nofollow">OpenResty</a> 1.11.2.1 or later, you will need to apply
patches to the standard Nginx core:</p>
<p dir="auto"><a href="https://openresty.org/en/nginx-ssl-patches.html" rel="nofollow">https://openresty.org/en/nginx-ssl-patches.html</a></p>
<p dir="auto">This directive was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">Note that this directive can only be used in the <strong>http context</strong> starting
with the <code>v0.10.7</code> release since SSL session resumption happens
before server name dispatch.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_session_fetch_by_lua_file</h2><a id="user-content-ssl_session_fetch_by_lua_file" class="anchor" aria-label="Permalink: ssl_session_fetch_by_lua_file" href="#ssl_session_fetch_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_session_fetch_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-before-SSL-handshake</em></p>
<p dir="auto">Equivalent to <a href="#ssl_session_fetch_by_lua_block">ssl_session_fetch_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or rather, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">Note that: this directive is only allowed to used in <strong>http context</strong> from the <code>v0.10.7</code> release
(because SSL session resumption happens before server name dispatch).</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_session_store_by_lua_block</h2><a id="user-content-ssl_session_store_by_lua_block" class="anchor" aria-label="Permalink: ssl_session_store_by_lua_block" href="#ssl_session_store_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_session_store_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-SSL-handshake</em></p>
<p dir="auto">This directive runs Lua code to fetch and save the SSL session (if any) according to the session ID
provided by the current SSL handshake request for the downstream. The saved or cached SSL
session data can be used for future SSL connections to resume SSL sessions without going
through the full SSL handshake process (which is very expensive in terms of CPU time).</p>
<p dir="auto">Lua APIs that may yield, like <a href="#ngxsleep">ngx.sleep</a> and <a href="#ngxsockettcp">cosockets</a>,
are <em>disabled</em> in this context. You can still, however, use the <a href="#ngxtimerat">ngx.timer.at</a> API
to create 0-delay timers to save the SSL session data asynchronously to external services (like <code>redis</code> or <code>memcached</code>).</p>
<p dir="auto">The Lua API for obtaining the current session ID and the associated session state data
is provided in the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/session.md#readme">ngx.ssl.session</a>
Lua module shipped with the <a href="https://github.com/openresty/lua-resty-core#readme">lua-resty-core</a>
library.</p>
<p dir="auto">To easily test this hook locally with a modern web browser, you can temporarily put the following line
in your https server block to disable the TLS session ticket support:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="ssl_session_tickets off;"><pre class="notranslate"><code>ssl_session_tickets off;
</code></pre></div>
<p dir="auto">But do not forget to comment this line out before publishing your site to the world.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">Note that: this directive is only allowed to used in <strong>http context</strong> from the <code>v0.10.7</code> release
(because SSL session resumption happens before server name dispatch).</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ssl_session_store_by_lua_file</h2><a id="user-content-ssl_session_store_by_lua_file" class="anchor" aria-label="Permalink: ssl_session_store_by_lua_file" href="#ssl_session_store_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ssl_session_store_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-SSL-handshake</em></p>
<p dir="auto">Equivalent to <a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or rather, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">Note that: this directive is only allowed to used in <strong>http context</strong> from the <code>v0.10.7</code> release
(because SSL session resumption happens before server name dispatch).</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">proxy_ssl_verify_by_lua_block</h2><a id="user-content-proxy_ssl_verify_by_lua_block" class="anchor" aria-label="Permalink: proxy_ssl_verify_by_lua_block" href="#proxy_ssl_verify_by_lua_block"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>proxy_ssl_verify_by_lua_block { lua-script }</em></p>
<p dir="auto"><strong>context:</strong> <em>location</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-server-certificate-message-was-processed</em></p>
<p dir="auto">This directive runs user Lua code when Nginx is about to post-process the SSL server certificate message for the upstream SSL (https) connections.</p>
<p dir="auto">It is particularly useful to parse upstream server certificate and do some custom operations in pure lua.</p>
<p dir="auto">The <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md">ngx.ssl.proxysslverify</a> Lua modules provided by the <a href="https://github.com/openresty/lua-resty-core/#readme">lua-resty-core</a>
library are particularly useful in this context.</p>
<p dir="auto">Below is a trivial example using the
<a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md">ngx.ssl.proxysslverify</a> module
at the same time:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 server {
     listen 443 ssl;
     server_name   test.com;
     ssl_certificate /path/to/cert.crt;
     ssl_certificate_key /path/to/key.key;

     location /t {
         proxy_ssl_certificate /path/to/cert.crt;
         proxy_ssl_certificate_key /path/to/key.key;
         proxy_pass https://upstream;

         proxy_ssl_verify_by_lua_block {
             local proxy_ssl_vfy = require &quot;ngx.ssl.proxysslverify&quot;
             local cert = proxy_ssl_vfy.get_verify_cert()

             -- ocsp to verify cert
             -- check crl
             proxy_ssl_vfy.set_verify_result()
             ...
         }
     }
     ...
 }"><pre> <span class="pl-c1">server</span> <span class="pl-c1">{</span>
     <span class="pl-c1">listen</span> <span class="pl-c1">443</span> <span class="pl-c1">ssl</span><span class="pl-c1">;</span>
     <span class="pl-c1">server_name</span>   test.com<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate</span> /path/to/cert.crt<span class="pl-c1">;</span>
     <span class="pl-c1">ssl_certificate_key</span> /path/to/key.key<span class="pl-c1">;</span>

     <span class="pl-c1">location</span> /t <span class="pl-c1">{</span>
         <span class="pl-c1">proxy_ssl_certificate</span> /path/to/cert.crt<span class="pl-c1">;</span>
         <span class="pl-c1">proxy_ssl_certificate_key</span> /path/to/key.key<span class="pl-c1">;</span>
         <span class="pl-c1">proxy_pass</span> https://<span class="pl-c1">upstream</span><span class="pl-c1">;</span>

         proxy_ssl_verify_by_lua_block <span class="pl-c1">{</span>
             local proxy_ssl_vfy = require <span class="pl-s">"ngx.ssl.proxysslverify"</span>
             local cert = proxy_ssl_vfy.get_verify_cert<span class="pl-c1">()</span>

             -- ocsp to verify cert
             -- check crl
             proxy_ssl_vfy.set_verify_result<span class="pl-c1">()</span>
             ...
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
     ...
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">See more information in the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl/proxysslverify.md">ngx.ssl.proxysslverify</a>
Lua modules' official documentation.</p>
<p dir="auto">Uncaught Lua exceptions in the user Lua code immediately abort the current SSL session, so does the
<a href="#ngxexit">ngx.exit</a> call with an error code like <code>ngx.ERROR</code>.</p>
<p dir="auto">This Lua code execution context <em>does</em> support yielding, so Lua APIs that may yield
(like cosockets, sleeping, and "light threads")
are enabled in this context</p>
<p dir="auto">Note, <code>ngx.ctx</code> in proxy_ssl_verify_by_lua_block is belonging to upstream connection, not downstream connection, so it's different from <code>ngx.ctx</code> in contexts like ssl_certificate_by_lua etc.</p>
<p dir="auto">This directive requires OpenSSL 3.0.2 or greater.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">proxy_ssl_verify_by_lua_file</h2><a id="user-content-proxy_ssl_verify_by_lua_file" class="anchor" aria-label="Permalink: proxy_ssl_verify_by_lua_file" href="#proxy_ssl_verify_by_lua_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>proxy_ssl_verify_by_lua_file &lt;path-to-lua-script-file&gt;</em></p>
<p dir="auto"><strong>context:</strong> <em>location</em></p>
<p dir="auto"><strong>phase:</strong> <em>right-after-server-certificate-message-was-processed</em></p>
<p dir="auto">Equivalent to <a href="#proxy_ssl_verify_by_lua_block">proxy_ssl_verify_by_lua_block</a>, except that the file specified by <code>&lt;path-to-lua-script-file&gt;</code> contains the Lua code, or, as from the <code>v0.5.0rc32</code> release, the <a href="#luajit-bytecode-support">LuaJIT bytecode</a> to be executed.</p>
<p dir="auto">When a relative path like <code>foo/bar.lua</code> is given, they will be turned into the absolute path relative to the <code>server prefix</code> path determined by the <code>-p PATH</code> command-line option while starting the Nginx server.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_shared_dict</h2><a id="user-content-lua_shared_dict" class="anchor" aria-label="Permalink: lua_shared_dict" href="#lua_shared_dict"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_shared_dict &lt;name&gt; &lt;size&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>no</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto"><strong>phase:</strong> <em>depends on usage</em></p>
<p dir="auto">Declares a shared memory zone, <code>&lt;name&gt;</code>, to serve as storage for the shm based Lua dictionary <code>ngx.shared.&lt;name&gt;</code>.</p>
<p dir="auto">Shared memory zones are always shared by all the Nginx worker processes in the current Nginx server instance.</p>
<p dir="auto">The <code>&lt;size&gt;</code> argument accepts size units such as <code>k</code> and <code>m</code>:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 http {
     lua_shared_dict dogs 10m;
     ...
 }"><pre> <span class="pl-c1">http</span> <span class="pl-c1">{</span>
     lua_shared_dict dogs <span class="pl-c1">10m</span><span class="pl-c1">;</span>
     ...
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">The hard-coded minimum size is 8KB while the practical minimum size depends
on actual user data set (some people start with 12KB).</p>
<p dir="auto">See <a href="#ngxshareddict">ngx.shared.DICT</a> for details.</p>
<p dir="auto">This directive was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_connect_timeout</h2><a id="user-content-lua_socket_connect_timeout" class="anchor" aria-label="Permalink: lua_socket_connect_timeout" href="#lua_socket_connect_timeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_connect_timeout &lt;time&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_connect_timeout 60s</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">This directive controls the default timeout value used in TCP/unix-domain socket object's <a href="#tcpsockconnect">connect</a> method and can be overridden by the <a href="#tcpsocksettimeout">settimeout</a> or <a href="#tcpsocksettimeouts">settimeouts</a> methods.</p>
<p dir="auto">The <code>&lt;time&gt;</code> argument can be an integer, with an optional time unit, like <code>s</code> (second), <code>ms</code> (millisecond), <code>m</code> (minute). The default time unit is <code>s</code>, i.e., "second". The default setting is <code>60s</code>.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_send_timeout</h2><a id="user-content-lua_socket_send_timeout" class="anchor" aria-label="Permalink: lua_socket_send_timeout" href="#lua_socket_send_timeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_send_timeout &lt;time&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_send_timeout 60s</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Controls the default timeout value used in TCP/unix-domain socket object's <a href="#tcpsocksend">send</a> method and can be overridden by the <a href="#tcpsocksettimeout">settimeout</a> or <a href="#tcpsocksettimeouts">settimeouts</a> methods.</p>
<p dir="auto">The <code>&lt;time&gt;</code> argument can be an integer, with an optional time unit, like <code>s</code> (second), <code>ms</code> (millisecond), <code>m</code> (minute). The default time unit is <code>s</code>, i.e., "second". The default setting is <code>60s</code>.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_send_lowat</h2><a id="user-content-lua_socket_send_lowat" class="anchor" aria-label="Permalink: lua_socket_send_lowat" href="#lua_socket_send_lowat"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_send_lowat &lt;size&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_send_lowat 0</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Controls the <code>lowat</code> (low water) value for the cosocket send buffer.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_read_timeout</h2><a id="user-content-lua_socket_read_timeout" class="anchor" aria-label="Permalink: lua_socket_read_timeout" href="#lua_socket_read_timeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_read_timeout &lt;time&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_read_timeout 60s</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto"><strong>phase:</strong> <em>depends on usage</em></p>
<p dir="auto">This directive controls the default timeout value used in TCP/unix-domain socket object's <a href="#tcpsockreceive">receive</a> method and iterator functions returned by the <a href="#tcpsockreceiveuntil">receiveuntil</a> method. This setting can be overridden by the <a href="#tcpsocksettimeout">settimeout</a> or <a href="#tcpsocksettimeouts">settimeouts</a> methods.</p>
<p dir="auto">The <code>&lt;time&gt;</code> argument can be an integer, with an optional time unit, like <code>s</code> (second), <code>ms</code> (millisecond), <code>m</code> (minute). The default time unit is <code>s</code>, i.e., "second". The default setting is <code>60s</code>.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_buffer_size</h2><a id="user-content-lua_socket_buffer_size" class="anchor" aria-label="Permalink: lua_socket_buffer_size" href="#lua_socket_buffer_size"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_buffer_size &lt;size&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_buffer_size 4k/8k</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies the buffer size used by cosocket reading operations.</p>
<p dir="auto">This buffer does not have to be that big to hold everything at the same time because cosocket supports 100% non-buffered reading and parsing. So even <code>1</code> byte buffer size should still work everywhere but the performance could be terrible.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_pool_size</h2><a id="user-content-lua_socket_pool_size" class="anchor" aria-label="Permalink: lua_socket_pool_size" href="#lua_socket_pool_size"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_pool_size &lt;size&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_pool_size 30</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies the size limit (in terms of connection count) for every cosocket connection pool associated with every remote server (i.e., identified by either the host-port pair or the unix domain socket file path).</p>
<p dir="auto">Default to 30 connections for every pool.</p>
<p dir="auto">When the connection pool exceeds the available size limit, the least recently used (idle) connection already in the pool will be closed to make room for the current connection.</p>
<p dir="auto">Note that the cosocket connection pool is per Nginx worker process rather than per Nginx server instance, so size limit specified here also applies to every single Nginx worker process.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_keepalive_timeout</h2><a id="user-content-lua_socket_keepalive_timeout" class="anchor" aria-label="Permalink: lua_socket_keepalive_timeout" href="#lua_socket_keepalive_timeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_keepalive_timeout &lt;time&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_keepalive_timeout 60s</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">This directive controls the default maximal idle time of the connections in the cosocket built-in connection pool. When this timeout reaches, idle connections will be closed and removed from the pool. This setting can be overridden by cosocket objects' <a href="#tcpsocksetkeepalive">setkeepalive</a> method.</p>
<p dir="auto">The <code>&lt;time&gt;</code> argument can be an integer, with an optional time unit, like <code>s</code> (second), <code>ms</code> (millisecond), <code>m</code> (minute). The default time unit is <code>s</code>, i.e., "second". The default setting is <code>60s</code>.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_socket_log_errors</h2><a id="user-content-lua_socket_log_errors" class="anchor" aria-label="Permalink: lua_socket_log_errors" href="#lua_socket_log_errors"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_socket_log_errors on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_socket_log_errors on</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">This directive can be used to toggle error logging when a failure occurs for the TCP or UDP cosockets. If you are already doing proper error handling and logging in your Lua code, then it is recommended to turn this directive off to prevent data flushing in your Nginx error log files (which is usually rather expensive).</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.13</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_ciphers</h2><a id="user-content-lua_ssl_ciphers" class="anchor" aria-label="Permalink: lua_ssl_ciphers" href="#lua_ssl_ciphers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_ciphers &lt;ciphers&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_ssl_ciphers DEFAULT</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies the enabled ciphers for requests to a SSL/TLS server in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method. The ciphers are specified in the format understood by the OpenSSL library.</p>
<p dir="auto">The full list can be viewed using the “openssl ciphers” command.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_crl</h2><a id="user-content-lua_ssl_crl" class="anchor" aria-label="Permalink: lua_ssl_crl" href="#lua_ssl_crl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_crl &lt;file&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>no</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies a file with revoked certificates (CRL) in the PEM format used to verify the certificate of the SSL/TLS server in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_protocols</h2><a id="user-content-lua_ssl_protocols" class="anchor" aria-label="Permalink: lua_ssl_protocols" href="#lua_ssl_protocols"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2] [TLSv1.3]</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Enables the specified protocols for requests to a SSL/TLS server in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<p dir="auto">The support for the <code>TLSv1.3</code> parameter requires version <code>v0.10.12</code> <em>and</em> OpenSSL 1.1.1.
From version v0.10.25, the default value change from <code>SSLV3 TLSv1 TLSv1.1 TLSv1.2</code> to <code>TLSv1 TLSv1.1 TLSv1.2 TLSv1.3</code>.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_certificate</h2><a id="user-content-lua_ssl_certificate" class="anchor" aria-label="Permalink: lua_ssl_certificate" href="#lua_ssl_certificate"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_certificate &lt;file&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>none</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies the file path to the SSL/TLS certificate in PEM format used for the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<p dir="auto">This directive allows you to specify the SSL/TLS certificate that will be presented to server during the SSL/TLS handshake process.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.26</code> release.</p>
<p dir="auto">See also <a href="#lua_ssl_certificate_key">lua_ssl_certificate_key</a> and <a href="#lua_ssl_verify_depth">lua_ssl_verify_depth</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_certificate_key</h2><a id="user-content-lua_ssl_certificate_key" class="anchor" aria-label="Permalink: lua_ssl_certificate_key" href="#lua_ssl_certificate_key"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_certificate_key &lt;file&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>none</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies the file path to the private key associated with the SSL/TLS certificate used in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<p dir="auto">This directive allows you to specify the private key file corresponding to the SSL/TLS certificate specified by lua_ssl_certificate. The private key should be in PEM format and must match the certificate.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.26</code> release.</p>
<p dir="auto">See also <a href="#lua_ssl_certificate">lua_ssl_certificate</a> and <a href="#lua_ssl_verify_depth">lua_ssl_verify_depth</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_trusted_certificate</h2><a id="user-content-lua_ssl_trusted_certificate" class="anchor" aria-label="Permalink: lua_ssl_trusted_certificate" href="#lua_ssl_trusted_certificate"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_trusted_certificate &lt;file&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>none</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Specifies a file path with trusted CA certificates in the PEM format used to verify the certificate of the SSL/TLS server in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto">See also <a href="#lua_ssl_verify_depth">lua_ssl_verify_depth</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_verify_depth</h2><a id="user-content-lua_ssl_verify_depth" class="anchor" aria-label="Permalink: lua_ssl_verify_depth" href="#lua_ssl_verify_depth"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_verify_depth &lt;number&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_ssl_verify_depth 1</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Sets the verification depth in the server certificates chain.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto">See also <a href="#lua_ssl_certificate">lua_ssl_certificate</a>, <a href="#lua_ssl_certificate_key">lua_ssl_certificate_key</a> and <a href="#lua_ssl_trusted_certificate">lua_ssl_trusted_certificate</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_key_log</h2><a id="user-content-lua_ssl_key_log" class="anchor" aria-label="Permalink: lua_ssl_key_log" href="#lua_ssl_key_log"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_key_log &lt;file&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>none</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Enables logging of client connection SSL keys in the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method and specifies the path to the key log file. Keys are logged in the SSLKEYLOGFILE format compatible with Wireshark.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_ssl_conf_command</h2><a id="user-content-lua_ssl_conf_command" class="anchor" aria-label="Permalink: lua_ssl_conf_command" href="#lua_ssl_conf_command"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_ssl_conf_command &lt;command&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>no</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location</em></p>
<p dir="auto">Sets arbitrary OpenSSL configuration <a href="https://www.openssl.org/docs/man1.1.1/man3/SSL_CONF_cmd.html" rel="nofollow">commands</a>.</p>
<p dir="auto">The directive is supported when using OpenSSL 1.0.2 or higher and nginx 1.19.4 or higher. According to the specify command, higher OpenSSL version may be needed.</p>
<p dir="auto">Several <code>lua_ssl_conf_command</code> directives can be specified on the same level:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_ssl_conf_command Options PrioritizeChaCha;
 lua_ssl_conf_command Ciphersuites TLS_CHACHA20_POLY1305_SHA256;"><pre> lua_ssl_conf_command Options PrioritizeChaCha<span class="pl-c1">;</span>
 lua_ssl_conf_command Ciphersuites TLS_CHACHA20_POLY1305_SHA256<span class="pl-c1">;</span></pre></div>
<p dir="auto">Configuration commands are applied after OpenResty own configuration for SSL, so they can be used to override anything set by OpenResty.</p>
<p dir="auto">Note though that configuring OpenSSL directly with <code>lua_ssl_conf_command</code> might result in a behaviour OpenResty does not expect, and should be done with care.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.21</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_upstream_skip_openssl_default_verify</h2><a id="user-content-lua_upstream_skip_openssl_default_verify" class="anchor" aria-label="Permalink: lua_upstream_skip_openssl_default_verify" href="#lua_upstream_skip_openssl_default_verify"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_upstream_skip_openssl_default_verify on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_upstream_skip_openssl_default_verify off</em></p>
<p dir="auto"><strong>context:</strong> <em>location, location-if</em></p>
<p dir="auto">When using proxy_ssl_verify_by_lua directive, <code>lua_upstream_skip_openssl_default_verify</code> controls whether to skip default openssl's verify function, that means using pure Lua code to verify upstream server certificate.</p>
<p dir="auto">This directive is turned <code>off</code> by default.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_http10_buffering</h2><a id="user-content-lua_http10_buffering" class="anchor" aria-label="Permalink: lua_http10_buffering" href="#lua_http10_buffering"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_http10_buffering on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_http10_buffering on</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location-if</em></p>
<p dir="auto">Enables or disables automatic response buffering for HTTP 1.0 (or older) requests. This buffering mechanism is mainly used for HTTP 1.0 keep-alive which relies on a proper <code>Content-Length</code> response header.</p>
<p dir="auto">If the Lua code explicitly sets a <code>Content-Length</code> response header before sending the headers (either explicitly via <a href="#ngxsend_headers">ngx.send_headers</a> or implicitly via the first <a href="#ngxsay">ngx.say</a> or <a href="#ngxprint">ngx.print</a> call), then the HTTP 1.0 response buffering will be disabled even when this directive is turned on.</p>
<p dir="auto">To output very large response data in a streaming fashion (via the <a href="#ngxflush">ngx.flush</a> call, for example), this directive MUST be turned off to minimize memory usage.</p>
<p dir="auto">This directive is turned <code>on</code> by default.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc19</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">rewrite_by_lua_no_postpone</h2><a id="user-content-rewrite_by_lua_no_postpone" class="anchor" aria-label="Permalink: rewrite_by_lua_no_postpone" href="#rewrite_by_lua_no_postpone"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>rewrite_by_lua_no_postpone on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>rewrite_by_lua_no_postpone off</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Controls whether or not to disable postponing <a href="#rewrite_by_lua">rewrite_by_lua*</a> directives to run at the end of the <code>rewrite</code> request-processing phase. By default, this directive is turned off and the Lua code is postponed to run at the end of the <code>rewrite</code> phase.</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc29</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">access_by_lua_no_postpone</h2><a id="user-content-access_by_lua_no_postpone" class="anchor" aria-label="Permalink: access_by_lua_no_postpone" href="#access_by_lua_no_postpone"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>access_by_lua_no_postpone on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>access_by_lua_no_postpone off</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Controls whether or not to disable postponing <a href="#access_by_lua">access_by_lua*</a> directives to run at the end of the <code>access</code> request-processing phase. By default, this directive is turned off and the Lua code is postponed to run at the end of the <code>access</code> phase.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.20</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_transform_underscores_in_response_headers</h2><a id="user-content-lua_transform_underscores_in_response_headers" class="anchor" aria-label="Permalink: lua_transform_underscores_in_response_headers" href="#lua_transform_underscores_in_response_headers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_transform_underscores_in_response_headers on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_transform_underscores_in_response_headers on</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location-if</em></p>
<p dir="auto">Controls whether to transform underscores (<code>_</code>) in the response header names specified in the <a href="#ngxheaderheader">ngx.header.HEADER</a> API to hyphens (<code>-</code>).</p>
<p dir="auto">This directive was first introduced in the <code>v0.5.0rc32</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_check_client_abort</h2><a id="user-content-lua_check_client_abort" class="anchor" aria-label="Permalink: lua_check_client_abort" href="#lua_check_client_abort"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_check_client_abort on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_check_client_abort off</em></p>
<p dir="auto"><strong>context:</strong> <em>http, server, location, location-if</em></p>
<p dir="auto">This directive controls whether to check for premature client connection abortion.</p>
<p dir="auto">When this directive is on, the ngx_lua module will monitor the premature connection close event on the downstream connections and when there is such an event, it will call the user Lua function callback (registered by <a href="#ngxon_abort">ngx.on_abort</a>) or just stop and clean up all the Lua "light threads" running in the current request's request handler when there is no user callback function registered.</p>
<p dir="auto">According to the current implementation, however, if the client closes the connection before the Lua code finishes reading the request body data via <a href="#ngxreqsocket">ngx.req.socket</a>, then ngx_lua will neither stop all the running "light threads" nor call the user callback (if <a href="#ngxon_abort">ngx.on_abort</a> has been called). Instead, the reading operation on <a href="#ngxreqsocket">ngx.req.socket</a> will just return the error message "client aborted" as the second return value (the first return value is surely <code>nil</code>).</p>
<p dir="auto">When TCP keepalive is disabled, it is relying on the client side to close the socket gracefully (by sending a <code>FIN</code> packet or something like that). For (soft) real-time web applications, it is highly recommended to configure the <a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html" rel="nofollow">TCP keepalive</a> support in your system's TCP stack implementation in order to detect "half-open" TCP connections in time.</p>
<p dir="auto">For example, on Linux, you can configure the standard <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen" rel="nofollow">listen</a> directive in your <code>nginx.conf</code> file like this:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 listen 80 so_keepalive=2s:2s:8;"><pre> <span class="pl-c1">listen</span> <span class="pl-c1">80</span> so_keepalive=<span class="pl-c1">2s</span>:<span class="pl-c1">2s</span>:8<span class="pl-c1">;</span></pre></div>
<p dir="auto">On FreeBSD, you can only tune the system-wide configuration for TCP keepalive, for example:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# sysctl net.inet.tcp.keepintvl=2000
# sysctl net.inet.tcp.keepidle=2000"><pre class="notranslate"><code># sysctl net.inet.tcp.keepintvl=2000
# sysctl net.inet.tcp.keepidle=2000
</code></pre></div>
<p dir="auto">This directive was first introduced in the <code>v0.7.4</code> release.</p>
<p dir="auto">See also <a href="#ngxon_abort">ngx.on_abort</a>.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_max_pending_timers</h2><a id="user-content-lua_max_pending_timers" class="anchor" aria-label="Permalink: lua_max_pending_timers" href="#lua_max_pending_timers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_max_pending_timers &lt;count&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_max_pending_timers 1024</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Controls the maximum number of pending timers allowed.</p>
<p dir="auto">Pending timers are those timers that have not expired yet.</p>
<p dir="auto">When exceeding this limit, the <a href="#ngxtimerat">ngx.timer.at</a> call will immediately return <code>nil</code> and the error string "too many pending timers".</p>
<p dir="auto">This directive was first introduced in the <code>v0.8.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_max_running_timers</h2><a id="user-content-lua_max_running_timers" class="anchor" aria-label="Permalink: lua_max_running_timers" href="#lua_max_running_timers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_max_running_timers &lt;count&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_max_running_timers 256</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Controls the maximum number of "running timers" allowed.</p>
<p dir="auto">Running timers are those timers whose user callback functions are still running or <code>lightthreads</code> spawned in callback functions are still running.</p>
<p dir="auto">When exceeding this limit, Nginx will stop running the callbacks of newly expired timers and log an error message "N lua_max_running_timers are not enough" where "N" is the current value of this directive.</p>
<p dir="auto">This directive was first introduced in the <code>v0.8.0</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_sa_restart</h2><a id="user-content-lua_sa_restart" class="anchor" aria-label="Permalink: lua_sa_restart" href="#lua_sa_restart"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_sa_restart on|off</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_sa_restart on</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">When enabled, this module will set the <code>SA_RESTART</code> flag on Nginx workers signal dispositions.</p>
<p dir="auto">This allows Lua I/O primitives to not be interrupted by Nginx's handling of various signals.</p>
<p dir="auto">This directive was first introduced in the <code>v0.10.14</code> release.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">lua_worker_thread_vm_pool_size</h2><a id="user-content-lua_worker_thread_vm_pool_size" class="anchor" aria-label="Permalink: lua_worker_thread_vm_pool_size" href="#lua_worker_thread_vm_pool_size"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>lua_worker_thread_vm_pool_size &lt;size&gt;</em></p>
<p dir="auto"><strong>default:</strong> <em>lua_worker_thread_vm_pool_size 10</em></p>
<p dir="auto"><strong>context:</strong> <em>http</em></p>
<p dir="auto">Specifies the size limit of the Lua VM pool (default 100) that will be used in the <a href="#ngxrun_worker_thread">ngx.run_worker_thread</a> API.</p>
<p dir="auto">Also, it is not allowed to create Lua VMs that exceeds the pool size limit.</p>
<p dir="auto">The Lua VM in the VM pool is used to execute Lua code in separate thread.</p>
<p dir="auto">The pool is global at Nginx worker level. And it is used to reuse Lua VMs between requests.</p>
<p dir="auto"><strong>Warning:</strong> Each worker thread uses a separate Lua VM and caches the Lua VM for reuse in subsequent operations. Configuring too many worker threads can result in consuming a lot of memory.</p>
<p dir="auto"><a href="#directives">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Nginx API for Lua</h1><a id="user-content-nginx-api-for-lua" class="anchor" aria-label="Permalink: Nginx API for Lua" href="#nginx-api-for-lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#ngxarg">ngx.arg</a></li>
<li><a href="#ngxvarvariable">ngx.var.VARIABLE</a></li>
<li><a href="#core-constants">Core constants</a></li>
<li><a href="#http-method-constants">HTTP method constants</a></li>
<li><a href="#http-status-constants">HTTP status constants</a></li>
<li><a href="#nginx-log-level-constants">Nginx log level constants</a></li>
<li><a href="#print">print</a></li>
<li><a href="#ngxctx">ngx.ctx</a></li>
<li><a href="#ngxlocationcapture">ngx.location.capture</a></li>
<li><a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a></li>
<li><a href="#ngxstatus">ngx.status</a></li>
<li><a href="#ngxheaderheader">ngx.header.HEADER</a></li>
<li><a href="#ngxrespget_headers">ngx.resp.get_headers</a></li>
<li><a href="#ngxreqis_internal">ngx.req.is_internal</a></li>
<li><a href="#ngxreqstart_time">ngx.req.start_time</a></li>
<li><a href="#ngxreqhttp_version">ngx.req.http_version</a></li>
<li><a href="#ngxreqraw_header">ngx.req.raw_header</a></li>
<li><a href="#ngxreqget_method">ngx.req.get_method</a></li>
<li><a href="#ngxreqset_method">ngx.req.set_method</a></li>
<li><a href="#ngxreqset_uri">ngx.req.set_uri</a></li>
<li><a href="#ngxreqset_uri_args">ngx.req.set_uri_args</a></li>
<li><a href="#ngxreqget_uri_args">ngx.req.get_uri_args</a></li>
<li><a href="#ngxreqget_post_args">ngx.req.get_post_args</a></li>
<li><a href="#ngxreqget_headers">ngx.req.get_headers</a></li>
<li><a href="#ngxreqset_header">ngx.req.set_header</a></li>
<li><a href="#ngxreqclear_header">ngx.req.clear_header</a></li>
<li><a href="#ngxreqread_body">ngx.req.read_body</a></li>
<li><a href="#ngxreqdiscard_body">ngx.req.discard_body</a></li>
<li><a href="#ngxreqget_body_data">ngx.req.get_body_data</a></li>
<li><a href="#ngxreqget_body_file">ngx.req.get_body_file</a></li>
<li><a href="#ngxreqset_body_data">ngx.req.set_body_data</a></li>
<li><a href="#ngxreqset_body_file">ngx.req.set_body_file</a></li>
<li><a href="#ngxreqinit_body">ngx.req.init_body</a></li>
<li><a href="#ngxreqappend_body">ngx.req.append_body</a></li>
<li><a href="#ngxreqfinish_body">ngx.req.finish_body</a></li>
<li><a href="#ngxreqsocket">ngx.req.socket</a></li>
<li><a href="#ngxexec">ngx.exec</a></li>
<li><a href="#ngxredirect">ngx.redirect</a></li>
<li><a href="#ngxsend_headers">ngx.send_headers</a></li>
<li><a href="#ngxheaders_sent">ngx.headers_sent</a></li>
<li><a href="#ngxprint">ngx.print</a></li>
<li><a href="#ngxsay">ngx.say</a></li>
<li><a href="#ngxlog">ngx.log</a></li>
<li><a href="#ngxflush">ngx.flush</a></li>
<li><a href="#ngxexit">ngx.exit</a></li>
<li><a href="#ngxeof">ngx.eof</a></li>
<li><a href="#ngxsleep">ngx.sleep</a></li>
<li><a href="#ngxescape_uri">ngx.escape_uri</a></li>
<li><a href="#ngxunescape_uri">ngx.unescape_uri</a></li>
<li><a href="#ngxencode_args">ngx.encode_args</a></li>
<li><a href="#ngxdecode_args">ngx.decode_args</a></li>
<li><a href="#ngxencode_base64">ngx.encode_base64</a></li>
<li><a href="#ngxdecode_base64">ngx.decode_base64</a></li>
<li><a href="#ngxdecode_base64mime">ngx.decode_base64mime</a></li>
<li><a href="#ngxcrc32_short">ngx.crc32_short</a></li>
<li><a href="#ngxcrc32_long">ngx.crc32_long</a></li>
<li><a href="#ngxhmac_sha1">ngx.hmac_sha1</a></li>
<li><a href="#ngxmd5">ngx.md5</a></li>
<li><a href="#ngxmd5_bin">ngx.md5_bin</a></li>
<li><a href="#ngxsha1_bin">ngx.sha1_bin</a></li>
<li><a href="#ngxquote_sql_str">ngx.quote_sql_str</a></li>
<li><a href="#ngxtoday">ngx.today</a></li>
<li><a href="#ngxtime">ngx.time</a></li>
<li><a href="#ngxnow">ngx.now</a></li>
<li><a href="#ngxupdate_time">ngx.update_time</a></li>
<li><a href="#ngxlocaltime">ngx.localtime</a></li>
<li><a href="#ngxutctime">ngx.utctime</a></li>
<li><a href="#ngxcookie_time">ngx.cookie_time</a></li>
<li><a href="#ngxhttp_time">ngx.http_time</a></li>
<li><a href="#ngxparse_http_time">ngx.parse_http_time</a></li>
<li><a href="#ngxis_subrequest">ngx.is_subrequest</a></li>
<li><a href="#ngxrematch">ngx.re.match</a></li>
<li><a href="#ngxrefind">ngx.re.find</a></li>
<li><a href="#ngxregmatch">ngx.re.gmatch</a></li>
<li><a href="#ngxresub">ngx.re.sub</a></li>
<li><a href="#ngxregsub">ngx.re.gsub</a></li>
<li><a href="#ngxshareddict">ngx.shared.DICT</a></li>
<li><a href="#ngxshareddictget">ngx.shared.DICT.get</a></li>
<li><a href="#ngxshareddictget_stale">ngx.shared.DICT.get_stale</a></li>
<li><a href="#ngxshareddictset">ngx.shared.DICT.set</a></li>
<li><a href="#ngxshareddictsafe_set">ngx.shared.DICT.safe_set</a></li>
<li><a href="#ngxshareddictadd">ngx.shared.DICT.add</a></li>
<li><a href="#ngxshareddictsafe_add">ngx.shared.DICT.safe_add</a></li>
<li><a href="#ngxshareddictreplace">ngx.shared.DICT.replace</a></li>
<li><a href="#ngxshareddictdelete">ngx.shared.DICT.delete</a></li>
<li><a href="#ngxshareddictincr">ngx.shared.DICT.incr</a></li>
<li><a href="#ngxshareddictlpush">ngx.shared.DICT.lpush</a></li>
<li><a href="#ngxshareddictrpush">ngx.shared.DICT.rpush</a></li>
<li><a href="#ngxshareddictlpop">ngx.shared.DICT.lpop</a></li>
<li><a href="#ngxshareddictrpop">ngx.shared.DICT.rpop</a></li>
<li><a href="#ngxshareddictllen">ngx.shared.DICT.llen</a></li>
<li><a href="#ngxshareddictttl">ngx.shared.DICT.ttl</a></li>
<li><a href="#ngxshareddictexpire">ngx.shared.DICT.expire</a></li>
<li><a href="#ngxshareddictflush_all">ngx.shared.DICT.flush_all</a></li>
<li><a href="#ngxshareddictflush_expired">ngx.shared.DICT.flush_expired</a></li>
<li><a href="#ngxshareddictget_keys">ngx.shared.DICT.get_keys</a></li>
<li><a href="#ngxshareddictcapacity">ngx.shared.DICT.capacity</a></li>
<li><a href="#ngxshareddictfree_space">ngx.shared.DICT.free_space</a></li>
<li><a href="#ngxsocketudp">ngx.socket.udp</a></li>
<li><a href="#udpsockbind">udpsock:bind</a></li>
<li><a href="#udpsocksetpeername">udpsock:setpeername</a></li>
<li><a href="#udpsocksend">udpsock:send</a></li>
<li><a href="#udpsockreceive">udpsock:receive</a></li>
<li><a href="#udpsockclose">udpsock:close</a></li>
<li><a href="#udpsocksettimeout">udpsock:settimeout</a></li>
<li><a href="#ngxsocketstream">ngx.socket.stream</a></li>
<li><a href="#ngxsockettcp">ngx.socket.tcp</a></li>
<li><a href="#tcpsockbind">tcpsock:bind</a></li>
<li><a href="#tcpsockconnect">tcpsock:connect</a></li>
<li><a href="#getfd">tcpsock:getfd</a></li>
<li><a href="#tcpsocksetclientcert">tcpsock:setclientcert</a></li>
<li><a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a></li>
<li><a href="#tcpsocksend">tcpsock:send</a></li>
<li><a href="#tcpsockreceive">tcpsock:receive</a></li>
<li><a href="#tcpsockreceiveany">tcpsock:receiveany</a></li>
<li><a href="#tcpsockreceiveuntil">tcpsock:receiveuntil</a></li>
<li><a href="#tcpsockclose">tcpsock:close</a></li>
<li><a href="#tcpsocksettimeout">tcpsock:settimeout</a></li>
<li><a href="#tcpsocksettimeouts">tcpsock:settimeouts</a></li>
<li><a href="#tcpsocksetoption">tcpsock:setoption</a></li>
<li><a href="#tcpsocksetkeepalive">tcpsock:setkeepalive</a></li>
<li><a href="#tcpsockgetreusedtimes">tcpsock:getreusedtimes</a></li>
<li><a href="#ngxsocketconnect">ngx.socket.connect</a></li>
<li><a href="#ngxget_phase">ngx.get_phase</a></li>
<li><a href="#ngxthreadspawn">ngx.thread.spawn</a></li>
<li><a href="#ngxthreadwait">ngx.thread.wait</a></li>
<li><a href="#ngxthreadkill">ngx.thread.kill</a></li>
<li><a href="#ngxon_abort">ngx.on_abort</a></li>
<li><a href="#ngxtimerat">ngx.timer.at</a></li>
<li><a href="#ngxtimerevery">ngx.timer.every</a></li>
<li><a href="#ngxtimerrunning_count">ngx.timer.running_count</a></li>
<li><a href="#ngxtimerpending_count">ngx.timer.pending_count</a></li>
<li><a href="#ngxconfigsubsystem">ngx.config.subsystem</a></li>
<li><a href="#ngxconfigdebug">ngx.config.debug</a></li>
<li><a href="#ngxconfigprefix">ngx.config.prefix</a></li>
<li><a href="#ngxconfignginx_version">ngx.config.nginx_version</a></li>
<li><a href="#ngxconfignginx_configure">ngx.config.nginx_configure</a></li>
<li><a href="#ngxconfigngx_lua_version">ngx.config.ngx_lua_version</a></li>
<li><a href="#ngxworkerexiting">ngx.worker.exiting</a></li>
<li><a href="#ngxworkerpid">ngx.worker.pid</a></li>
<li><a href="#ngxworkerpids">ngx.worker.pids</a></li>
<li><a href="#ngxworkercount">ngx.worker.count</a></li>
<li><a href="#ngxworkerid">ngx.worker.id</a></li>
<li><a href="#ngxsemaphore">ngx.semaphore</a></li>
<li><a href="#ngxbalancer">ngx.balancer</a></li>
<li><a href="#ngxssl">ngx.ssl</a></li>
<li><a href="#ngxocsp">ngx.ocsp</a></li>
<li><a href="#ndkset_vardirective">ndk.set_var.DIRECTIVE</a></li>
<li><a href="#coroutinecreate">coroutine.create</a></li>
<li><a href="#coroutineresume">coroutine.resume</a></li>
<li><a href="#coroutineyield">coroutine.yield</a></li>
<li><a href="#coroutinewrap">coroutine.wrap</a></li>
<li><a href="#coroutinerunning">coroutine.running</a></li>
<li><a href="#coroutinestatus">coroutine.status</a></li>
<li><a href="#ngxrun_worker_thread">ngx.run_worker_thread</a></li>
</ul>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Introduction</h2><a id="user-content-introduction" class="anchor" aria-label="Permalink: Introduction" href="#introduction"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The various <code>*_by_lua</code>, <code>*_by_lua_block</code> and <code>*_by_lua_file</code> configuration directives serve as gateways to the Lua API within the <code>nginx.conf</code> file. The Nginx Lua API described below can only be called within the user Lua code run in the context of these configuration directives.</p>
<p dir="auto">The API is exposed to Lua in the form of two standard packages <code>ngx</code> and <code>ndk</code>. These packages are in the default global scope within ngx_lua and are always available within ngx_lua directives.</p>
<p dir="auto">The packages can be introduced into external Lua modules like this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local say = ngx.say

 local _M = {}

 function _M.foo(a)
     say(a)
 end

 return _M"><pre> <span class="pl-k">local</span> <span class="pl-smi">say</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">say</span>

 <span class="pl-k">local</span> <span class="pl-smi">_M</span> <span class="pl-k">=</span> {}

 <span class="pl-k">function</span> <span class="pl-en">_M</span>.<span class="pl-en">foo</span>(<span class="pl-smi">a</span>)
     <span class="pl-c1">say</span>(<span class="pl-smi">a</span>)
 <span class="pl-k">end</span>

 <span class="pl-k">return</span> <span class="pl-smi">_M</span></pre></div>
<p dir="auto">Use of the <a href="https://www.lua.org/manual/5.1/manual.html#pdf-package.seeall" rel="nofollow">package.seeall</a> flag is strongly discouraged due to its various bad side-effects.</p>
<p dir="auto">It is also possible to directly require the packages in external Lua modules:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local ngx = require &quot;ngx&quot;
 local ndk = require &quot;ndk&quot;"><pre> <span class="pl-k">local</span> <span class="pl-smi">ngx</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>ngx<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">ndk</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>ndk<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">The ability to require these packages was introduced in the <code>v0.2.1rc19</code> release.</p>
<p dir="auto">Network I/O operations in user code should only be done through the Nginx Lua API calls as the Nginx event loop may be blocked and performance drop off dramatically otherwise. Disk operations with relatively small amount of data can be done using the standard Lua <code>io</code> library but huge file reading and writing should be avoided wherever possible as they may block the Nginx process significantly. Delegating all network and disk I/O operations to Nginx's subrequests (via the <a href="#ngxlocationcapture">ngx.location.capture</a> method and similar) is strongly recommended for maximum performance.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.arg</h2><a id="user-content-ngxarg" class="anchor" aria-label="Permalink: ngx.arg" href="#ngxarg"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>val = ngx.arg[index]</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, body_filter_by_lua*</em></p>
<p dir="auto">When this is used in the context of the <a href="#set_by_lua">set_by_lua*</a> directives, this table is read-only and holds the input arguments to the config directives:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 value = ngx.arg[n]"><pre> <span class="pl-smi">value</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">arg</span>[<span class="pl-smi">n</span>]</pre></div>
<p dir="auto">Here is an example</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     set $a 32;
     set $b 56;

     set_by_lua $sum
         'return tonumber(ngx.arg[1]) + tonumber(ngx.arg[2])'
         $a $b;

     echo $sum;
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$a</span> <span class="pl-c1">32</span><span class="pl-c1">;</span>
     <span class="pl-c1">set</span> <span class="pl-v">$b</span> <span class="pl-c1">56</span><span class="pl-c1">;</span>

     set_by_lua <span class="pl-v">$sum</span>
         <span class="pl-s">'return tonumber(ngx.arg[1]) + tonumber(ngx.arg[2])'</span>
         <span class="pl-v">$a</span> <span class="pl-v">$b</span><span class="pl-c1">;</span>

     echo <span class="pl-v">$sum</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">that writes out <code>88</code>, the sum of <code>32</code> and <code>56</code>.</p>
<p dir="auto">When this table is used in the context of <a href="#body_filter_by_lua">body_filter_by_lua*</a>, the first element holds the input data chunk to the output filter code and the second element holds the boolean flag for the "eof" flag indicating the end of the whole output data stream.</p>
<p dir="auto">The data chunk and "eof" flag passed to the downstream Nginx output filters can also be overridden by assigning values directly to the corresponding table elements. When setting <code>nil</code> or an empty Lua string value to <code>ngx.arg[1]</code>, no data chunk will be passed to the downstream Nginx output filters at all.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.var.VARIABLE</h2><a id="user-content-ngxvarvariable" class="anchor" aria-label="Permalink: ngx.var.VARIABLE" href="#ngxvarvariable"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.var.VAR_NAME</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*</em></p>
<p dir="auto">Read and write Nginx variable values.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 value = ngx.var.some_nginx_variable_name
 ngx.var.some_nginx_variable_name = value"><pre> value = ngx.var.some_nginx_variable_name
 ngx.var.some_nginx_variable_name = value</pre></div>
<p dir="auto">Note that only already defined Nginx variables can be written to.
For example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     set $my_var ''; # this line is required to create $my_var at config time
     content_by_lua_block {
         ngx.var.my_var = 123
         ...
     }
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$my_var</span> <span class="pl-s">''</span><span class="pl-c1">;</span> # this line is required to create <span class="pl-v">$my_var</span> at config time
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.var.my_var = <span class="pl-c1">123</span>
         ...
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">That is, Nginx variables cannot be created on-the-fly. Here is a list of pre-defined
<a href="http://nginx.org/en/docs/varindex.html" rel="nofollow">Nginx variables</a>.</p>
<p dir="auto">Some special Nginx variables like <code>$args</code> and <code>$limit_rate</code> can be assigned a value,
many others are not, like <code>$query_string</code>, <code>$arg_PARAMETER</code>, and <code>$http_NAME</code>.</p>
<p dir="auto">Nginx regex group capturing variables <code>$1</code>, <code>$2</code>, <code>$3</code>, and etc, can be read by this
interface as well, by writing <code>ngx.var[1]</code>, <code>ngx.var[2]</code>, <code>ngx.var[3]</code>, and etc.</p>
<p dir="auto">Setting <code>ngx.var.Foo</code> to a <code>nil</code> value will unset the <code>$Foo</code> Nginx variable.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.var.args = nil"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">var</span>.<span class="pl-e">args</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span></pre></div>
<p dir="auto"><strong>CAUTION</strong> When reading from an Nginx variable, Nginx will allocate memory in the per-request memory pool which is freed only at request termination. So when you need to read from an Nginx variable repeatedly in your Lua code, cache the Nginx variable value to your own Lua variable, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local val = ngx.var.some_var
 --- use the val repeatedly later"><pre> <span class="pl-k">local</span> <span class="pl-smi">val</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">var</span>.<span class="pl-e">some_var</span>
 <span class="pl-c"><span class="pl-c">---</span> use the val repeatedly later</span></pre></div>
<p dir="auto">to prevent (temporary) memory leaking within the current request's lifetime. Another way of caching the result is to use the <a href="#ngxctx">ngx.ctx</a> table.</p>
<p dir="auto">Undefined Nginx variables are evaluated to <code>nil</code> while uninitialized (but defined) Nginx variables are evaluated to an empty Lua string.</p>
<p dir="auto">This API requires a relatively expensive metamethod call and it is recommended to avoid using it on hot code paths.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Core constants</h2><a id="user-content-core-constants" class="anchor" aria-label="Permalink: Core constants" href="#core-constants"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, *log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
   ngx.OK (0)
   ngx.ERROR (-1)
   ngx.AGAIN (-2)
   ngx.DONE (-4)
   ngx.DECLINED (-5)"><pre>   <span class="pl-smi">ngx</span>.<span class="pl-c1">OK</span> (<span class="pl-c1">0</span>)
   <span class="pl-smi">ngx</span>.<span class="pl-c1">ERROR</span> (<span class="pl-k">-</span><span class="pl-c1">1</span>)
   <span class="pl-smi">ngx</span>.<span class="pl-c1">AGAIN</span> (<span class="pl-k">-</span><span class="pl-c1">2</span>)
   <span class="pl-smi">ngx</span>.<span class="pl-c1">DONE</span> (<span class="pl-k">-</span><span class="pl-c1">4</span>)
   <span class="pl-smi">ngx</span>.<span class="pl-c1">DECLINED</span> (<span class="pl-k">-</span><span class="pl-c1">5</span>)</pre></div>
<p dir="auto">Note that only three of these constants are utilized by the <a href="#nginx-api-for-lua">Nginx API for Lua</a> (i.e., <a href="#ngxexit">ngx.exit</a> accepts <code>ngx.OK</code>, <code>ngx.ERROR</code>, and <code>ngx.DECLINED</code> as input).</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
   ngx.null"><pre>   <span class="pl-smi">ngx</span>.<span class="pl-e">null</span></pre></div>
<p dir="auto">The <code>ngx.null</code> constant is a <code>NULL</code> light userdata usually used to represent nil values in Lua tables etc and is similar to the <a href="http://www.kyne.com.au/~mark/software/lua-cjson.php" rel="nofollow">lua-cjson</a> library's <code>cjson.null</code> constant. This constant was first introduced in the <code>v0.5.0rc5</code> release.</p>
<p dir="auto">The <code>ngx.DECLINED</code> constant was first introduced in the <code>v0.5.0rc19</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">HTTP method constants</h2><a id="user-content-http-method-constants" class="anchor" aria-label="Permalink: HTTP method constants" href="#http-method-constants"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="  ngx.HTTP_GET
  ngx.HTTP_HEAD
  ngx.HTTP_PUT
  ngx.HTTP_POST
  ngx.HTTP_DELETE
  ngx.HTTP_OPTIONS   (added in the v0.5.0rc24 release)
  ngx.HTTP_MKCOL     (added in the v0.8.2 release)
  ngx.HTTP_COPY      (added in the v0.8.2 release)
  ngx.HTTP_MOVE      (added in the v0.8.2 release)
  ngx.HTTP_PROPFIND  (added in the v0.8.2 release)
  ngx.HTTP_PROPPATCH (added in the v0.8.2 release)
  ngx.HTTP_LOCK      (added in the v0.8.2 release)
  ngx.HTTP_UNLOCK    (added in the v0.8.2 release)
  ngx.HTTP_PATCH     (added in the v0.8.2 release)
  ngx.HTTP_TRACE     (added in the v0.8.2 release)"><pre class="notranslate"><code>  ngx.HTTP_GET
  ngx.HTTP_HEAD
  ngx.HTTP_PUT
  ngx.HTTP_POST
  ngx.HTTP_DELETE
  ngx.HTTP_OPTIONS   (added in the v0.5.0rc24 release)
  ngx.HTTP_MKCOL     (added in the v0.8.2 release)
  ngx.HTTP_COPY      (added in the v0.8.2 release)
  ngx.HTTP_MOVE      (added in the v0.8.2 release)
  ngx.HTTP_PROPFIND  (added in the v0.8.2 release)
  ngx.HTTP_PROPPATCH (added in the v0.8.2 release)
  ngx.HTTP_LOCK      (added in the v0.8.2 release)
  ngx.HTTP_UNLOCK    (added in the v0.8.2 release)
  ngx.HTTP_PATCH     (added in the v0.8.2 release)
  ngx.HTTP_TRACE     (added in the v0.8.2 release)
</code></pre></div>
<p dir="auto">These constants are usually used in <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> method calls.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">HTTP status constants</h2><a id="user-content-http-status-constants" class="anchor" aria-label="Permalink: HTTP status constants" href="#http-status-constants"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
   value = ngx.HTTP_CONTINUE (100) (first added in the v0.9.20 release)
   value = ngx.HTTP_SWITCHING_PROTOCOLS (101) (first added in the v0.9.20 release)
   value = ngx.HTTP_OK (200)
   value = ngx.HTTP_CREATED (201)
   value = ngx.HTTP_ACCEPTED (202) (first added in the v0.9.20 release)
   value = ngx.HTTP_NO_CONTENT (204) (first added in the v0.9.20 release)
   value = ngx.HTTP_PARTIAL_CONTENT (206) (first added in the v0.9.20 release)
   value = ngx.HTTP_SPECIAL_RESPONSE (300)
   value = ngx.HTTP_MOVED_PERMANENTLY (301)
   value = ngx.HTTP_MOVED_TEMPORARILY (302)
   value = ngx.HTTP_SEE_OTHER (303)
   value = ngx.HTTP_NOT_MODIFIED (304)
   value = ngx.HTTP_TEMPORARY_REDIRECT (307) (first added in the v0.9.20 release)
   value = ngx.HTTP_PERMANENT_REDIRECT (308)
   value = ngx.HTTP_BAD_REQUEST (400)
   value = ngx.HTTP_UNAUTHORIZED (401)
   value = ngx.HTTP_PAYMENT_REQUIRED (402) (first added in the v0.9.20 release)
   value = ngx.HTTP_FORBIDDEN (403)
   value = ngx.HTTP_NOT_FOUND (404)
   value = ngx.HTTP_NOT_ALLOWED (405)
   value = ngx.HTTP_NOT_ACCEPTABLE (406) (first added in the v0.9.20 release)
   value = ngx.HTTP_REQUEST_TIMEOUT (408) (first added in the v0.9.20 release)
   value = ngx.HTTP_CONFLICT (409) (first added in the v0.9.20 release)
   value = ngx.HTTP_GONE (410)
   value = ngx.HTTP_UPGRADE_REQUIRED (426) (first added in the v0.9.20 release)
   value = ngx.HTTP_TOO_MANY_REQUESTS (429) (first added in the v0.9.20 release)
   value = ngx.HTTP_CLOSE (444) (first added in the v0.9.20 release)
   value = ngx.HTTP_ILLEGAL (451) (first added in the v0.9.20 release)
   value = ngx.HTTP_INTERNAL_SERVER_ERROR (500)
   value = ngx.HTTP_NOT_IMPLEMENTED (501)
   value = ngx.HTTP_METHOD_NOT_IMPLEMENTED (501) (kept for compatibility)
   value = ngx.HTTP_BAD_GATEWAY (502) (first added in the v0.9.20 release)
   value = ngx.HTTP_SERVICE_UNAVAILABLE (503)
   value = ngx.HTTP_GATEWAY_TIMEOUT (504) (first added in the v0.3.1rc38 release)
   value = ngx.HTTP_VERSION_NOT_SUPPORTED (505) (first added in the v0.9.20 release)
   value = ngx.HTTP_INSUFFICIENT_STORAGE (507) (first added in the v0.9.20 release)"><pre>   value = ngx.HTTP_CONTINUE <span class="pl-c1">(</span><span class="pl-c1">100</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_SWITCHING_PROTOCOLS <span class="pl-c1">(</span><span class="pl-c1">101</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_OK <span class="pl-c1">(</span><span class="pl-c1">200</span><span class="pl-c1">)</span>
   value = ngx.HTTP_CREATED <span class="pl-c1">(</span><span class="pl-c1">201</span><span class="pl-c1">)</span>
   value = ngx.HTTP_ACCEPTED <span class="pl-c1">(</span><span class="pl-c1">202</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_NO_CONTENT <span class="pl-c1">(</span><span class="pl-c1">204</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_PARTIAL_CONTENT <span class="pl-c1">(</span><span class="pl-c1">206</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_SPECIAL_RESPONSE <span class="pl-c1">(</span><span class="pl-c1">300</span><span class="pl-c1">)</span>
   value = ngx.HTTP_MOVED_PERMANENTLY <span class="pl-c1">(</span><span class="pl-c1">301</span><span class="pl-c1">)</span>
   value = ngx.HTTP_MOVED_TEMPORARILY <span class="pl-c1">(</span><span class="pl-c1">302</span><span class="pl-c1">)</span>
   value = ngx.HTTP_SEE_OTHER <span class="pl-c1">(</span><span class="pl-c1">303</span><span class="pl-c1">)</span>
   value = ngx.HTTP_NOT_MODIFIED <span class="pl-c1">(</span><span class="pl-c1">304</span><span class="pl-c1">)</span>
   value = ngx.HTTP_TEMPORARY_REDIRECT <span class="pl-c1">(</span><span class="pl-c1">307</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_PERMANENT_REDIRECT <span class="pl-c1">(</span><span class="pl-c1">308</span><span class="pl-c1">)</span>
   value = ngx.HTTP_BAD_REQUEST <span class="pl-c1">(</span><span class="pl-c1">400</span><span class="pl-c1">)</span>
   value = ngx.HTTP_UNAUTHORIZED <span class="pl-c1">(</span><span class="pl-c1">401</span><span class="pl-c1">)</span>
   value = ngx.HTTP_PAYMENT_REQUIRED <span class="pl-c1">(</span><span class="pl-c1">402</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_FORBIDDEN <span class="pl-c1">(</span><span class="pl-c1">403</span><span class="pl-c1">)</span>
   value = ngx.HTTP_NOT_FOUND <span class="pl-c1">(</span><span class="pl-c1">404</span><span class="pl-c1">)</span>
   value = ngx.HTTP_NOT_ALLOWED <span class="pl-c1">(</span><span class="pl-c1">405</span><span class="pl-c1">)</span>
   value = ngx.HTTP_NOT_ACCEPTABLE <span class="pl-c1">(</span><span class="pl-c1">406</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_REQUEST_TIMEOUT <span class="pl-c1">(</span><span class="pl-c1">408</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_CONFLICT <span class="pl-c1">(</span><span class="pl-c1">409</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_GONE <span class="pl-c1">(</span><span class="pl-c1">410</span><span class="pl-c1">)</span>
   value = ngx.HTTP_UPGRADE_REQUIRED <span class="pl-c1">(</span><span class="pl-c1">426</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_TOO_MANY_REQUESTS <span class="pl-c1">(</span><span class="pl-c1">429</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_CLOSE <span class="pl-c1">(</span><span class="pl-c1">444</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_ILLEGAL <span class="pl-c1">(</span><span class="pl-c1">451</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_INTERNAL_SERVER_ERROR <span class="pl-c1">(</span><span class="pl-c1">500</span><span class="pl-c1">)</span>
   value = ngx.HTTP_NOT_IMPLEMENTED <span class="pl-c1">(</span><span class="pl-c1">501</span><span class="pl-c1">)</span>
   value = ngx.HTTP_METHOD_NOT_IMPLEMENTED <span class="pl-c1">(</span><span class="pl-c1">501</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>kept <span class="pl-k">for</span> compatibility<span class="pl-c1">)</span>
   value = ngx.HTTP_BAD_GATEWAY <span class="pl-c1">(</span><span class="pl-c1">502</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_SERVICE_UNAVAILABLE <span class="pl-c1">(</span><span class="pl-c1">503</span><span class="pl-c1">)</span>
   value = ngx.HTTP_GATEWAY_TIMEOUT <span class="pl-c1">(</span><span class="pl-c1">504</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.3.<span class="pl-c1">1rc38</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_VERSION_NOT_SUPPORTED <span class="pl-c1">(</span><span class="pl-c1">505</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span>
   value = ngx.HTTP_INSUFFICIENT_STORAGE <span class="pl-c1">(</span><span class="pl-c1">507</span><span class="pl-c1">)</span> <span class="pl-c1">(</span>first added in the v0.9.<span class="pl-c1">20</span> release<span class="pl-c1">)</span></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Nginx log level constants</h2><a id="user-content-nginx-log-level-constants" class="anchor" aria-label="Permalink: Nginx log level constants" href="#nginx-log-level-constants"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
   ngx.STDERR
   ngx.EMERG
   ngx.ALERT
   ngx.CRIT
   ngx.ERR
   ngx.WARN
   ngx.NOTICE
   ngx.INFO
   ngx.DEBUG"><pre>   <span class="pl-smi">ngx</span>.<span class="pl-e">STDERR</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">EMERG</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">ALERT</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">CRIT</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">WARN</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">NOTICE</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">INFO</span>
   <span class="pl-smi">ngx</span>.<span class="pl-e">DEBUG</span></pre></div>
<p dir="auto">These constants are usually used by the <a href="#ngxlog">ngx.log</a> method.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">print</h2><a id="user-content-print" class="anchor" aria-label="Permalink: print" href="#print"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>print(...)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Writes argument values into the Nginx <code>error.log</code> file with the <code>ngx.NOTICE</code> log level.</p>
<p dir="auto">It is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.log(ngx.NOTICE, ...)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">NOTICE</span>, <span class="pl-c1">...</span>)</pre></div>
<p dir="auto">Lua <code>nil</code> arguments are accepted and result in literal <code>"nil"</code> strings while Lua booleans result in literal <code>"true"</code> or <code>"false"</code> strings. And the <code>ngx.null</code> constant will yield the <code>"null"</code> string output.</p>
<p dir="auto">There is a hard coded <code>2048</code> byte limitation on error message lengths in the Nginx core. This limit includes trailing newlines and leading time stamps. If the message size exceeds this limit, Nginx will truncate the message text accordingly. This limit can be manually modified by editing the <code>NGX_MAX_ERROR_STR</code> macro definition in the <code>src/core/ngx_log.h</code> file in the Nginx source tree.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.ctx</h2><a id="user-content-ngxctx" class="anchor" aria-label="Permalink: ngx.ctx" href="#ngxctx"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This table can be used to store per-request Lua context data and has a life time identical to the current request (as with the Nginx variables).</p>
<p dir="auto">Consider the following example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     rewrite_by_lua_block {
         ngx.ctx.foo = 76
     }
     access_by_lua_block {
         ngx.ctx.foo = ngx.ctx.foo + 3
     }
     content_by_lua_block {
         ngx.say(ngx.ctx.foo)
     }
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.foo = <span class="pl-c1">76</span>
     <span class="pl-c1">}</span>
     access_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.foo = ngx.ctx.foo + 3
     <span class="pl-c1">}</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span>ngx.ctx.foo<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then <code>GET /test</code> will yield the output</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 79"><pre> 79</pre></div>
<p dir="auto">That is, the <code>ngx.ctx.foo</code> entry persists across the rewrite, access, and content phases of a request.</p>
<p dir="auto">Every request, including subrequests, has its own copy of the table. For example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /sub {
     content_by_lua_block {
         ngx.say(&quot;sub pre: &quot;, ngx.ctx.blah)
         ngx.ctx.blah = 32
         ngx.say(&quot;sub post: &quot;, ngx.ctx.blah)
     }
 }

 location /main {
     content_by_lua_block {
         ngx.ctx.blah = 73
         ngx.say(&quot;main pre: &quot;, ngx.ctx.blah)
         local res = ngx.location.capture(&quot;/sub&quot;)
         ngx.print(res.body)
         ngx.say(&quot;main post: &quot;, ngx.ctx.blah)
     }
 }"><pre> <span class="pl-c1">location</span> /sub <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"sub pre: "</span>, ngx.ctx.blah<span class="pl-c1">)</span>
         ngx.ctx.blah = <span class="pl-c1">32</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"sub post: "</span>, ngx.ctx.blah<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /main <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.blah = <span class="pl-c1">73</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"main pre: "</span>, ngx.ctx.blah<span class="pl-c1">)</span>
         local res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/sub"</span><span class="pl-c1">)</span>
         ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"main post: "</span>, ngx.ctx.blah<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then <code>GET /main</code> will give the output</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 main pre: 73
 sub pre: nil
 sub post: 32
 main post: 73"><pre> main pre: 73
 sub pre: nil
 sub post: 32
 main post: 73</pre></div>
<p dir="auto">Here, modification of the <code>ngx.ctx.blah</code> entry in the subrequest does not affect the one in the parent request. This is because they have two separate versions of <code>ngx.ctx.blah</code>.</p>
<p dir="auto">Internal redirects (triggered by nginx configuration directives like <code>error_page</code>, <code>try_files</code>, <code>index</code>, etc.) will destroy the original request <code>ngx.ctx</code> data (if any) and the new request will have an empty <code>ngx.ctx</code> table. For instance,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /new {
     content_by_lua_block {
         ngx.say(ngx.ctx.foo)
     }
 }

 location /orig {
     content_by_lua_block {
         ngx.ctx.foo = &quot;hello&quot;
         ngx.exec(&quot;/new&quot;)
     }
 }"><pre> <span class="pl-c1">location</span> /new <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span>ngx.ctx.foo<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /orig <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.foo = <span class="pl-s">"hello"</span>
         ngx.exec<span class="pl-c1">(</span><span class="pl-s">"/new"</span><span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then <code>GET /orig</code> will give</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 nil"><pre> nil</pre></div>
<p dir="auto">rather than the original <code>"hello"</code> value.</p>
<p dir="auto">Because HTTP request is created after SSL handshake, the <code>ngx.ctx</code> created
in <a href="#ssl_certificate_by_lua">ssl_certificate_by_lua*</a>, <a href="#ssl_session_store_by_lua">ssl_session_store_by_lua*</a>, <a href="#ssl_session_fetch_by_lua">ssl_session_fetch_by_lua*</a> and <a href="#ssl_client_hello_by_lua">ssl_client_hello_by_lua*</a>
is not available in the following phases like <a href="#rewrite_by_lua">rewrite_by_lua*</a>.</p>
<p dir="auto">Since <code>v0.10.18</code>, the <code>ngx.ctx</code> created during a SSL handshake
will be inherited by the requests which share the same TCP connection established by the handshake.
Note that overwrite values in <code>ngx.ctx</code> in the http request phases (like <code>rewrite_by_lua*</code>) will only take affect in the current http request.</p>
<p dir="auto">Arbitrary data values, including Lua closures and nested tables, can be inserted into this "magic" table. It also allows the registration of custom meta methods.</p>
<p dir="auto">Overriding <code>ngx.ctx</code> with a new Lua table is also supported, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.ctx = { foo = 32, bar = 54 }"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">ctx</span> <span class="pl-k">=</span> { <span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">32</span>, <span class="pl-smi">bar</span> <span class="pl-k">=</span> <span class="pl-c1">54</span> }</pre></div>
<p dir="auto">When being used in the context of <a href="#init_worker_by_lua">init_worker_by_lua*</a>, this table just has the same lifetime of the current Lua handler.</p>
<p dir="auto">The <code>ngx.ctx</code> lookup requires relatively expensive metamethod calls and it is much slower than explicitly passing per-request data along by your own function arguments. So do not abuse this API for saving your own function arguments because it usually has quite some performance impact.</p>
<p dir="auto">Because of the metamethod magic, never "local" the <code>ngx.ctx</code> table outside your Lua function scope on the Lua module level due to <a href="#data-sharing-within-an-nginx-worker">worker-level data sharing</a>. For example, the following is bad:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- mymodule.lua
 local _M = {}

 -- the following line is bad since ngx.ctx is a per-request
 -- data while this &lt;code&gt;ctx&lt;/code&gt; variable is on the Lua module level
 -- and thus is per-nginx-worker.
 local ctx = ngx.ctx

 function _M.main()
     ctx.foo = &quot;bar&quot;
 end

 return _M"><pre> <span class="pl-c"><span class="pl-c">--</span> mymodule.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">_M</span> <span class="pl-k">=</span> {}

 <span class="pl-c"><span class="pl-c">--</span> the following line is bad since ngx.ctx is a per-request</span>
 <span class="pl-c"><span class="pl-c">--</span> data while this &lt;code&gt;ctx&lt;/code&gt; variable is on the Lua module level</span>
 <span class="pl-c"><span class="pl-c">--</span> and thus is per-nginx-worker.</span>
 <span class="pl-k">local</span> <span class="pl-smi">ctx</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">ctx</span>

 <span class="pl-k">function</span> <span class="pl-en">_M</span>.<span class="pl-en">main</span>()
     <span class="pl-smi">ctx</span>.<span class="pl-e">foo</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>

 <span class="pl-k">return</span> <span class="pl-smi">_M</span></pre></div>
<p dir="auto">Use the following instead:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- mymodule.lua
 local _M = {}

 function _M.main(ctx)
     ctx.foo = &quot;bar&quot;
 end

 return _M"><pre> <span class="pl-c"><span class="pl-c">--</span> mymodule.lua</span>
 <span class="pl-k">local</span> <span class="pl-smi">_M</span> <span class="pl-k">=</span> {}

 <span class="pl-k">function</span> <span class="pl-en">_M</span>.<span class="pl-en">main</span>(<span class="pl-smi">ctx</span>)
     <span class="pl-smi">ctx</span>.<span class="pl-e">foo</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>

 <span class="pl-k">return</span> <span class="pl-smi">_M</span></pre></div>
<p dir="auto">That is, let the caller pass the <code>ctx</code> table explicitly via a function argument.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.location.capture</h2><a id="user-content-ngxlocationcapture" class="anchor" aria-label="Permalink: ngx.location.capture" href="#ngxlocationcapture"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>res = ngx.location.capture(uri, options?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Issues a synchronous but still non-blocking <em>Nginx Subrequest</em> using <code>uri</code>.</p>
<p dir="auto">Nginx's subrequests provide a powerful way to make non-blocking internal requests to other locations configured with disk file directory or <em>any</em> other Nginx C modules like <code>ngx_proxy</code>, <code>ngx_fastcgi</code>, <code>ngx_memc</code>,
<code>ngx_postgres</code>, <code>ngx_drizzle</code>, and even ngx_lua itself and etc etc etc.</p>
<p dir="auto">Also note that subrequests just mimic the HTTP interface but there is <em>no</em> extra HTTP/TCP traffic <em>nor</em> IPC involved. Everything works internally, efficiently, on the C level.</p>
<p dir="auto">Subrequests are completely different from HTTP 301/302 redirection (via <a href="#ngxredirect">ngx.redirect</a>) and internal redirection (via <a href="#ngxexec">ngx.exec</a>).</p>
<p dir="auto">You should always read the request body (by either calling <a href="#ngxreqread_body">ngx.req.read_body</a> or configuring <a href="#lua_need_request_body">lua_need_request_body</a> on) before initiating a subrequest.</p>
<p dir="auto">This API function (as well as <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>) always buffers the whole response body of the subrequest in memory. Thus, you should use <a href="#ngxsockettcp">cosockets</a>
and streaming processing instead if you have to handle large subrequest responses.</p>
<p dir="auto">Here is a basic example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 res = ngx.location.capture(uri)"><pre> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-smi">uri</span>)</pre></div>
<p dir="auto">Returns a Lua table with 4 slots: <code>res.status</code>, <code>res.header</code>, <code>res.body</code>, and <code>res.truncated</code>.</p>
<p dir="auto"><code>res.status</code> holds the response status code for the subrequest response.</p>
<p dir="auto"><code>res.header</code> holds all the response headers of the
subrequest and it is a normal Lua table. For multi-value response headers,
the value is a Lua (array) table that holds all the values in the order that
they appear. For instance, if the subrequest response headers contain the following
lines:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 Set-Cookie: a=3
 Set-Cookie: foo=bar
 Set-Cookie: baz=blah"><pre> Set-Cookie: a=3
 Set-Cookie: foo=bar
 Set-Cookie: baz=blah</pre></div>
<p dir="auto">Then <code>res.header["Set-Cookie"]</code> will be evaluated to the table value
<code>{"a=3", "foo=bar", "baz=blah"}</code>.</p>
<p dir="auto"><code>res.body</code> holds the subrequest's response body data, which might be truncated. You always need to check the <code>res.truncated</code> boolean flag to see if <code>res.body</code> contains truncated data. The data truncation here can only be caused by those unrecoverable errors in your subrequests like the cases that the remote end aborts the connection prematurely in the middle of the response body data stream or a read timeout happens when your subrequest is receiving the response body data from the remote.</p>
<p dir="auto">URI query strings can be concatenated to URI itself, for instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 res = ngx.location.capture('/foo/bar?a=3&amp;b=4')"><pre> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo/bar?a=3&amp;b=4<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">Named locations like <code>@foo</code> are not allowed due to a limitation in
the Nginx core. Use normal locations combined with the <code>internal</code> directive to
prepare internal-only locations.</p>
<p dir="auto">An optional option table can be fed as the second
argument, which supports the options:</p>
<ul dir="auto">
<li><code>method</code>
specify the subrequest's request method, which only accepts constants like <code>ngx.HTTP_POST</code>.</li>
<li><code>body</code>
specify the subrequest's request body (string value only).</li>
<li><code>args</code>
specify the subrequest's URI query arguments (both string value and Lua tables are accepted)</li>
<li><code>headers</code>
specify the subrequest's request headers (Lua table only). this headers will override the original headers of the subrequest.</li>
<li><code>ctx</code>
specify a Lua table to be the <a href="#ngxctx">ngx.ctx</a> table for the subrequest. It can be the current request's <a href="#ngxctx">ngx.ctx</a> table, which effectively makes the parent and its subrequest to share exactly the same context table. This option was first introduced in the <code>v0.3.1rc25</code> release.</li>
<li><code>vars</code>
take a Lua table which holds the values to set the specified Nginx variables in the subrequest as this option's value. This option was first introduced in the <code>v0.3.1rc31</code> release.</li>
<li><code>copy_all_vars</code>
specify whether to copy over all the Nginx variable values of the current request to the subrequest in question. modifications of the Nginx variables in the subrequest will not affect the current (parent) request. This option was first introduced in the <code>v0.3.1rc31</code> release.</li>
<li><code>share_all_vars</code>
specify whether to share all the Nginx variables of the subrequest with the current (parent) request. modifications of the Nginx variables in the subrequest will affect the current (parent) request. Enabling this option may lead to hard-to-debug issues due to bad side-effects and is considered bad and harmful. Only enable this option when you completely know what you are doing.</li>
<li><code>always_forward_body</code>
when set to true, the current (parent) request's request body will always be forwarded to the subrequest being created if the <code>body</code> option is not specified. The request body read by either <a href="#ngxreqread_body">ngx.req.read_body()</a> or <a href="#lua_need_request_body">lua_need_request_body on</a> will be directly forwarded to the subrequest without copying the whole request body data when creating the subrequest (no matter the request body data is buffered in memory buffers or temporary files). By default, this option is <code>false</code> and when the <code>body</code> option is not specified, the request body of the current (parent) request is only forwarded when the subrequest takes the <code>PUT</code> or <code>POST</code> request method.</li>
</ul>
<p dir="auto">Issuing a POST subrequest, for example, can be done as follows</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 res = ngx.location.capture(
     '/foo/bar',
     { method = ngx.HTTP_POST, body = 'hello, world' }
 )"><pre> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(
     <span class="pl-s"><span class="pl-pds">'</span>/foo/bar<span class="pl-pds">'</span></span>,
     { <span class="pl-smi">method</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_POST</span>, <span class="pl-smi">body</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>hello, world<span class="pl-pds">' </span></span>}
 )</pre></div>
<p dir="auto">See HTTP method constants methods other than POST.
The <code>method</code> option is <code>ngx.HTTP_GET</code> by default.</p>
<p dir="auto">The <code>args</code> option can specify extra URI arguments, for instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.location.capture('/foo?a=1',
     { args = { b = 3, c = ':' } }
 )"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo?a=1<span class="pl-pds">'</span></span>,
     { <span class="pl-smi">args</span> <span class="pl-k">=</span> { <span class="pl-smi">b</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, <span class="pl-smi">c</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>:<span class="pl-pds">' </span></span>} }
 )</pre></div>
<p dir="auto">is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.location.capture('/foo?a=1&amp;b=3&amp;c=%3a')"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo?a=1&amp;b=3&amp;c=%3a<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">that is, this method will escape argument keys and values according to URI rules and
concatenate them together into a complete query string. The format for the Lua table passed as the <code>args</code> argument is identical to the format used in the <a href="#ngxencode_args">ngx.encode_args</a> method.</p>
<p dir="auto">The <code>args</code> option can also take plain query strings:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.location.capture('/foo?a=1',
     { args = 'b=3&amp;c=%3a' }
 )"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo?a=1<span class="pl-pds">'</span></span>,
     { <span class="pl-smi">args</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>b=3&amp;c=%3a<span class="pl-pds">' </span></span>}
 )</pre></div>
<p dir="auto">This is functionally identical to the previous examples.</p>
<p dir="auto">The <code>share_all_vars</code> option controls whether to share Nginx variables among the current request and its subrequests.
If this option is set to <code>true</code>, then the current request and associated subrequests will share the same Nginx variable scope. Hence, changes to Nginx variables made by a subrequest will affect the current request.</p>
<p dir="auto">Care should be taken in using this option as variable scope sharing can have unexpected side effects. The <code>args</code>, <code>vars</code>, or <code>copy_all_vars</code> options are generally preferable instead.</p>
<p dir="auto">This option is set to <code>false</code> by default</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /other {
     set $dog &quot;$dog world&quot;;
     echo &quot;$uri dog: $dog&quot;;
 }

 location /lua {
     set $dog 'hello';
     content_by_lua_block {
         res = ngx.location.capture(&quot;/other&quot;,
             { share_all_vars = true })

         ngx.print(res.body)
         ngx.say(ngx.var.uri, &quot;: &quot;, ngx.var.dog)
     }
 }"><pre> <span class="pl-c1">location</span> /other <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$dog</span> <span class="pl-s">"$dog world"</span><span class="pl-c1">;</span>
     echo <span class="pl-s">"$uri dog: $dog"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$dog</span> <span class="pl-s">'hello'</span><span class="pl-c1">;</span>
     content_by_lua_block <span class="pl-c1">{</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/other"</span>,
             <span class="pl-c1">{</span> share_all_vars = true <span class="pl-c1">}</span><span class="pl-c1">)</span>

         ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span>ngx.var.uri, <span class="pl-s">": "</span>, ngx.var.dog<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Accessing location <code>/lua</code> gives</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="/other dog: hello world
/lua: hello world"><pre class="notranslate"><code>/other dog: hello world
/lua: hello world
</code></pre></div>
<p dir="auto">The <code>copy_all_vars</code> option provides a copy of the parent request's Nginx variables to subrequests when such subrequests are issued. Changes made to these variables by such subrequests will not affect the parent request or any other subrequests sharing the parent request's variables.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /other {
     set $dog &quot;$dog world&quot;;
     echo &quot;$uri dog: $dog&quot;;
 }

 location /lua {
     set $dog 'hello';
     content_by_lua_block {
         res = ngx.location.capture(&quot;/other&quot;,
             { copy_all_vars = true })

         ngx.print(res.body)
         ngx.say(ngx.var.uri, &quot;: &quot;, ngx.var.dog)
     }
 }"><pre> <span class="pl-c1">location</span> /other <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$dog</span> <span class="pl-s">"$dog world"</span><span class="pl-c1">;</span>
     echo <span class="pl-s">"$uri dog: $dog"</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$dog</span> <span class="pl-s">'hello'</span><span class="pl-c1">;</span>
     content_by_lua_block <span class="pl-c1">{</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/other"</span>,
             <span class="pl-c1">{</span> copy_all_vars = true <span class="pl-c1">}</span><span class="pl-c1">)</span>

         ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span>ngx.var.uri, <span class="pl-s">": "</span>, ngx.var.dog<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Request <code>GET /lua</code> will give the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="/other dog: hello world
/lua: hello"><pre class="notranslate"><code>/other dog: hello world
/lua: hello
</code></pre></div>
<p dir="auto">Note that if both <code>share_all_vars</code> and <code>copy_all_vars</code> are set to true, then <code>share_all_vars</code> takes precedence.</p>
<p dir="auto">In addition to the two settings above, it is possible to specify
values for variables in the subrequest using the <code>vars</code> option. These
variables are set after the sharing or copying of variables has been
evaluated, and provides a more efficient method of passing specific
values to a subrequest over encoding them as URL arguments and
unescaping them in the Nginx config file.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /other {
     content_by_lua_block {
         ngx.say(&quot;dog = &quot;, ngx.var.dog)
         ngx.say(&quot;cat = &quot;, ngx.var.cat)
     }
 }

 location /lua {
     set $dog '';
     set $cat '';
     content_by_lua_block {
         res = ngx.location.capture(&quot;/other&quot;,
             { vars = { dog = &quot;hello&quot;, cat = 32 }})

         ngx.print(res.body)
     }
 }"><pre> <span class="pl-c1">location</span> /other <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"dog = "</span>, ngx.var.dog<span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"cat = "</span>, ngx.var.cat<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$dog</span> <span class="pl-s">''</span><span class="pl-c1">;</span>
     <span class="pl-c1">set</span> <span class="pl-v">$cat</span> <span class="pl-s">''</span><span class="pl-c1">;</span>
     content_by_lua_block <span class="pl-c1">{</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/other"</span>,
             <span class="pl-c1">{</span> vars = <span class="pl-c1">{</span> dog = <span class="pl-s">"hello"</span>, cat = <span class="pl-c1">32</span> <span class="pl-c1">}}</span><span class="pl-c1">)</span>

         ngx.print<span class="pl-c1">(</span>res.body<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Accessing <code>/lua</code> will yield the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="dog = hello
cat = 32"><pre class="notranslate"><code>dog = hello
cat = 32
</code></pre></div>
<p dir="auto">The <code>headers</code> option can be used to specify the request headers for the subrequest. The value of this option should be a Lua table where the keys are the header names and the values are the header values. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
location /foo {
    content_by_lua_block {
        ngx.print(ngx.var.http_x_test)
    }
}

location /lua {
    content_by_lua_block {
        local res = ngx.location.capture(&quot;/foo&quot;, {
            headers = {
                [&quot;X-Test&quot;] = &quot;aa&quot;,
            }
        })
        ngx.print(res.body)
    }
}"><pre><span class="pl-smi">location</span> <span class="pl-k">/</span><span class="pl-c1">foo</span> {
    <span class="pl-c1">content_by_lua_block</span> {
        <span class="pl-smi">ngx</span>.<span class="pl-c1">print</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">var</span>.<span class="pl-e">http_x_test</span>)
    }
}

<span class="pl-smi">location</span> <span class="pl-k">/</span><span class="pl-c1">lua</span> {
    <span class="pl-c1">content_by_lua_block</span> {
        <span class="pl-k">local</span> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, {
            <span class="pl-smi">headers</span> <span class="pl-k">=</span> {
                [<span class="pl-s"><span class="pl-pds">"</span>X-Test<span class="pl-pds">"</span></span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>aa<span class="pl-pds">"</span></span>,
            }
        })
        <span class="pl-smi">ngx</span>.<span class="pl-c1">print</span>(<span class="pl-smi">res</span>.<span class="pl-e">body</span>)
    }
}</pre></div>
<p dir="auto">Accessing <code>/lua</code> will yield the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="aa"><pre class="notranslate"><code>aa
</code></pre></div>
<p dir="auto">The <code>ctx</code> option can be used to specify a custom Lua table to serve as the <a href="#ngxctx">ngx.ctx</a> table for the subrequest.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /sub {
     content_by_lua_block {
         ngx.ctx.foo = &quot;bar&quot;;
     }
 }
 location /lua {
     content_by_lua_block {
         local ctx = {}
         res = ngx.location.capture(&quot;/sub&quot;, { ctx = ctx })

         ngx.say(ctx.foo)
         ngx.say(ngx.ctx.foo)
     }
 }"><pre> <span class="pl-c1">location</span> /sub <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.foo = <span class="pl-s">"bar"</span><span class="pl-c1">;</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>
 <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local ctx = <span class="pl-c1">{}</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/sub"</span>, <span class="pl-c1">{</span> ctx = ctx <span class="pl-c1">}</span><span class="pl-c1">)</span>

         ngx.say<span class="pl-c1">(</span>ctx.foo<span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span>ngx.ctx.foo<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then request <code>GET /lua</code> gives</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bar
nil"><pre class="notranslate"><code>bar
nil
</code></pre></div>
<p dir="auto">It is also possible to use this <code>ctx</code> option to share the same <a href="#ngxctx">ngx.ctx</a> table between the current (parent) request and the subrequest:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /sub {
     content_by_lua_block {
         ngx.ctx.foo = &quot;bar&quot;
     }
 }
 location /lua {
     content_by_lua_block {
         res = ngx.location.capture(&quot;/sub&quot;, { ctx = ngx.ctx })
         ngx.say(ngx.ctx.foo)
     }
 }"><pre> <span class="pl-c1">location</span> /sub <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.ctx.foo = <span class="pl-s">"bar"</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>
 <span class="pl-c1">location</span> /lua <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         res = ngx.<span class="pl-c1">location</span>.capture<span class="pl-c1">(</span><span class="pl-s">"/sub"</span>, <span class="pl-c1">{</span> ctx = ngx.ctx <span class="pl-c1">}</span><span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span>ngx.ctx.foo<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Request <code>GET /lua</code> yields the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bar"><pre class="notranslate"><code>bar
</code></pre></div>
<p dir="auto">Note that subrequests issued by <a href="#ngxlocationcapture">ngx.location.capture</a> inherit all the
request headers of the current request by default and that this may have unexpected side effects on the
subrequest responses. For example, when using the standard <code>ngx_proxy</code> module to serve
subrequests, an "Accept-Encoding: gzip" header in the main request may result
in gzipped responses that cannot be handled properly in Lua code. Original request headers should be ignored by setting
<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_request_headers" rel="nofollow">proxy_pass_request_headers</a> to <code>off</code> in subrequest locations.</p>
<p dir="auto">When the <code>body</code> option is not specified and the <code>always_forward_body</code> option is false (the default value), the <code>POST</code> and <code>PUT</code> subrequests will inherit the request bodies of the parent request (if any).</p>
<p dir="auto">There is a hard-coded upper limit on the number of subrequests possible for every main request. In older versions of Nginx, the limit was <code>50</code> concurrent subrequests and in more recent versions, Nginx <code>1.9.5</code> onwards, the same limit is changed to limit the depth of recursive subrequests. When this limit is exceeded, the following error message is added to the <code>error.log</code> file:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[error] 13983#0: *1 subrequests cycle while processing &quot;/uri&quot;"><pre class="notranslate"><code>[error] 13983#0: *1 subrequests cycle while processing "/uri"
</code></pre></div>
<p dir="auto">The limit can be manually modified if required by editing the definition of the <code>NGX_HTTP_MAX_SUBREQUESTS</code> macro in the <code>nginx/src/http/ngx_http_request.h</code> file in the Nginx source tree.</p>
<p dir="auto">Please also refer to restrictions on capturing locations configured by <a href="#locations-configured-by-subrequest-directives-of-other-modules">subrequest directives of other modules</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.location.capture_multi</h2><a id="user-content-ngxlocationcapture_multi" class="anchor" aria-label="Permalink: ngx.location.capture_multi" href="#ngxlocationcapture_multi"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>res1, res2, ... = ngx.location.capture_multi({ {uri, options?}, {uri, options?}, ... })</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Just like <a href="#ngxlocationcapture">ngx.location.capture</a>, but supports multiple subrequests running in parallel.</p>
<p dir="auto">This function issues several parallel subrequests specified by the input table and returns their results in the same order. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 res1, res2, res3 = ngx.location.capture_multi{
     { &quot;/foo&quot;, { args = &quot;a=3&amp;b=4&quot; } },
     { &quot;/bar&quot; },
     { &quot;/baz&quot;, { method = ngx.HTTP_POST, body = &quot;hello&quot; } },
 }

 if res1.status == ngx.HTTP_OK then
     ...
 end

 if res2.body == &quot;BLAH&quot; then
     ...
 end"><pre> <span class="pl-smi">res1</span>, <span class="pl-smi">res2</span>, <span class="pl-smi">res3</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture_multi</span>{
     { <span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, { <span class="pl-smi">args</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>a=3&amp;b=4<span class="pl-pds">" </span></span>} },
     { <span class="pl-s"><span class="pl-pds">"</span>/bar<span class="pl-pds">" </span></span>},
     { <span class="pl-s"><span class="pl-pds">"</span>/baz<span class="pl-pds">"</span></span>, { <span class="pl-smi">method</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_POST</span>, <span class="pl-smi">body</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">" </span></span>} },
 }

 <span class="pl-k">if</span> <span class="pl-smi">res1</span>.<span class="pl-e">status</span> <span class="pl-k">==</span> <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_OK</span> <span class="pl-k">then</span>
     <span class="pl-c1">...</span>
 <span class="pl-k">end</span>

 <span class="pl-k">if</span> <span class="pl-smi">res2</span>.<span class="pl-e">body</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>BLAH<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c1">...</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This function will not return until all the subrequests terminate.
The total latency is the longest latency of the individual subrequests rather than the sum.</p>
<p dir="auto">Lua tables can be used for both requests and responses when the number of subrequests to be issued is not known in advance:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- construct the requests table
 local reqs = {}
 table.insert(reqs, { &quot;/mysql&quot; })
 table.insert(reqs, { &quot;/postgres&quot; })
 table.insert(reqs, { &quot;/redis&quot; })
 table.insert(reqs, { &quot;/memcached&quot; })

 -- issue all the requests at once and wait until they all return
 local resps = {
     ngx.location.capture_multi(reqs)
 }

 -- loop over the responses table
 for i, resp in ipairs(resps) do
     -- process the response table &quot;resp&quot;
 end"><pre> <span class="pl-c"><span class="pl-c">--</span> construct the requests table</span>
 <span class="pl-k">local</span> <span class="pl-smi">reqs</span> <span class="pl-k">=</span> {}
 <span class="pl-c1">table.insert</span>(<span class="pl-smi">reqs</span>, { <span class="pl-s"><span class="pl-pds">"</span>/mysql<span class="pl-pds">" </span></span>})
 <span class="pl-c1">table.insert</span>(<span class="pl-smi">reqs</span>, { <span class="pl-s"><span class="pl-pds">"</span>/postgres<span class="pl-pds">" </span></span>})
 <span class="pl-c1">table.insert</span>(<span class="pl-smi">reqs</span>, { <span class="pl-s"><span class="pl-pds">"</span>/redis<span class="pl-pds">" </span></span>})
 <span class="pl-c1">table.insert</span>(<span class="pl-smi">reqs</span>, { <span class="pl-s"><span class="pl-pds">"</span>/memcached<span class="pl-pds">" </span></span>})

 <span class="pl-c"><span class="pl-c">--</span> issue all the requests at once and wait until they all return</span>
 <span class="pl-k">local</span> <span class="pl-smi">resps</span> <span class="pl-k">=</span> {
     <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture_multi</span>(<span class="pl-smi">reqs</span>)
 }

 <span class="pl-c"><span class="pl-c">--</span> loop over the responses table</span>
 <span class="pl-k">for</span> <span class="pl-smi">i</span>, <span class="pl-smi">resp</span> <span class="pl-k">in</span> <span class="pl-c1">ipairs</span>(<span class="pl-smi">resps</span>) <span class="pl-k">do</span>
     <span class="pl-c"><span class="pl-c">--</span> process the response table "resp"</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">The <a href="#ngxlocationcapture">ngx.location.capture</a> function is just a special form
of this function. Logically speaking, the <a href="#ngxlocationcapture">ngx.location.capture</a> can be implemented like this</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.location.capture =
     function (uri, args)
         return ngx.location.capture_multi({ {uri, args} })
     end"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-e">capture</span> <span class="pl-k">=</span>
     <span class="pl-k">function</span> (<span class="pl-smi">uri</span>, <span class="pl-smi">args</span>)
         <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture_multi</span>({ {<span class="pl-smi">uri</span>, <span class="pl-smi">args</span>} })
     <span class="pl-k">end</span></pre></div>
<p dir="auto">Please also refer to restrictions on capturing locations configured by <a href="#locations-configured-by-subrequest-directives-of-other-modules">subrequest directives of other modules</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.status</h2><a id="user-content-ngxstatus" class="anchor" aria-label="Permalink: ngx.status" href="#ngxstatus"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Read and write the current request's response status. This should be called
before sending out the response headers.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.status = ngx.HTTP_CREATED
 status = ngx.status"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">status</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_CREATED</span>
 <span class="pl-smi">status</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">status</span></pre></div>
<p dir="auto">Setting <code>ngx.status</code> after the response header is sent out has no effect but leaving an error message in your Nginx's error log file:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="attempt to set ngx.status after sending out response headers"><pre class="notranslate"><code>attempt to set ngx.status after sending out response headers
</code></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.header.HEADER</h2><a id="user-content-ngxheaderheader" class="anchor" aria-label="Permalink: ngx.header.HEADER" href="#ngxheaderheader"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.header.HEADER = VALUE</em></p>
<p dir="auto"><strong>syntax:</strong> <em>value = ngx.header.HEADER</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Set, add to, or clear the current request's <code>HEADER</code> response header that is to be sent.</p>
<p dir="auto">Underscores (<code>_</code>) in the header names will be replaced by hyphens (<code>-</code>) by default. This transformation can be turned off via the <a href="#lua_transform_underscores_in_response_headers">lua_transform_underscores_in_response_headers</a> directive.</p>
<p dir="auto">The header names are matched case-insensitively.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- equivalent to ngx.header[&quot;Content-Type&quot;] = 'text/plain'
 ngx.header.content_type = 'text/plain'

 ngx.header[&quot;X-My-Header&quot;] = 'blah blah'"><pre> <span class="pl-c"><span class="pl-c">--</span> equivalent to ngx.header["Content-Type"] = 'text/plain'</span>
 <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>.<span class="pl-e">content_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>text/plain<span class="pl-pds">'</span></span>

 <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>[<span class="pl-s"><span class="pl-pds">"</span>X-My-Header<span class="pl-pds">"</span></span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>blah blah<span class="pl-pds">'</span></span></pre></div>
<p dir="auto">Multi-value headers can be set this way:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.header['Set-Cookie'] = {'a=32; path=/', 'b=4; path=/'}"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>[<span class="pl-s"><span class="pl-pds">'</span>Set-Cookie<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> {<span class="pl-s"><span class="pl-pds">'</span>a=32; path=/<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>b=4; path=/<span class="pl-pds">'</span></span>}</pre></div>
<p dir="auto">will yield</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 Set-Cookie: a=32; path=/
 Set-Cookie: b=4; path=/"><pre> Set-Cookie: a=32<span class="pl-k">;</span> path=/
 Set-Cookie: b=4<span class="pl-k">;</span> path=/</pre></div>
<p dir="auto">in the response headers.</p>
<p dir="auto">Only Lua tables are accepted (Only the last element in the table will take effect for standard headers such as <code>Content-Type</code> that only accept a single value).</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.header.content_type = {'a', 'b'}"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>.<span class="pl-e">content_type</span> <span class="pl-k">=</span> {<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>}</pre></div>
<p dir="auto">is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.header.content_type = 'b'"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>.<span class="pl-e">content_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span></pre></div>
<p dir="auto">Setting a slot to <code>nil</code> effectively removes it from the response headers:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.header[&quot;X-My-Header&quot;] = nil"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>[<span class="pl-s"><span class="pl-pds">"</span>X-My-Header<span class="pl-pds">"</span></span>] <span class="pl-k">=</span> <span class="pl-c1">nil</span></pre></div>
<p dir="auto">The same applies to assigning an empty table:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.header[&quot;X-My-Header&quot;] = {}"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">header</span>[<span class="pl-s"><span class="pl-pds">"</span>X-My-Header<span class="pl-pds">"</span></span>] <span class="pl-k">=</span> {}</pre></div>
<p dir="auto">Setting <code>ngx.header.HEADER</code> after sending out response headers (either explicitly with <a href="#ngxsend_headers">ngx.send_headers</a> or implicitly with <a href="#ngxprint">ngx.print</a> and similar) will log an error message.</p>
<p dir="auto">Reading <code>ngx.header.HEADER</code> will return the value of the response header named <code>HEADER</code>.</p>
<p dir="auto">Underscores (<code>_</code>) in the header names will also be replaced by dashes (<code>-</code>) and the header names will be matched case-insensitively. If the response header is not present at all, <code>nil</code> will be returned.</p>
<p dir="auto">This is particularly useful in the context of <a href="#header_filter_by_lua">header_filter_by_lua*</a>, for example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     set $footer '';

     proxy_pass http://some-backend;

     header_filter_by_lua_block {
         if ngx.header[&quot;X-My-Header&quot;] == &quot;blah&quot; then
             ngx.var.footer = &quot;some value&quot;
         end
     }

     echo_after_body $footer;
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     <span class="pl-c1">set</span> <span class="pl-v">$footer</span> <span class="pl-s">''</span><span class="pl-c1">;</span>

     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://some-backend<span class="pl-c1">;</span>

     header_filter_by_lua_block <span class="pl-c1">{</span>
         <span class="pl-k">if</span> ngx.header[<span class="pl-s">"X-My-Header"</span>] == <span class="pl-s">"blah"</span> then
             ngx.var.footer = <span class="pl-s">"some value"</span>
         end
     <span class="pl-c1">}</span>

     echo_after_body <span class="pl-v">$footer</span><span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">For multi-value headers, all of the values of header will be collected in order and returned as a Lua table. For example, response headers</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="Foo: bar
Foo: baz"><pre class="notranslate"><code>Foo: bar
Foo: baz
</code></pre></div>
<p dir="auto">will result in</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 {&quot;bar&quot;, &quot;baz&quot;}"><pre> {<span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>baz<span class="pl-pds">"</span></span>}</pre></div>
<p dir="auto">to be returned when reading <code>ngx.header.Foo</code>.</p>
<p dir="auto">Note that <code>ngx.header</code> is not a normal Lua table and as such, it is not possible to iterate through it using the Lua <code>ipairs</code> function.</p>
<p dir="auto">Note: this function throws a Lua error if <code>HEADER</code> or
<code>VALUE</code> contain unsafe characters (control characters).</p>
<p dir="auto">For reading <em>request</em> headers, use the <a href="#ngxreqget_headers">ngx.req.get_headers</a> function instead.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.resp.get_headers</h2><a id="user-content-ngxrespget_headers" class="anchor" aria-label="Permalink: ngx.resp.get_headers" href="#ngxrespget_headers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>headers, err = ngx.resp.get_headers(max_headers?, raw?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*</em></p>
<p dir="auto">Returns a Lua table holding all the current response headers for the current request.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local h, err = ngx.resp.get_headers()

 if err == &quot;truncated&quot; then
     -- one can choose to ignore or reject the current response here
 end

 for k, v in pairs(h) do
     ...
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">h</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">resp</span>.<span class="pl-c1">get_headers</span>()

 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>truncated<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> one can choose to ignore or reject the current response here</span>
 <span class="pl-k">end</span>

 <span class="pl-k">for</span> <span class="pl-smi">k</span>, <span class="pl-smi">v</span> <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(<span class="pl-smi">h</span>) <span class="pl-k">do</span>
     <span class="pl-c1">...</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This function has the same signature as <a href="#ngxreqget_headers">ngx.req.get_headers</a> except getting response headers instead of request headers.</p>
<p dir="auto">Note that a maximum of 100 response headers are parsed by default (including those with the same name) and that additional response headers are silently discarded to guard against potential denial of service attacks. Since <code>v0.10.13</code>, when the limit is exceeded, it will return a second value which is the string <code>"truncated"</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.9.5</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.is_internal</h2><a id="user-content-ngxreqis_internal" class="anchor" aria-label="Permalink: ngx.req.is_internal" href="#ngxreqis_internal"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>is_internal = ngx.req.is_internal()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Returns a boolean indicating whether the current request is an "internal request", i.e.,
a request initiated from inside the current Nginx server instead of from the client side.</p>
<p dir="auto">Subrequests are all internal requests and so are requests after internal redirects.</p>
<p dir="auto">This API was first introduced in the <code>v0.9.20</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.start_time</h2><a id="user-content-ngxreqstart_time" class="anchor" aria-label="Permalink: ngx.req.start_time" href="#ngxreqstart_time"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>secs = ngx.req.start_time()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Returns a floating-point number representing the timestamp (including milliseconds as the decimal part) when the current request was created.</p>
<p dir="auto">The following example emulates the <code>$request_time</code> variable value (provided by <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" rel="nofollow">ngx_http_log_module</a>) in pure Lua:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local request_time = ngx.now() - ngx.req.start_time()"><pre> <span class="pl-k">local</span> <span class="pl-smi">request_time</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">now</span>() <span class="pl-k">-</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">start_time</span>()</pre></div>
<p dir="auto">This function was first introduced in the <code>v0.7.7</code> release.</p>
<p dir="auto">See also <a href="#ngxnow">ngx.now</a> and <a href="#ngxupdate_time">ngx.update_time</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.http_version</h2><a id="user-content-ngxreqhttp_version" class="anchor" aria-label="Permalink: ngx.req.http_version" href="#ngxreqhttp_version"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>num = ngx.req.http_version()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*</em></p>
<p dir="auto">Returns the HTTP version number for the current request as a Lua number.</p>
<p dir="auto">Current possible values are 3.0, 2.0, 1.0, 1.1, and 0.9. Returns <code>nil</code> for unrecognized values.</p>
<p dir="auto">This method was first introduced in the <code>v0.7.17</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.raw_header</h2><a id="user-content-ngxreqraw_header" class="anchor" aria-label="Permalink: ngx.req.raw_header" href="#ngxreqraw_header"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.req.raw_header(no_request_line?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*</em></p>
<p dir="auto">Returns the original raw HTTP protocol header received by the Nginx server.</p>
<p dir="auto">By default, the request line and trailing <code>CR LF</code> terminator will also be included. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.print(ngx.req.raw_header())"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">print</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">raw_header</span>())</pre></div>
<p dir="auto">gives something like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="GET /t HTTP/1.1
Host: localhost
Connection: close
Foo: bar"><pre class="notranslate"><code>GET /t HTTP/1.1
Host: localhost
Connection: close
Foo: bar
</code></pre></div>
<p dir="auto">You can specify the optional
<code>no_request_line</code> argument as a <code>true</code> value to exclude the request line from the result. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.print(ngx.req.raw_header(true))"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">print</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">raw_header</span>(<span class="pl-c1">true</span>))</pre></div>
<p dir="auto">outputs something like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="Host: localhost
Connection: close
Foo: bar"><pre class="notranslate"><code>Host: localhost
Connection: close
Foo: bar
</code></pre></div>
<p dir="auto">This method was first introduced in the <code>v0.7.17</code> release.</p>
<p dir="auto">This method does not work in HTTP/2 requests yet.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_method</h2><a id="user-content-ngxreqget_method" class="anchor" aria-label="Permalink: ngx.req.get_method" href="#ngxreqget_method"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>method_name = ngx.req.get_method()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, balancer_by_lua*, log_by_lua*</em></p>
<p dir="auto">Retrieves the current request's request method name. Strings like <code>"GET"</code> and <code>"POST"</code> are returned instead of numerical <a href="#http-method-constants">method constants</a>.</p>
<p dir="auto">If the current request is an Nginx subrequest, then the subrequest's method name will be returned.</p>
<p dir="auto">This method was first introduced in the <code>v0.5.6</code> release.</p>
<p dir="auto">See also <a href="#ngxreqset_method">ngx.req.set_method</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_method</h2><a id="user-content-ngxreqset_method" class="anchor" aria-label="Permalink: ngx.req.set_method" href="#ngxreqset_method"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_method(method_id)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*</em></p>
<p dir="auto">Overrides the current request's request method with the <code>method_id</code> argument. Currently only numerical <a href="#http-method-constants">method constants</a> are supported, like <code>ngx.HTTP_POST</code> and <code>ngx.HTTP_GET</code>.</p>
<p dir="auto">If the current request is an Nginx subrequest, then the subrequest's method will be overridden.</p>
<p dir="auto">This method was first introduced in the <code>v0.5.6</code> release.</p>
<p dir="auto">See also <a href="#ngxreqget_method">ngx.req.get_method</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_uri</h2><a id="user-content-ngxreqset_uri" class="anchor" aria-label="Permalink: ngx.req.set_uri" href="#ngxreqset_uri"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_uri(uri, jump?, binary?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*</em></p>
<p dir="auto">Rewrite the current request's (parsed) URI by the <code>uri</code> argument. The <code>uri</code> argument must be a Lua string and cannot be of zero length, or a Lua exception will be thrown.</p>
<p dir="auto">The optional boolean <code>jump</code> argument can trigger location rematch (or location jump) as <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>'s <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" rel="nofollow">rewrite</a> directive, that is, when <code>jump</code> is <code>true</code> (default to <code>false</code>), this function will never return and it will tell Nginx to try re-searching locations with the new URI value at the later <code>post-rewrite</code> phase and jumping to the new location.</p>
<p dir="auto">Location jump will not be triggered otherwise, and only the current request's URI will be modified, which is also the default behavior. This function will return but with no returned values when the <code>jump</code> argument is <code>false</code> or absent altogether.</p>
<p dir="auto">For example, the following Nginx config snippet</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite ^ /foo last;"><pre> <span class="pl-c1">rewrite</span> ^ /foo last<span class="pl-c1">;</span></pre></div>
<p dir="auto">can be coded in Lua like this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri(&quot;/foo&quot;, true)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, <span class="pl-c1">true</span>)</pre></div>
<p dir="auto">Similarly, Nginx config</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite ^ /foo break;"><pre> <span class="pl-c1">rewrite</span> ^ /foo <span class="pl-c1">break</span><span class="pl-c1">;</span></pre></div>
<p dir="auto">can be coded in Lua as</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri(&quot;/foo&quot;, false)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, <span class="pl-c1">false</span>)</pre></div>
<p dir="auto">or equivalently,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri(&quot;/foo&quot;)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">The <code>jump</code> argument can only be set to <code>true</code> in <a href="#rewrite_by_lua">rewrite_by_lua*</a>. Use of jump in other contexts is prohibited and will throw out a Lua exception.</p>
<p dir="auto">A more sophisticated example involving regex substitutions is as follows</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     rewrite_by_lua_block {
         local uri = ngx.re.sub(ngx.var.uri, &quot;^/test/(.*)&quot;, &quot;/$1&quot;, &quot;o&quot;)
         ngx.req.set_uri(uri)
     }
     proxy_pass http://my_backend;
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     rewrite_by_lua_block <span class="pl-c1">{</span>
         local uri = ngx.re.sub<span class="pl-c1">(</span>ngx.var.uri, <span class="pl-s">"^/test/(.*)"</span>, <span class="pl-s">"/$1"</span>, <span class="pl-s">"o"</span><span class="pl-c1">)</span>
         ngx.req.set_uri<span class="pl-c1">(</span>uri<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://my_backend<span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">which is functionally equivalent to</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     rewrite ^/test/(.*) /$1 break;
     proxy_pass http://my_backend;
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     <span class="pl-c1">rewrite</span> ^/test/<span class="pl-c1">(</span>.*<span class="pl-c1">)</span> /<span class="pl-v">$1</span> <span class="pl-c1">break</span><span class="pl-c1">;</span>
     <span class="pl-c1">proxy_pass</span> <span class="pl-c1">http</span>://my_backend<span class="pl-c1">;</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Note: this function throws a Lua error if the <code>uri</code> argument
contains unsafe characters (control characters).</p>
<p dir="auto">Note that it is not possible to use this interface to rewrite URI arguments and that <a href="#ngxreqset_uri_args">ngx.req.set_uri_args</a> should be used for this instead. For instance, Nginx config</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite ^ /foo?a=3? last;"><pre> <span class="pl-c1">rewrite</span> ^ /foo?a=3? last<span class="pl-c1">;</span></pre></div>
<p dir="auto">can be coded as</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri_args(&quot;a=3&quot;)
 ngx.req.set_uri(&quot;/foo&quot;, true)"><pre> ngx.req.set_uri_args<span class="pl-c1">(</span><span class="pl-s">"a=3"</span><span class="pl-c1">)</span>
 ngx.req.set_uri<span class="pl-c1">(</span><span class="pl-s">"/foo"</span>, true<span class="pl-c1">)</span></pre></div>
<p dir="auto">or</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri_args({a = 3})
 ngx.req.set_uri(&quot;/foo&quot;, true)"><pre> ngx.req.set_uri_args<span class="pl-c1">(</span><span class="pl-c1">{</span>a = 3<span class="pl-c1">}</span><span class="pl-c1">)</span>
 ngx.req.set_uri<span class="pl-c1">(</span><span class="pl-s">"/foo"</span>, true<span class="pl-c1">)</span></pre></div>
<p dir="auto">Starting from <code>0.10.16</code> of this module, this function accepts an
optional boolean <code>binary</code> argument to allow arbitrary binary URI
data. By default, this <code>binary</code> argument is false and this function
will throw out a Lua error such as the one below when the <code>uri</code>
argument contains any control characters (ASCII Code 0 ~ 0x08, 0x0A ~ 0x1F and 0x7F).</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[error] 23430#23430: *1 lua entry thread aborted: runtime error:
content_by_lua(nginx.conf:44):3: ngx.req.set_uri unsafe byte &quot;0x00&quot;
in &quot;\x00foo&quot; (maybe you want to set the 'binary' argument?)"><pre class="notranslate"><code>[error] 23430#23430: *1 lua entry thread aborted: runtime error:
content_by_lua(nginx.conf:44):3: ngx.req.set_uri unsafe byte "0x00"
in "\x00foo" (maybe you want to set the 'binary' argument?)
</code></pre></div>
<p dir="auto">This interface was first introduced in the <code>v0.3.1rc14</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_uri_args</h2><a id="user-content-ngxreqset_uri_args" class="anchor" aria-label="Permalink: ngx.req.set_uri_args" href="#ngxreqset_uri_args"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_uri_args(args)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*</em></p>
<p dir="auto">Rewrite the current request's URI query arguments by the <code>args</code> argument. The <code>args</code> argument can be either a Lua string, as in</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri_args(&quot;a=3&amp;b=hello%20world&quot;)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri_args</span>(<span class="pl-s"><span class="pl-pds">"</span>a=3&amp;b=hello%20world<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">or a Lua table holding the query arguments' key-value pairs, as in</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri_args({ a = 3, b = &quot;hello world&quot; })"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri_args</span>({ <span class="pl-smi">a</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, <span class="pl-smi">b</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">" </span></span>})</pre></div>
<p dir="auto">In the former case, i.e., when the whole query-string is provided directly,
the input Lua string should already be well-formed with the URI encoding.
For security considerations, this method will automatically escape any control and
whitespace characters (ASCII code 0x00 ~ 0x20 and 0x7F) in the Lua string.</p>
<p dir="auto">In the latter case, this method will escape argument keys and values according to the URI escaping rule.</p>
<p dir="auto">Multi-value arguments are also supported:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_uri_args({ a = 3, b = {5, 6} })"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_uri_args</span>({ <span class="pl-smi">a</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, <span class="pl-smi">b</span> <span class="pl-k">=</span> {<span class="pl-c1">5</span>, <span class="pl-c1">6</span>} })</pre></div>
<p dir="auto">which will result in a query string like <code>a=3&amp;b=5&amp;b=6</code> or <code>b=5&amp;b=6&amp;a=3</code>.</p>
<p dir="auto"><strong>Note that when using Lua table as the <code>arg</code> argument, the order of the arguments in the result query string which change from time to time. If you would like to get an ordered result, you need to use Lua string as the <code>arg</code> argument.</strong></p>
<p dir="auto">This interface was first introduced in the <code>v0.3.1rc13</code> release.</p>
<p dir="auto">See also <a href="#ngxreqset_uri">ngx.req.set_uri</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_uri_args</h2><a id="user-content-ngxreqget_uri_args" class="anchor" aria-label="Permalink: ngx.req.get_uri_args" href="#ngxreqget_uri_args"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>args, err = ngx.req.get_uri_args(max_args?, tab?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, balancer_by_lua*</em></p>
<p dir="auto">Returns a Lua table holding all the current request URL query arguments. An optional <code>tab</code> argument
can be used to reuse the table returned by this method.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location = /test {
     content_by_lua_block {
         local args, err = ngx.req.get_uri_args()

         if err == &quot;truncated&quot; then
             -- one can choose to ignore or reject the current request here
         end

         for key, val in pairs(args) do
             if type(val) == &quot;table&quot; then
                 ngx.say(key, &quot;: &quot;, table.concat(val, &quot;, &quot;))
             else
                 ngx.say(key, &quot;: &quot;, val)
             end
         end
     }
 }"><pre> <span class="pl-c1">location</span> = /test <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local args, err = ngx.req.get_uri_args<span class="pl-c1">()</span>

         <span class="pl-k">if</span> err == <span class="pl-s">"truncated"</span> then
             -- one can choose to ignore or reject the current request here
         end

         <span class="pl-k">for</span> key, val in pairs<span class="pl-c1">(</span>args<span class="pl-c1">)</span> do
             <span class="pl-k">if</span> type<span class="pl-c1">(</span>val<span class="pl-c1">)</span> == <span class="pl-s">"table"</span> then
                 ngx.say<span class="pl-c1">(</span>key, <span class="pl-s">": "</span>, table.concat<span class="pl-c1">(</span>val, <span class="pl-s">", "</span><span class="pl-c1">))</span>
             else
                 ngx.say<span class="pl-c1">(</span>key, <span class="pl-s">": "</span>, val<span class="pl-c1">)</span>
             end
         end
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then <code>GET /test?foo=bar&amp;bar=baz&amp;bar=blah</code> will yield the response body</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo: bar
 bar: baz, blah"><pre> foo: bar
 bar: baz, blah</pre></div>
<p dir="auto">Multiple occurrences of an argument key will result in a table value holding all the values for that key in order.</p>
<p dir="auto">Keys and values are unescaped according to URI escaping rules. In the settings above, <code>GET /test?a%20b=1%61+2</code> will yield:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 a b: 1a 2"><pre> a b: 1a 2</pre></div>
<p dir="auto">Arguments without the <code>=&lt;value&gt;</code> parts are treated as boolean arguments. <code>GET /test?foo&amp;bar</code> will yield:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo: true
 bar: true"><pre> foo: <span class="pl-c1">true</span>
 bar: <span class="pl-c1">true</span></pre></div>
<p dir="auto">That is, they will take Lua boolean values <code>true</code>. However, they are different from arguments taking empty string values. <code>GET /test?foo=&amp;bar=</code> will give something like</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo:
 bar:"><pre> foo:
 bar:</pre></div>
<p dir="auto">Empty key arguments are discarded. <code>GET /test?=hello&amp;=world</code> will yield an empty output for instance.</p>
<p dir="auto">Updating query arguments via the Nginx variable <code>$args</code> (or <code>ngx.var.args</code> in Lua) at runtime is also supported:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.var.args = &quot;a=3&amp;b=42&quot;
 local args, err = ngx.req.get_uri_args()"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">var</span>.<span class="pl-e">args</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>a=3&amp;b=42<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">args</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_uri_args</span>()</pre></div>
<p dir="auto">Here the <code>args</code> table will always look like</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 {a = 3, b = 42}"><pre> {<span class="pl-smi">a</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, <span class="pl-smi">b</span> <span class="pl-k">=</span> <span class="pl-c1">42</span>}</pre></div>
<p dir="auto">regardless of the actual request query string.</p>
<p dir="auto">Note that a maximum of 100 request arguments are parsed by default (including those with the same name) and that additional request arguments are silently discarded to guard against potential denial of service attacks. Since <code>v0.10.13</code>, when the limit is exceeded, it will return a second value which is the string <code>"truncated"</code>.</p>
<p dir="auto">However, the optional <code>max_args</code> function argument can be used to override this limit:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local args, err = ngx.req.get_uri_args(10)
 if err == &quot;truncated&quot; then
     -- one can choose to ignore or reject the current request here
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">args</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_uri_args</span>(<span class="pl-c1">10</span>)
 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>truncated<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> one can choose to ignore or reject the current request here</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This argument can be set to zero to remove the limit and to process all request arguments received:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local args, err = ngx.req.get_uri_args(0)"><pre> <span class="pl-k">local</span> <span class="pl-smi">args</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_uri_args</span>(<span class="pl-c1">0</span>)</pre></div>
<p dir="auto">Removing the <code>max_args</code> cap is strongly discouraged.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_post_args</h2><a id="user-content-ngxreqget_post_args" class="anchor" aria-label="Permalink: ngx.req.get_post_args" href="#ngxreqget_post_args"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>args, err = ngx.req.get_post_args(max_args?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Returns a Lua table holding all the current request POST query arguments (of the MIME type <code>application/x-www-form-urlencoded</code>). Call <a href="#ngxreqread_body">ngx.req.read_body</a> to read the request body first or turn on the <a href="#lua_need_request_body">lua_need_request_body</a> directive to avoid errors.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location = /test {
     content_by_lua_block {
         ngx.req.read_body()
         local args, err = ngx.req.get_post_args()

         if err == &quot;truncated&quot; then
             -- one can choose to ignore or reject the current request here
         end

         if not args then
             ngx.say(&quot;failed to get post args: &quot;, err)
             return
         end
         for key, val in pairs(args) do
             if type(val) == &quot;table&quot; then
                 ngx.say(key, &quot;: &quot;, table.concat(val, &quot;, &quot;))
             else
                 ngx.say(key, &quot;: &quot;, val)
             end
         end
     }
 }"><pre> <span class="pl-c1">location</span> = /test <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.req.read_body<span class="pl-c1">()</span>
         local args, err = ngx.req.get_post_args<span class="pl-c1">()</span>

         <span class="pl-k">if</span> err == <span class="pl-s">"truncated"</span> then
             -- one can choose to ignore or reject the current request here
         end

         <span class="pl-k">if</span> not args then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to get post args: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         <span class="pl-k">for</span> key, val in pairs<span class="pl-c1">(</span>args<span class="pl-c1">)</span> do
             <span class="pl-k">if</span> type<span class="pl-c1">(</span>val<span class="pl-c1">)</span> == <span class="pl-s">"table"</span> then
                 ngx.say<span class="pl-c1">(</span>key, <span class="pl-s">": "</span>, table.concat<span class="pl-c1">(</span>val, <span class="pl-s">", "</span><span class="pl-c1">))</span>
             else
                 ngx.say<span class="pl-c1">(</span>key, <span class="pl-s">": "</span>, val<span class="pl-c1">)</span>
             end
         end
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Then</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # Post request with the body 'foo=bar&amp;bar=baz&amp;bar=blah'
 $ curl --data 'foo=bar&amp;bar=baz&amp;bar=blah' localhost/test"><pre> <span class="pl-c"><span class="pl-c">#</span> Post request with the body 'foo=bar&amp;bar=baz&amp;bar=blah'</span>
 $ curl --data <span class="pl-s"><span class="pl-pds">'</span>foo=bar&amp;bar=baz&amp;bar=blah<span class="pl-pds">'</span></span> localhost/test</pre></div>
<p dir="auto">will yield the response body like</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo: bar
 bar: baz, blah"><pre> foo: bar
 bar: baz, blah</pre></div>
<p dir="auto">Multiple occurrences of an argument key will result in a table value holding all of the values for that key in order.</p>
<p dir="auto">Keys and values will be unescaped according to URI escaping rules.</p>
<p dir="auto">With the settings above,</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 # POST request with body 'a%20b=1%61+2'
 $ curl -d 'a%20b=1%61+2' localhost/test"><pre> <span class="pl-c"><span class="pl-c">#</span> POST request with body 'a%20b=1%61+2'</span>
 $ curl -d <span class="pl-s"><span class="pl-pds">'</span>a%20b=1%61+2<span class="pl-pds">'</span></span> localhost/test</pre></div>
<p dir="auto">will yield:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 a b: 1a 2"><pre> a b: 1a 2</pre></div>
<p dir="auto">Arguments without the <code>=&lt;value&gt;</code> parts are treated as boolean arguments. <code>POST /test</code> with the request body <code>foo&amp;bar</code> will yield:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo: true
 bar: true"><pre> foo: <span class="pl-c1">true</span>
 bar: <span class="pl-c1">true</span></pre></div>
<p dir="auto">That is, they will take Lua boolean values <code>true</code>. However, they are different from arguments taking empty string values. <code>POST /test</code> with request body <code>foo=&amp;bar=</code> will return something like</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 foo:
 bar:"><pre> foo:
 bar:</pre></div>
<p dir="auto">Empty key arguments are discarded. <code>POST /test</code> with body <code>=hello&amp;=world</code> will yield empty outputs for instance.</p>
<p dir="auto">Note that a maximum of 100 request arguments are parsed by default (including those with the same name) and that additional request arguments are silently discarded to guard against potential denial of service attacks. Since <code>v0.10.13</code>, when the limit is exceeded, it will return a second value which is the string <code>"truncated"</code>.</p>
<p dir="auto">However, the optional <code>max_args</code> function argument can be used to override this limit:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local args, err = ngx.req.get_post_args(10)
 if err == &quot;truncated&quot; then
     -- one can choose to ignore or reject the current request here
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">args</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_post_args</span>(<span class="pl-c1">10</span>)
 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>truncated<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> one can choose to ignore or reject the current request here</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This argument can be set to zero to remove the limit and to process all request arguments received:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local args, err = ngx.req.get_post_args(0)"><pre> <span class="pl-k">local</span> <span class="pl-smi">args</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_post_args</span>(<span class="pl-c1">0</span>)</pre></div>
<p dir="auto">Removing the <code>max_args</code> cap is strongly discouraged.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_headers</h2><a id="user-content-ngxreqget_headers" class="anchor" aria-label="Permalink: ngx.req.get_headers" href="#ngxreqget_headers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>headers, err = ngx.req.get_headers(max_headers?, raw?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Returns a Lua table holding all the current request headers.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local h, err = ngx.req.get_headers()

 if err == &quot;truncated&quot; then
     -- one can choose to ignore or reject the current request here
 end

 for k, v in pairs(h) do
     ...
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">h</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_headers</span>()

 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>truncated<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> one can choose to ignore or reject the current request here</span>
 <span class="pl-k">end</span>

 <span class="pl-k">for</span> <span class="pl-smi">k</span>, <span class="pl-smi">v</span> <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(<span class="pl-smi">h</span>) <span class="pl-k">do</span>
     <span class="pl-c1">...</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">To read an individual header:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(&quot;Host: &quot;, ngx.req.get_headers()[&quot;Host&quot;])"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>Host: <span class="pl-pds">"</span></span>, <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_headers</span>()[<span class="pl-s"><span class="pl-pds">"</span>Host<span class="pl-pds">"</span></span>])</pre></div>
<p dir="auto">Note that the <a href="#ngxvarvariable">ngx.var.HEADER</a> API call, which uses core <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_http_" rel="nofollow">$http_HEADER</a> variables, may be more preferable for reading individual request headers.</p>
<p dir="auto">For multiple instances of request headers such as:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 Foo: foo
 Foo: bar
 Foo: baz"><pre> Foo: foo
 Foo: bar
 Foo: baz</pre></div>
<p dir="auto">the value of <code>ngx.req.get_headers()["Foo"]</code> will be a Lua (array) table such as:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 {&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;}"><pre> {<span class="pl-s"><span class="pl-pds">"</span>foo<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>baz<span class="pl-pds">"</span></span>}</pre></div>
<p dir="auto">Note that a maximum of 100 request headers are parsed by default (including those with the same name) and that additional request headers are silently discarded to guard against potential denial of service attacks. Since <code>v0.10.13</code>, when the limit is exceeded, it will return a second value which is the string <code>"truncated"</code>.</p>
<p dir="auto">However, the optional <code>max_headers</code> function argument can be used to override this limit:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local headers, err = ngx.req.get_headers(10)

 if err == &quot;truncated&quot; then
     -- one can choose to ignore or reject the current request here
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">headers</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_headers</span>(<span class="pl-c1">10</span>)

 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>truncated<span class="pl-pds">" </span></span><span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> one can choose to ignore or reject the current request here</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This argument can be set to zero to remove the limit and to process all request headers received:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local headers, err = ngx.req.get_headers(0)"><pre> <span class="pl-k">local</span> <span class="pl-smi">headers</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_headers</span>(<span class="pl-c1">0</span>)</pre></div>
<p dir="auto">Removing the <code>max_headers</code> cap is strongly discouraged.</p>
<p dir="auto">Since the <code>0.6.9</code> release, all the header names in the Lua table returned are converted to the pure lower-case form by default, unless the <code>raw</code> argument is set to <code>true</code> (default to <code>false</code>).</p>
<p dir="auto">Also, by default, an <code>__index</code> metamethod is added to the resulting Lua table and will normalize the keys to a pure lowercase form with all underscores converted to dashes in case of a lookup miss. For example, if a request header <code>My-Foo-Header</code> is present, then the following invocations will all pick up the value of this header correctly:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(headers.my_foo_header)
 ngx.say(headers[&quot;My-Foo-Header&quot;])
 ngx.say(headers[&quot;my-foo-header&quot;])"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">headers</span>.<span class="pl-e">my_foo_header</span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">headers</span>[<span class="pl-s"><span class="pl-pds">"</span>My-Foo-Header<span class="pl-pds">"</span></span>])
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">headers</span>[<span class="pl-s"><span class="pl-pds">"</span>my-foo-header<span class="pl-pds">"</span></span>])</pre></div>
<p dir="auto">The <code>__index</code> metamethod will not be added when the <code>raw</code> argument is set to <code>true</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_header</h2><a id="user-content-ngxreqset_header" class="anchor" aria-label="Permalink: ngx.req.set_header" href="#ngxreqset_header"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_header(header_name, header_value)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*</em></p>
<p dir="auto">Set the current request's request header named <code>header_name</code> to value <code>header_value</code>, overriding any existing ones.</p>
<p dir="auto">The input Lua string <code>header_name</code> and <code>header_value</code> should already be well-formed with the URI encoding.
For security considerations, this method will automatically escape " ", """, "(", ")", ",", "/", ":", ";", "?",
"&lt;", "=", "&gt;", "?", "@", "[", "]", "", "{", "}", 0x00-0x1F, 0x7F-0xFF in <code>header_name</code> and automatically escape
"0x00-0x08, 0x0A-0x0F, 0x7F in <code>header_value</code>.</p>
<p dir="auto">By default, all the subrequests subsequently initiated by <a href="#ngxlocationcapture">ngx.location.capture</a> and <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> will inherit the new header.</p>
<p dir="auto">It is not a Lua's equivalent of nginx <code>proxy_set_header</code> directive (same is true about <a href="#ngxreqclear_header">ngx.req.clear_header</a>). <code>proxy_set_header</code> only affects the upstream request while <code>ngx.req.set_header</code> change the incoming request. Record the http headers in the access log file will show the difference. But you still can use it as an alternative of nginx <code>proxy_set_header</code> directive as long as you know the difference.</p>
<p dir="auto">Here is an example of setting the <code>Content-Type</code> header:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_header(&quot;Content-Type&quot;, &quot;text/css&quot;)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_header</span>(<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>text/css<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">The <code>header_value</code> can take an array list of values,
for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_header(&quot;Foo&quot;, {&quot;a&quot;, &quot;abc&quot;})"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_header</span>(<span class="pl-s"><span class="pl-pds">"</span>Foo<span class="pl-pds">"</span></span>, {<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>})</pre></div>
<p dir="auto">will produce two new request headers:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 Foo: a
 Foo: abc"><pre> Foo: a
 Foo: abc</pre></div>
<p dir="auto">and old <code>Foo</code> headers will be overridden if there is any.</p>
<p dir="auto">When the <code>header_value</code> argument is <code>nil</code>, the request header will be removed. So</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.set_header(&quot;X-Foo&quot;, nil)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">set_header</span>(<span class="pl-s"><span class="pl-pds">"</span>X-Foo<span class="pl-pds">"</span></span>, <span class="pl-c1">nil</span>)</pre></div>
<p dir="auto">is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.clear_header(&quot;X-Foo&quot;)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">clear_header</span>(<span class="pl-s"><span class="pl-pds">"</span>X-Foo<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">Note: this function throws a Lua error if <code>header_name</code> or
<code>header_value</code> contain unsafe characters (control characters).</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.clear_header</h2><a id="user-content-ngxreqclear_header" class="anchor" aria-label="Permalink: ngx.req.clear_header" href="#ngxreqclear_header"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.clear_header(header_name)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*</em></p>
<p dir="auto">Clears the current request's request header named <code>header_name</code>. None of the current request's existing subrequests will be affected but subsequently initiated subrequests will inherit the change by default.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.read_body</h2><a id="user-content-ngxreqread_body" class="anchor" aria-label="Permalink: ngx.req.read_body" href="#ngxreqread_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.read_body()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Reads the client request body synchronously without blocking the Nginx event loop.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.read_body()
 local args = ngx.req.get_post_args()"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">read_body</span>()
 <span class="pl-k">local</span> <span class="pl-smi">args</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">get_post_args</span>()</pre></div>
<p dir="auto">If the request body is already read previously by turning on <a href="#lua_need_request_body">lua_need_request_body</a> or by using other modules, then this function does not run and returns immediately.</p>
<p dir="auto">If the request body has already been explicitly discarded, either by the <a href="#ngxreqdiscard_body">ngx.req.discard_body</a> function or other modules, this function does not run and returns immediately.</p>
<p dir="auto">In case of errors, such as connection errors while reading the data, this method will throw out a Lua exception <em>or</em> terminate the current request with a 500 status code immediately.</p>
<p dir="auto">The request body data read using this function can be retrieved later via <a href="#ngxreqget_body_data">ngx.req.get_body_data</a> or, alternatively, the temporary file name for the body data cached to disk using <a href="#ngxreqget_body_file">ngx.req.get_body_file</a>. This depends on</p>
<ol dir="auto">
<li>whether the current request body is already larger than the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" rel="nofollow">client_body_buffer_size</a>,</li>
<li>and whether <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_file_only" rel="nofollow">client_body_in_file_only</a> has been switched on.</li>
</ol>
<p dir="auto">In cases where current request may have a request body and the request body data is not required, The <a href="#ngxreqdiscard_body">ngx.req.discard_body</a> function must be used to explicitly discard the request body to avoid breaking things under HTTP 1.1 keepalive or HTTP 1.1 pipelining.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc17</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.discard_body</h2><a id="user-content-ngxreqdiscard_body" class="anchor" aria-label="Permalink: ngx.req.discard_body" href="#ngxreqdiscard_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.discard_body()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Explicitly discard the request body, i.e., read the data on the connection and throw it away immediately (without using the request body by any means).</p>
<p dir="auto">This function is an asynchronous call and returns immediately.</p>
<p dir="auto">If the request body has already been read, this function does nothing and returns immediately.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc17</code> release.</p>
<p dir="auto">See also <a href="#ngxreqread_body">ngx.req.read_body</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_body_data</h2><a id="user-content-ngxreqget_body_data" class="anchor" aria-label="Permalink: ngx.req.get_body_data" href="#ngxreqget_body_data"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>data = ngx.req.get_body_data(max_bytes?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, log_by_lua*</em></p>
<p dir="auto">Retrieves in-memory request body data. It returns a Lua string rather than a Lua table holding all the parsed query arguments. Use the <a href="#ngxreqget_post_args">ngx.req.get_post_args</a> function instead if a Lua table is required.</p>
<p dir="auto">The optional <code>max_bytes</code> argument can be used when you don't need the entire body.</p>
<p dir="auto">This function returns <code>nil</code> if</p>
<ol dir="auto">
<li>the request body has not been read,</li>
<li>the request body has been read into disk temporary files,</li>
<li>or the request body has zero size.</li>
</ol>
<p dir="auto">If the request body has not been read yet, call <a href="#ngxreqread_body">ngx.req.read_body</a> first (or turn on <a href="#lua_need_request_body">lua_need_request_body</a> to force this module to read the request body. This is not recommended however).</p>
<p dir="auto">If the request body has been read into disk files, try calling the <a href="#ngxreqget_body_file">ngx.req.get_body_file</a> function instead.</p>
<p dir="auto">To force in-memory request bodies, try setting <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" rel="nofollow">client_body_buffer_size</a> to the same size value in <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" rel="nofollow">client_max_body_size</a>.</p>
<p dir="auto">Note that calling this function instead of using <code>ngx.var.request_body</code> or <code>ngx.var.echo_request_body</code> is more efficient because it can save one dynamic memory allocation and one data copy.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc17</code> release.</p>
<p dir="auto">See also <a href="#ngxreqget_body_file">ngx.req.get_body_file</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.get_body_file</h2><a id="user-content-ngxreqget_body_file" class="anchor" aria-label="Permalink: ngx.req.get_body_file" href="#ngxreqget_body_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>file_name = ngx.req.get_body_file()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Retrieves the file name for the in-file request body data. Returns <code>nil</code> if the request body has not been read or has been read into memory.</p>
<p dir="auto">The returned file is read only and is usually cleaned up by Nginx's memory pool. It should not be manually modified, renamed, or removed in Lua code.</p>
<p dir="auto">If the request body has not been read yet, call <a href="#ngxreqread_body">ngx.req.read_body</a> first (or turn on <a href="#lua_need_request_body">lua_need_request_body</a> to force this module to read the request body. This is not recommended however).</p>
<p dir="auto">If the request body has been read into memory, try calling the <a href="#ngxreqget_body_data">ngx.req.get_body_data</a> function instead.</p>
<p dir="auto">To force in-file request bodies, try turning on <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_file_only" rel="nofollow">client_body_in_file_only</a>.</p>
<p dir="auto">Note that this function is also work for balancer phase but it needs to call <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#recreate_request">balancer.recreate_request</a> to make the change take effect after set the request body data or headers.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc17</code> release.</p>
<p dir="auto">See also <a href="#ngxreqget_body_data">ngx.req.get_body_data</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_body_data</h2><a id="user-content-ngxreqset_body_data" class="anchor" aria-label="Permalink: ngx.req.set_body_data" href="#ngxreqset_body_data"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_body_data(data)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, balancer_by_lua*,</em></p>
<p dir="auto">Set the current request's request body using the in-memory data specified by the <code>data</code> argument.</p>
<p dir="auto">If the request body has not been read yet, call <a href="#ngxreqread_body">ngx.req.read_body</a> first (or turn on <a href="#lua_need_request_body">lua_need_request_body</a> to force this module to read the request body. This is not recommended however). Additionally, the request body must not have been previously discarded by <a href="#ngxreqdiscard_body">ngx.req.discard_body</a>.</p>
<p dir="auto">Whether the previous request body has been read into memory or buffered into a disk file, it will be freed or the disk file will be cleaned up immediately, respectively.</p>
<p dir="auto">Note that this function is also work for balancer phase but it needs to call <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#recreate_request">balancer.recreate_request</a> to make the change take effect after set the request body data or headers.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc18</code> release.</p>
<p dir="auto">See also <a href="#ngxreqset_body_file">ngx.req.set_body_file</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.set_body_file</h2><a id="user-content-ngxreqset_body_file" class="anchor" aria-label="Permalink: ngx.req.set_body_file" href="#ngxreqset_body_file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.set_body_file(file_name, auto_clean?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, balancer_by_lua*,</em></p>
<p dir="auto">Set the current request's request body using the in-file data specified by the <code>file_name</code> argument.</p>
<p dir="auto">If the request body has not been read yet, call <a href="#ngxreqread_body">ngx.req.read_body</a> first (or turn on <a href="#lua_need_request_body">lua_need_request_body</a> to force this module to read the request body. This is not recommended however). Additionally, the request body must not have been previously discarded by <a href="#ngxreqdiscard_body">ngx.req.discard_body</a>.</p>
<p dir="auto">If the optional <code>auto_clean</code> argument is given a <code>true</code> value, then this file will be removed at request completion or the next time this function or <a href="#ngxreqset_body_data">ngx.req.set_body_data</a> are called in the same request. The <code>auto_clean</code> is default to <code>false</code>.</p>
<p dir="auto">Please ensure that the file specified by the <code>file_name</code> argument exists and is readable by an Nginx worker process by setting its permission properly to avoid Lua exception errors.</p>
<p dir="auto">Whether the previous request body has been read into memory or buffered into a disk file, it will be freed or the disk file will be cleaned up immediately, respectively.</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc18</code> release.</p>
<p dir="auto">See also <a href="#ngxreqset_body_data">ngx.req.set_body_data</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.init_body</h2><a id="user-content-ngxreqinit_body" class="anchor" aria-label="Permalink: ngx.req.init_body" href="#ngxreqinit_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.init_body(buffer_size?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Creates a new blank request body for the current request and initializes the buffer for later request body data writing via the <a href="#ngxreqappend_body">ngx.req.append_body</a> and <a href="#ngxreqfinish_body">ngx.req.finish_body</a> APIs.</p>
<p dir="auto">If the <code>buffer_size</code> argument is specified, then its value will be used for the size of the memory buffer for body writing with <a href="#ngxreqappend_body">ngx.req.append_body</a>. If the argument is omitted, then the value specified by the standard <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" rel="nofollow">client_body_buffer_size</a> directive will be used instead.</p>
<p dir="auto">When the data can no longer be hold in the memory buffer for the request body, then the data will be flushed onto a temporary file just like the standard request body reader in the Nginx core.</p>
<p dir="auto">It is important to always call the <a href="#ngxreqfinish_body">ngx.req.finish_body</a> after all the data has been appended onto the current request body. Also, when this function is used together with <a href="#ngxreqsocket">ngx.req.socket</a>, it is required to call <a href="#ngxreqsocket">ngx.req.socket</a> <em>before</em> this function, or you will get the "request body already exists" error message.</p>
<p dir="auto">The usage of this function is often like this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.req.init_body(128 * 1024)  -- buffer is 128KB
 for chunk in next_data_chunk() do
     ngx.req.append_body(chunk) -- each chunk can be 4KB
 end
 ngx.req.finish_body()"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">init_body</span>(<span class="pl-c1">128</span> <span class="pl-k">*</span> <span class="pl-c1">1024</span>)  <span class="pl-c"><span class="pl-c">--</span> buffer is 128KB</span>
 <span class="pl-k">for</span> <span class="pl-smi">chunk</span> <span class="pl-k">in</span> <span class="pl-c1">next_data_chunk</span>() <span class="pl-k">do</span>
     <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">append_body</span>(<span class="pl-smi">chunk</span>) <span class="pl-c"><span class="pl-c">--</span> each chunk can be 4KB</span>
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-e">req</span>.<span class="pl-c1">finish_body</span>()</pre></div>
<p dir="auto">This function can be used with <a href="#ngxreqappend_body">ngx.req.append_body</a>, <a href="#ngxreqfinish_body">ngx.req.finish_body</a>, and <a href="#ngxreqsocket">ngx.req.socket</a> to implement efficient input filters in pure Lua (in the context of <a href="#rewrite_by_lua">rewrite_by_lua*</a> or <a href="#access_by_lua">access_by_lua*</a>), which can be used with other Nginx content handler or upstream modules like <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_http_proxy_module</a> and <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" rel="nofollow">ngx_http_fastcgi_module</a>.</p>
<p dir="auto">This function was first introduced in the <code>v0.5.11</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.append_body</h2><a id="user-content-ngxreqappend_body" class="anchor" aria-label="Permalink: ngx.req.append_body" href="#ngxreqappend_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.append_body(data_chunk)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Append new data chunk specified by the <code>data_chunk</code> argument onto the existing request body created by the <a href="#ngxreqinit_body">ngx.req.init_body</a> call.</p>
<p dir="auto">When the data can no longer be hold in the memory buffer for the request body, then the data will be flushed onto a temporary file just like the standard request body reader in the Nginx core.</p>
<p dir="auto">It is important to always call the <a href="#ngxreqfinish_body">ngx.req.finish_body</a> after all the data has been appended onto the current request body.</p>
<p dir="auto">This function can be used with <a href="#ngxreqinit_body">ngx.req.init_body</a>, <a href="#ngxreqfinish_body">ngx.req.finish_body</a>, and <a href="#ngxreqsocket">ngx.req.socket</a> to implement efficient input filters in pure Lua (in the context of <a href="#rewrite_by_lua">rewrite_by_lua*</a> or <a href="#access_by_lua">access_by_lua*</a>), which can be used with other Nginx content handler or upstream modules like <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_http_proxy_module</a> and <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" rel="nofollow">ngx_http_fastcgi_module</a>.</p>
<p dir="auto">This function was first introduced in the <code>v0.5.11</code> release.</p>
<p dir="auto">See also <a href="#ngxreqinit_body">ngx.req.init_body</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.finish_body</h2><a id="user-content-ngxreqfinish_body" class="anchor" aria-label="Permalink: ngx.req.finish_body" href="#ngxreqfinish_body"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.req.finish_body()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Completes the construction process of the new request body created by the <a href="#ngxreqinit_body">ngx.req.init_body</a> and <a href="#ngxreqappend_body">ngx.req.append_body</a> calls.</p>
<p dir="auto">This function can be used with <a href="#ngxreqinit_body">ngx.req.init_body</a>, <a href="#ngxreqappend_body">ngx.req.append_body</a>, and <a href="#ngxreqsocket">ngx.req.socket</a> to implement efficient input filters in pure Lua (in the context of <a href="#rewrite_by_lua">rewrite_by_lua*</a> or <a href="#access_by_lua">access_by_lua*</a>), which can be used with other Nginx content handler or upstream modules like <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_http_proxy_module</a> and <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" rel="nofollow">ngx_http_fastcgi_module</a>.</p>
<p dir="auto">This function was first introduced in the <code>v0.5.11</code> release.</p>
<p dir="auto">See also <a href="#ngxreqinit_body">ngx.req.init_body</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.req.socket</h2><a id="user-content-ngxreqsocket" class="anchor" aria-label="Permalink: ngx.req.socket" href="#ngxreqsocket"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock, err = ngx.req.socket()</em></p>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock, err = ngx.req.socket(raw)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Returns a read-only cosocket object that wraps the downstream connection. Only <a href="#tcpsockreceive">receive</a>, <a href="#tcpsockreceiveany">receiveany</a> and <a href="#tcpsockreceiveuntil">receiveuntil</a> methods are supported on this object.</p>
<p dir="auto">In case of error, <code>nil</code> will be returned as well as a string describing the error.</p>
<p dir="auto"><strong>Note:</strong> This method will block while waiting for client request body to be fully received. Block time depends on the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_timeout" rel="nofollow">client_body_timeout</a> directive and maximum body size specified by the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" rel="nofollow">client_max_body_size</a> directive. If read timeout occurs or client body size exceeds the defined limit, this function will not return and <code>408 Request Time-out</code> or <code>413 Request Entity Too Large</code> response will be returned to the client instead.</p>
<p dir="auto">The socket object returned by this method is usually used to read the current request's body in a streaming fashion. Do not turn on the <a href="#lua_need_request_body">lua_need_request_body</a> directive, and do not mix this call with <a href="#ngxreqread_body">ngx.req.read_body</a> and <a href="#ngxreqdiscard_body">ngx.req.discard_body</a>.</p>
<p dir="auto">If any request body data has been pre-read into the Nginx core request header buffer, the resulting cosocket object will take care of this to avoid potential data loss resulting from such pre-reading.
Chunked request bodies are not yet supported in this API.</p>
<p dir="auto">Since the <code>v0.9.0</code> release, this function accepts an optional boolean <code>raw</code> argument. When this argument is <code>true</code>, this function returns a full-duplex cosocket object wrapping around the raw downstream connection socket, upon which you can call the <a href="#tcpsockreceive">receive</a>, <a href="#tcpsockreceiveany">receiveany</a>, <a href="#tcpsockreceiveuntil">receiveuntil</a>, and <a href="#tcpsocksend">send</a> methods.</p>
<p dir="auto">When the <code>raw</code> argument is <code>true</code>, it is required that no pending data from any previous <a href="#ngxsay">ngx.say</a>, <a href="#ngxprint">ngx.print</a>, or <a href="#ngxsend_headers">ngx.send_headers</a> calls exists. So if you have these downstream output calls previously, you should call <a href="#ngxflush">ngx.flush(true)</a> before calling <code>ngx.req.socket(true)</code> to ensure that there is no pending output data. If the request body has not been read yet, then this "raw socket" can also be used to read the request body.</p>
<p dir="auto">You can use the "raw request socket" returned by <code>ngx.req.socket(true)</code> to implement fancy protocols like <a href="https://en.wikipedia.org/wiki/WebSocket" rel="nofollow">WebSocket</a>, or just emit your own raw HTTP response header or body data. You can refer to the <a href="https://github.com/openresty/lua-resty-websocket">lua-resty-websocket library</a> for a real world example.</p>
<p dir="auto">This function was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.exec</h2><a id="user-content-ngxexec" class="anchor" aria-label="Permalink: ngx.exec" href="#ngxexec"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.exec(uri, args?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Does an internal redirect to <code>uri</code> with <code>args</code> and is similar to the <a href="http://github.com/openresty/echo-nginx-module#echo_exec">echo_exec</a> directive of the <a href="http://github.com/openresty/echo-nginx-module">echo-nginx-module</a>.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.exec('/some-location')
 ngx.exec('/some-location', 'a=3&amp;b=5&amp;c=6')
 ngx.exec('/some-location?a=3&amp;b=5', 'c=6')"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">exec</span>(<span class="pl-s"><span class="pl-pds">'</span>/some-location<span class="pl-pds">'</span></span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">exec</span>(<span class="pl-s"><span class="pl-pds">'</span>/some-location<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>a=3&amp;b=5&amp;c=6<span class="pl-pds">'</span></span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">exec</span>(<span class="pl-s"><span class="pl-pds">'</span>/some-location?a=3&amp;b=5<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>c=6<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">The optional second <code>args</code> can be used to specify extra URI query arguments, for example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.exec(&quot;/foo&quot;, &quot;a=3&amp;b=hello%20world&quot;)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">exec</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a=3&amp;b=hello%20world<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">Alternatively, a Lua table can be passed for the <code>args</code> argument for ngx_lua to carry out URI escaping and string concatenation.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.exec(&quot;/foo&quot;, { a = 3, b = &quot;hello world&quot; })"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">exec</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, { <span class="pl-smi">a</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, <span class="pl-smi">b</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">" </span></span>})</pre></div>
<p dir="auto">The result is exactly the same as the previous example.</p>
<p dir="auto">The format for the Lua table passed as the <code>args</code> argument is identical to the format used in the <a href="#ngxencode_args">ngx.encode_args</a> method.</p>
<p dir="auto">Named locations are also supported but the second <code>args</code> argument will be ignored if present and the querystring for the new target is inherited from the referring location (if any).</p>
<p dir="auto"><code>GET /foo/file.php?a=hello</code> will return "hello" and not "goodbye" in the example below</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /foo {
     content_by_lua_block {
         ngx.exec(&quot;@bar&quot;, &quot;a=goodbye&quot;)
     }
 }

 location @bar {
     content_by_lua_block {
         local args = ngx.req.get_uri_args()
         for key, val in pairs(args) do
             if key == &quot;a&quot; then
                 ngx.say(val)
             end
         end
     }
 }"><pre> <span class="pl-c1">location</span> /foo <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.exec<span class="pl-c1">(</span><span class="pl-s">"@bar"</span>, <span class="pl-s">"a=goodbye"</span><span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span>

 <span class="pl-c1">location</span> @bar <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local args = ngx.req.get_uri_args<span class="pl-c1">()</span>
         <span class="pl-k">for</span> key, val in pairs<span class="pl-c1">(</span>args<span class="pl-c1">)</span> do
             <span class="pl-k">if</span> key == <span class="pl-s">"a"</span> then
                 ngx.say<span class="pl-c1">(</span>val<span class="pl-c1">)</span>
             end
         end
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Note that the <code>ngx.exec</code> method is different from <a href="#ngxredirect">ngx.redirect</a> in that
it is purely an internal redirect and that no new external HTTP traffic is involved.</p>
<p dir="auto">Also note that this method call terminates the processing of the current request and that it <em>must</em> be called before <a href="#ngxsend_headers">ngx.send_headers</a> or explicit response body
outputs by either <a href="#ngxprint">ngx.print</a> or <a href="#ngxsay">ngx.say</a>.</p>
<p dir="auto">It is recommended that a coding style that combines this method call with the <code>return</code> statement, i.e., <code>return ngx.exec(...)</code> be adopted when this method call is used in contexts other than <a href="#header_filter_by_lua">header_filter_by_lua*</a> to reinforce the fact that the request processing is being terminated.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.redirect</h2><a id="user-content-ngxredirect" class="anchor" aria-label="Permalink: ngx.redirect" href="#ngxredirect"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.redirect(uri, status?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Issue an <code>HTTP 301</code> or <code>302</code> redirection to <code>uri</code>.</p>
<p dir="auto">Note: this function throws a Lua error if the <code>uri</code> argument
contains unsafe characters (control characters).</p>
<p dir="auto">The optional <code>status</code> parameter specifies the HTTP status code to be used. The following status codes are supported right now:</p>
<ul dir="auto">
<li><code>301</code></li>
<li><code>302</code> (default)</li>
<li><code>303</code></li>
<li><code>307</code></li>
<li><code>308</code></li>
</ul>
<p dir="auto">It is <code>302</code> (<code>ngx.HTTP_MOVED_TEMPORARILY</code>) by default.</p>
<p dir="auto">Here is an example assuming the current server name is <code>localhost</code> and that it is listening on port 1984:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect(&quot;/foo&quot;)"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">which is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect(&quot;/foo&quot;, ngx.HTTP_MOVED_TEMPORARILY)"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_MOVED_TEMPORARILY</span>)</pre></div>
<p dir="auto">Redirecting arbitrary external URLs is also supported, for example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect(&quot;http://www.google.com&quot;)"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">"</span>http://www.google.com<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">We can also use the numerical code directly as the second <code>status</code> argument:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect(&quot;/foo&quot;, 301)"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, <span class="pl-c1">301</span>)</pre></div>
<p dir="auto">This method is similar to the <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" rel="nofollow">rewrite</a> directive with the <code>redirect</code> modifier in the standard
<a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">ngx_http_rewrite_module</a>, for example, this <code>nginx.conf</code> snippet</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite ^ /foo? redirect;  # nginx config"><pre> <span class="pl-c1">rewrite</span> ^ /foo? redirect<span class="pl-c1">;</span>  # nginx config</pre></div>
<p dir="auto">is equivalent to the following Lua code</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect('/foo')  -- Lua code"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo<span class="pl-pds">'</span></span>)  <span class="pl-c"><span class="pl-c">--</span> Lua code</span></pre></div>
<p dir="auto">while</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 rewrite ^ /foo? permanent;  # nginx config"><pre> <span class="pl-c1">rewrite</span> ^ /foo? permanent<span class="pl-c1">;</span>  # nginx config</pre></div>
<p dir="auto">is equivalent to</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect('/foo', ngx.HTTP_MOVED_PERMANENTLY)  -- Lua code"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo<span class="pl-pds">'</span></span>, <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_MOVED_PERMANENTLY</span>)  <span class="pl-c"><span class="pl-c">--</span> Lua code</span></pre></div>
<p dir="auto">URI arguments can be specified as well, for example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 return ngx.redirect('/foo?a=3&amp;b=4')"><pre> <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/foo?a=3&amp;b=4<span class="pl-pds">'</span></span>)</pre></div>
<p dir="auto">Note that this method call terminates the processing of the current request and that it <em>must</em> be called before <a href="#ngxsend_headers">ngx.send_headers</a> or explicit response body
outputs by either <a href="#ngxprint">ngx.print</a> or <a href="#ngxsay">ngx.say</a>.</p>
<p dir="auto">It is recommended that a coding style that combines this method call with the <code>return</code> statement, i.e., <code>return ngx.redirect(...)</code> be adopted when this method call is used in contexts other than <a href="#header_filter_by_lua">header_filter_by_lua*</a> to reinforce the fact that the request processing is being terminated.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.send_headers</h2><a id="user-content-ngxsend_headers" class="anchor" aria-label="Permalink: ngx.send_headers" href="#ngxsend_headers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.send_headers()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Explicitly send out the response headers.</p>
<p dir="auto">Since <code>v0.8.3</code> this function returns <code>1</code> on success, or returns <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto">Note that there is normally no need to manually send out response headers as ngx_lua will automatically send headers out
before content is output with <a href="#ngxsay">ngx.say</a> or <a href="#ngxprint">ngx.print</a> or when <a href="#content_by_lua">content_by_lua*</a> exits normally.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.headers_sent</h2><a id="user-content-ngxheaders_sent" class="anchor" aria-label="Permalink: ngx.headers_sent" href="#ngxheaders_sent"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>value = ngx.headers_sent</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Returns <code>true</code> if the response headers have been sent (by ngx_lua), and <code>false</code> otherwise.</p>
<p dir="auto">This API was first introduced in ngx_lua v0.3.1rc6.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.print</h2><a id="user-content-ngxprint" class="anchor" aria-label="Permalink: ngx.print" href="#ngxprint"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.print(...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Emits arguments concatenated to the HTTP client (as response body). If response headers have not been sent, this function will send headers out first and then output body data.</p>
<p dir="auto">Since <code>v0.8.3</code> this function returns <code>1</code> on success, or returns <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto">Lua <code>nil</code> values will output <code>"nil"</code> strings and Lua boolean values will output <code>"true"</code> and <code>"false"</code> literal strings respectively.</p>
<p dir="auto">Nested arrays of strings are permitted and the elements in the arrays will be sent one by one:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local table = {
     &quot;hello, &quot;,
     {&quot;world: &quot;, true, &quot; or &quot;, false,
         {&quot;: &quot;, nil}}
 }
 ngx.print(table)"><pre> <span class="pl-k">local</span> <span class="pl-smi">table</span> <span class="pl-k">=</span> {
     <span class="pl-s"><span class="pl-pds">"</span>hello, <span class="pl-pds">"</span></span>,
     {<span class="pl-s"><span class="pl-pds">"</span>world: <span class="pl-pds">"</span></span>, <span class="pl-c1">true</span>, <span class="pl-s"><span class="pl-pds">"</span> or <span class="pl-pds">"</span></span>, <span class="pl-c1">false</span>,
         {<span class="pl-s"><span class="pl-pds">"</span>: <span class="pl-pds">"</span></span>, <span class="pl-c1">nil</span>}}
 }
 <span class="pl-smi">ngx</span>.<span class="pl-c1">print</span>(<span class="pl-smi">table</span>)</pre></div>
<p dir="auto">will yield the output</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 hello, world: true or false: nil"><pre> hello, world: <span class="pl-c1">true</span> or false: nil</pre></div>
<p dir="auto">Non-array table arguments will cause a Lua exception to be thrown.</p>
<p dir="auto">The <code>ngx.null</code> constant will yield the <code>"null"</code> string output.</p>
<p dir="auto">This is an asynchronous call and will return immediately without waiting for all the data to be written into the system send buffer. To run in synchronous mode, call <code>ngx.flush(true)</code> after calling <code>ngx.print</code>. This can be particularly useful for streaming output. See <a href="#ngxflush">ngx.flush</a> for more details.</p>
<p dir="auto">Please note that both <code>ngx.print</code> and <a href="#ngxsay">ngx.say</a> will always invoke the whole Nginx output body filter chain, which is an expensive operation. So be careful when calling either of these two in a tight loop; buffer the data yourself in Lua and save the calls.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.say</h2><a id="user-content-ngxsay" class="anchor" aria-label="Permalink: ngx.say" href="#ngxsay"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.say(...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Just as <a href="#ngxprint">ngx.print</a> but also emit a trailing newline.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.log</h2><a id="user-content-ngxlog" class="anchor" aria-label="Permalink: ngx.log" href="#ngxlog"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.log(log_level, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Log arguments concatenated to error.log with the given logging level.</p>
<p dir="auto">Lua <code>nil</code> arguments are accepted and result in literal <code>"nil"</code> string while Lua booleans result in literal <code>"true"</code> or <code>"false"</code> string outputs. And the <code>ngx.null</code> constant will yield the <code>"null"</code> string output.</p>
<p dir="auto">The <code>log_level</code> argument can take constants like <code>ngx.ERR</code> and <code>ngx.WARN</code>. Check out <a href="#nginx-log-level-constants">Nginx log level constants</a> for details.</p>
<p dir="auto">There is a hard coded <code>2048</code> byte limitation on error message lengths in the Nginx core. This limit includes trailing newlines and leading time stamps. If the message size exceeds this limit, Nginx will truncate the message text accordingly. This limit can be manually modified by editing the <code>NGX_MAX_ERROR_STR</code> macro definition in the <code>src/core/ngx_log.h</code> file in the Nginx source tree.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.flush</h2><a id="user-content-ngxflush" class="anchor" aria-label="Permalink: ngx.flush" href="#ngxflush"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.flush(wait?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Flushes response output to the client.</p>
<p dir="auto"><code>ngx.flush</code> accepts an optional boolean <code>wait</code> argument (Default: <code>false</code>) first introduced in the <code>v0.3.1rc34</code> release. When called with the default argument, it issues an asynchronous call (Returns immediately without waiting for output data to be written into the system send buffer). Calling the function with the <code>wait</code> argument set to <code>true</code> switches to synchronous mode.</p>
<p dir="auto">In synchronous mode, the function will not return until all output data has been written into the system send buffer or until the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#send_timeout" rel="nofollow">send_timeout</a> setting has expired. Note that using the Lua coroutine mechanism means that this function does not block the Nginx event loop even in the synchronous mode.</p>
<p dir="auto">When <code>ngx.flush(true)</code> is called immediately after <a href="#ngxprint">ngx.print</a> or <a href="#ngxsay">ngx.say</a>, it causes the latter functions to run in synchronous mode. This can be particularly useful for streaming output.</p>
<p dir="auto">Note that <code>ngx.flush</code> is not functional when in the HTTP 1.0 output buffering mode. See <a href="#http-10-support">HTTP 1.0 support</a>.</p>
<p dir="auto">Since <code>v0.8.3</code> this function returns <code>1</code> on success, or returns <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.exit</h2><a id="user-content-ngxexit" class="anchor" aria-label="Permalink: ngx.exit" href="#ngxexit"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.exit(status)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">When <code>status &gt;= 200</code> (i.e., <code>ngx.HTTP_OK</code> and above), it will interrupt the execution of the current request and return status code to Nginx.</p>
<p dir="auto">When <code>status == 0</code> (i.e., <code>ngx.OK</code>), it will only quit the current phase handler (or the content handler if the <a href="#content_by_lua">content_by_lua*</a> directive is used) and continue to run later phases (if any) for the current request.</p>
<p dir="auto">The <code>status</code> argument can be <code>ngx.OK</code>, <code>ngx.ERROR</code>, <code>ngx.HTTP_NOT_FOUND</code>,
<code>ngx.HTTP_MOVED_TEMPORARILY</code>, or other <a href="#http-status-constants">HTTP status constants</a>.</p>
<p dir="auto">To return an error page with custom contents, use code snippets like this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.status = ngx.HTTP_GONE
 ngx.say(&quot;This is our own content&quot;)
 -- to cause quit the whole request rather than the current phase handler
 ngx.exit(ngx.HTTP_OK)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-e">status</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_GONE</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>This is our own content<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> to cause quit the whole request rather than the current phase handler</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">exit</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">HTTP_OK</span>)</pre></div>
<p dir="auto">The effect in action:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 $ curl -i http://localhost/test
 HTTP/1.1 410 Gone
 Server: nginx/1.0.6
 Date: Thu, 15 Sep 2011 00:51:48 GMT
 Content-Type: text/plain
 Transfer-Encoding: chunked
 Connection: keep-alive

 This is our own content"><pre> $ curl -i http://localhost/test
 HTTP/1.1 410 Gone
 Server: nginx/1.0.6
 Date: Thu, 15 Sep 2011 00:51:48 GMT
 Content-Type: text/plain
 Transfer-Encoding: chunked
 Connection: keep-alive

 This is our own content</pre></div>
<p dir="auto">Number literals can be used directly as the argument, for instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.exit(501)"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">exit</span>(<span class="pl-c1">501</span>)</pre></div>
<p dir="auto">Note that while this method accepts all <a href="#http-status-constants">HTTP status constants</a> as input, it only accepts <code>ngx.OK</code> and <code>ngx.ERROR</code> of the <a href="#core-constants">core constants</a>.</p>
<p dir="auto">Also note that this method call terminates the processing of the current request and that it is recommended that a coding style that combines this method call with the <code>return</code> statement, i.e., <code>return ngx.exit(...)</code> be used to reinforce the fact that the request processing is being terminated.</p>
<p dir="auto">When being used in the contexts of <a href="#header_filter_by_lua">header_filter_by_lua*</a>, <a href="#balancer_by_lua_block">balancer_by_lua*</a>, and
<a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua*</a>, <code>ngx.exit()</code> is
an asynchronous operation and will return immediately. This behavior may change in future and it is recommended that users always use <code>return</code> in combination as suggested above.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.eof</h2><a id="user-content-ngxeof" class="anchor" aria-label="Permalink: ngx.eof" href="#ngxeof"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.eof()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Explicitly specify the end of the response output stream. In the case of HTTP 1.1 chunked encoded output, it will just trigger the Nginx core to send out the "last chunk".</p>
<p dir="auto">When you disable the HTTP 1.1 keep-alive feature for your downstream connections, you can rely on well written HTTP clients to close the connection actively for you when you call this method. This trick can be used do back-ground jobs without letting the HTTP clients to wait on the connection, as in the following example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location = /async {
     keepalive_timeout 0;
     content_by_lua_block {
         ngx.say(&quot;got the task!&quot;)
         ngx.eof()  -- well written HTTP clients will close the connection at this point
         -- access MySQL, PostgreSQL, Redis, Memcached, and etc here...
     }
 }"><pre> <span class="pl-c1">location</span> = /async <span class="pl-c1">{</span>
     <span class="pl-c1">keepalive_timeout</span> 0<span class="pl-c1">;</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"got the task!"</span><span class="pl-c1">)</span>
         ngx.eof<span class="pl-c1">()</span>  -- well written HTTP clients will close the connection at this point
         -- access MySQL, PostgreSQL, Redis, Memcached, and etc here...
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">But if you create subrequests to access other locations configured by Nginx upstream modules, then you should configure those upstream modules to ignore client connection abortions if they are not by default. For example, by default the standard <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_http_proxy_module</a> will terminate both the subrequest and the main request as soon as the client closes the connection, so it is important to turn on the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ignore_client_abort" rel="nofollow">proxy_ignore_client_abort</a> directive in your location block configured by <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">ngx_http_proxy_module</a>:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 proxy_ignore_client_abort on;"><pre> <span class="pl-c1">proxy_ignore_client_abort</span> on<span class="pl-c1">;</span></pre></div>
<p dir="auto">A better way to do background jobs is to use the <a href="#ngxtimerat">ngx.timer.at</a> API.</p>
<p dir="auto">Since <code>v0.8.3</code> this function returns <code>1</code> on success, or returns <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.sleep</h2><a id="user-content-ngxsleep" class="anchor" aria-label="Permalink: ngx.sleep" href="#ngxsleep"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.sleep(seconds)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Sleeps for the specified seconds without blocking. One can specify time resolution up to 0.001 seconds (i.e., one millisecond).</p>
<p dir="auto">Behind the scene, this method makes use of the Nginx timers.</p>
<p dir="auto">Since the <code>0.7.20</code> release, The <code>0</code> time argument can also be specified.</p>
<p dir="auto">This method was introduced in the <code>0.5.0rc30</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.escape_uri</h2><a id="user-content-ngxescape_uri" class="anchor" aria-label="Permalink: ngx.escape_uri" href="#ngxescape_uri"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr = ngx.escape_uri(str, type?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Since <code>v0.10.16</code>, this function accepts an optional <code>type</code> argument.
It accepts the following values (defaults to <code>2</code>):</p>
<ul dir="auto">
<li><code>0</code>: escapes <code>str</code> as a full URI. And the characters
<code> </code> (space), <code>#</code>, <code>%</code>,
<code>?</code>, 0x00 ~ 0x1F, 0x7F ~ 0xFF will be escaped.</li>
<li><code>2</code>: escape <code>str</code> as a URI component. All characters except
alphabetic characters, digits, <code>-</code>, <code>.</code>, <code>_</code>,
<code>~</code> will be encoded as <code>%XX</code>.</li>
</ul>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.unescape_uri</h2><a id="user-content-ngxunescape_uri" class="anchor" aria-label="Permalink: ngx.unescape_uri" href="#ngxunescape_uri"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr = ngx.unescape_uri(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Unescape <code>str</code> as an escaped URI component.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(ngx.unescape_uri(&quot;b%20r56+7&quot;))"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">ngx</span>.<span class="pl-c1">unescape_uri</span>(<span class="pl-s"><span class="pl-pds">"</span>b%20r56+7<span class="pl-pds">"</span></span>))</pre></div>
<p dir="auto">gives the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="b r56 7"><pre class="notranslate"><code>b r56 7
</code></pre></div>
<p dir="auto">Invalid escaping sequences are handled in a conventional way: <code>%</code>s are left unchanged. Also, characters that should not appear in escaped string are simply left unchanged.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(ngx.unescape_uri(&quot;try %search%%20%again%&quot;))"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">ngx</span>.<span class="pl-c1">unescape_uri</span>(<span class="pl-s"><span class="pl-pds">"</span>try %search%%20%again%<span class="pl-pds">"</span></span>))</pre></div>
<p dir="auto">gives the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="try %search% %again%"><pre class="notranslate"><code>try %search% %again%
</code></pre></div>
<p dir="auto">(Note that <code>%20</code> following <code>%</code> got unescaped, even it can be considered a part of invalid sequence.)</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.encode_args</h2><a id="user-content-ngxencode_args" class="anchor" aria-label="Permalink: ngx.encode_args" href="#ngxencode_args"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.encode_args(table)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Encode the Lua table to a query args string according to the URI encoded rules.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.encode_args({foo = 3, [&quot;b r&quot;] = &quot;hello world&quot;})"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">encode_args</span>({<span class="pl-smi">foo</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>, [<span class="pl-s"><span class="pl-pds">"</span>b r<span class="pl-pds">"</span></span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>})</pre></div>
<p dir="auto">yields</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="foo=3&amp;b%20r=hello%20world"><pre class="notranslate"><code>foo=3&amp;b%20r=hello%20world
</code></pre></div>
<p dir="auto">The table keys must be Lua strings.</p>
<p dir="auto">Multi-value query args are also supported. Just use a Lua table for the argument's value, for example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.encode_args({baz = {32, &quot;hello&quot;}})"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">encode_args</span>({<span class="pl-smi">baz</span> <span class="pl-k">=</span> {<span class="pl-c1">32</span>, <span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>}})</pre></div>
<p dir="auto">gives</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="baz=32&amp;baz=hello"><pre class="notranslate"><code>baz=32&amp;baz=hello
</code></pre></div>
<p dir="auto">If the value table is empty and the effect is equivalent to the <code>nil</code> value.</p>
<p dir="auto">Boolean argument values are also supported, for instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.encode_args({a = true, b = 1})"><pre> <span class="pl-smi">ngx</span>.<span class="pl-c1">encode_args</span>({<span class="pl-smi">a</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>, <span class="pl-smi">b</span> <span class="pl-k">=</span> <span class="pl-c1">1</span>})</pre></div>
<p dir="auto">yields</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="a&amp;b=1"><pre class="notranslate"><code>a&amp;b=1
</code></pre></div>
<p dir="auto">If the argument value is <code>false</code>, then the effect is equivalent to the <code>nil</code> value.</p>
<p dir="auto">This method was first introduced in the <code>v0.3.1rc27</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.decode_args</h2><a id="user-content-ngxdecode_args" class="anchor" aria-label="Permalink: ngx.decode_args" href="#ngxdecode_args"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>table, err = ngx.decode_args(str, max_args?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Decodes a URI encoded query-string into a Lua table. This is the inverse function of <a href="#ngxencode_args">ngx.encode_args</a>.</p>
<p dir="auto">The optional <code>max_args</code> argument can be used to specify the maximum number of arguments parsed from the <code>str</code> argument. By default, a maximum of 100 request arguments are parsed (including those with the same name) and that additional URI arguments are silently discarded to guard against potential denial of service attacks. Since <code>v0.10.13</code>, when the limit is exceeded, it will return a second value which is the string <code>"truncated"</code>.</p>
<p dir="auto">This argument can be set to zero to remove the limit and to process all request arguments received:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local args = ngx.decode_args(str, 0)"><pre> <span class="pl-k">local</span> <span class="pl-smi">args</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">decode_args</span>(<span class="pl-smi">str</span>, <span class="pl-c1">0</span>)</pre></div>
<p dir="auto">Removing the <code>max_args</code> cap is strongly discouraged.</p>
<p dir="auto">This method was introduced in the <code>v0.5.0rc29</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.encode_base64</h2><a id="user-content-ngxencode_base64" class="anchor" aria-label="Permalink: ngx.encode_base64" href="#ngxencode_base64"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr = ngx.encode_base64(str, no_padding?)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Encodes <code>str</code> to a base64 digest. For base64url encoding use <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/base64.md#encode_base64url"><code>base64.encode_base64url</code></a>.</p>
<p dir="auto">Since the <code>0.9.16</code> release, an optional boolean-typed <code>no_padding</code> argument can be specified to control whether the base64 padding should be appended to the resulting digest (default to <code>false</code>, i.e., with padding enabled).</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.decode_base64</h2><a id="user-content-ngxdecode_base64" class="anchor" aria-label="Permalink: ngx.decode_base64" href="#ngxdecode_base64"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr = ngx.decode_base64(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Decodes the <code>str</code> argument as a base64 digest to the raw form. For base64url decoding use <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/base64.md#decode_base64url"><code>base64.decode_base64url</code></a>.</p>
<p dir="auto">The <code>str</code> should be standard 'base64' encoding for RFC 3548 or RFC 4648, and will returns <code>nil</code> if is not well formed or any characters not in the base encoding alphabet. Padding may be omitted from the input.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.decode_base64mime</h2><a id="user-content-ngxdecode_base64mime" class="anchor" aria-label="Permalink: ngx.decode_base64mime" href="#ngxdecode_base64mime"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr = ngx.decode_base64mime(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*</em></p>
<p dir="auto"><strong>requires:</strong> <code>resty.core.base64</code> or <code>resty.core</code></p>
<p dir="auto">Decodes the <code>str</code> argument as a base64 digest to the raw form.
The <code>str</code> follows base64 transfer encoding for MIME (RFC 2045), and will discard characters outside the base encoding alphabet.
Returns <code>nil</code> if <code>str</code> is not well formed.</p>
<p dir="auto">'''Note:''' This method requires the <code>resty.core.base64</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.crc32_short</h2><a id="user-content-ngxcrc32_short" class="anchor" aria-label="Permalink: ngx.crc32_short" href="#ngxcrc32_short"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>intval = ngx.crc32_short(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Calculates the CRC-32 (Cyclic Redundancy Code) digest for the <code>str</code> argument.</p>
<p dir="auto">This method performs better on relatively short <code>str</code> inputs (i.e., less than 30 ~ 60 bytes), as compared to <a href="#ngxcrc32_long">ngx.crc32_long</a>. The result is exactly the same as <a href="#ngxcrc32_long">ngx.crc32_long</a>.</p>
<p dir="auto">Behind the scene, it is just a thin wrapper around the <code>ngx_crc32_short</code> function defined in the Nginx core.</p>
<p dir="auto">This API was first introduced in the <code>v0.3.1rc8</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.crc32_long</h2><a id="user-content-ngxcrc32_long" class="anchor" aria-label="Permalink: ngx.crc32_long" href="#ngxcrc32_long"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>intval = ngx.crc32_long(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Calculates the CRC-32 (Cyclic Redundancy Code) digest for the <code>str</code> argument.</p>
<p dir="auto">This method performs better on relatively long <code>str</code> inputs (i.e., longer than 30 ~ 60 bytes), as compared to <a href="#ngxcrc32_short">ngx.crc32_short</a>.  The result is exactly the same as <a href="#ngxcrc32_short">ngx.crc32_short</a>.</p>
<p dir="auto">Behind the scene, it is just a thin wrapper around the <code>ngx_crc32_long</code> function defined in the Nginx core.</p>
<p dir="auto">This API was first introduced in the <code>v0.3.1rc8</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.hmac_sha1</h2><a id="user-content-ngxhmac_sha1" class="anchor" aria-label="Permalink: ngx.hmac_sha1" href="#ngxhmac_sha1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>digest = ngx.hmac_sha1(secret_key, str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Computes the <a href="https://en.wikipedia.org/wiki/HMAC" rel="nofollow">HMAC-SHA1</a> digest of the argument <code>str</code> and turns the result using the secret key <code>&lt;secret_key&gt;</code>.</p>
<p dir="auto">The raw binary form of the <code>HMAC-SHA1</code> digest will be generated, use <a href="#ngxencode_base64">ngx.encode_base64</a>, for example, to encode the result to a textual representation if desired.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local key = &quot;thisisverysecretstuff&quot;
 local src = &quot;some string we want to sign&quot;
 local digest = ngx.hmac_sha1(key, src)
 ngx.say(ngx.encode_base64(digest))"><pre> <span class="pl-k">local</span> <span class="pl-smi">key</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>thisisverysecretstuff<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">src</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>some string we want to sign<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">digest</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">hmac_sha1</span>(<span class="pl-smi">key</span>, <span class="pl-smi">src</span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">ngx</span>.<span class="pl-c1">encode_base64</span>(<span class="pl-smi">digest</span>))</pre></div>
<p dir="auto">yields the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="R/pvxzHC4NLtj7S+kXFg/NePTmk="><pre class="notranslate"><code>R/pvxzHC4NLtj7S+kXFg/NePTmk=
</code></pre></div>
<p dir="auto">This API requires the OpenSSL library enabled in the Nginx build (usually by passing the <code>--with-http_ssl_module</code> option to the <code>./configure</code> script).</p>
<p dir="auto">This function was first introduced in the <code>v0.3.1rc29</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.md5</h2><a id="user-content-ngxmd5" class="anchor" aria-label="Permalink: ngx.md5" href="#ngxmd5"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>digest = ngx.md5(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the hexadecimal representation of the MD5 digest of the <code>str</code> argument.</p>
<p dir="auto">For example,</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location = /md5 {
     content_by_lua_block {
         ngx.say(ngx.md5(&quot;hello&quot;))
     }
 }"><pre> <span class="pl-c1">location</span> = /md5 <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         ngx.say<span class="pl-c1">(</span>ngx.md5<span class="pl-c1">(</span><span class="pl-s">"hello"</span><span class="pl-c1">))</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">yields the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="5d41402abc4b2a76b9719d911017c592"><pre class="notranslate"><code>5d41402abc4b2a76b9719d911017c592
</code></pre></div>
<p dir="auto">See <a href="#ngxmd5_bin">ngx.md5_bin</a> if the raw binary MD5 digest is required.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.md5_bin</h2><a id="user-content-ngxmd5_bin" class="anchor" aria-label="Permalink: ngx.md5_bin" href="#ngxmd5_bin"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>digest = ngx.md5_bin(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the binary form of the MD5 digest of the <code>str</code> argument.</p>
<p dir="auto">See <a href="#ngxmd5">ngx.md5</a> if the hexadecimal form of the MD5 digest is required.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.sha1_bin</h2><a id="user-content-ngxsha1_bin" class="anchor" aria-label="Permalink: ngx.sha1_bin" href="#ngxsha1_bin"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>digest = ngx.sha1_bin(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the binary form of the SHA-1 digest of the <code>str</code> argument.</p>
<p dir="auto">This function requires SHA-1 support in the Nginx build. (This usually just means OpenSSL should be installed while building Nginx).</p>
<p dir="auto">This function was first introduced in the <code>v0.5.0rc6</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.quote_sql_str</h2><a id="user-content-ngxquote_sql_str" class="anchor" aria-label="Permalink: ngx.quote_sql_str" href="#ngxquote_sql_str"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>quoted_value = ngx.quote_sql_str(raw_value)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns a quoted SQL string literal according to the MySQL quoting rules.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.today</h2><a id="user-content-ngxtoday" class="anchor" aria-label="Permalink: ngx.today" href="#ngxtoday"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.today()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns current date (in the format <code>yyyy-mm-dd</code>) from the Nginx cached time (no syscall involved unlike Lua's date library).</p>
<p dir="auto">This is the local time.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.time</h2><a id="user-content-ngxtime" class="anchor" aria-label="Permalink: ngx.time" href="#ngxtime"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>secs = ngx.time()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the elapsed seconds from the epoch for the current time stamp from the Nginx cached time (no syscall involved unlike Lua's date library).</p>
<p dir="auto">Updates of the Nginx time cache can be forced by calling <a href="#ngxupdate_time">ngx.update_time</a> first.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.now</h2><a id="user-content-ngxnow" class="anchor" aria-label="Permalink: ngx.now" href="#ngxnow"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>secs = ngx.now()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns a floating-point number for the elapsed time in seconds (including milliseconds as the decimal part) from the epoch for the current time stamp from the Nginx cached time (no syscall involved unlike Lua's date library).</p>
<p dir="auto">You can forcibly update the Nginx time cache by calling <a href="#ngxupdate_time">ngx.update_time</a> first.</p>
<p dir="auto">This API was first introduced in <code>v0.3.1rc32</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.update_time</h2><a id="user-content-ngxupdate_time" class="anchor" aria-label="Permalink: ngx.update_time" href="#ngxupdate_time"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.update_time()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Forcibly updates the Nginx current time cache. This call involves a syscall and thus has some overhead, so do not abuse it.</p>
<p dir="auto">This API was first introduced in <code>v0.3.1rc32</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.localtime</h2><a id="user-content-ngxlocaltime" class="anchor" aria-label="Permalink: ngx.localtime" href="#ngxlocaltime"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.localtime()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the current time stamp (in the format <code>yyyy-mm-dd hh:mm:ss</code>) of the Nginx cached time (no syscall involved unlike Lua's <a href="https://www.lua.org/manual/5.1/manual.html#pdf-os.date" rel="nofollow">os.date</a> function).</p>
<p dir="auto">This is the local time.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.utctime</h2><a id="user-content-ngxutctime" class="anchor" aria-label="Permalink: ngx.utctime" href="#ngxutctime"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.utctime()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the current time stamp (in the format <code>yyyy-mm-dd hh:mm:ss</code>) of the Nginx cached time (no syscall involved unlike Lua's <a href="https://www.lua.org/manual/5.1/manual.html#pdf-os.date" rel="nofollow">os.date</a> function).</p>
<p dir="auto">This is the UTC time.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.cookie_time</h2><a id="user-content-ngxcookie_time" class="anchor" aria-label="Permalink: ngx.cookie_time" href="#ngxcookie_time"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.cookie_time(sec)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns a formatted string can be used as the cookie expiration time. The parameter <code>sec</code> is the time stamp in seconds (like those returned from <a href="#ngxtime">ngx.time</a>).</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(ngx.cookie_time(1290079655))
     -- yields &quot;Thu, 18-Nov-10 11:27:35 GMT&quot;"><pre> ngx.say<span class="pl-c1">(</span>ngx.cookie_time<span class="pl-c1">(</span><span class="pl-c1">1290079655</span><span class="pl-c1">))</span>
     -- yields <span class="pl-s">"Thu, 18-Nov-10 11:27:35 GMT"</span></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.http_time</h2><a id="user-content-ngxhttp_time" class="anchor" aria-label="Permalink: ngx.http_time" href="#ngxhttp_time"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.http_time(sec)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns a formated string can be used as the http header time (for example, being used in <code>Last-Modified</code> header). The parameter <code>sec</code> is the time stamp in seconds (like those returned from <a href="#ngxtime">ngx.time</a>).</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 ngx.say(ngx.http_time(1290079655))
     -- yields &quot;Thu, 18 Nov 2010 11:27:35 GMT&quot;"><pre> ngx.say<span class="pl-c1">(</span>ngx.http_time<span class="pl-c1">(</span><span class="pl-c1">1290079655</span><span class="pl-c1">))</span>
     -- yields <span class="pl-s">"Thu, 18 Nov 2010 11:27:35 GMT"</span></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.parse_http_time</h2><a id="user-content-ngxparse_http_time" class="anchor" aria-label="Permalink: ngx.parse_http_time" href="#ngxparse_http_time"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>sec = ngx.parse_http_time(str)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Parse the http time string (as returned by <a href="#ngxhttp_time">ngx.http_time</a>) into seconds. Returns the seconds or <code>nil</code> if the input string is in bad forms.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local time = ngx.parse_http_time(&quot;Thu, 18 Nov 2010 11:27:35 GMT&quot;)
 if time == nil then
     ...
 end"><pre> local time = ngx.parse_http_time<span class="pl-c1">(</span><span class="pl-s">"Thu, 18 Nov 2010 11:27:35 GMT"</span><span class="pl-c1">)</span>
 <span class="pl-k">if</span> time == nil then
     ...
 end</pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.is_subrequest</h2><a id="user-content-ngxis_subrequest" class="anchor" aria-label="Permalink: ngx.is_subrequest" href="#ngxis_subrequest"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>value = ngx.is_subrequest</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*</em></p>
<p dir="auto">Returns <code>true</code> if the current request is an Nginx subrequest, or <code>false</code> otherwise.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.re.match</h2><a id="user-content-ngxrematch" class="anchor" aria-label="Permalink: ngx.re.match" href="#ngxrematch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>captures, err = ngx.re.match(subject, regex, options?, ctx?, res_table?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Matches the <code>subject</code> string using the Perl compatible regular expression <code>regex</code> with the optional <code>options</code>.</p>
<p dir="auto">Only the first occurrence of the match is returned, or <code>nil</code> if no match is found. In case of errors, like seeing a bad regular expression or exceeding the PCRE stack limit, <code>nil</code> and a string describing the error will be returned.</p>
<p dir="auto">When a match is found, a Lua table <code>captures</code> is returned, where <code>captures[0]</code> holds the whole substring being matched, and <code>captures[1]</code> holds the first parenthesized sub-pattern's capturing, <code>captures[2]</code> the second, and so on.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, 1234&quot;, &quot;[0-9]+&quot;)
 if m then
     -- m[0] == &quot;1234&quot;

 else
     if err then
         ngx.log(ngx.ERR, &quot;error: &quot;, err)
         return
     end

     ngx.say(&quot;match not found&quot;)
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[0-9]+<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-smi">m</span> <span class="pl-k">then</span>
     <span class="pl-c"><span class="pl-c">--</span> m[0] == "1234"</span>

 <span class="pl-k">else</span>
     <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
         <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>

     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>match not found<span class="pl-pds">"</span></span>)
 <span class="pl-k">end</span></pre></div>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, 1234&quot;, &quot;([0-9])[0-9]+&quot;)
 -- m[0] == &quot;1234&quot;
 -- m[1] == &quot;1&quot;"><pre> <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([0-9])[0-9]+<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> m[0] == "1234"</span>
 <span class="pl-c"><span class="pl-c">--</span> m[1] == "1"</span></pre></div>
<p dir="auto">Named captures are also supported since the <code>v0.7.14</code> release
and are returned in the same Lua table as key-value pairs as the numbered captures.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, 1234&quot;, &quot;([0-9])(?&lt;remaining&gt;[0-9]+)&quot;)
 -- m[0] == &quot;1234&quot;
 -- m[1] == &quot;1&quot;
 -- m[2] == &quot;234&quot;
 -- m[&quot;remaining&quot;] == &quot;234&quot;"><pre> <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([0-9])(?&lt;remaining&gt;[0-9]+)<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> m[0] == "1234"</span>
 <span class="pl-c"><span class="pl-c">--</span> m[1] == "1"</span>
 <span class="pl-c"><span class="pl-c">--</span> m[2] == "234"</span>
 <span class="pl-c"><span class="pl-c">--</span> m["remaining"] == "234"</span></pre></div>
<p dir="auto">Unmatched subpatterns will have <code>false</code> values in their <code>captures</code> table fields.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, world&quot;, &quot;(world)|(hello)|(?&lt;named&gt;howdy)&quot;)
 -- m[0] == &quot;hello&quot;
 -- m[1] == false
 -- m[2] == &quot;hello&quot;
 -- m[3] == false
 -- m[&quot;named&quot;] == false"><pre> <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, world<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>(world)|(hello)|(?&lt;named&gt;howdy)<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> m[0] == "hello"</span>
 <span class="pl-c"><span class="pl-c">--</span> m[1] == false</span>
 <span class="pl-c"><span class="pl-c">--</span> m[2] == "hello"</span>
 <span class="pl-c"><span class="pl-c">--</span> m[3] == false</span>
 <span class="pl-c"><span class="pl-c">--</span> m["named"] == false</span></pre></div>
<p dir="auto">Specify <code>options</code> to control how the match operation will be performed. The following option characters are supported:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="a             anchored mode (only match from the beginning)

d             enable the DFA mode (or the longest token match semantics).
              this requires PCRE 6.0+ or else a Lua exception will be thrown.
              first introduced in ngx_lua v0.3.1rc30.

D             enable duplicate named pattern support. This allows named
              subpattern names to be repeated, returning the captures in
              an array-like Lua table. for example,
                local m = ngx.re.match(&quot;hello, world&quot;,
                                       &quot;(?&lt;named&gt;\w+), (?&lt;named&gt;\w+)&quot;,
                                       &quot;D&quot;)
                -- m[&quot;named&quot;] == {&quot;hello&quot;, &quot;world&quot;}
              this option was first introduced in the v0.7.14 release.
              this option requires at least PCRE 8.12.

i             case insensitive mode (similar to Perl's /i modifier)

j             enable PCRE JIT compilation, this requires PCRE 8.21+ which
              must be built with the --enable-jit option. for optimum performance,
              this option should always be used together with the 'o' option.
              first introduced in ngx_lua v0.3.1rc30.

J             enable the PCRE Javascript compatible mode. this option was
              first introduced in the v0.7.14 release. this option requires
              at least PCRE 8.12.

m             multi-line mode (similar to Perl's /m modifier)

o             compile-once mode (similar to Perl's /o modifier),
              to enable the worker-process-level compiled-regex cache

s             single-line mode (similar to Perl's /s modifier)

u             UTF-8 mode. this requires PCRE to be built with
              the --enable-utf8 option or else a Lua exception will be thrown.

U             similar to &quot;u&quot; but disables PCRE's UTF-8 validity check on
              the subject string. first introduced in ngx_lua v0.8.1.

x             extended mode (similar to Perl's /x modifier)"><pre class="notranslate"><code>a             anchored mode (only match from the beginning)

d             enable the DFA mode (or the longest token match semantics).
              this requires PCRE 6.0+ or else a Lua exception will be thrown.
              first introduced in ngx_lua v0.3.1rc30.

D             enable duplicate named pattern support. This allows named
              subpattern names to be repeated, returning the captures in
              an array-like Lua table. for example,
                local m = ngx.re.match("hello, world",
                                       "(?&lt;named&gt;\w+), (?&lt;named&gt;\w+)",
                                       "D")
                -- m["named"] == {"hello", "world"}
              this option was first introduced in the v0.7.14 release.
              this option requires at least PCRE 8.12.

i             case insensitive mode (similar to Perl's /i modifier)

j             enable PCRE JIT compilation, this requires PCRE 8.21+ which
              must be built with the --enable-jit option. for optimum performance,
              this option should always be used together with the 'o' option.
              first introduced in ngx_lua v0.3.1rc30.

J             enable the PCRE Javascript compatible mode. this option was
              first introduced in the v0.7.14 release. this option requires
              at least PCRE 8.12.

m             multi-line mode (similar to Perl's /m modifier)

o             compile-once mode (similar to Perl's /o modifier),
              to enable the worker-process-level compiled-regex cache

s             single-line mode (similar to Perl's /s modifier)

u             UTF-8 mode. this requires PCRE to be built with
              the --enable-utf8 option or else a Lua exception will be thrown.

U             similar to "u" but disables PCRE's UTF-8 validity check on
              the subject string. first introduced in ngx_lua v0.8.1.

x             extended mode (similar to Perl's /x modifier)
</code></pre></div>
<p dir="auto">These options can be combined:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, world&quot;, &quot;HEL LO&quot;, &quot;ix&quot;)
 -- m[0] == &quot;hello&quot;"><pre> local m, err = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, world"</span>, <span class="pl-s">"HEL LO"</span>, <span class="pl-s">"ix"</span><span class="pl-c1">)</span>
 -- m[0] == <span class="pl-s">"hello"</span></pre></div>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local m, err = ngx.re.match(&quot;hello, 美好生活&quot;, &quot;HELLO, (.{2})&quot;, &quot;iu&quot;)
 -- m[0] == &quot;hello, 美好&quot;
 -- m[1] == &quot;美好&quot;"><pre> local m, err = ngx.re.<span class="pl-c1">match</span><span class="pl-c1">(</span><span class="pl-s">"hello, 美好生活"</span>, <span class="pl-s">"HELLO, (.{2})"</span>, <span class="pl-s">"iu"</span><span class="pl-c1">)</span>
 -- m[0] == <span class="pl-s">"hello, 美好"</span>
 -- m[1] == <span class="pl-s">"美好"</span></pre></div>
<p dir="auto">The <code>o</code> option is useful for performance tuning, because the regex pattern in question will only be compiled once, cached in the worker-process level, and shared among all requests in the current Nginx worker process. The upper limit of the regex cache can be tuned via the <a href="#lua_regex_cache_max_entries">lua_regex_cache_max_entries</a> directive.</p>
<p dir="auto">The optional fourth argument, <code>ctx</code>, can be a Lua table holding an optional <code>pos</code> field. When the <code>pos</code> field in the <code>ctx</code> table argument is specified, <code>ngx.re.match</code> will start matching from that offset (starting from 1). Regardless of the presence of the <code>pos</code> field in the <code>ctx</code> table, <code>ngx.re.match</code> will always set this <code>pos</code> field to the position <em>after</em> the substring matched by the whole pattern in case of a successful match. When match fails, the <code>ctx</code> table will be left intact.</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local ctx = {}
 local m, err = ngx.re.match(&quot;1234, hello&quot;, &quot;[0-9]+&quot;, &quot;&quot;, ctx)
      -- m[0] = &quot;1234&quot;
      -- ctx.pos == 5"><pre> <span class="pl-k">local</span> <span class="pl-smi">ctx</span> <span class="pl-k">=</span> {}
 <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>1234, hello<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[0-9]+<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-smi">ctx</span>)
      <span class="pl-c"><span class="pl-c">--</span> m[0] = "1234"</span>
      <span class="pl-c"><span class="pl-c">--</span> ctx.pos == 5</span></pre></div>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local ctx = { pos = 2 }
 local m, err = ngx.re.match(&quot;1234, hello&quot;, &quot;[0-9]+&quot;, &quot;&quot;, ctx)
      -- m[0] = &quot;234&quot;
      -- ctx.pos == 5"><pre> <span class="pl-k">local</span> <span class="pl-smi">ctx</span> <span class="pl-k">=</span> { <span class="pl-smi">pos</span> <span class="pl-k">=</span> <span class="pl-c1">2</span> }
 <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">match</span>(<span class="pl-s"><span class="pl-pds">"</span>1234, hello<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[0-9]+<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-smi">ctx</span>)
      <span class="pl-c"><span class="pl-c">--</span> m[0] = "234"</span>
      <span class="pl-c"><span class="pl-c">--</span> ctx.pos == 5</span></pre></div>
<p dir="auto">The <code>ctx</code> table argument combined with the <code>a</code> regex modifier can be used to construct a lexer atop <code>ngx.re.match</code>.</p>
<p dir="auto">Note that, the <code>options</code> argument is not optional when the <code>ctx</code> argument is specified and that the empty Lua string (<code>""</code>) must be used as placeholder for <code>options</code> if no meaningful regex options are required.</p>
<p dir="auto">This method requires the PCRE library enabled in Nginx (<a href="#special-escaping-sequences">Known Issue With Special Escaping Sequences</a>).</p>
<p dir="auto">To confirm that PCRE JIT is enabled, activate the Nginx debug log by adding the <code>--with-debug</code> option to Nginx or OpenResty's <code>./configure</code> script. Then, enable the "debug" error log level in <code>error_log</code> directive. The following message will be generated if PCRE JIT is enabled:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="pcre JIT compiling result: 1"><pre class="notranslate"><code>pcre JIT compiling result: 1
</code></pre></div>
<p dir="auto">Starting from the <code>0.9.4</code> release, this function also accepts a 5th argument, <code>res_table</code>, for letting the caller supply the Lua table used to hold all the capturing results. Starting from <code>0.9.6</code>, it is the caller's responsibility to ensure this table is empty. This is very useful for recycling Lua tables and saving GC and table allocation overhead.</p>
<p dir="auto">This feature was introduced in the <code>v0.2.1rc11</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.re.find</h2><a id="user-content-ngxrefind" class="anchor" aria-label="Permalink: ngx.re.find" href="#ngxrefind"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>from, to, err = ngx.re.find(subject, regex, options?, ctx?, nth?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to <a href="#ngxrematch">ngx.re.match</a> but only returns the beginning index (<code>from</code>) and end index (<code>to</code>) of the matched substring. The returned indexes are 1-based and can be fed directly into the <a href="https://www.lua.org/manual/5.1/manual.html#pdf-string.sub" rel="nofollow">string.sub</a> API function to obtain the matched substring.</p>
<p dir="auto">In case of errors (like bad regexes or any PCRE runtime errors), this API function returns two <code>nil</code> values followed by a string describing the error.</p>
<p dir="auto">If no match is found, this function just returns a <code>nil</code> value.</p>
<p dir="auto">Below is an example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local s = &quot;hello, 1234&quot;
 local from, to, err = ngx.re.find(s, &quot;([0-9]+)&quot;, &quot;jo&quot;)
 if from then
     ngx.say(&quot;from: &quot;, from)
     ngx.say(&quot;to: &quot;, to)
     ngx.say(&quot;matched: &quot;, string.sub(s, from, to))
 else
     if err then
         ngx.say(&quot;error: &quot;, err)
         return
     end
     ngx.say(&quot;not matched!&quot;)
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">s</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">from</span>, <span class="pl-smi">to</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">find</span>(<span class="pl-smi">s</span>, <span class="pl-s"><span class="pl-pds">"</span>([0-9]+)<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>jo<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-smi">from</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>from: <span class="pl-pds">"</span></span>, <span class="pl-smi">from</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>to: <span class="pl-pds">"</span></span>, <span class="pl-smi">to</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>matched: <span class="pl-pds">"</span></span>, <span class="pl-c1">string.sub</span>(<span class="pl-smi">s</span>, <span class="pl-smi">from</span>, <span class="pl-smi">to</span>))
 <span class="pl-k">else</span>
     <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
         <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>not matched!<span class="pl-pds">"</span></span>)
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This example produces the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="from: 8
to: 11
matched: 1234"><pre class="notranslate"><code>from: 8
to: 11
matched: 1234
</code></pre></div>
<p dir="auto">Because this API function does not create new Lua strings nor new Lua tables, it is much faster than <a href="#ngxrematch">ngx.re.match</a>. It should be used wherever possible.</p>
<p dir="auto">Since the <code>0.9.3</code> release, an optional 5th argument, <code>nth</code>, is supported to specify which (submatch) capture's indexes to return. When <code>nth</code> is 0 (which is the default), the indexes for the whole matched substring is returned; when <code>nth</code> is 1, then the 1st submatch capture's indexes are returned; when <code>nth</code> is 2, then the 2nd submatch capture is returned, and so on. When the specified submatch does not have a match, then two <code>nil</code> values will be returned. Below is an example for this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local str = &quot;hello, 1234&quot;
 local from, to = ngx.re.find(str, &quot;([0-9])([0-9]+)&quot;, &quot;jo&quot;, nil, 2)
 if from then
     ngx.say(&quot;matched 2nd submatch: &quot;, string.sub(str, from, to))  -- yields &quot;234&quot;
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">str</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">from</span>, <span class="pl-smi">to</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">find</span>(<span class="pl-smi">str</span>, <span class="pl-s"><span class="pl-pds">"</span>([0-9])([0-9]+)<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>jo<span class="pl-pds">"</span></span>, <span class="pl-c1">nil</span>, <span class="pl-c1">2</span>)
 <span class="pl-k">if</span> <span class="pl-smi">from</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>matched 2nd submatch: <span class="pl-pds">"</span></span>, <span class="pl-c1">string.sub</span>(<span class="pl-smi">str</span>, <span class="pl-smi">from</span>, <span class="pl-smi">to</span>))  <span class="pl-c"><span class="pl-c">--</span> yields "234"</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">This API function was first introduced in the <code>v0.9.2</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.re.gmatch</h2><a id="user-content-ngxregmatch" class="anchor" aria-label="Permalink: ngx.re.gmatch" href="#ngxregmatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>iterator, err = ngx.re.gmatch(subject, regex, options?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to <a href="#ngxrematch">ngx.re.match</a>, but returns a Lua iterator instead, so as to let the user programmer iterate all the matches over the <code>&lt;subject&gt;</code> string argument with the PCRE <code>regex</code>.</p>
<p dir="auto">In case of errors, like seeing an ill-formed regular expression, <code>nil</code> and a string describing the error will be returned.</p>
<p dir="auto">Here is a small example to demonstrate its basic usage:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local iterator, err = ngx.re.gmatch(&quot;hello, world!&quot;, &quot;([a-z]+)&quot;, &quot;i&quot;)
 if not iterator then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 local m
 m, err = iterator()    -- m[0] == m[1] == &quot;hello&quot;
 if err then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 m, err = iterator()    -- m[0] == m[1] == &quot;world&quot;
 if err then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 m, err = iterator()    -- m == nil
 if err then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">iterator</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">gmatch</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, world!<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([a-z]+)<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>i<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">iterator</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">m</span>
 <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-c1">iterator</span>()    <span class="pl-c"><span class="pl-c">--</span> m[0] == m[1] == "hello"</span>
 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-c1">iterator</span>()    <span class="pl-c"><span class="pl-c">--</span> m[0] == m[1] == "world"</span>
 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-c1">iterator</span>()    <span class="pl-c"><span class="pl-c">--</span> m == nil</span>
 <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">More often we just put it into a Lua loop:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local it, err = ngx.re.gmatch(&quot;hello, world!&quot;, &quot;([a-z]+)&quot;, &quot;i&quot;)
 if not it then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 while true do
     local m, err = it()
     if err then
         ngx.log(ngx.ERR, &quot;error: &quot;, err)
         return
     end

     if not m then
         -- no match found (any more)
         break
     end

     -- found a match
     ngx.say(m[0])
     ngx.say(m[1])
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">it</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">gmatch</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, world!<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([a-z]+)<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>i<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">it</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-k">while</span> <span class="pl-c1">true</span> <span class="pl-k">do</span>
     <span class="pl-k">local</span> <span class="pl-smi">m</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-c1">it</span>()
     <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
         <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>

     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">m</span> <span class="pl-k">then</span>
         <span class="pl-c"><span class="pl-c">--</span> no match found (any more)</span>
         <span class="pl-k">break</span>
     <span class="pl-k">end</span>

     <span class="pl-c"><span class="pl-c">--</span> found a match</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">m</span>[<span class="pl-c1">0</span>])
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">m</span>[<span class="pl-c1">1</span>])
 <span class="pl-k">end</span></pre></div>
<p dir="auto">The optional <code>options</code> argument takes exactly the same semantics as the <a href="#ngxrematch">ngx.re.match</a> method.</p>
<p dir="auto">The current implementation requires that the iterator returned should only be used in a single request. That is, one should <em>not</em> assign it to a variable belonging to persistent namespace like a Lua package.</p>
<p dir="auto">This method requires the PCRE library enabled in Nginx (<a href="#special-escaping-sequences">Known Issue With Special Escaping Sequences</a>).</p>
<p dir="auto">This feature was first introduced in the <code>v0.2.1rc12</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.re.sub</h2><a id="user-content-ngxresub" class="anchor" aria-label="Permalink: ngx.re.sub" href="#ngxresub"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr, n, err = ngx.re.sub(subject, regex, replace, options?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Substitutes the first match of the Perl compatible regular expression <code>regex</code> on the <code>subject</code> argument string with the string or function argument <code>replace</code>. The optional <code>options</code> argument has exactly the same meaning as in <a href="#ngxrematch">ngx.re.match</a>.</p>
<p dir="auto">This method returns the resulting new string as well as the number of successful substitutions. In case of failures, like syntax errors in the regular expressions or the <code>&lt;replace&gt;</code> string argument, it will return <code>nil</code> and a string describing the error.</p>
<p dir="auto">When the <code>replace</code> is a string, then it is treated as a special template for string replacement. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local newstr, n, err = ngx.re.sub(&quot;hello, 1234&quot;, &quot;([0-9])[0-9]&quot;, &quot;[$0][$1]&quot;)
 if not newstr then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 -- newstr == &quot;hello, [12][1]34&quot;
 -- n == 1"><pre> <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([0-9])[0-9]<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[$0][$1]<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">newstr</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-c"><span class="pl-c">--</span> newstr == "hello, [12][1]34"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 1</span></pre></div>
<p dir="auto">where <code>$0</code> referring to the whole substring matched by the pattern and <code>$1</code> referring to the first parenthesized capturing substring.</p>
<p dir="auto">Curly braces can also be used to disambiguate variable names from the background string literals:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local newstr, n, err = ngx.re.sub(&quot;hello, 1234&quot;, &quot;[0-9]&quot;, &quot;${0}00&quot;)
 -- newstr == &quot;hello, 100234&quot;
 -- n == 1"><pre> <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[0-9]<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>${0}00<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> newstr == "hello, 100234"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 1</span></pre></div>
<p dir="auto">Literal dollar sign characters (<code>$</code>) in the <code>replace</code> string argument can be escaped by another dollar sign, for instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local newstr, n, err = ngx.re.sub(&quot;hello, 1234&quot;, &quot;[0-9]&quot;, &quot;$$&quot;)
 -- newstr == &quot;hello, $234&quot;
 -- n == 1"><pre> <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[0-9]<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>$$<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> newstr == "hello, $234"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 1</span></pre></div>
<p dir="auto">Do not use backlashes to escape dollar signs; it will not work as expected.</p>
<p dir="auto">When the <code>replace</code> argument is of type "function", then it will be invoked with the "match table" as the argument to generate the replace string literal for substitution. The "match table" fed into the <code>replace</code> function is exactly the same as the return value of <a href="#ngxrematch">ngx.re.match</a>. Here is an example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local func = function (m)
     return &quot;[&quot; .. m[0] .. &quot;][&quot; .. m[1] .. &quot;]&quot;
 end

 local newstr, n, err = ngx.re.sub(&quot;hello, 1234&quot;, &quot;( [0-9] ) [0-9]&quot;, func, &quot;x&quot;)
 -- newstr == &quot;hello, [12][1]34&quot;
 -- n == 1"><pre> <span class="pl-k">local</span> <span class="pl-en">func</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">m</span>)
     <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>[<span class="pl-pds">" </span></span><span class="pl-k">..</span> <span class="pl-smi">m</span>[<span class="pl-c1">0</span>] <span class="pl-k">..</span> <span class="pl-s"><span class="pl-pds">"</span>][<span class="pl-pds">" </span></span><span class="pl-k">..</span> <span class="pl-smi">m</span>[<span class="pl-c1">1</span>] <span class="pl-k">..</span> <span class="pl-s"><span class="pl-pds">"</span>]<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">sub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, 1234<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>( [0-9] ) [0-9]<span class="pl-pds">"</span></span>, <span class="pl-smi">func</span>, <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> newstr == "hello, [12][1]34"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 1</span></pre></div>
<p dir="auto">The dollar sign characters in the return value of the <code>replace</code> function argument are not special at all.</p>
<p dir="auto">This method requires the PCRE library enabled in Nginx (<a href="#special-escaping-sequences">Known Issue With Special Escaping Sequences</a>).</p>
<p dir="auto">This feature was first introduced in the <code>v0.2.1rc13</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.re.gsub</h2><a id="user-content-ngxregsub" class="anchor" aria-label="Permalink: ngx.re.gsub" href="#ngxregsub"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newstr, n, err = ngx.re.gsub(subject, regex, replace, options?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Just like <a href="#ngxresub">ngx.re.sub</a>, but does global substitution.</p>
<p dir="auto">Here is some examples:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local newstr, n, err = ngx.re.gsub(&quot;hello, world&quot;, &quot;([a-z])[a-z]+&quot;, &quot;[$0,$1]&quot;, &quot;i&quot;)
 if not newstr then
     ngx.log(ngx.ERR, &quot;error: &quot;, err)
     return
 end

 -- newstr == &quot;[hello,h], [world,w]&quot;
 -- n == 2"><pre> <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">gsub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, world<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([a-z])[a-z]+<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>[$0,$1]<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>i<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">newstr</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>error: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-c"><span class="pl-c">--</span> newstr == "[hello,h], [world,w]"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 2</span></pre></div>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local func = function (m)
     return &quot;[&quot; .. m[0] .. &quot;,&quot; .. m[1] .. &quot;]&quot;
 end
 local newstr, n, err = ngx.re.gsub(&quot;hello, world&quot;, &quot;([a-z])[a-z]+&quot;, func, &quot;i&quot;)
 -- newstr == &quot;[hello,h], [world,w]&quot;
 -- n == 2"><pre> <span class="pl-k">local</span> <span class="pl-en">func</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">m</span>)
     <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>[<span class="pl-pds">" </span></span><span class="pl-k">..</span> <span class="pl-smi">m</span>[<span class="pl-c1">0</span>] <span class="pl-k">..</span> <span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">" </span></span><span class="pl-k">..</span> <span class="pl-smi">m</span>[<span class="pl-c1">1</span>] <span class="pl-k">..</span> <span class="pl-s"><span class="pl-pds">"</span>]<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>
 <span class="pl-k">local</span> <span class="pl-smi">newstr</span>, <span class="pl-smi">n</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">re</span>.<span class="pl-c1">gsub</span>(<span class="pl-s"><span class="pl-pds">"</span>hello, world<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>([a-z])[a-z]+<span class="pl-pds">"</span></span>, <span class="pl-smi">func</span>, <span class="pl-s"><span class="pl-pds">"</span>i<span class="pl-pds">"</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> newstr == "[hello,h], [world,w]"</span>
 <span class="pl-c"><span class="pl-c">--</span> n == 2</span></pre></div>
<p dir="auto">This method requires the PCRE library enabled in Nginx (<a href="#special-escaping-sequences">Known Issue With Special Escaping Sequences</a>).</p>
<p dir="auto">This feature was first introduced in the <code>v0.2.1rc15</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT</h2><a id="user-content-ngxshareddict" class="anchor" aria-label="Permalink: ngx.shared.DICT" href="#ngxshareddict"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>dict = ngx.shared.DICT</em></p>
<p dir="auto"><strong>syntax:</strong> <em>dict = ngx.shared[name_var]</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Fetching the shm-based Lua dictionary object for the shared memory zone named <code>DICT</code> defined by the <a href="#lua_shared_dict">lua_shared_dict</a> directive.</p>
<p dir="auto">Shared memory zones are always shared by all the Nginx worker processes in the current Nginx server instance.</p>
<p dir="auto">The resulting object <code>dict</code> has the following methods:</p>
<ul dir="auto">
<li><a href="#ngxshareddictget">get</a></li>
<li><a href="#ngxshareddictget_stale">get_stale</a></li>
<li><a href="#ngxshareddictset">set</a></li>
<li><a href="#ngxshareddictsafe_set">safe_set</a></li>
<li><a href="#ngxshareddictadd">add</a></li>
<li><a href="#ngxshareddictsafe_add">safe_add</a></li>
<li><a href="#ngxshareddictreplace">replace</a></li>
<li><a href="#ngxshareddictdelete">delete</a></li>
<li><a href="#ngxshareddictincr">incr</a></li>
<li><a href="#ngxshareddictlpush">lpush</a></li>
<li><a href="#ngxshareddictrpush">rpush</a></li>
<li><a href="#ngxshareddictlpop">lpop</a></li>
<li><a href="#ngxshareddictrpop">rpop</a></li>
<li><a href="#ngxshareddictllen">llen</a></li>
<li><a href="#ngxshareddictttl">ttl</a></li>
<li><a href="#ngxshareddictexpire">expire</a></li>
<li><a href="#ngxshareddictflush_all">flush_all</a></li>
<li><a href="#ngxshareddictflush_expired">flush_expired</a></li>
<li><a href="#ngxshareddictget_keys">get_keys</a></li>
<li><a href="#ngxshareddictcapacity">capacity</a></li>
<li><a href="#ngxshareddictfree_space">free_space</a></li>
</ul>
<p dir="auto">All these methods are <em>atomic</em> operations, that is, safe from concurrent accesses from multiple Nginx worker processes for the same <code>lua_shared_dict</code> zone.</p>
<p dir="auto">Here is an example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 http {
     lua_shared_dict dogs 10m;
     server {
         location /set {
             content_by_lua_block {
                 local dogs = ngx.shared.dogs
                 dogs:set(&quot;Jim&quot;, 8)
                 ngx.say(&quot;STORED&quot;)
             }
         }
         location /get {
             content_by_lua_block {
                 local dogs = ngx.shared.dogs
                 ngx.say(dogs:get(&quot;Jim&quot;))
             }
         }
     }
 }"><pre> <span class="pl-c1">http</span> <span class="pl-c1">{</span>
     lua_shared_dict dogs <span class="pl-c1">10m</span><span class="pl-c1">;</span>
     <span class="pl-c1">server</span> <span class="pl-c1">{</span>
         <span class="pl-c1">location</span> /<span class="pl-c1">set</span> <span class="pl-c1">{</span>
             content_by_lua_block <span class="pl-c1">{</span>
                 local dogs = ngx.shared.dogs
                 dogs:<span class="pl-c1">set</span><span class="pl-c1">(</span><span class="pl-s">"Jim"</span>, 8<span class="pl-c1">)</span>
                 ngx.say<span class="pl-c1">(</span><span class="pl-s">"STORED"</span><span class="pl-c1">)</span>
             <span class="pl-c1">}</span>
         <span class="pl-c1">}</span>
         <span class="pl-c1">location</span> /get <span class="pl-c1">{</span>
             content_by_lua_block <span class="pl-c1">{</span>
                 local dogs = ngx.shared.dogs
                 ngx.say<span class="pl-c1">(</span>dogs:get<span class="pl-c1">(</span><span class="pl-s">"Jim"</span><span class="pl-c1">))</span>
             <span class="pl-c1">}</span>
         <span class="pl-c1">}</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Let us test it:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 $ curl localhost/set
 STORED

 $ curl localhost/get
 8

 $ curl localhost/get
 8"><pre> $ curl localhost/set
 STORED

 $ curl localhost/get
 8

 $ curl localhost/get
 8</pre></div>
<p dir="auto">The number <code>8</code> will be consistently output when accessing <code>/get</code> regardless of how many Nginx workers there are because the <code>dogs</code> dictionary resides in the shared memory and visible to <em>all</em> of the worker processes.</p>
<p dir="auto">The shared dictionary will retain its contents through a server config reload (either by sending the <code>HUP</code> signal to the Nginx process or by using the <code>-s reload</code> command-line option).</p>
<p dir="auto">The contents in the dictionary storage will be lost, however, when the Nginx server quits.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.get</h2><a id="user-content-ngxshareddictget" class="anchor" aria-label="Permalink: ngx.shared.DICT.get" href="#ngxshareddictget"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>value, flags = ngx.shared.DICT:get(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Retrieving the value in the dictionary <a href="#ngxshareddict">ngx.shared.DICT</a> for the key <code>key</code>. If the key does not exist or has expired, then <code>nil</code> will be returned.</p>
<p dir="auto">In case of errors, <code>nil</code> and a string describing the error will be returned.</p>
<p dir="auto">The value returned will have the original data type when they were inserted into the dictionary, for example, Lua booleans, numbers, or strings.</p>
<p dir="auto">The first argument to this method must be the dictionary object itself, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local cats = ngx.shared.cats
 local value, flags = cats.get(cats, &quot;Marry&quot;)"><pre> <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">value</span>, <span class="pl-smi">flags</span> <span class="pl-k">=</span> <span class="pl-smi">cats</span>.<span class="pl-c1">get</span>(<span class="pl-smi">cats</span>, <span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">or use Lua's syntactic sugar for method calls:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local cats = ngx.shared.cats
 local value, flags = cats:get(&quot;Marry&quot;)"><pre> <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">value</span>, <span class="pl-smi">flags</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">get</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">These two forms are fundamentally equivalent.</p>
<p dir="auto">If the user flags is <code>0</code> (the default), then no flags value will be returned.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.get_stale</h2><a id="user-content-ngxshareddictget_stale" class="anchor" aria-label="Permalink: ngx.shared.DICT.get_stale" href="#ngxshareddictget_stale"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>value, flags, stale = ngx.shared.DICT:get_stale(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the <a href="#ngxshareddictget">get</a> method but returns the value even if the key has already expired.</p>
<p dir="auto">Returns a 3rd value, <code>stale</code>, indicating whether the key has expired or not.</p>
<p dir="auto">Note that the value of an expired key is not guaranteed to be available so one should never rely on the availability of expired items.</p>
<p dir="auto">This method was first introduced in the <code>0.8.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.set</h2><a id="user-content-ngxshareddictset" class="anchor" aria-label="Permalink: ngx.shared.DICT.set" href="#ngxshareddictset"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>success, err, forcible = ngx.shared.DICT:set(key, value, exptime?, flags?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Unconditionally sets a key-value pair into the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>. Returns three values:</p>
<ul dir="auto">
<li><code>success</code>: boolean value to indicate whether the key-value pair is stored or not.</li>
<li><code>err</code>: textual error message, can be <code>"no memory"</code>.</li>
<li><code>forcible</code>: a boolean value to indicate whether other valid items have been removed forcibly when out of storage in the shared memory zone.</li>
</ul>
<p dir="auto">The <code>value</code> argument inserted can be Lua booleans, numbers, strings, or <code>nil</code>. Their value type will also be stored into the dictionary and the same data type can be retrieved later via the <a href="#ngxshareddictget">get</a> method.</p>
<p dir="auto">The optional <code>exptime</code> argument specifies expiration time (in seconds) for the inserted key-value pair. The time resolution is <code>0.001</code> seconds. If the <code>exptime</code> takes the value <code>0</code> (which is the default), then the item will never expire.</p>
<p dir="auto">The optional <code>flags</code> argument specifies a user flags value associated with the entry to be stored. It can also be retrieved later with the value. The user flags is stored as an unsigned 32-bit integer internally. Defaults to <code>0</code>. The user flags argument was first introduced in the <code>v0.5.0rc2</code> release.</p>
<p dir="auto">When it fails to allocate memory for the current key-value item, then <code>set</code> will try removing existing items in the storage according to the Least-Recently Used (LRU) algorithm. Note that, LRU takes priority over expiration time here. If up to tens of existing items have been removed and the storage left is still insufficient (either due to the total capacity limit specified by <a href="#lua_shared_dict">lua_shared_dict</a> or memory segmentation), then the <code>err</code> return value will be <code>no memory</code> and <code>success</code> will be <code>false</code>.</p>
<p dir="auto">If the sizes of items in the dictionary are not multiples or even powers of a certain value (like 2), it is easier to encounter <code>no memory</code> error because of memory fragmentation. It is recommended to use different dictionaries for different sizes of items.</p>
<p dir="auto">When you encounter <code>no memory</code> error, you can also evict more least-recently-used items by retrying this method call more times to to make room for the current item.</p>
<p dir="auto">If this method succeeds in storing the current item by forcibly removing other not-yet-expired items in the dictionary via LRU, the <code>forcible</code> return value will be <code>true</code>. If it stores the item without forcibly removing other valid items, then the return value <code>forcible</code> will be <code>false</code>.</p>
<p dir="auto">The first argument to this method must be the dictionary object itself, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local cats = ngx.shared.cats
 local succ, err, forcible = cats.set(cats, &quot;Marry&quot;, &quot;it is a nice cat!&quot;)"><pre> <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">succ</span>, <span class="pl-smi">err</span>, <span class="pl-smi">forcible</span> <span class="pl-k">=</span> <span class="pl-smi">cats</span>.<span class="pl-c1">set</span>(<span class="pl-smi">cats</span>, <span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>it is a nice cat!<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">or use Lua's syntactic sugar for method calls:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local cats = ngx.shared.cats
 local succ, err, forcible = cats:set(&quot;Marry&quot;, &quot;it is a nice cat!&quot;)"><pre> <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">succ</span>, <span class="pl-smi">err</span>, <span class="pl-smi">forcible</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">set</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>it is a nice cat!<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">These two forms are fundamentally equivalent.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">Please note that while internally the key-value pair is set atomically, the atomicity does not go across the method call boundary.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.safe_set</h2><a id="user-content-ngxshareddictsafe_set" class="anchor" aria-label="Permalink: ngx.shared.DICT.safe_set" href="#ngxshareddictsafe_set"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.shared.DICT:safe_set(key, value, exptime?, flags?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the <a href="#ngxshareddictset">set</a> method, but never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return <code>nil</code> and the string "no memory".</p>
<p dir="auto">This feature was first introduced in the <code>v0.7.18</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.add</h2><a id="user-content-ngxshareddictadd" class="anchor" aria-label="Permalink: ngx.shared.DICT.add" href="#ngxshareddictadd"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>success, err, forcible = ngx.shared.DICT:add(key, value, exptime?, flags?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Just like the <a href="#ngxshareddictset">set</a> method, but only stores the key-value pair into the dictionary <a href="#ngxshareddict">ngx.shared.DICT</a> if the key does <em>not</em> exist.</p>
<p dir="auto">If the <code>key</code> argument already exists in the dictionary (and not expired for sure), the <code>success</code> return value will be <code>false</code> and the <code>err</code> return value will be <code>"exists"</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.safe_add</h2><a id="user-content-ngxshareddictsafe_add" class="anchor" aria-label="Permalink: ngx.shared.DICT.safe_add" href="#ngxshareddictsafe_add"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.shared.DICT:safe_add(key, value, exptime?, flags?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the <a href="#ngxshareddictadd">add</a> method, but never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return <code>nil</code> and the string "no memory".</p>
<p dir="auto">This feature was first introduced in the <code>v0.7.18</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.replace</h2><a id="user-content-ngxshareddictreplace" class="anchor" aria-label="Permalink: ngx.shared.DICT.replace" href="#ngxshareddictreplace"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>success, err, forcible = ngx.shared.DICT:replace(key, value, exptime?, flags?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Just like the <a href="#ngxshareddictset">set</a> method, but only stores the key-value pair into the dictionary <a href="#ngxshareddict">ngx.shared.DICT</a> if the key <em>does</em> exist.</p>
<p dir="auto">If the <code>key</code> argument does <em>not</em> exist in the dictionary (or expired already), the <code>success</code> return value will be <code>false</code> and the <code>err</code> return value will be <code>"not found"</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.delete</h2><a id="user-content-ngxshareddictdelete" class="anchor" aria-label="Permalink: ngx.shared.DICT.delete" href="#ngxshareddictdelete"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.shared.DICT:delete(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Unconditionally removes the key-value pair from the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto">It is equivalent to <code>ngx.shared.DICT:set(key, nil)</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.incr</h2><a id="user-content-ngxshareddictincr" class="anchor" aria-label="Permalink: ngx.shared.DICT.incr" href="#ngxshareddictincr"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>newval, err, forcible? = ngx.shared.DICT:incr(key, value, init?, init_ttl?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto"><strong>optional requirement:</strong> <code>resty.core.shdict</code> or <code>resty.core</code></p>
<p dir="auto">Increments the (numerical) value for <code>key</code> in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a> by the step value <code>value</code>. Returns the new resulting number if the operation is successfully completed or <code>nil</code> and an error message otherwise.</p>
<p dir="auto">When the key does not exist or has already expired in the shared dictionary,</p>
<ol dir="auto">
<li>if the <code>init</code> argument is not specified or takes the value <code>nil</code>, this method will return <code>nil</code> and the error string <code>"not found"</code>, or</li>
<li>if the <code>init</code> argument takes a number value, this method will create a new <code>key</code> with the value <code>init + value</code>.</li>
</ol>
<p dir="auto">Like the <a href="#ngxshareddictadd">add</a> method, it also overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone.</p>
<p dir="auto">The optional <code>init_ttl</code> argument specifies expiration time (in seconds) of the value when it is initialized via the <code>init</code> argument. The time resolution is <code>0.001</code> seconds. If <code>init_ttl</code> takes the value <code>0</code> (which is the default), then the item will never expire. This argument cannot be provided without providing the <code>init</code> argument as well, and has no effect if the value already exists (e.g., if it was previously inserted via <a href="#ngxshareddictset">set</a> or the likes).</p>
<p dir="auto"><strong>Note:</strong> Usage of the <code>init_ttl</code> argument requires the <code>resty.core.shdict</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library. Example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require &quot;resty.core&quot;

 local cats = ngx.shared.cats
 local newval, err = cats:incr(&quot;black_cats&quot;, 1, 0, 0.1)

 print(newval) -- 1

 ngx.sleep(0.2)

 local val, err = cats:get(&quot;black_cats&quot;)
 print(val) -- nil"><pre> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.core<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">newval</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">incr</span>(<span class="pl-s"><span class="pl-pds">"</span>black_cats<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>, <span class="pl-c1">0</span>, <span class="pl-c1">0.1</span>)

 <span class="pl-c1">print</span>(<span class="pl-smi">newval</span>) <span class="pl-c"><span class="pl-c">--</span> 1</span>

 <span class="pl-smi">ngx</span>.<span class="pl-c1">sleep</span>(<span class="pl-c1">0.2</span>)

 <span class="pl-k">local</span> <span class="pl-smi">val</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">get</span>(<span class="pl-s"><span class="pl-pds">"</span>black_cats<span class="pl-pds">"</span></span>)
 <span class="pl-c1">print</span>(<span class="pl-smi">val</span>) <span class="pl-c"><span class="pl-c">--</span> nil</span></pre></div>
<p dir="auto">The <code>forcible</code> return value will always be <code>nil</code> when the <code>init</code> argument is not specified.</p>
<p dir="auto">If this method succeeds in storing the current item by forcibly removing other not-yet-expired items in the dictionary via LRU, the <code>forcible</code> return value will be <code>true</code>. If it stores the item without forcibly removing other valid items, then the return value <code>forcible</code> will be <code>false</code>.</p>
<p dir="auto">If the original value is not a valid Lua number in the dictionary, it will return <code>nil</code> and <code>"not a number"</code>.</p>
<p dir="auto">The <code>value</code> argument and <code>init</code> argument can be any valid Lua numbers, like negative numbers or floating-point numbers.</p>
<p dir="auto">This method was first introduced in the <code>v0.3.1rc22</code> release.</p>
<p dir="auto">The optional <code>init</code> parameter was first added in the <code>v0.10.6</code> release.</p>
<p dir="auto">The optional <code>init_ttl</code> parameter was introduced in the <code>v0.10.12rc2</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.lpush</h2><a id="user-content-ngxshareddictlpush" class="anchor" aria-label="Permalink: ngx.shared.DICT.lpush" href="#ngxshareddictlpush"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>length, err = ngx.shared.DICT:lpush(key, value)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Inserts the specified (numerical or string) <code>value</code> at the head of the list named <code>key</code> in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>. Returns the number of elements in the list after the push operation.</p>
<p dir="auto">If <code>key</code> does not exist, it is created as an empty list before performing the push operation. When the <code>key</code> already takes a value that is not a list, it will return <code>nil</code> and <code>"value not a list"</code>.</p>
<p dir="auto">It never overrides the (least recently used) unexpired items in the store when running out of storage in the shared memory zone. In this case, it will immediately return <code>nil</code> and the string "no memory".</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.rpush</h2><a id="user-content-ngxshareddictrpush" class="anchor" aria-label="Permalink: ngx.shared.DICT.rpush" href="#ngxshareddictrpush"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>length, err = ngx.shared.DICT:rpush(key, value)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the <a href="#ngxshareddictlpush">lpush</a> method, but inserts the specified (numerical or string) <code>value</code> at the tail of the list named <code>key</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.lpop</h2><a id="user-content-ngxshareddictlpop" class="anchor" aria-label="Permalink: ngx.shared.DICT.lpop" href="#ngxshareddictlpop"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>val, err = ngx.shared.DICT:lpop(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Removes and returns the first element of the list named <code>key</code> in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto">If <code>key</code> does not exist, it will return <code>nil</code>. When the <code>key</code> already takes a value that is not a list, it will return <code>nil</code> and <code>"value not a list"</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.rpop</h2><a id="user-content-ngxshareddictrpop" class="anchor" aria-label="Permalink: ngx.shared.DICT.rpop" href="#ngxshareddictrpop"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>val, err = ngx.shared.DICT:rpop(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Removes and returns the last element of the list named <code>key</code> in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto">If <code>key</code> does not exist, it will return <code>nil</code>. When the <code>key</code> already takes a value that is not a list, it will return <code>nil</code> and <code>"value not a list"</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.llen</h2><a id="user-content-ngxshareddictllen" class="anchor" aria-label="Permalink: ngx.shared.DICT.llen" href="#ngxshareddictllen"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>len, err = ngx.shared.DICT:llen(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the number of elements in the list named <code>key</code> in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto">If key does not exist, it is interpreted as an empty list and 0 is returned. When the <code>key</code> already takes a value that is not a list, it will return <code>nil</code> and <code>"value not a list"</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.6</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.ttl</h2><a id="user-content-ngxshareddictttl" class="anchor" aria-label="Permalink: ngx.shared.DICT.ttl" href="#ngxshareddictttl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ttl, err = ngx.shared.DICT:ttl(key)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto"><strong>requires:</strong> <code>resty.core.shdict</code> or <code>resty.core</code></p>
<p dir="auto">Retrieves the remaining TTL (time-to-live in seconds) of a key-value pair in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>. Returns the TTL as a number if the operation is successfully completed or <code>nil</code> and an error message otherwise.</p>
<p dir="auto">If the key does not exist (or has already expired), this method will return <code>nil</code> and the error string <code>"not found"</code>.</p>
<p dir="auto">The TTL is originally determined by the <code>exptime</code> argument of the <a href="#ngxshareddictset">set</a>, <a href="#ngxshareddictadd">add</a>, <a href="#ngxshareddictreplace">replace</a> (and the likes) methods. It has a time resolution of <code>0.001</code> seconds. A value of <code>0</code> means that the item will never expire.</p>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require &quot;resty.core&quot;

 local cats = ngx.shared.cats
 local succ, err = cats:set(&quot;Marry&quot;, &quot;a nice cat&quot;, 0.5)

 ngx.sleep(0.2)

 local ttl, err = cats:ttl(&quot;Marry&quot;)
 ngx.say(ttl) -- 0.3"><pre> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.core<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">succ</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">set</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a nice cat<span class="pl-pds">"</span></span>, <span class="pl-c1">0.5</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">sleep</span>(<span class="pl-c1">0.2</span>)

 <span class="pl-k">local</span> <span class="pl-smi">ttl</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">ttl</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">ttl</span>) <span class="pl-c"><span class="pl-c">--</span> 0.3</span></pre></div>
<p dir="auto">This feature was first introduced in the <code>v0.10.11</code> release.</p>
<p dir="auto"><strong>Note:</strong> This method requires the <code>resty.core.shdict</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.expire</h2><a id="user-content-ngxshareddictexpire" class="anchor" aria-label="Permalink: ngx.shared.DICT.expire" href="#ngxshareddictexpire"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>success, err = ngx.shared.DICT:expire(key, exptime)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto"><strong>requires:</strong> <code>resty.core.shdict</code> or <code>resty.core</code></p>
<p dir="auto">Updates the <code>exptime</code> (in second) of a key-value pair in the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>. Returns a boolean indicating success if the operation completes or <code>nil</code> and an error message otherwise.</p>
<p dir="auto">If the key does not exist, this method will return <code>nil</code> and the error string <code>"not found"</code>.</p>
<p dir="auto">The <code>exptime</code> argument has a resolution of <code>0.001</code> seconds. If <code>exptime</code> is <code>0</code>, then the item will never expire.</p>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require &quot;resty.core&quot;

 local cats = ngx.shared.cats
 local succ, err = cats:set(&quot;Marry&quot;, &quot;a nice cat&quot;, 0.1)

 succ, err = cats:expire(&quot;Marry&quot;, 0.5)

 ngx.sleep(0.2)

 local val, err = cats:get(&quot;Marry&quot;)
 ngx.say(val) -- &quot;a nice cat&quot;"><pre> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.core<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">succ</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">set</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a nice cat<span class="pl-pds">"</span></span>, <span class="pl-c1">0.1</span>)

 <span class="pl-smi">succ</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">expire</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>, <span class="pl-c1">0.5</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">sleep</span>(<span class="pl-c1">0.2</span>)

 <span class="pl-k">local</span> <span class="pl-smi">val</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">get</span>(<span class="pl-s"><span class="pl-pds">"</span>Marry<span class="pl-pds">"</span></span>)
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">val</span>) <span class="pl-c"><span class="pl-c">--</span> "a nice cat"</span></pre></div>
<p dir="auto">This feature was first introduced in the <code>v0.10.11</code> release.</p>
<p dir="auto"><strong>Note:</strong> This method requires the <code>resty.core.shdict</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.flush_all</h2><a id="user-content-ngxshareddictflush_all" class="anchor" aria-label="Permalink: ngx.shared.DICT.flush_all" href="#ngxshareddictflush_all"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ngx.shared.DICT:flush_all()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Flushes out all the items in the dictionary. This method does not actually free up all the memory blocks in the dictionary but just marks all the existing items as expired.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc17</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddictflush_expired">ngx.shared.DICT.flush_expired</a> and <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.flush_expired</h2><a id="user-content-ngxshareddictflush_expired" class="anchor" aria-label="Permalink: ngx.shared.DICT.flush_expired" href="#ngxshareddictflush_expired"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>flushed = ngx.shared.DICT:flush_expired(max_count?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Flushes out the expired items in the dictionary, up to the maximal number specified by the optional <code>max_count</code> argument. When the <code>max_count</code> argument is given <code>0</code> or not given at all, then it means unlimited. Returns the number of items that have actually been flushed.</p>
<p dir="auto">Unlike the <a href="#ngxshareddictflush_all">flush_all</a> method, this method actually frees up the memory used by the expired items.</p>
<p dir="auto">This feature was first introduced in the <code>v0.6.3</code> release.</p>
<p dir="auto">See also <a href="#ngxshareddictflush_all">ngx.shared.DICT.flush_all</a> and <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.get_keys</h2><a id="user-content-ngxshareddictget_keys" class="anchor" aria-label="Permalink: ngx.shared.DICT.get_keys" href="#ngxshareddictget_keys"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>keys = ngx.shared.DICT:get_keys(max_count?)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Fetch a list of the keys from the dictionary, up to <code>&lt;max_count&gt;</code>.</p>
<p dir="auto">By default, only the first 1024 keys (if any) are returned. When the <code>&lt;max_count&gt;</code> argument is given the value <code>0</code>, then all the keys will be returned even there is more than 1024 keys in the dictionary.</p>
<p dir="auto"><strong>CAUTION</strong> Avoid calling this method on dictionaries with a very large number of keys as it may lock the dictionary for significant amount of time and block Nginx worker processes trying to access the dictionary.</p>
<p dir="auto">This feature was first introduced in the <code>v0.7.3</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.capacity</h2><a id="user-content-ngxshareddictcapacity" class="anchor" aria-label="Permalink: ngx.shared.DICT.capacity" href="#ngxshareddictcapacity"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>capacity_bytes = ngx.shared.DICT:capacity()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto"><strong>requires:</strong> <code>resty.core.shdict</code> or <code>resty.core</code></p>
<p dir="auto">Retrieves the capacity in bytes for the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a> declared with
the <a href="#lua_shared_dict">lua_shared_dict</a> directive.</p>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require &quot;resty.core.shdict&quot;

 local cats = ngx.shared.cats
 local capacity_bytes = cats:capacity()"><pre> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.core.shdict<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">capacity_bytes</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">capacity</span>()</pre></div>
<p dir="auto">This feature was first introduced in the <code>v0.10.11</code> release.</p>
<p dir="auto"><strong>Note:</strong> This method requires the <code>resty.core.shdict</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">This feature requires at least Nginx core version <code>0.7.3</code>.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.shared.DICT.free_space</h2><a id="user-content-ngxshareddictfree_space" class="anchor" aria-label="Permalink: ngx.shared.DICT.free_space" href="#ngxshareddictfree_space"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>free_page_bytes = ngx.shared.DICT:free_space()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto"><strong>requires:</strong> <code>resty.core.shdict</code> or <code>resty.core</code></p>
<p dir="auto">Retrieves the free page size in bytes for the shm-based dictionary <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><strong>Note:</strong> The memory for ngx.shared.DICT is allocated via the Nginx slab allocator which has each slot for
data size ranges like ~8, 9~16, 17~32, ..., 1025~2048, 2048~ bytes. And pages are assigned to a slot if there
is no room in already assigned pages for the slot.</p>
<p dir="auto">So even if the return value of the <code>free_space</code> method is zero, there may be room in already assigned pages, so
you may successfully set a new key value pair to the shared dict without getting <code>true</code> for <code>forcible</code> or
non nil <code>err</code> from the <code>ngx.shared.DICT.set</code>.</p>
<p dir="auto">On the other hand, if already assigned pages for a slot are full and a new key value pair is added to the
slot and there is no free page, you may get <code>true</code> for <code>forcible</code> or non nil <code>err</code> from the
<code>ngx.shared.DICT.set</code> method.</p>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 require &quot;resty.core.shdict&quot;

 local cats = ngx.shared.cats
 local free_page_bytes = cats:free_space()"><pre> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.core.shdict<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-smi">cats</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">shared</span>.<span class="pl-e">cats</span>
 <span class="pl-k">local</span> <span class="pl-smi">free_page_bytes</span> <span class="pl-k">=</span> <span class="pl-en">cats</span>:<span class="pl-c1">free_space</span>()</pre></div>
<p dir="auto">This feature was first introduced in the <code>v0.10.11</code> release.</p>
<p dir="auto"><strong>Note:</strong> This method requires the <code>resty.core.shdict</code> or <code>resty.core</code> modules from the <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">This feature requires at least Nginx core version <code>1.11.7</code>.</p>
<p dir="auto">See also <a href="#ngxshareddict">ngx.shared.DICT</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.socket.udp</h2><a id="user-content-ngxsocketudp" class="anchor" aria-label="Permalink: ngx.socket.udp" href="#ngxsocketudp"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>udpsock = ngx.socket.udp()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Creates and returns a UDP or datagram-oriented unix domain socket object (also known as one type of the "cosocket" objects). The following methods are supported on this object:</p>
<ul dir="auto">
<li><a href="#udpsockbind">bind</a></li>
<li><a href="#udpsocksetpeername">setpeername</a></li>
<li><a href="#udpsocksend">send</a></li>
<li><a href="#udpsockreceive">receive</a></li>
<li><a href="#udpsockclose">close</a></li>
<li><a href="#udpsocksettimeout">settimeout</a></li>
</ul>
<p dir="auto">It is intended to be compatible with the UDP API of the <a href="http://w3.impa.br/~diego/software/luasocket/udp.html" rel="nofollow">LuaSocket</a> library but is 100% nonblocking out of the box.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto">See also <a href="#ngxsockettcp">ngx.socket.tcp</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:bind</h2><a id="user-content-udpsockbind" class="anchor" aria-label="Permalink: udpsock:bind" href="#udpsockbind"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = udpsock:bind(address)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*,ssl_session_fetch_by_lua*,ssl_client_hello_by_lua*</em></p>
<p dir="auto">Just like the standard <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind" rel="nofollow">proxy_bind</a> directive, this api makes the outgoing connection to a upstream server originate from the specified local IP address.</p>
<p dir="auto">Only IP addresses can be specified as the <code>address</code> argument.</p>
<p dir="auto">Here is an example for connecting to a TCP server from the specified local IP address:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     content_by_lua_block {
         local sock = ngx.socket.udp()
         -- assume &quot;192.168.1.10&quot; is the local ip address
         local ok, err = sock:bind(&quot;192.168.1.10&quot;)
         if not ok then
             ngx.say(&quot;failed to bind: &quot;, err)
             return
         end
         sock:close()
     }
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local sock = ngx.socket.udp<span class="pl-c1">()</span>
         -- assume <span class="pl-s">"192.168.1.10"</span> is the local ip address
         local ok, err = sock:bind<span class="pl-c1">(</span><span class="pl-s">"192.168.1.10"</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to bind: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         sock:close<span class="pl-c1">()</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:setpeername</h2><a id="user-content-udpsocksetpeername" class="anchor" aria-label="Permalink: udpsock:setpeername" href="#udpsocksetpeername"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = udpsock:setpeername(host, port)</em></p>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = udpsock:setpeername("unix:/path/to/unix-domain.socket")</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Attempts to connect a UDP socket object to a remote server or to a datagram unix domain socket file. Because the datagram protocol is actually connection-less, this method does not really establish a "connection", but only just set the name of the remote peer for subsequent read/write operations.</p>
<p dir="auto">Both IP addresses and domain names can be specified as the <code>host</code> argument. In case of domain names, this method will use Nginx core's dynamic resolver to parse the domain name without blocking and it is required to configure the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver" rel="nofollow">resolver</a> directive in the <code>nginx.conf</code> file like this:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 resolver 8.8.8.8;  # use Google's public DNS nameserver"><pre> <span class="pl-c1">resolver</span> <span class="pl-c1">8.8.8.8</span><span class="pl-c1">;</span>  # <span class="pl-c1">use</span> Google's public DNS nameserver</pre></div>
<p dir="auto">If the nameserver returns multiple IP addresses for the host name, this method will pick up one randomly.</p>
<p dir="auto">In case of error, the method returns <code>nil</code> followed by a string describing the error. In case of success, the method returns <code>1</code>.</p>
<p dir="auto">Here is an example for connecting to a UDP (memcached) server:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     resolver 8.8.8.8;

     content_by_lua_block {
         local sock = ngx.socket.udp()
         local ok, err = sock:setpeername(&quot;my.memcached.server.domain&quot;, 11211)
         if not ok then
             ngx.say(&quot;failed to connect to memcached: &quot;, err)
             return
         end
         ngx.say(&quot;successfully connected to memcached!&quot;)
         sock:close()
     }
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     <span class="pl-c1">resolver</span> <span class="pl-c1">8.8.8.8</span><span class="pl-c1">;</span>

     content_by_lua_block <span class="pl-c1">{</span>
         local sock = ngx.socket.udp<span class="pl-c1">()</span>
         local ok, err = sock:setpeername<span class="pl-c1">(</span><span class="pl-s">"my.memcached.server.domain"</span>, <span class="pl-c1">11211</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to connect to memcached: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"successfully connected to memcached!"</span><span class="pl-c1">)</span>
         sock:close<span class="pl-c1">()</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Since the <code>v0.7.18</code> release, connecting to a datagram unix domain socket file is also possible on Linux:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local sock = ngx.socket.udp()
 local ok, err = sock:setpeername(&quot;unix:/tmp/some-datagram-service.sock&quot;)
 if not ok then
     ngx.say(&quot;failed to connect to the datagram unix domain socket: &quot;, err)
     return
 end

 -- do something after connect
 -- such as sock:send or sock:receive"><pre> <span class="pl-k">local</span> <span class="pl-smi">sock</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">socket</span>.<span class="pl-c1">udp</span>()
 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">setpeername</span>(<span class="pl-s"><span class="pl-pds">"</span>unix:/tmp/some-datagram-service.sock<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to connect to the datagram unix domain socket: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-c"><span class="pl-c">--</span> do something after connect</span>
 <span class="pl-c"><span class="pl-c">--</span> such as sock:send or sock:receive</span></pre></div>
<p dir="auto">assuming the datagram service is listening on the unix domain socket file <code>/tmp/some-datagram-service.sock</code> and the client socket will use the "autobind" feature on Linux.</p>
<p dir="auto">Calling this method on an already connected socket object will cause the original connection to be closed first.</p>
<p dir="auto">This method was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:send</h2><a id="user-content-udpsocksend" class="anchor" aria-label="Permalink: udpsock:send" href="#udpsocksend"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = udpsock:send(data)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Sends data on the current UDP or datagram unix domain socket object.</p>
<p dir="auto">In case of success, it returns <code>1</code>. Otherwise, it returns <code>nil</code> and a string describing the error.</p>
<p dir="auto">The input argument <code>data</code> can either be a Lua string or a (nested) Lua table holding string fragments. In case of table arguments, this method will copy all the string elements piece by piece to the underlying Nginx socket send buffers, which is usually optimal than doing string concatenation operations on the Lua land.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:receive</h2><a id="user-content-udpsockreceive" class="anchor" aria-label="Permalink: udpsock:receive" href="#udpsockreceive"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>data, err = udpsock:receive(size?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Receives data from the UDP or datagram unix domain socket object with an optional receive buffer size argument, <code>size</code>.</p>
<p dir="auto">This method is a synchronous operation and is 100% nonblocking.</p>
<p dir="auto">In case of success, it returns the data received; in case of error, it returns <code>nil</code> with a string describing the error.</p>
<p dir="auto">If the <code>size</code> argument is specified, then this method will use this size as the receive buffer size. But when this size is greater than <code>8192</code>, then <code>8192</code> will be used instead.</p>
<p dir="auto">If no argument is specified, then the maximal buffer size, <code>8192</code> is assumed.</p>
<p dir="auto">Timeout for the reading operation is controlled by the <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a> config directive and the <a href="#udpsocksettimeout">settimeout</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 sock:settimeout(1000)  -- one second timeout
 local data, err = sock:receive()
 if not data then
     ngx.say(&quot;failed to read a packet: &quot;, err)
     return
 end
 ngx.say(&quot;successfully read a packet: &quot;, data)"><pre> <span class="pl-en">sock</span>:<span class="pl-c1">settimeout</span>(<span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout</span>
 <span class="pl-k">local</span> <span class="pl-smi">data</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receive</span>()
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">data</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read a packet: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>successfully read a packet: <span class="pl-pds">"</span></span>, <span class="pl-smi">data</span>)</pre></div>
<p dir="auto">It is important here to call the <a href="#udpsocksettimeout">settimeout</a> method <em>before</em> calling this method.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:close</h2><a id="user-content-udpsockclose" class="anchor" aria-label="Permalink: udpsock:close" href="#udpsockclose"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = udpsock:close()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Closes the current UDP or datagram unix domain socket. It returns the <code>1</code> in case of success and returns <code>nil</code> with a string describing the error otherwise.</p>
<p dir="auto">Socket objects that have not invoked this method (and associated connections) will be closed when the socket object is released by the Lua GC (Garbage Collector) or the current client HTTP request finishes processing.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">udpsock:settimeout</h2><a id="user-content-udpsocksettimeout" class="anchor" aria-label="Permalink: udpsock:settimeout" href="#udpsocksettimeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>udpsock:settimeout(time)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Set the timeout value in milliseconds for subsequent socket operations (like <a href="#udpsockreceive">receive</a>).</p>
<p dir="auto">Settings done by this method takes priority over those config directives, like <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.socket.stream</h2><a id="user-content-ngxsocketstream" class="anchor" aria-label="Permalink: ngx.socket.stream" href="#ngxsocketstream"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Just an alias to <a href="#ngxsockettcp">ngx.socket.tcp</a>. If the stream-typed cosocket may also connect to a unix domain
socket, then this API name is preferred.</p>
<p dir="auto">This API function was first added to the <code>v0.10.1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.socket.tcp</h2><a id="user-content-ngxsockettcp" class="anchor" aria-label="Permalink: ngx.socket.tcp" href="#ngxsockettcp"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock = ngx.socket.tcp()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Creates and returns a TCP or stream-oriented unix domain socket object (also known as one type of the "cosocket" objects). The following methods are supported on this object:</p>
<ul dir="auto">
<li><a href="#tcpsockbind">bind</a></li>
<li><a href="#tcpsockconnect">connect</a></li>
<li><a href="#tcpsocksetclientcert">setclientcert</a></li>
<li><a href="#tcpsocksslhandshake">sslhandshake</a></li>
<li><a href="#tcpsocksend">send</a></li>
<li><a href="#tcpsockreceive">receive</a></li>
<li><a href="#tcpsockclose">close</a></li>
<li><a href="#tcpsocksettimeout">settimeout</a></li>
<li><a href="#tcpsocksettimeouts">settimeouts</a></li>
<li><a href="#tcpsocksetoption">setoption</a></li>
<li><a href="#tcpsockreceiveany">receiveany</a></li>
<li><a href="#tcpsockreceiveuntil">receiveuntil</a></li>
<li><a href="#tcpsocksetkeepalive">setkeepalive</a></li>
<li><a href="#tcpsockgetreusedtimes">getreusedtimes</a></li>
</ul>
<p dir="auto">It is intended to be compatible with the TCP API of the <a href="http://w3.impa.br/~diego/software/luasocket/tcp.html" rel="nofollow">LuaSocket</a> library but is 100% nonblocking out of the box. Also, we introduce some new APIs to provide more functionalities.</p>
<p dir="auto">The cosocket object created by this API function has exactly the same lifetime as the Lua handler creating it. So never pass the cosocket object to any other Lua handler (including ngx.timer callback functions) and never share the cosocket object between different Nginx requests.</p>
<p dir="auto">For every cosocket object's underlying connection, if you do not
explicitly close it (via <a href="#tcpsockclose">close</a>) or put it back to the connection
pool (via <a href="#tcpsocksetkeepalive">setkeepalive</a>), then it is automatically closed when one of
the following two events happens:</p>
<ul dir="auto">
<li>the current request handler completes, or</li>
<li>the Lua cosocket object value gets collected by the Lua GC.</li>
</ul>
<p dir="auto">Fatal errors in cosocket operations always automatically close the current
connection (note that, read timeout error is the only error that is
not fatal), and if you call <a href="#tcpsockclose">close</a> on a closed connection, you will get
the "closed" error.</p>
<p dir="auto">Starting from the <code>0.9.9</code> release, the cosocket object here is full-duplex, that is, a reader "light thread" and a writer "light thread" can operate on a single cosocket object simultaneously (both "light threads" must belong to the same Lua handler though, see reasons above). But you cannot have two "light threads" both reading (or writing or connecting) the same cosocket, otherwise you might get an error like "socket busy reading" when calling the methods of the cosocket object.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto">See also <a href="#ngxsocketudp">ngx.socket.udp</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:bind</h2><a id="user-content-tcpsockbind" class="anchor" aria-label="Permalink: tcpsock:bind" href="#tcpsockbind"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:bind(address, port?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*,ssl_session_fetch_by_lua*,ssl_client_hello_by_lua*</em></p>
<p dir="auto">Just like the standard <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind" rel="nofollow">proxy_bind</a> directive, this api makes the outgoing connection to a upstream server originate from the specified local IP address.</p>
<p dir="auto">IP addresses can be specified as the <code>address</code> argument.
The optional <code>port</code> argument is usually used in the transparent proxy.</p>
<p dir="auto">Here is an example for connecting to a TCP server from the specified local IP address:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     content_by_lua_block {
         local sock = ngx.socket.tcp()
         -- assume &quot;192.168.1.10&quot; is the local ip address
         local ok, err = sock:bind(&quot;192.168.1.10&quot;)
         if not ok then
             ngx.say(&quot;failed to bind&quot;)
             return
         end
         local ok, err = sock:connect(&quot;192.168.1.67&quot;, 80)
         if not ok then
             ngx.say(&quot;failed to connect server: &quot;, err)
             return
         end
         ngx.say(&quot;successfully connected!&quot;)
         sock:close()
     }
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     content_by_lua_block <span class="pl-c1">{</span>
         local sock = ngx.socket.tcp<span class="pl-c1">()</span>
         -- assume <span class="pl-s">"192.168.1.10"</span> is the local ip address
         local ok, err = sock:bind<span class="pl-c1">(</span><span class="pl-s">"192.168.1.10"</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to bind"</span><span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         local ok, err = sock:connect<span class="pl-c1">(</span><span class="pl-s">"192.168.1.67"</span>, <span class="pl-c1">80</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to connect server: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"successfully connected!"</span><span class="pl-c1">)</span>
         sock:close<span class="pl-c1">()</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:connect</h2><a id="user-content-tcpsockconnect" class="anchor" aria-label="Permalink: tcpsock:connect" href="#tcpsockconnect"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:connect(host, port, options_table?)</em></p>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:connect("unix:/path/to/unix-domain.socket", options_table?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Attempts to connect a TCP socket object to a remote server or to a stream unix domain socket file without blocking.</p>
<p dir="auto">Before actually resolving the host name and connecting to the remote backend, this method will always look up the connection pool for matched idle connections created by previous calls of this method (or the <a href="#ngxsocketconnect">ngx.socket.connect</a> function).</p>
<p dir="auto">Both IP addresses and domain names can be specified as the <code>host</code> argument. In case of domain names, this method will use Nginx core's dynamic resolver to parse the domain name without blocking and it is required to configure the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver" rel="nofollow">resolver</a> directive in the <code>nginx.conf</code> file like this:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 resolver 8.8.8.8;  # use Google's public DNS nameserver"><pre> <span class="pl-c1">resolver</span> <span class="pl-c1">8.8.8.8</span><span class="pl-c1">;</span>  # <span class="pl-c1">use</span> Google's public DNS nameserver</pre></div>
<p dir="auto">If the nameserver returns multiple IP addresses for the host name, this method will pick up one randomly.</p>
<p dir="auto">In case of error, the method returns <code>nil</code> followed by a string describing the error. In case of success, the method returns <code>1</code>.</p>
<p dir="auto">Here is an example for connecting to a TCP server:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /test {
     resolver 8.8.8.8;

     content_by_lua_block {
         local sock = ngx.socket.tcp()
         local ok, err = sock:connect(&quot;www.google.com&quot;, 80)
         if not ok then
             ngx.say(&quot;failed to connect to google: &quot;, err)
             return
         end
         ngx.say(&quot;successfully connected to google!&quot;)
         sock:close()
     }
 }"><pre> <span class="pl-c1">location</span> /test <span class="pl-c1">{</span>
     <span class="pl-c1">resolver</span> <span class="pl-c1">8.8.8.8</span><span class="pl-c1">;</span>

     content_by_lua_block <span class="pl-c1">{</span>
         local sock = ngx.socket.tcp<span class="pl-c1">()</span>
         local ok, err = sock:connect<span class="pl-c1">(</span><span class="pl-s">"www.google.com"</span>, <span class="pl-c1">80</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span><span class="pl-s">"failed to connect to google: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         ngx.say<span class="pl-c1">(</span><span class="pl-s">"successfully connected to google!"</span><span class="pl-c1">)</span>
         sock:close<span class="pl-c1">()</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">Connecting to a Unix Domain Socket file is also possible:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local sock = ngx.socket.tcp()
 local ok, err = sock:connect(&quot;unix:/tmp/memcached.sock&quot;)
 if not ok then
     ngx.say(&quot;failed to connect to the memcached unix domain socket: &quot;, err)
     return
 end

 -- do something after connect
 -- such as sock:send or sock:receive"><pre> <span class="pl-k">local</span> <span class="pl-smi">sock</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">socket</span>.<span class="pl-c1">tcp</span>()
 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">connect</span>(<span class="pl-s"><span class="pl-pds">"</span>unix:/tmp/memcached.sock<span class="pl-pds">"</span></span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to connect to the memcached unix domain socket: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-c"><span class="pl-c">--</span> do something after connect</span>
 <span class="pl-c"><span class="pl-c">--</span> such as sock:send or sock:receive</span></pre></div>
<p dir="auto">assuming memcached (or something else) is listening on the unix domain socket file <code>/tmp/memcached.sock</code>.</p>
<p dir="auto">Timeout for the connecting operation is controlled by the <a href="#lua_socket_connect_timeout">lua_socket_connect_timeout</a> config directive and the <a href="#tcpsocksettimeout">settimeout</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local sock = ngx.socket.tcp()
 sock:settimeout(1000)  -- one second timeout
 local ok, err = sock:connect(host, port)"><pre> <span class="pl-k">local</span> <span class="pl-smi">sock</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">socket</span>.<span class="pl-c1">tcp</span>()
 <span class="pl-en">sock</span>:<span class="pl-c1">settimeout</span>(<span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout</span>
 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">connect</span>(<span class="pl-smi">host</span>, <span class="pl-smi">port</span>)</pre></div>
<p dir="auto">It is important here to call the <a href="#tcpsocksettimeout">settimeout</a> method <em>before</em> calling this method.</p>
<p dir="auto">Calling this method on an already connected socket object will cause the original connection to be closed first.</p>
<p dir="auto">An optional Lua table can be specified as the last argument to this method to specify various connect options:</p>
<ul dir="auto">
<li>
<p dir="auto"><code>pool</code>
specify a custom name for the connection pool being used. If omitted, then the connection pool name will be generated from the string template <code>"&lt;host&gt;:&lt;port&gt;"</code> or <code>"&lt;unix-socket-path&gt;"</code>.</p>
</li>
<li>
<p dir="auto"><code>pool_size</code>
specify the size of the connection pool. If omitted and no
<code>backlog</code> option was provided, no pool will be created. If omitted
but <code>backlog</code> was provided, the pool will be created with a default
size equal to the value of the <a href="#lua_socket_pool_size">lua_socket_pool_size</a>
directive.
The connection pool holds up to <code>pool_size</code> alive connections
ready to be reused by subsequent calls to <a href="#tcpsockconnect">connect</a>, but
note that there is no upper limit to the total number of opened connections
outside of the pool. If you need to restrict the total number of opened
connections, specify the <code>backlog</code> option.
When the connection pool would exceed its size limit, the least recently used
(kept-alive) connection already in the pool will be closed to make room for
the current connection.
Note that the cosocket connection pool is per Nginx worker process rather
than per Nginx server instance, so the size limit specified here also applies
to every single Nginx worker process. Also note that the size of the connection
pool cannot be changed once it has been created.
This option was first introduced in the <code>v0.10.14</code> release.</p>
</li>
<li>
<p dir="auto"><code>backlog</code>
if specified, this module will limit the total number of opened connections
for this pool. No more connections than <code>pool_size</code> can be opened
for this pool at any time. If <code>pool_size</code> number of connections are in use,
subsequent connect operations will be queued into a queue equal to this
option's value (the "backlog" queue).
If the number of queued connect operations is equal to <code>backlog</code>,
subsequent connect operations will fail and return <code>nil</code> plus the
error string <code>"too many waiting connect operations"</code>.
The queued connect operations will be resumed once the number of active
connections becomes less than <code>pool_size</code>.
The queued connect operation will abort once they have been queued for more
than <code>connect_timeout</code>, controlled by
<a href="#tcpsocksettimeouts">settimeouts</a>, and will return <code>nil</code> plus
the error string <code>"timeout"</code>.
This option was first introduced in the <code>v0.10.14</code> release.</p>
</li>
</ul>
<p dir="auto">The support for the options table argument was first introduced in the <code>v0.5.7</code> release.</p>
<p dir="auto">This method was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:getfd</h2><a id="user-content-tcpsockgetfd" class="anchor" aria-label="Permalink: tcpsock:getfd" href="#tcpsockgetfd"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>fd, err = tcpsock:getfd()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Get the file descriptor of the current tcp socket.</p>
<p dir="auto">This method was first introduced in the <code>v0.10.29</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:setclientcert</h2><a id="user-content-tcpsocksetclientcert" class="anchor" aria-label="Permalink: tcpsock:setclientcert" href="#tcpsocksetclientcert"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:setclientcert(cert, pkey)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Set client certificate chain and corresponding private key to the TCP socket object.
The certificate chain and private key provided will be used later by the <a href="#tcpsocksslhandshake">tcpsock:sslhandshake</a> method.</p>
<ul dir="auto">
<li><code>cert</code> specify a client certificate chain cdata object that will be used while handshaking with
remote server. These objects can be created using <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_cert">ngx.ssl.parse_pem_cert</a> or <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_der_cert">ngx.ssl.parse_der_cert</a>
function provided by lua-resty-core. Note that specifying the <code>cert</code> option requires
corresponding <code>pkey</code> be provided too. See below.</li>
<li><code>pkey</code> specify a private key corresponds to the <code>cert</code> option above.
These objects can be created using <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_priv_key">ngx.ssl.parse_pem_priv_key</a> or <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_der_priv_key">ngx.ssl.parse_der_priv_key</a>
function provided by lua-resty-core.</li>
</ul>
<p dir="auto">If both of <code>cert</code> and <code>pkey</code> are <code>nil</code>, this method will clear any existing client certificate and private key
that was previously set on the cosocket object.</p>
<p dir="auto">This method was first introduced in the <code>v0.10.22</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:sslhandshake</h2><a id="user-content-tcpsocksslhandshake" class="anchor" aria-label="Permalink: tcpsock:sslhandshake" href="#tcpsocksslhandshake"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>session, err = tcpsock:sslhandshake(reused_session?, server_name?, ssl_verify?, send_status_req?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Does SSL/TLS handshake on the currently established connection.</p>
<p dir="auto">The optional <code>reused_session</code> argument can take a former SSL
session userdata returned by a previous <code>sslhandshake</code>
call for exactly the same target. For short-lived connections, reusing SSL
sessions can usually speed up the handshake by one order by magnitude but it
is not so useful if the connection pool is enabled. This argument defaults to
<code>nil</code>. If this argument takes the boolean <code>false</code> value, no SSL session
userdata would return by this call and only a Lua boolean will be returned as
the first return value; otherwise the current SSL session will
always be returned as the first argument in case of successes.</p>
<p dir="auto">The optional <code>server_name</code> argument is used to specify the server
name for the new TLS extension Server Name Indication (SNI). Use of SNI can
make different servers share the same IP address on the server side. Also,
when SSL verification is enabled, this <code>server_name</code> argument is
also used to validate the server name specified in the server certificate sent from
the remote.</p>
<p dir="auto">The optional <code>ssl_verify</code> argument takes a Lua boolean value to
control whether to perform SSL verification. When set to <code>true</code>, the server
certificate will be verified according to the CA certificates specified by
the <a href="#lua_ssl_trusted_certificate">lua_ssl_trusted_certificate</a> directive.
You may also need to adjust the <a href="#lua_ssl_verify_depth">lua_ssl_verify_depth</a>
directive to control how deep we should follow along the certificate chain.
Also, when the <code>ssl_verify</code> argument is true and the
<code>server_name</code> argument is also specified, the latter will be used
to validate the server name in the server certificate.</p>
<p dir="auto">The optional <code>send_status_req</code> argument takes a boolean that controls whether to send
the OCSP status request in the SSL handshake request (which is for requesting OCSP stapling).</p>
<p dir="auto">For connections that have already done SSL/TLS handshake, this method returns
immediately.</p>
<p dir="auto">This method was first introduced in the <code>v0.9.11</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:send</h2><a id="user-content-tcpsocksend" class="anchor" aria-label="Permalink: tcpsock:send" href="#tcpsocksend"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>bytes, err = tcpsock:send(data)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Sends data without blocking on the current TCP or Unix Domain Socket connection.</p>
<p dir="auto">This method is a synchronous operation that will not return until <em>all</em> the data has been flushed into the system socket send buffer or an error occurs.</p>
<p dir="auto">In case of success, it returns the total number of bytes that have been sent. Otherwise, it returns <code>nil</code> and a string describing the error.</p>
<p dir="auto">The input argument <code>data</code> can either be a Lua string or a (nested) Lua table holding string fragments. In case of table arguments, this method will copy all the string elements piece by piece to the underlying Nginx socket send buffers, which is usually optimal than doing string concatenation operations on the Lua land.</p>
<p dir="auto">Timeout for the sending operation is controlled by the <a href="#lua_socket_send_timeout">lua_socket_send_timeout</a> config directive and the <a href="#tcpsocksettimeout">settimeout</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 sock:settimeout(1000)  -- one second timeout
 local bytes, err = sock:send(request)"><pre> <span class="pl-en">sock</span>:<span class="pl-c1">settimeout</span>(<span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout</span>
 <span class="pl-k">local</span> <span class="pl-smi">bytes</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">send</span>(<span class="pl-smi">request</span>)</pre></div>
<p dir="auto">It is important here to call the <a href="#tcpsocksettimeout">settimeout</a> method <em>before</em> calling this method.</p>
<p dir="auto">In case of any connection errors, this method always automatically closes the current connection.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:receive</h2><a id="user-content-tcpsockreceive" class="anchor" aria-label="Permalink: tcpsock:receive" href="#tcpsockreceive"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>data, err, partial = tcpsock:receive(size)</em></p>
<p dir="auto"><strong>syntax:</strong> <em>data, err, partial = tcpsock:receive(pattern?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Receives data from the connected socket according to the reading pattern or size.</p>
<p dir="auto">This method is a synchronous operation just like the <a href="#tcpsocksend">send</a> method and is 100% nonblocking.</p>
<p dir="auto">In case of success, it returns the data received; in case of error, it returns <code>nil</code> with a string describing the error and the partial data received so far.</p>
<p dir="auto">If a number-like argument is specified (including strings that look like numbers), then it is interpreted as a size. This method will not return until it reads exactly this size of data or an error occurs.</p>
<p dir="auto">If a non-number-like string argument is specified, then it is interpreted as a "pattern". The following patterns are supported:</p>
<ul dir="auto">
<li><code>'*a'</code>: reads from the socket until the connection is closed. No end-of-line translation is performed;</li>
<li><code>'*l'</code>: reads a line of text from the socket. The line is terminated by a <code>Line Feed</code> (LF) character (ASCII 10), optionally preceded by a <code>Carriage Return</code> (CR) character (ASCII 13). The CR and LF characters are not included in the returned line. In fact, all CR characters are ignored by the pattern.</li>
</ul>
<p dir="auto">If no argument is specified, then it is assumed to be the pattern <code>'*l'</code>, that is, the line reading pattern.</p>
<p dir="auto">Timeout for the reading operation is controlled by the <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a> config directive and the <a href="#tcpsocksettimeout">settimeout</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 sock:settimeout(1000)  -- one second timeout
 local line, err, partial = sock:receive()
 if not line then
     ngx.say(&quot;failed to read a line: &quot;, err)
     return
 end
 ngx.say(&quot;successfully read a line: &quot;, line)"><pre> <span class="pl-en">sock</span>:<span class="pl-c1">settimeout</span>(<span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout</span>
 <span class="pl-k">local</span> <span class="pl-smi">line</span>, <span class="pl-smi">err</span>, <span class="pl-smi">partial</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receive</span>()
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">line</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read a line: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>successfully read a line: <span class="pl-pds">"</span></span>, <span class="pl-smi">line</span>)</pre></div>
<p dir="auto">It is important here to call the <a href="#tcpsocksettimeout">settimeout</a> method <em>before</em> calling this method.</p>
<p dir="auto">Since the <code>v0.8.8</code> release, this method no longer automatically closes the current connection when the read timeout error happens. For other connection errors, this method always automatically closes the connection.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:receiveany</h2><a id="user-content-tcpsockreceiveany" class="anchor" aria-label="Permalink: tcpsock:receiveany" href="#tcpsockreceiveany"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>data, err = tcpsock:receiveany(max)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns any data received by the connected socket, at most <code>max</code> bytes.</p>
<p dir="auto">This method is a synchronous operation just like the <a href="#tcpsocksend">send</a> method and is 100% nonblocking.</p>
<p dir="auto">In case of success, it returns the data received; in case of error, it returns <code>nil</code> with a string describing the error.</p>
<p dir="auto">If the received data is more than this size, this method will return with exactly this size of data.
The remaining data in the underlying receive buffer could be returned in the next reading operation.</p>
<p dir="auto">Timeout for the reading operation is controlled by the <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a> config directive and the <a href="#tcpsocksettimeouts">settimeouts</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 sock:settimeouts(1000, 1000, 1000)  -- one second timeout for connect/read/write
 local data, err = sock:receiveany(10 * 1024) -- read any data, at most 10K
 if not data then
     ngx.say(&quot;failed to read any data: &quot;, err)
     return
 end
 ngx.say(&quot;successfully read: &quot;, data)"><pre> <span class="pl-en">sock</span>:<span class="pl-c1">settimeouts</span>(<span class="pl-c1">1000</span>, <span class="pl-c1">1000</span>, <span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout for connect/read/write</span>
 <span class="pl-k">local</span> <span class="pl-smi">data</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receiveany</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">1024</span>) <span class="pl-c"><span class="pl-c">--</span> read any data, at most 10K</span>
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">data</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read any data: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>successfully read: <span class="pl-pds">"</span></span>, <span class="pl-smi">data</span>)</pre></div>
<p dir="auto">This method doesn't automatically close the current connection when the read timeout error occurs. For other connection errors, this method always automatically closes the connection.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.14</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:receiveuntil</h2><a id="user-content-tcpsockreceiveuntil" class="anchor" aria-label="Permalink: tcpsock:receiveuntil" href="#tcpsockreceiveuntil"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>iterator = tcpsock:receiveuntil(pattern, options?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">This method returns an iterator Lua function that can be called to read the data stream until it sees the specified pattern or an error occurs.</p>
<p dir="auto">Here is an example for using this method to read a data stream with the boundary sequence <code>--abcedhb</code>:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local reader = sock:receiveuntil(&quot;\r\n--abcedhb&quot;)
 local data, err, partial = reader()
 if not data then
     ngx.say(&quot;failed to read the data stream: &quot;, err)
 end
 ngx.say(&quot;read the data stream: &quot;, data)"><pre> <span class="pl-k">local</span> <span class="pl-smi">reader</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receiveuntil</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\r\n</span>--abcedhb<span class="pl-pds">"</span></span>)
 <span class="pl-k">local</span> <span class="pl-smi">data</span>, <span class="pl-smi">err</span>, <span class="pl-smi">partial</span> <span class="pl-k">=</span> <span class="pl-c1">reader</span>()
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">data</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read the data stream: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>read the data stream: <span class="pl-pds">"</span></span>, <span class="pl-smi">data</span>)</pre></div>
<p dir="auto">When called without any argument, the iterator function returns the received data right <em>before</em> the specified pattern string in the incoming data stream. So for the example above, if the incoming data stream is <code>'hello, world! -agentzh\r\n--abcedhb blah blah'</code>, then the string <code>'hello, world! -agentzh'</code> will be returned.</p>
<p dir="auto">In case of error, the iterator function will return <code>nil</code> along with a string describing the error and the partial data bytes that have been read so far.</p>
<p dir="auto">The iterator function can be called multiple times and can be mixed safely with other cosocket method calls or other iterator function calls.</p>
<p dir="auto">The iterator function behaves differently (i.e., like a real iterator) when it is called with a <code>size</code> argument. That is, it will read that <code>size</code> of data on each invocation and will return <code>nil</code> at the last invocation (either sees the boundary pattern or meets an error). For the last successful invocation of the iterator function, the <code>err</code> return value will be <code>nil</code> too. The iterator function will be reset after the last successful invocation that returns <code>nil</code> data and <code>nil</code> error. Consider the following example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local reader = sock:receiveuntil(&quot;\r\n--abcedhb&quot;)

 while true do
     local data, err, partial = reader(4)
     if not data then
         if err then
             ngx.say(&quot;failed to read the data stream: &quot;, err)
             break
         end

         ngx.say(&quot;read done&quot;)
         break
     end
     ngx.say(&quot;read chunk: [&quot;, data, &quot;]&quot;)
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">reader</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receiveuntil</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\r\n</span>--abcedhb<span class="pl-pds">"</span></span>)

 <span class="pl-k">while</span> <span class="pl-c1">true</span> <span class="pl-k">do</span>
     <span class="pl-k">local</span> <span class="pl-smi">data</span>, <span class="pl-smi">err</span>, <span class="pl-smi">partial</span> <span class="pl-k">=</span> <span class="pl-c1">reader</span>(<span class="pl-c1">4</span>)
     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">data</span> <span class="pl-k">then</span>
         <span class="pl-k">if</span> <span class="pl-smi">err</span> <span class="pl-k">then</span>
             <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read the data stream: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
             <span class="pl-k">break</span>
         <span class="pl-k">end</span>

         <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>read done<span class="pl-pds">"</span></span>)
         <span class="pl-k">break</span>
     <span class="pl-k">end</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>read chunk: [<span class="pl-pds">"</span></span>, <span class="pl-smi">data</span>, <span class="pl-s"><span class="pl-pds">"</span>]<span class="pl-pds">"</span></span>)
 <span class="pl-k">end</span></pre></div>
<p dir="auto">Then for the incoming data stream <code>'hello, world! -agentzh\r\n--abcedhb blah blah'</code>, we shall get the following output from the sample code above:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="read chunk: [hell]
read chunk: [o, w]
read chunk: [orld]
read chunk: [! -a]
read chunk: [gent]
read chunk: [zh]
read done"><pre class="notranslate"><code>read chunk: [hell]
read chunk: [o, w]
read chunk: [orld]
read chunk: [! -a]
read chunk: [gent]
read chunk: [zh]
read done
</code></pre></div>
<p dir="auto">Note that, the actual data returned <em>might</em> be a little longer than the size limit specified by the <code>size</code> argument when the boundary pattern has ambiguity for streaming parsing. Near the boundary of the data stream, the data string actually returned could also be shorter than the size limit.</p>
<p dir="auto">Timeout for the iterator function's reading operation is controlled by the <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a> config directive and the <a href="#tcpsocksettimeout">settimeout</a> method. And the latter takes priority. For example:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local readline = sock:receiveuntil(&quot;\r\n&quot;)

 sock:settimeout(1000)  -- one second timeout
 line, err, partial = readline()
 if not line then
     ngx.say(&quot;failed to read a line: &quot;, err)
     return
 end
 ngx.say(&quot;successfully read a line: &quot;, line)"><pre> <span class="pl-k">local</span> <span class="pl-smi">readline</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">receiveuntil</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\r\n</span><span class="pl-pds">"</span></span>)

 <span class="pl-en">sock</span>:<span class="pl-c1">settimeout</span>(<span class="pl-c1">1000</span>)  <span class="pl-c"><span class="pl-c">--</span> one second timeout</span>
 <span class="pl-smi">line</span>, <span class="pl-smi">err</span>, <span class="pl-smi">partial</span> <span class="pl-k">=</span> <span class="pl-c1">readline</span>()
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">line</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to read a line: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>successfully read a line: <span class="pl-pds">"</span></span>, <span class="pl-smi">line</span>)</pre></div>
<p dir="auto">It is important here to call the <a href="#tcpsocksettimeout">settimeout</a> method <em>before</em> calling the iterator function (note that the <code>receiveuntil</code> call is irrelevant here).</p>
<p dir="auto">As from the <code>v0.5.1</code> release, this method also takes an optional <code>options</code> table argument to control the behavior. The following options are supported:</p>
<ul dir="auto">
<li><code>inclusive</code></li>
</ul>
<p dir="auto">The <code>inclusive</code> takes a boolean value to control whether to include the pattern string in the returned data string. Default to <code>false</code>. For example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local reader = tcpsock:receiveuntil(&quot;_END_&quot;, { inclusive = true })
 local data = reader()
 ngx.say(data)"><pre> <span class="pl-k">local</span> <span class="pl-smi">reader</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">receiveuntil</span>(<span class="pl-s"><span class="pl-pds">"</span>_END_<span class="pl-pds">"</span></span>, { <span class="pl-smi">inclusive</span> <span class="pl-k">=</span> <span class="pl-c1">true</span> })
 <span class="pl-k">local</span> <span class="pl-smi">data</span> <span class="pl-k">=</span> <span class="pl-c1">reader</span>()
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-smi">data</span>)</pre></div>
<p dir="auto">Then for the input data stream <code>"hello world _END_ blah blah blah"</code>, then the example above will output <code>hello world _END_</code>, including the pattern string <code>_END_</code> itself.</p>
<p dir="auto">Since the <code>v0.8.8</code> release, this method no longer automatically closes the current connection when the read timeout error happens. For other connection errors, this method always automatically closes the connection.</p>
<p dir="auto">This method was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:close</h2><a id="user-content-tcpsockclose" class="anchor" aria-label="Permalink: tcpsock:close" href="#tcpsockclose"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:close()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Closes the current TCP or stream unix domain socket. It returns the <code>1</code> in case of success and returns <code>nil</code> with a string describing the error otherwise.</p>
<p dir="auto">Note that there is no need to call this method on socket objects that have invoked the <a href="#tcpsocksetkeepalive">setkeepalive</a> method because the socket object is already closed (and the current connection is saved into the built-in connection pool).</p>
<p dir="auto">Socket objects that have not invoked this method (and associated connections) will be closed when the socket object is released by the Lua GC (Garbage Collector) or the current client HTTP request finishes processing.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:settimeout</h2><a id="user-content-tcpsocksettimeout" class="anchor" aria-label="Permalink: tcpsock:settimeout" href="#tcpsocksettimeout"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock:settimeout(time)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Set the timeout value in milliseconds for subsequent socket operations (<a href="#tcpsockconnect">connect</a>, <a href="#tcpsockreceive">receive</a>, and iterators returned from <a href="#tcpsockreceiveuntil">receiveuntil</a>).</p>
<p dir="auto">Settings done by this method take priority over those specified via config directives (i.e. <a href="#lua_socket_connect_timeout">lua_socket_connect_timeout</a>, <a href="#lua_socket_send_timeout">lua_socket_send_timeout</a>, and <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a>).</p>
<p dir="auto">Note that this method does <em>not</em> affect the <a href="#lua_socket_keepalive_timeout">lua_socket_keepalive_timeout</a> setting; the <code>timeout</code> argument to the <a href="#tcpsocksetkeepalive">setkeepalive</a> method should be used for this purpose instead.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:settimeouts</h2><a id="user-content-tcpsocksettimeouts" class="anchor" aria-label="Permalink: tcpsock:settimeouts" href="#tcpsocksettimeouts"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock:settimeouts(connect_timeout, send_timeout, read_timeout)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Respectively sets the connect, send, and read timeout thresholds (in milliseconds) for subsequent socket
operations (<a href="#tcpsockconnect">connect</a>, <a href="#tcpsocksend">send</a>, <a href="#tcpsockreceive">receive</a>, and iterators returned from <a href="#tcpsockreceiveuntil">receiveuntil</a>).</p>
<p dir="auto">Settings done by this method take priority over those specified via config directives (i.e. <a href="#lua_socket_connect_timeout">lua_socket_connect_timeout</a>, <a href="#lua_socket_send_timeout">lua_socket_send_timeout</a>, and <a href="#lua_socket_read_timeout">lua_socket_read_timeout</a>).</p>
<p dir="auto">It is recommended to use <a href="#tcpsocksettimeouts">settimeouts</a> instead of <a href="#tcpsocksettimeout">settimeout</a>.</p>
<p dir="auto">Note that this method does <em>not</em> affect the <a href="#lua_socket_keepalive_timeout">lua_socket_keepalive_timeout</a> setting; the <code>timeout</code> argument to the <a href="#tcpsocksetkeepalive">setkeepalive</a> method should be used for this purpose instead.</p>
<p dir="auto">This feature was first introduced in the <code>v0.10.7</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:setoption</h2><a id="user-content-tcpsocksetoption" class="anchor" aria-label="Permalink: tcpsock:setoption" href="#tcpsocksetoption"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:setoption(option, value?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">This function is added for <a href="http://w3.impa.br/~diego/software/luasocket/tcp.html" rel="nofollow">LuaSocket</a> API compatibility, its functionality is implemented <code>v0.10.18</code>.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto">In case of success, it returns <code>true</code>. Otherwise, it returns nil and a string describing the error.</p>
<p dir="auto">The <code>option</code> is a string with the option name, and the value depends on the option being set:</p>
<ul dir="auto">
<li>
<p dir="auto"><code>keepalive</code></p>
<p dir="auto">Setting this option to true enables sending of keep-alive messages on
connection-oriented sockets. Make sure the <code>connect</code> function
had been called before, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
local ok, err = tcpsock:setoption(&quot;keepalive&quot;, true)
if not ok then
    ngx.say(&quot;setoption keepalive failed: &quot;, err)
end"><pre><span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>keepalive<span class="pl-pds">"</span></span>, <span class="pl-c1">true</span>)
<span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
    <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption keepalive failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
<span class="pl-k">end</span></pre></div>
</li>
<li>
<p dir="auto"><code>reuseaddr</code></p>
<p dir="auto">Enabling this option indicates that the rules used in validating addresses
supplied in a call to bind should allow reuse of local addresses. Make sure
the <code>connect</code> function had been called before, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
local ok, err = tcpsock:setoption(&quot;reuseaddr&quot;, 0)
if not ok then
    ngx.say(&quot;setoption reuseaddr failed: &quot;, err)
end"><pre><span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>reuseaddr<span class="pl-pds">"</span></span>, <span class="pl-c1">0</span>)
<span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
    <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption reuseaddr failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
<span class="pl-k">end</span></pre></div>
</li>
<li>
<p dir="auto"><code>tcp-nodelay</code></p>
<p dir="auto">Setting this option to true disables the Nagle's algorithm for the connection.
Make sure the <code>connect</code> function had been called before, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
local ok, err = tcpsock:setoption(&quot;tcp-nodelay&quot;, true)
if not ok then
    ngx.say(&quot;setoption tcp-nodelay failed: &quot;, err)
end"><pre><span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>tcp-nodelay<span class="pl-pds">"</span></span>, <span class="pl-c1">true</span>)
<span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
    <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption tcp-nodelay failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
<span class="pl-k">end</span></pre></div>
</li>
<li>
<p dir="auto"><code>sndbuf</code></p>
<p dir="auto">Sets the maximum socket send buffer in bytes. The kernel doubles this value
(to allow space for bookkeeping overhead) when it is set using setsockopt().
Make sure the <code>connect</code> function had been called before, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
local ok, err = tcpsock:setoption(&quot;sndbuf&quot;, 1024 * 10)
if not ok then
    ngx.say(&quot;setoption sndbuf failed: &quot;, err)
end"><pre><span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>sndbuf<span class="pl-pds">"</span></span>, <span class="pl-c1">1024</span> <span class="pl-k">*</span> <span class="pl-c1">10</span>)
<span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
    <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption sndbuf failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
<span class="pl-k">end</span></pre></div>
</li>
<li>
<p dir="auto"><code>rcvbuf</code></p>
<p dir="auto">Sets the maximum socket receive buffer in bytes. The kernel doubles this value
(to allow space for bookkeeping overhead) when it is set using setsockopt. Make
sure the <code>connect</code> function had been called before, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
local ok, err = tcpsock:setoption(&quot;rcvbuf&quot;, 1024 * 10)
if not ok then
    ngx.say(&quot;setoption rcvbuf failed: &quot;, err)
end"><pre><span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>rcvbuf<span class="pl-pds">"</span></span>, <span class="pl-c1">1024</span> <span class="pl-k">*</span> <span class="pl-c1">10</span>)
<span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
    <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption rcvbuf failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
<span class="pl-k">end</span></pre></div>
</li>
</ul>
<p dir="auto">NOTE: Once the option is set, it will become effective until the connection is closed. If you know the connection is from the connection pool and all the in-pool connections already have called the setoption() method with the desired socket option state, then you can just skip calling setoption() again to avoid the overhead of repeated calls, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local count, err = tcpsock:getreusedtimes()
 if not count then
     ngx.say(&quot;getreusedtimes failed: &quot;, err)
     return
 end

 if count == 0 then
     local ok, err = tcpsock:setoption(&quot;rcvbuf&quot;, 1024 * 10)
     if not ok then
         ngx.say(&quot;setoption rcvbuf failed: &quot;, err)
         return
     end
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">count</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">getreusedtimes</span>()
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">count</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>getreusedtimes failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-k">if</span> <span class="pl-smi">count</span> <span class="pl-k">==</span> <span class="pl-c1">0</span> <span class="pl-k">then</span>
     <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">tcpsock</span>:<span class="pl-c1">setoption</span>(<span class="pl-s"><span class="pl-pds">"</span>rcvbuf<span class="pl-pds">"</span></span>, <span class="pl-c1">1024</span> <span class="pl-k">*</span> <span class="pl-c1">10</span>)
     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
         <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>setoption rcvbuf failed: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">These options described above are supported in <code>v0.10.18</code>, and more options will be implemented in future.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:setkeepalive</h2><a id="user-content-tcpsocksetkeepalive" class="anchor" aria-label="Permalink: tcpsock:setkeepalive" href="#tcpsocksetkeepalive"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = tcpsock:setkeepalive(timeout?, size?)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Puts the current socket's connection immediately into the cosocket built-in connection pool and keep it alive until other <a href="#tcpsockconnect">connect</a> method calls request it or the associated maximal idle timeout is expired.</p>
<p dir="auto">The first optional argument, <code>timeout</code>, can be used to specify the maximal idle timeout (in milliseconds) for the current connection. If omitted, the default setting in the <a href="#lua_socket_keepalive_timeout">lua_socket_keepalive_timeout</a> config directive will be used. If the <code>0</code> value is given, then the timeout interval is unlimited.</p>
<p dir="auto">The second optional argument <code>size</code> is considered deprecated since
the <code>v0.10.14</code> release of this module, in favor of the
<code>pool_size</code> option of the <a href="#tcpsockconnect">connect</a> method.
Since the <code>v0.10.14</code> release, this option will only take effect if
the call to <a href="#tcpsockconnect">connect</a> did not already create a connection
pool.
When this option takes effect (no connection pool was previously created by
<a href="#tcpsockconnect">connect</a>), it will specify the size of the connection pool,
and create it.
If omitted (and no pool was previously created), the default size is the value
of the <a href="#lua_socket_pool_size">lua_socket_pool_size</a> directive.
The connection pool holds up to <code>size</code> alive connections ready to be
reused by subsequent calls to <a href="#tcpsockconnect">connect</a>, but note that there
is no upper limit to the total number of opened connections outside of the
pool.
When the connection pool would exceed its size limit, the least recently used
(kept-alive) connection already in the pool will be closed to make room for
the current connection.
Note that the cosocket connection pool is per Nginx worker process rather
than per Nginx server instance, so the size limit specified here also applies
to every single Nginx worker process. Also note that the size of the connection
pool cannot be changed once it has been created.
If you need to restrict the total number of opened connections, specify both
the <code>pool_size</code> and <code>backlog</code> option in the call to
<a href="#tcpsockconnect">connect</a>.</p>
<p dir="auto">In case of success, this method returns <code>1</code>; otherwise, it returns <code>nil</code> and a string describing the error.</p>
<p dir="auto">When the system receive buffer for the current connection has unread data, then this method will return the "connection in dubious state" error message (as the second return value) because the previous session has unread data left behind for the next session and the connection is not safe to be reused.</p>
<p dir="auto">This method also makes the current cosocket object enter the "closed" state, so there is no need to manually call the <a href="#tcpsockclose">close</a> method on it afterwards.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">tcpsock:getreusedtimes</h2><a id="user-content-tcpsockgetreusedtimes" class="anchor" aria-label="Permalink: tcpsock:getreusedtimes" href="#tcpsockgetreusedtimes"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>count, err = tcpsock:getreusedtimes()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">This method returns the (successfully) reused times for the current connection. In case of error, it returns <code>nil</code> and a string describing the error.</p>
<p dir="auto">If the current connection does not come from the built-in connection pool, then this method always returns <code>0</code>, that is, the connection has never been reused (yet). If the connection comes from the connection pool, then the return value is always non-zero. So this method can also be used to determine if the current connection comes from the pool.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.socket.connect</h2><a id="user-content-ngxsocketconnect" class="anchor" aria-label="Permalink: ngx.socket.connect" href="#ngxsocketconnect"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock, err = ngx.socket.connect(host, port)</em></p>
<p dir="auto"><strong>syntax:</strong> <em>tcpsock, err = ngx.socket.connect("unix:/path/to/unix-domain.socket")</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*</em></p>
<p dir="auto">This function is a shortcut for combining <a href="#ngxsockettcp">ngx.socket.tcp()</a> and the <a href="#tcpsockconnect">connect()</a> method call in a single operation. It is actually implemented like this:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local sock = ngx.socket.tcp()
 local ok, err = sock:connect(...)
 if not ok then
     return nil, err
 end
 return sock"><pre> <span class="pl-k">local</span> <span class="pl-smi">sock</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">socket</span>.<span class="pl-c1">tcp</span>()
 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">sock</span>:<span class="pl-c1">connect</span>(<span class="pl-c1">...</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-smi">err</span>
 <span class="pl-k">end</span>
 <span class="pl-k">return</span> <span class="pl-smi">sock</span></pre></div>
<p dir="auto">There is no way to use the <a href="#tcpsocksettimeout">settimeout</a> method to specify connecting timeout for this method and the <a href="#lua_socket_connect_timeout">lua_socket_connect_timeout</a> directive must be set at configure time instead.</p>
<p dir="auto">This feature was first introduced in the <code>v0.5.0rc1</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.get_phase</h2><a id="user-content-ngxget_phase" class="anchor" aria-label="Permalink: ngx.get_phase" href="#ngxget_phase"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.get_phase()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_by_lua*, init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Retrieves the current running phase name. Possible return values are</p>
<ul dir="auto">
<li><code>init</code>
for the context of <a href="#init_by_lua">init_by_lua*</a>.</li>
<li><code>init_worker</code>
for the context of <a href="#init_worker_by_lua">init_worker_by_lua*</a>.</li>
<li><code>ssl_cert</code>
for the context of <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a>.</li>
<li><code>ssl_session_fetch</code>
for the context of <a href="#ssl_session_fetch_by_lua_block">ssl_session_fetch_by_lua*</a>.</li>
<li><code>ssl_session_store</code>
for the context of <a href="#ssl_session_store_by_lua_block">ssl_session_store_by_lua*</a>.</li>
<li><code>ssl_client_hello</code>
for the context of <a href="#ssl_client_hello_by_lua_block">ssl_client_hello_by_lua*</a>.</li>
<li><code>set</code>
for the context of <a href="#set_by_lua">set_by_lua*</a>.</li>
<li><code>rewrite</code>
for the context of <a href="#rewrite_by_lua">rewrite_by_lua*</a>.</li>
<li><code>balancer</code>
for the context of <a href="#balancer_by_lua_block">balancer_by_lua*</a>.</li>
<li><code>access</code>
for the context of <a href="#access_by_lua">access_by_lua*</a>.</li>
<li><code>content</code>
for the context of <a href="#content_by_lua">content_by_lua*</a>.</li>
<li><code>header_filter</code>
for the context of <a href="#header_filter_by_lua">header_filter_by_lua*</a>.</li>
<li><code>body_filter</code>
for the context of <a href="#body_filter_by_lua">body_filter_by_lua*</a>.</li>
<li><code>log</code>
for the context of <a href="#log_by_lua">log_by_lua*</a>.</li>
<li><code>timer</code>
for the context of user callback functions for <a href="#ngxtimerat">ngx.timer.*</a>.</li>
<li><code>exit_worker</code>
for the context of <a href="#exit_worker_by_lua">exit_worker_by_lua*</a>.</li>
</ul>
<p dir="auto">This API was first introduced in the <code>v0.5.10</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.thread.spawn</h2><a id="user-content-ngxthreadspawn" class="anchor" aria-label="Permalink: ngx.thread.spawn" href="#ngxthreadspawn"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>co = ngx.thread.spawn(func, arg1, arg2, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Spawns a new user "light thread" with the Lua function <code>func</code> as well as those optional arguments <code>arg1</code>, <code>arg2</code>, and etc. Returns a Lua thread (or Lua coroutine) object represents this "light thread".</p>
<p dir="auto">"Light threads" are just a special kind of Lua coroutines that are scheduled by the ngx_lua module.</p>
<p dir="auto">Before <code>ngx.thread.spawn</code> returns, the <code>func</code> will be called with those optional arguments until it returns, aborts with an error, or gets yielded due to I/O operations via the <a href="#nginx-api-for-lua">Nginx API for Lua</a> (like <a href="#tcpsockreceive">tcpsock:receive</a>).</p>
<p dir="auto">After <code>ngx.thread.spawn</code> returns, the newly-created "light thread" will keep running asynchronously usually at various I/O events.</p>
<p dir="auto">All the Lua code chunks running by <a href="#rewrite_by_lua">rewrite_by_lua</a>, <a href="#access_by_lua">access_by_lua</a>, and <a href="#content_by_lua">content_by_lua</a> are in a boilerplate "light thread" created automatically by ngx_lua. Such boilerplate "light thread" are also called "entry threads".</p>
<p dir="auto">By default, the corresponding Nginx handler (e.g., <a href="#rewrite_by_lua">rewrite_by_lua</a> handler) will not terminate until</p>
<ol dir="auto">
<li>both the "entry thread" and all the user "light threads" terminates,</li>
<li>a "light thread" (either the "entry thread" or a user "light thread") aborts by calling <a href="#ngxexit">ngx.exit</a>, <a href="#ngxexec">ngx.exec</a>, <a href="#ngxredirect">ngx.redirect</a>, or <a href="#ngxreqset_uri">ngx.req.set_uri(uri, true)</a>, or</li>
<li>the "entry thread" terminates with a Lua error.</li>
</ol>
<p dir="auto">When the user "light thread" terminates with a Lua error, however, it will not abort other running "light threads" like the "entry thread" does.</p>
<p dir="auto">Due to the limitation in the Nginx subrequest model, it is not allowed to abort a running Nginx subrequest in general. So it is also prohibited to abort a running "light thread" that is pending on one ore more Nginx subrequests. You must call <a href="#ngxthreadwait">ngx.thread.wait</a> to wait for those "light thread" to terminate before quitting the "world". A notable exception here is that you can abort pending subrequests by calling <a href="#ngxexit">ngx.exit</a> with and only with the status code <code>ngx.ERROR</code> (-1), <code>408</code>, <code>444</code>, or <code>499</code>.</p>
<p dir="auto">The "light threads" are not scheduled in a pre-emptive way. In other words, no time-slicing is performed automatically. A "light thread" will keep running exclusively on the CPU until</p>
<ol dir="auto">
<li>a (nonblocking) I/O operation cannot be completed in a single run,</li>
<li>it calls <a href="#coroutineyield">coroutine.yield</a> to actively give up execution, or</li>
<li>it is aborted by a Lua error or an invocation of <a href="#ngxexit">ngx.exit</a>, <a href="#ngxexec">ngx.exec</a>, <a href="#ngxredirect">ngx.redirect</a>, or <a href="#ngxreqset_uri">ngx.req.set_uri(uri, true)</a>.</li>
</ol>
<p dir="auto">For the first two cases, the "light thread" will usually be resumed later by the ngx_lua scheduler unless a "stop-the-world" event happens.</p>
<p dir="auto">User "light threads" can create "light threads" themselves. And normal user coroutines created by <a href="#coroutinecreate">coroutine.create</a> can also create "light threads". The coroutine (be it a normal Lua coroutine or a "light thread") that directly spawns the "light thread" is called the "parent coroutine" for the "light thread" newly spawned.</p>
<p dir="auto">The "parent coroutine" can call <a href="#ngxthreadwait">ngx.thread.wait</a> to wait on the termination of its child "light thread".</p>
<p dir="auto">You can call coroutine.status() and coroutine.yield() on the "light thread" coroutines.</p>
<p dir="auto">The status of the "light thread" coroutine can be "zombie" if</p>
<ol dir="auto">
<li>the current "light thread" already terminates (either successfully or with an error),</li>
<li>its parent coroutine is still alive, and</li>
<li>its parent coroutine is not waiting on it with <a href="#ngxthreadwait">ngx.thread.wait</a>.</li>
</ol>
<p dir="auto">The following example demonstrates the use of coroutine.yield() in the "light thread" coroutines
to do manual time-slicing:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local yield = coroutine.yield

 function f()
     local self = coroutine.running()
     ngx.say(&quot;f 1&quot;)
     yield(self)
     ngx.say(&quot;f 2&quot;)
     yield(self)
     ngx.say(&quot;f 3&quot;)
 end

 local self = coroutine.running()
 ngx.say(&quot;0&quot;)
 yield(self)

 ngx.say(&quot;1&quot;)
 ngx.thread.spawn(f)

 ngx.say(&quot;2&quot;)
 yield(self)

 ngx.say(&quot;3&quot;)
 yield(self)

 ngx.say(&quot;4&quot;)"><pre> <span class="pl-k">local</span> <span class="pl-smi">yield</span> <span class="pl-k">=</span> <span class="pl-c1">coroutine.yield</span>

 <span class="pl-k">function</span> <span class="pl-en">f</span>()
     <span class="pl-k">local</span> <span class="pl-c1">self</span> <span class="pl-k">=</span> <span class="pl-c1">coroutine.running</span>()
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>f 1<span class="pl-pds">"</span></span>)
     <span class="pl-c1">yield</span>(<span class="pl-c1">self</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>f 2<span class="pl-pds">"</span></span>)
     <span class="pl-c1">yield</span>(<span class="pl-c1">self</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>f 3<span class="pl-pds">"</span></span>)
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-c1">self</span> <span class="pl-k">=</span> <span class="pl-c1">coroutine.running</span>()
 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>0<span class="pl-pds">"</span></span>)
 <span class="pl-c1">yield</span>(<span class="pl-c1">self</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>)
 <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">f</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span>)
 <span class="pl-c1">yield</span>(<span class="pl-c1">self</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>3<span class="pl-pds">"</span></span>)
 <span class="pl-c1">yield</span>(<span class="pl-c1">self</span>)

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>4<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto">Then it will generate the output</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="0
1
f 1
2
f 2
3
f 3
4"><pre class="notranslate"><code>0
1
f 1
2
f 2
3
f 3
4
</code></pre></div>
<p dir="auto">"Light threads" are mostly useful for making concurrent upstream requests in a single Nginx request handler, much like a generalized version of <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a> that can work with all the <a href="#nginx-api-for-lua">Nginx API for Lua</a>. The following example demonstrates parallel requests to MySQL, Memcached, and upstream HTTP services in a single Lua handler, and outputting the results in the order that they actually return (similar to Facebook's BigPipe model):</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 -- query mysql, memcached, and a remote http service at the same time,
 -- output the results in the order that they
 -- actually return the results.

 local mysql = require &quot;resty.mysql&quot;
 local memcached = require &quot;resty.memcached&quot;

 local function query_mysql()
     local db = mysql:new()
     db:connect{
                 host = &quot;127.0.0.1&quot;,
                 port = 3306,
                 database = &quot;test&quot;,
                 user = &quot;monty&quot;,
                 password = &quot;mypass&quot;
               }
     local res, err, errno, sqlstate =
             db:query(&quot;select * from cats order by id asc&quot;)
     db:set_keepalive(0, 100)
     ngx.say(&quot;mysql done: &quot;, cjson.encode(res))
 end

 local function query_memcached()
     local memc = memcached:new()
     memc:connect(&quot;127.0.0.1&quot;, 11211)
     local res, err = memc:get(&quot;some_key&quot;)
     ngx.say(&quot;memcached done: &quot;, res)
 end

 local function query_http()
     local res = ngx.location.capture(&quot;/my-http-proxy&quot;)
     ngx.say(&quot;http done: &quot;, res.body)
 end

 ngx.thread.spawn(query_mysql)      -- create thread 1
 ngx.thread.spawn(query_memcached)  -- create thread 2
 ngx.thread.spawn(query_http)       -- create thread 3"><pre> <span class="pl-c"><span class="pl-c">--</span> query mysql, memcached, and a remote http service at the same time,</span>
 <span class="pl-c"><span class="pl-c">--</span> output the results in the order that they</span>
 <span class="pl-c"><span class="pl-c">--</span> actually return the results.</span>

 <span class="pl-k">local</span> <span class="pl-smi">mysql</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.mysql<span class="pl-pds">"</span></span>
 <span class="pl-k">local</span> <span class="pl-smi">memcached</span> <span class="pl-k">=</span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">"</span>resty.memcached<span class="pl-pds">"</span></span>

 <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">query_mysql</span>()
     <span class="pl-k">local</span> <span class="pl-smi">db</span> <span class="pl-k">=</span> <span class="pl-en">mysql</span>:<span class="pl-c1">new</span>()
     <span class="pl-en">db</span>:<span class="pl-c1">connect</span>{
                 <span class="pl-smi">host</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>,
                 <span class="pl-smi">port</span> <span class="pl-k">=</span> <span class="pl-c1">3306</span>,
                 <span class="pl-smi">database</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>test<span class="pl-pds">"</span></span>,
                 <span class="pl-smi">user</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>monty<span class="pl-pds">"</span></span>,
                 <span class="pl-smi">password</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>mypass<span class="pl-pds">"</span></span>
               }
     <span class="pl-k">local</span> <span class="pl-smi">res</span>, <span class="pl-smi">err</span>, <span class="pl-smi">errno</span>, <span class="pl-smi">sqlstate</span> <span class="pl-k">=</span>
             <span class="pl-en">db</span>:<span class="pl-c1">query</span>(<span class="pl-s"><span class="pl-pds">"</span>select * from cats order by id asc<span class="pl-pds">"</span></span>)
     <span class="pl-en">db</span>:<span class="pl-c1">set_keepalive</span>(<span class="pl-c1">0</span>, <span class="pl-c1">100</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>mysql done: <span class="pl-pds">"</span></span>, <span class="pl-smi">cjson</span>.<span class="pl-c1">encode</span>(<span class="pl-smi">res</span>))
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">query_memcached</span>()
     <span class="pl-k">local</span> <span class="pl-smi">memc</span> <span class="pl-k">=</span> <span class="pl-en">memcached</span>:<span class="pl-c1">new</span>()
     <span class="pl-en">memc</span>:<span class="pl-c1">connect</span>(<span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-c1">11211</span>)
     <span class="pl-k">local</span> <span class="pl-smi">res</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-en">memc</span>:<span class="pl-c1">get</span>(<span class="pl-s"><span class="pl-pds">"</span>some_key<span class="pl-pds">"</span></span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>memcached done: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>)
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">query_http</span>()
     <span class="pl-k">local</span> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-c1">capture</span>(<span class="pl-s"><span class="pl-pds">"</span>/my-http-proxy<span class="pl-pds">"</span></span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>http done: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>.<span class="pl-e">body</span>)
 <span class="pl-k">end</span>

 <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">query_mysql</span>)      <span class="pl-c"><span class="pl-c">--</span> create thread 1</span>
 <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">query_memcached</span>)  <span class="pl-c"><span class="pl-c">--</span> create thread 2</span>
 <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">query_http</span>)       <span class="pl-c"><span class="pl-c">--</span> create thread 3</span></pre></div>
<p dir="auto">This API was first enabled in the <code>v0.7.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.thread.wait</h2><a id="user-content-ngxthreadwait" class="anchor" aria-label="Permalink: ngx.thread.wait" href="#ngxthreadwait"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, res1, res2, ... = ngx.thread.wait(thread1, thread2, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Waits on one or more child "light threads" and returns the results of the first "light thread" that terminates (either successfully or with an error).</p>
<p dir="auto">The arguments <code>thread1</code>, <code>thread2</code>, and etc are the Lua thread objects returned by earlier calls of <a href="#ngxthreadspawn">ngx.thread.spawn</a>.</p>
<p dir="auto">The return values have exactly the same meaning as <a href="#coroutineresume">coroutine.resume</a>, that is, the first value returned is a boolean value indicating whether the "light thread" terminates successfully or not, and subsequent values returned are the return values of the user Lua function that was used to spawn the "light thread" (in case of success) or the error object (in case of failure).</p>
<p dir="auto">Only the direct "parent coroutine" can wait on its child "light thread", otherwise a Lua exception will be raised.</p>
<p dir="auto">The following example demonstrates the use of <code>ngx.thread.wait</code> and <a href="#ngxlocationcapture">ngx.location.capture</a> to emulate <a href="#ngxlocationcapture_multi">ngx.location.capture_multi</a>:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local capture = ngx.location.capture
 local spawn = ngx.thread.spawn
 local wait = ngx.thread.wait
 local say = ngx.say

 local function fetch(uri)
     return capture(uri)
 end

 local threads = {
     spawn(fetch, &quot;/foo&quot;),
     spawn(fetch, &quot;/bar&quot;),
     spawn(fetch, &quot;/baz&quot;)
 }

 for i = 1, #threads do
     local ok, res = wait(threads[i])
     if not ok then
         say(i, &quot;: failed to run: &quot;, res)
     else
         say(i, &quot;: status: &quot;, res.status)
         say(i, &quot;: body: &quot;, res.body)
     end
 end"><pre> <span class="pl-k">local</span> <span class="pl-smi">capture</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">location</span>.<span class="pl-e">capture</span>
 <span class="pl-k">local</span> <span class="pl-smi">spawn</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-e">spawn</span>
 <span class="pl-k">local</span> <span class="pl-smi">wait</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-e">wait</span>
 <span class="pl-k">local</span> <span class="pl-smi">say</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">say</span>

 <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">fetch</span>(<span class="pl-smi">uri</span>)
     <span class="pl-k">return</span> <span class="pl-c1">capture</span>(<span class="pl-smi">uri</span>)
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">threads</span> <span class="pl-k">=</span> {
     <span class="pl-c1">spawn</span>(<span class="pl-smi">fetch</span>, <span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>),
     <span class="pl-c1">spawn</span>(<span class="pl-smi">fetch</span>, <span class="pl-s"><span class="pl-pds">"</span>/bar<span class="pl-pds">"</span></span>),
     <span class="pl-c1">spawn</span>(<span class="pl-smi">fetch</span>, <span class="pl-s"><span class="pl-pds">"</span>/baz<span class="pl-pds">"</span></span>)
 }

 <span class="pl-k">for</span> <span class="pl-smi">i</span> <span class="pl-k">=</span> <span class="pl-c1">1</span>, <span class="pl-k">#</span><span class="pl-smi">threads</span> <span class="pl-k">do</span>
     <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-c1">wait</span>(<span class="pl-smi">threads</span>[<span class="pl-smi">i</span>])
     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
         <span class="pl-c1">say</span>(<span class="pl-smi">i</span>, <span class="pl-s"><span class="pl-pds">"</span>: failed to run: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>)
     <span class="pl-k">else</span>
         <span class="pl-c1">say</span>(<span class="pl-smi">i</span>, <span class="pl-s"><span class="pl-pds">"</span>: status: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>.<span class="pl-e">status</span>)
         <span class="pl-c1">say</span>(<span class="pl-smi">i</span>, <span class="pl-s"><span class="pl-pds">"</span>: body: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>.<span class="pl-e">body</span>)
     <span class="pl-k">end</span>
 <span class="pl-k">end</span></pre></div>
<p dir="auto">Here it essentially implements the "wait all" model.</p>
<p dir="auto">And below is an example demonstrating the "wait any" model:</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 function f()
     ngx.sleep(0.2)
     ngx.say(&quot;f: hello&quot;)
     return &quot;f done&quot;
 end

 function g()
     ngx.sleep(0.1)
     ngx.say(&quot;g: hello&quot;)
     return &quot;g done&quot;
 end

 local tf, err = ngx.thread.spawn(f)
 if not tf then
     ngx.say(&quot;failed to spawn thread f: &quot;, err)
     return
 end

 ngx.say(&quot;f thread created: &quot;, coroutine.status(tf))

 local tg, err = ngx.thread.spawn(g)
 if not tg then
     ngx.say(&quot;failed to spawn thread g: &quot;, err)
     return
 end

 ngx.say(&quot;g thread created: &quot;, coroutine.status(tg))

 ok, res = ngx.thread.wait(tf, tg)
 if not ok then
     ngx.say(&quot;failed to wait: &quot;, res)
     return
 end

 ngx.say(&quot;res: &quot;, res)

 -- stop the &quot;world&quot;, aborting other running threads
 ngx.exit(ngx.OK)"><pre> <span class="pl-k">function</span> <span class="pl-en">f</span>()
     <span class="pl-smi">ngx</span>.<span class="pl-c1">sleep</span>(<span class="pl-c1">0.2</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>f: hello<span class="pl-pds">"</span></span>)
     <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>f done<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>

 <span class="pl-k">function</span> <span class="pl-en">g</span>()
     <span class="pl-smi">ngx</span>.<span class="pl-c1">sleep</span>(<span class="pl-c1">0.1</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>g: hello<span class="pl-pds">"</span></span>)
     <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>g done<span class="pl-pds">"</span></span>
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">tf</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">f</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">tf</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to spawn thread f: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>f thread created: <span class="pl-pds">"</span></span>, <span class="pl-c1">coroutine.status</span>(<span class="pl-smi">tf</span>))

 <span class="pl-k">local</span> <span class="pl-smi">tg</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">spawn</span>(<span class="pl-smi">g</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">tg</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to spawn thread g: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>g thread created: <span class="pl-pds">"</span></span>, <span class="pl-c1">coroutine.status</span>(<span class="pl-smi">tg</span>))

 <span class="pl-smi">ok</span>, <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">thread</span>.<span class="pl-c1">wait</span>(<span class="pl-smi">tf</span>, <span class="pl-smi">tg</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>failed to wait: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-smi">ngx</span>.<span class="pl-c1">say</span>(<span class="pl-s"><span class="pl-pds">"</span>res: <span class="pl-pds">"</span></span>, <span class="pl-smi">res</span>)

 <span class="pl-c"><span class="pl-c">--</span> stop the "world", aborting other running threads</span>
 <span class="pl-smi">ngx</span>.<span class="pl-c1">exit</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">OK</span>)</pre></div>
<p dir="auto">And it will generate the following output:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="f thread created: running
g thread created: running
g: hello
res: g done"><pre class="notranslate"><code>f thread created: running
g thread created: running
g: hello
res: g done
</code></pre></div>
<p dir="auto">This API was first enabled in the <code>v0.7.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.thread.kill</h2><a id="user-content-ngxthreadkill" class="anchor" aria-label="Permalink: ngx.thread.kill" href="#ngxthreadkill"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.thread.kill(thread)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Kills a running "light thread" created by <a href="#ngxthreadspawn">ngx.thread.spawn</a>. Returns a true value when successful or <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto">According to the current implementation, only the parent coroutine (or "light thread") can kill a thread. Also, a running "light thread" with pending Nginx subrequests (initiated by <a href="#ngxlocationcapture">ngx.location.capture</a> for example) cannot be killed due to a limitation in the Nginx core.</p>
<p dir="auto">This API was first enabled in the <code>v0.9.9</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.on_abort</h2><a id="user-content-ngxon_abort" class="anchor" aria-label="Permalink: ngx.on_abort" href="#ngxon_abort"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, err = ngx.on_abort(callback)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto">Registers a user Lua function as the callback which gets called automatically when the client closes the (downstream) connection prematurely.</p>
<p dir="auto">Returns <code>1</code> if the callback is registered successfully or returns <code>nil</code> and a string describing the error otherwise.</p>
<p dir="auto">All the <a href="#nginx-api-for-lua">Nginx API for Lua</a> can be used in the callback function because the function is run in a special "light thread", just as those "light threads" created by <a href="#ngxthreadspawn">ngx.thread.spawn</a>.</p>
<p dir="auto">The callback function can decide what to do with the client abortion event all by itself. For example, it can simply ignore the event by doing nothing and the current Lua request handler will continue executing without interruptions. And the callback function can also decide to terminate everything by calling <a href="#ngxexit">ngx.exit</a>, for example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local function my_cleanup()
     -- custom cleanup work goes here, like cancelling a pending DB transaction

     -- now abort all the &quot;light threads&quot; running in the current request handler
     ngx.exit(499)
 end

 local ok, err = ngx.on_abort(my_cleanup)
 if not ok then
     ngx.log(ngx.ERR, &quot;failed to register the on_abort callback: &quot;, err)
     ngx.exit(500)
 end"><pre> <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">my_cleanup</span>()
     <span class="pl-c"><span class="pl-c">--</span> custom cleanup work goes here, like cancelling a pending DB transaction</span>

     <span class="pl-c"><span class="pl-c">--</span> now abort all the "light threads" running in the current request handler</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">exit</span>(<span class="pl-c1">499</span>)
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">on_abort</span>(<span class="pl-smi">my_cleanup</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>failed to register the on_abort callback: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-smi">ngx</span>.<span class="pl-c1">exit</span>(<span class="pl-c1">500</span>)
 <span class="pl-k">end</span></pre></div>
<p dir="auto">When <a href="#lua_check_client_abort">lua_check_client_abort</a> is set to <code>off</code> (which is the default), then this function call will always return the error message "lua_check_client_abort is off".</p>
<p dir="auto">According to the current implementation, this function can only be called once in a single request handler; subsequent calls will return the error message "duplicate call".</p>
<p dir="auto">This API was first introduced in the <code>v0.7.4</code> release.</p>
<p dir="auto">See also <a href="#lua_check_client_abort">lua_check_client_abort</a>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.timer.at</h2><a id="user-content-ngxtimerat" class="anchor" aria-label="Permalink: ngx.timer.at" href="#ngxtimerat"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>hdl, err = ngx.timer.at(delay, callback, user_arg1, user_arg2, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Creates an Nginx timer with a user callback function as well as optional user arguments.</p>
<p dir="auto">The first argument, <code>delay</code>, specifies the delay for the timer,
in seconds. One can specify fractional seconds like <code>0.001</code> to mean 1
millisecond here. <code>0</code> delay can also be specified, in which case the
timer will immediately expire when the current handler yields
execution.</p>
<p dir="auto">The second argument, <code>callback</code>, can
be any Lua function, which will be invoked later in a background
"light thread" after the delay specified. The user callback will be
called automatically by the Nginx core with the arguments <code>premature</code>,
<code>user_arg1</code>, <code>user_arg2</code>, and etc, where the <code>premature</code>
argument takes a boolean value indicating whether it is a premature timer
expiration or not(for the <code>0</code> delay timer it is always <code>false</code>), and <code>user_arg1</code>, <code>user_arg2</code>, and etc, are
those (extra) user arguments specified when calling <code>ngx.timer.at</code>
as the remaining arguments.</p>
<p dir="auto">Premature timer expiration happens when the Nginx worker process is
trying to shut down, as in an Nginx configuration reload triggered by
the <code>HUP</code> signal or in an Nginx server shutdown. When the Nginx worker
is trying to shut down, one can no longer call <code>ngx.timer.at</code> to
create new timers with nonzero delays and in that case <code>ngx.timer.at</code> will return a "conditional false" value and
a string describing the error, that is, "process exiting".</p>
<p dir="auto">Starting from the <code>v0.9.3</code> release, it is allowed to create zero-delay timers even when the Nginx worker process starts shutting down.</p>
<p dir="auto">When a timer expires, the user Lua code in the timer callback is
running in a "light thread" detached completely from the original
request creating the timer. So objects with the same lifetime as the
request creating them, like <a href="#ngxsockettcp">cosockets</a>, cannot be shared between the
original request and the timer user callback function.</p>
<p dir="auto">Here is a simple example:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location / {
     ...
     log_by_lua_block {
         local function push_data(premature, uri, args, status)
             -- push the data uri, args, and status to the remote
             -- via ngx.socket.tcp or ngx.socket.udp
             -- (one may want to buffer the data in Lua a bit to
             -- save I/O operations)
         end
         local ok, err = ngx.timer.at(0, push_data,
                                      ngx.var.uri, ngx.var.args, ngx.header.status)
         if not ok then
             ngx.log(ngx.ERR, &quot;failed to create timer: &quot;, err)
             return
         end

         -- other job in log_by_lua_block
     }
 }"><pre> <span class="pl-c1">location</span> / <span class="pl-c1">{</span>
     ...
     log_by_lua_block <span class="pl-c1">{</span>
         local function push_data<span class="pl-c1">(</span>premature, uri, args, <span class="pl-c1">status</span><span class="pl-c1">)</span>
             -- push the data uri, args, and <span class="pl-c1">status</span> to the remote
             -- via ngx.socket.tcp or ngx.socket.udp
             -- <span class="pl-c1">(</span>one may want to buffer the data in Lua a bit to
             -- save I/O operations<span class="pl-c1">)</span>
         end
         local ok, err = ngx.timer.at<span class="pl-c1">(</span>0, push_data,
                                      ngx.var.uri, ngx.var.args, ngx.header.<span class="pl-c1">status</span><span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.log<span class="pl-c1">(</span>ngx.ERR, <span class="pl-s">"failed to create timer: "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end

         -- other job in log_by_lua_block
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto">One can also create infinite re-occurring timers, for instance, a timer getting triggered every <code>5</code> seconds, by calling <code>ngx.timer.at</code> recursively in the timer callback function. Here is such an example,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local delay = 5
 local handler
 handler = function (premature)
     -- do some routine job in Lua just like a cron job
     if premature then
         return
     end
     local ok, err = ngx.timer.at(delay, handler)
     if not ok then
         ngx.log(ngx.ERR, &quot;failed to create the timer: &quot;, err)
         return
     end

     -- do something in timer
 end

 local ok, err = ngx.timer.at(delay, handler)
 if not ok then
     ngx.log(ngx.ERR, &quot;failed to create the timer: &quot;, err)
     return
 end

 -- do other jobs"><pre> <span class="pl-k">local</span> <span class="pl-smi">delay</span> <span class="pl-k">=</span> <span class="pl-c1">5</span>
 <span class="pl-k">local</span> <span class="pl-smi">handler</span>
 <span class="pl-en">handler</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">premature</span>)
     <span class="pl-c"><span class="pl-c">--</span> do some routine job in Lua just like a cron job</span>
     <span class="pl-k">if</span> <span class="pl-smi">premature</span> <span class="pl-k">then</span>
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>
     <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">timer</span>.<span class="pl-c1">at</span>(<span class="pl-smi">delay</span>, <span class="pl-smi">handler</span>)
     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
         <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>failed to create the timer: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
         <span class="pl-k">return</span>
     <span class="pl-k">end</span>

     <span class="pl-c"><span class="pl-c">--</span> do something in timer</span>
 <span class="pl-k">end</span>

 <span class="pl-k">local</span> <span class="pl-smi">ok</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-smi">ngx</span>.<span class="pl-e">timer</span>.<span class="pl-c1">at</span>(<span class="pl-smi">delay</span>, <span class="pl-smi">handler</span>)
 <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">ok</span> <span class="pl-k">then</span>
     <span class="pl-smi">ngx</span>.<span class="pl-c1">log</span>(<span class="pl-smi">ngx</span>.<span class="pl-e">ERR</span>, <span class="pl-s"><span class="pl-pds">"</span>failed to create the timer: <span class="pl-pds">"</span></span>, <span class="pl-smi">err</span>)
     <span class="pl-k">return</span>
 <span class="pl-k">end</span>

 <span class="pl-c"><span class="pl-c">--</span> do other jobs</span></pre></div>
<p dir="auto">It is recommended, however, to use the <a href="#ngxtimerevery">ngx.timer.every</a> API function
instead for creating recurring timers since it is more robust.</p>
<p dir="auto">Because timer callbacks run in the background and their running time
will not add to any client request's response time, they can easily
accumulate in the server and exhaust system resources due to either
Lua programming mistakes or just too much client traffic. To prevent
extreme consequences like crashing the Nginx server, there are
built-in limitations on both the number of "pending timers" and the
number of "running timers" in an Nginx worker process. The "pending
timers" here mean timers that have not yet been expired and "running
timers" are those whose user callbacks are currently running.</p>
<p dir="auto">The maximal number of pending timers allowed in an Nginx
worker is controlled by the <a href="#lua_max_pending_timers">lua_max_pending_timers</a>
directive. The maximal number of running timers is controlled by the
<a href="#lua_max_running_timers">lua_max_running_timers</a> directive.</p>
<p dir="auto">According to the current implementation, each "running timer" will
take one (fake) connection record from the global connection record
list configured by the standard <a href="http://nginx.org/en/docs/ngx_core_module.html#worker_connections" rel="nofollow">worker_connections</a> directive in
<code>nginx.conf</code>. So ensure that the
<a href="http://nginx.org/en/docs/ngx_core_module.html#worker_connections" rel="nofollow">worker_connections</a> directive is set to
a large enough value that takes into account both the real connections
and fake connections required by timer callbacks (as limited by the
<a href="#lua_max_running_timers">lua_max_running_timers</a> directive).</p>
<p dir="auto">A lot of the Lua APIs for Nginx are enabled in the context of the timer
callbacks, like stream/datagram cosockets (<a href="#ngxsockettcp">ngx.socket.tcp</a> and <a href="#ngxsocketudp">ngx.socket.udp</a>), shared
memory dictionaries (<a href="#ngxshareddict">ngx.shared.DICT</a>), user coroutines (<a href="#coroutinecreate">coroutine.*</a>),
user "light threads" (<a href="#ngxthreadspawn">ngx.thread.*</a>), <a href="#ngxexit">ngx.exit</a>, <a href="#ngxnow">ngx.now</a>/<a href="#ngxtime">ngx.time</a>,
<a href="#ngxmd5">ngx.md5</a>/<a href="#ngxsha1_bin">ngx.sha1_bin</a>, are all allowed. But the subrequest API (like
<a href="#ngxlocationcapture">ngx.location.capture</a>), the <a href="#ngxreqstart_time">ngx.req.*</a> API, the downstream output API
(like <a href="#ngxsay">ngx.say</a>, <a href="#ngxprint">ngx.print</a>, and <a href="#ngxflush">ngx.flush</a>) are explicitly disabled in
this context.</p>
<p dir="auto">You must notice that each timer will be based on a fake request (this fake request is also based on a fake connection). Because Nginx's memory release is based on the connection closure, if you run a lot of APIs that apply for memory resources in a timer, such as <a href="#tcpsockconnect">tcpsock:connect</a>, will cause the accumulation of memory resources. So it is recommended to create a new timer after running several times to release memory resources.</p>
<p dir="auto">You can pass most of the standard Lua values (nils, booleans, numbers, strings, tables, closures, file handles, etc.) into the timer callback, either explicitly as user arguments or implicitly as upvalues for the callback closure. There are several exceptions, however: you <em>cannot</em> pass any thread objects returned by <a href="#coroutinecreate">coroutine.create</a> and <a href="#ngxthreadspawn">ngx.thread.spawn</a> or any cosocket objects returned by <a href="#ngxsockettcp">ngx.socket.tcp</a>, <a href="#ngxsocketudp">ngx.socket.udp</a>, and <a href="#ngxreqsocket">ngx.req.socket</a> because these objects' lifetime is bound to the request context creating them while the timer callback is detached from the creating request's context (by design) and runs in its own (fake) request context. If you try to share the thread or cosocket objects across the boundary of the creating request, then you will get the "no co ctx found" error (for threads) or "bad request" (for cosockets). It is fine, however, to create all these objects inside your timer callback.</p>
<p dir="auto">Please note that the timer Lua handler has its own copy of the <code>ngx.ctx</code> magic
table. It won't share the same <code>ngx.ctx</code> with the Lua handler creating the timer.
If you need to pass data from the timer creator to the timer handler, please
use the extra parameters of <code>ngx.timer.at()</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.8.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.timer.every</h2><a id="user-content-ngxtimerevery" class="anchor" aria-label="Permalink: ngx.timer.every" href="#ngxtimerevery"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>hdl, err = ngx.timer.every(delay, callback, user_arg1, user_arg2, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the <a href="#ngxtimerat">ngx.timer.at</a> API function, but</p>
<ol dir="auto">
<li><code>delay</code> <em>cannot</em> be zero,</li>
<li>timer will be created every <code>delay</code> seconds until the current Nginx worker process starts exiting.</li>
</ol>
<p dir="auto">Like <a href="#ngxtimerat">ngx.timer.at</a>, the <code>callback</code> argument will be called
automatically with the arguments <code>premature</code>, <code>user_arg1</code>, <code>user_arg2</code>, etc.</p>
<p dir="auto">When success, returns a "conditional true" value (but not a <code>true</code>). Otherwise, returns a "conditional false" value and a string describing the error.</p>
<p dir="auto">This API also respect the <a href="#lua_max_pending_timers">lua_max_pending_timers</a> and <a href="#lua_max_running_timers">lua_max_running_timers</a>.</p>
<p dir="auto">This API was first introduced in the <code>v0.10.9</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.timer.running_count</h2><a id="user-content-ngxtimerrunning_count" class="anchor" aria-label="Permalink: ngx.timer.running_count" href="#ngxtimerrunning_count"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>count = ngx.timer.running_count()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the number of timers currently running.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.20</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.timer.pending_count</h2><a id="user-content-ngxtimerpending_count" class="anchor" aria-label="Permalink: ngx.timer.pending_count" href="#ngxtimerpending_count"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>count = ngx.timer.pending_count()</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Returns the number of pending timers.</p>
<p dir="auto">This directive was first introduced in the <code>v0.9.20</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.subsystem</h2><a id="user-content-ngxconfigsubsystem" class="anchor" aria-label="Permalink: ngx.config.subsystem" href="#ngxconfigsubsystem"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>subsystem = ngx.config.subsystem</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This string field indicates the Nginx subsystem the current Lua environment is based on. For this module, this field always takes the string value <code>"http"</code>. For
<a href="https://github.com/openresty/stream-lua-nginx-module#readme">ngx_stream_lua_module</a>, however, this field takes the value <code>"stream"</code>.</p>
<p dir="auto">This field was first introduced in the <code>0.10.1</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.debug</h2><a id="user-content-ngxconfigdebug" class="anchor" aria-label="Permalink: ngx.config.debug" href="#ngxconfigdebug"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>debug = ngx.config.debug</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This boolean field indicates whether the current Nginx is a debug build, i.e., being built by the <code>./configure</code> option <code>--with-debug</code>.</p>
<p dir="auto">This field was first introduced in the <code>0.8.7</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.prefix</h2><a id="user-content-ngxconfigprefix" class="anchor" aria-label="Permalink: ngx.config.prefix" href="#ngxconfigprefix"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>prefix = ngx.config.prefix()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">Returns the Nginx server "prefix" path, as determined by the <code>-p</code> command-line option when running the Nginx executable, or the path specified by the <code>--prefix</code> command-line option when building Nginx with the <code>./configure</code> script.</p>
<p dir="auto">This function was first introduced in the <code>0.9.2</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.nginx_version</h2><a id="user-content-ngxconfignginx_version" class="anchor" aria-label="Permalink: ngx.config.nginx_version" href="#ngxconfignginx_version"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ver = ngx.config.nginx_version</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This field take an integral value indicating the version number of the current Nginx core being used. For example, the version number <code>1.4.3</code> results in the Lua number 1004003.</p>
<p dir="auto">This API was first introduced in the <code>0.9.3</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.nginx_configure</h2><a id="user-content-ngxconfignginx_configure" class="anchor" aria-label="Permalink: ngx.config.nginx_configure" href="#ngxconfignginx_configure"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>str = ngx.config.nginx_configure()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*</em></p>
<p dir="auto">This function returns a string for the Nginx <code>./configure</code> command's arguments string.</p>
<p dir="auto">This API was first introduced in the <code>0.9.5</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.config.ngx_lua_version</h2><a id="user-content-ngxconfigngx_lua_version" class="anchor" aria-label="Permalink: ngx.config.ngx_lua_version" href="#ngxconfigngx_lua_version"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ver = ngx.config.ngx_lua_version</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*</em></p>
<p dir="auto">This field take an integral value indicating the version number of the current <code>ngx_lua</code> module being used. For example, the version number <code>0.9.3</code> results in the Lua number 9003.</p>
<p dir="auto">This API was first introduced in the <code>0.9.3</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.worker.exiting</h2><a id="user-content-ngxworkerexiting" class="anchor" aria-label="Permalink: ngx.worker.exiting" href="#ngxworkerexiting"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>exiting = ngx.worker.exiting()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This function returns a boolean value indicating whether the current Nginx worker process already starts exiting. Nginx worker process exiting happens on Nginx server quit or configuration reload (aka HUP reload).</p>
<p dir="auto">This API was first introduced in the <code>0.9.3</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.worker.pid</h2><a id="user-content-ngxworkerpid" class="anchor" aria-label="Permalink: ngx.worker.pid" href="#ngxworkerpid"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>pid = ngx.worker.pid()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">This function returns a Lua number for the process ID (PID) of the current Nginx worker process. This API is more efficient than <code>ngx.var.pid</code> and can be used in contexts where the <a href="#ngxvarvariable">ngx.var.VARIABLE</a> API cannot be used (like <a href="#init_worker_by_lua">init_worker_by_lua</a>).</p>
<p dir="auto">This API was first introduced in the <code>0.9.5</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.worker.pids</h2><a id="user-content-ngxworkerpids" class="anchor" aria-label="Permalink: ngx.worker.pids" href="#ngxworkerpids"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>pids = ngx.worker.pids()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, exit_worker_by_lua*</em></p>
<p dir="auto">This function returns a Lua table for all Nginx worker process IDs (PIDs). Nginx uses channel to send the current worker PID to another worker in the worker process start or restart. So this API can get all current worker PIDs. Windows does not have this API.</p>
<p dir="auto">This API was first introduced in the <code>0.10.23</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.worker.count</h2><a id="user-content-ngxworkercount" class="anchor" aria-label="Permalink: ngx.worker.count" href="#ngxworkercount"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>count = ngx.worker.count()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_by_lua*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">Returns the total number of the Nginx worker processes (i.e., the value configured
by the <a href="https://nginx.org/en/docs/ngx_core_module.html#worker_processes" rel="nofollow">worker_processes</a>
directive in <code>nginx.conf</code>).</p>
<p dir="auto">This API was first introduced in the <code>0.9.20</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.worker.id</h2><a id="user-content-ngxworkerid" class="anchor" aria-label="Permalink: ngx.worker.id" href="#ngxworkerid"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>id = ngx.worker.id()</em></p>
<p dir="auto"><strong>context:</strong> <em>set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, init_worker_by_lua*, exit_worker_by_lua*</em></p>
<p dir="auto">Returns the ordinal number of the current Nginx worker processes (starting from number 0).</p>
<p dir="auto">So if the total number of workers is <code>N</code>, then this method may return a number between 0
and <code>N - 1</code> (inclusive).</p>
<p dir="auto">This function returns meaningful values only for Nginx 1.9.1+. With earlier versions of Nginx, it
always returns <code>nil</code>.</p>
<p dir="auto">See also <a href="#ngxworkercount">ngx.worker.count</a>.</p>
<p dir="auto">This API was first introduced in the <code>0.9.20</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.semaphore</h2><a id="user-content-ngxsemaphore" class="anchor" aria-label="Permalink: ngx.semaphore" href="#ngxsemaphore"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>local semaphore = require "ngx.semaphore"</em></p>
<p dir="auto">This is a Lua module that implements a classic-style semaphore API for efficient synchronizations among
different "light threads". Sharing the same semaphore among different "light threads" created in different (request)
contexts are also supported as long as the "light threads" reside in the same Nginx worker process
and the <a href="#lua_code_cache">lua_code_cache</a> directive is turned on (which is the default).</p>
<p dir="auto">This Lua module does not ship with this ngx_lua module itself rather it is shipped with
the
<a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">Please refer to the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/semaphore.md">documentation</a>
for this <code>ngx.semaphore</code> Lua module in <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a>
for more details.</p>
<p dir="auto">This feature requires at least ngx_lua <code>v0.10.0</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.balancer</h2><a id="user-content-ngxbalancer" class="anchor" aria-label="Permalink: ngx.balancer" href="#ngxbalancer"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>local balancer = require "ngx.balancer"</em></p>
<p dir="auto">This is a Lua module that provides a Lua API to allow defining completely dynamic load balancers
in pure Lua.</p>
<p dir="auto">This Lua module does not ship with this ngx_lua module itself rather it is shipped with
the
<a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">Please refer to the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md">documentation</a>
for this <code>ngx.balancer</code> Lua module in <a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a>
for more details.</p>
<p dir="auto">This feature requires at least ngx_lua <code>v0.10.0</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.ssl</h2><a id="user-content-ngxssl" class="anchor" aria-label="Permalink: ngx.ssl" href="#ngxssl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>local ssl = require "ngx.ssl"</em></p>
<p dir="auto">This Lua module provides API functions to control the SSL handshake process in contexts like
<a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a>.</p>
<p dir="auto">This Lua module does not ship with this ngx_lua module itself rather it is shipped with
the
<a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">Please refer to the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md">documentation</a>
for this <code>ngx.ssl</code> Lua module for more details.</p>
<p dir="auto">This feature requires at least ngx_lua <code>v0.10.0</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.ocsp</h2><a id="user-content-ngxocsp" class="anchor" aria-label="Permalink: ngx.ocsp" href="#ngxocsp"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>local ocsp = require "ngx.ocsp"</em></p>
<p dir="auto">This Lua module provides API to perform OCSP queries, OCSP response validations, and
OCSP stapling planting.</p>
<p dir="auto">Usually, this module is used together with the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md">ngx.ssl</a>
module in the
context of <a href="#ssl_certificate_by_lua_block">ssl_certificate_by_lua*</a>.</p>
<p dir="auto">This Lua module does not ship with this ngx_lua module itself rather it is shipped with
the
<a href="https://github.com/openresty/lua-resty-core">lua-resty-core</a> library.</p>
<p dir="auto">Please refer to the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ocsp.md">documentation</a>
for this <code>ngx.ocsp</code> Lua module for more details.</p>
<p dir="auto">This feature requires at least ngx_lua <code>v0.10.0</code>.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ndk.set_var.DIRECTIVE</h2><a id="user-content-ndkset_vardirective" class="anchor" aria-label="Permalink: ndk.set_var.DIRECTIVE" href="#ndkset_vardirective"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>res = ndk.set_var.DIRECTIVE_NAME</em></p>
<p dir="auto"><strong>context:</strong> <em>init_worker_by_lua*, set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, exit_worker_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">This mechanism allows calling other Nginx C modules' directives that are implemented by <a href="https://github.com/simplresty/ngx_devel_kit">Nginx Devel Kit</a> (NDK)'s set_var submodule's <code>ndk_set_var_value</code>.</p>
<p dir="auto">For example, the following <a href="http://github.com/openresty/set-misc-nginx-module">set-misc-nginx-module</a> directives can be invoked this way:</p>
<ul dir="auto">
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_quote_sql_str">set_quote_sql_str</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_quote_pgsql_str">set_quote_pgsql_str</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_quote_json_str">set_quote_json_str</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_unescape_uri">set_unescape_uri</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_escape_uri">set_escape_uri</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_encode_base32">set_encode_base32</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_decode_base32">set_decode_base32</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_encode_base64">set_encode_base64</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_decode_base64">set_decode_base64</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_encode_base64">set_encode_hex</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_decode_base64">set_decode_hex</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_encode_base64">set_sha1</a></li>
<li><a href="http://github.com/openresty/set-misc-nginx-module#set_decode_base64">set_md5</a></li>
</ul>
<p dir="auto">For instance,</p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local res = ndk.set_var.set_escape_uri('a/b')
 -- now res == 'a%2fb'"><pre> <span class="pl-k">local</span> <span class="pl-smi">res</span> <span class="pl-k">=</span> <span class="pl-smi">ndk</span>.<span class="pl-e">set_var</span>.<span class="pl-c1">set_escape_uri</span>(<span class="pl-s"><span class="pl-pds">'</span>a/b<span class="pl-pds">'</span></span>)
 <span class="pl-c"><span class="pl-c">--</span> now res == 'a%2fb'</span></pre></div>
<p dir="auto">Similarly, the following directives provided by <a href="http://github.com/openresty/encrypted-session-nginx-module">encrypted-session-nginx-module</a> can be invoked from within Lua too:</p>
<ul dir="auto">
<li><a href="http://github.com/openresty/encrypted-session-nginx-module#set_encrypt_session">set_encrypt_session</a></li>
<li><a href="http://github.com/openresty/encrypted-session-nginx-module#set_decrypt_session">set_decrypt_session</a></li>
</ul>
<p dir="auto">This feature requires the <a href="https://github.com/simplresty/ngx_devel_kit">ngx_devel_kit</a> module.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.create</h2><a id="user-content-coroutinecreate" class="anchor" aria-label="Permalink: coroutine.create" href="#coroutinecreate"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>co = coroutine.create(f)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Creates a user Lua coroutines with a Lua function, and returns a coroutine object.</p>
<p dir="auto">Similar to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.create" rel="nofollow">coroutine.create</a> API, but works in the context of the Lua coroutines created by ngx_lua.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.resume</h2><a id="user-content-coroutineresume" class="anchor" aria-label="Permalink: coroutine.resume" href="#coroutineresume"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, ... = coroutine.resume(co, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Resumes the execution of a user Lua coroutine object previously yielded or just created.</p>
<p dir="auto">Similar to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.resume" rel="nofollow">coroutine.resume</a> API, but works in the context of the Lua coroutines created by ngx_lua.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.yield</h2><a id="user-content-coroutineyield" class="anchor" aria-label="Permalink: coroutine.yield" href="#coroutineyield"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>... = coroutine.yield(...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Yields the execution of the current user Lua coroutine.</p>
<p dir="auto">Similar to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.yield" rel="nofollow">coroutine.yield</a> API, but works in the context of the Lua coroutines created by ngx_lua.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.wrap</h2><a id="user-content-coroutinewrap" class="anchor" aria-label="Permalink: coroutine.wrap" href="#coroutinewrap"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>co = coroutine.wrap(f)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Similar to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.wrap" rel="nofollow">coroutine.wrap</a> API, but works in the context of the Lua coroutines created by ngx_lua.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first introduced in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.running</h2><a id="user-content-coroutinerunning" class="anchor" aria-label="Permalink: coroutine.running" href="#coroutinerunning"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>co = coroutine.running()</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Identical to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.running" rel="nofollow">coroutine.running</a> API.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first enabled in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">coroutine.status</h2><a id="user-content-coroutinestatus" class="anchor" aria-label="Permalink: coroutine.status" href="#coroutinestatus"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>status = coroutine.status(co)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*, init_by_lua*, ngx.timer.*, header_filter_by_lua*, body_filter_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*, ssl_client_hello_by_lua*</em></p>
<p dir="auto">Identical to the standard Lua <a href="https://www.lua.org/manual/5.1/manual.html#pdf-coroutine.status" rel="nofollow">coroutine.status</a> API.</p>
<p dir="auto">This API was first usable in the context of <a href="#init_by_lua">init_by_lua*</a> since the <code>0.9.2</code>.</p>
<p dir="auto">This API was first enabled in the <code>v0.6.0</code> release.</p>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">ngx.run_worker_thread</h2><a id="user-content-ngxrun_worker_thread" class="anchor" aria-label="Permalink: ngx.run_worker_thread" href="#ngxrun_worker_thread"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>syntax:</strong> <em>ok, res1, res2, ... = ngx.run_worker_thread(threadpool, module_name, func_name, arg1, arg2, ...)</em></p>
<p dir="auto"><strong>context:</strong> <em>rewrite_by_lua*, access_by_lua*, content_by_lua*</em></p>
<p dir="auto"><strong>This API is still experimental and may change in the future without notice.</strong></p>
<p dir="auto"><strong>This API is available only for Linux.</strong></p>
<p dir="auto">Wrap the <a href="http://nginx.org/en/docs/dev/development_guide.html#threads" rel="nofollow">nginx worker thread</a> to execute lua function. The caller coroutine would yield until the function returns.</p>
<p dir="auto">Only the following ngx_lua APIs could be used in <code>function_name</code> function of the <code>module</code> module:</p>
<ul dir="auto">
<li>
<p dir="auto"><code>ngx.encode_base64</code></p>
</li>
<li>
<p dir="auto"><code>ngx.decode_base64</code></p>
</li>
<li>
<p dir="auto"><code>ngx.hmac_sha1</code></p>
</li>
<li>
<p dir="auto"><code>ngx.encode_args</code></p>
</li>
<li>
<p dir="auto"><code>ngx.decode_args</code></p>
</li>
<li>
<p dir="auto"><code>ngx.quote_sql_str</code></p>
</li>
<li>
<p dir="auto"><code>ngx.crc32_short</code></p>
</li>
<li>
<p dir="auto"><code>ngx.crc32_long</code></p>
</li>
<li>
<p dir="auto"><code>ngx.hmac_sha1</code></p>
</li>
<li>
<p dir="auto"><code>ngx.md5_bin</code></p>
</li>
<li>
<p dir="auto"><code>ngx.md5</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.subsystem</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.debug</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.prefix</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.nginx_version</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.nginx_configure</code></p>
</li>
<li>
<p dir="auto"><code>ngx.config.ngx_lua_version</code></p>
</li>
<li>
<p dir="auto"><code>ngx.shared.DICT</code></p>
</li>
</ul>
<p dir="auto">The first argument <code>threadpool</code> specifies the Nginx thread pool name defined by <a href="https://nginx.org/en/docs/ngx_core_module.html#thread_pool" rel="nofollow">thread_pool</a>.</p>
<p dir="auto">The second argument <code>module_name</code> specifies the lua module name to execute in the worker thread, which would return a lua table. The module must be inside the package path, e.g.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 lua_package_path '/opt/openresty/?.lua;;';"><pre> lua_package_path <span class="pl-s">'/opt/openresty/?.lua;;'</span><span class="pl-c1">;</span></pre></div>
<p dir="auto">The third argument <code>func_name</code> specifies the function field in the module table as the second argument.</p>
<p dir="auto">The type of <code>args</code> must be one of type below:</p>
<ul dir="auto">
<li>boolean</li>
<li>number</li>
<li>string</li>
<li>nil</li>
<li>table (the table may be recursive, and contains members of types above.)</li>
</ul>
<p dir="auto">The <code>ok</code> is in boolean type, which indicate the C land error (failed to get thread from thread pool, pcall the module function failed, etc.). If <code>ok</code> is <code>false</code>, the <code>res1</code> is the error string.</p>
<p dir="auto">The return values (res1, ...) are returned by invocation of the module function. Normally, the <code>res1</code> should be in boolean type, so that the caller could inspect the error.</p>
<p dir="auto">This API is useful when you need to execute the below types of tasks:</p>
<ul dir="auto">
<li>CPU bound task, e.g. do md5 calculation</li>
<li>File I/O task</li>
<li>Call <code>os.execute()</code> or blocking C API via <code>ffi</code></li>
<li>Call external Lua library not based on cosocket or nginx</li>
</ul>
<p dir="auto">Example1: do md5 calculation.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /calc_md5 {
     default_type 'text/plain';

     content_by_lua_block {
         local ok, md5_or_err = ngx.run_worker_thread(&quot;testpool&quot;, &quot;md5&quot;, &quot;md5&quot;)
         ngx.say(ok, &quot; : &quot;, md5_or_err)
     }
 }"><pre> <span class="pl-c1">location</span> /calc_md5 <span class="pl-c1">{</span>
     <span class="pl-c1">default_type</span> <span class="pl-s">'text/plain'</span><span class="pl-c1">;</span>

     content_by_lua_block <span class="pl-c1">{</span>
         local ok, md5_or_err = ngx.run_worker_thread<span class="pl-c1">(</span><span class="pl-s">"testpool"</span>, <span class="pl-s">"md5"</span>, <span class="pl-s">"md5"</span><span class="pl-c1">)</span>
         ngx.say<span class="pl-c1">(</span>ok, <span class="pl-s">" : "</span>, md5_or_err<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><code>md5.lua</code></p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="local function md5()
    return ngx.md5(&quot;hello&quot;)
end

return { md5=md5, }"><pre><span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">md5</span>()
    <span class="pl-k">return</span> <span class="pl-smi">ngx</span>.<span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>)
<span class="pl-k">end</span>

<span class="pl-k">return</span> { <span class="pl-smi">md5</span><span class="pl-k">=</span><span class="pl-smi">md5</span>, }</pre></div>
<p dir="auto">Example2: write logs into the log file.</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 location /write_log_file {
     default_type 'text/plain';

     content_by_lua_block {
         local ok, err = ngx.run_worker_thread(&quot;testpool&quot;, &quot;write_log_file&quot;, &quot;log&quot;, ngx.var.arg_str)
         if not ok then
             ngx.say(ok, &quot; : &quot;, err)
             return
         end
         ngx.say(ok)
     }
 }"><pre> <span class="pl-c1">location</span> /write_log_file <span class="pl-c1">{</span>
     <span class="pl-c1">default_type</span> <span class="pl-s">'text/plain'</span><span class="pl-c1">;</span>

     content_by_lua_block <span class="pl-c1">{</span>
         local ok, err = ngx.run_worker_thread<span class="pl-c1">(</span><span class="pl-s">"testpool"</span>, <span class="pl-s">"write_log_file"</span>, <span class="pl-s">"log"</span>, ngx.var.arg_str<span class="pl-c1">)</span>
         <span class="pl-k">if</span> not ok then
             ngx.say<span class="pl-c1">(</span>ok, <span class="pl-s">" : "</span>, err<span class="pl-c1">)</span>
             <span class="pl-k">return</span>
         end
         ngx.say<span class="pl-c1">(</span>ok<span class="pl-c1">)</span>
     <span class="pl-c1">}</span>
 <span class="pl-c1">}</span></pre></div>
<p dir="auto"><code>write_log_file.lua</code></p>
<div class="highlight highlight-source-lua notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="
 local function log(str)
     local file, err = io.open(&quot;/tmp/tmp.log&quot;, &quot;a&quot;)
     if not file then
         return false, err
     end
     file:write(str)
     file:flush()
     file:close()
     return true
 end
 return {log=log}"><pre> <span class="pl-k">local</span> <span class="pl-k">function</span> <span class="pl-en">log</span>(<span class="pl-smi">str</span>)
     <span class="pl-k">local</span> <span class="pl-smi">file</span>, <span class="pl-smi">err</span> <span class="pl-k">=</span> <span class="pl-c1">io.open</span>(<span class="pl-s"><span class="pl-pds">"</span>/tmp/tmp.log<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>)
     <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-smi">file</span> <span class="pl-k">then</span>
         <span class="pl-k">return</span> <span class="pl-c1">false</span>, <span class="pl-smi">err</span>
     <span class="pl-k">end</span>
     <span class="pl-en">file</span>:<span class="pl-c1">write</span>(<span class="pl-smi">str</span>)
     <span class="pl-en">file</span>:<span class="pl-c1">flush</span>()
     <span class="pl-en">file</span>:<span class="pl-c1">close</span>()
     <span class="pl-k">return</span> <span class="pl-c1">true</span>
 <span class="pl-k">end</span>
 <span class="pl-k">return</span> {<span class="pl-smi">log</span><span class="pl-k">=</span><span class="pl-smi">log</span>}</pre></div>
<p dir="auto"><a href="#nginx-api-for-lua">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">Obsolete Sections</h1><a id="user-content-obsolete-sections" class="anchor" aria-label="Permalink: Obsolete Sections" href="#obsolete-sections"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This section is just holding obsolete documentation sections that have been either renamed or removed so that existing links over the web are still valid.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Special PCRE Sequences</h2><a id="user-content-special-pcre-sequences" class="anchor" aria-label="Permalink: Special PCRE Sequences" href="#special-pcre-sequences"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This section has been renamed to <a href="#special-escaping-sequences">Special Escaping Sequences</a>.</p>
<p dir="auto"><a href="#table-of-contents">Back to TOC</a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Lua/LuaJIT bytecode support</h2><a id="user-content-lualuajit-bytecode-support" class="anchor" aria-label="Permalink: Lua/LuaJIT bytecode support" href="#lualuajit-bytecode-support"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This section has been renamed to
<a href="#luajit-bytecode-support">LuaJIT bytecode support</a>. As of version
<code>v0.10.16</code> of this module, the standard Lua interpreter (also known
as "PUC-Rio Lua") is not supported anymore.</p>
</article></div></div></div></div></div> <!-- --> <!-- --> <script type="application/json" id="__PRIMER_DATA_:R0:__">{"resolvedServerColorMode":"day"}</script></div>
</react-partial>


      <input type="hidden" data-csrf="true" value="FgKiXguWrAxOPB1ikNdgNXL5KM20RtdtKFNwIj8+kPf5VZJgryTY0kESJxsRuee08zVH1P5zKOMDxhEd59lw4w==" />
</div>
  <div data-view-component="true" class="Layout-sidebar">      

      <div class="BorderGrid about-margin" data-pjax>
        <div class="BorderGrid-row">
          <div class="BorderGrid-cell">
            <div class="hide-sm hide-md">
  <h2 class="mb-3 h4">About</h2>

      <p class="f4 my-3">
        Embed the Power of Lua into NGINX HTTP servers
      </p>
      <div class="my-3 d-flex flex-items-center">
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link flex-shrink-0 mr-2">
    <path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path>
</svg>
        <span class="flex-auto min-width-0 css-truncate css-truncate-target width-fit">
          <a title="https://openresty.org/" role="link" target="_blank" rel="noopener noreferrer nofollow" class="text-bold" href="https://openresty.org/">openresty.org/</a>
        </span>
      </div>


    <h3 class="sr-only">Resources</h3>
    <div class="mt-2">
      <a class="Link--muted" data-analytics-event="{&quot;category&quot;:&quot;Repository Overview&quot;,&quot;action&quot;:&quot;click&quot;,&quot;label&quot;:&quot;location:sidebar;file:readme&quot;}" href="#readme-ov-file">
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-book mr-2">
    <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"></path>
</svg>
        Readme
</a>    </div>

  





  <include-fragment src="/openresty/lua-nginx-module/hovercards/citation/sidebar_partial?tree_name=master" data-nonce="v2:52c78e24-b6ba-2bee-e25d-671c7be5c833" data-view-component="true">
  

  <div data-show-on-forbidden-error hidden>
    <div class="Box">
  <div class="blankslate-container">
    <div data-view-component="true" class="blankslate blankslate-spacious color-bg-default rounded-2">
      

      <h3 data-view-component="true" class="blankslate-heading">        Uh oh!
</h3>
      <p data-view-component="true">        <p class="color-fg-muted my-2 mb-2 ws-normal">There was an error while loading. <a class="Link--inTextBlock" data-turbo="false" href="" aria-label="Please reload this page">Please reload this page</a>.</p>
</p>

</div>  </div>
</div>  </div>
</include-fragment>
  <div class="mt-2">
    <a href="/openresty/lua-nginx-module/activity" data-view-component="true" class="Link Link--muted"><svg text="gray" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-pulse mr-2">
    <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path>
</svg>
      <span class="color-fg-muted">Activity</span></a>  </div>

    <div class="mt-2">
      <a href="/openresty/lua-nginx-module/custom-properties" data-view-component="true" class="Link Link--muted"><svg text="gray" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-note mr-2">
    <path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM3.5 6.25a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Zm.75 2.25h4a.75.75 0 0 1 0 1.5h-4a.75.75 0 0 1 0-1.5Z"></path>
</svg>
        <span class="color-fg-muted">Custom properties</span></a>    </div>

  <h3 class="sr-only">Stars</h3>
  <div class="mt-2">
    <a href="/openresty/lua-nginx-module/stargazers" data-view-component="true" class="Link Link--muted"><svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-star mr-2">
    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"></path>
</svg>
      <strong>11.7k</strong>
      stars</a>  </div>

  <h3 class="sr-only">Watchers</h3>
  <div class="mt-2">
    <a href="/openresty/lua-nginx-module/watchers" data-view-component="true" class="Link Link--muted"><svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-eye mr-2">
    <path d="M8 2c1.981 0 3.671.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.45.678-1.367 1.932-2.637 3.023C11.67 13.008 9.981 14 8 14c-1.981 0-3.671-.992-4.933-2.078C1.797 10.83.88 9.576.43 8.898a1.62 1.62 0 0 1 0-1.798c.45-.677 1.367-1.931 2.637-3.022C4.33 2.992 6.019 2 8 2ZM1.679 7.932a.12.12 0 0 0 0 .136c.411.622 1.241 1.75 2.366 2.717C5.176 11.758 6.527 12.5 8 12.5c1.473 0 2.825-.742 3.955-1.715 1.124-.967 1.954-2.096 2.366-2.717a.12.12 0 0 0 0-.136c-.412-.621-1.242-1.75-2.366-2.717C10.824 4.242 9.473 3.5 8 3.5c-1.473 0-2.825.742-3.955 1.715-1.124.967-1.954 2.096-2.366 2.717ZM8 10a2 2 0 1 1-.001-3.999A2 2 0 0 1 8 10Z"></path>
</svg>
      <strong>557</strong>
      watching</a>  </div>

  <h3 class="sr-only">Forks</h3>
  <div class="mt-2">
    <a href="/openresty/lua-nginx-module/forks" data-view-component="true" class="Link Link--muted"><svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-repo-forked mr-2">
    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path>
</svg>
      <strong>2.1k</strong>
      forks</a>  </div>


    <div class="mt-2">
      <a class="Link--muted" href="/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fopenresty%2Flua-nginx-module&amp;report=openresty+%28user%29">
          Report repository
</a>    </div>
</div>

          </div>
        </div>

        
            <div class="BorderGrid-row">
              <div class="BorderGrid-cell">
                <h2 class="h4 mb-3" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame">
  <a href="/openresty/lua-nginx-module/releases" data-view-component="true" class="Link--primary no-underline Link">Releases</a></h2>

    <a class="Link--primary no-underline" data-pjax="#repo-content-pjax-container" data-turbo-frame="repo-content-turbo-frame" href="/openresty/lua-nginx-module/tags">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-tag color-fg-muted">
    <path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path>
</svg>
      <span class="text-bold">370</span>
      <span class="color-fg-muted">tags</span>
</a>
              </div>
            </div>

        
        
            <div class="BorderGrid-row">
              <div class="BorderGrid-cell">
                
  <h2 class="h4 mb-3">
  <a href="/orgs/openresty/packages?repo_name=lua-nginx-module" data-view-component="true" class="Link--primary no-underline Link d-flex flex-items-center">Packages
      <span title="0" hidden="hidden" data-view-component="true" class="Counter ml-1">0</span></a></h2>


      <div class="text-small color-fg-muted" >
        No packages published <br>
      </div>



              </div>
            </div>

        
            <div class="BorderGrid-row" hidden>
              <div class="BorderGrid-cell">
                <include-fragment src="/openresty/lua-nginx-module/used_by_list" accept="text/fragment+html" data-nonce="v2:52c78e24-b6ba-2bee-e25d-671c7be5c833" data-view-component="true">
  

  <div data-show-on-forbidden-error hidden>
    <div class="Box">
  <div class="blankslate-container">
    <div data-view-component="true" class="blankslate blankslate-spacious color-bg-default rounded-2">
      

      <h3 data-view-component="true" class="blankslate-heading">        Uh oh!
</h3>
      <p data-view-component="true">        <p class="color-fg-muted my-2 mb-2 ws-normal">There was an error while loading. <a class="Link--inTextBlock" data-turbo="false" href="" aria-label="Please reload this page">Please reload this page</a>.</p>
</p>

</div>  </div>
</div>  </div>
</include-fragment>
              </div>
            </div>

        
            <div class="BorderGrid-row">
              <div class="BorderGrid-cell">
                <h2 class="h4 mb-3">
  <a href="/openresty/lua-nginx-module/graphs/contributors" data-view-component="true" class="Link--primary no-underline Link d-flex flex-items-center">Contributors
      <span title="150" data-view-component="true" class="Counter ml-1">150</span></a></h2>


    
  <ul class="list-style-none d-flex flex-wrap mb-n2">
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/agentzh"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/agentzh/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/56241?s=64&amp;v=4" alt="@agentzh" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/zhuizhuhaomeng"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/zhuizhuhaomeng/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/4002750?s=64&amp;v=4" alt="@zhuizhuhaomeng" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/chaoslawful"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/chaoslawful/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/56617?s=64&amp;v=4" alt="@chaoslawful" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/thibaultcha"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/thibaultcha/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/1125431?s=64&amp;v=4" alt="@thibaultcha" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/spacewander"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/spacewander/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/4161644?s=64&amp;v=4" alt="@spacewander" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/membphis"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/membphis/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/6814606?s=64&amp;v=4" alt="@membphis" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/doujiang24"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/doujiang24/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/570391?s=64&amp;v=4" alt="@doujiang24" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/chipitsine"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/chipitsine/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/2217296?s=64&amp;v=4" alt="@chipitsine" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/rainingmaster"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/rainingmaster/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/8320024?s=64&amp;v=4" alt="@rainingmaster" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/willmafh"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/willmafh/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/11711429?s=64&amp;v=4" alt="@willmafh" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/jinglong"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/jinglong/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/853403?s=64&amp;v=4" alt="@jinglong" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/zhuzhaoyuan"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/zhuzhaoyuan/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/74670?s=64&amp;v=4" alt="@zhuzhaoyuan" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
    <li class="mb-2 mr-2"
        >
      <a href="https://github.com/liseen"
          class=""
            data-hovercard-type="user" data-hovercard-url="/users/liseen/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self"
          
        >
        <img src="https://avatars.githubusercontent.com/u/94178?s=64&amp;v=4" alt="@liseen" size="32" height="32" width="32" data-view-component="true" class="avatar circle" />
      </a>
    </li>
</ul>




  <div data-view-component="true" class="mt-3">
    <a text="small" href="/openresty/lua-nginx-module/graphs/contributors" data-view-component="true" class="Link--inTextBlock Link">+ 136 contributors</a></div>
              </div>
            </div>

        
        
            <div class="BorderGrid-row">
              <div class="BorderGrid-cell">
                <h2 class="h4 mb-3">Languages</h2>
<div class="mb-2">
  <span data-view-component="true" class="Progress">
    <span style="background-color:#555555 !important;;width: 94.8%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
    <span style="background-color:#000080 !important;;width: 3.3%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
    <span style="background-color:#89e051 !important;;width: 1.0%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
    <span style="background-color:#0298c3 !important;;width: 0.8%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
    <span style="background-color:#ccc !important;;width: 0.1%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
    <span style="background-color:#3572A5 !important;;width: 0.0%;" itemprop="keywords" data-view-component="true" class="Progress-item color-bg-success-emphasis"></span>
</span></div>
<ul class="list-style-none">
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=c"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#555555;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">C</span>
          <span>94.8%</span>
        </a>
    </li>
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=lua"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#000080;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">Lua</span>
          <span>3.3%</span>
        </a>
    </li>
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=shell"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#89e051;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">Shell</span>
          <span>1.0%</span>
        </a>
    </li>
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=perl"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#0298c3;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">Perl</span>
          <span>0.8%</span>
        </a>
    </li>
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=dtrace"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#ccc;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">DTrace</span>
          <span>0.1%</span>
        </a>
    </li>
    <li class="d-inline">
        <a class="d-inline-flex flex-items-center flex-nowrap Link--secondary no-underline text-small mr-3" href="/openresty/lua-nginx-module/search?l=python"  data-ga-click="Repository, language stats search click, location:repo overview">
          <svg style="color:#3572A5;" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-dot-fill mr-2">
    <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"></path>
</svg>
          <span class="color-fg-default text-bold mr-1">Python</span>
          <span>0.0%</span>
        </a>
    </li>
</ul>

              </div>
            </div>

              </div>
</div>
  
</div></div>

  </div>


  </div>

</turbo-frame>


    </main>
  </div>

  </div>

          <footer class="footer pt-8 pb-6 f6 color-fg-muted p-responsive" role="contentinfo" >
  <h2 class='sr-only'>Footer</h2>

  


  <div class="d-flex flex-justify-center flex-items-center flex-column-reverse flex-lg-row flex-wrap flex-lg-nowrap">
    <div class="d-flex flex-items-center flex-shrink-0 mx-2">
      <a aria-label="GitHub Homepage" class="footer-octicon mr-2" href="https://github.com">
        <svg aria-hidden="true" height="24" viewBox="0 0 24 24" version="1.1" width="24" data-view-component="true" class="octicon octicon-mark-github">
    <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
</svg>
</a>
      <span>
        &copy; 2025 GitHub,&nbsp;Inc.
      </span>
    </div>

    <nav aria-label="Footer">
      <h3 class="sr-only" id="sr-footer-heading">Footer navigation</h3>

      <ul class="list-style-none d-flex flex-justify-center flex-wrap mb-2 mb-lg-0" aria-labelledby="sr-footer-heading">

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to Terms&quot;,&quot;label&quot;:&quot;text:terms&quot;}" href="https://docs.github.com/site-policy/github-terms/github-terms-of-service" data-view-component="true" class="Link--secondary Link">Terms</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to privacy&quot;,&quot;label&quot;:&quot;text:privacy&quot;}" href="https://docs.github.com/site-policy/privacy-policies/github-privacy-statement" data-view-component="true" class="Link--secondary Link">Privacy</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to security&quot;,&quot;label&quot;:&quot;text:security&quot;}" href="https://github.com/security" data-view-component="true" class="Link--secondary Link">Security</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to status&quot;,&quot;label&quot;:&quot;text:status&quot;}" href="https://www.githubstatus.com/" data-view-component="true" class="Link--secondary Link">Status</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to community&quot;,&quot;label&quot;:&quot;text:community&quot;}" href="https://github.community/" data-view-component="true" class="Link--secondary Link">Community</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to docs&quot;,&quot;label&quot;:&quot;text:docs&quot;}" href="https://docs.github.com/" data-view-component="true" class="Link--secondary Link">Docs</a>
          </li>

          <li class="mx-2">
            <a data-analytics-event="{&quot;category&quot;:&quot;Footer&quot;,&quot;action&quot;:&quot;go to contact&quot;,&quot;label&quot;:&quot;text:contact&quot;}" href="https://support.github.com?tags=dotcom-footer" data-view-component="true" class="Link--secondary Link">Contact</a>
          </li>

          <li class="mx-2" >
  <cookie-consent-link>
    <button
      type="button"
      class="Link--secondary underline-on-hover border-0 p-0 color-bg-transparent"
      data-action="click:cookie-consent-link#showConsentManagement"
      data-analytics-event="{&quot;location&quot;:&quot;footer&quot;,&quot;action&quot;:&quot;cookies&quot;,&quot;context&quot;:&quot;subfooter&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;cookies_link_subfooter_footer&quot;}"
    >
       Manage cookies
    </button>
  </cookie-consent-link>
</li>

<li class="mx-2">
  <cookie-consent-link>
    <button
      type="button"
      class="Link--secondary underline-on-hover border-0 p-0 color-bg-transparent text-left"
      data-action="click:cookie-consent-link#showConsentManagement"
      data-analytics-event="{&quot;location&quot;:&quot;footer&quot;,&quot;action&quot;:&quot;dont_share_info&quot;,&quot;context&quot;:&quot;subfooter&quot;,&quot;tag&quot;:&quot;link&quot;,&quot;label&quot;:&quot;dont_share_info_link_subfooter_footer&quot;}"
    >
      Do not share my personal information
    </button>
  </cookie-consent-link>
</li>

      </ul>
    </nav>
  </div>
</footer>



    <ghcc-consent id="ghcc" class="position-fixed bottom-0 left-0" style="z-index: 999999"
      data-locale="en"
      data-initial-cookie-consent-allowed=""
      data-cookie-consent-required="false"
    ></ghcc-consent>




  <div id="ajax-error-message" class="ajax-error-message flash flash-error" hidden>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <button type="button" class="flash-close js-ajax-error-dismiss" aria-label="Dismiss error">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg>
    </button>
    You can’t perform that action at this time.
  </div>

    <template id="site-details-dialog">
  <details class="details-reset details-overlay details-overlay-dark lh-default color-fg-default hx_rsm" open>
    <summary role="button" aria-label="Close dialog"></summary>
    <details-dialog class="Box Box--overlay d-flex flex-column anim-fade-in fast hx_rsm-dialog hx_rsm-modal">
      <button class="Box-btn-octicon m-0 btn-octicon position-absolute right-0 top-0" type="button" aria-label="Close dialog" data-close-dialog>
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-x">
    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
</svg>
      </button>
      <div class="octocat-spinner my-6 js-details-dialog-spinner"></div>
    </details-dialog>
  </details>
</template>

    <div class="Popover js-hovercard-content position-absolute" style="display: none; outline: none;">
  <div class="Popover-message Popover-message--bottom-left Popover-message--large Box color-shadow-large" style="width:360px;">
  </div>
</div>

    <template id="snippet-clipboard-copy-button">
  <div class="zeroclipboard-container position-absolute right-0 top-0">
    <clipboard-copy aria-label="Copy" class="ClipboardButton btn js-clipboard-copy m-2 p-0" data-copy-feedback="Copied!" data-tooltip-direction="w">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-copy js-clipboard-copy-icon m-2">
    <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none m-2">
    <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
    </clipboard-copy>
  </div>
</template>
<template id="snippet-clipboard-copy-button-unpositioned">
  <div class="zeroclipboard-container">
    <clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w">
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-copy js-clipboard-copy-icon">
    <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
      <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none">
    <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
    </clipboard-copy>
  </div>
</template>




    </div>
    <div id="js-global-screen-reader-notice" class="sr-only mt-n1" aria-live="polite" aria-atomic="true" ></div>
    <div id="js-global-screen-reader-notice-assertive" class="sr-only mt-n1" aria-live="assertive" aria-atomic="true"></div>
  </body>
</html>

